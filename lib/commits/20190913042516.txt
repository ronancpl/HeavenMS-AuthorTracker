{"fetchDate": "2019-12-19", "content": [{"sha": "259c2e5ba19c915a9aff59a23aaf3fdace810d29", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MjU5YzJlNWJhMTljOTE1YTlhZmY1OWEyM2FhZjNmZGFjZTgxMGQyOQ==", "commit": {"author": {"name": "Ubaware", "email": "ubaware0@gmail.com", "date": "2019-09-13T04:25:16Z"}, "committer": {"name": "Ronan Lana", "email": "rcpl2010@gmail.com", "date": "2019-09-13T04:25:16Z"}, "message": "Fix for daily timers. Minor family fixes. Server code to change guild leader. (#513)", "tree": {"sha": "866389e6d4491708fe8454bd30368f253ec50996", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/866389e6d4491708fe8454bd30368f253ec50996"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/259c2e5ba19c915a9aff59a23aaf3fdace810d29", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/259c2e5ba19c915a9aff59a23aaf3fdace810d29", "html_url": "https://github.com/ronancpl/HeavenMS/commit/259c2e5ba19c915a9aff59a23aaf3fdace810d29", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/259c2e5ba19c915a9aff59a23aaf3fdace810d29/comments", "author": {"login": "Ubaware", "id": 52778420, "node_id": "MDQ6VXNlcjUyNzc4NDIw", "avatar_url": "https://avatars0.githubusercontent.com/u/52778420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ubaware", "html_url": "https://github.com/Ubaware", "followers_url": "https://api.github.com/users/Ubaware/followers", "following_url": "https://api.github.com/users/Ubaware/following{/other_user}", "gists_url": "https://api.github.com/users/Ubaware/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ubaware/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ubaware/subscriptions", "organizations_url": "https://api.github.com/users/Ubaware/orgs", "repos_url": "https://api.github.com/users/Ubaware/repos", "events_url": "https://api.github.com/users/Ubaware/events{/privacy}", "received_events_url": "https://api.github.com/users/Ubaware/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da2395cc3a770b9fe4dc772f8890ec87a2ee7669", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/da2395cc3a770b9fe4dc772f8890ec87a2ee7669", "html_url": "https://github.com/ronancpl/HeavenMS/commit/da2395cc3a770b9fe4dc772f8890ec87a2ee7669"}], "stats": {"total": 90, "additions": 85, "deletions": 5}, "files": [{"sha": "7bd871eec7a50975370cb7eb4785a6c20a605dec", "filename": "sql/db_database.sql", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -21456,6 +21456,9 @@ ALTER TABLE `dueyitems`\n \n ALTER TABLE `famelog`\n   ADD CONSTRAINT `famelog_ibfk_1` FOREIGN KEY (`characterid`) REFERENCES `characters` (`id`) ON DELETE CASCADE;\n+  \n+ALTER TABLE `family_character`\n+  ADD CONSTRAINT `family_character_ibfk_1` FOREIGN KEY (`cid`) REFERENCES `characters` (`id`) ON DELETE CASCADE;\n \n ALTER TABLE `skills`\n   ADD CONSTRAINT `skills_chrid_fk` FOREIGN KEY (`characterid`) REFERENCES `characters` (`id`) ON DELETE CASCADE;\t# thanks Shavit"}, {"sha": "8c8411e99fe9c919344ead9fb9e629acf0390fae", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -7577,7 +7577,7 @@ private void playerDead() {\n                 break;\n             }\n         }\n-        if (possesed > 0) {\n+        if (possesed > 0 && !GameConstants.isDojo(getMapId())) {\n             message(\"You have used a safety charm, so your EXP points have not been decreased.\");\n             MapleInventoryManipulator.removeById(client, ItemConstants.getInventoryType(charmID[i]), charmID[i], 1, true, false);\n         } else if (getJob() != MapleJob.BEGINNER) { //Hmm..."}, {"sha": "e87e417991295bb62b78540a3138a8a3d23da12c", "filename": "src/client/MapleFamily.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/client/MapleFamily.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/client/MapleFamily.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleFamily.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -203,9 +203,11 @@ public static void loadAllFamilies() {\n                             jobID = rs.getInt(\"job\");\n                         } else {\n                             FilePrinter.printError(FilePrinter.FAMILY_ERROR, \"Could not load character information of \" + cid + \" in loadAllFamilies(). (RECORD DOES NOT EXIST)\");\n+                            continue;\n                         }\n                     } catch(SQLException e) {\n                         FilePrinter.printError(FilePrinter.FAMILY_ERROR, e, \"Could not load character information of \" + cid + \" in loadAllFamilies(). (SQL ERROR)\");\n+                        continue;\n                     }\n                     int familyid = rsEntries.getInt(\"familyid\");\n                     int seniorid = rsEntries.getInt(\"seniorid\");"}, {"sha": "9efc1f5155e6b852c74c873bcf78b43543e6cbc7", "filename": "src/net/server/Server.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -535,7 +535,7 @@ private static long getTimeLeftForNextHour() {\n     public static long getTimeLeftForNextDay() {\n         Calendar nextDay = Calendar.getInstance();\n         nextDay.add(Calendar.DAY_OF_MONTH, 1);\n-        nextDay.set(Calendar.HOUR, 0);\n+        nextDay.set(Calendar.HOUR_OF_DAY, 0);\n         nextDay.set(Calendar.MINUTE, 0);\n         nextDay.set(Calendar.SECOND, 0);\n         "}, {"sha": "a7638e401dbf6a0b1d78f6cd9e4754697dd54b46", "filename": "src/net/server/channel/handlers/FamilyAddHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/channel/handlers/FamilyAddHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/channel/handlers/FamilyAddHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/FamilyAddHandler.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -46,6 +46,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         MapleCharacter chr = c.getPlayer();\n         if(addChr == null) {\n             c.announce(MaplePacketCreator.sendFamilyMessage(65, 0));\n+        } else if(addChr == chr) { //only possible through packet editing/client editing i think?\n+            c.announce(MaplePacketCreator.enableActions());\n         } else if(addChr.getMap() != chr.getMap() || (addChr.isHidden()) && chr.gmLevel() < addChr.gmLevel()) {\n             c.announce(MaplePacketCreator.sendFamilyMessage(69, 0));\n         } else if(addChr.getLevel() <= 10) {"}, {"sha": "fd767f6c9c27c95ad1c2da1c035809764b52a385", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -30,6 +30,7 @@\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.Comparator;\n import java.util.LinkedHashMap;\n import java.util.LinkedList;\n import java.util.List;\n@@ -307,6 +308,18 @@ public void broadcastEmblemChanged() {\n         }\n     }\n     \n+    public void broadcastInfoChanged() {\n+        PlayerStorage ps = Server.getInstance().getWorld(world).getPlayerStorage();\n+        \n+        for (MapleGuildCharacter mgc : getMembers()) {\n+            MapleCharacter chr = ps.getCharacterById(mgc.getId());\n+            if (chr == null || !chr.isLoggedinWorld()) continue;\n+            \n+            byte[] packet = MaplePacketCreator.showGuildInfo(chr);\n+            chr.announce(packet);\n+        }\n+    }\n+    \n     public void broadcast(final byte[] packet) {\n         broadcast(packet, -1, BCOp.NONE);\n     }\n@@ -567,6 +580,14 @@ public void changeRank(MapleGuildCharacter mgc, int newRank) {\n         }\n         \n         membersLock.lock();\n+        members.sort(new Comparator<MapleGuildCharacter>() {\n+            @Override\n+            public int compare(MapleGuildCharacter t, MapleGuildCharacter o) {\n+                if(t.getGuildRank() <= 1 && o.getGuildRank() > 1) return -1;\n+                else if(t.getGuildRank() > 1 && o.getGuildRank() <= 1) return 1;\n+                else return 0;\n+            }\n+        });\n         try {\n             this.broadcast(MaplePacketCreator.changeRank(mgc));\n         } finally {"}, {"sha": "ef066d107deb36ca75798b0378ba9f5e79ef0aca", "filename": "src/net/server/handlers/login/DeleteCharHandler.java", "status": "modified", "additions": 43, "deletions": 1, "changes": 44, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/handlers/login/DeleteCharHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/handlers/login/DeleteCharHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/DeleteCharHandler.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -21,8 +21,16 @@\n  */\n package net.server.handlers.login;\n \n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n import client.MapleClient;\n+import client.MapleFamily;\n import net.AbstractMaplePacketHandler;\n+import net.server.Server;\n+import tools.DatabaseConnection;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -34,11 +42,45 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         String pic = slea.readMapleAsciiString();\n         int cid = slea.readInt();\n         if (c.checkPic(pic)) {\n+        \t//check for family, guild leader, pending marriage, world transfer\n+        \ttry (Connection con = DatabaseConnection.getConnection();\n+        \t\t\tPreparedStatement ps = con.prepareStatement(\"SELECT `world`, `guildid`, `guildrank`, `familyId` FROM characters WHERE id = ?\");\n+        \t\t\tPreparedStatement ps2 = con.prepareStatement(\"SELECT COUNT(*) as rowcount FROM worldtransfers WHERE `characterid` = ? AND completionTime IS NULL\")) {\n+        \t\tps.setInt(1, cid);\n+        \t\tResultSet rs = ps.executeQuery();\n+        \t\tif(!rs.next()) throw new SQLException(\"Character record does not exist.\");\n+        \t\tint world = rs.getInt(\"world\");\n+        \t\tint guildId = rs.getInt(\"guildid\");\n+        \t\tint guildRank = rs.getInt(\"guildrank\");\n+        \t\tint familyId = rs.getInt(\"familyId\");\n+        \t\tif(guildId != 0 && guildRank <= 1) {\n+        \t\t\tc.announce(MaplePacketCreator.deleteCharResponse(cid, 0x16));\n+        \t\t\treturn;\n+        \t\t} else if(familyId != -1) {\n+        \t\t\tMapleFamily family = Server.getInstance().getWorld(world).getFamily(familyId);\n+        \t\t\tif(family != null && family.getTotalMembers() > 1) {\n+            \t\t\tc.announce(MaplePacketCreator.deleteCharResponse(cid, 0x1D));\n+            \t\t\treturn;\n+        \t\t\t}\n+        \t\t}\n+        \t\trs.close();\n+        \t\tps2.setInt(1, cid);\n+        \t\trs = ps2.executeQuery();\n+        \t\trs.next();\n+        \t\tif(rs.getInt(\"rowcount\") > 0) {\n+        \t\t\tc.announce(MaplePacketCreator.deleteCharResponse(cid, 0x1A));\n+        \t\t\treturn;\n+        \t\t}\n+        \t} catch(SQLException e) {\n+        \t\te.printStackTrace();\n+        \t\tc.announce(MaplePacketCreator.deleteCharResponse(cid, 0x09));\n+        \t\treturn;\n+        \t}\n             if(c.deleteCharacter(cid, c.getAccID())) {\n                 FilePrinter.print(FilePrinter.DELETED_CHAR + c.getAccountName() + \".txt\", c.getAccountName() + \" deleted CID: \" + cid);\n                 c.announce(MaplePacketCreator.deleteCharResponse(cid, 0));\n             } else {\n-                c.announce(MaplePacketCreator.deleteCharResponse(cid, 0x14));\n+                c.announce(MaplePacketCreator.deleteCharResponse(cid, 0x09));\n             }\n         } else {\n             c.announce(MaplePacketCreator.deleteCharResponse(cid, 0x14));"}, {"sha": "92dc8e2672f26a5817afaf3b5e47ade0a95f94db", "filename": "src/net/server/worker/FamilyDailyResetWorker.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/worker/FamilyDailyResetWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/net/server/worker/FamilyDailyResetWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/FamilyDailyResetWorker.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -29,7 +29,7 @@ public void run() {\n     public static void resetEntitlementUsage(World world) {\n         Calendar resetTime = Calendar.getInstance();\n         resetTime.add(Calendar.MINUTE, 1); // to make sure that we're in the \"next day\", since this is called at midnight\n-        resetTime.set(Calendar.HOUR, 0);\n+        resetTime.set(Calendar.HOUR_OF_DAY, 0);\n         resetTime.set(Calendar.MINUTE, 0);\n         resetTime.set(Calendar.SECOND, 0);\n         resetTime.set(Calendar.MILLISECOND, 0);"}, {"sha": "7258b2720c11185384952b305240aab5dc443c9b", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -2721,7 +2721,17 @@ private static int doubleToShortBits(double d) {\n         }\n \n         /**\n-         * state 0 = del ok state 12 = invalid bday state 14 = incorrect pic\n+         * State :\n+         * 0x00 = success\n+         * 0x06 = Trouble logging into the game?\n+         * 0x09 = Unknown error\n+         * 0x0A = Could not be processed due to too many connection requests to the server.\n+         * 0x12 = invalid bday\n+         * 0x14 = incorrect pic\n+         * 0x16 = Cannot delete a guild master.\n+         * 0x18 = Cannot delete a character with a pending wedding.\n+         * 0x1A = Cannot delete a character with a pending world transfer.\n+         * 0x1D = Cannot delete a character that has a family.\n          *\n          * @param cid\n          * @param state"}]}]},
