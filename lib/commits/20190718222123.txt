{"fetchDate": "2019-12-19", "content": [{"sha": "187023c81fdd2f6131f866313ca1c0d1ac3c892e", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MTg3MDIzYzgxZmRkMmY2MTMxZjg2NjMxM2NhMWMwZDFhYzNjODkyZQ==", "commit": {"author": {"name": "Ubaware", "email": "ubaware0@gmail.com", "date": "2019-07-18T22:21:23Z"}, "committer": {"name": "Ronan Lana", "email": "rcpl2010@gmail.com", "date": "2019-07-18T22:21:23Z"}, "message": "Proper coupon packet. (DB) coupon_items type 0 = mesos. (#491)", "tree": {"sha": "d626beb79cb4c8a3558dec48277fe8b3c08b8360", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/d626beb79cb4c8a3558dec48277fe8b3c08b8360"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/187023c81fdd2f6131f866313ca1c0d1ac3c892e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/187023c81fdd2f6131f866313ca1c0d1ac3c892e", "html_url": "https://github.com/ronancpl/HeavenMS/commit/187023c81fdd2f6131f866313ca1c0d1ac3c892e", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/187023c81fdd2f6131f866313ca1c0d1ac3c892e/comments", "author": {"login": "Ubaware", "id": 52778420, "node_id": "MDQ6VXNlcjUyNzc4NDIw", "avatar_url": "https://avatars0.githubusercontent.com/u/52778420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Ubaware", "html_url": "https://github.com/Ubaware", "followers_url": "https://api.github.com/users/Ubaware/followers", "following_url": "https://api.github.com/users/Ubaware/following{/other_user}", "gists_url": "https://api.github.com/users/Ubaware/gists{/gist_id}", "starred_url": "https://api.github.com/users/Ubaware/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Ubaware/subscriptions", "organizations_url": "https://api.github.com/users/Ubaware/orgs", "repos_url": "https://api.github.com/users/Ubaware/repos", "events_url": "https://api.github.com/users/Ubaware/events{/privacy}", "received_events_url": "https://api.github.com/users/Ubaware/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a29c3bcc8155eaa0c42ffac8dcc33bf8dd13326a", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a29c3bcc8155eaa0c42ffac8dcc33bf8dd13326a", "html_url": "https://github.com/ronancpl/HeavenMS/commit/a29c3bcc8155eaa0c42ffac8dcc33bf8dd13326a"}], "stats": {"total": 66, "additions": 46, "deletions": 20}, "files": [{"sha": "ee852650e99246a5ee46b6cc8cd224d94977218b", "filename": "src/net/server/channel/handlers/CouponCodeHandler.java", "status": "modified", "additions": 30, "deletions": 11, "changes": 41, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/187023c81fdd2f6131f866313ca1c0d1ac3c892e/src/net/server/channel/handlers/CouponCodeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/187023c81fdd2f6131f866313ca1c0d1ac3c892e/src/net/server/channel/handlers/CouponCodeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CouponCodeHandler.java?ref=187023c81fdd2f6131f866313ca1c0d1ac3c892e", "patch": "@@ -31,6 +31,7 @@\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n+import java.util.Arrays;\n import java.util.HashMap;\n import java.util.LinkedList;\n import java.util.List;\n@@ -63,7 +64,6 @@\n         ResultSet rs = ps.executeQuery();\n         while (rs.next()) {\n             int type = rs.getInt(\"type\"), quantity = rs.getInt(\"quantity\");\n-            \n             if (type < 5) {\n                 Integer i = couponPoints.get(type);\n                 if (i != null) {\n@@ -195,27 +195,40 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if (type < 0) {\n                     c.announce(MaplePacketCreator.showCashShopMessage((byte) parseCouponResult(type)));\n                 } else {\n-                    List<Item> couponPackage = new LinkedList<>();\n-\n+                    List<Item> cashItems = new LinkedList<Item>();\n+                    List<Pair<Integer, Integer>> items = new LinkedList<Pair<Integer, Integer>>();\n+                    int nxCredit = 0;\n+                    int maplePoints = 0;\n+                    int nxPrepaid = 0;\n+                    int mesos = 0;\n+                    \n                     for (Pair<Integer, Pair<Integer, Integer>> p : codeRes.getRight()) {\n                         type = p.getLeft();\n                         int quantity = p.getRight().getRight();\n \n                         CashShop cs = c.getPlayer().getCashShop();\n                         switch (type) {\n                             case 0:\n+                                c.getPlayer().gainMeso(quantity, false); //mesos\n+                                mesos += quantity;\n+                                break;\n                             case 4:\n                                 cs.gainCash(1, quantity);    //nxCredit\n+                                nxCredit += quantity;\n                                 break;\n                             case 1:\n                                 cs.gainCash(2, quantity);    //maplePoint\n+                                maplePoints += quantity;\n                                 break;\n                             case 2:\n                                 cs.gainCash(4, quantity);    //nxPrepaid\n+                                nxPrepaid += quantity;\n                                 break;\n                             case 3:\n                                 cs.gainCash(1, quantity);\n+                                nxCredit += quantity;\n                                 cs.gainCash(4, (quantity / 5000));\n+                                nxPrepaid += quantity / 5000;\n                                 break;\n \n                             default:\n@@ -234,22 +247,28 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                     Item it = CashShop.generateCouponItem(item, qty);\n \n                                     cs.addToInventory(it);\n-                                    couponPackage.add(it);\n+                                    cashItems.add(it);\n                                 } else {\n                                     MapleInventoryManipulator.addById(c, item, qty, \"\", -1);\n+                                    items.add(new Pair<Integer, Integer>((int)qty, item));\n                                 }\n-\n-                                //c.announce(MaplePacketCreator.showCouponRedeemedItem(item));\n                                 break;\n                         }\n                     }\n-\n-                    if (!couponPackage.isEmpty()) {\n-                        c.announce(MaplePacketCreator.showBoughtCashPackage(couponPackage, c.getAccID()));\n-                    } else {\n+                    if(cashItems.size() > 255) {\n+                        List<Item> oldList = cashItems;\n+                        cashItems = Arrays.asList(new Item[255]);\n+                        int index = 0;\n+                        for(Item item : oldList) {\n+                            cashItems.set(index, item);\n+                            index++;\n+                        }\n+                    }\n+                    if (nxCredit != 0 || nxPrepaid != 0) { //coupon packet can only show maple points (afaik)\n                         c.announce(MaplePacketCreator.showBoughtQuestItem(0));\n+                    } else {\n+                        c.announce(MaplePacketCreator.showCouponRedeemedItems(c.getAccID(), maplePoints, mesos, cashItems, items));\n                     }\n-\n                     c.enableCSActions();\n                 }\n             } finally {"}, {"sha": "fb9eb0231ba79aa19c59f3fec9e57ff192fd39b7", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/187023c81fdd2f6131f866313ca1c0d1ac3c892e/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/187023c81fdd2f6131f866313ca1c0d1ac3c892e/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=187023c81fdd2f6131f866313ca1c0d1ac3c892e", "patch": "@@ -6112,12 +6112,12 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n         \n+        \n         public static byte[] sendNameTransferCheck(boolean canUseName) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.CASHSHOP_CHECK_NAME_CHANGE.getValue());\n                 mplew.writeShort(0);\n                 mplew.writeBool(!canUseName);\n-                \n                 return mplew.getPacket();\n         }\n         \n@@ -6219,16 +6219,23 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n         \n-        public static byte[] showCouponRedeemedItem(int itemid) {\n+        public static byte[] showCouponRedeemedItems(int accountId, int maplePoints, int mesos, List<Item> cashItems, List<Pair<Integer, Integer>> items) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.CASHSHOP_OPERATION.getValue());\n-                mplew.writeShort(0x49); //v72\n-                mplew.writeInt(0);\n-                mplew.writeInt(1);\n-                mplew.writeShort(1);\n-                mplew.writeShort(0x1A);\n-                mplew.writeInt(itemid);\n-                mplew.writeInt(0);\n+                mplew.write(0x59);\n+                mplew.write((byte)cashItems.size());\n+                for(Item item : cashItems) {\n+                    addCashItemInformation(mplew, item, accountId);\n+                }\n+                mplew.writeInt(maplePoints);\n+                mplew.writeInt(items.size());\n+                for(Pair<Integer, Integer> itemPair : items) {\n+                    int quantity = itemPair.getLeft();\n+                    mplew.writeShort((short) quantity); //quantity (0 = 1 for cash items)\n+                    mplew.writeShort(0x1F); //0 = ?, >=0x20 = ?, <0x20 = ? (does nothing?)\n+                    mplew.writeInt(itemPair.getRight());\n+                }\n+                mplew.writeInt(mesos);\n                 return mplew.getPacket();\n         }\n "}]}]},
