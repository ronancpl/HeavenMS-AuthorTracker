{"fetchDate": "2019-12-19", "content": [{"sha": "7e32e5a7624aa95bd538fe65db73f4281b3b5218", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6N2UzMmU1YTc2MjRhYTk1YmQ1MzhmZTY1ZGI3M2Y0MjgxYjNiNTIxOA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2016-01-03T13:13:07Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2016-01-03T13:13:07Z"}, "message": "Cash Shop patch + new features\n\nCash shop fix, new item sorting features, minor patches.", "tree": {"sha": "f9b0cf97b3d1367d9c50830df24560826c4ce844", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/f9b0cf97b3d1367d9c50830df24560826c4ce844"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/7e32e5a7624aa95bd538fe65db73f4281b3b5218", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7e32e5a7624aa95bd538fe65db73f4281b3b5218", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7e32e5a7624aa95bd538fe65db73f4281b3b5218", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7e32e5a7624aa95bd538fe65db73f4281b3b5218/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b4fcf78618eec3b0fc38453a32fff64c5b864db", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7b4fcf78618eec3b0fc38453a32fff64c5b864db", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7b4fcf78618eec3b0fc38453a32fff64c5b864db"}], "stats": {"total": 379, "additions": 312, "deletions": 67}, "files": [{"sha": "95832e8eb973b21a0b3ba826cb4d0399ba452993", "filename": ".gitignore", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/.gitignore", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/.gitignore", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/.gitignore?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -0,0 +1,2 @@\n+/build/\n+/dist/\n\\ No newline at end of file"}, {"sha": "cd17c9fe7a385996fa856634710ee6f934ad50cd", "filename": "README.txt", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/README.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/README.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.txt?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -4,11 +4,19 @@ Freelance developer: Ronan C. P. Lana\n \n Credits about are to be given to the original MapleSolaxia staff and other colaborators, as some minor\n changes/patches on the game were applied by me.\n+\n+This is a NetBeans 8.0.2 Project. This means that it's easier to install the project via \"NetBeans' import\n+new project using existing code\". Once installed, build this project on your machine and run the server using\n+the \"launch.bat\" application.\n+\n+\n+Note that the project uses the IP 25.15.163.31. Therefore, change the IP wherever it applies to run properly\n+the program. Eventually, I will change the settings on this repository to run at localhost (127.0.0.1).\n ------------------------------------------------\n \n \n To run it in Windows 10:\n \t- Install everything normally;\n \t- WampServer 2.0 -> change port 80 at \"httpd.conf\" to another, as it clashes with a Windows\n default port.\n-\t- Run MapleStory client using these: \"Windows XP (SP2)\" & \"16-bit color mode\";\n\\ No newline at end of file\n+\t- Run MapleStory client using these: \"Windows XP (SP2)\" & \"(8 or 16)-bit color mode\";\n\\ No newline at end of file"}, {"sha": "e11fc7a207997838ccac2d74471a0d30cdf01834", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -76,8 +76,15 @@ Correcao de bug que nao retirava corretamente recursos de projeteis.\n Movimenta\ufffd\ufffdo no ranking agora \ufffd contabilizado corretamente.\n \n 11 Dezembro 2015,\n-Corrigi bug que nao permitia ao tentar aceitar quest remotamente (lightbulb).\n+Correcao de bug que nao permitia ao tentar aceitar quest remotamente (lightbulb).\n \n 26 --- 29 Dezembro 2015,\n Correcao de movimentacao no Ranking, a cada atualizacao do sistema.\n-Implementacao e aprimoramento das funcionalidades de ItemSort e SlotMerger do inventario.\n\\ No newline at end of file\n+Implementacao e aprimoramento das funcionalidades de ItemSort e SlotMerger do inventario.\n+Correcao de bug em scripts que fazia o jogador ficar preso num mapa de transicao (barco, por ex.).\n+\n+01 Janeiro 2016,\n+Correcao de bug, onde o sistema nao contabilizava corretamente queda de HP em determinados mapas.\n+\n+03 Janeiro 2016,\n+Correcao de bug, onde clientes podiam congelar apos acessar o Cash Shop.\n\\ No newline at end of file"}, {"sha": "f33c95db5f0a5759169d89ac8aa534a297027f17", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -3,7 +3,25 @@\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/RankingWorker.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/world/World.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/server/MapleStatEffect.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/MapleServerHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/client/MapleClient.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/PlayerStorage.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/client/command/Commands.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/client/MapleCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/ChangeMapSpecialHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/tools/MaplePacketCreator.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/EnterMTSHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/Channel.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/EnterCashShopHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/ChangeMapHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/StorageHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/PlayerLoggedinHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/PacketProcessor.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/net/server/channel/handlers/ChangeChannelHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/constants/ServerConstants.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/server/maps/MapleMap.java</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "c2a9e5710a43656a426e1689f360436ba8ecdafc", "filename": "scripts/event/Trains.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/scripts/event/Trains.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/scripts/event/Trains.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Trains.js?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -10,7 +10,7 @@ var Orbis_Station;\n var Ludibrium_Station;\n \n //Time Setting is in millisecond\n-var closeTime = 60 * 1000; //The time to close the gate\n+var closeTime = 50 * 1000; //The time to close the gate\n var beginTime = 60 * 1000; //The time to begin the ride\n var rideTime = 60 * 1000; //The time that require move to destination\n "}, {"sha": "60dc99be815c816e9c15c3c7063a6e0c06521286", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -2971,7 +2971,7 @@ public void setRates() {\n \n     public static MapleCharacter loadCharFromDB(int charid, MapleClient client, boolean channelserver) throws SQLException {\n         try {\n-            MapleCharacter ret = new MapleCharacter();\n+            MapleCharacter ret = new MapleCharacter();            \n             ret.client = client;\n             ret.id = charid;\n             Connection con = DatabaseConnection.getConnection();\n@@ -3857,6 +3857,7 @@ public synchronized void saveCooldowns() {\n                     ps.executeBatch();\n                 }\n             } catch (SQLException se) {\n+                se.printStackTrace();\n             }\n         }\n     }\n@@ -3871,6 +3872,7 @@ public void saveGuildStatus() {\n                 ps.execute();\n             }\n         } catch (SQLException se) {\n+            se.printStackTrace();\n         }\n     }\n \n@@ -3959,6 +3961,7 @@ public final boolean insertNewChar() {\n                 con.setAutoCommit(true);\n                 con.setTransactionIsolation(Connection.TRANSACTION_REPEATABLE_READ);\n             } catch (SQLException e) {\n+                e.printStackTrace();\n             }\n         }\n     }\n@@ -4216,7 +4219,7 @@ public synchronized void saveToDB() {\n             con.commit();\n \t\t\tcon.setAutoCommit(true);\n \t\t\t\n-\t\t\tif (cashshop != null) {\n+            if (cashshop != null) {\n                 cashshop.save(con);\n             }\n             if (storage != null) {"}, {"sha": "9d56cff9c024314f4feb00f12f2612941ae267a0", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -506,6 +506,7 @@ public int login(String login, String pwd) {\n \t\t\t\t\trs.close();\n \t\t\t\t}\n \t\t\t} catch (SQLException e) {\n+                            e.printStackTrace();\n \t\t\t}\n \t\t}\n \t\tif (loginok == 0) {\n@@ -755,12 +756,12 @@ private void removePlayer() {\n \t}\n \n \tpublic final void disconnect(boolean shutdown, boolean cashshop) {//once per MapleClient instance\n-\t\tif (disconnecting) {\n+                if (disconnecting) {\n \t\t\treturn;\n \t\t}\n \t\tdisconnecting = true;\n \t\tif (player != null && player.isLoggedin() && player.getClient() != null) {\n-\t\t\tMapleMap map = player.getMap();\n+                        MapleMap map = player.getMap();\n \t\t\tfinal MapleParty party = player.getParty();\n \t\t\tfinal int idz = player.getId();\n \t\t\tfinal int messengerid = player.getMessenger() == null ? 0 : player.getMessenger().getId();\n@@ -771,13 +772,17 @@ public final void disconnect(boolean shutdown, boolean cashshop) {//once per Map\n \t\t\tfinal MapleGuildCharacter chrg = player.getMGC();\n \t\t\tfinal MapleGuild guild = player.getGuild();\n \n-\t\t\tremovePlayer();\n-\t\t\tplayer.saveCooldowns();\n-\t\t\tplayer.saveToDB();\n \t\t\tif (channel == -1 || shutdown) {\n+                                removePlayer();\n+                                player.saveCooldowns();\n+                                player.saveToDB();\n+                            \n \t\t\t\tplayer = null;\n \t\t\t\treturn;\n \t\t\t}\n+                        \n+                        removePlayer();\n+\t\t\t\n \t\t\tfinal World worlda = getWorldServer();\n \t\t\ttry {\n \t\t\t\tif (!cashshop) {\n@@ -854,7 +859,10 @@ public final void disconnect(boolean shutdown, boolean cashshop) {//once per Map\n \t\t\t\t\t}\n \t\t\t\t\tplayer.logOff();\n \t\t\t\t}\n-\t\t\t\tplayer = null;\n+\t\t\t\t\n+                                player.saveCooldowns();\n+                                player.saveToDB();\n+                                player = null;\n \t\t\t}\n \t\t}\n \t\tif (!serverTransition && isLoggedIn()) {"}, {"sha": "2aa3eab80a761cd70a64b150a35f7976f829ddac", "filename": "src/client/MonsterBook.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MonsterBook.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/client/MonsterBook.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MonsterBook.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -56,6 +56,7 @@ public void addCard(final MapleClient c, final int cardid) {\n         c.announce(MaplePacketCreator.addCard(false, cardid, 1));\n         c.announce(MaplePacketCreator.showGainCard());\n         calculateLevel();\n+        \n         c.getPlayer().saveToDB();\n     }\n "}, {"sha": "f8b6eff693e4eb38aef50a20741be9d87bcb3529", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -29,6 +29,7 @@\n     public static final boolean USE_FAMILY_SYSTEM = false;\n     public static final boolean USE_DUEY = true;\n     public static final boolean USE_ITEM_SORT = true;\n+    public static final boolean USE_ITEM_SORT_BY_NAME = false;  //item sorting based on name rather than id.\n     public static final boolean USE_PARTY_SEARCH = false;\n     public static final boolean USE_AUTOBAN = false;            //commands the server to detect infractors automatically.\n     public static final boolean USE_ANOTHER_AUTOASSIGN = true;  //based on distributing AP accordingly with higher secondary stat on equipments."}, {"sha": "7608c777b0d4095fe7f7957437787139671a67c6", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -60,7 +60,9 @@ public MapleServerHandler(int world, int channel) {\n \n     @Override\n     public void exceptionCaught(IoSession session, Throwable cause) throws Exception {\n-    \tif (cause instanceof IOException || cause instanceof ClassCastException) {\n+    \tSystem.out.println(\"disconnect by exception\");\n+        \n+        if (cause instanceof IOException || cause instanceof ClassCastException) {\n             return;\n         }\n         MapleClient mc = (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n@@ -107,7 +109,7 @@ public void sessionClosed(IoSession session) throws Exception {\n             try {\n                 boolean inCashShop = false;\n                 if (client.getPlayer() != null) {\n-                    inCashShop = client.getPlayer().getCashShop().isOpened();                  \n+                    inCashShop = client.getPlayer().getCashShop().isOpened();\n                 }\n                 client.disconnect(false, inCashShop);\n             } catch (Throwable t) {"}, {"sha": "f5a79dfbf94b44e3ff8e1702b3151acadffb2e1c", "filename": "src/net/server/Server.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -595,6 +595,7 @@ public void run() {\n                     try {\n                         instance.finalize();//FUU I CAN AND IT'S FREE\n                     } catch (Throwable ex) {\n+                        ex.printStackTrace();\n                     }\n                     instance = null;\n                     System.gc();"}, {"sha": "e4cf6e8d47c7fe68a24491ca09e7588eb8fbd610", "filename": "src/net/server/channel/handlers/AllianceOperationHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/AllianceOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/AllianceOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AllianceOperationHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -126,6 +126,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             default:\n                 c.getPlayer().dropMessage(\"Feature not available\");\n         }\n+        \n         alliance.saveToDB();\n     }\n "}, {"sha": "69d7b32c0b4f775ee4527e8d9edcf679905b1f71", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -47,6 +47,7 @@\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         CashShop cs = chr.getCashShop();\n+        \n         if (!cs.isOpened()) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n@@ -98,6 +99,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             try {\n                 chr.sendNote(recipient.get(\"name\"), chr.getName() + \" has sent you a gift! Go check out the Cash Shop.\", (byte) 0); //fame or not\n             } catch (SQLException ex) {\n+                ex.printStackTrace();\n             }\n             MapleCharacter receiver = c.getChannelServer().getPlayerStorage().getCharacterByName(recipient.get(\"name\"));\n             if (receiver != null) receiver.showNote();\n@@ -283,6 +285,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         try {\n                             chr.sendNote(partner.getName(), text, (byte) 1);\n                         } catch (SQLException ex) {\n+                            ex.printStackTrace();\n                         }\n                         partner.showNote();\n                     }"}, {"sha": "4aaf4bd530217acd57ebab70a54b4b3f912bfff6", "filename": "src/net/server/channel/handlers/ChangeMapHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ChangeMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ChangeMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeMapHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -49,7 +49,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t}\n \t\tif (slea.available() == 0) { //Cash Shop :)\n \t\t\tif(!chr.getCashShop().isOpened()) {                 \n-\t\t\t\tc.disconnect(false, false);               \n+                            c.disconnect(false, false);               \n \t\t\t\treturn;           \n \t\t\t}\n \t\t\tString[] socket = c.getChannelServer().getIP().split(\":\");\n@@ -62,7 +62,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t}\n \t\t} else {\n \t\t\tif(chr.getCashShop().isOpened()) {                 \n-\t\t\t\tc.disconnect(false, false);               \n+\t\t\t\tc.disconnect(false, false);\n \t\t\t\treturn;           \n \t\t\t}\n \t\t\ttry {"}, {"sha": "c91c82b86b9158daf4807953eafa9d1527d743c9", "filename": "src/net/server/channel/handlers/EnterCashShopHandler.java", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/EnterCashShopHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/EnterCashShopHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterCashShopHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -38,21 +38,25 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         try {\n         \tMapleCharacter mc = c.getPlayer();\n \n-        \tif (mc.getCashShop().isOpened()) return;\n+        \tif (mc.getCashShop().isOpened()) {\n+                    return;\n+                }\n         \t\n-\t\t\tServer.getInstance().getPlayerBuffStorage().addBuffsToStorage(mc.getId(), mc.getAllBuffs());\n+\t\tServer.getInstance().getPlayerBuffStorage().addBuffsToStorage(mc.getId(), mc.getAllBuffs());\n \t        mc.cancelBuffEffects();\n \t        mc.cancelExpirationTask();\n-\t\t\tc.announce(MaplePacketCreator.openCashShop(c, false));\n-\t\t\tmc.saveToDB();\n-\t\t\tmc.getCashShop().open(true);\n-\t\t\tmc.getMap().removePlayer(mc);\n-\t\t\tc.getChannelServer().removePlayer(mc);\n-\t\t\t\n-\t\t\tc.announce(MaplePacketCreator.showCashInventory(c));                \n-\t\t\tc.announce(MaplePacketCreator.showGifts(mc.getCashShop().loadGifts()));\n-\t\t\tc.announce(MaplePacketCreator.showWishList(mc, false));\n-\t\t\tc.announce(MaplePacketCreator.showCash(mc));\n+                \n+\t\tc.announce(MaplePacketCreator.openCashShop(c, false));\n+                c.announce(MaplePacketCreator.showCashInventory(c));\n+\t\tc.announce(MaplePacketCreator.showGifts(mc.getCashShop().loadGifts()));\n+\t\tc.announce(MaplePacketCreator.showWishList(mc, false));\n+\t\tc.announce(MaplePacketCreator.showCash(mc));\n+                        \n+                \n+\t\tc.getChannelServer().removePlayer(mc);\n+                mc.getMap().removePlayer(mc);\n+                mc.getCashShop().open(true);\n+                mc.saveToDB();\n         } catch (Exception e) {\n             e.printStackTrace();\n         }"}, {"sha": "06e4a174223af21030dc449b20007f1139f50ed6", "filename": "src/net/server/channel/handlers/EnterMTSHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/EnterMTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/EnterMTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterMTSHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -60,10 +60,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         Server.getInstance().getPlayerBuffStorage().addBuffsToStorage(chr.getId(), chr.getAllBuffs());\n         chr.cancelExpirationTask();\n         chr.saveToDB();\n+        System.out.println(\"STRANGE SAVE TO DB\");\n         chr.getMap().removePlayer(c.getPlayer());\n         try {\n             c.announce(MaplePacketCreator.openCashShop(c, true));\n         } catch (Exception ex) {\n+            ex.printStackTrace();\n         }\n         chr.getCashShop().open(true);// xD\n         c.announce(MaplePacketCreator.enableCSUse());"}, {"sha": "9a367916f343baf1c804eccdd38d907a3982cc19", "filename": "src/net/server/channel/handlers/ItemIdSortHandler.java", "status": "modified", "additions": 161, "deletions": 17, "changes": 178, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ItemIdSortHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ItemIdSortHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ItemIdSortHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -22,7 +22,6 @@\n package net.server.channel.handlers;\n \n import java.util.ArrayList;\n-import java.util.Collections;\n import java.util.List;\n \n import constants.ServerConstants;\n@@ -32,55 +31,200 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Item;\n+import client.inventory.Equip;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.inventory.ModifyInventory;\n+import server.MapleItemInformationProvider;\n \n /**\n  *\n  * @author BubblesDev\n  */\n-public final class ItemIdSortHandler extends AbstractMaplePacketHandler {\n \n+class PairedQuicksort {\n+    /* by RonanLana */\n+    \n+    private int i = 0;\n+    private int j = 0;\n+    private final ArrayList<Integer> intersect;\n+    MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+    \n+    private void PartitionByItemId(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (x.getItemId() > A.get(i).getItemId()) i++;\n+            while (x.getItemId() < A.get(j).getItemId()) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByName(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (ii.getName(x.getItemId()).compareTo(ii.getName(A.get(i).getItemId())) > 0) i++;\n+            while (ii.getName(x.getItemId()).compareTo(ii.getName(A.get(j).getItemId())) < 0) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByQuantity(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (x.getQuantity() > A.get(i).getQuantity()) i++;\n+            while (x.getQuantity() < A.get(j).getQuantity()) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByLevel(int Esq, int Dir, ArrayList<Item> A) {\n+        Equip x, w, eqpI, eqpJ;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = (Equip)(A.get((i + j) / 2));\n+        \n+        do {\n+            eqpI = (Equip)A.get(i);\n+            eqpJ = (Equip)A.get(j);\n+            \n+            while (x.getLevel() > eqpI.getLevel()) i++;\n+            while (x.getLevel() < eqpJ.getLevel()) j--;\n+            \n+            if (i <= j) {\n+                w = (Equip)A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, (Item)w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+\n+    void MapleQuicksort(int Esq, int Dir, ArrayList<Item> A, int sort) {\n+        switch(sort) {\n+            case 3:\n+                PartitionByLevel(Esq, Dir, A);\n+                break;\n+            \n+            case 2:\n+                PartitionByName(Esq, Dir, A);\n+                break;\n+                \n+            case 1:\n+                PartitionByQuantity(Esq, Dir, A);\n+                break;\n+                    \n+            default:\n+                PartitionByItemId(Esq, Dir, A);\n+        }\n+        \n+        \n+        if (Esq < j) MapleQuicksort(Esq, j, A, sort);\n+        if (i < Dir) MapleQuicksort(i, Dir, A, sort);\n+    }\n+    \n+    public PairedQuicksort(ArrayList<Item> A, int primarySort, int secondarySort) {\n+        intersect = new ArrayList<>();\n+        \n+        MapleQuicksort(0, A.size() - 1, A, primarySort);\n+        \n+        intersect.add(0);\n+        for(int ind = 1; ind < A.size(); ind++) {\n+            if(A.get(ind - 1).getItemId() != A.get(ind).getItemId()) {\n+                intersect.add(ind);\n+            }\n+        }\n+        intersect.add(A.size());\n+        \n+        for(int ind = 0; ind < intersect.size() - 1; ind++) {\n+            MapleQuicksort(intersect.get(ind), intersect.get(ind + 1) - 1, A, secondarySort);\n+        }\n+    }\n+}\n+\n+public final class ItemIdSortHandler extends AbstractMaplePacketHandler {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-    \tMapleCharacter chr = c.getPlayer();\n-        chr.getAutobanManager().setTimestamp(4, slea.readInt(), 3);\n+        MapleCharacter chr = c.getPlayer();\n+        chr.getAutobanManager().setTimestamp(3, slea.readInt(), 3);\n         byte inventoryType = slea.readByte();\n         \n-        if(!chr.isGM() || !ServerConstants.USE_ITEM_SORT) {\n-\t\t\tc.announce(MaplePacketCreator.enableActions());\n-\t\t\treturn;\n-\t\t}\n+        if(!ServerConstants.USE_ITEM_SORT) {\n+            c.announce(MaplePacketCreator.enableActions());\n+            return;\n+        }\n \t\t\n-\t\tif (inventoryType < 1 || inventoryType > 5) {\n+\tif (inventoryType < 1 || inventoryType > 5) {\n             c.disconnect(false, false);\n             return;\n         }\n \t\t\n         MapleInventory inventory = chr.getInventory(MapleInventoryType.getByType(inventoryType));\n+        \n         ArrayList<Item> itemarray = new ArrayList<>();\n         List<ModifyInventory> mods = new ArrayList<>();\n+        \n         for (short i = 1; i <= inventory.getSlotLimit(); i++) {\n             Item item = inventory.getItem(i);\n             if (item != null) {\n             \titemarray.add((Item) item.copy());\n             }\n         }\n         \n-        Collections.sort(itemarray);\n         for (Item item : itemarray) {\n-        \tinventory.removeItem(item.getPosition());\n+                inventory.removeSlot(item.getPosition());\n+                mods.add(new ModifyInventory(3, item));\n         }\n         \n+        int invTypeCriteria = (MapleInventoryType.getByType(inventoryType) == MapleInventoryType.EQUIP) ? 3 : 1;\n+        int sortCriteria = (ServerConstants.USE_ITEM_SORT_BY_NAME == true) ? 2 : 0;\n+        PairedQuicksort pq = new PairedQuicksort(itemarray, sortCriteria, invTypeCriteria);\n+        \n         for (Item item : itemarray) {\n-        \t//short position = item.getPosition();\n             inventory.addItem(item);\n-            if (inventory.getType().equals(MapleInventoryType.EQUIP)) {\n-\t            mods.add(new ModifyInventory(3, item));\n-\t            mods.add(new ModifyInventory(0, item.copy()));//to prevent crashes\n-\t            //mods.add(new ModifyInventory(2, item.copy(), position));\n-            }\n+\t    mods.add(new ModifyInventory(0, item.copy()));//to prevent crashes\n         }\n         itemarray.clear();\n         c.announce(MaplePacketCreator.modifyInventory(true, mods));"}, {"sha": "24a53b8470520e1648adea9062687a91312ab788", "filename": "src/net/server/channel/handlers/ItemSortHandler.java", "status": "modified", "additions": 40, "deletions": 16, "changes": 56, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ItemSortHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/ItemSortHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ItemSortHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -28,31 +28,55 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleCharacter;\n import client.MapleClient;\n+import client.inventory.Item;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n+import server.MapleItemInformationProvider;\n \n public final class ItemSortHandler extends AbstractMaplePacketHandler {\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-    \tMapleCharacter chr = c.getPlayer();\n-\t\tchr.getAutobanManager().setTimestamp(2, slea.readInt(), 3);\n-\t\tMapleInventoryType inventoryType = MapleInventoryType.getByType(slea.readByte());\n-\t\tif (inventoryType.equals(MapleInventoryType.UNDEFINED) || c.getPlayer().getInventory(inventoryType).isFull()) {\n-\t\t    c.getSession().write(MaplePacketCreator.enableActions());\n-\t\t    return;\n-\t\t}\n-\t\tif(ServerConstants.USE_ITEM_SORT == false) {\n-\t\t\tc.announce(MaplePacketCreator.enableActions());\n-\t\t\treturn;\n-\t\t}\n+        MapleCharacter chr = c.getPlayer();\n+        chr.getAutobanManager().setTimestamp(2, slea.readInt(), 3);\n+        MapleInventoryType inventoryType = MapleInventoryType.getByType(slea.readByte());\n+                \n+\tif(!ServerConstants.USE_ITEM_SORT) {\n+\t\tc.announce(MaplePacketCreator.enableActions());\n+\t\treturn;\n+\t}\n \t\t\n-\t\tMapleInventory inventory = c.getPlayer().getInventory(inventoryType);\n+\tMapleInventory inventory = c.getPlayer().getInventory(inventoryType);\n+        \n+        //------------------- RonanLana's SLOT MERGER -----------------\n+                \n+                MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+                Item srcItem, dstItem;\n+                \n+                for(short dst = 0; dst <= inventory.getSlotLimit(); dst++) {\n+                    dstItem = inventory.getItem(dst);\n+                    if(dstItem == null) continue;\n+                    \n+                    for(short src = (short)(dst + 1); src <= inventory.getSlotLimit(); src++) {\n+                        srcItem = inventory.getItem(src);\n+                        if(srcItem == null) continue;\n+                        \n+                        if(dstItem.getItemId() != srcItem.getItemId()) continue;\n+                        if(dstItem.getQuantity() == ii.getSlotMax(c, inventory.getItem(dst).getItemId())) break;\n+                        \n+                        MapleInventoryManipulator.move(c, inventoryType, src, dst);\n+                    }\n+                }\n+                \n+        //------------------------------------------------------------\n+                \n+                inventory = c.getPlayer().getInventory(inventoryType);\n \t\tboolean sorted = false;\n \t\t\n \t\twhile (!sorted) {\n-\t\t\tshort freeSlot = inventory.getNextFreeSlot();\n-\t\t    if (freeSlot != -1) {\n+                    short freeSlot = inventory.getNextFreeSlot();\n+                    \n+                    if (freeSlot != -1) {\n \t\t        short itemSlot = -1;\n \t\t        for (short i = (short) (freeSlot + 1); i <= inventory.getSlotLimit(); i = (short) (i + 1)) {\n \t\t            if (inventory.getItem(i) != null) {\n@@ -69,7 +93,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t        sorted = true;\n \t\t    }\n \t\t}\n-\t\tc.getSession().write(MaplePacketCreator.finishedSort(inventoryType.getType()));\n-\t\tc.getSession().write(MaplePacketCreator.enableActions());\n+\t\tc.announce(MaplePacketCreator.finishedSort(inventoryType.getType()));\n+\t\tc.announce(MaplePacketCreator.enableActions());\n     }\n }\n\\ No newline at end of file"}, {"sha": "2c7e576118385e017c799b0c780091f94f13bcb6", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 18, "deletions": 5, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -50,6 +50,7 @@\n import client.inventory.MaplePet;\n import client.inventory.PetDataFactory;\n import constants.GameConstants;\n+import java.util.concurrent.ScheduledFuture;\n import server.TimerManager;\n \n public final class PlayerLoggedinHandler extends AbstractMaplePacketHandler {\n@@ -76,9 +77,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             player.newClient(c);\n         }\n         if (player == null) { //If you are still getting null here then please just uninstall the game >.>, we dont need you fucking with the logs\n-        \tc.disconnect(true, false);\n-        \treturn;\n+            c.disconnect(true, false);\n+            return;\n         }\n+        \n         c.setPlayer(player);\n         c.setAccID(player.getAccountID());\n         \n@@ -104,6 +106,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         c.updateLoginState(MapleClient.LOGIN_LOGGEDIN);\n \n         cserv.addPlayer(player);\n+        \n         List<PlayerBuffValueHolder> buffs = server.getPlayerBuffStorage().getBuffsFromStorage(cid);\n         if (buffs != null) {\n             player.silentGiveBuffs(buffs);\n@@ -159,7 +162,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         player.getMap().addPlayer(player);\n         World world = server.getWorld(c.getWorld());\n         world.getPlayerStorage().addPlayer(player);\n-        \n+            \n         int buddyIds[] = player.getBuddylist().getBuddyIds();\n         world.loggedOn(player.getName(), player.getId(), c.getChannel(), buddyIds);\n         for (CharacterIdChannelPair onlineBuddy : server.getWorld(c.getWorld()).multiBuddyFind(player.getId(), buddyIds)) {\n@@ -206,6 +209,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n             }\n         }\n+\n         player.showNote();\n         if (player.getParty() != null) {\n             MaplePartyCharacter pchar = player.getMPC();\n@@ -253,9 +257,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             \tServer.getInstance().broadcastGMMessage(MaplePacketCreator.earnTitleMessage(\"GM \" + player.getName() + \" has logged in\"));\n             }\n             \n-            if (player.getMap().getHPDec() > 0) {\n-                player.doHurtHp();\n+            \n+        }\n+        \n+        if (player.getMap().getHPDec() > 0) {\n+            final MapleCharacter mc = player;\n+            \n+            ScheduledFuture<?> hpDecreaseTask = TimerManager.getInstance().schedule(new Runnable() {\n+            @Override\n+            public void run() {\n+                mc.doHurtHp();\n             }\n+            }, 10000);\n         }\n     }\n }"}, {"sha": "acb54d19a854f1856b0b396d15a7f8c50196374b", "filename": "src/net/server/handlers/login/AfterLoginHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/handlers/login/AfterLoginHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/net/server/handlers/login/AfterLoginHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/AfterLoginHandler.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -30,6 +30,8 @@\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        System.out.println(\"after login\");\n+        \n         byte c2 = slea.readByte();\n         byte c3 = 5;\n         if (slea.available() > 0) {"}, {"sha": "73edf5f9853e56edfe83bb67fc6ca9f77cb17097", "filename": "src/server/CashShop.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7e32e5a7624aa95bd538fe65db73f4281b3b5218/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=7e32e5a7624aa95bd538fe65db73f4281b3b5218", "patch": "@@ -175,6 +175,7 @@ public byte getInfo() {\n                     if (rs != null) rs.close();\n                     if (ps != null) ps.close();\n                 } catch (SQLException ex) {\n+                    ex.printStackTrace();\n                 }\n             }\n         }"}]}]},
