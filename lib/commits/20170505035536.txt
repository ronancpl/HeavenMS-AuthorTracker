{"fetchDate": "2019-12-19", "content": [{"sha": "da00345aec775bb2a58ef8b9757b89d21e938044", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZGEwMDM0NWFlYzc3NWJiMmE1OGVmOGI5NzU3Yjg5ZDIxZTkzODA0NA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-05T03:55:36Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-05T03:55:36Z"}, "message": "KerningPQ + some boosts on PQ/event scripting\n\nAdded cleaner mechanics for dealing with PQs and events (bonus Exp when\nclearing a stage, for instance). Reimplemented KerningPQ.", "tree": {"sha": "fb40feb85197d34c5cc3e2549f28507fbe66acca", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/fb40feb85197d34c5cc3e2549f28507fbe66acca"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/da00345aec775bb2a58ef8b9757b89d21e938044", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/da00345aec775bb2a58ef8b9757b89d21e938044", "html_url": "https://github.com/ronancpl/HeavenMS/commit/da00345aec775bb2a58ef8b9757b89d21e938044", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/da00345aec775bb2a58ef8b9757b89d21e938044/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "03ab8be97d7b3d116e86f9848292101f63947eb2", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/03ab8be97d7b3d116e86f9848292101f63947eb2", "html_url": "https://github.com/ronancpl/HeavenMS/commit/03ab8be97d7b3d116e86f9848292101f63947eb2"}], "stats": {"total": 2240, "additions": 1235, "deletions": 1005}, "files": [{"sha": "dc5f63184274f66e273ab63997da4b4efc61e0c4", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -185,4 +185,19 @@ Corre\n \n 29 Abril 2017,\n Novos m\ufffdtodos para uso especializado em eventos caracteristicos de PQ.\n-Aprimora\ufffd\ufffdo da Boss Rush PQ: novo sistema de recompensas.\n\\ No newline at end of file\n+Aprimora\ufffd\ufffdo da Boss Rush PQ: novo sistema de recompensas.\n+\n+01 Maio 2017,\n+Corre\ufffd\ufffdo de bugs menores na BRPQ.\n+Refatora\ufffd\ufffdo de c\ufffddigo pertinente aos Cash USEs para Pet.\n+Anima\ufffd\ufffdo para Pets ao consumirem pet food.\n+\n+02 Maio 2017,\n+Reestrutura\ufffd\ufffdo e refatora\ufffd\ufffdo de c\ufffddigo para PQs (fun\ufffd\ufffdes espec\ufffdficas para uso em PQs).\n+Reimplementa\ufffd\ufffdo da Kerning PQ.\n+\n+03 Maio 2017,\n+Para quests que podem ser repetidas, adi\ufffd\ufffdo de mensagem mencionando o tempo restante para recome\ufffd\ufffd-la.\n+\n+04 - 05 Maio 2017,\n+Finaliza\ufffd\ufffdo da reimplementa\ufffd\ufffdo da Kerning PQ, com adi\ufffd\ufffdo de novos mecanismos esperados em eventos/PQs.\n\\ No newline at end of file"}, {"sha": "9b65b85a48e59c3f90dd97d4ccf998d03cb1107c", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 7, "deletions": 23, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -3,30 +3,14 @@\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/command/Commands.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MonsterBook.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/raid_stage.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/AbstractPlayerInteraction.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/constants/ServerConstants.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/1022101.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/1012103.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/tools/MaplePacketCreator.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9000038.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/raid_rest.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleDisease.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq3.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq4.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq1.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9020001.js</file>\n             <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/event/EventInstanceManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/BossRushPQ.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/QuestActionHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/npc/NPCConversationManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9000037.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleMap.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/raidout.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/PiratePQ.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleClient.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/event/EventManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/MapleQuest.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/requirements/MonsterBookCountRequirement.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq2.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/KerningPQ.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq0.js</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "5d8de9a5d49b3f7737dab717b8aac58983da8a72", "filename": "scripts/event/0_EXAMPLE.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/0_EXAMPLE.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/0_EXAMPLE.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/0_EXAMPLE.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -66,7 +66,7 @@ function disbandParty(eim, player) {\n }\n \n function clearPQ(eim) {\n-    // Happens when the function EventInstanceManager.finishPQ() is invoked by NPC/Reactor script\n+    // Happens when the function EventInstanceManager.clearPQ() is invoked by NPC/Reactor script\n }\n \n function removePlayer(eim, player) {"}, {"sha": "f75a1e35f477b42f998198631ef27412899c86a4", "filename": "scripts/event/BossRushPQ.js", "status": "modified", "additions": 26, "deletions": 36, "changes": 62, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/BossRushPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/BossRushPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BossRushPQ.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -69,9 +69,10 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n function setup(level, leaderid) {\n         em.setProperty(\"state\", \"1\");\n \tem.setProperty(\"leader\", \"true\");\n+        \n         var eim = em.newInstance(\"BossRush\" + leaderid);\n-\t\n-        em.setProperty(\"level\", level);\n+        eim.setProperty(\"level\", level);\n+        \n         eim.startEventTimer(45 * 60000); //45 mins\n         setEventRewards(eim);\n         return eim;\n@@ -93,8 +94,7 @@ function playerExit(eim, player) {\n \n function changedMap(eim, player, mapid) {\n         if (mapid < 970030001 || mapid > 970042711) {\n-                var party = eim.getPlayers();\n-                if (eim.isLeader(player) || party.size() <= minPlayers) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n                 }\n@@ -106,8 +106,7 @@ function changedMap(eim, player, mapid) {\n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n-        var party = eim.getPlayers();\n-        if (eim.isLeader(player) || party.size() <= minPlayers) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                 eim.unregisterPlayer(player);\n                 end(eim);\n         }\n@@ -117,16 +116,14 @@ function playerRevive(eim, player) { // player presses ok on the death pop up.\n \n \n function playerDisconnected(eim, player) {\n-        var party = eim.getPlayers();\n-        if (eim.isLeader(player) || party.size() <= minPlayers)\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player))\n                 end(eim);\n         else\n                 playerExit(eim, player);\n }\n \n function leftParty(eim, player) {\n-        var party = eim.getPlayers();\n-        if (party.size() <= minPlayers)\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n                 end(eim);\n         else\n                 playerExit(eim, player);\n@@ -137,35 +134,33 @@ function disbandParty(eim) {\n }\n \n function monsterValue(eim, mobId) {\n-    return 1;\n+        return 1;\n }\n \n function end(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n-}\n-\n-function playerClear(eim, player, toMap) {\n-    eim.unregisterPlayer(player);\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function complete(eim, toMap) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerClear(eim, party.get(i), toMap);\n-    }\n-    eim.dispose();\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();      // from now on event just finishes when ALL players gets out of the range defined inside changedMap function.\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function clearPQ(eim, toMap) {\n-    complete(eim, toMap);\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n }\n \n-function giveRandomEventReward(eim, player) {\n-    eim.giveEventReward(player);\n+function reopenEvent() {\n+        em.setProperty(\"state\", \"0\");\n+        em.setProperty(\"leader\", \"true\");\n }\n \n function monsterKilled(mob, eim) {}\n@@ -174,9 +169,4 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n-function dispose(eim) {\n-    em.cancelSchedule();\n-    \n-    em.setProperty(\"state\", \"0\");\n-    em.setProperty(\"leader\", \"true\");\n-}\n+function dispose(eim) {}"}, {"sha": "5ebb88eeb7cb7705507524c85393cac424a0d99c", "filename": "scripts/event/Ellin.js", "status": "modified", "additions": 53, "deletions": 76, "changes": 129, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/Ellin.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/Ellin.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Ellin.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,6 +1,6 @@\n var isPq = true;\n-var minPlayers = 4, maxPlayers = 6;\n-var minLevel = 44, maxLevel = 55;\n+var minPlayers = 1, maxPlayers = 6;\n+var minLevel = 1, maxLevel = 200;\n var entryMap = 930000000;\n var exitMap = 930000800;\n var recruitMap = 300030100;\n@@ -35,8 +35,10 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n function setup(level, leaderid) {\n         em.setProperty(\"state\", \"1\");\n \tem.setProperty(\"leader\", \"true\");\n+        \n         var eim = em.newInstance(\"Ellin\" + leaderid);\n-\n+        eim.setProperty(\"level\", level);\n+        \n         eim.setInstanceMap(930000000).resetPQ(level);\n \teim.setInstanceMap(930000100).resetPQ(level);\n \teim.setInstanceMap(930000200).resetPQ(level);\n@@ -55,109 +57,89 @@ function setup(level, leaderid) {\n \n function respawnStg2(eim) {    \n     if(!eim.getMapInstance(930000200).getAllPlayer().isEmpty()) eim.getMapInstance(930000200).instanceMapRespawn();\n-    em.schedule(\"respawnStg2\", eim, 4 * 1000);\n+    eim.schedule(\"respawnStg2\", 4 * 1000);\n }\n \n function changedMap(eim, player, mapid) {\n-    if (mapid < 930000000 || mapid > 930000800) {\n-\teim.unregisterPlayer(player);\n-        if(eim.getPlayers().isEmpty()) end(eim);\n-    }\n+        if (mapid < 930000000 || mapid > 930000800) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n }\n \n function playerEntry(eim, player) {\n-    var map = eim.getMapInstance(entryMap);\n-    player.changeMap(map, map.getPortal(0));\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n }\n \n function scheduledTimeout(eim) {\n-    end(eim);\n+        end(eim);\n }\n \n-function removePlayer(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, 0);\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n }\n \n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n-    if (eim.isLeader(player) || party.size() <= minPlayers) { // Check for party leader\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n \n function playerDisconnected(eim, player) {\n-    var party = eim.getPlayers();\n-    if (eim.isLeader(player) || party.size() < minPlayers) {\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            if (party.get(i).equals(player))\n-                removePlayer(eim, player);\n-            else\n-                playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        removePlayer(eim, player);\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player))\n+                end(eim);\n+        else\n+                playerExit(eim, player);\n }\n \n function leftParty(eim, player) {\n-    var party = eim.getPlayers();\n-    if (party.size() < minPlayers) {\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim,party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n+                end(eim);\n+        else\n+                playerExit(eim, player);\n }\n \n function disbandParty(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n-}\n-\n-function playerExit(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, 0);\n+        end(eim);\n }\n \n function monsterValue(eim, mobId) {\n-    return 1;\n+        return 1;\n }\n \n function end(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n-}\n-\n-function playerClear(eim, player, toMap) {\n-    eim.unregisterPlayer(player);\n-    \n-    if(toMap != null) player.changeMap(toMap);\n-    else player.changeMap(clearMap, 0);\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function complete(eim, toMap) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerClear(eim, party.get(i), toMap);\n-    }\n-    eim.dispose();\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+        eim.warpEventTeam(toMap);\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function clearPQ(eim, toMap) {\n-    complete(eim, toMap);\n+function reopenEvent() {\n+        em.setProperty(\"state\", \"0\");\n+        em.setProperty(\"leader\", \"true\");\n }\n \n function monsterKilled(mob, eim) {}\n@@ -166,9 +148,4 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n-function dispose(eim) {\n-    em.cancelSchedule();\n-    \n-    em.setProperty(\"state\", \"0\");\n-    em.setProperty(\"leader\", \"true\");\n-}\n+function dispose(eim) {}"}, {"sha": "bdff3cdbe036bcc51c21f4f88a52406827458708", "filename": "scripts/event/KerningPQ.js", "status": "modified", "additions": 118, "deletions": 123, "changes": 241, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/KerningPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/KerningPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KerningPQ.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,140 +1,153 @@\n-/*\n- * This file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-                       Matthias Butz <matze@odinms.de>\n-                       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License version 3\n-    as published by the Free Software Foundation. You may not use, modify\n-    or distribute this program under any other version of the\n-    GNU Affero General Public License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n- */\n-\n-/*\n-INSERT monsterdrops (monsterid,itemid,chance) VALUES (9300001,4001007,5);\n-INSERT monsterdrops (monsterid,itemid,chance) VALUES (9300000,4001008,1);\n-INSERT monsterdrops (monsterid,itemid,chance) VALUES (9300002,4001008,1);\n-INSERT monsterdrops (monsterid,itemid,chance) VALUES (9300003,4001008,1);\n-*/\n-\n-importPackage(Packages.world);\n-var exitMap;\n-var minPlayers = 3;\n-\n-function init() { // Initial loading.\n-    exitMap = em.getChannelServer().getMapFactory().getMap(103000890);\n-    em.setProperty(\"KPQOpen\", \"true\"); // allows entrance.\n-    em.setProperty(\"shuffleReactors\", \"true\");\n-    instanceId = 1;\n+var isPq = true;\n+var minPlayers = 1, maxPlayers = 6;\n+var minLevel = 1, maxLevel = 200;\n+var entryMap = 103000800;\n+var exitMap = 103000890;\n+var recruitMap = 103000000;\n+var clearMap = 103000805;\n+\n+function init() {\n+        em.setProperty(\"state\", \"0\");\n+\tem.setProperty(\"leader\", \"true\");\n }\n \n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n \n+        evLevel = 1;    //Rewards at clear PQ\n+        itemSet = [2040505, 2040514, 2040502, 2040002, 2040602, 2040402, 2040802, 1032009, 1032004, 1032005, 1032006, 1032007, 1032010, 1032002, 1002026, 1002089, 1002090, 2000003, 2000001, 2000002, 2000006, 2022003, 2022000, 2000004, 4003000, 4010000, 4010001, 4010002, 4010003, 4010004, 4010005, 4010006, 4010007, 4020000, 4020001, 4020002, 4020003, 4020004, 4020005, 4020006, 4020007, 4020008];\n+        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 80, 80, 80, 50, 5, 15, 15, 30, 15, 15, 15, 15, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [100, 200, 400, 800, 1500];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n \n-function monsterValue(eim, mobId) { // Killed monster.\n-    return 1; // returns an amount to add onto kill count.\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+            var partyList = party.toArray();\n+            \n+            for(var i = 0; i < party.size(); i++) {\n+                var ch = partyList[i];\n+            \n+                if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                        if(ch.isLeader()) hasLeader = true;\n+                        eligible.push(ch);\n+                }\n+            }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n }\n \n-function setup() { // Invoked from \"EventManager.startInstance()\"\n-    var eim = em.newInstance(\"KerningPQ\"); // adds a new instance and returns EventInstanceManager.\n-    var eventTime = 30 * (1000 * 60); // 30 mins.\n-    var firstPortal = eim.getMapInstance(103000800).getPortal(\"next00\");\n-\trespawn(eim);\n-    firstPortal.setScriptName(\"kpq0\");\n-    em.schedule(\"timeOut\", eim, eventTime); // invokes \"timeOut\" in how ever many seconds.\n-    eim.startEventTimer(eventTime); // Sends a clock packet and tags a timer to the players.\n-    return eim; // returns the new instance.\n+function setup(level, leaderid) {\n+        em.setProperty(\"state\", \"1\");\n+\tem.setProperty(\"leader\", \"true\");\n+        \n+        var eim = em.newInstance(\"Kerning\" + leaderid);\n+        eim.setProperty(\"level\", level);\n+        \n+        respawnStg1(eim);\n+        eim.startEventTimer(30 * 60000); //30 mins\n+        setEventRewards(eim);\n+        return eim;\n }\n \n-function playerEntry(eim, player) { // this gets looped for every player in the party.\n-    var map = eim.getMapInstance(103000800);\n-    player.changeMap(map, map.getPortal(0)); // We're now in KPQ :D\n+function respawnStg1(eim) {    \n+        eim.getMapInstance(103000800).instanceMapRespawn();\n+        eim.schedule(\"respawnStg1\", 10 * 1000);\n }\n \n-function playerDead(eim, player) {\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n }\n \n-function playerRevive(eim, player) { // player presses ok on the death pop up.\n-    if (eim.isLeader(player) || party.size() <= minPlayers) { // Check for party leader\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+function scheduledTimeout(eim) {\n+        end(eim);\n }\n \n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n \n-function respawn(eim) {\t\n-\tvar map = eim.getMapInstance(103000800);\n-\tvar map2 = eim.getMapInstance(103000805);\n-\tif (map.getSummonState()) {\t//Map spawns are set to true by default\n-\t\tmap.instanceMapRespawn();\n-\t}\n-\tif(map2.getSummonState()) {\n-\t\tmap2.instanceMapRespawn();\n-\t}\n-\teim.schedule(\"respawn\", 10000);\n+function changedMap(eim, player, mapid) {\n+        if (mapid < 103000800 || mapid > 103000805) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n }\n \n+function playerDead(eim, player) {}\n \n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n \n function playerDisconnected(eim, player) {\n-    var party = eim.getPlayers();\n-    if (eim.isLeader(player) || party.size() < minPlayers) {\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            if (party.get(i).equals(player))\n-                removePlayer(eim, player);\n-            else\n-                playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        removePlayer(eim, player);\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n function leftParty(eim, player) {\n-    var party = eim.getPlayers();\n-    if (party.size() < minPlayers) {\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim,party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n function disbandParty(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n+        end(eim);\n }\n \n-function playerExit(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, exitMap.getPortal(0));\n+function monsterValue(eim, mobId) {\n+        return 1;\n }\n \n-function removePlayer(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.getMap().removePlayer(player);\n-    player.setMap(exitMap);\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n }\n \n function clearPQ(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++)\n-        playerExit(eim, party.get(i));\n-    eim.dispose();\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n+}\n+\n+function reopenEvent() {\n+        em.setProperty(\"state\", \"0\");\n+        em.setProperty(\"leader\", \"true\");\n }\n \n function monsterKilled(mob, eim) {}\n@@ -143,22 +156,4 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n-function dispose(eim) {\n-\tem.cancelSchedule();\n-    em.schedule(\"OpenKPQ\", 10000); // 10 seconds ?\n-}\n-\n-function OpenKPQ() {\n-    em.setProperty(\"KPQOpen\", \"true\");\n-}\n-\n-function timeOut(eim) {\n-    if (eim != null) {\n-        if (eim.getPlayerCount() > 0) {\n-            var pIter = eim.getPlayers().iterator();\n-            while (pIter.hasNext())\n-                playerExit(eim, pIter.next());\n-        }\n-        eim.dispose();\n-    }\n-}\n\\ No newline at end of file\n+function dispose(eim) {}"}, {"sha": "ed6ea913500bfef13eb15a83417ea28bc081077a", "filename": "scripts/event/PiratePQ.js", "status": "modified", "additions": 58, "deletions": 85, "changes": 143, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/PiratePQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/event/PiratePQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PiratePQ.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,6 +1,6 @@\n var isPq = true;\n-var minPlayers = 3, maxPlayers = 6;\n-var minLevel = 55, maxLevel = 100;\n+var minPlayers = 1, maxPlayers = 6;\n+var minLevel = 1, maxLevel = 200;\n var entryMap = 925100000;\n var exitMap = 925100700;\n var recruitMap = 251010404;\n@@ -35,15 +35,18 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n function setup(level, leaderid) {\n         em.setProperty(\"state\", \"1\");\n \tem.setProperty(\"leader\", \"true\");\n+        \n         var eim = em.newInstance(\"Pirate\" + leaderid);\n+        eim.setProperty(\"level\", level);\n+        \n \tem.setProperty(\"stage2\", \"0\");\n         em.setProperty(\"stage2a\", \"0\");\n \tem.setProperty(\"stage3a\", \"0\");\n         em.setProperty(\"stage2b\", \"0\");\n \tem.setProperty(\"stage3b\", \"0\");\n \tem.setProperty(\"stage4\", \"0\");\n \tem.setProperty(\"stage5\", \"0\");\n-        em.setProperty(\"level\", level);\n+        \n         em.setProperty(\"openedChests\", \"0\");\n         eim.setInstanceMap(925100000).resetPQ(level);\n         eim.setInstanceMap(925100000).shuffleReactors();\n@@ -125,111 +128,91 @@ function setup(level, leaderid) {\n         return eim;\n }\n \n+function respawnStg4(eim) {    \n+        eim.getMapInstance(925100400).instanceMapRespawn();\n+        eim.schedule(\"respawnStg4\", 10 * 1000);\n+}\n+\n function playerEntry(eim, player) {\n-    var map = eim.getMapInstance(entryMap);\n-    player.changeMap(map, map.getPortal(0));\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n }\n \n function scheduledTimeout(eim) {\n-    end(eim);\n+        end(eim);\n }\n \n-function removePlayer(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, 0);\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n }\n \n function changedMap(eim, player, mapid) {\n-    if (mapid < 925100000 || mapid > 925100500) {\n-\teim.unregisterPlayer(player);\n-\n-\tif (eim.disposeIfPlayerBelow(minPlayers, exitMap)) {\n-\t\tem.setProperty(\"state\", \"0\");\n-\t\tem.setProperty(\"leader\", \"true\");\n-\t}\n-    }\n+        if (mapid < 925100000 || mapid > 925100500) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n }\n \n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n-    var party = eim.getPlayers();\n-    if (eim.isLeader(player) || party.size() <= minPlayers) { // Check for party leader\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n \n function playerDisconnected(eim, player) {\n-    var party = eim.getPlayers();\n-    if (eim.isLeader(player) || party.size() < minPlayers) {\n-        var party = eim.getPlayers();\n-        for (var i = 0; i < party.size(); i++)\n-            if (party.get(i).equals(player))\n-                removePlayer(eim, player);\n-            else\n-                playerExit(eim, party.get(i));\n-        eim.dispose();\n-    } else\n-        removePlayer(eim, player);\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player))\n+                end(eim);\n+        else\n+                playerExit(eim, player);\n }\n \n function leftParty(eim, player) {\n-    var party = eim.getPlayers();\n-    if (party.size() < minPlayers) {\n-        for (var i = 0; i < party.size(); i++)\n-            playerExit(eim,party.get(i));\n-        eim.dispose();\n-    } else\n-        playerExit(eim, player);\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n+                end(eim);\n+        else\n+                playerExit(eim, player);\n }\n \n function disbandParty(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n-}\n-\n-function playerExit(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, 0);\n+        end(eim);\n }\n \n function monsterValue(eim, mobId) {\n-    return 1;\n+        return 1;\n }\n \n function end(eim) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerExit(eim, party.get(i));\n-    }\n-    eim.dispose();\n-}\n-\n-function playerClear(eim, player, toMap) {\n-    eim.unregisterPlayer(player);\n-    \n-    if(toMap != null) player.changeMap(toMap);\n-    else player.changeMap(clearMap, 0);\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function complete(eim, toMap) {\n-    var party = eim.getPlayers();\n-    for (var i = 0; i < party.size(); i++) {\n-        playerClear(eim, party.get(i), toMap);\n-    }\n-    eim.dispose();\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+        eim.warpEventTeam(toMap);\n+        \n+        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n-function clearPQ(eim, toMap) {\n-    complete(eim, toMap);\n+function reopenEvent() {\n+        em.setProperty(\"state\", \"0\");\n+        em.setProperty(\"leader\", \"true\");\n }\n \n function monsterKilled(mob, eim) {}\n@@ -238,14 +221,4 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n-function respawnStg4(eim) {    \n-    eim.getMapInstance(925100400).instanceMapRespawn();\n-    em.schedule(\"respawnStg4\", eim, 10 * 1000);\n-}\n-\n-function dispose(eim) {\n-    em.cancelSchedule();\n-    \n-    em.setProperty(\"state\", \"0\");\n-    em.setProperty(\"leader\", \"true\");\n-}\n+function dispose(eim) {}"}, {"sha": "688791cd55b346189eb0dad09af81b5a374587b3", "filename": "scripts/npc/world0/1012112.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1012112.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1012112.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/1012112.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -94,7 +94,11 @@ function action(mode, type, selection) {\n                     if (prop == null || prop.equals(\"0\")) { //Start the PQ\n \t\t\t\t\t    cm.removeHPQItems();\n                         em.setProperty(\"latestLeader\", cm.getPlayer().getName());\n-                        em.startInstance(cm.getParty(), cm.getPlayer().getMap());\n+                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap())) {\n+                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                            cm.dispose();\n+                            return;\n+                        }\n                     } else {\n                         cm.sendOk(\"Someone is already attempting the PQ. Please wait for them to finish, or find another channel.\");\n                         cm.dispose();"}, {"sha": "8122e857375b8fb83e9d4e4adf8d703032e4f09b", "filename": "scripts/npc/world0/1012114.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1012114.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1012114.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/1012114.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -37,7 +37,7 @@ function action(mode, type, selection) {\n             status++;\n \t\tif (status == 51) {\n \t\t    var eim = cm.getEventManager(\"HenesysPQ\").getInstance(\"HenesysPQ_\" + cm.getParty().getLeader().getName());\n-\t\t\teim.finishPQ();\n+\t\t\teim.clearPQ();\n             cm.dispose();\n \t\t\treturn;\n \t\t}\n@@ -89,7 +89,7 @@ function action(mode, type, selection) {\n                 cm.sendNextPrev(\"When the flowers of primrose blooms, the full moon will rise, and that's when the Moon Bunnies will appear and start pounding the mill. Your task is to fight off the monsters to make sure that Moon Bunny can concentrate on making the best rice cake possible.\");\n             } else if (chosen == 1) {\n \t\t\t\tvar eim = cm.getEventManager(\"HenesysPQ\").getInstance(\"HenesysPQ_\" + cm.getParty().getLeader().getName());\n-\t\t\t\teim.finishPQ();\n+\t\t\t\teim.clearPQ();\n                 cm.dispose();\n             }\n         } else if (status == 4) {"}, {"sha": "85749950f061e86373565cb21a3219b00c02c819", "filename": "scripts/npc/world0/1061012.js", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1061012.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/1061012.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/1061012.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -22,7 +22,9 @@ function start() {\n \t    } else if (em.getProperty(\"started\").equals(\"true\")) {\n \t\tcm.sendOk(\"Someone else is already attempting to defeat the Jr.Balrog in another world.\" );\n \t    } else {\n-\t\tem.startInstance(cm.getParty(), cm.getMap());\n+\t\tif(!em.startInstance(cm.getParty(), cm.getMap())) {\n+                    cm.sendOk(\"A party in your name is already registered in this event.\");\n+                }\n \t    }\n \t}\n     }"}, {"sha": "2386140397226bafe1fa2424cf8fadd51b91617a", "filename": "scripts/npc/world0/2013002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2013002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2013002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2013002.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -44,7 +44,7 @@ function action(mode, type, selection) {\n                 cm.sendNext(\"Thank you for not only restoring the statue, but rescuing me, Minerva, from the entrapment. May the blessing of the goddess be with you till the end...\");\n             else if (status == 1) {\n                 var eim = cm.getPlayer().getEventInstance();\n-                eim.finishPQ();\n+                eim.clearPQ();\n                 cm.dispose();\n             }\n         } else if (cm.getPlayer().getMapId() == 920011300) {"}, {"sha": "f6dc6f670c1f209d77f5eeef129c4c95652f81ce", "filename": "scripts/npc/world0/2030008.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2030008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2030008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2030008.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -117,7 +117,11 @@ function action(mode, type, selection) {\n                         if (em == null) {\n                             cm.sendOk(\"This trial is currently under construction.\");\n                         } else {\n-                            em.startInstance(cm.getParty(), cm.getPlayer().getMap());\n+                            if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap())) {\n+                                cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                cm.dispose();\n+                                return;\n+                            }\n                             party = cm.getPlayer().getEventInstance().getPlayers();\n                             cm.removeFromParty(4001015, party);\n                             cm.removeFromParty(4001018, party);"}, {"sha": "358c846eae5e4c0fe8df4b6aaaab627608926f4f", "filename": "scripts/npc/world0/2030013_old.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2030013_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2030013_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2030013_old.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -79,7 +79,11 @@ function action(mode, type, selection) {\n                         cm.sendOk(\"You may not use that password.\");\n                     else { // start Zakum Battle\n                         var eim = em.newInstance(\"Zakum\" + passwd);\n-                        em.startInstance(eim,cm.getPlayer().getName());\n+                        if(!em.startInstance(eim,cm.getPlayer().getName())) {\n+                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                            cm.dispose();\n+                            return;\n+                        }\n                         eim.registerPlayer(cm.getPlayer());\n                     }\n                 }"}, {"sha": "79e79e605a9b549d799e4711ce4d2b8184a54cc2", "filename": "scripts/npc/world0/2032002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2032002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2032002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2032002.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -82,7 +82,7 @@ function action(mode, type, selection) {\n                     cm.givePartyExp(20000, party);\n                 } else\n                     cm.givePartyExp(12000, party);\n-                eim.finishPQ();\n+                eim.clearPQ();\n                 cm.dispose();\n             }\n             else if (selectedType == 2) {"}, {"sha": "ae76e2fb4f0fe247eded53ab983186ee0d7ec11b", "filename": "scripts/npc/world0/2040034.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2040034.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2040034.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2040034.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -74,7 +74,11 @@ function action(mode, type, selection) {\n \t\t\t\t\t} else {\n \t\t\t\t\t\tvar prop = em.getProperty(\"LPQOpen\");\n \t\t\t\t\t\tif (prop == null || prop.equals(\"true\")) { \n-\t\t\t\t\t\t\tem.startInstance(cm.getParty(), cm.getPlayer().getMap());\n+\t\t\t\t\t\t\tif(!em.startInstance(cm.getParty(), cm.getPlayer().getMap())) {\n+                                                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                                            cm.dispose();\n+                                                            return;\n+                                                        }\n \t\t\t\t\t\t\tcm.removeAll(4001022);\n \t\t\t\t\t\t\tcm.removeAll(4001023);\n \t\t\t\t\t\t\tcm.dispose();"}, {"sha": "0747a6a2af61a9c61434f4f2cebc5195178d95c3", "filename": "scripts/npc/world0/2083000.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2083000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2083000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2083000.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -85,7 +85,11 @@ function action(mode, type, selection) {\n                     }\n                     else {\n                         // Begin the PQ.\n-                        em.startInstance(cm.getParty(),cm.getPlayer().getMap());\n+                        if(!em.startInstance(cm.getParty(),cm.getPlayer().getMap())) {\n+                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                            cm.dispose();\n+                            return;\n+                        }\n                         //force the two scripts on portals in the map\n                         //eim = cm.getPlayer().getEventInstance();\n                         var map = eim.getMapInstance(240050100);"}, {"sha": "ae9f2881daefe7e84f605fbbdb7bd20fcdfe75d5", "filename": "scripts/npc/world0/2094000.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2094000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2094000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2094000.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -50,7 +50,11 @@ function action(mode, type, selection) {\n                                         if(eli.size() > 0) {\n                                                 var prop = em.getProperty(\"state\");\n                                                 if (prop != null && prop.equals(\"0\")) { \n-                                                        em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1);\n+                                                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                                            cm.dispose();\n+                                                            return;\n+                                                        }\n                                                         cm.dispose();\n                                                 } else {\n                                                         cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");"}, {"sha": "093c1cfcba2f7934b8a7306f983fa73f966e2ca1", "filename": "scripts/npc/world0/2094002.js", "status": "modified", "additions": 21, "deletions": 16, "changes": 37, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2094002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2094002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2094002.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -20,36 +20,40 @@ function action(mode, type, selection) {\n \tcm.dispose();\n \treturn;\n     }\n-    var em = cm.getEventManager(\"PiratePQ\");\n-    if (em == null) {\n-\tcm.sendNext(\"The event isn't started...\");\n+    \n+    if (!cm.isLeader()) {\n+\tcm.sendNext(\"I wish for your leader to talk to me.\");\n \tcm.dispose();\n \treturn;\n     }\n     \n-    level = em.getProperty(\"level\");\n-    if (!cm.isLeader()) {\n-\tcm.sendNext(\"I wish for your leader to talk to me.\");\n+    var eim = cm.getEventInstance();\n+    if (eim == null) {\n+        cm.warp(251010404,0);\n+\tcm.sendNext(\"How are you even here without being registered on an event?\");\n \tcm.dispose();\n \treturn;\n     }\n+    \n+    level = eim.getProperty(\"level\");\n+    \n     switch(cm.getPlayer().getMapId()) {\n \tcase 925100000:\n \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must destroy all the monsters guarding it.\");\n \t    cm.dispose();\n \t    break;\n \tcase 925100100:\n-\t    var emp = em.getProperty(\"stage2\");\n+\t    var emp = eim.getProperty(\"stage2\");\n \t    if (emp == null) {\n-\t\tem.setProperty(\"stage2\", \"0\");\n+\t\teim.setProperty(\"stage2\", \"0\");\n \t\temp = \"0\";\n \t    }\n \t    if (emp.equals(\"0\")) {\n \t\tif (cm.haveItem(4001120,20)) {\n \t\t    cm.sendNext(\"Excellent! Now hunt me 20 Rising Medals.\");\n \t\t    cm.gainItem(4001120,-20);\n                     cm.getMap().killAllMonsters();\n-\t\t    em.setProperty(\"stage2\", \"1\");\n+\t\t    eim.setProperty(\"stage2\", \"1\");\n \t\t} else {\n \t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rookie Medals.\");\n                     if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300114, level, true);\n@@ -59,7 +63,7 @@ function action(mode, type, selection) {\n \t\t    cm.sendNext(\"Excellent! Now hunt me 20 Veteran Medals.\");\n \t\t    cm.gainItem(4001121,-20);\n                     cm.getMap().killAllMonsters();\n-\t\t    em.setProperty(\"stage2\", \"2\");\n+\t\t    eim.setProperty(\"stage2\", \"2\");\n \t\t} else {\n \t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rising Medals.\");\n                     if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300115, level, true);\n@@ -69,7 +73,7 @@ function action(mode, type, selection) {\n \t\t    cm.sendNext(\"Excellent! Now let us go.\");\n \t\t    cm.gainItem(4001122,-20);\n                     cm.getMap().killAllMonsters();\n-\t\t    em.setProperty(\"stage2\", \"3\");\n+\t\t    eim.setProperty(\"stage2\", \"3\");\n \t\t} else {\n \t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Veteran Medals.\");\n                     if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300116, level, true);\n@@ -87,9 +91,9 @@ function action(mode, type, selection) {\n \tcase 925100201:\n \t    if (cm.getMap().getMonsters().size() == 0) {\n \t\tcm.sendNext(\"Excellent.\");\n-\t\tif (em.getProperty(\"stage2a\") == \"0\") {\n+\t\tif (eim.getProperty(\"stage2a\") == \"0\") {\n \t\t    cm.getMap().setReactorState();\n-\t\t    em.setProperty(\"stage2a\", \"1\");\n+\t\t    eim.setProperty(\"stage2a\", \"1\");\n \t\t}\n \t    } else {\n \t   \tcm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n@@ -99,9 +103,9 @@ function action(mode, type, selection) {\n \tcase 925100301:\n \t    if (cm.getMap().getMonsters().size() == 0) {\n \t\tcm.sendNext(\"Excellent.\");\n-\t\tif (em.getProperty(\"stage3a\").equals(\"0\")) {\n+\t\tif (eim.getProperty(\"stage3a\").equals(\"0\")) {\n \t\t    cm.getMap().setReactorState();\n-\t\t    em.setProperty(\"stage3a\", \"1\");\n+\t\t    eim.setProperty(\"stage3a\", \"1\");\n \t\t}\n \t    } else {\n \t   \tcm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n@@ -119,7 +123,8 @@ function action(mode, type, selection) {\n \t    break;\n \tcase 925100500:\n \t    if (cm.getMap().getMonsters().size() == 0) {\n-\t\tcm.clearPQ(925100600);\n+\t\tcm.getEventInstance().clearPQ();\n+                cm.getEventInstance().warpEventTeam(925100600);\n \t    } else {\n \t   \tcm.sendNext(\"Defeat all monsters! Even Lord Pirate's minions!\");\n \t    }"}, {"sha": "8d6fb23f768a1e31c9c8b7f66709a2861a5e458f", "filename": "scripts/npc/world0/2133000.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2133000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2133000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2133000.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -50,7 +50,11 @@ function action(mode, type, selection) {\n                                         if(eli.size() > 0) {\n                                                 var prop = em.getProperty(\"state\");\n                                                 if (prop != null && prop.equals(\"0\")) { \n-                                                        em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1);\n+                                                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                            cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                                            cm.dispose();\n+                                                            return;\n+                                                        }\n                                                         cm.dispose();\n                                                 } else {\n                                                         cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");"}, {"sha": "d752de99f829df21ce7ac71d20bccfae3e9551ba", "filename": "scripts/npc/world0/2141001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2141001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/2141001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2141001.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -189,7 +189,7 @@ function action(mode, type, selection) {\n \t\t\tcm.sendOk(\"Due to an unknown error, the request for squad has been denied.\");\n \t\t\tcm.dispose();\n \t\t    }\n-\t\t} else if (selection == 3) { // get insode\n+\t\t} else if (selection == 3) { // get inside\n \t\t    if (cm.getSquad(\"PinkBean\") != null) {\n \t\t\tvar dd = cm.getEventManager(\"PinkBeanBattle\");\n \t\t\tdd.startInstance(cm.getSquad(\"PinkBean\"), cm.getMap(), 160104);"}, {"sha": "a135c3b54e5d04e41cbca09774c0d177841ee717", "filename": "scripts/npc/world0/22000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/22000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/22000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/22000.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n     } else if (status == 3) {\n         if (cm.haveItem(4031801))\n             cm.gainItem(4031801, -1);\n-        cm.warp(2010000);\n+        cm.warp(104000000);\n         cm.dispose();\n     }\n }\n\\ No newline at end of file"}, {"sha": "24517e8a35d813016c330831fab93bb2ace4bd04", "filename": "scripts/npc/world0/9000037.js", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9000037.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9000037.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9000037.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -41,18 +41,16 @@ function action(mode, type, selection) {\n \n                 if (status == 0) {\n                         if(state == 3) {\n+                                if(cm.getEventInstance().getProperty(\"clear\") == null) {\n+                                        cm.getEventInstance().clearPQ();\n+                                        cm.getEventInstance().setProperty(\"clear\", \"true\");\n+                                }\n+                            \n                                 if(cm.isLeader()) {\n-                                        if(cm.getPlayer().getEventInstance().getPlayerCount() > 1) {\n-                                                cm.sendOk(\"Now, tell your party I will be warping everyone out and rewarding them as they talk to me. The leader goes last.\");\n-                                                cm.dispose();\n-                                                return;\n-                                        }\n-                                        else {\n-                                                cm.sendOk(\"Your party completed such an astounding feat coming this far, #byou have defeated all the bosses#k, congratulations! Now I will be handing your reward as you are being transported out...\");\n-                                        }\n-                                }                                \n+                                        cm.sendOk(\"Your party completed such an astounding feat coming this far, #byou have defeated all the bosses#k, congratulations! Now I will be handing your reward as you are being transported out...\");\n+                                }\n                                 else {\n-                                        cm.sendOk(\"For #bdefeating all bosses#k in this event, congratulations! Now you will receive a prize that matches your performance here as I warp you out.\");\n+                                        cm.sendOk(\"For #bdefeating all bosses#k in this event, congratulations! You will now receive a prize that matches your performance here as I warp you out.\");\n                                 }\n                         }\n                         else if(state == 2) {\n@@ -114,7 +112,11 @@ function action(mode, type, selection) {\n                                                 if(eli.size() > 0) {\n                                                         var prop = em.getProperty(\"state\");\n                                                         if (prop != null && prop.equals(\"0\")) { \n-                                                                em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1);\n+                                                                if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                                    cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                                                    cm.dispose();\n+                                                                    return;\n+                                                                }\n                                                                 cm.dispose();\n                                                         } else {\n                                                                 cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");"}, {"sha": "b4c517463d7081674abe93d0bd5ee1706ba7ecf3", "filename": "scripts/npc/world0/9020000.js", "status": "modified", "additions": 80, "deletions": 78, "changes": 158, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9020000.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,89 +1,91 @@\n-/*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc> \n-                       Matthias Butz <matze@odinms.de>\n-                       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License version 3\n-    as published by the Free Software Foundation. You may not use, modify\n-    or distribute this program under any other version of the\n-    GNU Affero General Public License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-\n /**\n--- Odin JavaScript --------------------------------------------------------------------------------\n-\tLakelis - Victoria Road: Kerning City (103000000)\n--- By ---------------------------------------------------------------------------------------------\n-\tStereo\n--- Version Info -----------------------------------------------------------------------------------\n-\t1.0 - First Version by Stereo\n----------------------------------------------------------------------------------------------------\n-**/\n+ * @author: Ronan\n+ * @npc: Lakelis\n+ * @map: 103000000 - Kerning City\n+ * @func: Kerning PQ\n+*/\n \n-var status;\n-var minLevel = 21;\n-var maxLevel = 255;\n-var minPlayers = 1;\n-var maxPlayers = 6;\n+var status = 0;\n+var minLevel = 1;\n+var maxLevel = 200;\n+var minPartySize = 1;\n+var maxPartySize = 6;\n+var state;\n \n function start() {\n-    status = -1;\n-    action(1, 0, 0);\n+\tstatus = -1;\n+        state = (cm.getMapId() >= 103000800 && cm.getMapId() <= 103000805) ? 1 : 0;\n+\taction(1, 0, 0);\n }\n \n function action(mode, type, selection) {\n-    if (mode == 1)\n-        status++;\n-    else {\n-        cm.dispose();\n-        return;\n-    }\n-    if (status == 0) {\n-        if (cm.getParty() == null) { // No Party\n-            cm.sendOk(\"How about you and your party members collectively beating a quest? Here you'll find obstacles and problems where you won't be able to beat it without great teamwork.  If you want to try it, please tell the #bleader of your party#k to talk to me.\");\n-            cm.dispose();\n-        } else if (!cm.isLeader()) { // Not Party Leader\n-            cm.sendOk(\"If you want to try the quest, please tell the #bleader of your party#k to talk to me.\");\n-            cm.dispose();\n-        } else {\n-            var party = cm.getParty().getMembers();\n-            var inMap = cm.partyMembersInMap();\n-            var levelValid = 0;\n-            for (var i = 0; i < party.size(); i++) {\n-                if (party.get(i).getLevel() >= minLevel && party.get(i).getLevel() <= maxLevel)\n-                    levelValid++;\n-            }\n-            if (inMap < minPlayers || inMap > maxPlayers) {\n-                cm.sendOk(\"Your party is not a party of \"+minPlayers+\". Please make sure all your members are present and qualified to participate in this quest.\");\n+        if (mode == -1) {\n                 cm.dispose();\n-            } else if (levelValid != inMap) {\n-                cm.sendOk(\"Please make sure all your members are present and qualified to participate in this quest. This PQ requires players ranging from level \"+minLevel+\" to level \"+maxLevel+\". I see #b\" + levelValid + \"#k members are in the right level range. If this seems wrong, #blog out and log back in,#k or reform the party.\");\n-                cm.dispose();\n-            } else {\n-                var em = cm.getEventManager(\"KerningPQ\");\n-                if (em == null) {\n-                    cm.sendOk(\"This PQ is currently unavailable.\");\n-                } else if (em.getProperty(\"KPQOpen\").equals(\"true\")) {\n-                    // Begin the PQ.\n-                    em.startInstance(cm.getParty(), cm.getPlayer().getMap());\n-                    party = cm.getParty();\n-                    cm.removePartyItems(4001008);\n-                    cm.removePartyItems(4001007);\n-                    em.setProperty(\"KPQOpen\" , \"false\");\n-                } else {\n-                    cm.sendNext(\"There is already another party inside. Please wait !\");\n+        } else {\n+                if (mode == 0 && status == 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+\n+                if (status == 0) {\n+                        if(state == 1) {\n+                                cm.sendYesNo(\"Do you wish to abandon this area?\");\n+                        }\n+                        else {\n+                                cm.sendSimple(\"#b<Party Quest: 1st Accompaniment>#k\\r\\n\\r\\nHow about you and your party members collectively beating a quest? Here you'll find obstacles and problems where you won't be able to beat it without great teamwork. If you want to try it, please tell the #bleader of your party#k to talk to me.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+                        }\n+                } else if (status == 1) {\n+                        if(state == 1) {\n+                                cm.warp(103000000);\n+                                cm.dispose();\n+                        }\n+                        else {\n+                                if (selection == 0) {\n+                                        if (cm.getParty() == null) {\n+                                                cm.sendOk(\"You can participate in the party quest only if you are in a party.\");\n+                                                cm.dispose();\n+                                        } else if(!cm.isLeader()) {\n+                                                cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n+                                                cm.dispose();\n+                                        } else {\n+                                                var em = cm.getEventManager(\"KerningPQ\");\n+                                                if(em == null) {\n+                                                        cm.sendOk(\"The Kerning PQ has encountered an error.\");\n+                                                        cm.dispose();\n+                                                }\n+\n+                                                var eli = em.getEligibleParty(cm.getParty());\n+                                                if(eli.size() > 0) {\n+                                                        var prop = em.getProperty(\"state\");\n+                                                        if (prop != null && prop.equals(\"0\")) {\n+                                                                if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                                    cm.sendOk(\"A party in your name is already registered in this event.\");\n+                                                                    cm.dispose();\n+                                                                    return;\n+                                                                }\n+                                                                cm.dispose();\n+                                                        } else {\n+                                                                cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n+                                                                cm.dispose();\n+                                                        }\n+                                                }\n+                                                else {\n+                                                        cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n+                                                        cm.dispose();\n+                                                }\n+                                        }\n+                                } else if (selection == 1) {\n+                                        cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n+                                        cm.dispose();\n+                                } else {\n+                                        cm.sendOk(\"#b<Party Quest: 1st Accompaniment>#k\\r\\nYour party must pass through many obstacles and puzzles while traversing the sub-objectives of this Party Quest. Coordinate with your team in order to further advance and defeat the final boss and collect the dropped item in order to access the rewards and bonus stage.\");\n+                                        cm.dispose();\n+                                }\n+                        }\n                 }\n-                cm.dispose();\n-            }\n         }\n-    }\n }\n\\ No newline at end of file"}, {"sha": "7dc4335f59591c3b198738bb5ece597e6148d840", "filename": "scripts/npc/world0/9020001.js", "status": "modified", "additions": 232, "deletions": 316, "changes": 548, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9020001.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,4 +1,4 @@\n-/*/*\n+/*\n \tThis file is part of the OdinMS Maple Story Server\n     Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n \t\t       Matthias Butz <matze@odinms.de>\n@@ -21,361 +21,277 @@\n */\n \n /**\n--- Odin JavaScript --------------------------------------------------------------------------------\n-\tCloto - Hidden Street : 1st Accompaniment\n--- By ---------------------------------------------------------------------------------------------\n-\tStereo\n--- Version Info -----------------------------------------------------------------------------------\n-        1.1 - Second Version by Moogra\n-\t1.0 - First Version by Stereo\n----------------------------------------------------------------------------------------------------\n-**/\n+ * @author: Stereo, Moogra, Ronan\n+ * @npc: Cloto\n+ * @map: 1st Accompaniment - KPQ\n+ * @func: Kerning PQ\n+*/\n \n importPackage(Packages.tools);\n importPackage(java.awt);\n \n-var status;\n-var curMap;\n-var questions = Array(\"Here's the question. Collect the same number of coupons as the minimum level required to make the first job advancement as warrior.\",\n+var stage1Questions = Array(\n+    \"Here's the question. Collect the same number of coupons as the minimum level required to make the first job advancement as warrior.\",\n     \"Here's the question. Collect the same number of coupons as the minimum amount of STR needed to make the first job advancement as a warrior.\",\n     \"Here's the question. Collect the same number of coupons as the minimum amount of INT needed to make the first job advancement as a magician.\",\n     \"Here's the question. Collect the same number of coupons as the minimum amount of DEX needed to make the first job advancement as a bowman.\",\n     \"Here's the question. Collect the same number of coupons as the minimum amount of DEX needed to make the first job advancement as a thief.\",\n     \"Here's the question. Collect the same number of coupons as the minimum level required to advance to 2nd job.\",\n-\t\"Here's the question. Collect the same number of coupons as the minimum level required to make the first job advancement as a magician.\");\n-var qanswers = Array(10, 35, 20, 25, 25, 30, 8);\n-var party;\n-var preamble; // we dont even need this mother fucker ! --\n+    \"Here's the question. Collect the same number of coupons as the minimum level required to make the first job advancement as a magician.\");\n+var stage1Answers = Array(10, 35, 20, 25, 25, 30, 8);\n+\n var stage2Rects = Array(new Rectangle(-755,-132,4,218),new Rectangle(-721,-340,4,166),new Rectangle(-586,-326,4,150),new Rectangle(-483,-181,4,222));\n var stage3Rects = Array(new Rectangle(608,-180,140,50),new Rectangle(791,-117,140,45),\n     new Rectangle(958,-180,140,50),new Rectangle(876,-238,140,45),\n     new Rectangle(702,-238,140,45));\n var stage4Rects = Array(new Rectangle(910,-236,35,5),new Rectangle(877,-184,35,5),\n     new Rectangle(946,-184,35,5),new Rectangle(845,-132,35,5),\n     new Rectangle(910,-132,35,5),new Rectangle(981,-132,35,5));\n-var stage2combos = Array(Array(0,1,1,1),Array(1,0,1,1),Array(1,1,0,1),Array(1,1,1,0));\n-var stage3combos = Array(Array(0,0,1,1,1),Array(0,1,0,1,1),Array(0,1,1,0,1),\n+    \n+var stage2Combos = Array(Array(0,1,1,1),Array(1,0,1,1),Array(1,1,0,1),Array(1,1,1,0));\n+var stage3Combos = Array(Array(0,0,1,1,1),Array(0,1,0,1,1),Array(0,1,1,0,1),\n     Array(0,1,1,1,0),Array(1,0,0,1,1),Array(1,0,1,0,1),\n     Array(1,0,1,1,0),Array(1,1,0,0,1),Array(1,1,0,1,0),\n     Array(1,1,1,0,0));\n-var stage4combos = Array(Array(0,0,0,1,1,1),Array(0,0,1,0,1,1),Array(0,0,1,1,0,1),\n+var stage4Combos = Array(Array(0,0,0,1,1,1),Array(0,0,1,0,1,1),Array(0,0,1,1,0,1),\n     Array(0,0,1,1,1,0),Array(0,1,0,0,1,1),Array(0,1,0,1,0,1),\n     Array(0,1,0,1,1,0),Array(0,1,1,0,0,1),Array(0,1,1,0,1,0),\n     Array(0,1,1,1,0,0),Array(1,0,0,0,1,1),Array(1,0,0,1,0,1),\n     Array(1,0,0,1,1,0),Array(1,0,1,0,0,1),Array(1,0,1,0,1,0),\n     Array(1,0,1,1,0,0),Array(1,1,0,0,0,1),Array(1,1,0,0,1,0),\n-    Array(1,1,0,1,0,0),Array(1,1,1,0,0,0));\t\n-var eye = 9300002;\n-var necki = 9300000;\n-var slime = 9300003;\n-var monsterIds = Array(eye, eye, eye, necki, necki, necki, necki, necki, necki, slime);\n-var prizeIdScroll = Array(2040502, 2040505,// Overall DEX and DEF\n-    2040802,// Gloves for DEX\n-    2040002, 2040402, 2040602);// Helmet, Topwear and Bottomwear for DEF\n-var prizeIdUse = Array(2000001, 2000002, 2000003, 2000006,// Orange, White and Blue Potions and Mana Elixir\n-    2000004, 2022000, 2022003);// Elixir, Pure Water and Unagi\n-var prizeQtyUse = Array(80, 80, 80, 50, 5, 15, 15);\n-var prizeIdEquip = Array(1032004, 1032005, 1032009,// Level 20-25 Earrings\n-    1032006, 1032007, 1032010,// Level 30 Earrings\n-    1032002,// Level 35 Earring\n-    1002026, 1002089, 1002090);// Bamboo Hats\n-var prizeIdEtc = Array(4010000, 4010001, 4010002, 4010003,// Mineral Ores\n-    4010004, 4010005, 4010006,// Mineral Ores\n-    4020000, 4020001, 4020002, 4020003,// Jewel Ores\n-    4020004, 4020005, 4020006,// Jewel Ores\n-    4020007, 4020008, 4003000);\t// Diamond and Black Crystal Ores and Screws\n-var prizeQtyEtc = Array(15, 15, 15, 15, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 30);\n-//500, 1000, 2000, 4000, 7500 = default\n-function start() {\n-    status = -1;\n-    curMap = cm.getPlayer().getMapId() - 103000799;\n-    action(1, 0, 0);\n+    Array(1,1,0,1,0,0),Array(1,1,1,0,0,0));\n+\n+function clearStage(stage, eim, curMap) {\n+    eim.setProperty(stage + \"stageclear\", \"true\");\n+    eim.showClearEffect(true);\n+    \n+    eim.linkToNextStage(stage, \"kpq\", curMap);  //opens the portal to the next map\n }\n \n-function action(mode, type, selection) {\n-    if (mode == 1) {\n-        status++;\n-    } else if (type == 0 && mode == 0)\n-        status--;\n-    else {\n-        cm.dispose();\n-        return;\n+function rectangleStages(eim, property, areaCombos, areaRects) {\n+    var c = eim.getProperty(property);\n+    if(c == null) {\n+        c = Math.floor(Math.random() * areaCombos.length);\n+        eim.setProperty(property, c.toString());\n     }\n-    if (curMap == 1) { // First Stage.\n-        if (isLeader()) {\n-            var eim = cm.getPlayer().getEventInstance();\n-            party = eim.getPlayers();\n-            preamble = eim.getProperty(\"leader1stpreamble\");\n-            if (preamble == null) {\n-\t\t\t\tcm.sendNext(\"Hello. Welcome to the first stage. Look around and you'll see Ligators wandering around. When you defeat them, they will cough up a #bcoupon#k. Every member of the party other than the leader should talk to me, geta  question, and gather up the same number of #bcoupons#k as the answer to the question I'll give to them.\\r\\nIf you gather up the right amount of #bcoupons#k, I'll give the #bpass#k to that player. Once all the party members other than the leader gather up the #bpasses#k and give them to the leader, the leader will hand over the #bpasses#k to me, clearing the stage in the process. The faster you take care of the stages, the more stages you'll be able to challenge. So I suggest you take care of things quickly and swiftly. Well then, best of luck to you.\");\n-                eim.setProperty(\"leader1stpreamble\",\"done\");\n-\t\t\t\tcm.dispose();\n-            } else {\n-                var complete = eim.getProperty(curMap + \"stageclear\");\n-                if (complete != null) {\n-                    cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n-                    cm.dispose();\n-                } else {\n-                    var numpasses = party.size() - 1; // All the players in the party need to get a pass besides the leader.\n-                    var strpasses = \"#b\" + numpasses + \" passes#k\";\n-                    if (!cm.haveItem(4001008, numpasses)) {\n-                        cm.sendNext(\"I'm sorry, but you are short on the number of passes. You need to give me the right number of passes; it should be the number of members of your party minus the leader, \" + strpasses + \" to clear the stage. Tell your party members to solve the questions, gather up the passes, and give them to you.\");\n-                        cm.dispose();\n-                    } else {\n-                        cm.sendNext(\"You gathered up \" + strpasses + \"! Congratulations on clearing the stage! I'll make the portal that sends you to the next stage. There's a time limit on getting there, so please hurry. Best of luck to you all!\");\n-                        clear(1, eim, cm);\n-\t\t\t\t\t\tcm.givePartyExp(\"KerningPQ1st\");\n-                        cm.gainItem(4001008, -numpasses);\n-                        cm.dispose();\n-                    // TODO: Make the shiny thing flash\n-                    }\n-                }\n-            }\n-        } else { // Not leader\n-            var eim = cm.getPlayer().getEventInstance();\n-            pstring = \"member1stpreamble\" + cm.getPlayer().getId();\n-            preamble = eim.getProperty(pstring);\n-            if (status == 0) {\n-                if (preamble == null) {\n-                    var qstring = \"member1st\" + cm.getPlayer().getId();\n-                    var question = eim.getProperty(qstring);\n-                    if (question == null) {\n-                        // Select a random question to ask the player.\n-                        var questionNum = Math.floor(Math.random() * questions.length);\n-                        eim.setProperty(qstring, questionNum);\n-                    }\n-                    cm.sendNext(\"Here, you need to collect #bcoupons#k by defeating the same number of Ligators as the answer to the questions asked individually.\");\n-                } else { // Otherwise, check for stage completed\n-                    var complete = eim.getProperty(curMap + \"stageclear\");\n-                    if (complete != null) { // Strage completed\n-                        cm.sendNext(\"Please hurry on to the next stage, the portal is open!\");\n-                        cm.dispose();\n-                    } else {\n-                        // Reply to player correct/incorrect response to the question they have been asked\n-                        var qstring = \"member1st\" + cm.getPlayer().getId();\n-\t\t\t\t\t\tvar qcompletestr = \"member1stcom\" + cm.getPlayer().getId();\n-                        var numcoupons = qanswers[parseInt(eim.getProperty(qstring))];\n-                        var qcorr = cm.itemQuantity(4001007);\n-\t\t\t\t\t\tif(eim.getProperty(qcompletestr) != null) {\n-\t\t\t\t\t\t\tcm.sendNext(\"Thanks for bringing me the coupons. Please hand the pass to your party leader to continue.\");\n-\t\t\t\t\t\t\tcm.dispose();\n-\t\t\t\t\t\t} else if (numcoupons == qcorr) {\n-                            cm.sendNext(\"That's the right answer! For that you have just received a #bpass#k. Please hand it to the leader of the party.\");\n-                            cm.gainItem(4001007, -numcoupons);\n-                            cm.gainItem(4001008, 1);\n-\t\t\t\t\t\t\teim.setProperty(qcompletestr, \"done\");\n-\t\t\t\t\t\t\tcm.dispose();\n-                        } else\n-                            cm.sendNext(\"I'm sorry, but that is not the right answer! Please have the correct number of coupons in your inventory.\");\n-                    }\n-                }\n-            } else if (status == 1) {\n-                if (preamble == null) {\n-                    var qstring = \"member1st\" + cm.getPlayer().getId();\n-                    var question = parseInt(eim.getProperty(qstring));\n-                    cm.sendNextPrev(questions[question]);\n-                } else {\n-\t\t\t\t\tvar qstring = \"member1st\" + cm.getPlayer().getId();\n-                    var question = parseInt(eim.getProperty(qstring));\n-                    cm.sendNextPrev(questions[question]);\n-                    cm.dispose();\n-                }\n-            } else if (status == 2) { // Preamble completed\n-                eim.setProperty(pstring,\"done\");\n-                cm.dispose();\n-            }\n-        } // End first map scripts\n-    }else if (2 <= curMap && 4 >= curMap) {\n-        new Rectanglestages(cm);\n-    }else if (curMap == 5) { // Final stage\n-        var eim = cm.getPlayer().getEventInstance();\n-        if (eim.getProperty(\"5stageclear\") == null) { //If no\n-            if (isLeader()) { // Leader\n-                if (cm.haveItem(4001008, 10)) {\n-                    // Clear stage\n-                    cm.sendNext(\"Here's the portal that leads you to the last, bonus stage. It's a stage that allows you to defeat regular monsters a little easier. You'll be given a set amount of time to hunt as much as possible, but you can always leave the stage in the middle of it through the NPC. Again, congratulations on clearing all the stages. Take care...\");\n-                    party = eim.getPlayers();\n-                    cm.gainItem(4001008, -10);\n-                    clear(5, eim, cm);\n-\t\t\t\t\tcm.givePartyExp(\"KerningPQFinal\");\n-                    cm.dispose();\n-                } else { // Not done yet\n-                    cm.sendNext(\"Hello. Welcome to the 5th and final stage. Walk around the map and you'll be able to find some Boss monsters. Defeat all of them, gather up #bthe passes#k, and please get them to me. Once you earn your pass, the leader of your party will collect them, and then get them to me once the #bpasses#k are gathered up. The monsters may be familiar to you, but they may be much stronger than you think, so please be careful. Good luck!\\r\\nAs a result of complaints, it is now mandatory to kill all the Slimes! Do it!\");\n-                }\n-                cm.dispose();\n-            } else { // Members\n-                cm.sendNext(\"Welcome to the 5th and final stage.  Walk around the map and you will be able to find some Boss monsters.  Defeat them all, gather up the #bpasses#k, and give them to your leader.  Once you are done, return to me to collect your reward.\");\n-                cm.dispose();\n-            }\n-        } else { // Give rewards and warp to bonus\n-            if (status == 0) {\n-                cm.sendNext(\"Incredible! You cleared all the stages to get to this point. Here's a small prize for your job well done. Before you accept it, however, please make sure your use and etc. inventories have empty slots available.\\r\\n#bYou will not receive a prize if you have no free slots!#k\");\n-            } else if (status == 1) {\n-                getPrize(eim,cm);\n-                cm.dispose();\n+    else c = parseInt(c);\n+    \n+    // get player placement\n+    var players = eim.getPlayers();\n+    var playerPlacement = new Array(0, 0, 0, 0, 0, 0);\n+\n+    for(var i = 0; i < eim.getPlayerCount(); i++) {\n+        for(var j = 0; j < areaRects.length; j++) {\n+            if(areaRects[j].contains(players.get(i).getPosition())) {\n+                playerPlacement[j] += 1;\n+                break;\n             }\n         }\n-    } else { // No map found\n-        cm.sendNext(\"Invalid map, this means the stage is incomplete.\");\n-        cm.dispose();\n     }\n-}\n \n-function clear(stage, eim, cm) {\n-    eim.setProperty(stage + \"stageclear\", \"true\");\n-    var map = eim.getMapInstance(cm.getPlayer().getMapId());\n-    map.broadcastMessage(MaplePacketCreator.showEffect(\"quest/party/clear\"));\n-    map.broadcastMessage(MaplePacketCreator.playSound(\"Party1/Clear\"));\n-    map.broadcastMessage(MaplePacketCreator.environmentChange(\"gate\", 2));\n-    var mf = eim.getMapFactory();\n-    map = mf.getMap(103000800 + stage);\n-    var nextStage = eim.getMapInstance(103000800 + stage);\n-    var portal = nextStage.getPortal(\"next00\");\n-    if (portal != null) {\n-        portal.setScriptName(\"kpq\" + stage);\n+    var curCombo = areaCombos[c];\n+    var accept = true;\n+    for(var j = 0; j < curCombo.length; j++) {\n+        if(curCombo[j] != playerPlacement[j]) {\n+            accept = false;\n+            break;\n+        }\n     }\n+    \n+    return accept;\n }\n \n-function failstage(eim, cm) {\n-    var map = eim.getMapInstance(cm.getPlayer().getMapId());\n-    map.broadcastMessage(MaplePacketCreator.playSound(\"Party1/Failed\"));\n-    map.broadcastMessage(MaplePacketCreator.showEffect(\"quest/party/wrong_kor\"));\n+var status = -1;\n+var eim;\n+\n+function start() {\n+\taction(1, 0, 0);\n }\n \n-function Rectanglestages (cm) {\n-    var eim = cm.getPlayer().getEventInstance();\n-    var nthtext;\n-    var nthobj;\n-    var nthverb;\n-    var nthpos;\n-    var curArray;\n-    var curCombo;\n-    var objset;\n-    if (curMap == 2) {\n-        nthtext = \"2nd\";\n-        nthobj = \"ropes\";\n-        nthverb = \"hang\";\n-        nthpos = \"hang on the ropes too low\";\n-        curArray = stage2Rects;\n-        curCombo = stage2combos;\n-        objset = [0,0,0,0];\n-    } else if (curMap == 3) {\n-        nthtext = \"3rd\";\n-        nthobj = \"platforms\";\n-        nthverb = \"stand\";\n-        nthpos = \"stand too close to the edges\";\n-        curArray = stage3Rects;\n-        curCombo = stage3combos;\n-        objset = [0,0,0,0,0];\n-    } else if (curMap == 4) {\n-        nthtext = \"4th\";\n-        nthobj = \"barrels\";\n-        nthverb = \"stand\";\n-        nthpos = \"stand too close to the edges\";\n-        curArray = stage4Rects;\n-        curCombo = stage4combos;\n-        objset = [0,0,0,0,0,0];\n-    }\n-    if (isLeader()) { // Check if player is leader\n-        if (status == 0) {\n-            party = eim.getPlayers();\n-            preamble = eim.getProperty(\"leader\" + nthtext + \"preamble\");\n-            if (preamble == null) { // first time talking.\n-                cm.sendNext(\"Hi. Welcome to the \" + nthtext + \" stage. Next to me, you'll see a number of \" + nthobj + \". Out of these \" + nthobj + \", #b3 are connected to the portal that sends you to the next stage#k. All you need to do is have #b3 party members find the correct \" + nthobj + \" and \" + nthverb + \" on them.#k\\r\\nBUT, it doesn't count as an answer if you \" + nthpos + \"; please be near the middle of the \" + nthobj + \" to be counted as a correct answer. Also, only 3 members of your party are allowed on the \" + nthobj + \". Once they are \" + nthverb + \"ing on them, the leader of the party must #bdouble-click me to check and see if the answer's correct or not#k. Now, find the right \" + nthobj + \" to \" + nthverb + \" on!\");\n-                eim.setProperty(\"leader\" + nthtext + \"preamble\",\"done\");\n-                var sequenceNum = Math.floor(Math.random() * curCombo.length);\n-                eim.setProperty(\"stage\" + nthtext + \"combo\", sequenceNum.toString());\n+function action(mode, type, selection) {\n+        eim = cm.getEventInstance();\n+    \n+        if (mode == -1) {\n                 cm.dispose();\n-            } else {\n-\t\t\t\tif(cm.getPlayer().getMap().getCharacters().size() != eim.getPlayerCount()) {\n-\t\t\t\t\tcm.sendOk(\"Please make sure all of your party members are here before you continue.\");\n-\t\t\t\t\tcm.dispose();\n-\t\t\t\t\treturn;\n-\t\t\t\t}\n-                var complete = eim.getProperty(curMap + \"stageclear\");\n-                if (complete != null) {\n-                    cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n-                    cm.dispose();\n-                } else { // Check for people on ropes and their positions\n-                    var playersOnCombo = 0;\n-                    for (var i = 0; i < party.size(); i++) {\n-                        for (var y = 0; y < curArray.length; y++) {\n-                            if (curArray[y].contains(party.get(i).getPosition())) {\n-                                playersOnCombo++;\n-                                objset[y] = 1;\n-                                break;\n-                            }\n+        } else {\n+                if (mode == 0 && status == 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+                    \n+                if(status == 0) {\n+                        var curMap = cm.getMapId();\n+                        var stage = curMap - 103000800 + 1;\n+                        if(eim.getProperty(stage.toString() + \"stageclear\") != null) {\n+                                if(stage < 5) {\n+                                        cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n+                                        cm.dispose();\n+                                }\n+                                else {\n+                                        cm.sendNext(\"Incredible! You cleared all the stages to get to this point. Here's a small prize for your job well done. Before you accept it, however, please make sure your use and etc. inventories have empty slots available.\");\n+                                }\n                         }\n-                    }\n-                    if (playersOnCombo == 3) {\n-                        var combo = curCombo[parseInt(eim.getProperty(\"stage\" + nthtext + \"combo\"))];\n-                        var correctCombo = true;\n-                        for (i = 0; i < objset.length && correctCombo; i++)\n-                            if (combo[i] != objset[i])\n-                                correctCombo = false;\n-                        if (correctCombo) {\n-                            clear(curMap, eim, cm);\n-\t\t\t\t\t\t\tcm.givePartyExp(\"KerningPQ\" + nthtext);\n-                            cm.dispose();\n-                        } else { // Wrong\n-                            failstage(eim, cm);\n-                            cm.dispose();\n+                        else if(curMap == 103000800) {   // stage 1\n+                                if(cm.isLeader()) {\n+                                        var numpasses = eim.getPlayerCount() - 1;     // minus leader\n+\n+                                        if(cm.hasItem(4001008, numpasses)) {\n+                                                cm.sendNext(\"You gathered up \" + numpasses + \" passes! Congratulations on clearing the stage! I'll make the portal that sends you to the next stage. There's a time limit on getting there, so please hurry. Best of luck to you all!\");\n+                                                clearStage(stage, eim, curMap);\n+                                                eim.gridClear();\n+                                                cm.gainItem(4001008, -numpasses);\n+                                        }\n+                                        else {\n+                                                cm.sendNext(\"I'm sorry, but you are short on the number of passes. You need to give me the right number of passes; it should be the number of members of your party minus the leader, in this case the total of \" + numpasses + \" to clear the stage. Tell your party members to solve the questions, gather up the passes, and give them to you.\");\n+                                        }\n+                                }\n+                                else {\n+                                        var data = eim.gridCheck(cm.getPlayer());\n+\n+                                        if(data == 0) {\n+                                                cm.sendNext(\"Thanks for bringing me the coupons. Please hand the pass to your party leader to continue.\");\n+                                        } else if(data == -1) {\n+                                                data = Math.floor(Math.random() * stage1Questions.length) + 1;   //data will be counted from 1\n+                                                eim.gridInsert(cm.getPlayer(), data);\n+\n+                                                var question = stage1Questions[data - 1];\n+                                                cm.sendNext(question);\n+                                        } else {\n+                                                var answer = stage1Answers[data - 1];\n+\n+                                                if(cm.itemQuantity(4001007) == answer) {\n+                                                        cm.sendNext(\"That's the right answer! For that you have just received a #bpass#k. Please hand it to the leader of the party.\");\n+                                                        cm.gainItem(4001007, -answer);\n+                                                        cm.gainItem(4001008, 1);\n+                                                        eim.gridInsert(cm.getPlayer(), 0);\n+                                                }\n+                                                else {\n+                                                        cm.sendNext(\"I'm sorry, but that is not the right answer! Please have the correct number of coupons in your inventory.\");\n+                                                }\n+                                        }\n+                                }\n+                                \n+                                cm.dispose();\n+                        } else if(curMap == 103000801) {   // stage 2\n+                                var stgProperty = \"stg2Property\";\n+                                var stgCombos = stage2Combos;\n+                                var stgAreas = stage2Rects;\n+\n+                                var nthtext = \"2nd\", nthobj = \"ropes\", nthverb = \"hang\", nthpos = \"hang on the ropes too low\";\n+                                var nextStgId = 103000802;\n+\n+                                if(!eim.isLeader(cm.getPlayer())) {\n+                                        cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n+                                }\n+                                else if(eim.getProperty(stgProperty) == null) {\n+                                        cm.sendNext(\"Hi. Welcome to the \" + nthtext + \" stage. Next to me, you'll see a number of \" + nthobj + \". Out of these \" + nthobj + \", #b3 are connected to the portal that sends you to the next stage#k. All you need to do is have #b3 party members find the correct \" + nthobj + \" and \" + nthverb + \" on them.#k\\r\\nBUT, it doesn't count as an answer if you \" + nthpos + \"; please be near the middle of the \" + nthobj + \" to be counted as a correct answer. Also, only 3 members of your party are allowed on the \" + nthobj + \". Once they are \" + nthverb + \"ing on them, the leader of the party must #bdouble-click me to check and see if the answer's correct or not#k. Now, find the right \" + nthobj + \" to \" + nthverb + \" on!\");\n+                                        var c = Math.floor(Math.random() * stgCombos.length);\n+                                        eim.setProperty(stgProperty, c.toString());\n+                                }\n+                                else {\n+                                        var accept = rectangleStages(eim, stgProperty, stgCombos, stgAreas);\n+\n+                                        if(accept) {\n+                                                clearStage(stage, eim, curMap);\n+                                                cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n+                                        }\n+                                        else {\n+                                                eim.showWrongEffect();\n+                                                cm.sendNext(\"It looks like you haven't found the 3 \" + nthobj + \" just yet. Please think of a different combination of \" + nthobj + \". Only 3 are allowed to \" + nthverb + \" on \" + nthobj + \", and if you \" + nthpos + \" it may not count as an answer, so please keep that in mind. Keep going!\");\n+                                        }\n+                                }\n+\n+                                cm.dispose();\n+                        } else if(curMap == 103000802) {\n+                                var stgProperty = \"stg3Property\";\n+                                var stgCombos = stage3Combos;\n+                                var stgAreas = stage3Rects;\n+\n+                                var nthtext = \"3rd\", nthobj = \"platforms\", nthverb = \"stand\", nthpos = \"stand too close to the edges\";\n+                                var nextStgId = 103000803;\n+\n+                                if(!eim.isLeader(cm.getPlayer())) {\n+                                        cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n+                                }\n+                                else if(eim.getProperty(stgProperty) == null) {\n+                                        cm.sendNext(\"Hi. Welcome to the \" + nthtext + \" stage. Next to me, you'll see a number of \" + nthobj + \". Out of these \" + nthobj + \", #b3 are connected to the portal that sends you to the next stage#k. All you need to do is have #b3 party members find the correct \" + nthobj + \" and \" + nthverb + \" on them.#k\\r\\nBUT, it doesn't count as an answer if you \" + nthpos + \"; please be near the middle of the \" + nthobj + \" to be counted as a correct answer. Also, only 3 members of your party are allowed on the \" + nthobj + \". Once they are \" + nthverb + \"ing on them, the leader of the party must #bdouble-click me to check and see if the answer's correct or not#k. Now, find the right \" + nthobj + \" to \" + nthverb + \" on!\");\n+                                        var c = Math.floor(Math.random() * stgCombos.length);\n+                                        eim.setProperty(stgProperty, c.toString());\n+                                }\n+                                else {\n+                                        var accept = rectangleStages(eim, stgProperty, stgCombos, stgAreas);\n+\n+                                        if(accept) {\n+                                                clearStage(stage, eim, curMap);\n+                                                cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n+                                        }\n+                                        else {\n+                                                eim.showWrongEffect();\n+                                                cm.sendNext(\"It looks like you haven't found the 3 \" + nthobj + \" just yet. Please think of a different combination of \" + nthobj + \". Only 3 are allowed to \" + nthverb + \" on \" + nthobj + \", and if you \" + nthpos + \" it may not count as an answer, so please keep that in mind. Keep going!\");\n+                                        }\n+                                }\n+\n+                                cm.dispose();\n+                        } else if(curMap == 103000803) {\n+                                var stgProperty = \"stg4Property\";\n+                                var stgCombos = stage4Combos;\n+                                var stgAreas = stage4Rects;\n+\n+                                var nthtext = \"4th\", nthobj = \"barrels\", nthverb = \"stand\", nthpos = \"stand too close to the edges\";\n+                                var nextStgId = 103000804;\n+\n+                                if(!eim.isLeader(cm.getPlayer())) {\n+                                        cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n+                                }\n+                                else if(eim.getProperty(stgProperty) == null) {\n+                                        cm.sendNext(\"Hi. Welcome to the \" + nthtext + \" stage. Next to me, you'll see a number of \" + nthobj + \". Out of these \" + nthobj + \", #b3 are connected to the portal that sends you to the next stage#k. All you need to do is have #b3 party members find the correct \" + nthobj + \" and \" + nthverb + \" on them.#k\\r\\nBUT, it doesn't count as an answer if you \" + nthpos + \"; please be near the middle of the \" + nthobj + \" to be counted as a correct answer. Also, only 3 members of your party are allowed on the \" + nthobj + \". Once they are \" + nthverb + \"ing on them, the leader of the party must #bdouble-click me to check and see if the answer's correct or not#k. Now, find the right \" + nthobj + \" to \" + nthverb + \" on!\");\n+                                        var c = Math.floor(Math.random() * stgCombos.length);\n+                                        eim.setProperty(stgProperty, c.toString());\n+                                }\n+                                else {\n+                                        var accept = rectangleStages(eim, stgProperty, stgCombos, stgAreas);\n+\n+                                        if(accept) {\n+                                                clearStage(stage, eim, curMap);\n+                                                cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n+                                        }\n+                                        else {\n+                                                eim.showWrongEffect();\n+                                                cm.sendNext(\"It looks like you haven't found the 3 \" + nthobj + \" just yet. Please think of a different combination of \" + nthobj + \". Only 3 are allowed to \" + nthverb + \" on \" + nthobj + \", and if you \" + nthpos + \" it may not count as an answer, so please keep that in mind. Keep going!\");\n+                                        }\n+                                }\n+\n+                                cm.dispose();\n+                        } else if(curMap == 103000804) {\n+                                if (eim.isLeader(cm.getPlayer())) {\n+                                        if (cm.haveItem(4001008, 10)) {\n+                                                cm.sendNext(\"Here's the portal that leads you to the last, bonus stage. It's a stage that allows you to defeat regular monsters a little easier. You'll be given a set amount of time to hunt as much as possible, but you can always leave the stage in the middle of it through the NPC. Again, congratulations on clearing all the stages. Let your party talk to me to receive their prizes as they are allowed to pass to the bonus stage. Take care...\");\n+                                                cm.gainItem(4001008, -10);\n+\n+                                                clearStage(stage, eim, curMap);\n+                                                eim.clearPQ();\n+                                        } else {\n+                                                cm.sendNext(\"Hello. Welcome to the 5th and final stage. Walk around the map and you'll be able to find some Boss monsters. Defeat all of them, gather up #bthe passes#k, and please get them to me. Once you earn your pass, the leader of your party will collect them, and then get them to me once the #bpasses#k are gathered up. The monsters may be familiar to you, but they may be much stronger than you think, so please be careful. Good luck!\");\n+                                        }\n+                                } else {\n+                                        cm.sendNext(\"Welcome to the 5th and final stage.  Walk around the map and you will be able to find some Boss monsters.  Defeat them all, gather up the #bpasses#k, and #bgive them to your leader#k.  Once you are done, return to me to collect your reward.\");\n+                                }\n+                                \n+                                cm.dispose();\n+                        }\n+                }\n+                else if (status == 1) {\n+                        if(!eim.giveEventReward(cm.getPlayer())) {\n+                                cm.sendNext(\"Please make room on your inventory first!\");\n+                        } else {\n+                                cm.warp(103000805, \"st00\");\n                         }\n-                    } else {\n-                        cm.sendNext(\"It looks like you haven't found the 3 \" + nthobj + \" just yet. Please think of a different combination of \" + nthobj + \". Only 3 are allowed to \" + nthverb + \" on \" + nthobj + \", and if you \" + nthpos + \" it may not count as an answer, so please keep that in mind. Keep going!\");\n+                        \n                         cm.dispose();\n-                    }\n                 }\n-            }\n-        } else {\n-            var complete = eim.getProperty(curMap + \"stageclear\");\n-            if (complete != null) {\n-                var target = eim.getMapInstance(103000800 + curMap);\n-                var targetPortal = target.getPortal(\"st00\");\n-                cm.getPlayer().changeMap(target, targetPortal);\n-            }\n-            cm.dispose();\n         }\n-    } else { // Not leader\n-        var complete = eim.getProperty(curMap.toString() + \"stageclear\");\n-        if (complete != null) {\n-            cm.sendNext(\"Please hurry on to the next stage, the portal opened!\");\n-        } else {\n-            cm.sendNext(\"Please have the party leader talk to me.\");\n-        }\n-        cm.dispose();\n-    }\n-}\n-\n-function isLeader(){\n-    if(cm.getParty() == null)\n-        return false;\n-    else\n-        return cm.isLeader();\n-}\n-\n-function getPrize(eim,cm) {\n-    var itemSetSel = Math.random();\n-    var itemSet;\n-    var itemSetQty;\n-    var hasQty = false;\n-    if (itemSetSel < 0.3)\n-        itemSet = prizeIdScroll;\n-    else if (itemSetSel < 0.6)\n-        itemSet = prizeIdEquip;\n-    else if (itemSetSel < 0.9) {\n-        itemSet = prizeIdUse;\n-        itemSetQty = prizeQtyUse;\n-        hasQty = true;\n-    } else {\n-        itemSet = prizeIdEtc;\n-        itemSetQty = prizeQtyEtc;\n-        hasQty = true;\n-    }\n-    var sel = Math.floor(Math.random()*itemSet.length);\n-    var qty = 1;\n-    if (hasQty)\n-        qty = itemSetQty[sel];\n-    cm.gainItem(itemSet[sel], qty, true, true);\n-        cm.getPlayer().changeMap(eim.getMapInstance(103000805));\n }\n\\ No newline at end of file"}, {"sha": "fbbc28076de082f2e97b74881fb150a5603eb474", "filename": "scripts/npc/world0/9020002.js", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9020002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9020002.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -46,7 +46,7 @@ function action(mode, type, selection){\n     var mapId = cm.getPlayer().getMapId();\n     if (mapId == 103000890) {\n         if (status == 0) {\n-            cm.sendNext(\"See you next time.\");\n+            cm.sendNext(\"To return back to the city, follow this way.\");\n         } else {\n             cm.getPlayer().changeMap(103000000, cm.getClient().getChannelServer().getMapFactory().getMap(103000000).getRandomSpawnpoint());\n             cm.removeAll(4001007);\n@@ -61,15 +61,7 @@ function action(mode, type, selection){\n             }\n             cm.sendYesNo(outText);\n         } else if (mode == 1) {\n-            var eim = cm.getPlayer().getEventInstance(); // Remove them from the PQ!\n-            if (eim == null)\n-                cm.warp(103000890, \"st00\"); // Warp player\n-            else if (cm.isLeader()) {\n-                //cm.getEventManager(\"KerningPQ\").setProperty(\"KPQOpen\" , \"true\");\n-                eim.disbandParty();\n-            }\n-            else\n-                eim.leftParty(cm.getPlayer());\n+            cm.warp(103000890, \"st00\"); // Warp player\n             cm.dispose();\n         }\n     }"}, {"sha": "46432c5e7674ac0b29341720a75fe4937432f675", "filename": "scripts/npc/world0/9040010.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9040010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9040010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9040010.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -34,7 +34,7 @@ function start() {\n \t\t\t\t\t\tpoints = 100;\n                     cm.getGuild().gainGP(points);\n                 }\n-                eim.finishPQ();\n+                eim.clearPQ();\n             }\n             else {\n                 cm.sendOk(\"This is your final challenge. Defeat the evil lurking within the Rubian and return it to me. That is all.\");"}, {"sha": "3fd9fc5e8600ad3df658f4aff6b8e78c383879c5", "filename": "scripts/npc/world0/9103001.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9103001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9103001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9103001.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -72,8 +72,11 @@ function action(mode, type, selection) {\n                 } else if (!open){\n                     cm.sendOk(\"The PQ is #rclosed#k for now.\");\n                 } else {\n-                    //cm.sendOk(\"You may enter\");//ENTER PQ\n-                    em.startInstance(cm.getParty(), cm.getPlayer().getMap());\n+                    if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap())) {\n+                        cm.sendOk(\"A party in your name is already registered in this event.\");\n+                        cm.dispose();\n+                        return;\n+                    }\n                     var party = cm.getPlayer().getEventInstance().getPlayers();\n                     cm.removeFromParty(4001106, party);\n                 }"}, {"sha": "e78524b640f71bf42f79b6d949de2b54921c6aad", "filename": "scripts/npc/world0/9201048.js", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9201048.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/npc/world0/9201048.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9201048.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -59,8 +59,13 @@ function start() {\n             var em = cm.getEventManager(\"AmoriaPQ\");\n             if (em == null)\n                 cm.dispose();\n-            else\n-                em.startInstance(cm.getParty(),cm.getPlayer().getMap());\n+            else {\n+                if(!em.startInstance(cm.getParty(),cm.getPlayer().getMap())) {\n+                    cm.sendOk(\"A party in your name is already registered in this event.\");\n+                    cm.dispose();\n+                    return;\n+                }\n+            }\n             cm.dispose();\n         }\n         else {"}, {"sha": "efbf215bb2bb39d274812798a0692971425b4085", "filename": "scripts/portal/kpq4.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/portal/kpq4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/portal/kpq4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/kpq4.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -26,7 +26,7 @@ Kerning PQ: 4th stage to final stage portal\n function enter(pi) {\n     var eim = pi.getPlayer().getEventInstance();\n     var target = eim.getMapInstance(103000805);\n-    if (eim.getProperty(\"4stageclear\") != null) {\n+    if (eim.getProperty(\"5stageclear\") != null) {\n         pi.getPlayer().changeMap(target, target.getPortal(\"st00\"));\n         return true;\n     }"}, {"sha": "b47179ae6154da22caa6597f42885f40095bca9f", "filename": "scripts/portal/party6_out.js", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/portal/party6_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/scripts/portal/party6_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/party6_out.js?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -1,7 +1,8 @@\n function enter(pi) {\n         if ((pi.getMap().getMonsters().size() == 0 || pi.getMap().getMonsterById(9300183) != null) && (pi.getMap().getReactorByName(\"\") == null || pi.getMap().getReactorByName(\"\").getState() == 1)) {\n                 if(pi.isLeader()) {\n-                        pi.clearPQ(930000800);\n+                        pi.getEventInstance().clearPQ();\n+                        pi.getEventInstance().warpEventTeam(930000800);\n                         return true;\n                 }\n                 else {"}, {"sha": "8f3ee6e20597a7a3975227c6b4602c45d65ea8c4", "filename": "sql/db_drops.sql", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -19106,6 +19106,8 @@\n   UPDATE reactordrops SET questid=6002 WHERE itemid=4031508;\n   UPDATE reactordrops SET questid=9351 WHERE itemid=4031258;\n   UPDATE reactordrops SET questid=3083 WHERE itemid >= 4031274 AND itemid <= 4031278;\n+  UPDATE reactordrops SET questid=1008 WHERE itemid=4031161;\n+  UPDATE reactordrops SET questid=1008 WHERE itemid=4031162;\n \n   INSERT INTO `reactordrops` (`reactorid`, `itemid`, `chance`, `questid`) VALUES\n     (9102000, 4031157, 1, 2074),"}, {"sha": "1f944870a8719452716ff69ee61bcdd559652f3b", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 60, "deletions": 7, "changes": 67, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -151,9 +151,17 @@\n     private static final int[]  EXP_RATE_GAIN = {1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144};    //fibonacci :3\n     \n     private static final String LEVEL_200 = \"[Congrats] %s has reached Level 200! Congratulate %s on such an amazing achievement!\";\n+\n+    // MapleStory default keyset\n     private static final int[] DEFAULT_KEY = {18, 65, 2, 23, 3, 4, 5, 6, 16, 17, 19, 25, 26, 27, 31, 34, 35, 37, 38, 40, 43, 44, 45, 46, 50, 56, 59, 60, 61, 62, 63, 64, 57, 48, 29, 7, 24, 33, 41, 39};\n     private static final int[] DEFAULT_TYPE = {4, 6, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 4, 4, 5, 6, 6, 6, 6, 6, 6, 5, 4, 5, 4, 4, 4, 4, 4};\n     private static final int[] DEFAULT_ACTION = {0, 106, 10, 1, 12, 13, 18, 24, 8, 5, 4, 19, 14, 15, 2, 17, 11, 3, 20, 16, 9, 50, 51, 6, 7, 53, 100, 101, 102, 103, 104, 105, 54, 22, 52, 21, 25, 26, 23, 27};\n+    \n+    // MapleSolaxiaV2 custom keyset\n+    private static final int[] CUSTOM_KEY = {2, 3, 4, 5, 31, 56, 59, 32, 42, 6, 17, 29, 30, 41, 50, 60, 61, 62, 63, 64, 65, 16, 7, 8};\n+    private static final int[] CUSTOM_TYPE = {4, 4, 4, 4, 5, 5, 6, 5, 5, 4, 4, 4, 5, 4, 4, 6, 6, 6, 6, 6, 6, 4, 4, 4};\n+    private static final int[] CUSTOM_ACTION = {1, 0, 3, 2, 53, 54, 100, 52, 51, 19, 5, 9, 50, 7, 22, 101, 102, 103, 104, 105, 106, 8, 17, 26};\n+    \n     private static final String[] BLOCKED_NAMES = {\"admin\", \"owner\", \"moderator\", \"intern\", \"donor\", \"administrator\", \"help\", \"helper\", \"alert\", \"notice\", \"maplestory\", \"Solaxia\", \"fuck\", \"wizet\", \"fucking\", \"negro\", \"fuk\", \"fuc\", \"penis\", \"pussy\", \"asshole\", \"gay\",\n         \"nigger\", \"homo\", \"suck\", \"cum\", \"shit\", \"shitty\", \"condom\", \"security\", \"official\", \"rape\", \"nigga\", \"sex\", \"tit\", \"boner\", \"orgy\", \"clit\", \"asshole\", \"fatass\", \"bitch\", \"support\", \"gamemaster\", \"cock\", \"gaay\", \"gm\",\n         \"operate\", \"master\", \"sysop\", \"party\", \"GameMaster\", \"community\", \"message\", \"event\", \"test\", \"meso\", \"Scania\", \"renewal\", \"yata\", \"AsiaSoft\", \"henesys\"};\n@@ -354,9 +362,28 @@ public static MapleCharacter getDefault(MapleClient c) {\n         ret.getInventory(MapleInventoryType.USE).setSlotLimit(24);\n         ret.getInventory(MapleInventoryType.SETUP).setSlotLimit(24);\n         ret.getInventory(MapleInventoryType.ETC).setSlotLimit(24);\n-        for (int i = 0; i < DEFAULT_KEY.length; i++) {\n-            ret.keymap.put(DEFAULT_KEY[i], new MapleKeyBinding(DEFAULT_TYPE[i], DEFAULT_ACTION[i]));\n+        \n+        // Select a keybinding method\n+        int[] selectedKey;\n+        int[] selectedType;\n+        int[] selectedAction;\n+        \n+        if(ServerConstants.USE_CUSTOM_KEYSET) {\n+            selectedKey = CUSTOM_KEY;\n+            selectedType = CUSTOM_TYPE;\n+            selectedAction = CUSTOM_ACTION;\n         }\n+        else {\n+            selectedKey = DEFAULT_KEY;\n+            selectedType = DEFAULT_TYPE;\n+            selectedAction = DEFAULT_ACTION;\n+        }\n+                \n+        for (int i = 0; i < selectedKey.length; i++) {\n+            ret.keymap.put(selectedKey[i], new MapleKeyBinding(selectedType[i], selectedAction[i]));\n+        }\n+        \n+        \n         //to fix the map 0 lol\n         for (int i = 0; i < 5; i++) {\n             ret.trockmaps.add(999999999);\n@@ -1206,6 +1233,11 @@ public void run() {\n             newWarpMap = -1;\n             changeMap(temp);\n         }\n+        \n+        // if this event map has a gate already opened, render it\n+        if(getEventInstance() != null) {\n+            getEventInstance().recoverOpenedGate(this, map.getId());\n+        }\n     }\n \n     public void changePage(int page) {\n@@ -1714,6 +1746,10 @@ public void gainFame(int delta) {\n         this.addFame(delta);\n         this.updateSingleStat(MapleStat.FAME, this.fame);\n     }\n+    \n+    public void gainMeso(int gain) {\n+        gainMeso(gain, true, false, true);\n+    }\n \n     public void gainMeso(int gain, boolean show) {\n         gainMeso(gain, show, false, false);\n@@ -3475,7 +3511,7 @@ public void mobKilled(int id) {\n \t\tint lastQuestProcessed = 0;\n         try {\n             for (MapleQuestStatus q : quests.values()) {\n-\t\t\t\tlastQuestProcessed = q.getQuest().getId();\n+                lastQuestProcessed = q.getQuest().getId();\n                 if (q.getStatus() == MapleQuestStatus.Status.COMPLETED || q.getQuest().canComplete(this, null)) {\n                     continue;\n                 }\n@@ -4037,12 +4073,28 @@ public final boolean insertNewChar() {\n                 return false;\n             }\n \n+            // Select a keybinding method\n+            int[] selectedKey;\n+            int[] selectedType;\n+            int[] selectedAction;\n+\n+            if(ServerConstants.USE_CUSTOM_KEYSET) {\n+                selectedKey = CUSTOM_KEY;\n+                selectedType = CUSTOM_TYPE;\n+                selectedAction = CUSTOM_ACTION;\n+            }\n+            else {\n+                selectedKey = DEFAULT_KEY;\n+                selectedType = DEFAULT_TYPE;\n+                selectedAction = DEFAULT_ACTION;\n+            }\n+            \n             ps = con.prepareStatement(\"INSERT INTO keymap (characterid, `key`, `type`, `action`) VALUES (?, ?, ?, ?)\");\n             ps.setInt(1, id);\n-            for (int i = 0; i < DEFAULT_KEY.length; i++) {\n-                ps.setInt(2, DEFAULT_KEY[i]);\n-                ps.setInt(3, DEFAULT_TYPE[i]);\n-                ps.setInt(4, DEFAULT_ACTION[i]);\n+            for (int i = 0; i < selectedKey.length; i++) {\n+                ps.setInt(2, selectedKey[i]);\n+                ps.setInt(3, selectedType[i]);\n+                ps.setInt(4, selectedAction[i]);\n                 ps.execute();\n             }\n             ps.close();\n@@ -4203,6 +4255,7 @@ public synchronized void saveToDB() {\n                 ps.addBatch();\n             }\n             ps.executeBatch();\n+            \n             deleteWhereCharacterId(con, \"DELETE FROM skillmacros WHERE characterid = ?\");\n             ps = con.prepareStatement(\"INSERT INTO skillmacros (characterid, skill1, skill2, skill3, name, shout, position) VALUES (?, ?, ?, ?, ?, ?, ?)\");\n             ps.setInt(1, getId());"}, {"sha": "b891cb041c01323c4d44b805f6ab38947137442c", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -24,6 +24,7 @@\n     public static boolean JAVA_8;\n     public static boolean SHUTDOWNHOOK;\n     //Gameplay Configurations\n+    public static final boolean USE_CUSTOM_KEYSET = true;\n     public static final boolean USE_MAXRANGE = true;        //will send and receive packets from all events of a map, rather than those of only view range.\n     public static final boolean USE_DEBUG = true;           //will enable some text prints and new commands in the client oriented for debugging.\n     public static final boolean USE_MTS = false;"}, {"sha": "70f17a67add8702715898fe7019750659c550aca", "filename": "src/net/server/channel/handlers/KeymapChangeHandler.java", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/KeymapChangeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/KeymapChangeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/KeymapChangeHandler.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -35,28 +35,30 @@\n public final class KeymapChangeHandler extends AbstractMaplePacketHandler {\n \t@Override\n \tpublic final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-\t\tif (slea.available() >= 8) {\n+                if (slea.available() >= 8) {\n \t\t\tint mode = slea.readInt();\n \t\t\tif(mode == 0) {\n \t\t\t\tint numChanges = slea.readInt();\n \t\t\t\tfor (int i = 0; i < numChanges; i++) {\n \t\t\t\t\tint key = slea.readInt();\n \t\t\t\t\tint type = slea.readByte();\n-\t\t\t\t\tint action = slea.readInt();              \n+\t\t\t\t\tint action = slea.readInt();\n+                                        \n \t\t\t\t\tSkill skill = SkillFactory.getSkill(action);\n \t\t\t\t\tboolean isBanndedSkill = false;\n \t\t\t\t\tif (skill != null) {\n-\t\t\t\t\t\tisBanndedSkill = GameConstants.bannedBindSkills(skill.getId());         \n+\t\t\t\t\t\tisBanndedSkill = GameConstants.bannedBindSkills(skill.getId());\n \t\t\t\t\t\tif (isBanndedSkill || (!c.getPlayer().isGM() && GameConstants.isGMSkills(skill.getId())) || (!GameConstants.isInJobTree(skill.getId(), c.getPlayer().getJob().getId()) && !c.getPlayer().isGM())) { //for those skills are are \"technically\" in the beginner tab, like bamboo rain in Dojo or skills you find in PYPQ\n \t\t\t\t\t\t\tAutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit keymapping.\");\n \t\t\t\t\t\t\tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to use skill \" + skill.getId() + \"\\r\\n\");\n \t\t\t\t\t\t\tc.disconnect(true, false);\n \t\t\t\t\t\t\treturn;\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tif (c.getPlayer().getSkillLevel(skill) < 1) {\n-\t\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t\t}\n+\t\t\t\t\t\t/* if (c.getPlayer().getSkillLevel(skill) < 1) {    HOW WOULD A SKILL EVEN BE AVAILABLE TO KEYBINDING\n+\t\t\t\t\t\t\tcontinue;                                   IF THERE IS NOT EVEN A SINGLE POINT USED INTO IT??\n+\t\t\t\t\t\t} */                                              //Nice to know some skills have the same ids as items, heh.\n \t\t\t\t\t}\n+                                        \n \t\t\t\t\tc.getPlayer().changeKeybinding(key, new MapleKeyBinding(type, action));\n \t\t\t\t}\n \t\t\t} else if(mode == 1) { // Auto HP Potion"}, {"sha": "d7984df99e7119664018a9f5fb65f4603e5b1f6f", "filename": "src/net/server/channel/handlers/PartyOperationHandler.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/PartyOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/PartyOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PartyOperationHandler.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -99,10 +99,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 String name = slea.readMapleAsciiString();\n                 MapleCharacter invited = world.getPlayerStorage().getCharacterByName(name);\n                 if (invited != null) {\n-                \tif(invited.getLevel() < 10) { //min requirement is level 10\n-                \t\t c.announce(MaplePacketCreator.serverNotice(5, \"The player you have invited does not meet the requirements.\"));\n-                \t\treturn;\n-                \t}\n+                    if(invited.getLevel() < 10) { //min requirement is level 10\n+                             c.announce(MaplePacketCreator.serverNotice(5, \"The player you have invited does not meet the requirements.\"));\n+                            return;\n+                    }\n                     if (invited.getParty() == null) {\n                         if (player.getParty() == null) {\n                             partyplayer = new MaplePartyCharacter(player);"}, {"sha": "c2ed617358b8b0b23dac6598a3e80c4abdbd1df3", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -245,8 +245,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         player.checkBerserk();\n         player.expirationTask();\n         //player.setRates();\n-\t\tif (GameConstants.hasSPTable(player.getJob()) && player.getJob().getId() != 2001) {\n-\t\t\tplayer.createDragon();\n+        if (GameConstants.hasSPTable(player.getJob()) && player.getJob().getId() != 2001) {\n+                player.createDragon();\n         }\n         if (newcomer){\n             /*"}, {"sha": "dedb7ec7a811f1a7e80a402ddf79fd8b3c9cf2ef", "filename": "src/net/server/channel/handlers/QuestActionHandler.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/QuestActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/net/server/channel/handlers/QuestActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/QuestActionHandler.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -59,18 +59,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         } else if (action == 4) { // scripted start quest\n             int npc = slea.readInt();\n             slea.readInt();\n-\t\t\tif(quest.canStart(player, npc)) {\n-\t\t\t\tQuestScriptManager.getInstance().start(c, questid, npc);\n-\t\t\t}\n+            if(quest.canStart(player, npc)) {\n+                QuestScriptManager.getInstance().start(c, questid, npc);\n+            }\n         } else if (action == 5) { // scripted end quests\n             //System.out.println(slea.toString());\n             int npc = slea.readInt();\n             slea.readInt();\n             \n             if(quest.canComplete(player, npc)) {\n-                    QuestScriptManager.getInstance().end(c, questid, npc);\n-                    player.getClient().getSession().write(MaplePacketCreator.showSpecialEffect(9)); //show effect when completion \n-                    player.getMap().broadcastMessage(player, MaplePacketCreator.showForeignEffect(player.getId(), 9));//show effect around players I guess\n+                QuestScriptManager.getInstance().end(c, questid, npc);\n+                player.getClient().getSession().write(MaplePacketCreator.showSpecialEffect(9)); //show effect when completion \n+                player.getMap().broadcastMessage(player, MaplePacketCreator.showForeignEffect(player.getId(), 9));//show effect around players I guess\n             }\n         }\n     }"}, {"sha": "1309c596e338bbbe4ee6342267185d1d3e45390e", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 6, "deletions": 10, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -32,6 +32,7 @@\n import net.server.guild.MapleGuild;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n+import scripting.event.EventInstanceManager;\n import scripting.event.EventManager;\n import scripting.npc.NPCScriptManager;\n import server.MapleInventoryManipulator;\n@@ -157,24 +158,19 @@ public EventManager getEventManager(String event) {\n \t\treturn getClient().getEventManager(event);\n \t}\n         \n-        public void clearPQ(int toMap) {\n-                clearPQ(getWarpMap(toMap));\n-        }\n+        public EventInstanceManager getEventInstance() {\n+\t\treturn getPlayer().getEventInstance();\n+\t}\n         \n-        public void clearPQ(MapleMap toMap) {\n-                if(getPlayer().getEventInstance() != null)\n-                        getPlayer().getEventInstance().getEm().clearPQ(getPlayer().getEventInstance(), toMap);\n-        }\n-\n         public MapleInventory getInventory(MapleInventoryType type) {\n                 return getPlayer().getInventory(type);\n         }\n         \n-\tpublic boolean hasItem(int itemid){\n+\tpublic boolean hasItem(int itemid) {\n \t\treturn haveItem(itemid, 1);\n \t}\n \n-\tpublic boolean hasItem(int itemid, int quantity){\n+\tpublic boolean hasItem(int itemid, int quantity) {\n \t\treturn haveItem(itemid, quantity);\n \t}\n "}, {"sha": "da74b73e63779ada00fb066eb4503a610ae4cf0a", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 360, "deletions": 140, "changes": 500, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -25,10 +25,12 @@\n import java.sql.PreparedStatement;\n import java.sql.SQLException;\n import java.util.ArrayList;\n-import java.util.HashMap;\n import java.util.LinkedList;\n import java.util.List;\n+import java.util.HashMap;\n import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.Properties;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n@@ -39,6 +41,7 @@\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n import provider.MapleDataProviderFactory;\n+import server.MaplePortal;\n import server.TimerManager;\n import server.expeditions.MapleExpedition;\n import server.life.MapleMonster;\n@@ -52,6 +55,7 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n import scripting.AbstractPlayerInteraction;\n+import tools.MaplePacketCreator;\n \n /**\n  *\n@@ -75,12 +79,23 @@\n         private final WriteLock wL = mutex.writeLock();\n         private ScheduledFuture<?> event_schedule = null;\n         private boolean disposed = false;\n+        private boolean eventCleared = false;\n         \n         // multi-leveled PQ rewards!\n         private Map<Integer, List<Integer>> collectionSet = new HashMap<>(ServerConstants.MAX_EVENT_LEVELS);\n         private Map<Integer, List<Integer>> collectionQty = new HashMap<>(ServerConstants.MAX_EVENT_LEVELS);\n         private Map<Integer, Integer> collectionExp = new HashMap<>(ServerConstants.MAX_EVENT_LEVELS);\n         \n+        // Exp/Meso rewards by CLEAR on a stage\n+        private List<Integer> onMapClearExp = new ArrayList<>();\n+        private List<Integer> onMapClearMeso = new ArrayList<>();\n+        \n+        // registers player status on an event (null on this Map structure equals to 0)\n+        private Map<Integer, Integer> playerGrid = new HashMap<>();\n+        \n+        // registers all opened gates on the event. Will help late characters to encounter next stages gates already opened\n+        private Set<Integer> openedGates = new HashSet<>();\n+        \n \tpublic EventInstanceManager(EventManager em, String name) {\n \t\tthis.em = em;\n \t\tthis.name = name;\n@@ -97,6 +112,8 @@ public void giveEventPlayersExp(int gain) {\n         }\n         \n         public void giveEventPlayersExp(int gain, int mapId) {\n+                if(gain == 0) return;\n+            \n                 rL.lock();\n                 try {\n                         if(mapId == -1) {\n@@ -113,6 +130,30 @@ public void giveEventPlayersExp(int gain, int mapId) {\n                         rL.unlock();\n                 }\n \t}\n+        \n+        public void giveEventPlayersMeso(int gain) {\n+                giveEventPlayersMeso(gain, -1);\n+        }\n+        \n+        public void giveEventPlayersMeso(int gain, int mapId) {\n+                if(gain == 0) return;\n+            \n+                rL.lock();\n+                try {\n+                        if(mapId == -1) {\n+                                for(MapleCharacter mc: chars) {\n+                                        mc.gainMeso(gain * mc.getMesoRate());\n+                                }\n+                        }\n+                        else {\n+                                for(MapleCharacter mc: chars) {\n+                                        if(mc.getMapId() == mapId) mc.gainMeso(gain * mc.getMesoRate());\n+                                }\n+                        }\n+                } finally {\n+                        rL.unlock();\n+                }\n+\t}\n \n \tpublic void registerPlayer(MapleCharacter chr) {\n \t\tif (chr == null || !chr.isLoggedin()){\n@@ -186,12 +227,19 @@ public void run() {\n                 }\n         }\n         \n-        public void cancelEventTimer() {\n-                if(event_schedule != null) event_schedule.cancel(false);\n+        public void stopEventTimer() {\n+                if(event_schedule != null) {\n+                    event_schedule.cancel(false);\n+                    event_schedule = null;\n+                }\n                 dismissEventTimer();\n         }\n         \n         private void dismissEventTimer() {\n+                for(MapleCharacter chr: getPlayers()) {\n+                    chr.getClient().getSession().write(MaplePacketCreator.removeClock());\n+                }\n+                \n                 event_schedule = null;\n                 eventTime = 0;\n                 timeStarted = 0;\n@@ -220,9 +268,10 @@ public void registerExpedition(MapleExpedition exped) {\n \tpublic void unregisterPlayer(MapleCharacter chr) {\n                 wL.lock();\n                 try {\n-                    chars.remove(chr);\n+                        chars.remove(chr);\n+                        gridRemove(chr);\n                 } finally {\n-                    wL.unlock();\n+                        wL.unlock();\n                 }\n             \n \t\tchr.setEventInstance(null);\n@@ -231,20 +280,20 @@ public void unregisterPlayer(MapleCharacter chr) {\n \tpublic int getPlayerCount() {\n                 rL.lock();\n                 try {\n-                    return chars.size();\n+                        return chars.size();\n                 }\n                 finally {\n-                    rL.unlock();\n+                        rL.unlock();\n                 }\n \t}\n \n \tpublic List<MapleCharacter> getPlayers() {\n                 rL.lock();\n                 try {\n-                    return new ArrayList<>(chars);\n+                        return new ArrayList<>(chars);\n                 }\n                 finally {\n-                    rL.unlock();\n+                        rL.unlock();\n                 }\n \t}\n \n@@ -340,37 +389,40 @@ public void monsterKilled(MapleCharacter chr, MapleMonster mob) {\n \n \tpublic int getKillCount(MapleCharacter chr) {\n \t\tInteger kc = killCount.get(chr);\n-\t\tif (kc == null) {\n-\t\t\treturn 0;\n-\t\t} else {\n-\t\t\treturn kc;\n-\t\t}\n+\t\treturn (kc == null) ? 0 : kc;\n \t}\n+        \n+        public void cancelSchedule() {\n+            if(event_schedule != null) {\n+                event_schedule.cancel(false);\n+                event_schedule = null;\n+            }\n+        }\n \n \tpublic void dispose() {\n-            try {\n-                em.getIv().invokeFunction(\"dispose\", this);\n-            } catch (ScriptException | NoSuchMethodException ex) {\n-                ex.printStackTrace();\n-            }\n+                try {\n+                        em.getIv().invokeFunction(\"dispose\", this);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \n-            wL.lock();\n-            try {\n-                chars.clear();\n-            } finally {\n-                wL.unlock();\n-            }\n-            \n-            if(event_schedule != null) event_schedule.cancel(false);\n+                wL.lock();\n+                try {\n+                        chars.clear();\n+                } finally {\n+                        wL.unlock();\n+                }\n+                \n+                cancelSchedule();\n \n-            mobs.clear();\n-            killCount.clear();\n-            mapFactory = null;\n-            if (expedition != null) {\n-                    em.getChannelServer().getExpeditions().remove(expedition);\n-            }\n-            em.disposeInstance(name);\n-            em = null;\n+                mobs.clear();\n+                killCount.clear();\n+                mapFactory = null;\n+                if (expedition != null) {\n+                        em.getChannelServer().getExpeditions().remove(expedition);\n+                }\n+                em.disposeInstance(name);\n+                em = null;\n \t}\n \n \tpublic MapleMapFactory getMapFactory() {\n@@ -381,6 +433,8 @@ public void schedule(final String methodName, long delay) {\n \t\tTimerManager.getInstance().schedule(new Runnable() {\n \t\t\t@Override\n \t\t\tpublic void run() {\n+                                if(em == null) return;\n+                                \n \t\t\t\ttry {\n \t\t\t\t\tem.getIv().invokeFunction(methodName, EventInstanceManager.this);\n \t\t\t\t} catch (ScriptException | NoSuchMethodException ex) {\n@@ -431,8 +485,8 @@ public String getProperty(String key) {\n \t\treturn props.getProperty(key);\n \t}\n \n-        public Properties getProperties(){\n-            return props;\n+        public Properties getProperties() {\n+                return props;\n         }\n \t\n \tpublic void leftParty(MapleCharacter chr) {\n@@ -451,7 +505,7 @@ public void disbandParty() {\n \t\t}\n \t}\n \n-\tpublic void finishPQ() {\n+\tpublic void clearPQ() {\n \t\ttry {\n \t\t\tem.getIv().invokeFunction(\"clearPQ\", this);\n \t\t} catch (ScriptException | NoSuchMethodException ex) {\n@@ -472,149 +526,315 @@ public boolean isLeader(MapleCharacter chr) {\n \t}\n         \n         public final MapleMap setInstanceMap(final int mapid) { //gets instance map from the channelserv\n-            if (disposed) {\n+                if (disposed) {\n+                        return this.getMapFactory().getMap(mapid);\n+                }\n+                mapIds.add(mapid);\n+                isInstanced.add(false);\n                 return this.getMapFactory().getMap(mapid);\n-            }\n-            mapIds.add(mapid);\n-            isInstanced.add(false);\n-            return this.getMapFactory().getMap(mapid);\n         }\n         \n         public final boolean disposeIfPlayerBelow(final byte size, final int towarp) {\n-            if (disposed) {\n-                return true;\n-            }\n-            MapleMap map = null;\n-            if (towarp > 0) {\n-                map = this.getMapFactory().getMap(towarp);\n-            }\n+                if (disposed) {\n+                        return true;\n+                }\n+                MapleMap map = null;\n+                if (towarp > 0) {\n+                        map = this.getMapFactory().getMap(towarp);\n+                }\n \n-            rL.lock();\n-            try {\n-                if (chars != null && chars.size() < size) {\n-                    for (MapleCharacter chr : chars) {\n-                        if (chr == null) {\n-                            continue;\n-                        }\n-                        unregisterPlayer(chr);\n-                        if (towarp > 0) {\n-                            chr.changeMap(map, map.getPortal(0));\n+                rL.lock();\n+                try {\n+                        if (chars != null && chars.size() < size) {\n+                                for (MapleCharacter chr : chars) {\n+                                        if (chr == null) {\n+                                                continue;\n+                                        }\n+\n+                                        unregisterPlayer(chr);\n+                                        if (towarp > 0) {\n+                                                chr.changeMap(map, map.getPortal(0));\n+                                        }\n+                                }\n+\n+                                dispose();\n+                                return true;\n                         }\n-                    }\n-                    dispose();\n-                    return true;\n-                }\n-            } catch (Exception ex) {\n-                ex.printStackTrace();\n-            } finally {\n-                rL.unlock();\n-            }\n-            return false;\n+                } catch (Exception ex) {\n+                        ex.printStackTrace();\n+                } finally {\n+                        rL.unlock();\n+                }\n+                return false;\n         }\n         \n         private List<Integer> convertToIntegerArray(List<Double> list) {\n-            List<Integer> intList = new ArrayList<>();\n-            for(Double d: list) intList.add(d.intValue());\n-            \n-            return intList;\n+                List<Integer> intList = new ArrayList<>();\n+                for(Double d: list) intList.add(d.intValue());\n+\n+                return intList;\n+        }\n+        \n+        public void setEventClearStageExp(List<Double> gain) {\n+                onMapClearExp.clear();\n+                onMapClearExp.addAll(convertToIntegerArray(gain));\n+        }\n+        \n+        public void setEventClearStageMeso(List<Double> gain) {\n+                onMapClearMeso.clear();\n+                onMapClearMeso.addAll(convertToIntegerArray(gain));\n+        }\n+        \n+        public Integer getClearStageExp(int stage) {    //stage counts from ONE.\n+                if(stage > onMapClearExp.size()) return 0;\n+                return onMapClearExp.get(stage - 1);\n+        }\n+        \n+        public Integer getClearStageMeso(int stage) {   //stage counts from ONE.\n+                if(stage > onMapClearMeso.size()) return 0;\n+                return onMapClearMeso.get(stage - 1);\n+        }\n+        \n+        public List<Integer> getClearStageBonus(int stage) {\n+                List<Integer> list = new ArrayList<>();\n+                list.add(getClearStageExp(stage));\n+                list.add(getClearStageMeso(stage));\n+                \n+                return list;\n         }\n         \n         public final void setEventRewards(List<Double> rwds, List<Double> qtys, int expGiven) {\n-            setEventRewards(1, rwds, qtys, expGiven);\n+                setEventRewards(1, rwds, qtys, expGiven);\n         }\n         \n         public final void setEventRewards(List<Double> rwds, List<Double> qtys) {\n-            setEventRewards(1, rwds, qtys);\n+                setEventRewards(1, rwds, qtys);\n         }\n         \n         public final void setEventRewards(int eventLevel, List<Double> rwds, List<Double> qtys) {\n-            setEventRewards(eventLevel, rwds, qtys, 0);\n+                setEventRewards(eventLevel, rwds, qtys, 0);\n         }\n         \n         public final void setEventRewards(int eventLevel, List<Double> rwds, List<Double> qtys, int expGiven) {\n-            // fixed EXP will be rewarded at the same time the random item is given\n-            \n-            if(eventLevel <= 0 || eventLevel > ServerConstants.MAX_EVENT_LEVELS) return;\n-            eventLevel--;    //event level starts from 1\n-            \n-            List<Integer> rewardIds = convertToIntegerArray(rwds);\n-            List<Integer> rewardQtys = convertToIntegerArray(qtys);\n-            \n-            //rewardsSet and rewardsQty hold temporary values\n-            collectionSet.put(eventLevel, rewardIds);\n-            collectionQty.put(eventLevel, rewardQtys);\n-            collectionExp.put(eventLevel, expGiven);\n+                // fixed EXP will be rewarded at the same time the random item is given\n+\n+                if(eventLevel <= 0 || eventLevel > ServerConstants.MAX_EVENT_LEVELS) return;\n+                eventLevel--;    //event level starts from 1\n+\n+                List<Integer> rewardIds = convertToIntegerArray(rwds);\n+                List<Integer> rewardQtys = convertToIntegerArray(qtys);\n+\n+                //rewardsSet and rewardsQty hold temporary values\n+                wL.lock();\n+                try {\n+                        collectionSet.put(eventLevel, rewardIds);\n+                        collectionQty.put(eventLevel, rewardQtys);\n+                        collectionExp.put(eventLevel, expGiven);\n+                } finally {\n+                        wL.unlock();\n+                }\n         }\n         \n         private byte getRewardListRequirements(int level) {\n-            if(level >= collectionSet.size()) return 0;\n-            \n-            byte rewardTypes = 0;\n-            List<Integer> list = collectionSet.get(level);\n-            \n-            for (Integer itemId : list) {\n-                rewardTypes |= (1 << ItemConstants.getInventoryType(itemId).getType());\n-            }\n-            \n-            return rewardTypes;\n+                if(level >= collectionSet.size()) return 0;\n+\n+                byte rewardTypes = 0;\n+                List<Integer> list = collectionSet.get(level);\n+\n+                for (Integer itemId : list) {\n+                        rewardTypes |= (1 << ItemConstants.getInventoryType(itemId).getType());\n+                }\n+\n+                return rewardTypes;\n         }\n         \n         private boolean hasRewardSlot(MapleCharacter player, int eventLevel) {\n-            byte listReq = getRewardListRequirements(eventLevel);   //gets all types of items present in the event reward list\n-            \n-            //iterating over all valid inventory types\n-            for(byte type = 1; type <= 5; type++) {\n-                if((listReq >> type) % 2 == 1 && !player.hasEmptySlot(type))\n-                    return false;\n-            }\n-            \n-            return true;\n+                byte listReq = getRewardListRequirements(eventLevel);   //gets all types of items present in the event reward list\n+\n+                //iterating over all valid inventory types\n+                for(byte type = 1; type <= 5; type++) {\n+                        if((listReq >> type) % 2 == 1 && !player.hasEmptySlot(type))\n+                                return false;\n+                }\n+\n+                return true;\n         }\n         \n         public final boolean giveEventReward(MapleCharacter player) {\n-            return giveEventReward(player, 1);\n+                return giveEventReward(player, 1);\n         }\n         \n         //gives out EXP & a random item in a similar fashion of when clearing KPQ, LPQ, etc.\n         public final boolean giveEventReward(MapleCharacter player, int eventLevel) {\n-            eventLevel--;       //event level starts counting from 1\n-            if(eventLevel >= collectionSet.size()) return true;\n-            \n-            List<Integer> rewardsSet = collectionSet.get(eventLevel);\n-            List<Integer> rewardsQty = collectionQty.get(eventLevel);\n-            \n-            Integer rewardExp = collectionExp.get(eventLevel);\n-            if(rewardExp == null) rewardExp = 0;\n-            \n-            if(rewardsSet == null || rewardsSet.isEmpty()) {\n-                if(rewardExp > 0) player.gainExp(rewardExp);\n-                return true;\n-            }\n-            \n-            if(!hasRewardSlot(player, eventLevel)) return false;\n+                rL.lock();\n+                try {\n+                        eventLevel--;       //event level starts counting from 1\n+                        if(eventLevel >= collectionSet.size()) return true;\n \n-            AbstractPlayerInteraction api = new AbstractPlayerInteraction(player.getClient());\n-            int rnd = (int)Math.floor(Math.random() * rewardsSet.size());\n-            \n-            api.gainItem(rewardsSet.get(rnd), rewardsQty.get(rnd).shortValue());\n-            if(rewardExp > 0) player.gainExp(rewardExp);\n-            return true;\n+                        List<Integer> rewardsSet = collectionSet.get(eventLevel);\n+                        List<Integer> rewardsQty = collectionQty.get(eventLevel);\n+\n+                        Integer rewardExp = collectionExp.get(eventLevel);\n+                        if(rewardExp == null) rewardExp = 0;\n+\n+                        if(rewardsSet == null || rewardsSet.isEmpty()) {\n+                                if(rewardExp > 0) player.gainExp(rewardExp);\n+                                return true;\n+                        }\n+\n+                        if(!hasRewardSlot(player, eventLevel)) return false;\n+\n+                        AbstractPlayerInteraction api = new AbstractPlayerInteraction(player.getClient());\n+                        int rnd = (int)Math.floor(Math.random() * rewardsSet.size());\n+\n+                        api.gainItem(rewardsSet.get(rnd), rewardsQty.get(rnd).shortValue());\n+                        if(rewardExp > 0) player.gainExp(rewardExp);\n+                        return true;\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final void setEventCleared() {\n+                eventCleared = true;\n+        }\n+        \n+        public final boolean isEventTeamLackingNow(boolean testLeader, int minPlayers, MapleCharacter quitter) {\n+                if(eventCleared && getPlayerCount() > 1) return false;\n+                \n+                if(!eventCleared && testLeader && getLeader().getId() == quitter.getId()) return true;\n+                if(getPlayerCount() <= minPlayers) return true;\n+                \n+                return false;\n         }\n         \n         public final boolean isEventTeamTogether() {\n-            if(chars.size() <= 1) return true;\n+                rL.lock();\n+                try {\n+                        if(chars.size() <= 1) return true;\n+\n+                        int mapId = chars.get(0).getMapId();\n+                        for(int i = 1; i < chars.size(); i++) {\n+                                if(chars.get(i).getMapId() != mapId) return false;\n+                        }\n+\n+                        return true;\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final void warpEventTeam(int warpTo) {\n+                rL.lock();\n+                try {\n+                        for (MapleCharacter chr : chars) {\n+                                chr.changeMap(warpTo);\n+                        }\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final MapleCharacter getLeader() {\n+                rL.lock();\n+                try {\n+                        for (MapleCharacter chr : chars) {\n+                                if(chr.isPartyLeader()) return chr;\n+                        }\n+                        \n+                        return null;\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final void showWrongEffect() {\n+                MapleMap map = getMapInstance(getLeader().getMapId());\n+                map.broadcastMessage(MaplePacketCreator.showEffect(\"quest/party/wrong_kor\"));\n+                map.broadcastMessage(MaplePacketCreator.playSound(\"Party1/Failed\"));\n+        }\n+        \n+        public final void showClearEffect() {\n+                showClearEffect(false);\n+        }\n+        \n+        public final void showClearEffect(boolean hasGate) {\n+                MapleMap map = getMapInstance(getLeader().getMapId());\n+                map.broadcastMessage(MaplePacketCreator.showEffect(\"quest/party/clear\"));\n+                map.broadcastMessage(MaplePacketCreator.playSound(\"Party1/Clear\"));\n+                if(hasGate) {\n+                        map.broadcastMessage(MaplePacketCreator.environmentChange(\"gate\", 2));\n+                        wL.lock();\n+                        try {\n+                                openedGates.add(map.getId());\n+                        } finally {\n+                                wL.unlock();\n+                        }\n+                }\n+        }\n+        \n+        public final void recoverOpenedGate(MapleCharacter chr, int thisMapId) {\n+                rL.lock();\n+                try {\n+                        if(openedGates.contains(thisMapId)) {\n+                                chr.announce(MaplePacketCreator.environmentChange(\"gate\", 2));\n+                        }\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final void linkToNextStage(int thisStage, String eventFamily, int thisMapId) {\n+                List<Integer> list = getClearStageBonus(thisStage);     // will give bonus exp & mesos to everyone in the event\n+                giveEventPlayersExp(list.get(0));\n+                giveEventPlayersMeso(list.get(1));\n             \n-            int mapId = chars.get(0).getMapId();\n-            for(int i = 1; i < chars.size(); i++) {\n-                if(chars.get(i).getMapId() != mapId) return false;\n-            }\n+                thisStage--;    //stages counts from ONE, scripts from ZERO\n             \n-            return true;\n+                MapleMap nextStage = getMapInstance(thisMapId);\n+                MaplePortal portal = nextStage.getPortal(\"next00\");\n+                if (portal != null) {\n+                        portal.setScriptName(eventFamily + thisStage);\n+                }\n         }\n         \n-        public final void warpEventTeam(int warpTo) {\n-            for (MapleCharacter chr : chars) {\n-                chr.changeMap(warpTo);\n-            }\n+        // registers a player status in an event\n+        public final void gridInsert(MapleCharacter chr, int newStatus) {\n+                wL.lock();\n+                try {\n+                        playerGrid.put(chr.getId(), newStatus);\n+                } finally {\n+                        wL.unlock();\n+                }\n+        }\n+        \n+        // unregisters a player status in an event\n+        public final void gridRemove(MapleCharacter chr) {\n+                wL.lock();\n+                try {\n+                        playerGrid.remove(chr.getId());\n+                } finally {\n+                        wL.unlock();\n+                }\n+        }\n+        \n+        // checks a player status\n+        public final int gridCheck(MapleCharacter chr) {\n+                rL.lock();\n+                try {\n+                        Integer i = playerGrid.get(chr.getId());\n+                        return (i != null) ? i : -1;\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public final void gridClear() {\n+                wL.lock();\n+                try {\n+                        playerGrid.clear();\n+                } finally {\n+                        wL.unlock();\n+                }\n         }\n }"}, {"sha": "9c571e61b8521db7ff10cb6613df9578570c92ae", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 33, "deletions": 5, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -154,56 +154,76 @@ public String getName() {\n     }\n \n     //Expedition method: starts an expedition\n-    public void startInstance(MapleExpedition exped) {\n+    public boolean startInstance(MapleExpedition exped) {\n         try {\n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n+            if(eim == null) return false;\n+            \n             eim.registerExpedition(exped);\n             exped.start();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n+        \n+        return true;\n     }\n \n     //Regular method: player \n-    public void startInstance(MapleCharacter chr) {\n+    public boolean startInstance(MapleCharacter chr) {\n         try {\n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n+            if(eim == null) return false;\n+            \n             eim.registerPlayer(chr);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n+        \n+        return true;\n     }    \n     \n     //PQ method: starts a PQ\n-    public void startInstance(MapleParty party, MapleMap map) {\n+    public boolean startInstance(MapleParty party, MapleMap map) {\n         try {\n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n+            if(eim == null) return false;\n+            \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n+        \n+        return true;\n     }\n     \n     //PQ method: starts a PQ with a difficulty level, requires function setup(difficulty, leaderid) instead of setup()\n-    public void startInstance(MapleParty party, MapleMap map, int difficulty) {\n+    public boolean startInstance(MapleParty party, MapleMap map, int difficulty) {\n         try {\n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, party.getLeader().getId()));\n+            if(eim == null) return false;\n+            \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n+        \n+        return true;\n     }\n \n     //non-PQ method for starting instance\n-    public void startInstance(EventInstanceManager eim, String leader) {\n+    public boolean startInstance(EventInstanceManager eim, String leader) {\n         try {\n+            if(eim == null) return false;\n+            \n             iv.invokeFunction(\"setup\", eim);\n             eim.setProperty(\"leader\", leader);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n+        \n+        return true;\n     }\n     \n     public List<MaplePartyCharacter> getEligibleParty(MapleParty party) {\n@@ -225,6 +245,14 @@ public void startInstance(EventInstanceManager eim, String leader) {\n         return(new ArrayList<>());\n     }\n     \n+    public void clearPQ(EventInstanceManager eim) {\n+        try {\n+            iv.invokeFunction(\"clearPQ\", eim);\n+        } catch (ScriptException | NoSuchMethodException ex) {\n+            Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n+        }\n+    }\n+    \n     public void clearPQ(EventInstanceManager eim, MapleMap toMap) {\n         try {\n             iv.invokeFunction(\"clearPQ\", eim, toMap);"}, {"sha": "b627ab138f2f1ac7024670085a08bcbbc2e75abd", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -227,7 +227,7 @@ public void gainMeso(int gain) {\n \t\tif (gain > 0 && ServerConstants.USE_AUTOBAN == true) {\n \t\t\tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" gained \" + gain + \" mesos from NPC \" + npc + \"\\r\\n\");\n \t\t}\n-\t\tgetPlayer().gainMeso(gain, true, false, true);\n+\t\tgetPlayer().gainMeso(gain);\n \t}\n \n \tpublic void gainExp(int gain) {"}, {"sha": "7fa1e2021d786ab527d30aa895a9c0e06b33ec93", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 59, "deletions": 25, "changes": 84, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -90,8 +90,8 @@ private MapleQuest(int id) {\n \t\t\t\t\n                 MapleQuestRequirement req = this.getRequirement(type, startReq);\n \t\t\t\t\n-\t\t\t\tif(req == null)\n-\t\t\t\t\tcontinue;\n+                if(req == null)\n+                        continue;\n \t\t\t\t\n                 if (type.equals(MapleQuestRequirementType.MOB)) {\n                     for (MapleData mob : startReq.getChildren()) {\n@@ -161,22 +161,56 @@ public boolean isAutoStart() {\n     public static MapleQuest getInstance(int id) {\n         MapleQuest ret = quests.get(id);\n         if (ret == null) {\n-\t\t\tquestInfo = questData.getData(\"QuestInfo.img\");\n-\t\t\tquestReq = questData.getData(\"Check.img\");\n-\t\t\tquestAct = questData.getData(\"Act.img\");\n+            questInfo = questData.getData(\"QuestInfo.img\");\n+            questReq = questData.getData(\"Check.img\");\n+            questAct = questData.getData(\"Act.img\");\n \t\t\t\n             ret = new MapleQuest(id);\n             quests.put(id, ret);\n         }\n         return ret;\n     }\n+    \n+    private String getIntervalTimeLeft(MapleCharacter c, IntervalRequirement r) {\n+        StringBuilder str = new StringBuilder();\n+        \n+        long futureTime = c.getQuest(MapleQuest.getInstance(getId())).getCompletionTime() + r.getInterval();\n+        long leftTime = futureTime - System.currentTimeMillis();\n+        \n+        byte mode = 0;\n+        if(leftTime / (60*1000) > 0) {\n+            mode++;     //counts minutes\n+            \n+            if(leftTime / (60*60*1000) > 0)\n+                mode++;     //counts hours\n+        }\n+        \n+        switch(mode) {\n+            case 2:\n+                int hours   = (int) ((leftTime / (1000*60*60)));\n+                str.append(hours + \" hours, \");\n+                \n+            case 1:\n+                int minutes = (int) ((leftTime / (1000*60)) % 60);\n+                str.append(minutes + \" minutes, \");\n+                \n+            default:\n+                int seconds = (int) (leftTime / 1000) % 60 ;\n+                str.append(seconds + \" seconds\");\n+        }\n+        \n+        return str.toString();\n+    }\n \n     public boolean canStart(MapleCharacter c, int npcid) {\n         if (c.getQuest(this).getStatus() != Status.NOT_STARTED && !(c.getQuest(this).getStatus() == Status.COMPLETED && repeatable)) {\n             return false;\n         }\n         for (MapleQuestRequirement r : startReqs.values()) {\n             if (!r.check(c, npcid)) {\n+                if(r.getType().getType() == MapleQuestRequirementType.INTERVAL.getType()) {\n+                    c.message(\"This quest will become available again in approximately \" + getIntervalTimeLeft(c, (IntervalRequirement)r) + \".\");\n+                }\n                 return false;\n             }\n         }\n@@ -198,9 +232,9 @@ public boolean canComplete(MapleCharacter c, Integer npcid) {\n     public void start(MapleCharacter c, int npc) {\n         if (autoStart || canStart(c, npc)) {\n             for (MapleQuestAction a : startActs.values()) {\n-\t\t\t\tif (!a.check(c, null)) { // would null be good ?\n-\t\t\t\t\treturn;\n-\t\t\t\t}\n+                if (!a.check(c, null)) { // would null be good ?\n+                        return;\n+                }\n                 a.run(c, null);\n             }\n             forceStart(c, npc);\n@@ -212,20 +246,20 @@ public void complete(MapleCharacter c, int npc) {\n     }\n \n     public void complete(MapleCharacter c, int npc, Integer selection) {\n-\t\tif (autoPreComplete || canComplete(c, npc)) {\n-\t\t   for (MapleQuestAction a : completeActs.values()) {\n-\t\t\t  if (!a.check(c, selection)) {\n-\t\t\t \t return;\n-\t\t\t  }\n-\t\t    }\n-\t\t    forceComplete(c, npc);\n-\t\t    for (MapleQuestAction a : completeActs.values()) {\n-\t\t        a.run(c, selection);\n-\t\t    }\n-                    \n-                    c.getClient().getSession().write(MaplePacketCreator.showSpecialEffect(9)); // Quest completion\n-                    c.getMap().broadcastMessage(c, MaplePacketCreator.showForeignEffect(c.getId(), 9), false); //use 9 instead of 12 for both\n-\t\t}\n+        if (autoPreComplete || canComplete(c, npc)) {\n+           for (MapleQuestAction a : completeActs.values()) {\n+                  if (!a.check(c, selection)) {\n+                         return;\n+                  }\n+            }\n+            forceComplete(c, npc);\n+            for (MapleQuestAction a : completeActs.values()) {\n+                a.run(c, selection);\n+            }\n+\n+            c.getClient().getSession().write(MaplePacketCreator.showSpecialEffect(9)); // Quest completion\n+            c.getMap().broadcastMessage(c, MaplePacketCreator.showForeignEffect(c.getId(), 9), false); //use 9 instead of 12 for both\n+        }\n     }\n \n     public void reset(MapleCharacter c) {\n@@ -314,9 +348,9 @@ public String getInfoEx() {\n \t\treturn ret;\n     }\n \n-    public int getTimeLimit() {\n-        return timeLimit;\n-    }\n+        public int getTimeLimit() {\n+                return timeLimit;\n+        }\n \t\n \tpublic static void clearCache(int quest) {\n \t\tif(quests.containsKey(quest)){"}, {"sha": "76d0645a25a21704cfbfe258f6c8a2037052e6b5", "filename": "src/server/quest/requirements/IntervalRequirement.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/requirements/IntervalRequirement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/requirements/IntervalRequirement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/requirements/IntervalRequirement.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -42,6 +42,9 @@ public IntervalRequirement(MapleQuest quest, MapleData data) {\n \t\tquestID = quest.getId();\n \t}\n \t\n+        public int getInterval() {\n+                return interval;\n+        }\n \t\n \t@Override\n \tpublic void processData(MapleData data) {"}, {"sha": "908544ad899775a925a689e18e37562ead9cd384", "filename": "src/server/quest/requirements/MapleQuestRequirement.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/requirements/MapleQuestRequirement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/server/quest/requirements/MapleQuestRequirement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/requirements/MapleQuestRequirement.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -51,6 +51,6 @@ public MapleQuestRequirement(MapleQuestRequirementType type) {\n \tpublic abstract void processData(MapleData data);\n \t\n \tpublic MapleQuestRequirementType getType() {\n-        return type;\n-    }\n+            return type;\n+        }\n }\n\\ No newline at end of file"}, {"sha": "b8c6f19fba08d9d927c3a435d205654b3c865a7a", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/da00345aec775bb2a58ef8b9757b89d21e938044/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/da00345aec775bb2a58ef8b9757b89d21e938044/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=da00345aec775bb2a58ef8b9757b89d21e938044", "patch": "@@ -2508,6 +2508,7 @@ private static int doubleToShortBits(double d) {\n          * @param progress\n          * @return\n          */\n+        \n         public static byte[] updateQuestInfo(short quest, int npc) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.UPDATE_QUEST_INFO.getValue());"}]}]},
