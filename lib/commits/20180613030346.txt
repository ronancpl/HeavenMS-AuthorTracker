{"fetchDate": "2019-12-19", "content": [{"sha": "dddfdcf315ed69d3c599b4658bb0f0e72865d118", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZGRkZmRjZjMxNWVkNjlkM2M1OTliNDY1OGJiMGYwZTcyODY1ZDExOA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-06-13T03:03:46Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-06-13T03:03:46Z"}, "message": "Enhanced map bounds + HolidayPQ + Battleship\n\nFixed Abdula not showing book info for Arans.\nFixed map bounds, now it hopefully doesn't let items pass through the walkable area anymore.\nImplemented HolidayPQ.\nAdded a custom item sandbox system, to be used with items generated by the \"drop\" command.\nAdded the whole-map buff when using the Happy Birthday item.\nFixed several battleship issues:\n - Battleship now shows HP properly at the buff icon.\n - Cleared some inconsistencies on battleship when interacting with the enhanced buff system.\n - Battleship now hands out defensive buffs properly.", "tree": {"sha": "24a3742e1a600ebef1d3fdd6413b7b2f51f7563b", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/24a3742e1a600ebef1d3fdd6413b7b2f51f7563b"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/dddfdcf315ed69d3c599b4658bb0f0e72865d118", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/dddfdcf315ed69d3c599b4658bb0f0e72865d118", "html_url": "https://github.com/ronancpl/HeavenMS/commit/dddfdcf315ed69d3c599b4658bb0f0e72865d118", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/dddfdcf315ed69d3c599b4658bb0f0e72865d118/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b8d3a0b2b09938713c283eb626c92cdd424de63", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0b8d3a0b2b09938713c283eb626c92cdd424de63", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0b8d3a0b2b09938713c283eb626c92cdd424de63"}], "stats": {"total": 6890, "additions": 4294, "deletions": 2596}, "files": [{"sha": "b081593974554ae917885ea37ce3c46f84fcb65f", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -9,7 +9,7 @@ Regarding distributability and usage of the code presented here: like it was bef\n \n This is a NetBeans 8.0.2 Project, that MUST be built and run under JDK/JRE 7 in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n \n-In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of private server, in order to perceive it at it's full potential. My opinion, though! Refer to \"README_wzchanges.txt\" for more information on what has been changed from Nexon's v83 WZ files.\n+In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of server source, in order to perceive it at it's full potential. My opinion, though! Refer to \"README_wzchanges.txt\" for more information on what has been changed from Nexon's v83 WZ files.\n \n The main objective of this project is to try as best as possible to recreate what once was the original MapleStory v83, while adding up some flavors that spices up the gameplay. In other words, aim to get the best of the MapleStory of that era.\n \n@@ -71,7 +71,7 @@ Paypal: https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=3K8\n \n * HeavenMS staff has __no current intention__ to publicly open a server with this source, if that ever comes to happen this note will be lifted. __Don't be scammed!__\n \n-* This server source is __NOT intended to be stable__ as is. Proper deadlock review and other maintenance checks are needed in order to make it stable for production use.\n+* This server source is __NOT intended to be stable__ as is. Proper deadlock review and other maintenance checks are needed in order to make it suitable for production use.\n \n ---\n ### Preparing the ambient "}, {"sha": "9354192e895b57cc33a40ef5218b6d681e09ef13", "filename": "docs/feature_list.md", "status": "modified", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -22,7 +22,7 @@ Feature list:\n \n PQs:\n \n-* HPQ/KPQ/LPQ/LMPQ/OPQ/EllinPQ/PiratePQ/MagatiaPQ/HorntailPQ/AmoriaPQ/TreasurePQ/ElnathPQ.\n+* HPQ/KPQ/LPQ/LMPQ/OPQ/EllinPQ/PiratePQ/MagatiaPQ/HorntailPQ/AmoriaPQ/TreasurePQ/ElnathPQ/HolidayPQ.\n * CWKPQ as Expedition-based event.\n * Expeditions: Scarga/Horntail/Showa/Balrog/Zakum/Pinkbean.\n * GuildPQ + Guild queue with multi-lobby systems available.\n@@ -34,8 +34,10 @@ Skills:\n \n * Some skills behaving oddly have been patched, such as Steal, Venomous Star/Stab and Mystic Doors.\n * Maker skill features properly developed.\n+* Improved current Battleship skill, now showing the HP properly on buff tab and making visible for others after changing maps.\n * Server is using heuristics to calculate fee costs for the Maker (errors sums up to 8k mesos, reagent errors stacks up comformant with it's level).\n * New skill: Chair Mastery (max lv 1) - Players having this passive skill can gain a significant boost of HP/MP recovery when sitting on a field/map chair.\n+* Mu Lung Dojo skills functional.\n \n Quests:\n \n@@ -71,6 +73,7 @@ Cash & Items:\n * New scroll: antibanish. For use only in cases where bosses send a player back to town.\n * Inventory system properly checks for item slot free space and ownership.\n * Storage with \"Arrange Items\" feature functional.\n+* Close-quarters evaluation mode for items (sandbox).\n * Spikes on shoes.\n * Vega's spell.\n * Owl of Minerva.\n@@ -87,6 +90,7 @@ Monsters, Maps & Reactors:\n * Monsterbook displays drop data info conformant with the underlying DB (needs custom wz). See more on the MobBookUpdate feature.\n * Every skill/mastery book is now droppable by mobs.\n * Mobs now can drop more than one of the same equipment (number of possible drops defined at droptime, uses the minimum/maximum quantity fields on DB).\n+* Redesigned HT mechanics for spawn and linked damage to the sponge.\n * Improved map bounding checks for item drop points, assuring most of the items dropped will be available to pickup inside the accessible map area.\n * Limited item count on maps, smartly expiring oldest registered items, preventing potential item flooding.\n * Implemented Zombify disease status.\n@@ -95,6 +99,7 @@ Monsters, Maps & Reactors:\n * Boats, elevator and other travelling mechanics fully working.\n * HP decreasing overtime on maps and mechanics to prevent them (consumables, equips) fully functional.\n * Crimson Balrog boat approaching visual effect made functional.\n+* Maps having everlasting items no longer expires them.\n * PQs, Taxis and other event-driven situations warps players at random spawnpoints, GMS-like.\n * Some reactors (PQ bonus boxes) spraying items on the map, instead of dropping everything at once.\n * Reactors pick items up smartly, checking for an option to pick up on many-items-nearby scenario.\n@@ -116,6 +121,7 @@ Player potentials:\n * Player level rates.\n * Gain fame by quests.\n * Pet evolutions functional (not GMS-like).\n+* Reviewed keybinding system.\n \n Server potentials:\n \n@@ -141,6 +147,14 @@ Server potentials:\n * Accounts can be created automatically when trying to login on an inexistent account -- credits to shavit.\n * Usage of Bcrypt (up-to-date) as the main password hashing algorithm, replacing old SHA's -- credits to shavit.\n \n+Custom NPCs:\n+\n+* Spiegelmann: automatized rock-refiner.\n+* Abdula: lists droppers of needed skill/mastery books.\n+* Agent E: accessory crafter.\n+* Donation Box: automatized item-buyer.\n+* Coco & Ace of Hearts: C. scroll crafters.\n+\n Admin/GM commands:\n \n * Server commands layered by GM levels.\n@@ -175,6 +189,7 @@ Project:\n * Fixed/added some missing packets for MoveEnvironment, summons and others.\n * Uncovered many Send/Recv opcodes throughout the source.\n * Reviewed many Java object aspects that needed concurrency protection.\n+* Reviewed SQL data, eliminating duplicated entries on the tables.\n * Usage of HikariCP to improve the DB connection management.\n * Protected many flaws with login management system.\n * Heavily reviewed future task management inside the project. Way less trivial schedules are spawned now, relieving task overload on the TimerManager.\n@@ -199,11 +214,4 @@ Localhost:\n * Removed the AP assign block for novices.\n * Removed a block that would show up when trying to apply an attack gem on equipments that aren't weapons.\n \n-Custom NPCs:\n-\n-* Agent E: Accessory crafter.\n-* Donation Box: Instant-sell NPC.\n-* Ace of Hearts & Coco: C. scroll crafter.\n-* Spiegelmann: Instant-ore refiner NPC.\n-\n ---------------------------\n\\ No newline at end of file"}, {"sha": "86ca538bf41ecee797f0360195151436ac4236ce", "filename": "docs/issues.txt", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -11,6 +11,7 @@ Known issues:\n - Some criticals (e.g. from Aran skills) will not show up as crit for other players.\n - Deadlocks may start appearing if the server stays online long enough with many players logged in.\n - If there are multiple bosses that shows HPBar on the map, if a player hits more than one the HPBar may start flickering on the screen.\n+- Sometimes battleship may behave oddly with the enhanced buff system, making the character d/c in certain scenarios.\n ---------------------------\n \n ---------------------------"}, {"sha": "9200ba06ea3b3ab88cfe2460ec7e24dfb5fb6a63", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -2,6 +2,8 @@\n \tSpiegelmann -> 2042000\n \tCoco -> 9000017\n \tAgent E -> 9000036\n+\tDonation Box -> 9000041\n+\tAbdula -> 9209000\n \n CUSTOM NPC SHOPS:\n \tSpindle -> 9201082\n@@ -1025,4 +1027,16 @@ Adicionado comportamento de substitui\u00e7\u00e3o de itens ao expirar, cortesia do Gabr\n Corrigido ponteiro nulo ao tentar usar return scroll em mapas como Mu Lung.\n Corrigido um cr\u00edtico problema de deadlock com o MaplePacketEncoder.\n Corrigido um cr\u00edtico problema de vazamento de dados na DB referente ao quest status.\n-4th job Aran agora usa script de evento, evitando m\u00faltiplos jogadores lutando contra m\u00faltiplas Mahas.\n\\ No newline at end of file\n+4th job Aran agora usa script de evento, evitando m\u00faltiplos jogadores lutando contra m\u00faltiplas Mahas.\n+\n+08 - 10 Junho 2018,\n+Corrigido Abdula n\u00e3o mostrando skill/mastery books para Aran.\n+Corrigido fronteiras de mapa n\u00e3o mais deixando passar itens para fora do campo.\n+Corrigido battleship n\u00e3o mostrando HP corretamente.\n+Corrigido battleship n\u00e3o atuando corretamente com o sistema de buffs, deixando jogadores sem poder ativar a skill em certos casos.\n+Corrigido battleship n\u00e3o dando buffs na defesa corretamente.\n+\n+11 - 12 Junho 2018,\n+Adicionado efeito do us\u00e1vel Happy Birthday pra todos no mapa.\n+Implementado HolidayPQ.\n+Adicionado sistema de sandbox para itens.\n\\ No newline at end of file"}, {"sha": "62641dcb868a6d2d7b582d41e559a598bbf46d1e", "filename": "scripts/event/HolidayPQ_1.js", "status": "added", "additions": 356, "deletions": 0, "changes": 356, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HolidayPQ_1.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,356 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/**\n+ * @author: Ronan\n+ * @event: Holiday PQ\n+*/\n+\n+// GMS-like event string data thanks to iHealForLove\n+\n+importPackage(Packages.client.inventory);\n+importPackage(Packages.server.life);\n+\n+var isPq = true;\n+var minPlayers = 3, maxPlayers = 6;\n+var minLevel = 21, maxLevel = 30;\n+var entryMap = 889100001;\n+var exitMap = 889100002;\n+var recruitMap = 889100000;\n+var clearMap = 889100002;\n+\n+var minMapId = 889100001;\n+var maxMapId = 889100001;\n+\n+var eventTime = 15;     // 15 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [4032094, 4032095];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n+\n+        evLevel = 3;    //Rewards at Hard difficulty\n+        itemSet = [1302080, 1002033, 2022153, 2022042, 2020006, 2020009, 2020016, 2020024, 4010006, 4010007, 4020004, 4020005, 4003002];\n+        itemQty = [1, 1, 1, 5, 20, 15, 10, 10, 2, 4, 4, 4, 1];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 2;    //Rewards at Normal difficulty\n+        itemSet = [1302080, 1002033, 2012005, 2012006, 2020002, 2020025, 2020026, 4010003, 4010004, 4010005, 4020002, 4020003, 4020007];\n+        itemQty = [1, 1, 15, 15, 15, 10, 10, 3, 3, 3, 3, 3, 3];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 1;    //Rewards at Easy difficulty\n+        itemSet = [1002033, 2012005, 2012006, 2020002, 2022006, 2022002, 4010000, 4010001, 4010002, 4020000, 4020001, 4020006];\n+        itemQty = [1, 15, 15, 10, 5, 5, 2, 2, 2, 2, 2, 2];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [210, 620, 500, 1400, 950, 2200];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Holiday1_\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"stage\", \"0\");\n+        eim.setProperty(\"statusStg1\", \"-1\");\n+        eim.setProperty(\"missingDrops\", \"0\");\n+        eim.setProperty(\"snowmanLevel\", \"0\");\n+        eim.setProperty(\"snowmanStep\", \"0\");\n+        eim.setProperty(\"spawnedBoss\", \"0\");\n+        \n+        var mapobj = eim.getInstanceMap(entryMap);\n+        mapobj.resetPQ(level);\n+        mapobj.allowSummonState(false);\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {\n+        eim.getInstanceMap(entryMap).instanceMapRespawn();\n+        eim.schedule(\"respawnStages\", 10 * 1000);\n+}\n+\n+function snowmanHeal(eim) {\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = eim.getInstanceMap(entryMap).getMonsterById(9400316 + (5 * difficulty) + 5);\n+        \n+        snowman.heal(200 + 200 * difficulty, 0);\n+        eim.schedule(\"snowmanHeal\", 10 * 1000);\n+}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                end(eim);\n+        }\n+        else\n+                playerLeft(eim, player);\n+}\n+\n+function disbandParty(eim) {\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n+}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isScrooge(mob) {\n+        var mobid = mob.getId();\n+        return mobid >= 9400319 && mobid <= 9400321;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        try {\n+                if(eim.isEventCleared()) return;\n+                else if(isScrooge(mob)) {\n+                        eim.giveEventPlayersStageReward(2 * eim.getIntProperty(\"level\"));\n+                        eim.showClearEffect();\n+                        eim.clearPQ();\n+                        return;\n+                }\n+\n+                var rnd = Math.random();\n+                var forceDrop = false;\n+                if(rnd >= 0.42) {   // 42% chance of dropping token\n+                        var miss = eim.getIntProperty(\"missingDrops\");\n+                        if(miss < 5) {\n+                                eim.setIntProperty(\"missingDrops\", miss + 1);\n+                                return;\n+                        }\n+                        \n+                        forceDrop = true;\n+                }\n+                \n+                var mapObj = mob.getMap();\n+                var itemObj = new Item((forceDrop || Math.random() < 0.77) ? 4032094 : 4032095, 0, 1);   // 77% chance of not fake\n+                var dropper = eim.getPlayers().get(0);\n+\n+                mapObj.spawnItemDrop(mob, dropper, itemObj, mob.getPosition(), true, false);\n+                eim.setIntProperty(\"missingDrops\", 0);\n+        } catch(err) {} // PQ not started yet\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function friendlyKilled(mob, eim) {\n+        eim.setIntProperty(\"snowmanStep\", 0);\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(snowmanLevel <= 1) {\n+                end(eim);\n+        } else {\n+                eim.setIntProperty(\"snowmanLevel\", snowmanLevel - 1);\n+        }\n+}\n+\n+function snowmanEvolve(eim, curLevel) {\n+        var mapobj = eim.getInstanceMap(entryMap);\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = mapobj.getMonsterById(9400317 + (5 * difficulty) + (curLevel - 1));\n+    \n+        eim.setIntProperty(\"snowmanLevel\", curLevel + 2);   // increment by 2 to decrement by 1 on friendlyKilled\n+        mapobj.killMonster(snowman, null, false, 2);\n+        \n+        var snowman = MapleLifeFactory.getMonster(9400317 + (5 * difficulty) + curLevel);\n+        mapobj.spawnMonsterOnGroundBelow(snowman, new java.awt.Point(-180, 15));\n+        \n+        if(curLevel >= 4) {\n+                mapobj.allowSummonState(false);\n+                mapobj.killAllMonstersNotFriendly();\n+                mapobj.setReactorState();\n+                \n+                eim.giveEventPlayersStageReward(2 * difficulty - 1);\n+                eim.showClearEffect();\n+        }\n+}\n+\n+function snowmanSnack(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(step >= 2 + (eim.getIntProperty(\"level\") * snowmanLevel)) {\n+                step = 0;\n+                snowmanEvolve(eim, snowmanLevel);\n+        } else {\n+                var mapobj = eim.getInstanceMap(entryMap);\n+                var difficulty = eim.getIntProperty(\"level\");\n+                var snowman = mapobj.getMonsterById(9400316 + (5 * difficulty) + snowmanLevel);\n+                \n+                snowman.heal(200 + (200 * snowmanLevel), 0);\n+                step += 1;\n+        }\n+        \n+        eim.setIntProperty(\"snowmanStep\", step);\n+}\n+\n+function snowmanSnackFake(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        if(step > 0) {\n+                eim.setIntProperty(\"snowmanStep\", step - 1);\n+        }\n+        \n+        eim.dropMessage(5, \"The snowman absorbed a Fake Snow Vigor!\");\n+}\n+\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "24ba28a198a156dbbfe2f9e4aa1a6ef0a871135c", "filename": "scripts/event/HolidayPQ_2.js", "status": "added", "additions": 356, "deletions": 0, "changes": 356, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HolidayPQ_2.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,356 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/**\n+ * @author: Ronan\n+ * @event: Holiday PQ\n+*/\n+\n+// GMS-like event string data thanks to iHealForLove\n+\n+importPackage(Packages.client.inventory);\n+importPackage(Packages.server.life);\n+\n+var isPq = true;\n+var minPlayers = 3, maxPlayers = 6;\n+var minLevel = 31, maxLevel = 40;\n+var entryMap = 889100011;\n+var exitMap = 889100012;\n+var recruitMap = 889100010;\n+var clearMap = 889100012;\n+\n+var minMapId = 889100011;\n+var maxMapId = 889100011;\n+\n+var eventTime = 20;     // 20 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [4032094, 4032095];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n+\n+        evLevel = 3;    //Rewards at Hard difficulty\n+        itemSet = [1302080, 1002033, 2022153, 2022042, 2020006, 2020009, 2020016, 2020024, 4010006, 4010007, 4020004, 4020005, 4003002];\n+        itemQty = [1, 1, 1, 5, 20, 15, 10, 10, 2, 4, 4, 4, 1];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 2;    //Rewards at Normal difficulty\n+        itemSet = [1302080, 1002033, 2012005, 2012006, 2020002, 2020025, 2020026, 4010003, 4010004, 4010005, 4020002, 4020003, 4020007];\n+        itemQty = [1, 1, 15, 15, 15, 10, 10, 3, 3, 3, 3, 3, 3];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 1;    //Rewards at Easy difficulty\n+        itemSet = [1002033, 2012005, 2012006, 2020002, 2022006, 2022002, 4010000, 4010001, 4010002, 4020000, 4020001, 4020006];\n+        itemQty = [1, 15, 15, 10, 5, 5, 2, 2, 2, 2, 2, 2];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [210, 620, 500, 1400, 950, 2200];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Holiday2_\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"stage\", \"0\");\n+        eim.setProperty(\"statusStg1\", \"-1\");\n+        eim.setProperty(\"missingDrops\", \"0\");\n+        eim.setProperty(\"snowmanLevel\", \"0\");\n+        eim.setProperty(\"snowmanStep\", \"0\");\n+        eim.setProperty(\"spawnedBoss\", \"0\");\n+        \n+        var mapobj = eim.getInstanceMap(entryMap);\n+        mapobj.resetPQ(level);\n+        mapobj.allowSummonState(false);\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {\n+        eim.getInstanceMap(entryMap).instanceMapRespawn();\n+        eim.schedule(\"respawnStages\", 10 * 1000);\n+}\n+\n+function snowmanHeal(eim) {\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = eim.getInstanceMap(entryMap).getMonsterById(9400316 + (5 * difficulty) + 5);\n+        \n+        snowman.heal(200 + 200 * difficulty, 0);\n+        eim.schedule(\"snowmanHeal\", 10 * 1000);\n+}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                end(eim);\n+        }\n+        else\n+                playerLeft(eim, player);\n+}\n+\n+function disbandParty(eim) {\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n+}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isScrooge(mob) {\n+        var mobid = mob.getId();\n+        return mobid >= 9400319 && mobid <= 9400321;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        try {\n+                if(eim.isEventCleared()) return;\n+                else if(isScrooge(mob)) {\n+                        eim.giveEventPlayersStageReward(2 * eim.getIntProperty(\"level\"));\n+                        eim.showClearEffect();\n+                        eim.clearPQ();\n+                        return;\n+                }\n+\n+                var rnd = Math.random();\n+                var forceDrop = false;\n+                if(rnd >= 0.42) {   // 42% chance of dropping token\n+                        var miss = eim.getIntProperty(\"missingDrops\");\n+                        if(miss < 5) {\n+                                eim.setIntProperty(\"missingDrops\", miss + 1);\n+                                return;\n+                        }\n+                        \n+                        forceDrop = true;\n+                }\n+                \n+                var mapObj = mob.getMap();\n+                var itemObj = new Item((forceDrop || Math.random() < 0.77) ? 4032094 : 4032095, 0, 1);   // 77% chance of not fake\n+                var dropper = eim.getPlayers().get(0);\n+\n+                mapObj.spawnItemDrop(mob, dropper, itemObj, mob.getPosition(), true, false);\n+                eim.setIntProperty(\"missingDrops\", 0);\n+        } catch(err) {} // PQ not started yet\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function friendlyKilled(mob, eim) {\n+        eim.setIntProperty(\"snowmanStep\", 0);\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(snowmanLevel <= 1) {\n+                end(eim);\n+        } else {\n+                eim.setIntProperty(\"snowmanLevel\", snowmanLevel - 1);\n+        }\n+}\n+\n+function snowmanEvolve(eim, curLevel) {\n+        var mapobj = eim.getInstanceMap(entryMap);\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = mapobj.getMonsterById(9400317 + (5 * difficulty) + (curLevel - 1));\n+    \n+        eim.setIntProperty(\"snowmanLevel\", curLevel + 2);   // increment by 2 to decrement by 1 on friendlyKilled\n+        mapobj.killMonster(snowman, null, false, 2);\n+        \n+        var snowman = MapleLifeFactory.getMonster(9400317 + (5 * difficulty) + curLevel);\n+        mapobj.spawnMonsterOnGroundBelow(snowman, new java.awt.Point(-180, 15));\n+        \n+        if(curLevel >= 4) {\n+                mapobj.allowSummonState(false);\n+                mapobj.killAllMonstersNotFriendly();\n+                mapobj.setReactorState();\n+                \n+                eim.giveEventPlayersStageReward(2 * difficulty - 1);\n+                eim.showClearEffect();\n+        }\n+}\n+\n+function snowmanSnack(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(step >= 2 + (eim.getIntProperty(\"level\") * snowmanLevel)) {\n+                step = 0;\n+                snowmanEvolve(eim, snowmanLevel);\n+        } else {\n+                var mapobj = eim.getInstanceMap(entryMap);\n+                var difficulty = eim.getIntProperty(\"level\");\n+                var snowman = mapobj.getMonsterById(9400316 + (5 * difficulty) + snowmanLevel);\n+                \n+                snowman.heal(200 + (200 * snowmanLevel), 0);\n+                step += 1;\n+        }\n+        \n+        eim.setIntProperty(\"snowmanStep\", step);\n+}\n+\n+function snowmanSnackFake(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        if(step > 0) {\n+                eim.setIntProperty(\"snowmanStep\", step - 1);\n+        }\n+        \n+        eim.dropMessage(5, \"The snowman absorbed a Fake Snow Vigor!\");\n+}\n+\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "5dbcfe4481319195e9271e3d35068dfee40ea43e", "filename": "scripts/event/HolidayPQ_3.js", "status": "added", "additions": 356, "deletions": 0, "changes": 356, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_3.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/event/HolidayPQ_3.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HolidayPQ_3.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,356 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/**\n+ * @author: Ronan\n+ * @event: Holiday PQ\n+*/\n+\n+// GMS-like event string data thanks to iHealForLove\n+\n+importPackage(Packages.client.inventory);\n+importPackage(Packages.server.life);\n+\n+var isPq = true;\n+var minPlayers = 3, maxPlayers = 6;\n+var minLevel = 41, maxLevel = 50;\n+var entryMap = 889100021;\n+var exitMap = 889100022;\n+var recruitMap = 889100020;\n+var clearMap = 889100022;\n+\n+var minMapId = 889100021;\n+var maxMapId = 889100021;\n+\n+var eventTime = 25;     // 25 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [4032094, 4032095];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n+\n+        evLevel = 3;    //Rewards at Hard difficulty\n+        itemSet = [1302080, 1002033, 2022153, 2022042, 2020006, 2020009, 2020016, 2020024, 4010006, 4010007, 4020004, 4020005, 4003002];\n+        itemQty = [1, 1, 1, 5, 20, 15, 10, 10, 2, 4, 4, 4, 1];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 2;    //Rewards at Normal difficulty\n+        itemSet = [1302080, 1002033, 2012005, 2012006, 2020002, 2020025, 2020026, 4010003, 4010004, 4010005, 4020002, 4020003, 4020007];\n+        itemQty = [1, 1, 15, 15, 15, 10, 10, 3, 3, 3, 3, 3, 3];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        evLevel = 1;    //Rewards at Easy difficulty\n+        itemSet = [1002033, 2012005, 2012006, 2020002, 2022006, 2022002, 4010000, 4010001, 4010002, 4020000, 4020001, 4020006];\n+        itemQty = [1, 15, 15, 10, 5, 5, 2, 2, 2, 2, 2, 2];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [210, 620, 500, 1400, 950, 2200];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Holiday3_\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"stage\", \"0\");\n+        eim.setProperty(\"statusStg1\", \"-1\");\n+        eim.setProperty(\"missingDrops\", \"0\");\n+        eim.setProperty(\"snowmanLevel\", \"0\");\n+        eim.setProperty(\"snowmanStep\", \"0\");\n+        eim.setProperty(\"spawnedBoss\", \"0\");\n+        \n+        var mapobj = eim.getInstanceMap(entryMap);\n+        mapobj.resetPQ(level);\n+        mapobj.allowSummonState(false);\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {\n+        eim.getInstanceMap(entryMap).instanceMapRespawn();\n+        eim.schedule(\"respawnStages\", 10 * 1000);\n+}\n+\n+function snowmanHeal(eim) {\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = eim.getInstanceMap(entryMap).getMonsterById(9400316 + (5 * difficulty) + 5);\n+        \n+        snowman.heal(200 + 200 * difficulty, 0);\n+        eim.schedule(\"snowmanHeal\", 10 * 1000);\n+}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                end(eim);\n+        }\n+        else\n+                playerLeft(eim, player);\n+}\n+\n+function disbandParty(eim) {\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n+}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isScrooge(mob) {\n+        var mobid = mob.getId();\n+        return mobid >= 9400319 && mobid <= 9400321;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        try {\n+                if(eim.isEventCleared()) return;\n+                else if(isScrooge(mob)) {\n+                        eim.giveEventPlayersStageReward(2 * eim.getIntProperty(\"level\"));\n+                        eim.showClearEffect();\n+                        eim.clearPQ();\n+                        return;\n+                }\n+\n+                var rnd = Math.random();\n+                var forceDrop = false;\n+                if(rnd >= 0.42) {   // 42% chance of dropping token\n+                        var miss = eim.getIntProperty(\"missingDrops\");\n+                        if(miss < 5) {\n+                                eim.setIntProperty(\"missingDrops\", miss + 1);\n+                                return;\n+                        }\n+                        \n+                        forceDrop = true;\n+                }\n+                \n+                var mapObj = mob.getMap();\n+                var itemObj = new Item((forceDrop || Math.random() < 0.77) ? 4032094 : 4032095, 0, 1);   // 77% chance of not fake\n+                var dropper = eim.getPlayers().get(0);\n+\n+                mapObj.spawnItemDrop(mob, dropper, itemObj, mob.getPosition(), true, false);\n+                eim.setIntProperty(\"missingDrops\", 0);\n+        } catch(err) {} // PQ not started yet\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function friendlyKilled(mob, eim) {\n+        eim.setIntProperty(\"snowmanStep\", 0);\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(snowmanLevel <= 1) {\n+                end(eim);\n+        } else {\n+                eim.setIntProperty(\"snowmanLevel\", snowmanLevel - 1);\n+        }\n+}\n+\n+function snowmanEvolve(eim, curLevel) {\n+        var mapobj = eim.getInstanceMap(entryMap);\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var snowman = mapobj.getMonsterById(9400317 + (5 * difficulty) + (curLevel - 1));\n+    \n+        eim.setIntProperty(\"snowmanLevel\", curLevel + 2);   // increment by 2 to decrement by 1 on friendlyKilled\n+        mapobj.killMonster(snowman, null, false, 2);\n+        \n+        var snowman = MapleLifeFactory.getMonster(9400317 + (5 * difficulty) + curLevel);\n+        mapobj.spawnMonsterOnGroundBelow(snowman, new java.awt.Point(-180, 15));\n+        \n+        if(curLevel >= 4) {\n+                mapobj.allowSummonState(false);\n+                mapobj.killAllMonstersNotFriendly();\n+                mapobj.setReactorState();\n+                \n+                eim.giveEventPlayersStageReward(2 * difficulty - 1);\n+                eim.showClearEffect();\n+        }\n+}\n+\n+function snowmanSnack(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        var snowmanLevel = eim.getIntProperty(\"snowmanLevel\");\n+        \n+        if(step >= 2 + (eim.getIntProperty(\"level\") * snowmanLevel)) {\n+                step = 0;\n+                snowmanEvolve(eim, snowmanLevel);\n+        } else {\n+                var mapobj = eim.getInstanceMap(entryMap);\n+                var difficulty = eim.getIntProperty(\"level\");\n+                var snowman = mapobj.getMonsterById(9400316 + (5 * difficulty) + snowmanLevel);\n+                \n+                snowman.heal(200 + (200 * snowmanLevel), 0);\n+                step += 1;\n+        }\n+        \n+        eim.setIntProperty(\"snowmanStep\", step);\n+}\n+\n+function snowmanSnackFake(eim) {\n+        if(eim.getIntProperty(\"snowmanLevel\") >= 5) return;\n+    \n+        var step = eim.getIntProperty(\"snowmanStep\");\n+        if(step > 0) {\n+                eim.setIntProperty(\"snowmanStep\", step - 1);\n+        }\n+        \n+        eim.dropMessage(5, \"The snowman absorbed a Fake Snow Vigor!\");\n+}\n+\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "8b92bc305def9b398427a07399ff83df69da9949", "filename": "scripts/npc/9000011.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9000011.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9000011.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000011.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -39,7 +39,7 @@ function action(mode, type, selection) {\n \t\t\t} else if (selection == 1) {\n \t\t\t\tcm.sendSimple(\"There are many games for this event. It will help you a lot to know how to play the game before you play it. Choose the one you want to know more of! #b\\r\\n#L0# Ola Ola#l\\r\\n#L1# MapleStory Maple Physical Fitness Test#l\\r\\n#L2# Snow Ball#l\\r\\n#L3# Coconut Harvest#l\\r\\n#L4# OX Quiz#l\\r\\n#L5# Treasure Hunt#l#k\");\n \t\t\t} else if (selection == 2) {\n-\t\t\t\tvar marr = cm.getQuestRecord(160200);\n+\t\t\t\tvar marr = cm.getQuestRecord(100295);\n \t\t\t\tif (marr.getCustomData() == null) {\n \t\t\t\t\tmarr.setCustomData(\"0\");\n \t\t\t\t}"}, {"sha": "8c899cdb067f6ee27cf1fe30986fcc6c80f378b3", "filename": "scripts/npc/9105004.js", "status": "added", "additions": 230, "deletions": 0, "changes": 230, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9105004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9105004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9105004.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,230 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/* \n+ * @Author Ronan\n+ * Snow Spirit\n+\tMaplemas PQ coordinator\n+ */\n+\n+importPackage(Packages.server.life);\n+\n+var prizeTree = [[[2000002, 1002850], [20, 1]], [[2000006, 1012011], [20, 1]]];\n+\n+var state;\n+var status;\n+var gift;\n+var pqType;\n+ \n+function start() {\n+        pqType = ((cm.getMapId() / 10) % 10) + 1;\n+        state = (cm.getMapId() % 10 > 0) ? 1 : 0;\n+        status = -1;\n+        action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if(state > 0) {\n+                    insidePqAction(mode, type, selection);\n+                } else {\n+                    recruitPqAction(mode, type, selection);\n+                }\n+        }\n+}\n+\n+function recruitPqAction(mode, type, selection) {\n+        if (status == 0) {\n+                em = cm.getEventManager(\"HolidayPQ_\" + pqType);\n+                if(em == null) {\n+                        cm.sendOk(\"The Holiday PQ \" + pqType + \" has encountered an error.\");\n+                        cm.dispose();\n+                } else if(cm.isUsingOldPqNpcStyle()) {\n+                        action(1, 0, 0);\n+                        return;\n+                }\n+\n+                cm.sendSimple(\"#e#b<Party Quest: Holiday>\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nHow about you and your party members collectively beating a quest? Here you'll find obstacles and problems where you won't be able to beat it without great teamwork. If you want to try it, please tell the #bleader of your party#k to talk to me.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+        } else if (status == 1) {\n+                if (selection == 0) {\n+                        if (cm.getParty() == null) {\n+                                cm.sendOk(\"You can participate in the party quest only if you are in a party.\");\n+                                cm.dispose();\n+                        } else if(!cm.isLeader()) {\n+                                cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n+                                cm.dispose();\n+                        } else {\n+                                var eli = em.getEligibleParty(cm.getParty());\n+                                if(eli.size() > 0) {\n+                                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), pqType)) {\n+                                                cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n+                                        }\n+                                }\n+                                else {\n+                                        cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n+                                }\n+\n+                                cm.dispose();\n+                        }\n+                } else if (selection == 1) {\n+                        cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n+                        cm.dispose();\n+                } else {\n+                        cm.sendOk(\"#e#b<Party Quest: Holiday>#k#n\\r\\n\\r\\nJoin in with your team to build up the Snowman that will protect Happyville from the misdoings of Scrooge. While inside, work out with your team to protect it at any means necessary while collecting Snow Vigor that will help on the build up of the Snowman.\");\n+                        cm.dispose();\n+                }\n+        }\n+}\n+\n+function insidePqAction(mode, type, selection) {\n+        var eim = cm.getEventInstance();\n+        var difficulty = eim.getIntProperty(\"level\");\n+        var stg = eim.getIntProperty(\"statusStg1\");\n+\n+        var mapobj = eim.getInstanceMap(889100001 + 10 * (difficulty - 1));\n+\n+        if(status == 0) {\n+                if(stg == -1) {\n+                        cm.sendNext(\"#b#h0##k... you're finally here. This is the place where the residents of Happyville build the giant snowman. But Scrooge's subordinates are attacking it right now. Now Hurry! Our mission is for you and your party to protect the snowman from Scrooge's men within the time limit. If you eliminate them, then they'll drop an item called Snow Vigor. Gather them up and drop them on the snowman, and you'll literally see it grow. Once it returns to its original size, then your task is complete. Just beware of one thing. Some of the subordinates may drop a fake Snow Vigor. A fake Snow Vigor will actually cause the snowman to melt even faster than usual. Best of luck to you.\");\n+                } else if(stg == 0) {\n+                        if(cm.getMap().getMonsterById(9400321 + 5 * difficulty) == null) {\n+                                cm.sendNext(\"Please, defeat Scrooge's underlings and make the snowman grow, so that Scrooge has no other way to avoid showing himself up.\");\n+                                cm.dispose();\n+                        } else {\n+                                cm.sendNext(\"Awesome! Just as I expected, you managed to defeat Scrooge's subordinates. Thank you so much! (Stands silent for a while...) Unfortunately, Scrooge doesn't seem like he's going to stop right here. One of his men have already told him what happened, which means... he'll show up soon. Please keep fighting, and again, best of luck to you.\");\n+                        }\n+                } else {\n+                        if(!eim.isEventCleared()) {\n+                                cm.sendNext(\"Please defeat the Scrooge, so our Maplemas keeps safe from harm!\");\n+                                cm.dispose();\n+                        } else {\n+                                cm.sendNext(\"Wow!! You defeated Scrooge! Thank you so much! You have managed to make this Maplemas safe and sound! Thanks!!\");\n+                        }\n+                }\n+        } else if(status == 1) {\n+                if(stg == -1) {\n+                        if(!cm.isEventLeader()) {\n+                                cm.sendOk(\"Please let your party leader talk to me for further details on the mission.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+\n+                        mapobj.allowSummonState(true);\n+                        var snowman = MapleLifeFactory.getMonster(9400317 + (5 * difficulty));\n+                        mapobj.spawnMonsterOnGroundBelow(snowman, new java.awt.Point(-180, 15));\n+                        eim.setIntProperty(\"snowmanLevel\", 1);\n+                        eim.dropMessage(5, \"The snowman appeared on the field! Protect it using all means necessary!\");\n+\n+                        eim.setIntProperty(\"statusStg1\", 0);\n+                        cm.dispose();\n+                        return;\n+                } else if(stg == 0) {\n+                        if(!cm.isEventLeader()) {\n+                                cm.sendOk(\"Please let your party leader talk to me for further details on the mission.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+\n+                        mapobj.broadcastStringMessage(5, \"As the snowman grows to it's prime, the Scrooge appears!\");\n+                        eim.getEm().getIv().invokeFunction(\"snowmanHeal\", eim);\n+\n+                        var boss = MapleLifeFactory.getMonster(9400318 + difficulty);\n+                        mapobj.spawnMonsterOnGroundBelow(boss, new java.awt.Point(-180, 15));\n+                        eim.setProperty(\"spawnedBoss\", \"true\");\n+\n+                        eim.setIntProperty(\"statusStg1\", 1);\n+                        cm.dispose();\n+                } else {\n+                        gift = cm.haveItem(4032092, 1);\n+                        if(gift) {\n+                                var optStr = generateSelectionMenu(generatePrizeString());\n+                                cm.sendSimple(\"Oh, you brought a #b#t4032092##k with you? That's nice, hold on a bit... Here's your Maplemas gift. Please select the one you'd like to receive:\\r\\n\\r\\n\" + optStr);\n+                        } else if(eim.gridCheck(cm.getPlayer()) == -1) {\n+                                cm.sendNext(\"Here's your Maplemas gift. Enjoy~\");\n+                        } else {\n+                                cm.sendOk(\"Happy Maplemas!!\");\n+                                cm.dispose();\n+                        }\n+                }\n+\n+        } else if(status == 2) {\n+                if(gift) {\n+                        var selItems = prizeTree[selection];\n+                        if(cm.canHoldAll(selItems[0], selItems[1])) {\n+                                cm.gainItem(4032092, -1);\n+                                cm.gainItem(selItems[0][0], selItems[1][0]);\n+\n+                                if(selection == 1) {\n+                                        var rnd = (Math.random() * 9) | 0;\n+                                        cm.gainItem(selItems[0][1] + rnd, selItems[1][1]);\n+                                } else {\n+                                        cm.gainItem(selItems[0][1], selItems[1][1]);\n+                                }\n+                        } else {\n+                                cm.sendOk(\"Please make sure you have room in your EQUIP and USE inventories before proceeding.\");\n+                        }\n+                } else {\n+                        if(eim.giveEventReward(cm.getPlayer(), difficulty)) {\n+                                eim.gridInsert(cm.getPlayer(), 1);\n+                        } else {\n+                                cm.sendOk(\"Please make sure you have room in your EQUIP, USE and ETC inventories before proceeding.\");\n+                        }\n+                }\n+\n+                cm.dispose();\n+        }\n+}\n+\n+function generatePrizeString() {\n+        var strTree = [];\n+        \n+        for(var i = 0; i < prizeTree.length; i++) {\n+                var items = prizeTree[i][0];\n+                var qtys = prizeTree[i][1];\n+\n+                var strSel = \"\";\n+                for(var j = 0; j < items.length; j++) {\n+                        strSel += (\"#i\" + items[j] + \"# #t\" + items[j] + \"#\" + (qtys[j] > 1 ? (\" : \" + qtys[j]) : \"\"));\n+                }\n+\n+                strTree.push(strSel);\n+        }\n+        \n+        return strTree;\n+}\n+\n+function generateSelectionMenu(array) {\n+        var menu = \"\";\n+        for (var i = 0; i < array.length; i++) {\n+                menu += \"#L\" + i + \"#\" + array[i] + \"#l\\r\\n\";\n+        }\n+        return menu;\n+}\n\\ No newline at end of file"}, {"sha": "ccac6a8b3ca4cadcd8c77fc3d00d5a18f84d34e0", "filename": "scripts/npc/9105005.js", "status": "added", "additions": 59, "deletions": 0, "changes": 59, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9105005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9105005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9105005.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,59 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status;\n+var area;\n+ \n+function start() {\n+        area = cm.getMapId() % 10;\n+        status = -1;\n+        action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if(status == 0) {\n+                        if(area > 0) {\n+                                cm.sendYesNo(\"Do you wish to leave this place?\");\n+                        } else {\n+                                cm.sendYesNo(\"Do you wish to return to #bHappyville#k?\");\n+                        }\n+                } else {\n+                        if(area > 0) {\n+                                cm.warp(cm.getMapId() + 1, 0);\n+                        } else {\n+                                cm.warp(209000000);\n+                        }\n+                        \n+                        cm.dispose();\n+                }\n+        }\n+}"}, {"sha": "4ec9b478d1b9f50435959bed4f998cb07dcd3835", "filename": "scripts/npc/9201005.js", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9201005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9201005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201005.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -260,12 +260,6 @@ function action(mode, type, selection) {\n                 var eim = getMarriageInstance(wid);\n \n                 if(eim != null) {\n-                    if(!cm.canHold(4000313)) {\n-                        cm.sendOk(\"Please have a free ETC slot available to get the #b#t4000313##k.\");\n-                        cm.dispose();\n-                        return;\n-                    }\n-\n                     cm.gainItem(weddingGuestTicket, -1);\n                     eim.registerPlayer(cm.getPlayer());     //cm.warp(680000210, 0);\n                 } else {"}, {"sha": "48448b3da9eea9b445fd731a0d85ee46f69534ea", "filename": "scripts/npc/9201008.js", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9201008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9201008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201008.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -260,12 +260,6 @@ function action(mode, type, selection) {\n                 var eim = getMarriageInstance(wid);\n \n                 if(eim != null) {\n-                    if(!cm.canHold(4000313)) {\n-                        cm.sendOk(\"Please have a free ETC slot available to get the #b#t4000313##k.\");\n-                        cm.dispose();\n-                        return;\n-                    }\n-\n                     cm.gainItem(weddingGuestTicket, -1);\n                     eim.registerPlayer(cm.getPlayer());     //cm.warp(680000210, 0);\n                 } else {"}, {"sha": "780c1b51245647ffa65b72cfe08987111e7dfd91", "filename": "scripts/npc/9209000.js", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9209000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9209000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9209000.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1,3 +1,22 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n /**\n  * @author: Ronan\n  * @npc: Abdula"}, {"sha": "998f662cb892acdbfb39d594683ebd28d765ff39", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -32,15 +32,15 @@ var ambientSong = \"Bgm04/Shinin'Harbor\";\n var feature_tree = [];\n var feature_cursor;\n \n-var tabs = [\"PQs\", \"Skills\", \"Quests\", \"Player Social Network\", \"Cash & Items\", \"Monsters, Maps & Reactors\", \"PQ potentials\", \"Player potentials\", \"Server potentials\", \"Admin/GM commands\", \"Localhost edits\", \"Project\"];\n+var tabs = [\"PQs\", \"Skills\", \"Quests\", \"Player Social Network\", \"Cash & Items\", \"Monsters, Maps & Reactors\", \"PQ potentials\", \"Player potentials\", \"Server potentials\", \"Admin/GM commands\", \"Custom NPCs\", \"Localhost edits\", \"Project\"];\n \n function addFeature(feature) {\n         feature_cursor.push(feature);\n }\n \n function writeFeatureTab_PQs() {\n         addFeature(\"HPQ/KPQ/LPQ/LMPQ/OPQ/APQ/EllinPQ/PiratePQ.\");\n-        addFeature(\"MagatiaPQ/HorntailPQ/TreasurePQ/ElnathPQ.\");\n+        addFeature(\"RnJPQ/HorntailPQ/TreasurePQ/ElnathPQ/HolidayPQ.\");\n         addFeature(\"CWKPQ as Expedition-based event.\");\n         addFeature(\"Scarga/Horntail/Showa/Balrog/Zakum/Pinkbean.\");\n         addFeature(\"GuildPQ & queue with multi-lobby systems available.\");\n@@ -51,8 +51,10 @@ function writeFeatureTab_PQs() {\n \n function writeFeatureTab_Skills() {\n         addFeature(\"Reviewed many skills, such as Steal and M. Door.\");\n+        addFeature(\"Improved battleship: HP visible and map-persistent.\");\n         addFeature(\"Maker skill features properly developed.\");\n         addFeature(\"Chair Mastery - map chair boosts HP/MP rec.\");\n+        addFeature(\"Mu Lung Dojo skills functional.\");\n }\n \n function writeFeatureTab_Quests() {\n@@ -85,6 +87,7 @@ function writeFeatureTab_CashItems() {\n         addFeature(\"New town scroll: antibanish. Counters boss banishes.\");\n         addFeature(\"Inventory system checks for free slot & stack space.\");\n         addFeature(\"Storage with 'Arrange Items' feature functional.\");\n+        addFeature(\"Close-quarters evaluation mode for items.\");\n         addFeature(\"Further improved Karma scissors.\");\n         addFeature(\"Scroll for Spikes on Shoes.\");\n         addFeature(\"Scroll for Cold Protection.\");\n@@ -103,12 +106,14 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Monsterbook displays updated drop data info.\");\n         addFeature(\"Every skill/mastery book is now obtainable.\");\n         addFeature(\"Mobs now can drop more than one of the same equip.\");\n+        addFeature(\"Redesigned HT mechanics: assemble & dmg taken.\");\n         addFeature(\"Implemented Zombify disease status.\");\n         addFeature(\"Added Boss HP Bar for dozens of bosses.\");\n         addFeature(\"Game will favor showing the targeted boss HPbar.\");\n         addFeature(\"Dmg overtime on maps and neutralizers functional.\");\n         addFeature(\"Boats, elevator and other travel mechanics functional.\");\n         addFeature(\"C. Balrog's boat approaching visual effect functional.\");\n+        addFeature(\"Maps having everlasting items no longer expires them.\");\n         addFeature(\"PQs, Taxis and events warps players to random SPs.\");\n         addFeature(\"PQ boxes sprays items when opened, GMS-like.\");\n         addFeature(\"Reactors pick items up smartly from the field.\");\n@@ -129,6 +134,7 @@ function writeFeatureTab_Playerpotentials() {\n         addFeature(\"Player level rates.\");\n         addFeature(\"Gain fame by quests.\");\n         addFeature(\"Pet evolutions functional (not GMS-like).\");\n+        addFeature(\"Reviewed keybinding system.\");\n }\n \n function writeFeatureTab_Serverpotentials() {\n@@ -160,6 +166,14 @@ function writeFeatureTab_AdminGMcommands() {\n         addFeature(\"Several new commands.\");\n }\n \n+function writeFeatureTab_CustomNPCs() {\n+        addFeature(\"Spiegelmann: automatized rock-refiner.\");\n+        addFeature(\"Abdula: lists droppers of needed skill/mastery books.\");\n+        addFeature(\"Agent E: accessory crafter.\");\n+        addFeature(\"Donation Box: automatized item-buyer.\");\n+        addFeature(\"Coco & Ace of Hearts: C. scroll crafters.\");\n+}\n+\n function writeFeatureTab_Localhostedits() {\n         addFeature(\"Removed the 'n' NPC dialog issue.\");\n         addFeature(\"Removed caps for MATK, WMDEF, ACC and AVOID.\");\n@@ -180,6 +194,7 @@ function writeFeatureTab_Project() {\n         addFeature(\"Fixed/added many missing packet opcodes.\");\n         addFeature(\"Uncovered many opcodes throughout the source.\");\n         addFeature(\"Reviewed many Java aspects that needed attention.\");\n+        addFeature(\"Reviewed SQL data, eliminating duplicated entries.\");\n         addFeature(\"Protected many flaws with login management system.\");\n         addFeature(\"ThreadTracker: runtime tool for deadlock detection.\");\n         addFeature(\"Heavily reviewed future task management, spawning much less threads and relieving task overload on the TimerManager.\");"}, {"sha": "265ddde47b602625501cc3904f66acc3a188476d", "filename": "scripts/portal/08_xmas_out.js", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/portal/08_xmas_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/portal/08_xmas_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/08_xmas_out.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,25 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+function enter(pi) {\n+        pi.playPortalSound();\n+        pi.warp(pi.getMapId() - 2, 0);\n+        return true;\n+}\n\\ No newline at end of file"}, {"sha": "f5db1d4a01a551a8e1e890bb1f239a7108b0db21", "filename": "scripts/quest/28004.js", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/quest/28004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/quest/28004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/28004.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,54 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status = -1;\n+\n+function start(mode, type, selection) {\n+    if (mode == -1) {\n+        qm.dispose();\n+    } else {\n+        if(mode == 0 && type > 0) {\n+            qm.dispose();\n+            return;\n+        }\n+        \n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        \n+        if (status == 0) {\n+            if(qm.getPlayer().getLevel() > 50) {\n+                qm.forceCompleteQuest();\n+                qm.dispose();\n+                return;\n+            }\n+            \n+            qm.sendNext(\"Okay... so here's our plan to defeat Scrooge and his dastardly plans. The Force of the Spirit I gave you is an item packed with mana. It's an item you'll definitely use at the map I am about to send you. In order to do that, you'll have to bring your party members with you as well. You should bring your party members here or form one right now!\");\n+        } else if (status == 1) {\n+            qm.sendAcceptDecline(\"Would you like to move forward?\");\n+        } else {\n+            var level = qm.getPlayer().getLevel();\n+            \n+            qm.warp(level <= 30 ? 889100000 : (level <= 40 ? 889100010 : 889100020));\n+            qm.dispose();\n+        }\n+    }\n+}"}, {"sha": "aae65913c122f7b3874fc1eacbf4690d7ccdc8ff", "filename": "scripts/reactor/9400300.js", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/reactor/9400300.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/reactor/9400300.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/9400300.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,29 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/* @Author Ronan\n+ * \n+ * 9400300.js: assimilate Snow Vigor\n+*/\n+\n+function act() {\n+    var eim = rm.getEventInstance();\n+    eim.getEm().getIv().invokeFunction(\"snowmanSnack\", eim);\n+}\n\\ No newline at end of file"}, {"sha": "9f5d20212a1a502a717c28e684396a3ba349de14", "filename": "scripts/reactor/9400301.js", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/reactor/9400301.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/scripts/reactor/9400301.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/9400301.js?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,29 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/* @Author Ronan\n+ * \n+ * 9400301.js: assimilate Fake Snow Vigor\n+*/\n+\n+function act() {\n+    var eim = rm.getEventInstance();\n+    eim.getEm().getIv().invokeFunction(\"snowmanSnackFake\", eim);\n+}\n\\ No newline at end of file"}, {"sha": "4848b89c6422f118950523d79d753e7520785d7f", "filename": "src/client/MapleBuffStat.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleBuffStat.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleBuffStat.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleBuffStat.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -65,7 +65,6 @@\n     SPARK(0x20000000L),\n     MAP_CHAIR(0x40000000L),\n     FINALATTACK(0x80000000L),\n-    BATTLESHIP(0xA00000040L), // weird one\n     WATK(0x100000000L),\n     WDEF(0x200000000L),\n     MATK(0x400000000L),"}, {"sha": "fcce53ed94a9f387a4f1f76cd1ee4ab428c07358", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 56, "deletions": 18, "changes": 74, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -200,7 +200,7 @@\n     private int owlSearch;\n     private long lastfametime, lastUsedCashItem, lastHealed, lastBuyback, lastDeathtime, lastMesoDrop = -1, jailExpiration = -1;\n     private transient int localmaxhp, localmaxmp, localstr, localdex, localluk, localint_, magic, watk;\n-    private boolean hidden, canDoor = true, berserk, hasMerchant, whiteChat = false;\n+    private boolean hidden, canDoor = true, berserk, hasMerchant, hasSandboxItem = false, whiteChat = false;\n     private int linkedLevel = 0;\n     private String linkedName = null;\n     private boolean finishedDojoTutorial;\n@@ -479,9 +479,6 @@ public void addCooldown(int skillId, long startTime, long length) {\n         effLock.lock();\n         chrLock.lock();\n         try {\n-            if (this.coolDowns.containsKey(Integer.valueOf(skillId))) {\n-                this.coolDowns.remove(Integer.valueOf(skillId));\n-            }\n             this.coolDowns.put(Integer.valueOf(skillId), new MapleCoolDownValueHolder(skillId, startTime, length));\n         } finally {\n             chrLock.unlock();\n@@ -961,6 +958,33 @@ public static boolean canCreateChar(String name) {\n     public boolean canDoor() {\n         return canDoor;\n     }\n+    \n+    public void setHasSandboxItem() {\n+        hasSandboxItem = true;\n+    }\n+    \n+    public void removeSandboxItems() {  // sandbox idea thanks to Morty\n+        if(!hasSandboxItem) return;\n+        \n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        for(MapleInventoryType invType : MapleInventoryType.values()) {\n+            MapleInventory inv = this.getInventory(invType);\n+            \n+            inv.lockInventory();\n+            try {\n+                for(Item item : new ArrayList<>(inv.list())) {\n+                    if(MapleInventoryManipulator.isSandboxItem(item)) {\n+                        MapleInventoryManipulator.removeFromSlot(client, invType, item.getPosition(), item.getQuantity(), false);\n+                        dropMessage(5, \"[\" + ii.getName(item.getItemId()) + \"] has passed its trial conditions and will be removed from your inventory.\");\n+                    }\n+                }\n+            } finally {\n+                inv.unlockInventory();\n+            }\n+        }\n+        \n+        hasSandboxItem = false;\n+    }\n \n     public FameStatus canGiveFame(MapleCharacter from) {\n         if (gmLevel > 0) {\n@@ -1789,18 +1813,26 @@ public boolean canHold(int itemid, int quantity) {\n         return getInventory(ItemConstants.getInventoryType(itemid)).getNextFreeSlot() > -1;\n     }\n \n+    public boolean isRidingBattleship() {\n+        Integer bv = getBuffedValue(MapleBuffStat.MONSTER_RIDING);\n+        return bv != null && bv.equals(Corsair.BATTLE_SHIP);\n+    }\n+    \n+    public void announceBattleshipHp() {\n+        announce(MaplePacketCreator.skillCooldown(5221999, battleshipHp));\n+    }\n+    \n     public void decreaseBattleshipHp(int decrease) {\n         this.battleshipHp -= decrease;\n         if (battleshipHp <= 0) {\n-            this.battleshipHp = 0;\n             Skill battleship = SkillFactory.getSkill(Corsair.BATTLE_SHIP);\n             int cooldown = battleship.getEffect(getSkillLevel(battleship)).getCooldown();\n             announce(MaplePacketCreator.skillCooldown(Corsair.BATTLE_SHIP, cooldown));\n             addCooldown(Corsair.BATTLE_SHIP, System.currentTimeMillis(), (long)(cooldown * 1000));\n             removeCooldown(5221999);\n             cancelEffectFromBuffStat(MapleBuffStat.MONSTER_RIDING);\n         } else {\n-            announce(MaplePacketCreator.skillCooldown(5221999, battleshipHp / 10));   //:D\n+            announceBattleshipHp();\n             addCooldown(5221999, 0, Long.MAX_VALUE);\n         }\n     }\n@@ -2575,8 +2607,9 @@ public void run() {\n                                 Pair<Integer, String> replace = ii.getReplaceOnExpire(item.getItemId());\n                                 if (replace.left > 0) {\n                                     toadd.add(replace.left);\n-                                    if (replace.right != null)\n+                                    if (!replace.right.isEmpty()) {\n                                         dropMessage(replace.right);\n+                                    }\n                                 }\n                                 for (Integer itemid : toadd) {\n                                     MapleInventoryManipulator.addById(client, itemid, (short) 1);\n@@ -3032,7 +3065,7 @@ private void extractBuffValue(int sourceid, MapleBuffStat stat) {\n         }\n     }\n     \n-    private void debugListAllBuffs() {\n+    public void debugListAllBuffs() {\n         effLock.lock();\n         chrLock.lock();\n         try {\n@@ -3057,7 +3090,7 @@ private void debugListAllBuffs() {\n         }\n     }\n     \n-    private void debugListAllBuffsCount() {\n+    public void debugListAllBuffsCount() {\n         effLock.lock();\n         chrLock.lock();\n         try {\n@@ -3568,6 +3601,13 @@ public int compare( Pair<MapleStatEffect, Pair<Integer, Integer>> o1, Pair<Maple\n             Pair<MapleStatEffect, Long> msel = lmse.getRight();\n             msel.getLeft().updateBuffEffect(this, getActiveStatupsFromSourceid(lmse.getLeft()), msel.getRight());\n         }\n+        \n+        if (this.isRidingBattleship()) {\n+            List<Pair<MapleBuffStat, Integer>> statups = new ArrayList<>(1);\n+            statups.add(new Pair<>(MapleBuffStat.MONSTER_RIDING, 0));\n+            this.announce(MaplePacketCreator.giveBuff(1932000, 5221006, statups));\n+            this.announceBattleshipHp();\n+        }\n     }\n     \n     private static MapleBuffStat getSingletonStatupFromEffect(MapleStatEffect mse) {\n@@ -5805,6 +5845,10 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             ret.getInventory(MapleInventoryType.SETUP).setSlotLimit(rs.getByte(\"setupslots\"));\n             ret.getInventory(MapleInventoryType.ETC).setSlotLimit(rs.getByte(\"etcslots\"));\n             for (Pair<Item, MapleInventoryType> item : ItemFactory.INVENTORY.loadItems(ret.id, !channelserver)) {\n+                if(MapleInventoryManipulator.isSandboxItem(item.getLeft())) {\n+                    ret.setHasSandboxItem();\n+                }\n+                \n                 ret.getInventory(item.getRight()).addFromDB(item.getLeft());\n                 Item itemz = item.getLeft();\n                 if (itemz.getPetId() > -1) {\n@@ -6015,12 +6059,6 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n                     }\n                 }\n                 \n-                /*\n-                for(MapleQuestStatus mqs : loadedQuestStatus.values()) {\n-                    mqs.resetUpdated();\n-                }\n-                */\n-                \n                 loadedQuestStatus.clear();\n                 \n                 ps = con.prepareStatement(\"SELECT skillid,skilllevel,masterlevel,expiration FROM skills WHERE characterid = ?\");\n@@ -6550,11 +6588,11 @@ public void resetStats() {\n         statup.add(new Pair<>(MapleStat.LUK, tluk));\n         announce(MaplePacketCreator.updatePlayerStats(statup, this));\n     }\n-\n+    \n     public void resetBattleshipHp() {\n-        this.battleshipHp = 4000 * getSkillLevel(SkillFactory.getSkill(Corsair.BATTLE_SHIP)) + ((getLevel() - 120) * 2000);\n+        this.battleshipHp = 400 * getSkillLevel(SkillFactory.getSkill(Corsair.BATTLE_SHIP)) + ((getLevel() - 120) * 200);\n     }\n-\n+    \n     public void resetEnteredScript() {\n         if (entered.containsKey(map.getId())) {\n             entered.remove(map.getId());"}, {"sha": "35cfa9b0accb7422b4889353487cdd0ce4edf826", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -64,6 +64,7 @@\n import constants.GameConstants;\n import constants.ServerConstants;\n import scripting.AbstractPlayerInteraction;\n+import scripting.event.EventInstanceManager;\n import scripting.event.EventManager;\n import scripting.npc.NPCConversationManager;\n import scripting.npc.NPCScriptManager;\n@@ -798,8 +799,9 @@ private void removePlayer() {\n                         player.closePlayerInteractions();\n \t\t\tQuestScriptManager.getInstance().dispose(this);\n \t\t\t\n-\t\t\tif (player.getEventInstance() != null) {\n-\t\t\t\tplayer.getEventInstance().playerDisconnected(player);\n+                        EventInstanceManager eim = player.getEventInstance();\n+\t\t\tif (eim != null) {\n+\t\t\t\teim.playerDisconnected(player);\n \t\t\t}\n \t\t\tif (player.getMap() != null) {\n                                 int mapId = player.getMapId();"}, {"sha": "9420259fa795314ef06ffa380e7b05fbc520ee7f", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1285,8 +1285,10 @@ else if (type.equals(\"cash\")) {\n                                     byte b = toDrop.getFlag();\n                                     b |= ItemConstants.ACCOUNT_SHARING;\n                                     b |= ItemConstants.UNTRADEABLE;\n+                                    b |= ItemConstants.SANDBOX;\n                                     \n                                     toDrop.setFlag(b);\n+                                    toDrop.setOwner(\"TRIAL-MODE\");\n                                 }\n                                 \n \t\t\t\tc.getPlayer().getMap().spawnItemDrop(c.getPlayer(), c.getPlayer(), toDrop, c.getPlayer().getPosition(), true, true);"}, {"sha": "d126ecbb382af977ca983160080dd22268fe2469", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -77,7 +77,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                         if (i.hasNext()) {\n                             Item eItem = (Item) i.next();\n                             short oldQ = eItem.getQuantity();\n-                            if (oldQ < slotMax && (eItem.getOwner().equals(owner) || owner == null)) {\n+                            if (oldQ < slotMax && ((eItem.getOwner().equals(owner) || owner == null) && eItem.getFlag() == flag)) {\n                                 short newQ = (short) Math.min(oldQ + quantity, slotMax);\n                                 quantity -= (newQ - oldQ);\n                                 eItem.setQuantity(newQ);\n@@ -89,6 +89,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                         }\n                     }\n                 }\n+                boolean sandboxItem = (flag & ItemConstants.SANDBOX) == ItemConstants.SANDBOX;\n                 while (quantity > 0 || ItemConstants.isRechargeable(itemId)) {\n                     short newQ = (short) Math.min(quantity, slotMax);\n                     if (newQ != 0) {\n@@ -106,6 +107,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                             nItem.setOwner(owner);\n                         }\n                         c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n+                        if(sandboxItem) c.getPlayer().setHasSandboxItem();\n                         if ((ItemConstants.isRechargeable(itemId)) && quantity == 0) {\n                             break;\n                         }\n@@ -125,6 +127,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                     return false;\n                 }\n                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n+                if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n             }\n         } else if (quantity == 1) {\n             Item nEquip = ii.getEquipById(itemId);\n@@ -140,6 +143,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                 return false;\n             }\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nEquip))));\n+            if(MapleInventoryManipulator.isSandboxItem(nEquip)) c.getPlayer().setHasSandboxItem();\n         } else {\n             throw new RuntimeException(\"Trying to create equip with non-one quantity\");\n         }\n@@ -173,7 +177,7 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                         if (i.hasNext()) {\n                             Item eItem = (Item) i.next();\n                             short oldQ = eItem.getQuantity();\n-                            if (oldQ < slotMax && item.getOwner().equals(eItem.getOwner())) {\n+                            if (oldQ < slotMax && item.getFlag() == eItem.getFlag() && item.getOwner().equals(eItem.getOwner())) {\n                                 short newQ = (short) Math.min(oldQ + quantity, slotMax);\n                                 quantity -= (newQ - oldQ);\n                                 eItem.setQuantity(newQ);\n@@ -199,10 +203,12 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                         return false;\n                     }\n                     c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n+                    if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n                 }\n             } else {\n                 Item nItem = new Item(item.getItemId(), (short) 0, quantity, petId);\n                 nItem.setExpiration(item.getExpiration());\n+                nItem.setFlag(item.getFlag());\n                 \n                 short newSlot = c.getPlayer().getInventory(type).addItem(nItem);\n                 if (newSlot == -1) {\n@@ -211,6 +217,7 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                     return false;\n                 }\n                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n+                if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n                 c.announce(MaplePacketCreator.enableActions());\n             }\n         } else if (quantity == 1) {\n@@ -221,6 +228,7 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                 return false;\n             }\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, item))));\n+            if(MapleInventoryManipulator.isSandboxItem(item)) c.getPlayer().setHasSandboxItem();\n         } else {\n             FilePrinter.printError(FilePrinter.ITEM, \"Tried to pickup Equip id \" + item.getItemId() + \" containing more than 1 quantity --> \" + quantity);\n             c.announce(MaplePacketCreator.getInventoryFull());\n@@ -625,4 +633,8 @@ public static void drop(MapleClient c, MapleInventoryType type, short src, short\n     private static boolean isDroppedItemRestricted(Item it) {\n         return ServerConstants.USE_ERASE_UNTRADEABLE_DROP && ((it.getFlag() & ItemConstants.UNTRADEABLE) == ItemConstants.UNTRADEABLE);\n     }\n+    \n+    public static boolean isSandboxItem(Item it) {\n+        return (it.getFlag() & ItemConstants.SANDBOX) == ItemConstants.SANDBOX;\n+    }\n }"}, {"sha": "a49234a84c91de95aee4fe612af76aadac0701d3", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -42,6 +42,7 @@\n     public final static int UNTRADEABLE = 0x08;\n     public final static int KARMA_EQP = 0x10;\n     public final static int KARMA_UNTRADEABLE = 0x20;   // let 0x20 until it's proven something uses this\n+    public final static int SANDBOX = 0x40;             // let 0x40 until it's proven something uses this\n     public final static int PET_COME = 0x80;\n     public final static int ACCOUNT_SHARING = 0x100;\n "}, {"sha": "47c03e443b1fb726262db7c4f4549431536c2d43", "filename": "src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -57,9 +57,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         } else if(monster.getId() == 9300093) {   //tylus\n                                 monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Tylus has fallen by the overwhelming forces of the ambush.\"));\n                         } else if(monster.getId() == 9300137) {   //juliet\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Juliet has fainted on the middle of the combat.\"));\n+                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Juliet has fainted in the middle of the combat.\"));\n                         } else if(monster.getId() == 9300138) {   //romeo\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Romeo has fainted on the middle of the combat.\"));\n+                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Romeo has fainted in the middle of the combat.\"));\n+                        } else if(monster.getId() == 9400322 || monster.getId() == 9400327 || monster.getId() == 9400332) {\n+                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Snowman has melted on the heat of the battle.\"));\n                         }\n                         \n                         c.getPlayer().getMap().killFriendlies(monster);"}, {"sha": "a23acdad1c0d6cc79103a7c6b36258a188521a53", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -263,11 +263,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             if (!c.hasVotedAlready()){\n             \tplayer.announce(MaplePacketCreator.earnTitleMessage(\"You can vote now! Vote and earn a vote point!\"));\n             }\n-                    */\n+            */\n             if (player.isGM()){\n             \tServer.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.earnTitleMessage((player.gmLevel() < 6 ? \"GM \" : \"Admin \") + player.getName() + \" has logged in\"));\n             }\n-            \n+        } else {\n+            if(player.isRidingBattleship()) {\n+                player.announceBattleshipHp();\n+            }\n         }\n         \n         showDueyNotification(c, player);"}, {"sha": "e1d383dac42bc18712a96307a4241519879c1f5d", "filename": "src/net/server/channel/handlers/RingActionHandler.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/RingActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/RingActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RingActionHandler.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -409,8 +409,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 if(guestChr != null && MapleInventoryManipulator.checkSpace(guestChr.getClient(), newItemId, 1, \"\") && MapleInventoryManipulator.addById(guestChr.getClient(), newItemId, (short) 1, expiration)) {\n                                     guestChr.dropMessage(6, \"[WEDDING] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding!\");\n                                 } else {\n-                                    c.getPlayer().sendNote(name, \"You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\", (byte) 0);\n-\n+                                    if(guestChr != null && guestChr.isLoggedinWorld()) {\n+                                        guestChr.dropMessage(6, \"[WEDDING] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\");\n+                                    } else {\n+                                        c.getPlayer().sendNote(name, \"You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\", (byte) 0);\n+                                    }\n+                                    \n                                     Item weddingTicket = new Item(newItemId, (short) 0, (short) 1);\n                                     weddingTicket.setExpiration(expiration);\n "}, {"sha": "6a0715687ac56e0882565488b5b91a4f9cda1600", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -237,10 +237,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 chr.addMPHP(-damage, -mpattack);\n             } else {\n-                if (chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {\n-                    if (chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING).intValue() == Corsair.BATTLE_SHIP) {\n-                        chr.decreaseBattleshipHp(damage);\n-                    }\n+                if (chr.isRidingBattleship()) {\n+                    chr.decreaseBattleshipHp(damage);\n                 }\n                 chr.addMPHP(-damage, -mpattack);\n             }"}, {"sha": "dac49603e375bacc935d787837fd5a420e433190", "filename": "src/net/server/channel/handlers/UseItemHandler.java", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/UseItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/net/server/channel/handlers/UseItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseItemHandler.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -31,6 +31,7 @@\n import net.AbstractMaplePacketHandler;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import server.MapleItemInformationProvider;\n+import server.MapleStatEffect;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -94,8 +95,16 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             \n             remove(c, slot);\n             \n-            ii.getItemEffect(toUse.getItemId()).applyTo(chr);\n-            chr.checkBerserk(chr.isHidden());\n+            if(toUse.getItemId() != 2022153) {\n+                ii.getItemEffect(toUse.getItemId()).applyTo(chr);\n+                chr.checkBerserk(chr.isHidden());\n+            } else {\n+                MapleStatEffect mse = ii.getItemEffect(toUse.getItemId());\n+                for(MapleCharacter player : chr.getMap().getCharacters()) {\n+                    mse.applyTo(player);\n+                    player.checkBerserk(player.isHidden());\n+                }\n+            }\n         }\n     }\n "}, {"sha": "7350052c56dc23684b81f0465af3a6e6e459fe3a", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -234,8 +234,7 @@ public void registerPlayer(MapleCharacter chr) {\n                         wL.lock();\n                         try {\n                                 chars.put(chr.getId(), chr);\n-                        }\n-                        finally {\n+                        } finally {\n                                 wL.unlock();\n                         }\n                         \n@@ -420,8 +419,7 @@ public int getPlayerCount() {\n                 rL.lock();\n                 try {\n                         return chars.size();\n-                }\n-                finally {\n+                } finally {\n                         rL.unlock();\n                 }\n \t}\n@@ -430,8 +428,7 @@ public MapleCharacter getPlayerById(int id) {\n                 rL.lock();\n                 try {\n                         return chars.get(id);\n-                }\n-                finally {\n+                } finally {\n                         rL.unlock();\n                 }\n \t}\n@@ -440,8 +437,7 @@ public MapleCharacter getPlayerById(int id) {\n                 rL.lock();\n                 try {\n                         return new ArrayList<>(chars.values());\n-                }\n-                finally {\n+                } finally {\n                         rL.unlock();\n                 }\n \t}"}, {"sha": "0b49e7a70bde637015062d3b693d921e75bd1b37", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 41, "deletions": 21, "changes": 62, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -121,6 +121,8 @@\n     protected Map<Integer, Pair<String, Integer>> statUpgradeMakerCache = new HashMap<>();\n     protected Map<Integer, MakerItemFactory.MakerItemCreateEntry> makerItemCache = new HashMap<>();\n     protected Map<Integer, Integer> makerCatalystCache = new HashMap<>();\n+    protected Map<Integer, Map<String, Integer>> skillUpgradeCache = new HashMap<>();\n+    protected Map<Integer, MapleData> skillUpgradeInfoCache = new HashMap<>();\n \n     private MapleItemInformationProvider() {\n         loadCardIdData();\n@@ -525,8 +527,9 @@ public int getPrice(int itemId, int quantity) {\n             return replaceOnExpireCache.get(itemId);\n         }\n  \n-        int itemReplacement = MapleDataTool.getInt(\"info/replace/itemid\", getItemData(itemId), 0);\n-        String msg = MapleDataTool.getString(\"info/replace/msg\", getItemData(itemId));\n+        MapleData data = getItemData(itemId);\n+        int itemReplacement = MapleDataTool.getInt(\"info/replace/itemid\", data, 0);\n+        String msg = MapleDataTool.getString(\"info/replace/msg\", data, \"\");\n  \n         Pair<Integer, String> ret = new Pair<>(itemReplacement, msg);\n         replaceOnExpireCache.put(itemId, ret);\n@@ -1239,25 +1242,42 @@ public boolean isPickupRestricted(int itemId) {\n         return bRestricted;\n     }\n \n-    public Map<String, Integer> getSkillStats(int itemId, double playerJob) {\n-        Map<String, Integer> ret = new LinkedHashMap<>();\n+    private Pair<Map<String, Integer>, MapleData> getSkillStatsInternal(int itemId) {\n+        Map<String, Integer> ret = skillUpgradeCache.get(itemId);\n+        MapleData retSkill = skillUpgradeInfoCache.get(itemId);\n+        \n+        if(ret != null) return new Pair<>(ret, retSkill);\n+        \n+        retSkill = null;\n+        ret = new LinkedHashMap<>();\n         MapleData item = getItemData(itemId);\n-        if (item == null) {\n-            return null;\n-        }\n-        MapleData info = item.getChildByPath(\"info\");\n-        if (info == null) {\n-            return null;\n-        }\n-        for (MapleData data : info.getChildren()) {\n-            if (data.getName().startsWith(\"inc\")) {\n-                ret.put(data.getName().substring(3), MapleDataTool.getIntConvert(data));\n+        if (item != null) {\n+            MapleData info = item.getChildByPath(\"info\");\n+            if (info != null) {\n+                for (MapleData data : info.getChildren()) {\n+                    if (data.getName().startsWith(\"inc\")) {\n+                        ret.put(data.getName().substring(3), MapleDataTool.getIntConvert(data));\n+                    }\n+                }\n+                ret.put(\"masterLevel\", MapleDataTool.getInt(\"masterLevel\", info, 0));\n+                ret.put(\"reqSkillLevel\", MapleDataTool.getInt(\"reqSkillLevel\", info, 0));\n+                ret.put(\"success\", MapleDataTool.getInt(\"success\", info, 0));\n+                \n+                retSkill = info.getChildByPath(\"skill\");\n             }\n         }\n-        ret.put(\"masterLevel\", MapleDataTool.getInt(\"masterLevel\", info, 0));\n-        ret.put(\"reqSkillLevel\", MapleDataTool.getInt(\"reqSkillLevel\", info, 0));\n-        ret.put(\"success\", MapleDataTool.getInt(\"success\", info, 0));\n-        MapleData skill = info.getChildByPath(\"skill\");\n+        \n+        skillUpgradeCache.put(itemId, ret);\n+        skillUpgradeInfoCache.put(itemId, retSkill);\n+        return new Pair<>(ret, retSkill);\n+    }\n+    \n+    public Map<String, Integer> getSkillStats(int itemId, double playerJob) {\n+        Pair<Map<String, Integer>, MapleData> retData = getSkillStatsInternal(itemId);\n+        if(retData.getLeft().isEmpty()) return null;\n+        \n+        Map<String, Integer> ret = new LinkedHashMap<>(retData.getLeft());\n+        MapleData skill = retData.getRight();\n         int curskill;\n         for (int i = 0; i < skill.getChildren().size(); i++) {\n             curskill = MapleDataTool.getInt(Integer.toString(i), skill, 0);\n@@ -1933,7 +1953,7 @@ public int getMakerStimulant(int itemId) {  // thanks to Arnah\n     }\n     \n     private boolean canUseSkillBook(MapleCharacter player, Integer skillBookId) {\n-        Map<String, Integer> skilldata = MapleItemInformationProvider.getInstance().getSkillStats(skillBookId, player.getJob().getId());\n+        Map<String, Integer> skilldata = getSkillStats(skillBookId, player.getJob().getId());\n         if(skilldata == null || skilldata.get(\"skillid\") == 0) return false;\n             \n         Skill skill2 = SkillFactory.getSkill(skilldata.get(\"skillid\"));\n@@ -1942,7 +1962,7 @@ private boolean canUseSkillBook(MapleCharacter player, Integer skillBookId) {\n     \n     public List<Integer> usableMasteryBooks(MapleCharacter player) {\n         List<Integer> masterybook = new LinkedList<>();\n-        for(Integer i = 2290000; i <= 2290125; i++) {\n+        for(Integer i = 2290000; i <= 2290139; i++) {\n             if(canUseSkillBook(player, i)) {\n                 masterybook.add(i);\n             }\n@@ -1953,7 +1973,7 @@ private boolean canUseSkillBook(MapleCharacter player, Integer skillBookId) {\n     \n     public List<Integer> usableSkillBooks(MapleCharacter player) {\n         List<Integer> skillbook = new LinkedList<>();\n-        for(Integer i = 2280000; i <= 2280012; i++) {\n+        for(Integer i = 2280000; i <= 2280019; i++) {\n             if(canUseSkillBook(player, i)) {\n                 skillbook.add(i);\n             }"}, {"sha": "93f222621a4b837839f9618f01664cc24ebfe1e2", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1001,7 +1001,7 @@ public void silentApplyBuff(MapleCharacter chr, long localStartTime) {\n             }\n         }\n         if (sourceid == Corsair.BATTLE_SHIP) {\n-            chr.announce(MaplePacketCreator.skillCooldown(5221999, chr.getBattleshipHp()));\n+            chr.announceBattleshipHp();\n         }\n     }\n \n@@ -1107,14 +1107,17 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n             } else if (isCombo()) {\n                 mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), statups);\n             } else if (isMonsterRiding()) {\n-                buff = MaplePacketCreator.giveBuff(localsourceid, localDuration, localstatups);\n-                mbuff = MaplePacketCreator.showMonsterRiding(applyto.getId(), givemount);\n-                localDuration = duration;\n                 if (sourceid == Corsair.BATTLE_SHIP) {//hp\n-                    if (applyto.getBattleshipHp() == 0) {\n+                    if (applyto.getBattleshipHp() <= 0) {\n                         applyto.resetBattleshipHp();\n                     }\n+                    \n+                    localstatups = statups;\n                 }\n+                \n+                buff = MaplePacketCreator.giveBuff(localsourceid, localDuration, localstatups);\n+                mbuff = MaplePacketCreator.showMonsterRiding(applyto.getId(), givemount);\n+                localDuration = duration;\n             } else if (isShadowPartner()) {\n                 List<Pair<MapleBuffStat, Integer>> stat = Collections.singletonList(new Pair<>(MapleBuffStat.SHADOWPARTNER, 0));\n                 mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), stat);\n@@ -1130,9 +1133,8 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n             \n             if (buff != null) {\n             \tif (!hasNoIcon()) { //Thanks flav for such a simple release! :)\n-            \t\tapplyto.getClient().announce(buff);\n-            \t}\n-                else {\n+                    applyto.announce(buff);\n+            \t} else {\n                     System.out.println(\"<Error> NO buff icon for id \" + sourceid);\n                 }\n             }\n@@ -1146,7 +1148,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n                 applyto.getMap().broadcastMessage(applyto, mbuff, false);\n             }\n             if (sourceid == Corsair.BATTLE_SHIP) {\n-                applyto.announce(MaplePacketCreator.skillCooldown(5221999, applyto.getBattleshipHp() / 10));\n+                applyto.announceBattleshipHp();\n             }\n         }\n     }"}, {"sha": "73138e6d5d0a0266f53f14bb02874484cfb28036", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -275,6 +275,7 @@ public void broadcastMobHpBar(MapleCharacter from) {\n      *\n      * @param from the player that dealt the damage\n      * @param damage\n+     * @param stayAlive\n      */\n     public synchronized void damage(MapleCharacter from, int damage, boolean stayAlive) {\n         Integer trueDamage = applyAndGetHpDamage(damage, stayAlive);\n@@ -293,7 +294,7 @@ public synchronized void damage(MapleCharacter from, int damage, boolean stayAli\n \n         broadcastMobHpBar(from);\n     }\n-\n+    \n     public void heal(int hp, int mp) {\n         Integer hpHealed = applyAndGetHpDamage(-hp, false);\n         if(hpHealed == null) return;\n@@ -305,7 +306,7 @@ public void heal(int hp, int mp) {\n         }\n         setMp(mp2Heal);\n         \n-        if(hp > 0) getMap().broadcastMessage(MaplePacketCreator.healMonster(getObjectId(), hp));\n+        if(hp > 0) getMap().broadcastMessage(MaplePacketCreator.healMonster(getObjectId(), hp, getHp(), getMaxHp()));\n         \n         maxHpPlusHeal.addAndGet(hpHealed);\n         dispatchMonsterHealed(hpHealed);\n@@ -695,7 +696,7 @@ public void setControllerKnowsAboutAggro(boolean controllerKnowsAboutAggro) {\n     public boolean hasBossHPBar() {\n         return isBoss() && getTagColor() > 0;\n     }\n-\n+    \n     @Override\n     public void sendSpawnData(MapleClient c) {\n         if (!isAlive()) {"}, {"sha": "d8e2f619e9c7b8740eecca7f7f7c8ef5c2996261", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 14, "deletions": 16, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -470,26 +470,26 @@ private Point calcPointBelow(Point initial) {\n     public void generateMapDropRangeCache() {\n         bndLock.lock();\n         try {\n-            Integer mapId = Integer.valueOf(mapid);\n-            Pair<Integer, Integer> bounds = dropBoundsCache.get(mapId);\n+            Pair<Integer, Integer> bounds = dropBoundsCache.get(mapid);\n             \n             if(bounds != null) {\n                 xLimits = bounds;\n             } else {\n+                // assuming MINIMAP always have an equal-greater picture representation of the map area (players won't walk beyond the area known by the minimap).\n                 Point lp = new Point(mapArea.x, mapArea.y), rp = new Point(mapArea.x + mapArea.width, mapArea.y), fallback = new Point(mapArea.x + (mapArea.width / 2), mapArea.y);\n \n-                lp = bsearchDropPos(lp, fallback);\n-                rp = bsearchDropPos(rp, fallback);\n+                lp = bsearchDropPos(lp, fallback);  // approximated leftmost fh node position\n+                rp = bsearchDropPos(rp, fallback);  // approximated rightmost fh node position\n \n-                xLimits = new Pair<>(lp.x, rp.x);\n-                dropBoundsCache.put(mapId, xLimits);\n+                xLimits = new Pair<>(lp.x + 14, rp.x - 14);\n+                dropBoundsCache.put(mapid, xLimits);\n             }\n         } finally {\n             bndLock.unlock();\n         }\n     }\n     \n-    public Point bsearchDropPos(Point initial, Point fallback) {\n+    private Point bsearchDropPos(Point initial, Point fallback) {\n         Point res, dropPos = null;\n                 \n         int awayx = fallback.x;\n@@ -1304,13 +1304,6 @@ public void killMonsterWithDrops(int mobId) {\n         }\n     }\n     \n-    public void monsterCloakingDevice() {\n-        for (MapleMapObject monstermo : getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.MONSTER))) {\n-            MapleMonster monster = (MapleMonster) monstermo;\n-            broadcastMessage(MaplePacketCreator.makeMonsterInvisible(monster));\n-        }\n-    }\n-\n     public void softKillAllMonsters() {\n         closeMapSpawnPoints();\n         \n@@ -1809,6 +1802,8 @@ public void sendPackets(MapleClient c) {\n                 monsterItemDrop(monster, monster.getDropPeriodTime() / 3);\n             } else if (monster.getId() == 9300093) {\n                 monsterItemDrop(monster, monster.getDropPeriodTime());\n+            } else if (monster.getId() == 9400326 || monster.getId() == 9400331 || monster.getId() == 9400336) {\n+                monsterItemDrop(monster, monster.getDropPeriodTime());\n             } else {\n                 FilePrinter.printError(FilePrinter.UNHANDLED_EVENT, \"UNCODED TIMED MOB DETECTED: \" + monster.getId() + \"\\r\\n\");\n             }\n@@ -2373,6 +2368,9 @@ public void run() {\n                 break;\n             }\n         }\n+        \n+        chr.removeSandboxItems();\n+        \n         if (chr.isHidden()) {\n             broadcastGMMessage(chr, MaplePacketCreator.spawnEnterPlayerMapObject(chr), false);\n             chr.announce(MaplePacketCreator.getGMEffect(0x10, (byte) 1));\n@@ -2842,11 +2840,11 @@ public MapleFootholdTree getFootholds() {\n     }\n     \n     public void setMapPointBoundings(int px, int py, int h, int w) {\n-        mapArea.setBounds(px + 80, py, w - 160, h);\n+        mapArea.setBounds(px, py, w, h);\n     }\n     \n     public void setMapLineBoundings(int vrTop, int vrBottom, int vrLeft, int vrRight) {\n-        mapArea.setBounds(vrLeft + 7, vrTop, vrRight - vrLeft - 14, vrBottom - vrTop);\n+        mapArea.setBounds(vrLeft, vrTop, vrRight - vrLeft, vrBottom - vrTop);\n     }\n     \n     /**"}, {"sha": "a054a6fe5987228687d2972553346c8347e0931c", "filename": "src/server/maps/MapleMiniDungeon.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MapleMiniDungeon.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MapleMiniDungeon.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMiniDungeon.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -58,6 +58,7 @@ public void run() {\n                     }\n                     \n                     dispose();\n+                    timeoutTask = null;\n                 } finally {\n                     lock.unlock();\n                 }"}, {"sha": "8fd9c688d229c80eec515578afe89797fb0eaaa5", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -241,8 +241,6 @@ public void buy(MapleClient c, int item, short quantity) {\n                     if (c.getPlayer().getMeso() >= price) {\n                         if (canBuy(c, newItem)) {\n                             c.getPlayer().gainMeso(-price, false);\n-                            \n-                            if(ServerConstants.USE_ANNOUNCE_SHOPITEMSOLD) announceItemSold(newItem, price);   // idea thanks to vcoc\n                             owner.gainMeso(price, true);\n                             \n                             SoldItem soldItem = new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), quantity, price);\n@@ -275,12 +273,6 @@ public void buy(MapleClient c, int item, short quantity) {\n         }\n     }\n     \n-    private void announceItemSold(Item item, int mesos) {\n-        String qtyStr = (item.getQuantity() > 1) ? \" (qty. \" + item.getQuantity() + \")\" : \"\";\n-        \n-        owner.dropMessage(6, \"[PLAYER SHOP] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n-    }\n-\n     public void broadcastToVisitors(final byte[] packet) {\n         visitorLock.lock();\n         try {"}, {"sha": "0cfcae201e75c6925f9acf6a62487c3f2a188706", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 28, "deletions": 13, "changes": 41, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1883,13 +1883,25 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 mplew.writeInt(CHAR_MAGIC_SPAWN);\n                 mplew.writeShort(0);\n                 mplew.write(0);\n-                final Item mount = chr.getInventory(MapleInventoryType.EQUIPPED).getItem((short) -18);\n-                if (chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null && mount != null) {\n-                        mplew.writeInt(mount.getItemId());\n-                        mplew.writeInt(1004);\n+                \n+                Integer bv = chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING);\n+                if (bv != null) {\n+                        if(bv.equals(Corsair.BATTLE_SHIP)) {\n+                                mplew.writeInt(1932000);\n+                                mplew.writeInt(Corsair.BATTLE_SHIP);\n+                        } else {\n+                                final Item mount = chr.getInventory(MapleInventoryType.EQUIPPED).getItem((short) -18);\n+                                if(mount != null) {\n+                                        mplew.writeInt(mount.getItemId());\n+                                        mplew.writeInt(1004);\n+                                } else {\n+                                        mplew.writeLong(0);\n+                                }\n+                        }\n                 } else {\n                         mplew.writeLong(0);\n                 }\n+                \n                 mplew.writeInt(CHAR_MAGIC_SPAWN);\n                 mplew.skip(9);\n                 mplew.writeInt(CHAR_MAGIC_SPAWN);\n@@ -2107,7 +2119,7 @@ private static void addMarriageRingLook(final MaplePacketLittleEndianWriter mple\n                 if (ring != null) {\n                         mplew.writeInt(chr.getId());\n                         mplew.writeInt(ring.getPartnerChrId());\n-                        mplew.writeInt(ring.getRingId());\n+                        mplew.writeInt(ring.getItemId());\n                 }\n         }\n \n@@ -3967,21 +3979,24 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n         }\n \n         public static byte[] damageMonster(int oid, int damage) {\n+                return damageMonster(oid, damage, 0, 0);\n+        }\n+        \n+        public static byte[] healMonster(int oid, int heal, int curhp, int maxhp) {\n+                return damageMonster(oid, -heal, curhp, maxhp);\n+        }\n+        \n+        private static byte[] damageMonster(int oid, int damage, int curhp, int maxhp) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.DAMAGE_MONSTER.getValue());\n                 mplew.writeInt(oid);\n                 mplew.write(0);\n                 mplew.writeInt(damage);\n-                mplew.write(0);\n-                mplew.write(0);\n-                mplew.write(0);\n+                mplew.writeInt(curhp);\n+                mplew.writeInt(maxhp);\n                 return mplew.getPacket();\n         }\n-\n-        public static byte[] healMonster(int oid, int heal) {\n-                return damageMonster(oid, -heal);\n-        }\n-\n+        \n         public static byte[] updateBuddylist(Collection<BuddylistEntry> buddylist) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.BUDDYLIST.getValue());"}, {"sha": "c716d243fe231db382faeb46971301a0a42f1a1e", "filename": "wz/Item.wz/Etc/0403.img.xml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Item.wz/Etc/0403.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Item.wz/Etc/0403.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Etc/0403.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -11223,6 +11223,7 @@\n       </canvas>\n       <int name=\"price\" value=\"1\"/>\n       <int name=\"notSale\" value=\"1\"/>\n+      <int name=\"pquest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04032095\">\n@@ -11237,6 +11238,7 @@\n       </canvas>\n       <int name=\"price\" value=\"1\"/>\n       <int name=\"notSale\" value=\"1\"/>\n+      <int name=\"pquest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04032096\">"}, {"sha": "e4472f2a7c65f107188a5545e4528490bb020509", "filename": "wz/Map.wz/Map/Map2/209000000.img.xml", "status": "modified", "additions": 2411, "deletions": 2409, "changes": 4820, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map2/209000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map2/209000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/209000000.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118"}, {"sha": "1ce64cc06e8c22843741a9992ba95c239e44cca8", "filename": "wz/Map.wz/Map/Map8/889100001.img.xml", "status": "modified", "additions": 8, "deletions": 16, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100001.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100001.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/889100001.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1112,29 +1112,21 @@\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"reactor\">\n-    <imgdir name=\"0\">\n-      <string name=\"id\" value=\"8892000\"/>\n+    <imgdir name=\"1\">\n+      <string name=\"id\" value=\"9400301\"/>\n       <int name=\"x\" value=\"-178\"/>\n       <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"snow00\"/>\n+      <string name=\"name\" value=\"snowmanFakeCollector\"/>\n     </imgdir>\n-    <imgdir name=\"1\">\n-      <string name=\"id\" value=\"8892001\"/>\n-      <int name=\"x\" value=\"-188\"/>\n-      <int name=\"y\" value=\"146\"/>\n+    <imgdir name=\"0\">\n+      <string name=\"id\" value=\"9400300\"/>\n+      <int name=\"x\" value=\"-178\"/>\n+      <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"mob00\"/>\n-    </imgdir>\n-    <imgdir name=\"2\">\n-      <string name=\"id\" value=\"8898000\"/>\n-      <int name=\"x\" value=\"-182\"/>\n-      <int name=\"y\" value=\"31\"/>\n-      <int name=\"reactorTime\" value=\"0\"/>\n-      <int name=\"f\" value=\"1\"/>\n-      <string name=\"name\" value=\"snow01\"/>\n+      <string name=\"name\" value=\"snowmanCollector\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"snowMan\">"}, {"sha": "c8c456efb218daa2f795705eafbd21de19bb4ee0", "filename": "wz/Map.wz/Map/Map8/889100011.img.xml", "status": "modified", "additions": 6, "deletions": 14, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100011.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100011.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/889100011.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1281,28 +1281,20 @@\n   </imgdir>\n   <imgdir name=\"reactor\">\n     <imgdir name=\"0\">\n-      <string name=\"id\" value=\"8892002\"/>\n+      <string name=\"id\" value=\"9400300\"/>\n       <int name=\"x\" value=\"-178\"/>\n       <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"snow10\"/>\n+      <string name=\"name\" value=\"snowmanCollector\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"id\" value=\"8892003\"/>\n-      <int name=\"x\" value=\"-188\"/>\n-      <int name=\"y\" value=\"146\"/>\n+      <string name=\"id\" value=\"9400301\"/>\n+      <int name=\"x\" value=\"-178\"/>\n+      <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"mob10\"/>\n-    </imgdir>\n-    <imgdir name=\"2\">\n-      <string name=\"id\" value=\"8898000\"/>\n-      <int name=\"x\" value=\"-182\"/>\n-      <int name=\"y\" value=\"31\"/>\n-      <int name=\"reactorTime\" value=\"0\"/>\n-      <int name=\"f\" value=\"1\"/>\n-      <string name=\"name\" value=\"snow01\"/>\n+      <string name=\"name\" value=\"snowmanFakeCollector\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"snowMan\">"}, {"sha": "3694a2463f6e0e05d59d3c49f3bca30b939eb4af", "filename": "wz/Map.wz/Map/Map8/889100021.img.xml", "status": "modified", "additions": 6, "deletions": 14, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100021.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Map.wz/Map/Map8/889100021.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/889100021.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -1225,28 +1225,20 @@\n   </imgdir>\n   <imgdir name=\"reactor\">\n     <imgdir name=\"0\">\n-      <string name=\"id\" value=\"8892004\"/>\n+      <string name=\"id\" value=\"9400300\"/>\n       <int name=\"x\" value=\"-178\"/>\n       <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"snow20\"/>\n+      <string name=\"name\" value=\"snowmanCollector\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"id\" value=\"8892005\"/>\n-      <int name=\"x\" value=\"-188\"/>\n-      <int name=\"y\" value=\"146\"/>\n+      <string name=\"id\" value=\"9400301\"/>\n+      <int name=\"x\" value=\"-178\"/>\n+      <int name=\"y\" value=\"32\"/>\n       <int name=\"reactorTime\" value=\"-1\"/>\n       <int name=\"f\" value=\"0\"/>\n-      <string name=\"name\" value=\"mob20\"/>\n-    </imgdir>\n-    <imgdir name=\"2\">\n-      <string name=\"id\" value=\"8898000\"/>\n-      <int name=\"x\" value=\"-182\"/>\n-      <int name=\"y\" value=\"31\"/>\n-      <int name=\"reactorTime\" value=\"0\"/>\n-      <int name=\"f\" value=\"1\"/>\n-      <string name=\"name\" value=\"snow01\"/>\n+      <string name=\"name\" value=\"snowmanFakeCollector\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"snowMan\">"}, {"sha": "c38df3af54fc294b59de87575b312fef4f9b79b7", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -27173,7 +27173,6 @@\n   <imgdir name=\"28002\">\n     <imgdir name=\"0\">\n       <int name=\"npc\" value=\"9105003\"/>\n-      <string name=\"end\" value=\"2008123100\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n       <int name=\"npc\" value=\"2020005\"/>\n@@ -27188,7 +27187,6 @@\n   <imgdir name=\"28003\">\n     <imgdir name=\"0\">\n       <int name=\"npc\" value=\"2020005\"/>\n-      <string name=\"end\" value=\"2008123100\"/>\n       <imgdir name=\"quest\">\n         <imgdir name=\"0\">\n           <int name=\"id\" value=\"28002\"/>\n@@ -27212,15 +27210,15 @@\n     </imgdir>\n     <imgdir name=\"0\">\n       <int name=\"npc\" value=\"9105003\"/>\n-      <string name=\"end\" value=\"2008123100\"/>\n       <string name=\"startscript\" value=\"q28004s\"/>\n       <imgdir name=\"quest\">\n         <imgdir name=\"0\">\n           <int name=\"id\" value=\"28003\"/>\n           <int name=\"state\" value=\"2\"/>\n         </imgdir>\n       </imgdir>\n-      <int name=\"interval\" value=\"0\"/>\n+      <int name=\"lvmin\" value=\"21\"/>\n+      <int name=\"lvmax\" value=\"51\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"28102\">"}, {"sha": "9779e1a01ec19675986fe7f388aee7623bf4208b", "filename": "wz/Reactor.wz/9400300.img.xml", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Reactor.wz/9400300.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Reactor.wz/9400300.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Reactor.wz/9400300.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"9400300.img\">\n+  <imgdir name=\"info\">\n+    <string name=\"info\" value=\"\ub85c\ubbf8\uc624\uc640\uc904\ub9ac\uc5e3:\ube44\uc774\ucee4\"/>\n+  </imgdir>\n+  <imgdir name=\"0\">\n+    <canvas name=\"0\" width=\"1\" height=\"1\">\n+      <vector name=\"origin\" x=\"33\" y=\"80\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+    <imgdir name=\"event\">\n+      <imgdir name=\"0\">\n+        <int name=\"type\" value=\"100\"/>\n+        <int name=\"state\" value=\"0\"/>\n+        <int name=\"0\" value=\"4032094\"/>\n+        <int name=\"1\" value=\"1\"/>\n+        <vector name=\"lt\" x=\"-220\" y=\"-24\"/>\n+        <vector name=\"rb\" x=\"220\" y=\"9\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"hit\">\n+      <uol name=\"0\" value=\"../0\"/>\n+    </imgdir>\n+  </imgdir>\n+  <imgdir name=\"1\">\n+    <canvas name=\"0\" width=\"67\" height=\"81\">\n+      <vector name=\"origin\" x=\"33\" y=\"80\"/>\n+      <int name=\"z\" value=\"0\"/>\n+      <int name=\"delay\" value=\"150\"/>\n+    </canvas>\n+    <imgdir name=\"event\">\n+      <imgdir name=\"0\">\n+        <int name=\"type\" value=\"101\"/>\n+        <int name=\"state\" value=\"1\"/>\n+      </imgdir>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "cd4c01d308bcd355ad3c73c69721975badb33632", "filename": "wz/Reactor.wz/9400301.img.xml", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Reactor.wz/9400301.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/Reactor.wz/9400301.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Reactor.wz/9400301.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"9400301.img\">\n+  <imgdir name=\"info\">\n+    <string name=\"info\" value=\"\ub85c\ubbf8\uc624\uc640\uc904\ub9ac\uc5e3:\ube44\uc774\ucee4\"/>\n+  </imgdir>\n+  <imgdir name=\"0\">\n+    <canvas name=\"0\" width=\"1\" height=\"1\">\n+      <vector name=\"origin\" x=\"33\" y=\"80\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+    <imgdir name=\"event\">\n+      <imgdir name=\"0\">\n+        <int name=\"type\" value=\"100\"/>\n+        <int name=\"state\" value=\"0\"/>\n+        <int name=\"0\" value=\"4032095\"/>\n+        <int name=\"1\" value=\"1\"/>\n+        <vector name=\"lt\" x=\"-220\" y=\"-24\"/>\n+        <vector name=\"rb\" x=\"220\" y=\"9\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"hit\">\n+      <uol name=\"0\" value=\"../0\"/>\n+    </imgdir>\n+  </imgdir>\n+  <imgdir name=\"1\">\n+    <canvas name=\"0\" width=\"67\" height=\"81\">\n+      <vector name=\"origin\" x=\"33\" y=\"80\"/>\n+      <int name=\"z\" value=\"0\"/>\n+      <int name=\"delay\" value=\"150\"/>\n+    </canvas>\n+    <imgdir name=\"event\">\n+      <imgdir name=\"0\">\n+        <int name=\"type\" value=\"101\"/>\n+        <int name=\"state\" value=\"1\"/>\n+      </imgdir>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "5b25c7751f417010849d97bd080cfb651c87e5d6", "filename": "wz/String.wz/Map.img.xml", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/String.wz/Map.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/dddfdcf315ed69d3c599b4658bb0f0e72865d118/wz/String.wz/Map.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Map.img.xml?ref=dddfdcf315ed69d3c599b4658bb0f0e72865d118", "patch": "@@ -8614,33 +8614,43 @@\n     </imgdir>\n     <imgdir name=\"889100000\">\n       <string name=\"mapName\" value=\"Entrance - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100001\">\n       <string name=\"mapName\" value=\"Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100002\">\n       <string name=\"mapName\" value=\"Exit - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100010\">\n       <string name=\"mapName\" value=\"Entrance - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100011\">\n       <string name=\"mapName\" value=\"Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100012\">\n       <string name=\"mapName\" value=\"Exit - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100020\">\n       <string name=\"mapName\" value=\"Entrance - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100021\">\n       <string name=\"mapName\" value=\"Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100022\">\n       <string name=\"mapName\" value=\"Exit - Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"889100100\">\n       <string name=\"mapName\" value=\"Path to Snow Man&apos;s Land\"/>\n+      <string name=\"streetName\" value=\"Snow Man&apos;s Land\"/>\n     </imgdir>\n     <imgdir name=\"680100000\">\n       <string name=\"streetName\" value=\"Maple 7th Day Market\"/>"}]}]},
