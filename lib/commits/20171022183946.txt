{"fetchDate": "2019-12-19", "content": [{"sha": "08658f406b769b36a27c54a9b469b03f7b175767", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MDg2NThmNDA2Yjc2OWIzNmEyN2M1NGE5YjQ2OWIwM2Y3YjE3NTc2Nw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-10-22T18:39:46Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-10-22T18:39:46Z"}, "message": "Added Storage's \"Arrange Items\" + Fixed equipped pet on CS issue\n\nImplemented the \"Arrange Items\" Storage feature (merge & sort items on the Storage). Fixed items from different ownerships being merged together when trying to swap their positions. Fixed a bug where putting equipped pets onto Cash Shop inventory would cause a crash the returning to the game.", "tree": {"sha": "7f765b962ef842e36d8f88b22d51c60027b97078", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/7f765b962ef842e36d8f88b22d51c60027b97078"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/08658f406b769b36a27c54a9b469b03f7b175767", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/08658f406b769b36a27c54a9b469b03f7b175767", "html_url": "https://github.com/ronancpl/HeavenMS/commit/08658f406b769b36a27c54a9b469b03f7b175767", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/08658f406b769b36a27c54a9b469b03f7b175767/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d91c8934008a07ae856bd03b9c43cd704af3867e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/d91c8934008a07ae856bd03b9c43cd704af3867e", "html_url": "https://github.com/ronancpl/HeavenMS/commit/d91c8934008a07ae856bd03b9c43cd704af3867e"}], "stats": {"total": 449, "additions": 436, "deletions": 13}, "files": [{"sha": "6b2f953da466da6b48f7fe462915b779fc00acb8", "filename": "build/built-jar.properties", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/built-jar.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/built-jar.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/built-jar.properties?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -1,4 +1,4 @@\n-#Sun, 22 Oct 2017 01:52:47 -0200\n+#Sun, 22 Oct 2017 15:23:02 -0200\n \n \n C\\:\\\\Nexon\\\\MapleSolaxia\\\\MapleSolaxiaV2="}, {"sha": "b9423ca39b5857a2330b9b5b06a5b12e375862f9", "filename": "build/classes/client/MapleCharacter.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/client/MapleCharacter.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/client/MapleCharacter.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "32e09704ad7b334f0ec5202d08a54b3c1cfcade9", "filename": "build/classes/client/inventory/MapleInventory.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/client/inventory/MapleInventory.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/client/inventory/MapleInventory.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/inventory/MapleInventory.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "76d1995797d33562e01c593b5b0a2bb73dc4efc1", "filename": "build/classes/constants/ServerConstants.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/constants/ServerConstants.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/constants/ServerConstants.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/constants/ServerConstants.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "114ffd674ba73ec050fc54611fed8fe80de62ed9", "filename": "build/classes/net/server/channel/handlers/CashOperationHandler.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/net/server/channel/handlers/CashOperationHandler.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/net/server/channel/handlers/CashOperationHandler.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/CashOperationHandler.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "1bac9da35919287a4dcbb8be2635cda1b48a6355", "filename": "build/classes/net/server/channel/handlers/StorageHandler.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/net/server/channel/handlers/StorageHandler.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/net/server/channel/handlers/StorageHandler.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/StorageHandler.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "fbe6ba30097a85711526034b30936f577879973d", "filename": "build/classes/server/MapleInventoryManipulator.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleInventoryManipulator.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleInventoryManipulator.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/MapleInventoryManipulator.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "b5893bcb37efb97efc386da89bf30eb522b1c0e1", "filename": "build/classes/server/MapleStorage$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleStorage$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleStorage$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/MapleStorage$1.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "195885c3b794846c646a408c693aa89be12c8384", "filename": "build/classes/server/MapleStorage.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleStorage.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/server/MapleStorage.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/MapleStorage.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "b97d61561c21dc5b9b3d6f1f92d5f19d11496f99", "filename": "build/classes/tools/MaplePacketCreator$2.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/tools/MaplePacketCreator$2.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/tools/MaplePacketCreator$2.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/tools/MaplePacketCreator$2.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "c7091612ea2ed634f9cd161d84977d33413a99b5", "filename": "build/classes/tools/MaplePacketCreator.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/tools/MaplePacketCreator.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/build/classes/tools/MaplePacketCreator.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/tools/MaplePacketCreator.class?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "b93b8c14af74207b24c8841beb3dec105afe7f24", "filename": "dist/MapleSolaxia.jar", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/dist/MapleSolaxia.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/dist/MapleSolaxia.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/dist/MapleSolaxia.jar?ref=08658f406b769b36a27c54a9b469b03f7b175767"}, {"sha": "5acd8fae8b887a877999939da5c93018fc961b5f", "filename": "docs/feature_list.txt", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/docs/feature_list.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/docs/feature_list.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.txt?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -43,6 +43,8 @@ Cash & Items:\n * EXP/DROP coupons now appears as a buff effect when on active time.\n * Great deal of cash items functional.\n * New scroll: antibanish. For use only in cases where bosses send a player back to town.\n+* Inventory system properly checks for item slot free space and ownership.\n+* Storage with \"Arrange Items\" feature functional.\n \n PQ potentials:\n * Lobby system - Multiple PQ instances on same channel."}, {"sha": "2fd24019d71107535fde42f20dffe8f333a4f9da", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -592,8 +592,14 @@ Adicionado contador de buscas por itens realizados pelos jogadores ao usar Owl.\n Consertado Roaring Tiger Messenger aparecendo fora da tela ao final da anima\ufffd\ufffdo.\n Consertado bugs envolvendo ganho de EXP em party, para casos onde o level do mob alvo \ufffd bem maior que o do atacante/leecher.\n \n-21 - 22 Outubro 2017,\n+20 - 21 Outubro 2017,\n Bonus de Map chair rearranjado como uma skill, buffando jogador no momento que a codi\ufffd\ufffdo de ativa\ufffd\ufffdo \ufffd atingida.\n Hired Merchant agora verifica devidamente se jogador possui slot antes de liberar a compra de um item.\n Pequeno conserto de acesso concorrente com o Storage.\n-Corrigido Map chair n\ufffdo removendo task corretamente caso jogador mude de mapa inesperadamente.\n\\ No newline at end of file\n+Corrigido Map chair n\ufffdo removendo task corretamente caso jogador mude de mapa inesperadamente.\n+\n+22 Outubro 2017,\n+Corrigido itens com ownership diferente sendo agrupados num mesmo slot, perdendo a referencia de dono.\n+Implementado feature \"Arrange Items\" do MapleStorage. Ele faz os devidos agrupamentos de itens e organiza os itens do storage.\n+Corrigido storage mesclando itens que deveriam ser \ufffdnicos (que n\ufffdo poderiam haver mais de um num mesmo slot, ou no invent\ufffdrio do jogador).\n+Corrigido bug onde colocar um pet equipado no Cash Inventory e voltar ao jogo causaria crash no jogador.\n\\ No newline at end of file"}, {"sha": "5b4a228d8126a33e6bfb772cef634ed58ab97069", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -2,6 +2,15 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"2\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group/>\n+        <group>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/PlayerLoggedinHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/command/Commands.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/CashOperationHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/requirements/QuestRequirement.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/InventoryMergeHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleStorage.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleStorageInventory.java</file>\n+        </group>\n     </open-files>\n </project-private>"}, {"sha": "5aff74185dbc21c28313e11482150b73ed4f3494", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -3770,9 +3770,9 @@ public int getItemQuantity(int itemid, boolean checkEquipped) {\n     }\n     \n     public int getCleanItemQuantity(int itemid, boolean checkEquipped) {\n-        int possesed = inventory[ii.getInventoryType(itemid).ordinal()].countCleanById(itemid);\n+        int possesed = inventory[ii.getInventoryType(itemid).ordinal()].countNotOwnedById(itemid);\n         if (checkEquipped) {\n-            possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countCleanById(itemid);\n+            possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countNotOwnedById(itemid);\n         }\n         return possesed;\n     }\n@@ -4224,7 +4224,7 @@ public byte getPetIndex(int petId) {\n             petLock.unlock();\n         }\n     }\n-\n+    \n     public byte getPetIndex(MaplePet pet) {\n         petLock.lock();\n         try {"}, {"sha": "2e106ce84a5c51c13cf0f01258fd7b7bf51a03ad", "filename": "src/client/inventory/MapleInventory.java", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/client/inventory/MapleInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/client/inventory/MapleInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventory.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -104,8 +104,9 @@ public Item findById(int itemId) {\n     }\n     \n     public Item findByName(String name) {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         for (Item item : list()) {\n-            String itemName = MapleItemInformationProvider.getInstance().getName(item.getItemId());\n+            String itemName = ii.getName(item.getItemId());\n             if(itemName == null) {\n                 FilePrinter.printError(FilePrinter.EXCEPTION, \"[CRITICAL] Item \"  + item.getItemId() + \" has no name.\");\n                 continue;\n@@ -128,7 +129,7 @@ public int countById(int itemId) {\n         return qty;\n     }\n     \n-    public int countCleanById(int itemId) {\n+    public int countNotOwnedById(int itemId) {\n         int qty = 0;\n         for (Item item : list()) {\n             if (item.getItemId() == itemId && item.getOwner().equals(\"\")) {\n@@ -199,6 +200,10 @@ public void addFromDB(Item item) {\n         addSlot(item.getPosition(), item);\n     }\n \n+    private static boolean isSameOwner(Item source, Item target) {\n+        return source.getOwner().equals(target.getOwner());\n+    }\n+    \n     public void move(short sSlot, short dSlot, short slotMax) {\n         lock.lock();\n         try {\n@@ -211,7 +216,7 @@ public void move(short sSlot, short dSlot, short slotMax) {\n                 source.setPosition(dSlot);\n                 inventory.put(dSlot, source);\n                 inventory.remove(sSlot);\n-            } else if (target.getItemId() == source.getItemId() && !ItemConstants.isRechargable(source.getItemId())) {\n+            } else if (target.getItemId() == source.getItemId() && !ItemConstants.isRechargable(source.getItemId()) && isSameOwner(source, target)) {\n                 if (type.getType() == MapleInventoryType.EQUIP.getType() || type.getType() == MapleInventoryType.CASH.getType()) {\n                     swap(target, source);\n                 } else if (source.getQuantity() + target.getQuantity() > slotMax) {"}, {"sha": "50097135c98e9b54b84748bedce4e9356a03a026", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -40,7 +40,8 @@\n     public static final boolean USE_MTS = false;\n     public static final boolean USE_FAMILY_SYSTEM = false;\n     public static final boolean USE_DUEY = true;\n-    public static final boolean USE_ITEM_SORT = true;\n+    public static final boolean USE_STORAGE_ITEM_SORT = true;       //Enables storage \"Arrange Items\" feature.\n+    public static final boolean USE_ITEM_SORT = true;               //Enables inventory \"Item Sort/Merge\" feature.\n     public static final boolean USE_ITEM_SORT_BY_NAME = false;      //Item sorting based on name rather than id.\n     public static final boolean USE_PARTY_SEARCH = false;\n     public static final boolean USE_PARTY_FOR_STARTERS = true;      //Players level 10 or below can create/invite other players on the given level range."}, {"sha": "0015aff6b92128f71b4481fc7ac3481e70f22971", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -208,6 +208,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             Item item = mi.findByCashId(cashId);\n             if (item == null) {\n                 return;\n+            } else if(c.getPlayer().getPetIndex(item.getPetId()) > -1) {\n+                chr.getClient().announce(MaplePacketCreator.serverNotice(1, \"You cannot put the pet you currently equip into the Cash Shop inventory.\"));\n+                return;\n             }\n             cs.addToInventory(item);\n             mi.removeSlot(item.getPosition());"}, {"sha": "3004392491f5c2fd4108ea634268e68bac0a8dfd", "filename": "src/net/server/channel/handlers/StorageHandler.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/net/server/channel/handlers/StorageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/net/server/channel/handlers/StorageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/StorageHandler.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -28,6 +28,7 @@\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import constants.ItemConstants;\n+import constants.ServerConstants;\n import net.AbstractMaplePacketHandler;\n import server.MapleInventoryManipulator;\n import server.MapleItemInformationProvider;\n@@ -49,7 +50,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tfinal MapleStorage storage = chr.getStorage();\n \n \t\tif (chr.getLevel() < 15){\n-\t\t\tchr.message(\"You may only use this storage once you have reached level 15.\");\n+\t\t\tchr.message(\"You may only use the storage once you have reached level 15.\");\n \t\t\treturn;\n \t\t}\n \t\tif (mode == 4) { // take out\n@@ -127,6 +128,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t\t\tFilePrinter.print(FilePrinter.STORAGE + c.getAccountName() + \".txt\", c.getPlayer().getName() + \" stored \" + item.getQuantity() + \" \" + itemName + \" (\" + item.getItemId() + \")\\r\\n\");\t\n \t\t\t\t}\n \t\t\t}\n+                } else if (mode == 6) { // arrange items\n+                        if(ServerConstants.USE_STORAGE_ITEM_SORT) storage.arrangeItems(c);\n+                        c.announce(MaplePacketCreator.enableActions());\n \t\t} else if (mode == 7) { // meso\n \t\t\tint meso = slea.readInt();\n \t\t\tint storageMesos = storage.getMeso();"}, {"sha": "a8e4c9b2e16780266cc3001f11d9898be03d0225", "filename": "src/server/MapleInventoryManipulator.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleInventoryManipulator.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -353,6 +353,10 @@ public static void removeById(MapleClient c, MapleInventoryType type, int itemId\n         }\n     }\n \n+    private static boolean isSameOwner(Item source, Item target) {\n+        return source.getOwner().equals(target.getOwner());\n+    }\n+    \n     public static void move(MapleClient c, MapleInventoryType type, short src, short dst) {\n         if (src < 0 || dst < 0) {\n             return;\n@@ -374,7 +378,7 @@ public static void move(MapleClient c, MapleInventoryType type, short src, short\n         short slotMax = ii.getSlotMax(c, source.getItemId());\n         c.getPlayer().getInventory(type).move(src, dst, slotMax);\n         final List<ModifyInventory> mods = new ArrayList<>();\n-        if (!(type.equals(MapleInventoryType.EQUIP) || type.equals(MapleInventoryType.CASH)) && initialTarget != null && initialTarget.getItemId() == source.getItemId() && !ItemConstants.isRechargable(source.getItemId())) {\n+        if (!(type.equals(MapleInventoryType.EQUIP) || type.equals(MapleInventoryType.CASH)) && initialTarget != null && initialTarget.getItemId() == source.getItemId() && !ItemConstants.isRechargable(source.getItemId()) && isSameOwner(source, initialTarget)) {\n             if ((olddstQ + oldsrcQ) > slotMax) {\n                 mods.add(new ModifyInventory(1, source));\n                 mods.add(new ModifyInventory(1, initialTarget));"}, {"sha": "2acee93c47f2e0f75b3f3f55cf3c26f586ebd5b8", "filename": "src/server/MapleStorage.java", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStorage.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -27,6 +27,7 @@\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.Comparator;\n import java.util.HashMap;\n@@ -266,6 +267,23 @@ public void sendTakenOut(MapleClient c, MapleInventoryType type) {\n             lock.unlock();\n         }\n     }\n+    \n+    public void arrangeItems(MapleClient c) {\n+        lock.lock();\n+        try {\n+            MapleStorageInventory msi = new MapleStorageInventory(c, items);\n+            msi.mergeItems();\n+            items = msi.sortItems();\n+            \n+            for (MapleInventoryType type : MapleInventoryType.values()) {\n+                typeItems.put(type, new ArrayList<>(items));\n+            }\n+\n+            c.announce(MaplePacketCreator.arrangeStorage(slots, items));\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n \n     public int getMeso() {\n         return meso;"}, {"sha": "3ce1ccda4453ac375a37b441985d7b58a7d5f466", "filename": "src/server/MapleStorageInventory.java", "status": "added", "additions": 355, "deletions": 0, "changes": 355, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleStorageInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/server/MapleStorageInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStorageInventory.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -0,0 +1,355 @@\n+/*\n+ * To change this license header, choose License Headers in Project Properties.\n+ * To change this template file, choose Tools | Templates\n+ * and open the template in the editor.\n+ */\n+\n+package server;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import constants.ItemConstants;\n+import constants.ServerConstants;\n+\n+import client.MapleClient;\n+import client.inventory.Equip;\n+import client.inventory.Item;\n+import java.util.ArrayList;\n+\n+/**\n+ *\n+ * @author RonanLana\n+ */\n+\n+class PairedQuicksort {\n+    private int i = 0;\n+    private int j = 0;\n+    private final ArrayList<Integer> intersect;\n+    MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+    \n+    private void PartitionByItemId(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (x.getItemId() > A.get(i).getItemId()) i++;\n+            while (x.getItemId() < A.get(j).getItemId()) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByName(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (ii.getName(x.getItemId()).compareTo(ii.getName(A.get(i).getItemId())) > 0) i++;\n+            while (ii.getName(x.getItemId()).compareTo(ii.getName(A.get(j).getItemId())) < 0) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByQuantity(int Esq, int Dir, ArrayList<Item> A) {\n+        Item x, w;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = A.get((i + j) / 2);\n+        do {\n+            while (x.getQuantity() > A.get(i).getQuantity()) i++;\n+            while (x.getQuantity() < A.get(j).getQuantity()) j--;\n+            \n+            if (i <= j) {\n+                w = A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+    \n+    private void PartitionByLevel(int Esq, int Dir, ArrayList<Item> A) {\n+        Equip x, w, eqpI, eqpJ;\n+\n+        i = Esq;\n+        j = Dir;\n+        \n+        x = (Equip)(A.get((i + j) / 2));\n+        \n+        do {\n+            eqpI = (Equip)A.get(i);\n+            eqpJ = (Equip)A.get(j);\n+            \n+            while (x.getLevel() > eqpI.getLevel()) i++;\n+            while (x.getLevel() < eqpJ.getLevel()) j--;\n+            \n+            if (i <= j) {\n+                w = (Equip)A.get(i);\n+                A.set(i, A.get(j));\n+                A.set(j, (Item)w);\n+\n+                i++;\n+                j--;\n+            }\n+        } while (i <= j);\n+    }\n+\n+    void MapleQuicksort(int Esq, int Dir, ArrayList<Item> A, int sort) {\n+        switch(sort) {\n+            case 3:\n+                PartitionByLevel(Esq, Dir, A);\n+                break;\n+            \n+            case 2:\n+                PartitionByName(Esq, Dir, A);\n+                break;\n+                \n+            case 1:\n+                PartitionByQuantity(Esq, Dir, A);\n+                break;\n+                    \n+            default:\n+                PartitionByItemId(Esq, Dir, A);\n+        }\n+        \n+        \n+        if (Esq < j) MapleQuicksort(Esq, j, A, sort);\n+        if (i < Dir) MapleQuicksort(i, Dir, A, sort);\n+    }\n+    \n+    public PairedQuicksort(ArrayList<Item> A, int primarySort, int secondarySort) {\n+        intersect = new ArrayList<>();\n+        \n+        if(A.size() > 0) MapleQuicksort(0, A.size() - 1, A, primarySort);\n+        \n+        intersect.add(0);\n+        for(int ind = 1; ind < A.size(); ind++) {\n+            if(A.get(ind - 1).getItemId() != A.get(ind).getItemId()) {\n+                intersect.add(ind);\n+            }\n+        }\n+        intersect.add(A.size());\n+        \n+        for(int ind = 0; ind < intersect.size() - 1; ind++) {\n+            if(intersect.get(ind + 1) > intersect.get(ind)) MapleQuicksort(intersect.get(ind), intersect.get(ind + 1) - 1, A, secondarySort);\n+        }\n+    }\n+}\n+\n+public class MapleStorageInventory {\n+    private MapleClient c;\n+    private Map<Short, Item> inventory = new LinkedHashMap<>();\n+    private byte slotLimit;\n+    \n+    public MapleStorageInventory(MapleClient c, List<Item> toSort) {\n+        this.inventory = new LinkedHashMap<>();\n+        this.slotLimit = (byte)toSort.size();\n+        this.c = c;\n+        \n+        for(Item item : toSort) {\n+            this.addItem(item);\n+        }\n+    }\n+\n+    private byte getSlotLimit() {\n+        return slotLimit;\n+    }\n+    \n+    private Collection<Item> list() {\n+        return Collections.unmodifiableCollection(inventory.values());\n+    }\n+\n+    private short addItem(Item item) {\n+        short slotId = getNextFreeSlot();\n+        if (slotId < 0 || item == null) {\n+            return -1;\n+        }\n+        addSlot(slotId, item);\n+        item.setPosition(slotId);\n+        return slotId;\n+    }\n+\n+    private static boolean isEquipOrCash(Item item) {\n+        int type = item.getItemId() / 1000000;\n+        return type == 1 || type == 5;\n+    }\n+    \n+    private static boolean isSameOwner(Item source, Item target) {\n+        return source.getOwner().equals(target.getOwner());\n+    }\n+    \n+    private void move(short sSlot, short dSlot, short slotMax) {\n+        Item source = (Item) inventory.get(sSlot);\n+        Item target = (Item) inventory.get(dSlot);\n+        if (source == null) {\n+            return;\n+        }\n+        if (target == null) {\n+            source.setPosition(dSlot);\n+            inventory.put(dSlot, source);\n+            inventory.remove(sSlot);\n+        } else if (target.getItemId() == source.getItemId() && !ItemConstants.isRechargable(source.getItemId()) && !MapleItemInformationProvider.getInstance().isPickupRestricted(source.getItemId()) && isSameOwner(source, target)) {\n+            if (isEquipOrCash(source)) {\n+                swap(target, source);\n+            } else if (source.getQuantity() + target.getQuantity() > slotMax) {\n+                short rest = (short) ((source.getQuantity() + target.getQuantity()) - slotMax);\n+                source.setQuantity(rest);\n+                target.setQuantity(slotMax);\n+            } else {\n+                target.setQuantity((short) (source.getQuantity() + target.getQuantity()));\n+                inventory.remove(sSlot);\n+            }\n+        } else {\n+            swap(target, source);\n+        }\n+    }\n+    \n+    private void moveItem(short src, short dst) {\n+        if (src < 0 || dst < 0) {\n+            return;\n+        }\n+        if(dst > this.getSlotLimit()) {\n+            return;\n+        }\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        Item source = this.getItem(src);\n+        if (source == null) {\n+            return;\n+        }\n+        short slotMax = ii.getSlotMax(c, source.getItemId());\n+        this.move(src, dst, slotMax);\n+    }\n+\n+    private void swap(Item source, Item target) {\n+        inventory.remove(source.getPosition());\n+        inventory.remove(target.getPosition());\n+        short swapPos = source.getPosition();\n+        source.setPosition(target.getPosition());\n+        target.setPosition(swapPos);\n+        inventory.put(source.getPosition(), source);\n+        inventory.put(target.getPosition(), target);\n+    }\n+\n+    private Item getItem(short slot) {\n+        return inventory.get(slot);\n+    }\n+\n+    private void addSlot(short slot, Item item) {\n+        inventory.put(slot, item);\n+    }\n+    \n+    private void removeSlot(short slot) {\n+        inventory.remove(slot);\n+    }\n+\n+    private boolean isFull() {\n+        return inventory.size() >= slotLimit;\n+    }\n+\n+    private short getNextFreeSlot() {\n+        if (isFull()) {\n+            return -1;\n+        }\n+        \n+        for (short i = 1; i <= slotLimit; i++) {\n+            if (!inventory.containsKey(i)) {\n+                return i;\n+            }\n+        }\n+        return -1;\n+    }\n+\n+    public void mergeItems() {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        Item srcItem, dstItem;\n+\n+        for(short dst = 1; dst <= this.getSlotLimit(); dst++) {\n+            dstItem = this.getItem(dst);\n+            if(dstItem == null) continue;\n+\n+            for(short src = (short)(dst + 1); src <= this.getSlotLimit(); src++) {\n+                srcItem = this.getItem(src);\n+                if(srcItem == null) continue;\n+\n+                if(dstItem.getItemId() != srcItem.getItemId()) continue;\n+                if(dstItem.getQuantity() == ii.getSlotMax(c, this.getItem(dst).getItemId())) break;\n+\n+                moveItem(src, dst);\n+            }\n+        }\n+                \n+        boolean sorted = false;\n+\n+        while (!sorted) {\n+            short freeSlot = this.getNextFreeSlot();\n+\n+            if (freeSlot != -1) {\n+                short itemSlot = -1;\n+                for (short i = (short) (freeSlot + 1); i <= this.getSlotLimit(); i = (short) (i + 1)) {\n+                    if (this.getItem(i) != null) {\n+                        itemSlot = i;\n+                        break;\n+                    }\n+                }\n+                if (itemSlot > 0) {\n+                    moveItem(itemSlot, freeSlot);\n+                } else {\n+                    sorted = true;\n+                }\n+            } else {\n+                sorted = true;\n+            }\n+        }\n+    }\n+    \n+    public List<Item> sortItems() {\n+        ArrayList<Item> itemarray = new ArrayList<>();\n+        \n+        for (short i = 1; i <= this.getSlotLimit(); i++) {\n+            Item item = this.getItem(i);\n+            if (item != null) {\n+            \titemarray.add((Item) item.copy());\n+            }\n+        }\n+        \n+        for (Item item : itemarray) {\n+            this.removeSlot(item.getPosition());\n+        }\n+        \n+        int invTypeCriteria = 1;\n+        int sortCriteria = (ServerConstants.USE_ITEM_SORT_BY_NAME == true) ? 2 : 0;\n+        PairedQuicksort pq = new PairedQuicksort(itemarray, sortCriteria, invTypeCriteria);\n+        \n+        inventory.clear();\n+        return itemarray;\n+    }\n+}"}, {"sha": "d7b01e6d5a297014c0f1b9cb68701fdcc9faec1c", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/08658f406b769b36a27c54a9b469b03f7b175767/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/08658f406b769b36a27c54a9b469b03f7b175767/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=08658f406b769b36a27c54a9b469b03f7b175767", "patch": "@@ -3177,7 +3177,23 @@ private static void writeLongMaskFromList(final MaplePacketLittleEndianWriter mp\n                 }\n                 return mplew.getPacket();\n         }\n+        \n+        public static byte[] arrangeStorage(byte slots, Collection<Item> items) {\n+                MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n \n+                mplew.writeShort(SendOpcode.STORAGE.getValue());\n+                mplew.write(0xF);\n+                mplew.write(slots);\n+                mplew.write(124);\n+                for(byte i = 0; i < 10; i++) mplew.write(0);\n+                mplew.write(items.size());\n+                for (Item item : items) {\n+                        addItemInfo(mplew, item, true);\n+                }\n+                mplew.write(0);\n+                return mplew.getPacket();\n+        }\n+        \n         /**\n          *\n          * @param oid"}]}]},
