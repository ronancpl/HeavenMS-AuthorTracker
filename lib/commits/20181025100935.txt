{"fetchDate": "2019-12-19", "content": [{"sha": "8f8cd815aa935fe0612425c48410da0ffda758d0", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6OGY4Y2Q4MTVhYTkzNWZlMDYxMjQyNWM0ODQxMGRhMGZmZGE3NThkMA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-10-25T10:09:35Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-10-25T10:09:35Z"}, "message": "PlayerNPC patch + Wedding ring effects + Bypassable PIN/PIC + SP cap\n\nFixed an issue with delayed item pickups.\nFixed ClearSlot command not removing rechargeables from inventory.\nFixed Resurrection and Hyper Body animation effect not working for other players.\nImplemented bypassable PIN/PIC, applied on accounts after a successful authentication, remaining active while activity is detected for that account.\nFixed anti-multiclient system not properly registering players logged in via all-chars-view.\nFixed cases where players still could gain EXP from much higher-leveled mobs if they were on an event instance.\nOptimized scroll result method performance.\nAdded a server flag for SP cap limit on the player's current job (missing amount are reobtained after changing jobs).\nPlayerNPCs now have overridable scripts.\nFixed some mapobject issues with PlayerNPCs, potencially leading to disappearing from maps in certain circumstances.\nFixed SpawnAllPnpcs command not properly spawning all PlayersNPCs.\nAdded extra info on Abdula, now stating whether a book can be obtained from questline or not.\nFixed marriage ring effects.\nFixed some cases where marriage rings were being able to be sent out from the character owner.\nFixed Duey allowing send untradeable items.\nNew tool: MapleWorldmapChecker. It reads Map.wz XMLs, fetching mapids not properly referenced on the worldmap nodes.", "tree": {"sha": "e3573811e6d220dda637865e422b070911d786a1", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/e3573811e6d220dda637865e422b070911d786a1"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/8f8cd815aa935fe0612425c48410da0ffda758d0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8f8cd815aa935fe0612425c48410da0ffda758d0", "html_url": "https://github.com/ronancpl/HeavenMS/commit/8f8cd815aa935fe0612425c48410da0ffda758d0", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8f8cd815aa935fe0612425c48410da0ffda758d0/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17d3ffe1c300f651fa441b7330a67a75d4bd20d2", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/17d3ffe1c300f651fa441b7330a67a75d4bd20d2", "html_url": "https://github.com/ronancpl/HeavenMS/commit/17d3ffe1c300f651fa441b7330a67a75d4bd20d2"}], "stats": {"total": 2311, "additions": 2040, "deletions": 271}, "files": [{"sha": "fe7e4107921147d71735b133a846d55ebdf2c106", "filename": ".gitignore", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/.gitignore", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/.gitignore", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/.gitignore?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -91,6 +91,10 @@\n /tools/MapleSkillMakerReagentIndexer/dist/\n /tools/MapleSkillMakerReagentIndexer/nbproject/\n \n+/tools/MapleWorldmapChecker/build/\n+/tools/MapleWorldmapChecker/dist/\n+/tools/MapleWorldmapChecker/nbproject/\n+\n /tools/SpiderDropFetcher/build/\n /tools/SpiderDropFetcher/dist/\n /tools/SpiderDropFetcher/nbproject/"}, {"sha": "3c9b4feb602ab9a9f72038bd425bf1e8807432a1", "filename": "README.md", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -7,7 +7,7 @@ Besides myself for maintaining this repository, credits are to be given to Wizet\n \n Regarding distributability and usage of the code presented here: like it was before, this MapleStory server is open-source. By that, it is meant that anyone is **free to install, use, modify and redistribute the contents**, as long as there is **no kind of commercial trading involved** and the **credits to the original creators are maintained** within the codes.\n \n-This is a NetBeans 8.0.2 Project, that MUST be built and run under JDK/JRE 7 in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n+This is a NetBeans 8.0.2 Project, that MUST be built and run under JDK/JRE 7 (1.7.0_79+) in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n \n In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of server source, in order to perceive it at it's full potential. My opinion, though! Refer to \"README_wzchanges.txt\" for more information on what has been changed from Nexon's v83 WZ files.\n \n@@ -57,7 +57,7 @@ Status: <span style=\"color:grey\">__In development (4th round)__</span>.\n \n #### Mission\n \n-With non-profitting means intended, provide nostalgic pre-BB MapleStory players world-wide a quality local server for freestyle entertainment.\n+With non-profitting means intended, provide nostalgic pre-BB maplers world-wide a quality local server for freestyle entertainment.\n \n #### Vision\n \n@@ -131,7 +131,9 @@ Hamachi is optional, though. You don't have to install Hamachi if you want to ma\n ---\n ### Installing the SERVER \n \n-Set the \"HeavenMS\" folder on a place of your preference. It is recommended to use \"C:\\Nexon\\HeavenMS\".\n+By downloading through the Github download button, you may have obtained a ZIP file with a single \"HeavenMS-master\" folder on it. EXTRACT that folder.\n+\n+For expediency, \"HeavenMS-master\" folder on this guide will be referred just as \"HeavenMS\". Rename it for convenience. Then, set \"HeavenMS\" the folder on a place of your preference. It is recommended to use \"C:\\Nexon\\HeavenMS\".\n \n Setting up the SQL: open MySQL Query Browser, then create a new session with the parameters below, then click OK.\n \n@@ -151,9 +153,11 @@ At the end of the execution of these SQLs, you should have installed a database\n \n Configure the IP you want to use for your MapleStory server in \"configuration.ini\" file, or set it as \"localhost\" if you want to run it only on your machine. Alternatively, you can use the IP given by Hamachi to use on a Hamachi network, or you can use a non-Hamachi method of port-forwarding. Neither will be approached here.\n \n+#### Open the NetBeans project\n+\n Now open NetBeans, and click \"Open a project...\" . Select then the \"HeavenMS\" folder, that should already be a project recognizable by NetBeans. If it isn't, you have a problem.\n \n-#### Inside the project, you may encounter some code errors.\n+Inside the project, you may encounter some code errors.\n \n These errors pops-up because you have not set yet the \"cores\" of the project. From the project hierarchy, right-click the project and select \"Resolve Project Problems\".\n "}, {"sha": "985b3e072945f031f43c118857d67d8558e2b390", "filename": "docs/feature_list.md", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -6,6 +6,10 @@ Ronan - Head Developer\n \n Vcoc - Freelance Developer\n \n+Thora - Contributor\n+\n+GabrielSin - Contributor\n+\n ---------------------------\n DISCLAIMER:\n ---------------------------\n@@ -58,6 +62,7 @@ Player Social Network:\n \n * Guild and Alliance system fully functional.\n * Implemented Marriage system from the ground-up (excluding character packet encoding parts that were already present, proper credits given throughout the source files).\n+* Marriage ring effects functional.\n * Beginners can create and join a \"beginner-only\" party (characters up to level 10).\n * HP bar of party members now properly calculates the HP gain from equipments.\n * Enhanced synchronization on Player Shops and Hired Merchants. Transactions made are instantly informed to the owner.\n@@ -174,7 +179,9 @@ Server potentials:\n * Both fixed and randomized versions of HP/MP growth rate available, regarding player job (enable one at ServerConstants). Placeholder for HP/MP washing feature.\n * Implemented methods to get the current Players' MaxHP/MaxMP method with equipment HP/MP gains already summed up.\n * Reallocated mapobjectids utilization throughout the source, preventing issues such as \"NPC disappearing mysteriously after some server time\" from happening.\n-* Implemented old GMS statup mechanic for novices level 10 or below. Usage of the edited localhost is mandatory on this.\n+* Implemented old GMS AP assigning for novices level 10 or below. Usage of the edited localhost is mandatory on this.\n+* Implemented SP capping for players that passed the job upgrade level. After upgrading jobs, the missing SP amount is replenished.\n+* Bypassable PIN/PIC system for players that were already authenticated and are currently loggedin and active.\n * Accounts can be created automatically when trying to login on an inexistent account -- credits to shavit.\n * Usage of Bcrypt (up-to-date) as the main password hashing algorithm, replacing old SHA's -- credits to shavit.\n \n@@ -201,8 +208,9 @@ External tools:\n * MapleArrowFetcher - Updates min/max quantity dropped on all arrows drop data, calculations based on mob level and whether it's a boss or not.\n * MapleBossHpBarFetcher - Searches the quest WZ files and reports in all relevant data regarding mobs that has a boss HP bar whilst not having a proper \"boss\" label.\n * MapleCashDropFetcher - Searches the DB for any CASH drop data entry and lists them on a report file.\n+* MapleCodeCouponGenerator - Reads the XML recipe at the input folder and loads into the DB new coupon codes bundled with all depicted items.\n * MapleCouponInstaller - Retrieves coupon info from the WZ and makes a SQL table with it. The server will use that table to gather info regarding rates and intervals.\n-* MapleDojoUpdate - Patches the dojo WZ nodes with correct script names for onUserEnter and onFirstUserEnter fields.\n+* MapleDojoUpdater - Patches the dojo WZ nodes with correct script names for onUserEnter and onFirstUserEnter fields.\n * MapleEquipmentOmnileveler - Updates the equipment WZ nodes with item level information, allowing thus access for item level and EXP info for common equipments.\n * MapleIdRetriever - Two behaviors: generates a SQL table with relation (id, name) of the handbook given as input. Given a file with names, outputs a file with ids.\n * MapleInvalidItemIdFetcher - Generates a file listing all inexistent itemid's currently laying on the DB.\n@@ -218,6 +226,7 @@ External tools:\n * MapleReactorDropFetcher - Searches the DB for reactors with drop data and reports in reactorids that are not yet coded.\n * MapleSkillMakerFetcher - Updates the DB Maker-related tables with the current info present on the WZs.\n * MapleSkillMakerReagentIndexer - Generates a new maker table describing all stat-improvements from the Maker reagents (those empowering crystals and jewels).\n+* MapleWorldmapChecker - Searches the map WZ files for map/field entries with missing tooltip informations (that would point which map the character currently is on the overworld maps).\n \n Project:\n "}, {"sha": "67dc79ce4e8c13ee1ac4ee558073342d082793e9", "filename": "docs/issues.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -14,11 +14,11 @@ Known issues:\n - Dragon Roar doesn't show the stun effect to players.\n - Some monster status such as freeze and weapon/magic reflect doesn't behave properly in certain scenarios. Freeze seems to not work on mobs with low OID or are starters from server boot time.\n - On low-end connections, things such as command summoning a player that is currently logging in (already visible to other players) may cause the player to freeze, consequently freezing the account as well since the server-side disconnection doesn't happen.\n+- Reportedly, there are cases where mob positions fail to sync between player's client-view.\n ---------------------------\n \n ---------------------------\n Missing features list:\n-- Miniroom tooltips (such as number of players in store/host awaiting game) not showing up properly.\n - Change name/World transfer.\n - Some pirate skills doesn't work for 3rd parties.\n - Cache frequently used SQL data."}, {"sha": "22fc3a580c6802ef9fa3900624b4aff375bd5757", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 34, "deletions": 1, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1381,4 +1381,37 @@ Protegido concorrentemente m\u00f3dulos de chairs.\n \n 09 Outubro 2018,\n Corrigido disease seduce n\u00e3o funcionando da forma esperada quando jogador est\u00e1 sentado.\n-Movido Dropspider para fora do c\u00f3digo-fonte do server, agora estando como uma ferramenta externa.\n\\ No newline at end of file\n+Movido Dropspider para fora do c\u00f3digo-fonte do server, agora estando como uma ferramenta externa.\n+\n+10 - 11 Outubro 2018,\n+Corrigido comando ClearSlots n\u00e3o apagando recarreg\u00e1veis do invent\u00e1rio.\n+Adicionado busca por quests no comando Search.\n+Corrigido notas musicais misturadas no mapa da harpa.\n+Corrigido certas inconsist\u00eancias com restancia\u00e7\u00e3o de jogadores, como pode ser visto ao aplicar Resurrection ou Hyper Body.\n+Implementado funcionalidade \"toggle PIN/PIC\", ap\u00f3s confirmado PIN/PIC jogador poder\u00e1 evitar reutiliz\u00e1-lo por um curto per\u00edodo de tempo.\n+Corrigido sistema anti-multicliente n\u00e3o registrando devidamente jogadores que entram via all-chars.\n+Corrigido casos onde jogadores muito abaixo do n\u00edvel de mobs ainda poderiam ganhar EXP dos mesmos, quando se est\u00e1 dentro de um evento.\n+\n+13 - 16 Outubro 2018,\n+Melhorada fun\u00e7\u00e3o que gerencia resultado no uso de scrolls.\n+Implementado nova flag que permite bloquear ganho de SP ao atingir o cap para tal job, al\u00e9m de permitir recuperar pontos de SP assim que avan\u00e7ar de job.\n+Adicionado possibilidade de overload de script para playerNPCs.\n+Nova ferramenta: MapleWorldmapChecker. Verifica arquivo Map.wz em busca de poss\u00edveis mapids que n\u00e3o constam em hierarquias superiores de worldmaps.\n+Adicionado informa\u00e7\u00e3o extra ao NPC Abdula, agora definindo skill/mastery books como sendo parte de questline quando aplic\u00e1vel.\n+Corrigido loots levando atraso arbitrariamente, devido a mudan\u00e7as anteriores no c\u00f3digo.\n+\n+17 Outubro 2018,\n+Corrigido PlayerNPCs atuando inconsistentemente, por compartilhar objectid com personagens de jogadores.\n+Corrigido comandos de colocar/retirar PlayerNPCs n\u00e3o atuando corretamente.\n+Corrigido certos casos no uso do invent\u00e1rio de cash que leva itens a n\u00e3o serem retirados pelo jogador corretamente.\n+Corrigido comando SpawnAllPnpcs n\u00e3o colocando de fato todos os personagens do servidor.\n+\n+18 Outubro 2018,\n+Corrigido efeitos de rings de casamento n\u00e3o atuando corretamente.\n+Implementado mec\u00e2nica para reconhecimento de jogadores casados, agora jogadores podem ver efeitos dos respectivos itens.\n+Removido possibilidade de colocar aneis de casamento no Cash Shop e Storage.\n+Removido possibilidade de colocar itens \"untradeable\" no Duey.\n+Removido possibilidade de preparar engagements enquanto segurando aneis de casamento.\n+\n+23 Outubro 2018,\n+Adicionado script para quest de 4o job de Cygnus Knights.\n\\ No newline at end of file"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "scripts/map/onFirstUserEnter/killing_BonusSetting.js", "status": "removed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/17d3ffe1c300f651fa441b7330a67a75d4bd20d2/scripts/map/onFirstUserEnter/killing_BonusSetting.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/17d3ffe1c300f651fa441b7330a67a75d4bd20d2/scripts/map/onFirstUserEnter/killing_BonusSetting.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onFirstUserEnter/killing_BonusSetting.js?ref=17d3ffe1c300f651fa441b7330a67a75d4bd20d2"}, {"sha": "8b0ccf4333241799254195e709fcb1f6565edd8d", "filename": "scripts/map/onFirstUserEnter/killing_MapSetting.js", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/17d3ffe1c300f651fa441b7330a67a75d4bd20d2/scripts/map/onFirstUserEnter/killing_MapSetting.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/17d3ffe1c300f651fa441b7330a67a75d4bd20d2/scripts/map/onFirstUserEnter/killing_MapSetting.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onFirstUserEnter/killing_MapSetting.js?ref=17d3ffe1c300f651fa441b7330a67a75d4bd20d2", "patch": "@@ -1,12 +0,0 @@\n-//importPackage(Packages.tools);\n-\n-function start(ms) { \n-    //var pq = ms.getPyramid();\n-    //ms.getPlayer().resetEnteredScript();\n-    //ms.getClient().announce(MaplePacketCreator.getClock(pq.timer()));\n-}\n-/*\n-killing/first/stage\n-killing/first/number/\n-killing/first/start\n-*/\n\\ No newline at end of file"}, {"sha": "b23d49df236020a5880864e28e9020931e79d645", "filename": "scripts/npc/1092007.js", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/1092007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/1092007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1092007.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -17,7 +17,7 @@ function action(mode, type, selection){\n         cm.dispose();\n     }\n     else{\n-        if (mode == 0 && status == 0){\n+        if (mode == 0 && type > 0){\n             cm.dispose();\n             return;\n         }\n@@ -31,11 +31,10 @@ function action(mode, type, selection){\n             if (cm.getQuestStatus(2175) == 1){\n                 if (cm.getPlayer().canHold(2030019)){\n                     cm.sendOk(\"Please take this #b#t2030019##k, it will make your life a lot easier.  #i2030019#\");\n-                    cm.gainItem(2030019, 1);\n                 }\n                 else{\n                     cm.sendOk(\"No free inventory spot available. Please make room in your USE inventory first.\");\n-                    cm.dipose();\n+                    cm.dispose();\n                 }\n             }\n             else{\n@@ -44,6 +43,7 @@ function action(mode, type, selection){\n             }\n         }\n         else if (status == 1){\n+            cm.gainItem(2030019, 1);\n             cm.warp(100000006, 0);\n             cm.dispose();\n         }"}, {"sha": "903fe7481d9f45d06d94cfbe3262fc902c0a18e7", "filename": "scripts/npc/1104002.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/1104002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/1104002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1104002.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -47,12 +47,12 @@ function action(mode, type, selection) {\n     \n                 if(status == 0) {\n                         if(!cm.isQuestStarted(20407)) {\n-                            cm.sendOk(\"... Knight, you still #bseem unsure to face this fight#k, don't you? There's no grace in challenging someone when they are still not mentally ready for the battle. Talk your peace to that big clumsy bird of yours, maybe it'll put some guts on you.\");\n-                            cm.dispose();\n-                            return;\n+                                cm.sendOk(\"... Knight, you still #bseem unsure to face this fight#k, don't you? There's no grace in challenging someone when they are still not mentally ready for the battle. Talk your peace to that big clumsy bird of yours, maybe it'll put some guts on you.\");\n+                                cm.dispose();\n+                                return;\n                         }\n                     \n-                        cm.sendAcceptDecline(\"Hahahahaha! This place's Empress is already under my domain, that's surely a great advance on the #bBlack Wings#k' overthrow towards Maple World... And you, there? Still wants to face us? Or, better yet, #rfeel fancy to join us#k since there's nothing more you can do?\");\n+                        cm.sendAcceptDecline(\"Hahahahaha! This place's Empress is already under my domain, that's surely a great advance on the #bBlack Wings#k' overthrow towards Maple World... And you, there? Still wants to face us? Or, better yet, since you seem strong enough to be quite a supplementary reinforcement at our service, #rwill you meet our expectations and fancy joining us#k since there's nothing more you can do?\");\n                 } else if (status == 1) {\n                         cm.sendOk(\"Heh, cowards have no place on the #rBlack Mage's#k army. Begone!\");\n                         cm.dispose();"}, {"sha": "7c43a161baf48c1e3accd0fad4492d7f5e5fb560", "filename": "scripts/npc/2012027.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012027.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012027.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012027.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'C';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "90e0006589244c0124631a48be4568f20de8af8e", "filename": "scripts/npc/2012028.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012028.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012028.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012028.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'D';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "41b10d0867d76dd7ca6a9aa5bac18244cefee072", "filename": "scripts/npc/2012029.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012029.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012029.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012029.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'E';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "3e9dfb80e910b9bdfecb1aae8231543543b1f523", "filename": "scripts/npc/2012030.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012030.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012030.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012030.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'F';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "4e8946e69a6dced133760ec684b03a7236a17cd1", "filename": "scripts/npc/2012031.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012031.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012031.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012031.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'G';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "949480f276635613ef877d2f53c921ff968a46d0", "filename": "scripts/npc/2012032.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012032.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012032.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012032.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'A';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "98c196d0547055d6f499cb7cb0a882752266b061", "filename": "scripts/npc/2012033.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012033.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2012033.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012033.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,7 @@ importPackage(Packages.tools);\n \n var status;\n var harpNote = 'B';\n-var harpSounds = [\"do\", \"la\", \"mi\", \"pa\", \"re\", \"si\", \"sol\"];\n+var harpSounds = [\"do\", \"re\", \"mi\", \"pa\", \"sol\", \"la\", \"si\"];   // musical order detected thanks to Arufonsu\n var harpSong = \"CCGGAAGFFEEDDC|GGFFEED|GGFFEED|CCGGAAGFFEEDDC|\";\n  \n function start() {"}, {"sha": "e4387c1f9834085316d065dfbdd174ed050db1ea", "filename": "scripts/npc/2030011.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2030011.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2030011.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030011.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -29,6 +29,6 @@ function start() {\n     cm.removeAll(4001015);\n     cm.removeAll(4001016);\n     cm.removeAll(4001018);\n-    cm.sendSimple(\"See you next time.\");\n+    cm.sendOk(\"See you next time.\");\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "0a88cb81aa984a27bf7e42320cd050dd0e9a03ee", "filename": "scripts/npc/2082003.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2082003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/2082003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2082003.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1,5 +1,5 @@\n function start() {\n-cm.sendSimple(\"If you had wings, I'm sure you could go there.  But, that alone won't be enough.  If you want to fly though the wind that's sharper than a blade, you'll need tough scales as well.  I'm the only Halfling left that knows the way back... If you want to go there, I can transform you.  No matter what you are, for this moment, you will become a #bDragon#k...\\r\\n #L0##bI want to become a dragon.#k#l\");\n+    cm.sendSimple(\"If you had wings, I'm sure you could go there.  But, that alone won't be enough.  If you want to fly though the wind that's sharper than a blade, you'll need tough scales as well.  I'm the only Halfling left that knows the way back... If you want to go there, I can transform you.  No matter what you are, for this moment, you will become a #bDragon#k...\\r\\n #L0##bI want to become a dragon.#k#l\");\n }\n \n function action(m, t, s) {"}, {"sha": "b7e8d3b4f3d7a3069e29b2baee1e52306f33c9bc", "filename": "scripts/npc/9201002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201002.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -199,7 +199,7 @@ function action(mode, type, selection) {\n                     } else {\n                         var placeTime = cserv.getWeddingReservationTimeLeft(wid);\n \n-                        cm.sendOk(\"Have patience. Your wedding is set to happen at the #r\" + placeTime + \"#k.\");\n+                        cm.sendOk(\"Have patience. Your wedding is set to happen at the #r\" + placeTime + \"#k. Don't forget the wedding garment.\");\n                         cm.dispose();\n                     }\n                 } else {"}, {"sha": "613715d0865d0b65b1ff8a16bc6222d179971c28", "filename": "scripts/npc/9201005.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201005.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -132,7 +132,7 @@ function action(mode, type, selection) {\n                             if(weddingId > 0) {\n                                 if(cserv.isWeddingReserved(weddingId)) {    // registration check\n                                     var placeTime = cserv.getWeddingReservationTimeLeft(weddingId);\n-                                    cm.sendOk(\"Your wedding is set to start at the #r\" + placeTime + \"#k. Don't be late!\");\n+                                    cm.sendOk(\"Your wedding is set to start at the #r\" + placeTime + \"#k. Get formally dressed and don't be late!\");\n                                 } else {\n                                     var partner = wserv.getPlayerStorage().getCharacterById(cm.getPlayer().getPartnerId());\n                                     if(partner == null) {\n@@ -177,10 +177,10 @@ function action(mode, type, selection) {\n                                             var placeTime = cserv.getWeddingReservationTimeLeft(weddingId);\n \n                                             var wedType = weddingType ? \"Premium\" : \"Regular\";\n-                                            cm.sendOk(\"You both have received 15 Wedding Tickets, to be given to your guests. #bDouble-click the ticket#k to send it to someone. Invitations can only be sent #rbefore the wedding start time#k. Your #b\" + wedType + \" wedding#k is set to start at the #r\" + placeTime + \"#k. Don't be late!\");\n+                                            cm.sendOk(\"You both have received 15 Wedding Tickets, to be given to your guests. #bDouble-click the ticket#k to send it to someone. Invitations can only be sent #rbefore the wedding start time#k. Your #b\" + wedType + \" wedding#k is set to start at the #r\" + placeTime + \"#k. Get formally dressed and don't be late!\");\n \n-                                            player.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Don't be late!\");\n-                                            partner.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Don't be late!\");\n+                                            player.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Get dressed and don't be late!\");\n+                                            partner.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Get dressed and don't be late!\");\n \n                                             if(!hasSuitForWedding(player)) {\n                                                 player.dropMessage(5, \"Wedding Assistant: Please purchase a wedding garment before showing up for the ceremony. One can be bought at the Wedding Shop left-most Amoria.\");"}, {"sha": "ade6b8bc6bb2f51330bb56184069ab545f8072de", "filename": "scripts/npc/9201007.js", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201007.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -109,14 +109,23 @@ function action(mode, type, selection) {\n             selection = 20; // Random.\n         }\n     } else if (status == 1) {\n+        var cmPartner;\n+        try {\n+            cmPartner = cm.getMap().getCharacterById(cm.getPlayer().getPartnerId()).getClient().getAbstractPlayerInteraction();\n+        } catch(err) {\n+            cmPartner = null;\n+        }\n+        \n         switch(selection) {\n             case 0:\n                 if(eim.getIntProperty(\"isPremium\") == 1) {\n                     eim.warpEventTeam(680000300);\n                     cm.sendOk(\"Enjoy! Cherish your Photos Forever!\");\n+                    if (cmPartner != null) cmPartner.npcTalk(cm.getNpc(), \"Enjoy! Cherish your Photos Forever!\");\n                 } else {    // skip the party-time (premium only)\n                     eim.warpEventTeam(680000500);\n                     cm.sendOk(\"Congratulations for the newly-wed! I will escort you to the exit.\");\n+                    if (cmPartner != null) cmPartner.npcTalk(cm.getNpc(), \"Congratulations for the newly-wed! I will escort you to the exit.\");\n                 }\n                 \n                 cm.dispose();"}, {"sha": "4931aa8826facd46ff39110164536ffcf117b968", "filename": "scripts/npc/9201008.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201008.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -132,7 +132,7 @@ function action(mode, type, selection) {\n                             if(weddingId > 0) {\n                                 if(cserv.isWeddingReserved(weddingId)) {    // registration check\n                                     var placeTime = cserv.getWeddingReservationTimeLeft(weddingId);\n-                                    cm.sendOk(\"Your wedding is set to start at the #r\" + placeTime + \"#k. Don't be late!\");\n+                                    cm.sendOk(\"Your wedding is set to start at the #r\" + placeTime + \"#k. Get a cool attire and don't be late!\");\n                                 } else {\n                                     var partner = wserv.getPlayerStorage().getCharacterById(cm.getPlayer().getPartnerId());\n                                     if(partner == null) {\n@@ -177,10 +177,10 @@ function action(mode, type, selection) {\n                                             var placeTime = cserv.getWeddingReservationTimeLeft(weddingId);\n \n                                             var wedType = weddingType ? \"Premium\" : \"Regular\";\n-                                            cm.sendOk(\"You both have received 15 Wedding Tickets, to be given to your guests. #bDouble-click the ticket#k to send it to someone. Invitations can only be sent #rbefore the wedding start time#k. Your #b\" + wedType + \" wedding#k is set to start at the #r\" + placeTime + \"#k. Don't be late!\");\n+                                            cm.sendOk(\"You both have received 15 Wedding Tickets, to be given to your guests. #bDouble-click the ticket#k to send it to someone. Invitations can only be sent #rbefore the wedding start time#k. Your #b\" + wedType + \" wedding#k is set to start at the #r\" + placeTime + \"#k. Get a cool attire and don't be late!\");\n \n-                                            player.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Don't be late!\");\n-                                            partner.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Don't be late!\");\n+                                            player.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Get dressed and don't be late!\");\n+                                            partner.dropMessage(6, \"Wedding Assistant: You both have received 15 Wedding Tickets. Invitations can only be sent before the wedding start time. Your \" + wedType + \" wedding is set to start at the \" + placeTime + \". Get dressed and don't be late!\");\n \n                                             if(!hasSuitForWedding(player)) {\n                                                 player.dropMessage(5, \"Wedding Assistant: Please purchase a wedding garment before showing up for the ceremony. One can be bought at the Wedding Shop left-most Amoria.\");"}, {"sha": "aa88cda5e37792f91ec4fb8a3c0af3f07b3d0c9d", "filename": "scripts/npc/9201009.js", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201009.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -109,14 +109,23 @@ function action(mode, type, selection) {\n             selection = 20; // Random.\n         }\n     } else if (status == 1) {\n+        var cmPartner;\n+        try {\n+            cmPartner = cm.getMap().getCharacterById(cm.getPlayer().getPartnerId()).getClient().getAbstractPlayerInteraction();\n+        } catch(err) {\n+            cmPartner = null;\n+        }\n+        \n         switch(selection) {\n             case 0:\n                 if(eim.getIntProperty(\"isPremium\") == 1) {\n                     eim.warpEventTeam(680000300);\n                     cm.sendOk(\"Enjoy! Cherish your Photos Forever!\");\n+                    if (cmPartner != null) cmPartner.npcTalk(cm.getNpc(), \"Enjoy! Cherish your Photos Forever!\");\n                 } else {    // skip the party-time (premium only)\n                     eim.warpEventTeam(680000500);\n                     cm.sendOk(\"Congratulations for the newly-wed! I will escort you to the exit.\");\n+                    if (cmPartner != null) cmPartner.npcTalk(cm.getNpc(), \"Congratulations for the newly-wed! I will escort you to the exit.\");\n                 }\n                 \n                 cm.dispose();"}, {"sha": "1692015df9b96e239e4fc663ae0bd9a354939a26", "filename": "scripts/npc/9201012.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201012.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9201012.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201012.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -133,7 +133,7 @@ function action(mode, type, selection) {\n                 } else {\n                     var placeTime = cserv.getWeddingReservationTimeLeft(wid);\n \n-                    cm.sendOk(\"Yo. Your wedding is set to happen at the #r\" + placeTime + \"#k, don't be late will you?\");\n+                    cm.sendOk(\"Yo. Your wedding is set to happen at the #r\" + placeTime + \"#k, get a decent apparel don't be late will you?\");\n                     cm.dispose();\n                 }\n             } else {"}, {"sha": "2ae7c3c08240731a1c7452e3bd5e812b13edcc82", "filename": "scripts/npc/9209000.js", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9209000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9209000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9209000.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -98,20 +98,22 @@ function action(mode, type, selection) {\n         } else if(status == 2) {\n             selected = selection;\n             var mobList = cm.getNamesWhoDropsItem(table[selected]);\n-\n+            \n             var sendStr;\n             if(mobList.length == 0) {\n-                sendStr = \"No mobs drop '#b#t\" + table[selected] + \"##k'.\";\n-\n+                sendStr = \"No mobs drop '#b#t\" + table[selected] + \"##k'.\\r\\n\\r\\n\";\n             } else {\n                 sendStr = \"The following mobs drop '#b#t\" + table[selected] + \"##k':\\r\\n\\r\\n\";\n \n                 for(var i = 0; i < mobList.length; i++) {\n                     sendStr += \"  #L\" + i + \"# \" + mobList[i] + \"#l\\r\\n\";\n                 }\n+                \n+                sendStr += \"\\r\\n\";\n             }\n+            sendStr += cm.getSkillBookInfo(table[selected]);\n \n-            cm.sendSimple(sendStr);\n+            cm.sendNext(sendStr);\n             cm.dispose();\n         }\n     }"}, {"sha": "63ec0c5eb02d39eb112c7b2dfa083f3129532a39", "filename": "scripts/npc/9209100.js", "status": "modified", "additions": 31, "deletions": 3, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9209100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9209100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9209100.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1,8 +1,36 @@\n+var status;\n+\n+function playerNearby(chrpos, portalpos) {\n+    try {\n+        return Math.sqrt( Math.pow((portalpos.getX() - chrpos.getX()), 2) + Math.pow((portalpos.getY() - chrpos.getY()), 2) ) < 77;\n+    } catch(err) {\n+        return false;\n+    }\n+}\n+\n function start() {\n-    cm.sendOk(\"You didn't hear it from Rooney? It's a dress-up party, and you can't enter unless you've transformed into something else. I hear that Cliff has something that you may be looking for...\");\n-    action(1,0,0);\n+        status = -1;\n+        action(1, 0, 0);\n }\n \n function action(mode, type, selection) {\n-    cm.dispose();\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if (status == 0) {\n+                        if (playerNearby(cm.getPlayer().getPosition(), cm.getMap().getPortal(\"chimney01\").getPosition())) cm.sendOk(\"Hey, hey~~ Please don't go sneaking into someone else's house without permission, you don't want to get a naughty remark on Santa's list this year, do you?\");\n+                        else cm.sendOk(\"Hohoho~~ have you a Great Year full of health, realization and happiness!\");\n+                } else {\n+                        cm.dispose();\n+                }\n+        }\n }\n\\ No newline at end of file"}, {"sha": "c7e41c8478907ba832ed4b45cd9bd1822b05f37b", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -80,7 +80,7 @@ function writeFeatureTab_PlayerSocialNetwork() {\n         addFeature(\"Improved ranking system, with daily movement.\");\n         addFeature(\"Protected and improved face expression system.\");\n         addFeature(\"Automated support for Player NPCs and Hall of Fame.\");\n-        addFeature(\"Engagement & Wedding system.\");\n+        addFeature(\"Engagement & Wedding system with ring effects.\");\n         addFeature(\"Equipments displays to everyone it's level & EXP info.\");\n         addFeature(\"Further improved the existent minigame mechanics.\");\n }\n@@ -191,8 +191,9 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Fixed and randomized HP/MP growth rate available.\");\n         addFeature(\"Players' MaxHP/MaxMP method accounting equip gain.\");\n         addFeature(\"Prevented 'NPC gone after some uptime' issue.\");\n-        addFeature(\"Implemented starters' AP assigning for under level 11.\");\n         addFeature(\"AP assigning available for novices level 10 or below.\");\n+        addFeature(\"SP cap past tier-level, recovered after job upgrade.\");\n+        addFeature(\"Bypassable PIN/PIC system for authenticated users.\");\n         addFeature(\"Automatic account registration - thanks shavit!\");\n }\n "}, {"sha": "31ed8985fc2a6a5b335ffb03cffafbb593867bdd", "filename": "scripts/portal/Depart_goBack00.js", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/portal/Depart_goBack00.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/portal/Depart_goBack00.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Depart_goBack00.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1,4 +1,5 @@\n function enter(pi) {\n     pi.playPortalSound();\n-    pi.warp(pi.getPlayer().getMap().getId() - 10,\"left00\");\n+    pi.warp(pi.getPlayer().getMap().getId() - 10, \"left00\");\n+    return true;\n }\n\\ No newline at end of file"}, {"sha": "d43a8120029668ededb9d9412c617c06d27c2349", "filename": "scripts/portal/Depart_goBack01.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/portal/Depart_goBack01.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/portal/Depart_goBack01.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Depart_goBack01.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1,5 +1,5 @@\n function enter(pi) {\n     pi.playPortalSound();\n-    pi.warp(pi.getPlayer().getMap().getId() -10,\"left01\");\n+    pi.warp(pi.getPlayer().getMap().getId() - 10, \"left01\");\n     return true;\n }\n\\ No newline at end of file"}, {"sha": "c30be527c48836281e3a40b8edf5754d80162b26", "filename": "scripts/quest/20408.js", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/quest/20408.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/scripts/quest/20408.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20408.js?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,63 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status = -1;\n+\n+function start(mode, type, selection) { // missing script for questid found thanks to Lost(tm)\n+    if (mode == -1) {\n+        qm.dispose();\n+    } else {\n+        if(mode == 0 && type > 0) {\n+            qm.dispose();\n+            return;\n+        }\n+        \n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        \n+        if (status == 0) {\n+            qm.sendNext(\"#h0#... First of all, thank you for your great work. If it weren't you, I... I wouldn't be safe from the curse of Black Witch. Thank you so much.\");\n+        } else if (status == 1) {\n+            qm.sendNextPrev(\"If nothing else, this chain of events makes one thing crystal clear, you have put in countless hours of hard work to better yourself and contribute to the Cygnus Knights.\");\n+        } else if (status == 2) {\n+            qm.sendAcceptDecline(\"To celebrate your hard work and accomplishments... I would like to award you a new title and renew my blessings onto you. Will you... accept this?\");\n+        } else if (status == 3) {\n+            if (!qm.canHold(1142069, 1)) {\n+                qm.sendOk(\"Please, make a room available on your EQUIP inventory for the medal.\");\n+                qm.dispose();\n+                return;\n+            }\n+            \n+            qm.gainItem(1142069, 1);\n+            if (qm.getJobId() % 10 == 1) {\n+                qm.changeJobById(qm.getJobId() + 1);\n+            }\n+            \n+            qm.forceStartQuest();\n+            qm.forceCompleteQuest();\n+            \n+            qm.sendOk(\"#h0#. For courageously battling the Black Mage, I will appoint you as the new Chief Knight of Cygnus Knights from this moment onwards. Please use your power and authority wisely to help protect the citizens of Maple World.\");\n+        } else if (status == 4) {\n+            qm.dispose();\n+        }\n+    }\n+}"}, {"sha": "f5dd1bcb4fc8427c459bab55dd4ef0f9d3744b97", "filename": "sql/db_database.sql", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -10813,14 +10813,14 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (10592, 9300170, 4001156, 1, 1, 0, 999999),\n (10593, 9300171, 4001156, 1, 1, 0, 999999),\n (10594, 9300169, 4001156, 1, 1, 0, 999999),\n-(10595, 9000100, 4031013, 1, 1, 0, 300000),\n-(10596, 9000101, 4031013, 1, 1, 0, 300000),\n-(10597, 9000000, 4031013, 1, 1, 0, 300000),\n-(10598, 9000001, 4031013, 1, 1, 0, 300000),\n-(10599, 9000200, 4031013, 1, 1, 0, 300000),\n-(10600, 9000201, 4031013, 1, 1, 0, 300000),\n-(10601, 9000300, 4031013, 1, 1, 0, 300000),\n-(10602, 9000301, 4031013, 1, 1, 0, 300000),\n+(10595, 9000100, 4031013, 1, 1, 0, 700000),\n+(10596, 9000101, 4031013, 1, 1, 0, 700000),\n+(10597, 9000000, 4031013, 1, 1, 0, 700000),\n+(10598, 9000001, 4031013, 1, 1, 0, 700000),\n+(10599, 9000200, 4031013, 1, 1, 0, 700000),\n+(10600, 9000201, 4031013, 1, 1, 0, 700000),\n+(10601, 9000300, 4031013, 1, 1, 0, 700000),\n+(10602, 9000301, 4031013, 1, 1, 0, 700000),\n (10603, 8180000, 4031511, 1, 1, 6904, 600000),\n (10604, 8180001, 4031511, 1, 1, 6904, 600000),\n (10605, 9400407, 4000343, 1, 1, 0, 100000),\n@@ -11428,7 +11428,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (11210, 9001002, 4031059, 1, 1, 0, 999999),\n (11211, 9001003, 4031059, 1, 1, 0, 999999),\n (11212, 9001004, 4031059, 1, 1, 0, 999999),\n-(11213, 9001005, 4031857, 1, 1, 2192, 300000),\n+(11213, 9001005, 4031857, 1, 1, 2192, 700000),\n (11214, 9001012, 4032311, 1, 1, 0, 300000),\n (11215, 9001012, 4032311, 1, 1, 0, 300000),\n (11217, 9001013, 4032339, 1, 1, 21303, 999999),\n@@ -11626,10 +11626,10 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (11628, 6220000, 1472055, 1, 1, 0, 1250),\n (11627, 5120500, 1472055, 1, 1, 0, 750),\n (11626, 5120000, 1472055, 1, 1, 0, 750),\n-(11625, 9001006, 4031856, 1, 1, 2191, 400000),\n+(11625, 9001006, 4031856, 1, 1, 2191, 700000),\n (11623, 9400218, 4001106, 25, 50, 0, 999999),\n (11622, 9400217, 4001106, 1, 3, 0, 999999),\n-(11613, 2110200, 4032390, 1, 1, 2248, 100000),\n+(11613, 2110200, 4032390, 1, 1, 2248, 200000),\n (11612, 8140200, 1382012, 1, 1, 0, 700),\n (11611, 7130600, 1382012, 1, 1, 0, 700),\n (11610, 5100004, 1382012, 1, 1, 0, 700),"}, {"sha": "5c55b2292ff22cf8398be00ad7d7e87961568e5d", "filename": "sql/db_drops.sql", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -3251,7 +3251,7 @@ USE `heavenms`;\n (3210202, 1002628, 1, 1, 0, 700), \n (9400509, 4000070, 1, 1, 0, 200000), \n (9400509, 4003005, 1, 1, 0, 7000), \n-(9400509, 4031523, 1, 1, 0, 7000),\n+(9400509, 4031523, 1, 1, 8848, 200000),\n (9400509, 4030009, 1, 1, 0, 28000), \n (9400509, 2000002, 1, 1, 0, 40000), \n (9400509, 2000003, 1, 1, 0, 40000), \n@@ -19309,8 +19309,8 @@ USE `heavenms`;\n (3000002, 2381033, 1, 1, 0, 10000),\n (3000003, 2381033, 1, 1, 0, 10000),\n (3000004, 2381033, 1, 1, 0, 10000),\n-(2230101, 4032399, 1, 1, 2251, 30000),\n-(2230131, 4032399, 1, 1, 2251, 30000),\n+(2230101, 4032399, 1, 1, 2251, 200000),\n+(2230131, 4032399, 1, 1, 2251, 200000),\n (9400578, 4032008, 1, 1, 0, 200000),\n (9400578, 2001000, 1, 1, 0, 800),\n (9400578, 1032032, 1, 1, 0, 1200),\n@@ -20290,7 +20290,9 @@ USE `heavenms`;\n (9400101, 4000090, 1, 1, 0, 400000),\n (9400102, 4000091, 1, 1, 0, 400000),\n (9400110, 4000092, 1, 1, 0, 400000),\n-(9400111, 4000093, 1, 1, 0, 400000);\n+(9400111, 4000093, 1, 1, 0, 400000),\n+(3210201, 4031524, 1, 1, 8848, 200000),\n+(3110101, 4031527, 1, 1, 8849, 400000);\n \n # (dropperid, itemid, minqty, maxqty, questid, chance)\n "}, {"sha": "ce77bd2b7a042ba7f13e4caa40c06667b602608b", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 132, "deletions": 13, "changes": 145, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -159,6 +159,8 @@\n import server.maps.MapleMapItem;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.movement.AbsoluteLifeMovement;\n+import server.movement.LifeMovementFragment;\n \n public class MapleCharacter extends AbstractMapleCharacterObject {\n     private static final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n@@ -804,10 +806,14 @@ public void toggleBlockCashShop() {\n         blockCashShop = !blockCashShop;\n     }\n \n+    public void setClient(MapleClient c) {\n+        this.client = c;\n+    }\n+    \n     public void newClient(MapleClient c) {\n         this.loggedIn = true;\n         c.setAccountName(this.client.getAccountName());//No null's for accountName\n-        this.client = c;\n+        this.setClient(c);\n         this.map = c.getChannelServer().getMapFactory().getMap(getMapId());\n         MaplePortal portal = map.findClosestPlayerSpawnpoint(getPosition());\n         if (portal == null) {\n@@ -833,7 +839,7 @@ public void Hide(boolean hide, boolean login) {\n                 announce(MaplePacketCreator.getGMEffect(0x10, (byte) 0));\n                 List<MapleBuffStat> dsstat = Collections.singletonList(MapleBuffStat.DARKSIGHT);\n                 getMap().broadcastGMMessage(this, MaplePacketCreator.cancelForeignBuff(id, dsstat), false);\n-                getMap().broadcastMessage(this, MaplePacketCreator.spawnPlayerMapObject(this), false);\n+                getMap().broadcastSpawnPlayerMapObjectMessage(this, this, false);\n                 \n                 for(MapleSummon ms: this.getSummonsValues()) {\n                     getMap().broadcastNONGMMessage(this, MaplePacketCreator.spawnSummon(ms, false), false);\n@@ -842,9 +848,8 @@ public void Hide(boolean hide, boolean login) {\n                 this.hidden = true;\n                 announce(MaplePacketCreator.getGMEffect(0x10, (byte) 1));\n                 if (!login) {\n-                    getMap().broadcastMessage(this, MaplePacketCreator.removePlayerFromMap(getId()), false);\n+                    getMap().broadcastNONGMMessage(this, MaplePacketCreator.removePlayerFromMap(getId()), false);\n                 }\n-                getMap().broadcastGMMessage(this, MaplePacketCreator.spawnPlayerMapObject(this), false);\n                 List<Pair<MapleBuffStat, Integer>> ldsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n                 getMap().broadcastGMMessage(this, MaplePacketCreator.giveForeignBuff(id, ldsstat), false);\n                 for (MapleMonster mon : this.getControlledMonsters()) {\n@@ -1034,8 +1039,15 @@ public synchronized void changeJob(MapleJob newJob) {\n             if (newJob.getId() % 10 == 2) {\n                 spGain += 2;\n             }\n+            \n+            if (ServerConstants.USE_ENFORCE_JOB_SP_RANGE) {\n+                spGain = getChangedJobSp(newJob);\n+            }\n+        }\n+        \n+        if (spGain > 0) {\n+            gainSp(spGain, GameConstants.getSkillBook(newJob.getId()), true);\n         }\n-        gainSp(spGain, GameConstants.getSkillBook(newJob.getId()), true);\n         \n         if (newJob.getId() % 10 > 1) {\n             gainAp(5, true);\n@@ -1160,6 +1172,19 @@ public void changeKeybinding(int key, MapleKeyBinding keybinding) {\n         }\n     }\n     \n+    public void broadcastStance(int newStance) {\n+        setStance(newStance);\n+        broadcastStance();\n+    }\n+    \n+    public void broadcastStance() {\n+        AbsoluteLifeMovement alm = new AbsoluteLifeMovement(0, getPosition(), 0, getStance());\n+        alm.setPixelsPerSecond(new Point(0, 0));\n+        List<LifeMovementFragment> moveUpdate = Collections.singletonList((LifeMovementFragment) alm);\n+        \n+        map.broadcastMessage(this, MaplePacketCreator.movePlayer(id, moveUpdate), false);\n+    }\n+    \n     public MapleMap getWarpMap(int map) {\n \tMapleMap target;\n         EventInstanceManager eim = getEventInstance();\n@@ -1743,7 +1768,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n \t\t\n         if (ob instanceof MapleMapItem) {\n             MapleMapItem mapitem = (MapleMapItem) ob;\n-            if(Server.getInstance().getCurrentTime() - mapitem.getDropTime() < 900 || !mapitem.canBePickedBy(this)) {\n+            if (System.currentTimeMillis() - mapitem.getDropTime() < 900 || !mapitem.canBePickedBy(this)) {\n                 client.announce(MaplePacketCreator.enableActions());\n                 return;\n             }\n@@ -2585,7 +2610,7 @@ public void enteredScript(String script, int mapid) {\n     }\n \n     public void equipChanged() {\n-        getMap().broadcastMessage(this, MaplePacketCreator.updateCharLook(this), false);\n+        getMap().broadcastUpdateCharLookMessage(this, this);\n         equipchanged = true;\n         updateLocalStats();\n         if (getMessenger() != null) {\n@@ -3939,8 +3964,14 @@ public void run() {\n                 extraRecInterval = effect.getMpRRate();\n             }\n             \n-            stopExtraTask();\n-            startExtraTask(extraHpRec, extraMpRec, extraRecInterval);   // HP & MP sharing the same task holder\n+            chrLock.lock();\n+            try {\n+                stopExtraTask();\n+                startExtraTask(extraHpRec, extraMpRec, extraRecInterval);   // HP & MP sharing the same task holder\n+            } finally {\n+                chrLock.unlock();\n+            }\n+            \n         } else if (effect.isMapChair()) {\n             startChairTask();\n         }\n@@ -4504,6 +4535,18 @@ public boolean haveItemEquipped(int itemid) {\n         return (inventory[MapleInventoryType.EQUIPPED.ordinal()].findById(itemid) != null);\n     }\n     \n+    public boolean haveWeddingRing() {\n+        int rings[] = {1112806, 1112803, 1112807, 1112809};\n+        \n+        for (int ringid : rings) {\n+            if (haveItemWithId(ringid, true)) {\n+                return true;\n+            }\n+        }\n+\n+        return false;\n+    }\n+    \n     public int getItemQuantity(int itemid, boolean checkEquipped) {\n         int possesed = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countById(itemid);\n         if (checkEquipped) {\n@@ -5572,7 +5615,85 @@ public void leaveMap() {\n             hpDecreaseTask.cancel(false);\n         }\n     }\n+    \n+    private int getChangedJobSp(MapleJob newJob) {\n+        int curSp = getUsedSp(newJob) + getJobRemainingSp(newJob);\n+        int spGain = 0;\n+        int expectedSp = getJobLevelSp(level - 10, newJob, GameConstants.getJobBranch(newJob));\n+        if (curSp < expectedSp) {\n+            spGain += (expectedSp - curSp);\n+        }\n+        \n+        return getSpGain(spGain, curSp, job);\n+    }\n+    \n+    private int getUsedSp(MapleJob job) {\n+        int jobId = job.getId();\n+        int spUsed = 0;\n+        \n+        for (Entry<Skill, SkillEntry> s : this.getSkills().entrySet()) {\n+            Skill skill = s.getKey();\n+            if (GameConstants.isInJobTree(skill.getId(), jobId) && !skill.isBeginnerSkill()) {\n+                spUsed += s.getValue().skillevel;\n+            }\n+        }\n+        \n+        return spUsed;\n+    }\n+    \n+    private int getJobLevelSp(int level, MapleJob job, int jobBranch) {\n+        if (getJobStyleInternal(job.getId(), (byte) 0x40) == MapleJob.MAGICIAN) {\n+            level += 2;  // starts earlier, level 8\n+        }\n+        \n+        return 3 * level + GameConstants.getChangeJobSpUpgrade(jobBranch);\n+    }\n+    \n+    private int getJobMaxSp(MapleJob job) {\n+        int jobBranch = GameConstants.getJobBranch(job);\n+        int jobRange = GameConstants.getJobUpgradeLevelRange(jobBranch);\n+        return getJobLevelSp(jobRange, job, jobBranch);\n+    }\n+    \n+    private int getJobRemainingSp(MapleJob job) {\n+        int skillBook = GameConstants.getSkillBook(job.getId());\n+        \n+        int ret = 0;\n+        for (int i = 0; i <= skillBook; i++) {\n+            ret += this.getRemainingSp(i);\n+        }\n+        \n+        return ret;\n+    }\n+    \n+    private int getSpGain(int spGain, MapleJob job) {\n+        int curSp = getUsedSp(job) + getJobRemainingSp(job);\n+        return getSpGain(spGain, curSp, job);\n+    }\n+    \n+    private int getSpGain(int spGain, int curSp, MapleJob job) {\n+        int maxSp = getJobMaxSp(job);\n \n+        spGain = Math.min(spGain, maxSp - curSp);\n+        int jobBranch = GameConstants.getJobBranch(job);\n+        return spGain;\n+    }\n+    \n+    private void levelUpGainSp() {\n+        if (GameConstants.getJobBranch(job) == 0) {\n+            return;\n+        }\n+        \n+        int spGain = 3;\n+        if (ServerConstants.USE_ENFORCE_JOB_SP_RANGE && !GameConstants.hasSPTable(job)) {\n+            spGain = getSpGain(spGain, job);\n+        }\n+        \n+        if (spGain > 0) {\n+            gainSp(spGain, GameConstants.getSkillBook(job.getId()), true);\n+        }\n+    }\n+    \n     public synchronized void levelUp(boolean takeexp) {\n         Skill improvingMaxHP = null;\n         Skill improvingMaxMP = null;\n@@ -5693,9 +5814,7 @@ public void run() {\n             level = maxClassLevel; //To prevent levels past the maximum\n         }\n         \n-        if (job.getId() % 1000 > 0) {\n-            gainSp(3, GameConstants.getSkillBook(job.getId()), true);\n-        }\n+        levelUpGainSp();\n         \n         effLock.lock();\n         statWlock.lock();\n@@ -8835,7 +8954,7 @@ public void sendDestroyData(MapleClient client) {\n     @Override\n     public void sendSpawnData(MapleClient client) {\n         if (!this.isHidden() || client.getPlayer().gmLevel() > 1) {\n-            client.announce(MaplePacketCreator.spawnPlayerMapObject(this));\n+            client.announce(MaplePacketCreator.spawnPlayerMapObject(client, this, false));\n             \n             if(hasBuffFromSourceid(getJobMapChair(job))) {\n                 client.announce(MaplePacketCreator.giveForeignChairSkillEffect(id));"}, {"sha": "d719989a474dea30dbfbd3f56a28894f84f639aa", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 23, "deletions": 4, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -79,6 +79,7 @@\n \n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import net.server.coordinator.MapleLoginBypassCoordinator;\n \n public class MapleClient {\n \n@@ -473,6 +474,7 @@ public boolean checkPin(String other) {\n \t\t}\n \t\tif (pin.equals(other)) {\n \t\t\tpinattempt = 0;\n+                        MapleLoginBypassCoordinator.getInstance().registerLoginBypassEntry(getNibbleHWID(), accId, false);\n \t\t\treturn true;\n \t\t}\n \t\treturn false;\n@@ -499,14 +501,15 @@ public String getPic() {\n \t}\n \n \tpublic boolean checkPic(String other) {\n-                if(!ServerConstants.ENABLE_PIC) return true;\n+                if(!(ServerConstants.ENABLE_PIC && !canBypassPic())) return true;\n             \n \t\tpicattempt++;\n \t\tif (picattempt > 5) {\n \t\t\tMapleSessionCoordinator.getInstance().closeSession(session, false);\n \t\t}\n \t\tif (pic.equals(other)) {\n \t\t\tpicattempt = 0;\n+                        MapleLoginBypassCoordinator.getInstance().registerLoginBypassEntry(getNibbleHWID(), accId, true);\n \t\t\treturn true;\n \t\t}\n \t\treturn false;\n@@ -743,7 +746,7 @@ public void setAccID(int id) {\n \tpublic int getAccID() {\n \t\treturn accId;\n \t}\n-\n+        \n \tpublic void updateLoginState(int newstate) {\n \t\ttry {\n                         Connection con = DatabaseConnection.getConnection();\n@@ -1051,6 +1054,10 @@ public void testPing(long timeThen) {\n \tpublic String getHWID() {\n \t\treturn hwid;\n \t}\n+        \n+        public void setHWID(String hwid) {\n+\t\tthis.hwid = hwid;\n+\t}\n \n \tpublic Set<String> getMacs() {\n \t\treturn Collections.unmodifiableSet(macs);\n@@ -1232,8 +1239,8 @@ public short getCharacterSlots() {\n         public void setCharacterSlots(byte slots) {\n                 characterSlots = slots;\n \t}\n-\n-\tpublic synchronized boolean gainCharacterSlot() {\n+        \n+        public synchronized boolean gainCharacterSlot() {\n \t\tif (characterSlots < 15) {\n \t\t\tConnection con = null;\n \t\t\ttry {\n@@ -1462,4 +1469,16 @@ public void resetCsCoupon() {\n         public void enableCSActions() {\n                 announce(MaplePacketCreator.enableCSUse(player));\n         }\n+        \n+        public String getNibbleHWID() {\n+                return (String) session.getAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+        }\n+        \n+        public boolean canBypassPin() {\n+                return MapleLoginBypassCoordinator.getInstance().canLoginBypass(getNibbleHWID(), accId, false);\n+        }\n+        \n+        public boolean canBypassPic() {\n+                return MapleLoginBypassCoordinator.getInstance().canLoginBypass(getNibbleHWID(), accId, true);\n+        }\n }"}, {"sha": "a762f25b3a85a542bf29afbbc39c4a201ef237d4", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -180,6 +180,7 @@ private void registerLv0Commands(){\n         addCommand(\"dex\", StatDexCommand.class);\n         addCommand(\"int\", StatIntCommand.class);\n         addCommand(\"luk\", StatLukCommand.class);\n+        addCommand(\"enableauth\", EnableAuthCommand.class);\n         \n         commandsNameDesc.add(levelCommandsCursor);\n     }"}, {"sha": "a08b5786900f47949507051c2ecb377237f25e1c", "filename": "src/client/command/commands/gm0/BuyBackCommand.java", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm0/BuyBackCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm0/BuyBackCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/BuyBackCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -28,6 +28,10 @@\n import client.processor.BuybackProcessor;\n \n public class BuyBackCommand extends Command {\n+    {\n+        setDescription(\"\");\n+    }\n+    \n     @Override\n     public void execute(MapleClient c, String[] params) {\n         if (params.length < 1) {"}, {"sha": "55f8c460badf769588867ada175c201e5fddff18", "filename": "src/client/command/commands/gm0/EnableAuthCommand.java", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm0/EnableAuthCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm0/EnableAuthCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/EnableAuthCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,45 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server, commands OdinMS-based\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/*\n+   @Author: Arthur L - Refactored command content into modules\n+*/\n+package client.command.commands.gm0;\n+\n+import client.command.Command;\n+import client.MapleClient;\n+import net.server.coordinator.MapleLoginBypassCoordinator;\n+\n+public class EnableAuthCommand extends Command {\n+    {\n+        setDescription(\"\");\n+    }\n+\n+    @Override\n+    public void execute(MapleClient c, String[] params) {\n+        if (c.tryacquireClient()) {\n+            try {\n+                MapleLoginBypassCoordinator.getInstance().unregisterLoginBypassEntry(c.getNibbleHWID(), c.getAccID());\n+            } finally {\n+                c.releaseClient();\n+            }\n+        }\n+    }\n+}"}, {"sha": "314ad9d45b087168a9bd8f631c7e33d4d90f7b4f", "filename": "src/client/command/commands/gm2/ClearSlotCommand.java", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/ClearSlotCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/ClearSlotCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/ClearSlotCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -49,31 +49,31 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.EQUIP, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.EQUIP, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 for (int i = 0; i < 101; i++) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.USE).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 for (int i = 0; i < 101; i++) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.ETC).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.ETC, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.ETC, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 for (int i = 0; i < 101; i++) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.SETUP).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.SETUP, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.SETUP, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 for (int i = 0; i < 101; i++) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.CASH).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"All Slots Cleared.\");\n                 break;\n@@ -82,7 +82,7 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.EQUIP, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.EQUIP, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"Equipment Slot Cleared.\");\n                 break;\n@@ -91,7 +91,7 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.USE).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"Use Slot Cleared.\");\n                 break;\n@@ -100,7 +100,7 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.SETUP).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.SETUP, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.SETUP, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"Set-Up Slot Cleared.\");\n                 break;\n@@ -109,7 +109,7 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.ETC).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.ETC, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.ETC, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"ETC Slot Cleared.\");\n                 break;\n@@ -118,7 +118,7 @@ public void execute(MapleClient c, String[] params) {\n                     Item tempItem = c.getPlayer().getInventory(MapleInventoryType.CASH).getItem((byte) i);\n                     if (tempItem == null)\n                         continue;\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, (byte) i, tempItem.getQuantity(), false, true);\n+                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, (byte) i, tempItem.getQuantity(), false, false);\n                 }\n                 player.yellowMessage(\"Cash Slot Cleared.\");\n                 break;"}, {"sha": "d80e068f77c93835f7d214a9f2c4e20e1940eb45", "filename": "src/client/command/commands/gm2/MaxSkillCommand.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/MaxSkillCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/MaxSkillCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/MaxSkillCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -56,5 +56,6 @@ public void execute(MapleClient c, String[] params) {\n             player.changeSkillLevel(skill, (byte) -1, -1, -1);\n         }\n \n+        player.yellowMessage(\"Skills maxed out.\");\n     }\n }"}, {"sha": "31b3e518b7c0b78f6cc18c65f4feb5b2b2223d28", "filename": "src/client/command/commands/gm2/SearchCommand.java", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/SearchCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/SearchCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/SearchCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -31,10 +31,12 @@\n import provider.MapleDataProviderFactory;\n import provider.MapleDataTool;\n import server.MapleItemInformationProvider;\n+import server.quest.MapleQuest;\n import tools.MaplePacketCreator;\n import tools.Pair;\n \n import java.io.File;\n+import java.util.List;\n \n public class SearchCommand extends Command {\n     private static MapleData npcStringData;\n@@ -65,7 +67,7 @@ public void execute(MapleClient c, String[] params) {\n         long start = System.currentTimeMillis();//for the lulz\n         MapleData data = null;\n         if (!params[0].equalsIgnoreCase(\"ITEM\")) {\n-            boolean mapSearch = false;\n+            int searchType = 0;\n             \n             if (params[0].equalsIgnoreCase(\"NPC\")) {\n                 data = npcStringData;\n@@ -75,21 +77,24 @@ public void execute(MapleClient c, String[] params) {\n                 data = skillStringData;\n             } else if (params[0].equalsIgnoreCase(\"MAP\")) {\n                 data = mapStringData;\n-                mapSearch = true;\n+                searchType = 1;\n+            } else if (params[0].equalsIgnoreCase(\"QUEST\")) {\n+                data = mapStringData;\n+                searchType = 2;\n             } else {\n-                sb.append(\"#bInvalid search.\\r\\nSyntax: '!search [type] [name]', where [type] is MAP, NPC, ITEM, MOB, or SKILL.\");\n+                sb.append(\"#bInvalid search.\\r\\nSyntax: '!search [type] [name]', where [type] is MAP, QUEST, NPC, ITEM, MOB, or SKILL.\");\n             }\n             if (data != null) {\n                 String name;\n                 \n-                if (!mapSearch) {\n+                if (searchType == 0) {\n                     for (MapleData searchData : data.getChildren()) {\n                         name = MapleDataTool.getString(searchData.getChildByPath(\"name\"), \"NO-NAME\");\n                         if (name.toLowerCase().contains(search.toLowerCase())) {\n                             sb.append(\"#b\").append(Integer.parseInt(searchData.getName())).append(\"#k - #r\").append(name).append(\"\\r\\n\");\n                         }\n                     }\n-                } else {\n+                } else if (searchType == 1) {\n                     String mapName, streetName;\n                     \n                     for (MapleData searchDataDir : data.getChildren()) {\n@@ -102,6 +107,16 @@ public void execute(MapleClient c, String[] params) {\n                             }\n                         }\n                     }\n+                } else {\n+                    for (MapleQuest mq : MapleQuest.getMatchedQuests(search)) {\n+                        sb.append(\"#b\").append(mq.getId()).append(\"#k - #r\");\n+                        \n+                        String parentName = mq.getParentName();\n+                        if (!parentName.isEmpty()) {\n+                            sb.append(parentName).append(\" - \");\n+                        }\n+                        sb.append(mq.getName()).append(\"\\r\\n\");\n+                    }\n                 }\n             }\n         } else {"}, {"sha": "7a50cefc7fd32e9c5108ace533330d776b7fa49f", "filename": "src/client/command/commands/gm2/WhereaMiCommand.java", "status": "modified", "additions": 43, "deletions": 10, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/WhereaMiCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm2/WhereaMiCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/WhereaMiCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -28,7 +28,9 @@\n import client.MapleCharacter;\n import server.life.MapleMonster;\n import server.life.MapleNPC;\n+import server.life.MaplePlayerNPC;\n import server.maps.MapleMapObject;\n+import java.util.HashSet;\n \n public class WhereaMiCommand extends Command {\n     {\n@@ -38,23 +40,54 @@\n     @Override\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n+        \n+        HashSet<MapleCharacter> chars = new HashSet<>();\n+        HashSet<MapleNPC> npcs = new HashSet<>();\n+        HashSet<MaplePlayerNPC> playernpcs = new HashSet<>();\n+        HashSet<MapleMonster> mobs = new HashSet<>();\n+        \n+        for (MapleMapObject mmo : player.getMap().getMapObjects()) {\n+            if (mmo instanceof MapleNPC) {\n+                MapleNPC npc = (MapleNPC) mmo;\n+                npcs.add(npc);\n+            } else if (mmo instanceof MapleCharacter) {\n+                MapleCharacter mc = (MapleCharacter) mmo;\n+                chars.add(mc);\n+            } else if (mmo instanceof MapleMonster) {\n+                MapleMonster mob = (MapleMonster) mmo;\n+                if (mob.isAlive()) {\n+                    mobs.add(mob);\n+                }\n+            } else if (mmo instanceof MaplePlayerNPC) {\n+                MaplePlayerNPC npc = (MaplePlayerNPC) mmo;\n+                playernpcs.add(npc);\n+            }\n+        }\n+        \n         player.yellowMessage(\"Map ID: \" + player.getMap().getId());\n+        \n         player.yellowMessage(\"Players on this map:\");\n-        for (MapleMapObject mmo : player.getMap().getPlayers()) {\n-            MapleCharacter chr = (MapleCharacter) mmo;\n+        for (MapleCharacter chr : chars) {\n             player.dropMessage(5, \">> \" + chr.getName() + \" - \" + chr.getId() + \" - Oid: \" + chr.getObjectId());\n         }\n-        player.yellowMessage(\"NPCs on this map:\");\n-        for (MapleMapObject npcs : player.getMap().getMapObjects()) {\n-            if (npcs instanceof MapleNPC) {\n-                MapleNPC npc = (MapleNPC) npcs;\n+        \n+        if (!playernpcs.isEmpty()) {\n+            player.yellowMessage(\"PlayerNPCs on this map:\");\n+            for (MaplePlayerNPC pnpc : playernpcs) {\n+                player.dropMessage(5, \">> \" + pnpc.getName() + \" - Scriptid: \" + pnpc.getScriptId() + \" - Oid: \" + pnpc.getObjectId());\n+            }\n+        }\n+        \n+        if (!npcs.isEmpty()) {\n+            player.yellowMessage(\"NPCs on this map:\");\n+            for (MapleNPC npc : npcs) {\n                 player.dropMessage(5, \">> \" + npc.getName() + \" - \" + npc.getId() + \" - Oid: \" + npc.getObjectId());\n             }\n         }\n-        player.yellowMessage(\"Monsters on this map:\");\n-        for (MapleMapObject mobs : player.getMap().getMapObjects()) {\n-            if (mobs instanceof MapleMonster) {\n-                MapleMonster mob = (MapleMonster) mobs;\n+        \n+        if (!mobs.isEmpty()) {\n+            player.yellowMessage(\"Monsters on this map:\");\n+            for (MapleMonster mob : mobs) {\n                 if (mob.isAlive()) {\n                     player.dropMessage(5, \">> \" + mob.getName() + \" - \" + mob.getId() + \" - Oid: \" + mob.getObjectId());\n                 }"}, {"sha": "c7869de186f5baa5724a4d657e8fd41b6c20156a", "filename": "src/client/command/commands/gm6/EraseAllPNpcsCommand.java", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm6/EraseAllPNpcsCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/command/commands/gm6/EraseAllPNpcsCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/EraseAllPNpcsCommand.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,7 +25,6 @@\n \n import client.command.Command;\n import client.MapleClient;\n-import client.MapleCharacter;\n import server.life.MaplePlayerNPC;\n \n public class EraseAllPNpcsCommand extends Command {\n@@ -35,7 +34,6 @@\n \n     @Override\n     public void execute(MapleClient c, String[] params) {\n-        //MapleCharacter player = c.getPlayer();\n         MaplePlayerNPC.removeAllPlayerNPC();\n     }\n }"}, {"sha": "307c7bd221697660a8a6e481c8864ec4d7c5dbe8", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -294,7 +294,7 @@ private static int randomizeStatUpgrade(int top) {\n         int stat = 0;\n         if(rnd >= limit) {\n             rnd -= limit;\n-            stat = 1 + (int)Math.floor((-1 + Math.sqrt((8 * rnd) + 1)) / 2);\n+            stat = 1 + (int)Math.floor((-1 + Math.sqrt((8 * rnd) + 1)) / 2);    // optimized randomizeStatUpgrade author: David A.\n         }\n         \n         return stat;"}, {"sha": "d6e7a3ac1502e69d4d2b21ad2e889d66bc48cef0", "filename": "src/client/processor/BuybackProcessor.java", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/BuybackProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/BuybackProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/BuybackProcessor.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -21,12 +21,7 @@\n \n import client.MapleClient;\n import client.MapleCharacter;\n-import java.awt.Point;\n-import java.util.Collections;\n-import java.util.List;\n import server.maps.MapleMap;\n-import server.movement.AbsoluteLifeMovement;\n-import server.movement.LifeMovementFragment;\n import tools.MaplePacketCreator;\n \n /**\n@@ -74,16 +69,10 @@ public static void processBuyback(MapleClient c) {\n                     jobString = \"beginner\";\n             }\n \n-            chr.setStance(0);\n             chr.healHpMp();\n+            chr.broadcastStance(chr.isFacingLeft() ? 5 : 4);\n             \n-            AbsoluteLifeMovement alm = new AbsoluteLifeMovement(0, chr.getPosition(), 0, 0);\n-            alm.setPixelsPerSecond(new Point(0, 0));\n-            List<LifeMovementFragment> moveUpdate = Collections.singletonList((LifeMovementFragment) alm);\n-\n             MapleMap map = chr.getMap();\n-            map.broadcastMessage(chr, MaplePacketCreator.movePlayer(c.getPlayer().getId(), moveUpdate), false);\n-\n             map.broadcastMessage(MaplePacketCreator.playSound(\"Buyback/\" + jobString));\n             map.broadcastMessage(MaplePacketCreator.earnTitleMessage(chr.getName() + \" just bought back into the game!\"));\n "}, {"sha": "653a1ee155aee6e4df72ddc39e7e4e984da81273", "filename": "src/client/processor/DueyProcessor.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/DueyProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/DueyProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/DueyProcessor.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -389,6 +389,11 @@ public static void dueySendItem(MapleClient c, byte inventId, short itemPos, sho\n                     MapleInventoryType inv = MapleInventoryType.getByType(inventId);\n                     Item item = c.getPlayer().getInventory(inv).getItem(itemPos);\n                     if (item != null && c.getPlayer().getItemQuantity(item.getItemId(), false) >= amount) {\n+                        if (item.isUntradeable()) {\n+                            c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_INCORRECT_REQUEST.getCode()));\n+                            return;\n+                        }\n+                        \n                         c.getPlayer().gainMeso(-finalcost, false);\n                         c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));\n "}, {"sha": "0d8e731ebae65d409cf9c78e59977a166f2442af", "filename": "src/client/processor/StorageProcessor.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/StorageProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/client/processor/StorageProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/StorageProcessor.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -121,6 +121,11 @@ public static void storageAction(SeekableLittleEndianAccessor slea, MapleClient\n                                                 MapleInventoryType invType = ItemConstants.getInventoryType(itemId);\n                                                 Item item = chr.getInventory(invType).getItem(slot).copy();\n                                                 if (item != null && item.getItemId() == itemId && (item.getQuantity() >= quantity || ItemConstants.isRechargeable(itemId))) {\n+                                                        if (ItemConstants.isWeddingRing(itemId) || ItemConstants.isWeddingToken(itemId)) {\n+                                                                c.announce(MaplePacketCreator.enableActions());\n+                                                                return;\n+                                                        }\n+                                                    \n                                                         if (ItemConstants.isRechargeable(itemId)) {\n                                                                 quantity = item.getQuantity();\n                                                         }"}, {"sha": "37e9074548f5f3e24fff16490bef0632bf1a7996", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -25,6 +25,8 @@\n     private static final int[] MESO_RATE_GAIN = {1, 3, 6, 10, 15, 21, 28, 36, 45, 55, 66, 78, 91, 105};\n     private static final int[]  EXP_RATE_GAIN = {1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610};    //fibonacci :3\n     \n+    private static final int[] jobUpgradeBlob = {1, 20, 60, 110, 190};\n+    private static final int[] jobUpgradeSpUp = {0, 1, 2, 3, 6};\n     private final static Map<Integer, String> jobNames = new HashMap<>();\n     private final static NumberFormat nfFormatter = new DecimalFormat(\"#,###,###,###\");\n     private final static NumberFormat nfParser = NumberFormat.getInstance(ServerConstants.USE_UNITPRICE_WITH_COMMA ? Locale.FRANCE : Locale.UK);\n@@ -152,6 +154,14 @@ public static String getJobName(int jobid) {\n         return name;\n     }\n     \n+    public static int getJobUpgradeLevelRange(int jobbranch) {\n+        return jobUpgradeBlob[jobbranch];\n+    }\n+    \n+    public static int getChangeJobSpUpgrade(int jobbranch) {\n+        return jobUpgradeSpUp[jobbranch];\n+    }\n+    \n     public static boolean isHallOfFameMap(int mapid) {\n         switch(mapid) {\n             case 102000004:     // warrior"}, {"sha": "857331d2658dfd1eaaa4086bed5020647a51345d", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -27,9 +27,12 @@\n     public static final long  COUPON_INTERVAL = 60 * 60 * 1000;\t//60 minutes, 3600000.\n     public static final long  UPDATE_INTERVAL = 777;            //Dictates the frequency on which the \"centralized server time\" is updated.\n     \n-    public static final boolean ENABLE_PIC = false;             //Pick true/false to enable or disable Pic. Delete character needs this feature ENABLED.\n+    public static final boolean ENABLE_PIC = false;             //Pick true/false to enable or disable Pic. Delete character required PIC available.\n     public static final boolean ENABLE_PIN = false;             //Pick true/false to enable or disable Pin.\n     \n+    public static final int BYPASS_PIC_EXPIRATION = 20;         //Enables PIC bypass, which will remain active for that account by that client machine for N minutes. Set 0 to disable.\n+    public static final int BYPASS_PIN_EXPIRATION = 15;         //Enables PIN bypass, which will remain active for that account by that client machine for N minutes. Set 0 to disable.\n+    \n     public static final boolean AUTOMATIC_REGISTER = true;      //Automatically register players when they login with a nonexistent username.\n     public static final boolean BCRYPT_MIGRATION = true;        //Performs a migration from old SHA-1 and SHA-512 password to bcrypt.\n     public static final boolean COLLECTIVE_CHARSLOT = false;    //Available character slots are contabilized globally rather than per world server.\n@@ -79,6 +82,7 @@\n     public static final boolean USE_ENFORCE_HPMP_SWAP = false;      //Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     public static final boolean USE_ENFORCE_MOB_LEVEL_RANGE = true; //Players N levels below the killed mob will gain no experience from defeating it.\n     public static final boolean USE_ENFORCE_JOB_LEVEL_RANGE = false;//Caps the player level on the minimum required to advance their current jobs.\n+    public static final boolean USE_ENFORCE_JOB_SP_RANGE = true;   //Caps the player SP level on the total obtainable by their current jobs. After changing jobs, missing SP will be retrieved.\n     public static final boolean USE_ENFORCE_ITEM_SUGGESTION = false;//Forces the Owl of Minerva and the Cash Shop to always display the defined item array instead of those featured by the players.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_CASH = true;//Forces players to not sell CASH items via merchants.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_PET = true; //Forces players to not sell pets via merchants. (since non-named pets gets dirty name and other possible DB-related issues)"}, {"sha": "4742b4cb9c728fa3c1f932bb0e28bb26e927fc8a", "filename": "src/net/server/Server.java", "status": "modified", "additions": 39, "deletions": 15, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -86,6 +86,7 @@\n import constants.GameConstants;\n import constants.ServerConstants;\n import server.CashShop.CashItemFactory;\n+import server.MapleSkillbookInformationProvider;\n import server.TimerManager;\n import server.life.MaplePlayerNPCFactory;\n import server.quest.MapleQuest;\n@@ -329,7 +330,7 @@ public int addChannel(int worldid) {\n             if(p == null) {\n                 return -1;\n             }\n-\n+            \n             channelid++;\n             World world = this.getWorld(worldid);\n             Channel channel = new Channel(worldid, channelid, getCurrentTime());\n@@ -923,6 +924,8 @@ public void init() {\n \n         System.out.println(\"HeavenMS is now online.\\r\\n\");\n         online = true;\n+        \n+        MapleSkillbookInformationProvider.getInstance();\n     }\n \n     public static void main(String args[]) {\n@@ -1485,36 +1488,57 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n         return new Pair<>(characterCount, wchars);\n     }\n     \n-    public void loadAccountCharacters(MapleClient c) {\n-        Integer accId = c.getAccID();\n-        boolean firstAccountLogin;\n-        \n+    public void loadAllAccountsCharactersView() {\n+        try {\n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"SELECT id FROM accounts\");\n+            ResultSet rs = ps.executeQuery();\n+            \n+            while (rs.next()) {\n+                int accountId = rs.getInt(\"id\");\n+                if (isFirstAccountLogin(accountId)) {\n+                    loadAccountCharactersView(accountId, 0, 0);\n+                }\n+            }\n+            \n+            rs.close();\n+            ps.close();\n+            con.close();\n+        } catch (SQLException se) {\n+            se.printStackTrace();\n+        }\n+    }\n+    \n+    private boolean isFirstAccountLogin(Integer accId) {\n         lgnRLock.lock();\n         try {\n-            firstAccountLogin = !accountChars.containsKey(accId);\n+            return !accountChars.containsKey(accId);\n         } finally {\n             lgnRLock.unlock();\n         }\n-        \n-        if(!firstAccountLogin) {\n+    }\n+    \n+    public void loadAccountCharacters(MapleClient c) {\n+        Integer accId = c.getAccID();\n+        if (!isFirstAccountLogin(accId)) {\n             Set<Integer> accWorlds = new HashSet<>();\n             \n             lgnRLock.lock();\n             try {\n-                for(Integer chrid : getAccountCharacterEntries(accId)) {\n+                for (Integer chrid : getAccountCharacterEntries(accId)) {\n                     accWorlds.add(worldChars.get(chrid));\n                 }\n             } finally {\n                 lgnRLock.unlock();\n             }\n             \n             int gmLevel = 0;\n-            for(Integer aw : accWorlds) {\n+            for (Integer aw : accWorlds) {\n                 World wserv = this.getWorld(aw);\n                 \n                 if (wserv != null) {\n-                    for(MapleCharacter chr : wserv.getAllCharactersView()) {\n-                        if(gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n+                    for (MapleCharacter chr : wserv.getAllCharactersView()) {\n+                        if (gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n                     }\n                 }\n             }\n@@ -1541,14 +1565,14 @@ private int loadAccountCharactersView(Integer accId, int gmLevel, int fromWorldi\n                 chars = new HashSet<>(5);\n             }\n             \n-            for(int wid = fromWorldid; wid < wlist.size(); wid++) {\n+            for (int wid = fromWorldid; wid < wlist.size(); wid++) {\n                 World w = wlist.get(wid);\n                 List<MapleCharacter> wchars = accChars.get(wid);\n                 w.loadAccountCharactersView(accId, wchars);\n                 \n-                for(MapleCharacter chr : wchars) {\n+                for (MapleCharacter chr : wchars) {\n                     int cid = chr.getId();\n-                    if(gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n+                    if (gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n                     \n                     chars.add(cid);\n                     worldChars.put(cid, wid);"}, {"sha": "7e51b218ff9296e6547ca629191d26c464299993", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -243,10 +243,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             if (item == null) {\n                 c.enableCSActions();\n                 return;\n-            } else if(c.getPlayer().getPetIndex(item.getPetId()) > -1) {\n+            } else if (c.getPlayer().getPetIndex(item.getPetId()) > -1) {\n                 chr.getClient().announce(MaplePacketCreator.serverNotice(1, \"You cannot put the pet you currently equip into the Cash Shop inventory.\"));\n                 c.enableCSActions();\n                 return;\n+            } else if (ItemConstants.isWeddingRing(item.getItemId()) || ItemConstants.isWeddingToken(item.getItemId())) {\n+                chr.getClient().announce(MaplePacketCreator.serverNotice(1, \"You cannot put relationship items into the Cash Shop inventory.\"));\n+                c.enableCSActions();\n+                return;\n             }\n             cs.addToInventory(item);\n             mi.removeSlot(item.getPosition());"}, {"sha": "ccb354f373aa2d1666aa00ce586ec0d6abba5e46", "filename": "src/net/server/channel/handlers/GuildOperationHandler.java", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/GuildOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/GuildOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GuildOperationHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -47,9 +47,8 @@ private boolean isGuildNameAcceptable(String name) {\n         return true;\n     }\n \n-    private void respawnPlayer(MapleCharacter mc) {\n-        mc.getMap().broadcastMessage(mc, MaplePacketCreator.removePlayerFromMap(mc.getId()), false);\n-        mc.getMap().broadcastMessage(mc, MaplePacketCreator.spawnPlayerMapObject(mc), false);\n+    private void restancePlayer(MapleCharacter mc) {\n+        mc.broadcastStance();\n     }\n \n     private class Invited {\n@@ -132,7 +131,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 c.announce(MaplePacketCreator.showGuildInfo(mc));\n                 \n                 c.getPlayer().dropMessage(1, \"You have successfully created a Guild.\");\n-                respawnPlayer(mc);\n+                restancePlayer(mc);\n                 break;\n             case 0x05:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {\n@@ -192,7 +191,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if(allianceId > 0) Server.getInstance().getAlliance(allianceId).updateAlliancePackets(mc);\n                 \n                 mc.saveGuildStatus(); // update database\n-                respawnPlayer(mc);\n+                restancePlayer(mc);\n                 break;\n             case 0x07:\n                 allianceId = mc.getGuild().getAllianceId();\n@@ -211,7 +210,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \n                 mc.getMGC().setGuildId(0);\n                 mc.saveGuildStatus();\n-                respawnPlayer(mc);\n+                restancePlayer(mc);\n                 break;\n             case 0x08:\n                 allianceId = mc.getGuild().getAllianceId();\n@@ -271,7 +270,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 \n                 mc.gainMeso(-ServerConstants.CHANGE_EMBLEM_COST, true, false, true);\n-                respawnPlayer(mc);\n+                restancePlayer(mc);\n                 break;\n             case 0x10:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {"}, {"sha": "aeaa78ade27ae737de2555a24ab7ee9bad6cfb15", "filename": "src/net/server/channel/handlers/NPCTalkHandler.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/NPCTalkHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/NPCTalkHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NPCTalkHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -80,11 +80,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n         } else if (obj instanceof MaplePlayerNPC) {\n             MaplePlayerNPC pnpc = (MaplePlayerNPC) obj;\n+            NPCScriptManager nsm = NPCScriptManager.getInstance();\n             \n-            if(pnpc.getScriptId() < 9977777) {\n-                NPCScriptManager.getInstance().start(c, pnpc.getScriptId(), \"rank_user\", null);\n+            if (pnpc.getScriptId() < 9977777 && !nsm.isNpcScriptAvailable(c, \"\" + pnpc.getScriptId())) {\n+                nsm.start(c, pnpc.getScriptId(), \"rank_user\", null);\n             } else {\n-                NPCScriptManager.getInstance().start(c, pnpc.getScriptId(), null);\n+                nsm.start(c, pnpc.getScriptId(), null);\n             }\n         }\n     }"}, {"sha": "44ec3167390e95869b6c015c1f6711bec4e71f9c", "filename": "src/net/server/channel/handlers/PetChatHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/PetChatHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/PetChatHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetChatHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -29,6 +29,8 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class PetChatHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int petId = slea.readInt();\n         slea.readInt();"}, {"sha": "84483ac4c96cab2fa5c0cac4f26c4a62e09b881a", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -83,22 +83,19 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         final Server server = Server.getInstance();\n         MapleCharacter player = c.getWorldServer().getPlayerStorage().getCharacterById(cid);\n         boolean newcomer = false;\n+        \n+        IoSession session = c.getSession();\n+        String remoteHwid;\n         if (player == null) {\n-            IoSession session = c.getSession();\n-            \n             if (!server.validateCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), cid)) {\n                 c.disconnect(true, false);\n                 return;\n             }\n             \n-            if (ServerConstants.DETERRED_MULTICLIENT) {\n-                String remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n-                if (remoteHwid == null) {\n-                    c.disconnect(true, false);\n-                    return;\n-                }\n-\n-                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+            remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n+            if (remoteHwid == null) {\n+                c.disconnect(true, false);\n+                return;\n             }\n             \n             try {\n@@ -108,6 +105,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 e.printStackTrace();\n             }\n         } else {\n+            remoteHwid = player.getClient().getHWID();\n             c.setCharacterSlots((byte) player.getClient().getCharacterSlots());\n             player.newClient(c);\n         }\n@@ -116,6 +114,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n+        int hwidLen = remoteHwid.length();\n+        session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+        session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n+        c.setHWID(remoteHwid);\n+        \n         c.setPlayer(player);\n         c.setAccID(player.getAccountID());\n         "}, {"sha": "e1a912060345ed422034bb5016aead4f07f896af", "filename": "src/net/server/channel/handlers/QuestActionHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/QuestActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/QuestActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/QuestActionHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -36,7 +36,7 @@\n  */\n public final class QuestActionHandler extends AbstractMaplePacketHandler {\n     \n-    // credits to gabriel.sin\n+    // isNpcNearby credits to gabriel.sin\n     private static boolean isNpcNearby(SeekableLittleEndianAccessor slea, MapleCharacter player, MapleQuest quest, int npcId) {\n         Point playerP = null;\n         "}, {"sha": "338ad0dc7d80540deb9a0979a0addc5387d993b5", "filename": "src/net/server/channel/handlers/RingActionHandler.java", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/RingActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/channel/handlers/RingActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RingActionHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -107,8 +107,16 @@ public static void sendEngageProposal(final MapleClient c, final String name, fi\n             source.dropMessage(1, \"The player is already engaged!\");\n             source.announce(Wedding.OnMarriageResult((byte) 0));\n             return;\n-        } else if (target.getGender() != 1) {\n-            source.dropMessage(1, \"You may only propose to a girl!\");\n+        } else if (target.haveWeddingRing()) {\n+            source.dropMessage(1, \"The player already holds a marriage ring...\");\n+            source.announce(Wedding.OnMarriageResult((byte) 0));\n+            return;\n+        } else if (source.haveWeddingRing()) {\n+            source.dropMessage(1, \"You can't propose while holding a marriage ring!\");\n+            source.announce(Wedding.OnMarriageResult((byte) 0));\n+            return;\n+        } else if (target.getGender() == source.getGender()) {\n+            source.dropMessage(1, \"You may only propose to a \" + (source.getGender() == 1 ? \"male\" : \"female\") + \"!\");\n             source.announce(Wedding.OnMarriageResult((byte) 0));\n             return;\n         } else if (!MapleInventoryManipulator.checkSpace(c, newBoxId, 1, \"\")) {"}, {"sha": "7c21df8decbec54f906d9e6a10b19a44362ac512", "filename": "src/net/server/coordinator/MapleLoginBypassCoordinator.java", "status": "added", "additions": 114, "deletions": 0, "changes": 114, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/coordinator/MapleLoginBypassCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/coordinator/MapleLoginBypassCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleLoginBypassCoordinator.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,114 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator;\n+\n+import constants.ServerConstants;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map.Entry;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import client.MapleCharacter;\n+import client.MapleClient;\n+import net.server.world.World;\n+import net.server.Server;\n+import tools.Pair;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleLoginBypassCoordinator {\n+    \n+    private final static MapleLoginBypassCoordinator instance = new MapleLoginBypassCoordinator();\n+    \n+    public static MapleLoginBypassCoordinator getInstance() {\n+        return instance;\n+    }\n+    \n+    private final ConcurrentHashMap<Pair<String, Integer>, Pair<Boolean, Long>> loginBypass = new ConcurrentHashMap<>();   // optimized PIN & PIC check\n+    \n+    public boolean canLoginBypass(String nibbleHwid, int accId, boolean pic) {\n+        try {\n+            Pair<String, Integer> entry = new Pair<>(nibbleHwid, accId);\n+            Boolean p = loginBypass.get(entry).getLeft();\n+            \n+            return !pic || p;\n+        } catch (NullPointerException npe) {\n+            return false;\n+        }\n+    }\n+    \n+    public void registerLoginBypassEntry(String nibbleHwid, int accId, boolean pic) {\n+        long expireTime = (pic ? ServerConstants.BYPASS_PIC_EXPIRATION : ServerConstants.BYPASS_PIN_EXPIRATION);\n+        if (expireTime > 0) {\n+            Pair<String, Integer> entry = new Pair<>(nibbleHwid, accId);\n+            expireTime = Server.getInstance().getCurrentTime() + expireTime * 60 * 1000;\n+            try {\n+                pic |= loginBypass.get(entry).getLeft();\n+                expireTime = Math.max(loginBypass.get(entry).getRight(), expireTime);\n+            } catch (NullPointerException npe) {}\n+            \n+            loginBypass.put(entry, new Pair<>(pic, expireTime));\n+        }\n+    }\n+    \n+    public void unregisterLoginBypassEntry(String nibbleHwid, int accId) {\n+        Pair<String, Integer> entry = new Pair<>(nibbleHwid, accId);\n+        loginBypass.remove(entry);\n+    }\n+    \n+    public void runUpdateLoginBypass() {\n+        if (!loginBypass.isEmpty()) {\n+            List<Pair<String, Integer>> toRemove = new LinkedList<>();\n+            Set<Integer> onlineAccounts = new HashSet<>();\n+            long timeNow = Server.getInstance().getCurrentTime();\n+            \n+            for (World w : Server.getInstance().getWorlds()) {\n+                for (MapleCharacter chr : w.getPlayerStorage().getAllCharacters()) {\n+                    MapleClient c = chr.getClient();\n+                    if (c != null) {\n+                        onlineAccounts.add(c.getAccID());\n+                    }\n+                }\n+            }\n+            \n+            for (Entry<Pair<String, Integer>, Pair<Boolean, Long>> e : loginBypass.entrySet()) {\n+                if (onlineAccounts.contains(e.getKey().getRight())) {\n+                    long expireTime = timeNow + 2 * 60 * 1000;\n+                    if (expireTime > e.getValue().getRight()) {\n+                        loginBypass.replace(e.getKey(), new Pair<>(e.getValue().getLeft(), expireTime));\n+                    }\n+                } else if (e.getValue().getRight() < timeNow) {\n+                    toRemove.add(e.getKey());\n+                }\n+            }\n+            \n+            if (!toRemove.isEmpty()) {\n+                for (Pair<String, Integer> p : toRemove) {\n+                    loginBypass.remove(p);\n+                }\n+            }\n+        }\n+    }\n+    \n+}"}, {"sha": "86da706e5e4125356a7082c9f8c7ed48b295734a", "filename": "src/net/server/coordinator/MapleSessionCoordinator.java", "status": "modified", "additions": 20, "deletions": 13, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/coordinator/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/coordinator/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleSessionCoordinator.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -290,17 +290,20 @@ public void closeLoginSession(IoSession session) {\n             lrh.remove(session);\n             if (lrh.isEmpty()) {\n                 loginRemoteHosts.remove(remoteIp);\n-                \n-                String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n-                if (nibbleHwid != null) {\n-                    onlineRemoteHwids.remove(nibbleHwid);\n-                }\n             }\n         }\n+        \n+        String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+        if (nibbleHwid != null) {\n+            onlineRemoteHwids.remove(nibbleHwid);\n+        }\n     }\n     \n     public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbleHwid, int accountId, boolean routineCheck) {\n-        if (!ServerConstants.DETERRED_MULTICLIENT) return AntiMulticlientResult.SUCCESS;\n+        if (!ServerConstants.DETERRED_MULTICLIENT) {\n+            session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, nibbleHwid);\n+            return AntiMulticlientResult.SUCCESS;\n+        }\n         \n         String remoteHost = getRemoteIp(session);\n         Lock lock = getCoodinatorLock(remoteHost);\n@@ -368,11 +371,13 @@ public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbl\n     }\n     \n     public AntiMulticlientResult attemptGameSession(IoSession session, int accountId, String remoteHwid) {\n-        if (!ServerConstants.DETERRED_MULTICLIENT) return AntiMulticlientResult.SUCCESS;\n-        \n         String remoteHost = getRemoteIp(session);\n-        Lock lock = getCoodinatorLock(remoteHost);\n+        if (!ServerConstants.DETERRED_MULTICLIENT) {\n+            associateRemoteHostHwid(remoteHost, remoteHwid);\n+            return AntiMulticlientResult.SUCCESS;\n+        }\n         \n+        Lock lock = getCoodinatorLock(remoteHost);\n         try {\n             int tries = 0;\n             while (true) {\n@@ -413,10 +418,7 @@ public AntiMulticlientResult attemptGameSession(IoSession session, int accountId\n                         \n                         // updated session CLIENT_HWID attribute will be set when the player log in the game\n                         onlineRemoteHwids.add(remoteHwid);\n-\n-                        cachedHostHwids.put(remoteHost, remoteHwid);\n-                        cachedHostTimeout.put(remoteHost, Server.getInstance().getCurrentTime() + 604800000);   // 1 week-time entry\n-                        \n+                        associateRemoteHostHwid(remoteHost, remoteHwid);\n                         associateHwidAccountIfAbsent(remoteHwid, accountId);\n \n                         return AntiMulticlientResult.SUCCESS;\n@@ -456,6 +458,11 @@ public String getGameSessionHwid(IoSession session) {\n         return cachedHostHwids.get(remoteHost);\n     }\n     \n+    private void associateRemoteHostHwid(String remoteHost, String remoteHwid) {\n+        cachedHostHwids.put(remoteHost, remoteHwid);\n+        cachedHostTimeout.put(remoteHost, Server.getInstance().getCurrentTime() + 604800000);   // 1 week-time entry\n+    }\n+    \n     public void runUpdateHwidHistory() {\n         try {\n             Connection con = DatabaseConnection.getConnection();"}, {"sha": "fa04f5ab72383c7411649f2037f6c478991e40a4", "filename": "src/net/server/handlers/login/ViewAllCharHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -64,7 +64,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.announce(MaplePacketCreator.showAllCharacter(charsSize, unk));\n             \n             for (Pair<Integer, List<MapleCharacter>> wchars : worldChars) {\n-                c.announce(MaplePacketCreator.showAllCharacterInfo(wchars.getLeft(), wchars.getRight(), ServerConstants.ENABLE_PIC));\n+                c.announce(MaplePacketCreator.showAllCharacterInfo(wchars.getLeft(), wchars.getRight(), ServerConstants.ENABLE_PIC && !c.canBypassPic()));\n             }\n         } catch (Exception e) {\n             e.printStackTrace();"}, {"sha": "ced0c14a8e480a8159d4188fb6e701c1924c29b7", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 44, "deletions": 8, "changes": 52, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -6,19 +6,63 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.coordinator.MapleSessionCoordinator;\n import net.server.world.World;\n+import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class ViewAllCharRegisterPicHandler extends AbstractMaplePacketHandler {\n \n+    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n+\n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         slea.readByte();\n         int charId = slea.readInt();\n         slea.readInt(); // please don't let the client choose which world they should login\n         \n+        String mac = slea.readMapleAsciiString();\n+        String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n+        c.updateMacs(mac);\n+        c.updateHWID(hwid);\n+        \n+        if (c.hasBannedMac() || c.hasBannedHWID()) {\n+            c.getSession().close(true);\n+            return;\n+        }\n+        \n+        IoSession session = c.getSession();\n+        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n             c.getSession().close(true);\n@@ -35,14 +79,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int channel = Randomizer.rand(1, server.getWorld(c.getWorld()).getChannelsSize());\n         c.setChannel(channel);\n         \n-        String mac = slea.readMapleAsciiString();\n-        c.updateMacs(mac);\n-        if (c.hasBannedMac()) {\n-            c.getSession().close(true);\n-            return;\n-        }\n-        \n-        slea.readMapleAsciiString();\n         String pic = slea.readMapleAsciiString();\n         c.setPic(pic);\n         "}, {"sha": "119827584118e0a1960f811503567fd68e4d43dd", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 44, "deletions": 7, "changes": 51, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -27,18 +27,62 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.coordinator.MapleSessionCoordinator;\n import net.server.world.World;\n+import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class ViewAllCharSelectedHandler extends AbstractMaplePacketHandler {\n \n+    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n+\n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int charId = slea.readInt();\n         slea.readInt(); // please don't let the client choose which world they should login\n         \n+        String macs = slea.readMapleAsciiString();\n+        String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n+        c.updateMacs(macs);\n+        c.updateHWID(hwid);\n+        \n+        if (c.hasBannedMac() || c.hasBannedHWID()) {\n+            c.getSession().close(true);\n+            return;\n+        }\n+        \n+        IoSession session = c.getSession();\n+        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n             c.getSession().close(true);\n@@ -53,13 +97,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n-        String macs = slea.readMapleAsciiString();\n-        c.updateMacs(macs);\n-        if (c.hasBannedMac()) {\n-            c.getSession().close(true);\n-            return;\n-        }\n-        \n         try {\n             int channel = Randomizer.rand(1, wserv.getChannelsSize());\n             c.setChannel(channel);"}, {"sha": "6617d1eda86a2e4dad84bc95cb8071398139002a", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 44, "deletions": 7, "changes": 51, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -11,16 +11,60 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n import java.net.InetSocketAddress;\n+import net.server.coordinator.MapleSessionCoordinator;\n+import org.apache.mina.core.session.IoSession;\n \n public class ViewAllCharSelectedWithPicHandler extends AbstractMaplePacketHandler {\n \n+    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n+\n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n \n         String pic = slea.readMapleAsciiString();\n         int charId = slea.readInt();\n         slea.readInt(); // please don't let the client choose which world they should login\n         \n+        String macs = slea.readMapleAsciiString();\n+        String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n+        c.updateMacs(macs);\n+        c.updateHWID(hwid);\n+        \n+        if (c.hasBannedMac() || c.hasBannedHWID()) {\n+            c.getSession().close(true);\n+            return;\n+        }\n+        \n+        IoSession session = c.getSession();\n+        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n             c.getSession().close(true);\n@@ -37,13 +81,6 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int channel = Randomizer.rand(1, wserv.getChannelsSize());\n         c.setChannel(channel);\n         \n-        String macs = slea.readMapleAsciiString();\n-        c.updateMacs(macs);\n-        if (c.hasBannedMac()) {\n-            c.getSession().close(true);\n-            return;\n-        }\n-        \n         if (c.checkPic(pic)) {\n             String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n             if(socket == null) {"}, {"sha": "e71c533ffc12fddf3dab52198f06d1af3646198c", "filename": "src/net/server/worker/LoginStorageWorker.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/worker/LoginStorageWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/worker/LoginStorageWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/LoginStorageWorker.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -20,6 +20,7 @@\n package net.server.worker;\n \n import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleLoginBypassCoordinator;\n \n /**\n  *\n@@ -30,5 +31,6 @@\n     @Override\n     public void run() {\n         MapleSessionCoordinator.getInstance().runUpdateLoginHistory();\n+        MapleLoginBypassCoordinator.getInstance().runUpdateLoginBypass();\n     }\n }"}, {"sha": "f4228208fa3f5da0872fee856f54a18251970eca", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -409,6 +409,11 @@ public int compare(Entry<Integer, SortedMap<Integer, MapleCharacter>> o1, Entry<\n         return list;\n     }\n     \n+    public List<MapleCharacter> loadAndGetAllCharactersView() {\n+        Server.getInstance().loadAllAccountsCharactersView();\n+        return getAllCharactersView();\n+    }\n+    \n     public List<MapleCharacter> getAllCharactersView() {    // sorted by accountid, charid\n         List<MapleCharacter> chrList = new LinkedList<>();\n         Map<Integer, SortedMap<Integer, MapleCharacter>> accChars;\n@@ -598,8 +603,7 @@ public void setGuildAndRank(int cid, int guildid, int rank) {\n             mc.saveGuildStatus();\n         }\n         if (bDifferentGuild) {\n-            mc.getMap().broadcastMessage(mc, MaplePacketCreator.removePlayerFromMap(cid), false);\n-            mc.getMap().broadcastMessage(mc, MaplePacketCreator.spawnPlayerMapObject(mc), false);\n+            mc.broadcastStance();\n         }\n     }\n "}, {"sha": "5d76522c9ec4fb10937b29f5ee482cd713ad6cfe", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -1063,4 +1063,8 @@ public static String getFirstJobStatRequirement(int jobType) {\n                 \n                 return null;\n         }\n+        \n+        public void npcTalk(int npcid, String message) {\n+                c.announce(MaplePacketCreator.getNPCTalk(npcid, (byte) 0, message, \"00 00\", (byte) 0));\n+        }\n }"}, {"sha": "31a2d7c81b5a0c2c0fe9029fd3d1ea3b171bee6c", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -60,6 +60,8 @@\n import constants.ItemConstants;\n import java.awt.Point;\n import java.util.Arrays;\n+import server.MapleSkillbookInformationProvider;\n+import server.MapleSkillbookInformationProvider.SkillBookEntry;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n \n@@ -545,4 +547,9 @@ public boolean isUsingOldPqNpcStyle() {\n                 return MapleItemInformationProvider.getInstance().getWhoDrops(itemId).toArray();\n         }\n         \n+        public String getSkillBookInfo(int itemid) {\n+                SkillBookEntry sbe = MapleSkillbookInformationProvider.getInstance().getSkillbookAvailability(itemid);\n+                return sbe != SkillBookEntry.UNAVAILABLE ? \"    Obtainable through #rquestline#k.\" : \"\";\n+        }\n+        \n }"}, {"sha": "3bf5a440a7ce291e10a607cd4e444e02687976fc", "filename": "src/scripting/npc/NPCScriptManager.java", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/npc/NPCScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/scripting/npc/NPCScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCScriptManager.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -50,6 +50,15 @@ public static NPCScriptManager getInstance() {\n     private Map<MapleClient, NPCConversationManager> cms = new HashMap<>();\n     private Map<MapleClient, Invocable> scripts = new HashMap<>();\n     \n+    public boolean isNpcScriptAvailable(MapleClient c, String fileName) {\n+        Invocable iv = null;\n+        if (fileName != null) {\n+            iv = getInvocable(\"npc/\" + fileName + \".js\", c);\n+        }\n+        \n+        return iv != null;\n+    }\n+    \n     public boolean start(MapleClient c, int npc, MapleCharacter chr) {\n         return start(c, npc, null, chr);\n     }"}, {"sha": "6ebb3bd3d93cb4d113c044f6205b49c3e21548cf", "filename": "src/server/CashShop.java", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -379,13 +379,16 @@ public void open(boolean b) {\n     }\n \n     public Item findByCashId(int cashId) {\n-        boolean isRing = false;\n+        boolean isRing;\n         Equip equip = null;\n         for (Item item : getInventory()) {\n             if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                 equip = (Equip) item;\n                 isRing = equip.getRingId() > -1;\n+            } else {\n+                isRing = false;\n             }\n+            \n             if ((item.getPetId() > -1 ? item.getPetId() : isRing ? equip.getRingId() : item.getCashId()) == cashId) {\n                 return item;\n             }"}, {"sha": "d5432dc6ef59c9a1c4b11219a7c11afa1b818f4c", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 3, "deletions": 12, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -641,21 +641,12 @@ public MapleWeaponType getWeaponType(int itemId) {\n         return type[cat - 30];\n     }\n \n-    private static double testYourLuck() {\n-        double result = 100.0, rolled;\n-        int i, j = ServerConstants.SCROLL_CHANCE_RATE;\n-        \n-        if(j < 1) j = 1;\n-        for(i = 0; i < j; i++) {\n-            rolled = Math.ceil(Math.random() * 100.0);\n-            if(result > rolled) result = rolled;\n-        }\n-        \n-        return(result);\n+    private static double testYourLuck(double prop, int dices) {   // revamped testYourLuck author: David A.\n+        return Math.pow(1.0 - prop, dices);\n     }\n     \n     public static boolean rollSuccessChance(double prop) {\n-        return(testYourLuck() <= prop && prop > 0.0);\n+        return Math.random() > testYourLuck(prop / 100.0, ServerConstants.SCROLL_CHANCE_RATE);\n     }\n     \n     private static short getMaximumShortMaxIfOverflow(int value1, int value2) {"}, {"sha": "90d37eb3c32a6cf6d1008f085c46d8c1a5112ba0", "filename": "src/server/MapleSkillbookInformationProvider.java", "status": "added", "additions": 358, "deletions": 0, "changes": 358, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleSkillbookInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleSkillbookInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleSkillbookInformationProvider.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,358 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+import java.util.Scanner;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import tools.DatabaseConnection;\n+\n+/**\n+ *\n+ * @author RonanLana\n+ */\n+public class MapleSkillbookInformationProvider {\n+    private final static MapleSkillbookInformationProvider instance = new MapleSkillbookInformationProvider();\n+    \n+    public static MapleSkillbookInformationProvider getInstance() {\n+        return instance;\n+    }\n+    \n+    protected static Map<Integer, SkillBookEntry> foundSkillbooks = new HashMap<>();\n+    \n+    public enum SkillBookEntry {\n+        UNAVAILABLE,\n+        QUEST,\n+        REACTOR,\n+        SCRIPT\n+    }\n+    \n+    static String host = \"jdbc:mysql://localhost:3306/heavenms\";\n+    static String driver = \"com.mysql.jdbc.Driver\";\n+    static String username = \"root\";\n+    static String password = \"\";\n+\n+    static String wzPath = \"wz\";\n+    static String rootDirectory = \".\";\n+    \n+    static InputStreamReader fileReader = null;\n+    static BufferedReader bufferedReader = null;\n+    \n+    static int initialStringLength = 50;\n+    \n+    static int skillbookMinItemid = 2280000;\n+    static int skillbookMaxItemid = 2300000;  // exclusively\n+    \n+    static byte status = 0;\n+    static int questId = -1;\n+    static int isCompleteState = 0;\n+    \n+    static int currentItemid = 0;\n+    static int currentCount = 0;\n+    \n+    static {\n+        loadSkillbooks();\n+    }\n+\n+    private static String getName(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+        \n+        i = token.lastIndexOf(\"name\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        if(j < i) {           //node value containing 'name' in it's scope, cheap fix since we don't deal with strings anyway\n+            System.out.println(\"[CRITICAL] Found this '\" + token + \"'\");\n+            return \"0\";\n+        }\n+        \n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static String getValue(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"value\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static void forwardCursor(int st) {\n+        String line = null;\n+\n+        try {\n+            while(status >= st && (line = bufferedReader.readLine()) != null) {\n+                simpleToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static void simpleToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        }\n+    }\n+    \n+    private static void inspectQuestItemList(int st) {\n+        String line = null;\n+\n+        try {\n+            while(status >= st && (line = bufferedReader.readLine()) != null) {\n+                readItemToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public static boolean isSkillBook(int itemid) {\n+        return itemid >= skillbookMinItemid && itemid < skillbookMaxItemid;\n+    }\n+    \n+    private static void processCurrentItem() {\n+        try {\n+            if(isSkillBook(currentItemid)) {\n+                if(currentCount > 0) {\n+                    foundSkillbooks.put(currentItemid, SkillBookEntry.QUEST);\n+                }\n+            }\n+        } catch(Exception e) {}\n+    }\n+    \n+    private static void readItemToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+            \n+            processCurrentItem();\n+            \n+            currentItemid = 0;\n+            currentCount = 0;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        }\n+        else {\n+            String d = getName(token);\n+            \n+            if(d.equals(\"id\")) {\n+                currentItemid = Integer.parseInt(getValue(token));\n+            } else if(d.equals(\"count\")) {\n+                currentCount = Integer.parseInt(getValue(token));\n+            }\n+        }\n+    }\n+\n+    private static void translateActToken(String token) {\n+        String d;\n+        int temp;\n+\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            if(status == 1) {           //getting QuestId\n+                d = getName(token);\n+                questId = Integer.parseInt(d);\n+            }\n+            else if(status == 2) {      //start/complete\n+                d = getName(token);\n+                isCompleteState = Integer.parseInt(d);\n+            }\n+            else if(status == 3) {\n+                d = getName(token);\n+\n+                if(d.contains(\"item\")) {\n+                    temp = status;\n+                    inspectQuestItemList(temp);\n+                } else {\n+                    forwardCursor(status);\n+                }\n+            }\n+\n+            status += 1;\n+        }\n+    }\n+    \n+    private static void fetchSkillbooksFromQuests() {\n+        String line;\n+        try {\n+            fileReader = new InputStreamReader(new FileInputStream(wzPath + \"/Quest.wz/Act.img.xml\"), \"UTF-8\");\n+            bufferedReader = new BufferedReader(fileReader);\n+\n+            while((line = bufferedReader.readLine()) != null) {\n+                translateActToken(line);\n+            }\n+\n+            bufferedReader.close();\n+            fileReader.close();\n+        } catch(IOException ioe) {\n+            System.out.println(\"Failed to read Quest.wz file.\");\n+            ioe.printStackTrace();\n+        }\n+    }\n+    \n+    private static void fetchSkillbooksFromReactors() {\n+        Connection con = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            \n+            PreparedStatement ps = con.prepareStatement(\"SELECT itemid FROM reactordrops WHERE itemid >= ? AND itemid < ?;\");\n+            ps.setInt(1, skillbookMinItemid);\n+            ps.setInt(2, skillbookMaxItemid);\n+            ResultSet rs = ps.executeQuery();\n+\n+            if (rs.isBeforeFirst()) {\n+                while(rs.next()) {\n+                    foundSkillbooks.put(rs.getInt(\"itemid\"), SkillBookEntry.REACTOR);\n+                }\n+            }\n+\n+            rs.close();\n+            ps.close();\n+            \n+            con.close();\n+        } catch (SQLException sqle) {\n+            sqle.printStackTrace();\n+        }\n+    }\n+    \n+    private static void listFiles(String directoryName, ArrayList<File> files) {\n+        File directory = new File(directoryName);\n+\n+        // get all the files from a directory\n+        File[] fList = directory.listFiles();\n+        for (File file : fList) {\n+            if (file.isFile()) {\n+                files.add(file);\n+            } else if (file.isDirectory()) {\n+                listFiles(file.getAbsolutePath(), files);\n+            }\n+        }\n+    }\n+    \n+    private static List<File> listFilesFromDirectoryRecursively(String directory) {\n+        ArrayList<File> files = new ArrayList<>();\n+        listFiles(directory, files);\n+        \n+        return files;\n+    }\n+    \n+    private static void filterScriptDirectorySearchMatchingData(String path) {\n+        for (File file : listFilesFromDirectoryRecursively(rootDirectory + \"/\" + path)) {\n+            if (file.getName().endsWith(\".js\")) {\n+                fileSearchMatchingData(file);\n+            }\n+        }\n+    }\n+    \n+    private static Set<Integer> foundMatchingDataOnFile(String fileContent) {\n+        Set<Integer> matches = new HashSet<>(4);\n+        \n+        Matcher searchM = Pattern.compile(\"22(8|9)[0-9]{4}\").matcher(fileContent);\n+        int idx = 0;\n+        while (searchM.find(idx)) {\n+            idx = searchM.end();\n+            matches.add(Integer.valueOf(fileContent.substring(searchM.start(), idx)));\n+        }\n+        \n+        return matches;\n+    }\n+    \n+    static String readFileToString(File file, String encoding) throws IOException {\n+        Scanner scanner = new Scanner(file, encoding);\n+        String text = \"\";\n+        try {\n+            try {\n+                text = scanner.useDelimiter(\"\\\\A\").next();\n+            } finally {\n+                scanner.close();\n+            }\n+        } catch (NoSuchElementException e) {}\n+        \n+        return text;\n+    }\n+    \n+    private static void fileSearchMatchingData(File file) {\n+        try {\n+            String fileContent = readFileToString(file, \"UTF-8\");\n+            \n+            Set<Integer> books = foundMatchingDataOnFile(fileContent);\n+            for (Integer i : books) {\n+                foundSkillbooks.put(i, SkillBookEntry.SCRIPT);\n+            }\n+        } catch (IOException ioe) {\n+            System.out.println(\"Failed to read \" + file.getName() + \".\");\n+            ioe.printStackTrace();\n+        }\n+    }\n+    \n+    private static void fetchSkillbooksFromScripts() {\n+        filterScriptDirectorySearchMatchingData(\"scripts\");\n+    }\n+    \n+    private static void loadSkillbooks() {\n+        fetchSkillbooksFromQuests();\n+        fetchSkillbooksFromReactors();\n+        fetchSkillbooksFromScripts();\n+    }\n+    \n+    public SkillBookEntry getSkillbookAvailability(int itemid) {\n+        SkillBookEntry sbe = foundSkillbooks.get(itemid);\n+        return sbe != null ? sbe : SkillBookEntry.UNAVAILABLE;\n+    }\n+    \n+}"}, {"sha": "8bf876c81730779687a72937e55d9a3443607d98", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -753,10 +753,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         } else {\n             if (isResurrection()) {\n                 hpchange = applyto.getCurrentMaxHp();\n-                applyto.setStance(0);\n-                \n-                applyto.getMap().broadcastMessage(applyto, MaplePacketCreator.removePlayerFromMap(applyto.getId()), false);\n-                applyto.getMap().broadcastMessage(applyto, MaplePacketCreator.spawnPlayerMapObject(applyto), false);\n+                applyto.broadcastStance(applyto.isFacingLeft() ? 5 : 4);\n             }\n         }\n         \n@@ -895,9 +892,6 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             applyfrom.getMap().spawnMist(mist, getDuration(), mist.isPoisonMist(), false, mist.isRecoveryMist());\n         } else if(isTimeLeap()) {\n             applyto.removeAllCooldownsExcept(Buccaneer.TIME_LEAP, true);\n-        } else if(isHyperBody() && !primary) {\n-            applyto.getMap().broadcastMessage(applyto, MaplePacketCreator.removePlayerFromMap(applyto.getId()), false);\n-            applyto.getMap().broadcastMessage(applyto, MaplePacketCreator.spawnPlayerMapObject(applyto), false);\n         }\n         \n         return true;"}, {"sha": "e8ad6fb262b732d8e7c61387c00e98cdf55f7ceb", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -445,8 +445,14 @@ private void distributeExperienceToParty(int pid, float exp, int killer, Set<Map\n     }\n \n     private int calcThresholdLevel(boolean isPqMob) {\n-        if(isPqMob || !ServerConstants.USE_ENFORCE_MOB_LEVEL_RANGE) {\n+        if(!ServerConstants.USE_ENFORCE_MOB_LEVEL_RANGE) {\n             return 0;\n+        } else if (isPqMob) {\n+            double thresholdLevel = getLevel();\n+            thresholdLevel /= 32.55916838;\n+            thresholdLevel = Math.log(thresholdLevel) / 0.02058204546;\n+            \n+            return (int) Math.ceil(thresholdLevel);\n         } else {\n             return getLevel() - (!isBoss() ? ServerConstants.MIN_UNDERLEVEL_TO_EXP_GAIN : 2 * ServerConstants.MIN_UNDERLEVEL_TO_EXP_GAIN);\n         }"}, {"sha": "f956a04864ea273aa47cf1845a5c5b5c5653fb9c", "filename": "src/server/life/MaplePlayerNPC.java", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/life/MaplePlayerNPC.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/life/MaplePlayerNPC.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MaplePlayerNPC.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -613,7 +613,14 @@ public static void removePlayerNPC(MapleCharacter chr) {\n     \n     public static void multicastSpawnPlayerNPC(int mapid, int world) {\n         World wserv = Server.getInstance().getWorld(world);\n-        for(MapleCharacter mc : wserv.getAllCharactersView()) {\n+        if (wserv == null) return;\n+        \n+        MapleClient c = new MapleClient(null, null, null);  // mock client\n+        c.setWorld(world);\n+        c.setChannel(1);\n+        \n+        for(MapleCharacter mc : wserv.loadAndGetAllCharactersView()) {\n+            mc.setClient(c);\n             spawnPlayerNPC(mapid, mc);\n         }\n     }\n@@ -630,14 +637,12 @@ public static void removeAllPlayerNPC() {\n                 int world = rs.getInt(\"world\"), map = rs.getInt(\"map\");\n                 if(world >= wsize) continue;\n                 \n-                World w = Server.getInstance().getWorld(world);\n-                for (Channel channel : w.getChannels()) {\n+                for (Channel channel : Server.getInstance().getChannelsFromWorld(world)) {\n                     MapleMap m = channel.getMapFactory().getMap(map);\n                     \n                     for(MapleMapObject pnpcObj : m.getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.PLAYER_NPC))) {\n                         MaplePlayerNPC pn = (MaplePlayerNPC) pnpcObj;\n-\n-                        m.removeMapObject(pn);\n+                        m.removeMapObject(pnpcObj);\n                         m.broadcastMessage(MaplePacketCreator.removeNPCController(pn.getObjectId()));\n                         m.broadcastMessage(MaplePacketCreator.removePlayerNPC(pn.getObjectId()));\n                     }"}, {"sha": "d7fd94401e7935d0321ab2ba47e686c5a1a470bf", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 48, "deletions": 6, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -427,8 +427,9 @@ private int getUsableOID() {\n         try {\n             Integer curOid;\n             \n+            // clashes with playernpc on curOid >= 2147000000, developernpc uses >= 2147483000\n             do {\n-                if ((curOid = runningOid.incrementAndGet()) < 0) {  // clashes with playernpc on curOid >= 2147000000, developernpc uses >= 2147483000\n+                if ((curOid = runningOid.incrementAndGet()) >= 2147000000) {\n                     runningOid.set(curOid = 1000000001);\n                 }\n             } while (mapobjects.containsKey(curOid));\n@@ -1610,9 +1611,6 @@ public MapleNPC getNPCById(int id) {\n     }\n     \n     public boolean containsNPC(int npcid) {\n-        if (npcid == 9000066) {\n-            return true;\n-        }\n         objectRLock.lock();\n         try {\n             for (MapleMapObject obj : mapobjects.values()) {\n@@ -2453,13 +2451,13 @@ public void run() {\n         chr.removeSandboxItems();\n         \n         if (chr.isHidden()) {\n-            broadcastGMMessage(chr, MaplePacketCreator.spawnEnterPlayerMapObject(chr), false);\n+            broadcastGMSpawnPlayerMapObjectMessage(chr, chr, true);\n             chr.announce(MaplePacketCreator.getGMEffect(0x10, (byte) 1));\n \n             List<Pair<MapleBuffStat, Integer>> dsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n             broadcastGMMessage(chr, MaplePacketCreator.giveForeignBuff(chr.getId(), dsstat), false);\n         } else {\n-            broadcastMessage(chr, MaplePacketCreator.spawnEnterPlayerMapObject(chr), false);\n+            broadcastSpawnPlayerMapObjectMessage(chr, chr, true);\n         }\n \n         sendObjectPlacement(chr.getClient());\n@@ -2781,6 +2779,50 @@ private void broadcastItemDropMessage(MapleMapItem mdrop, Point dropperPos, Poin\n         }\n     }\n     \n+    public void broadcastSpawnPlayerMapObjectMessage(MapleCharacter source, MapleCharacter player, boolean enteringField) {\n+        broadcastSpawnPlayerMapObjectMessage(source, player, enteringField, false);\n+    }\n+            \n+    public void broadcastGMSpawnPlayerMapObjectMessage(MapleCharacter source, MapleCharacter player, boolean enteringField) {\n+        broadcastSpawnPlayerMapObjectMessage(source, player, enteringField, true);\n+    }\n+    \n+    private void broadcastSpawnPlayerMapObjectMessage(MapleCharacter source, MapleCharacter player, boolean enteringField, boolean gmBroadcast) {\n+        chrRLock.lock();\n+        try {\n+            if (gmBroadcast) {\n+                for (MapleCharacter chr : characters) {\n+                    if (chr.isGM()) {\n+                        if (chr != source) {\n+                            chr.announce(MaplePacketCreator.spawnPlayerMapObject(chr.getClient(), player, enteringField));\n+                        }\n+                    }\n+                }\n+            } else {\n+                for (MapleCharacter chr : characters) {\n+                    if (chr != source) {\n+                        chr.announce(MaplePacketCreator.spawnPlayerMapObject(chr.getClient(), player, enteringField));\n+                    }\n+                }\n+            }\n+        } finally {\n+            chrRLock.unlock();\n+        }\n+    }\n+    \n+    public void broadcastUpdateCharLookMessage(MapleCharacter source, MapleCharacter player) {\n+        chrRLock.lock();\n+        try {\n+            for (MapleCharacter chr : characters) {\n+                if (chr != source) {\n+                    chr.announce(MaplePacketCreator.updateCharLook(chr.getClient(), player));\n+                }\n+            }\n+        } finally {\n+            chrRLock.unlock();\n+        }\n+    }\n+    \n     public void dropMessage(int type, String message) {\n         broadcastStringMessage(type, message);\n     }"}, {"sha": "e1b964c9f958f1ea2d2021aae22b0fa4a862b992", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -71,6 +71,7 @@\n     private boolean autoStart;\n     private boolean autoPreComplete, autoComplete;\n     private boolean repeatable = false;\n+    private String name = \"\", parent = \"\";\n     private final static MapleDataProvider questData = MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Quest.wz\"));\n     private static MapleData questInfo;\n     private static MapleData questAct;\n@@ -87,6 +88,9 @@ private MapleQuest(int id) {\n         if(questInfo != null) {\n             MapleData reqInfo = questInfo.getChildByPath(String.valueOf(id));\n             if(reqInfo != null) {\n+                name = MapleDataTool.getString(\"name\", reqInfo, \"\");\n+                parent = MapleDataTool.getString(\"parent\", reqInfo, \"\");\n+                \n                 timeLimit = MapleDataTool.getInt(\"timeLimit\", reqInfo, 0);\n                 timeLimit2 = MapleDataTool.getInt(\"timeLimit2\", reqInfo, 0);\n                 autoStart = MapleDataTool.getInt(\"autoStart\", reqInfo, 0) == 1;\n@@ -550,6 +554,27 @@ public int getNpcRequirement(boolean complete) {\n                 }\n         }\n         \n+        public String getName() {\n+                return name;\n+        }\n+        \n+        public String getParentName() {\n+                return parent;\n+        }\n+        \n+        public static List<MapleQuest> getMatchedQuests(String search) {\n+                List<MapleQuest> ret = new LinkedList<>();\n+                \n+                search = search.toLowerCase();\n+                for (MapleQuest mq : quests.values()) {\n+                        if (mq.name.toLowerCase().contains(search) || mq.parent.toLowerCase().contains(search)) {\n+                                ret.add(mq);\n+                        }\n+                }\n+                \n+                return ret;\n+        }\n+        \n \tpublic static void loadAllQuest() {\n \t\tquestInfo = questData.getData(\"QuestInfo.img\");\n \t\tquestReq = questData.getData(\"Check.img\");"}, {"sha": "6ce86148ec5bc05e076572bcf680173f7a4750a0", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 29, "deletions": 29, "changes": 58, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -713,13 +713,13 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n                 mplew.write(0);\n                 \n                 mplew.write(0); // IsQuietBan\n-        \t\tmplew.writeLong(0);//IsQuietBanTimeStamp\n-        \t\tmplew.writeLong(0); //CreationTimeStamp\n+                mplew.writeLong(0);//IsQuietBanTimeStamp\n+                mplew.writeLong(0); //CreationTimeStamp\n \n                 mplew.writeInt(1); // 1: Remove the \"Select the world you want to play in\"\n-\n-                mplew.write(ServerConstants.ENABLE_PIN ? 0 : 1); // 0 = Pin-System Enabled, 1 = Disabled\n-                mplew.write(ServerConstants.ENABLE_PIC ? (c.getPic() == null ? 0 : 1) : 2); // 0 = Register PIC, 1 = Ask for PIC, 2 = Disabled\n+                \n+                mplew.write(ServerConstants.ENABLE_PIN && !c.canBypassPin() ? 0 : 1); // 0 = Pin-System Enabled, 1 = Disabled\n+                mplew.write(ServerConstants.ENABLE_PIC && !c.canBypassPic() ? (c.getPic() == null ? 0 : 1) : 2); // 0 = Register PIC, 1 = Ask for PIC, 2 = Disabled\n                 \n                 return mplew.getPacket();\n         }\n@@ -889,7 +889,7 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n                         addCharEntry(mplew, chr, false);\n                 }\n \n-                mplew.write(ServerConstants.ENABLE_PIC ? (c.getPic() == null ? 0 : 1) : 2);\n+                mplew.write(ServerConstants.ENABLE_PIC && !c.canBypassPic() ? (c.getPic() == null ? 0 : 1) : 2);\n                 mplew.writeInt(ServerConstants.COLLECTIVE_CHARSLOT ? chars.size() + c.getAvailableCharacterSlots() : c.getCharacterSlots());\n                 return mplew.getPacket();\n         }\n@@ -1049,7 +1049,7 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.writeShort(chr.getHp());\n                 mplew.writeBool(false);\n                 mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n-                mplew.writeInt(0);\n+                mplew.skip(5);\n                 return mplew.getPacket();\n         }\n         \n@@ -1066,7 +1066,7 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.writeInt(spawnPosition.x);    // spawn position placement thanks to Arnah (Vertisy)\n                 mplew.writeInt(spawnPosition.y);\n                 mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n-                mplew.writeInt(0);\n+                mplew.skip(5);\n                 return mplew.getPacket();\n         }\n         \n@@ -1829,19 +1829,12 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n         /**\n          * Gets a packet spawning a player as a mapobject to other clients.\n          *\n+         * @param target The client receiving this packet.\n          * @param chr The character to spawn to other clients.\n+         * @param enteringField Whether the character to spawn is not yet present in the map or already is.\n          * @return The spawn player packet.\n          */\n-        \n-        public static byte[] spawnPlayerMapObject(MapleCharacter chr) {\n-                return spawnPlayerMapObject(chr, false);\n-        }\n-        \n-        public static byte[] spawnEnterPlayerMapObject(MapleCharacter chr) {\n-                return spawnPlayerMapObject(chr, true);\n-        }\n-        \n-        private static byte[] spawnPlayerMapObject(MapleCharacter chr, boolean enteringField) {\n+        public static byte[] spawnPlayerMapObject(MapleClient target, MapleCharacter chr, boolean enteringField) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.SPAWN_PLAYER.getValue());\n                 mplew.writeInt(chr.getId());\n@@ -2013,7 +2006,7 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 }\n                 addRingLook(mplew, chr, true);  // crush\n                 addRingLook(mplew, chr, false); // friendship\n-                addMarriageRingLook(mplew, chr);\n+                addMarriageRingLook(target, mplew, chr);\n                 encodeNewYearCardInfo(mplew, chr);  // new year seems to crash sometimes...\n                 mplew.skip(2);\n                 mplew.write(chr.getTeam());//only needed in specific fields\n@@ -2137,17 +2130,23 @@ private static void addRingLook(final MaplePacketLittleEndianWriter mplew, Maple\n                 }\n         }\n \n-        private static void addMarriageRingLook(final MaplePacketLittleEndianWriter mplew, MapleCharacter chr) {\n+        private static void addMarriageRingLook(MapleClient target, final MaplePacketLittleEndianWriter mplew, MapleCharacter chr) {\n                 MapleRing ring = chr.getMarriageRing();\n             \n-                if (ring != null && !ring.equipped()) {\n+                if (ring == null || !ring.equipped()) {\n                         mplew.write(0);\n-                        return;\n-                }\n-                mplew.writeBool(ring != null);\n-                if (ring != null) {\n-                        mplew.writeInt(chr.getId());\n-                        mplew.writeInt(ring.getPartnerChrId());\n+                } else {\n+                        mplew.write(1);\n+                        \n+                        MapleCharacter targetChr = target.getPlayer();\n+                        if (targetChr != null && targetChr.getPartnerId() == chr.getId()) {\n+                            mplew.writeInt(0);    // 1a pessoa: ser 0 0 implica match...\n+                            mplew.writeInt(0);    // 3a pessoa: 1 2 2 1 funciona!\n+                        } else {\n+                            mplew.writeInt(chr.getId());    // 1a pessoa: ser 0 0 implica match...\n+                            mplew.writeInt(ring.getPartnerChrId());    // 3a pessoa: 1 2 2 1 funciona!\n+                        }\n+                        \n                         mplew.writeInt(ring.getItemId());\n                 }\n         }\n@@ -2558,15 +2557,15 @@ private static int doubleToShortBits(double d) {\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] updateCharLook(MapleCharacter chr) {\n+        public static byte[] updateCharLook(MapleClient target, MapleCharacter chr) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.UPDATE_CHAR_LOOK.getValue());\n                 mplew.writeInt(chr.getId());\n                 mplew.write(1);\n                 addCharLook(mplew, chr, false);\n                 addRingLook(mplew, chr, true);\n                 addRingLook(mplew, chr, false);\n-                addMarriageRingLook(mplew, chr);\n+                addMarriageRingLook(target, mplew, chr);\n                 mplew.writeInt(0);\n                 return mplew.getPacket();\n         }\n@@ -2913,6 +2912,7 @@ private static int doubleToShortBits(double d) {\n                 }\n \n                 mplew.writeMapleAsciiString(q.getQuestData());\n+                mplew.skip(5);\n                 return mplew.getPacket();\n         }\n "}, {"sha": "162d963a0e6c7105126baf3071dd4d76d982e370", "filename": "tools/MapleWorldmapChecker/build.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/build.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/build.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleWorldmapChecker/build.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleWorldmapChecker\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleWorldmapChecker.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleWorldmapChecker-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "781ea1284f0d4b54414aaf24c3764881c28d8a22", "filename": "tools/MapleWorldmapChecker/lib/Report.txt", "status": "added", "additions": 76, "deletions": 0, "changes": 76, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/lib/Report.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/lib/Report.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleWorldmapChecker/lib/Report.txt?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,76 @@\n+ # Report File autogenerated from the MapleWorldmapChecker feature by Ronan Lana.\n+ # Generated data takes into account several data info from the server-side WZ.xmls.\n+\n+Missing mapid references in top hierarchy:\n+\n+'WorldMap000.img.xml':\n+  1020000:WorldMap.img.xml\n+\n+\n+'WorldMap010.img.xml':\n+  101000400:WorldMap.img.xml\n+  105040306:WorldMap.img.xml\n+  105050500:WorldMap.img.xml\n+  193000000:WorldMap.img.xml\n+  680000100:WorldMap.img.xml\n+  680000110:WorldMap.img.xml\n+  680000200:WorldMap.img.xml\n+  680000210:WorldMap.img.xml\n+  680000300:WorldMap.img.xml\n+  680000400:WorldMap.img.xml\n+  680000401:WorldMap.img.xml\n+  680010000:WorldMap.img.xml\n+  680010100:WorldMap.img.xml\n+\n+\n+'WorldMap012.img.xml':\n+  107000500:WorldMap010.img.xml\n+\n+\n+'WorldMap014.img.xml':\n+  106021401:WorldMap010.img.xml\n+  106021402:WorldMap010.img.xml\n+  106021800:WorldMap010.img.xml\n+\n+\n+'WorldMap020.img.xml':\n+  200080101:WorldMap.img.xml\n+  200082301:WorldMap.img.xml\n+  211040401:WorldMap.img.xml\n+\n+\n+'WorldMap021.img.xml':\n+  280030000:WorldMap020.img.xml\n+\n+\n+'WorldMap030.img.xml':\n+  220010001:WorldMap.img.xml\n+  220011001:WorldMap.img.xml\n+  221022100:WorldMap.img.xml\n+  221022200:WorldMap.img.xml\n+  222010310:WorldMap.img.xml\n+\n+\n+'WorldMap050.img.xml':\n+  240040201:WorldMap.img.xml\n+  240040301:WorldMap.img.xml\n+\n+\n+'WorldMap060.img.xml':\n+  251000100:WorldMap.img.xml\n+  251010404:WorldMap.img.xml\n+\n+\n+'WorldMap100.img.xml':\n+  140020110:WorldMap.img.xml\n+\n+\n+'WorldMap142.img.xml':\n+  600010002:WorldMap.img.xml\n+\n+\n+'WorldMap211.img.xml':\n+  801040100:WorldMap210.img.xml\n+  801040101:WorldMap210.img.xml\n+\n+"}, {"sha": "328e8e5bc3b7f1f7bad2bc0751a933e00c801983", "filename": "tools/MapleWorldmapChecker/manifest.mf", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/manifest.mf", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/manifest.mf", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleWorldmapChecker/manifest.mf?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,3 @@\n+Manifest-Version: 1.0\n+X-COMMENT: Main-Class will be added automatically by build\n+"}, {"sha": "4006d476ab462bcb6e76d8e426e454d5571831e7", "filename": "tools/MapleWorldmapChecker/src/mapleworldmapchecker/MapleWorldmapChecker.java", "status": "added", "additions": 316, "deletions": 0, "changes": 316, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/src/mapleworldmapchecker/MapleWorldmapChecker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/src/mapleworldmapchecker/MapleWorldmapChecker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleWorldmapChecker/src/mapleworldmapchecker/MapleWorldmapChecker.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,316 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package mapleworldmapchecker;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+/**\n+ *\n+ * @author RonanLana\n+ \n+ This application parses the Map.wz file inputted and reports areas (mapids) that are supposed to be referenced \n+ throughout the map tree (area map -> continent map -> world map) but are currently missing.\n+ \n+ */\n+public class MapleWorldmapChecker {\n+    \n+    static String newFile = \"lib/Report.txt\";\n+    static PrintWriter printWriter = null;\n+    static InputStreamReader fileReader = null;\n+    static BufferedReader bufferedReader = null;\n+    \n+    static String worldmapPath = \"../../wz/Map.wz/WorldMap\";\n+    static int initialStringLength = 50;\n+    \n+    static Map<String, Set<Integer>> worldMapids = new HashMap<>();\n+    static Map<String, String> parentWorldmaps = new HashMap<>();\n+    static Set<String> rootWorldmaps = new HashSet<>();\n+    //static String rootWorldmap = \"\";\n+    \n+    static Set<Integer> currentWorldMapids;\n+    static String currentParent;\n+    \n+    static byte status = 0;\n+    static boolean isInfo;\n+    \n+    private static String getName(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"name\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static String getValue(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"value\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static void forwardCursor(int st) {\n+        String line = null;\n+\n+        try {\n+            while(status >= st && (line = bufferedReader.readLine()) != null) {\n+                simpleToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static void simpleToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        }\n+    }\n+    \n+    private static void translateToken(String token) {\n+        String d;\n+        \n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+            \n+            if (status == 2) {\n+                d = getName(token);\n+                \n+                switch (d) {\n+                    case \"MapList\":\n+                        isInfo = false;\n+                        break;\n+                        \n+                    case \"info\":\n+                        isInfo = true;\n+                        break;\n+                        \n+                    default:\n+                        forwardCursor(status);\n+                }\n+            } else if (status == 4) {\n+                d = getName(token);\n+                \n+                if (!d.contentEquals(\"mapNo\")) {\n+                    forwardCursor(status);\n+                }\n+            }\n+        }\n+        else {\n+            if (status == 4) {\n+                currentWorldMapids.add(Integer.valueOf(getValue(token)));\n+            } else if (status == 2 && isInfo) {\n+                try {\n+                    d = getName(token);\n+                    if (d.contentEquals(\"parentMap\")) {\n+                        currentParent = (getValue(token) + \".img.xml\");\n+                    } else {\n+                        forwardCursor(status);\n+                    }\n+                } catch (Exception e) {\n+                    System.out.println(\"failed '\" + token + \"'\");\n+                    \n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void parseWorldmapFile(File worldmapFile) throws IOException {\n+        String line;\n+        \n+        fileReader = new InputStreamReader(new FileInputStream(worldmapFile), \"UTF-8\");\n+        bufferedReader = new BufferedReader(fileReader);\n+        \n+        currentParent = \"\";\n+        status = 0;\n+        \n+        currentWorldMapids = new HashSet<>();\n+        while((line = bufferedReader.readLine()) != null) {\n+            translateToken(line);\n+        }\n+        \n+        String worldmapName = worldmapFile.getName();\n+        worldMapids.put(worldmapName, currentWorldMapids);\n+        \n+        if (!currentParent.isEmpty()) parentWorldmaps.put(worldmapName, currentParent);\n+        else rootWorldmaps.add(worldmapName);\n+\n+        bufferedReader.close();\n+        fileReader.close();\n+    }\n+    \n+    private static void parseWorldmapDirectory() {\n+        System.out.println(\"Parsing directory '\" + worldmapPath + \"'\");\n+        File folder = new File(worldmapPath);\n+        for (File file : folder.listFiles()) {\n+            if (file.isFile()) {\n+                try {\n+                    parseWorldmapFile(file);\n+                }\n+                catch(FileNotFoundException ex) {\n+                    System.out.println(\"Unable to open worldmap file \" + file.getAbsolutePath() + \".\");\n+                }\n+                catch(IOException ex) {\n+                    System.out.println(\"Error reading worldmap file \" + file.getAbsolutePath() + \".\");\n+                }\n+\n+                catch(Exception e) {\n+                    e.printStackTrace();\n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void printReportFileHeader() {\n+        printWriter.println(\" # Report File autogenerated from the MapleWorldmapChecker feature by Ronan Lana.\");\n+        printWriter.println(\" # Generated data takes into account several data info from the server-side WZ.xmls.\");\n+        printWriter.println();\n+    }\n+    \n+    private static void printReportFileResults(List<Pair<String, List<Pair<Integer, String>>>> results) {\n+        printWriter.println(\"Missing mapid references in top hierarchy:\\n\");\n+        for (Pair<String, List<Pair<Integer, String>>> res : results) {\n+            printWriter.println(\"'\" + res.getLeft() + \"':\");\n+\n+            for (Pair<Integer, String> i : res.getRight()) {\n+                printWriter.println(\"  \" + i);\n+            }\n+\n+            printWriter.println(\"\\n\");\n+        }\n+    }\n+    \n+    private static void verifyWorldmapTreeMapids() {\n+        try {\n+            printWriter = new PrintWriter(newFile, \"UTF-8\");    \n+            printReportFileHeader();\n+            \n+            if (rootWorldmaps.size() > 1) {\n+                printWriter.println(\"[WARNING] Detected several root worldmaps: \" + rootWorldmaps + \"\\n\");\n+            }\n+            \n+            Set<String> worldmaps = new HashSet<>(parentWorldmaps.keySet());\n+            worldmaps.addAll(rootWorldmaps);\n+            \n+            Map<String, Set<Integer>> tempMapids = new HashMap<>(worldMapids.size());\n+            for (Entry<String, Set<Integer>> e : worldMapids.entrySet()) {\n+                tempMapids.put(e.getKey(), new HashSet<>(e.getValue()));\n+            }\n+            \n+            Map<String, List<Pair<Integer, String>>> unreferencedMapids = new HashMap<>();\n+            \n+            for (String s : worldmaps) {\n+                List<Pair<Integer, String>> currentUnreferencedMapids = new ArrayList<>();\n+\n+                for (Integer i : tempMapids.get(s)) {\n+                    String parent = parentWorldmaps.get(s);\n+                    \n+                    while (parent != null) {\n+                        Set<Integer> mapids = worldMapids.get(parent);\n+                        if (!mapids.contains(i)) {\n+                            currentUnreferencedMapids.add(new Pair<>(i, parent));\n+                            break;\n+                        } else {\n+                            tempMapids.get(parent).remove(i);\n+                        }\n+                        \n+                        parent = parentWorldmaps.get(parent);\n+                    }\n+                }\n+                \n+                if (!currentUnreferencedMapids.isEmpty()) {\n+                    unreferencedMapids.put(s, currentUnreferencedMapids);\n+                }\n+            }\n+            \n+            if (!unreferencedMapids.isEmpty()) {\n+                List<Pair<String, List<Pair<Integer, String>>>> unreferencedEntries = new ArrayList<>(20);\n+                for (Entry<String, List<Pair<Integer, String>>> e : unreferencedMapids.entrySet()) {\n+                    List<Pair<Integer, String>> list = new ArrayList<>(e.getValue());\n+                    Collections.sort(list, new Comparator<Pair<Integer, String>>() {\n+                        @Override\n+                        public int compare(Pair<Integer, String> o1, Pair<Integer, String> o2) {\n+                            return o1.getLeft().compareTo(o2.getLeft());\n+                        }\n+                    });\n+\n+                    unreferencedEntries.add(new Pair<>(e.getKey(), list));\n+                }\n+                \n+                Collections.sort(unreferencedEntries, new Comparator<Pair<String, List<Pair<Integer, String>>>>() {\n+                    @Override\n+                    public int compare(Pair<String, List<Pair<Integer, String>>> o1, Pair<String, List<Pair<Integer, String>>> o2) {\n+                        return o1.getLeft().compareTo(o2.getLeft());\n+                    }\n+                });\n+\n+                printReportFileResults(unreferencedEntries);\n+            }\n+            \n+            printWriter.close();\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+    \n+    public static void main(String[] args) {\n+        parseWorldmapDirectory();\n+        verifyWorldmapTreeMapids();\n+    }\n+    \n+}"}, {"sha": "4621929ba3a2a625032b48f80c99d401c020a64c", "filename": "tools/MapleWorldmapChecker/src/mapleworldmapchecker/Pair.java", "status": "added", "additions": 121, "deletions": 0, "changes": 121, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/src/mapleworldmapchecker/Pair.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/MapleWorldmapChecker/src/mapleworldmapchecker/Pair.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleWorldmapChecker/src/mapleworldmapchecker/Pair.java?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,121 @@\n+/*\n+This file is part of the OdinMS Maple Story Server\n+Copyright (C) 2008 ~ 2010 Patrick Huy <patrick.huy@frz.cc> \n+Matthias Butz <matze@odinms.de>\n+Jan Christian Meyer <vimes@odinms.de>\n+\n+This program is free software: you can redistribute it and/or modify\n+it under the terms of the GNU Affero General Public License version 3\n+as published by the Free Software Foundation. You may not use, modify\n+or distribute this program under any other version of the\n+GNU Affero General Public License.\n+\n+This program is distributed in the hope that it will be useful,\n+but WITHOUT ANY WARRANTY; without even the implied warranty of\n+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+GNU Affero General Public License for more details.\n+\n+You should have received a copy of the GNU Affero General Public License\n+along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package mapleworldmapchecker;\n+\n+/**\n+ * Represents a pair of values.\n+ * \n+ * @author Frz\n+ * @since Revision 333\n+ * @version 1.0\n+ * \n+ * @param <E> The type of the left value.\n+ * @param <F> The type of the right value.\n+ */\n+public class Pair<E, F> {\n+\n+    public E left;\n+    public F right;\n+\n+    /**\n+     * Class constructor - pairs two objects together.\n+     *\n+     * @param left The left object.\n+     * @param right The right object.\n+     */\n+    public Pair(E left, F right) {\n+        this.left = left;\n+        this.right = right;\n+    }\n+\n+    /**\n+     * Gets the left value.\n+     *\n+     * @return The left value.\n+     */\n+    public E getLeft() {\n+        return left;\n+    }\n+\n+    /**\n+     * Gets the right value.\n+     *\n+     * @return The right value.\n+     */\n+    public F getRight() {\n+        return right;\n+    }\n+\n+    /**\n+     * Turns the pair into a string.\n+     *\n+     * @return Each value of the pair as a string joined by a colon.\n+     */\n+    @Override\n+    public String toString() {\n+        return left.toString() + \":\" + right.toString();\n+    }\n+\n+    /**\n+     * Gets the hash code of this pair.\n+     */\n+    @Override\n+    public int hashCode() {\n+        final int prime = 31;\n+        int result = 1;\n+        result = prime * result + ((left == null) ? 0 : left.hashCode());\n+        result = prime * result + ((right == null) ? 0 : right.hashCode());\n+        return result;\n+    }\n+\n+    /**\n+     * Checks to see if two pairs are equal.\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+        if (obj == null) {\n+            return false;\n+        }\n+        if (getClass() != obj.getClass()) {\n+            return false;\n+        }\n+        final Pair other = (Pair) obj;\n+        if (left == null) {\n+            if (other.left != null) {\n+                return false;\n+            }\n+        } else if (!left.equals(other.left)) {\n+            return false;\n+        }\n+        if (right == null) {\n+            if (other.right != null) {\n+                return false;\n+            }\n+        } else if (!right.equals(other.right)) {\n+            return false;\n+        }\n+        return true;\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "40390bc48411db1bdf3d15c13cd4c3e3763eedd1", "filename": "tools/SQL/userstances.txt", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/SQL/userstances.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/tools/SQL/userstances.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/SQL/userstances.txt?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -0,0 +1,20 @@\n+0 walk right\n+1 walk left\n+2 walk right\n+3 walk left\n+4 stand right\n+5 stand left\n+6 jump right\n+7 jump left\n+8 defend right\n+9 defend left\n+10 prone right\n+11 prone left\n+12 swim right\n+13 swim left\n+14 15 ladder left\n+16 17 ladder mid\n+18 dead right\n+19 dead left\n+20 sit right\n+21 sit left\n\\ No newline at end of file"}, {"sha": "bb6ea59e8e229b04106211134303ebf67bbe4972", "filename": "wz/Item.wz/Etc/0403.img.xml", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Item.wz/Etc/0403.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Item.wz/Etc/0403.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Etc/0403.img.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -6204,7 +6204,7 @@\n       </canvas>\n       <int name=\"price\" value=\"0\"/>\n       <int name=\"notSale\" value=\"1\"/>\n-      <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"quest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04031524\">\n@@ -6217,7 +6217,7 @@\n       </canvas>\n       <int name=\"price\" value=\"0\"/>\n       <int name=\"notSale\" value=\"1\"/>\n-      <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"quest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04031525\">\n@@ -6257,7 +6257,7 @@\n       </canvas>\n       <int name=\"price\" value=\"0\"/>\n       <int name=\"notSale\" value=\"1\"/>\n-      <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"quest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04031528\">"}, {"sha": "708174ba51761574bbe16e17955150356630372a", "filename": "wz/Map.wz/WorldMap/WorldMap.img.xml", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap.img.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -32,6 +32,7 @@\n         <int name=\"15\" value=\"1010400\"/>\n         <int name=\"16\" value=\"2000000\"/>\n         <int name=\"17\" value=\"2000001\"/>\n+        <int name=\"18\" value=\"1020000\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"112\" height=\"125\">\n         <vector name=\"origin\" x=\"279\" y=\"180\"/>\n@@ -130,6 +131,7 @@\n         <int name=\"27\" value=\"101020008\"/>\n         <int name=\"28\" value=\"101020009\"/>\n         <int name=\"29\" value=\"101020010\"/>\n+        <int name=\"30\" value=\"101000400\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"215\" height=\"59\">\n         <vector name=\"origin\" x=\"214\" y=\"132\"/>\n@@ -230,6 +232,7 @@\n         <int name=\"41\" value=\"103040302\"/>\n         <int name=\"42\" value=\"103040303\"/>\n         <int name=\"43\" value=\"103040400\"/>\n+        <int name=\"44\" value=\"193000000\"/>\n       </imgdir>\n       <vector name=\"spot\" x=\"-273\" y=\"-99\"/>\n       <canvas name=\"path\" width=\"287\" height=\"116\">\n@@ -305,6 +308,8 @@\n         <int name=\"40\" value=\"105090800\"/>\n         <int name=\"41\" value=\"105090900\"/>\n         <int name=\"42\" value=\"107000500\"/>\n+        <int name=\"43\" value=\"105040306\"/>\n+        <int name=\"44\" value=\"105050500\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"7\">\n@@ -410,6 +415,8 @@\n         <int name=\"54\" value=\"200081200\"/>\n         <int name=\"55\" value=\"200081300\"/>\n         <int name=\"56\" value=\"200081400\"/>\n+        <int name=\"57\" value=\"200080101\"/>\n+        <int name=\"58\" value=\"200082301\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"462\" height=\"316\">\n         <vector name=\"origin\" x=\"214\" y=\"132\"/>\n@@ -466,6 +473,8 @@\n         <int name=\"42\" value=\"211042300\"/>\n         <int name=\"43\" value=\"211042400\"/>\n         <int name=\"44\" value=\"211050000\"/>\n+        <int name=\"45\" value=\"280030000\"/>\n+        <int name=\"46\" value=\"211040401\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"11\">\n@@ -578,6 +587,8 @@\n         <int name=\"96\" value=\"300010000\"/>\n         <int name=\"97\" value=\"300010100\"/>\n         <int name=\"98\" value=\"300010200\"/>\n+        <int name=\"106\" value=\"220010001\"/>\n+        <int name=\"107\" value=\"220011001\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"59\" height=\"119\">\n         <vector name=\"origin\" x=\"60\" y=\"102\"/>\n@@ -628,6 +639,8 @@\n         <int name=\"37\" value=\"221040200\"/>\n         <int name=\"38\" value=\"221040300\"/>\n         <int name=\"39\" value=\"221040400\"/>\n+        <int name=\"40\" value=\"221022100\"/>\n+        <int name=\"41\" value=\"221022200\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"13\">\n@@ -648,6 +661,7 @@\n         <int name=\"11\" value=\"222010400\"/>\n         <int name=\"12\" value=\"222020000\"/>\n         <int name=\"13\" value=\"222020100\"/>\n+        <int name=\"14\" value=\"222010310\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"14\">\n@@ -748,6 +762,8 @@\n         <int name=\"91\" value=\"240070601\"/>\n         <int name=\"92\" value=\"240070602\"/>\n         <int name=\"93\" value=\"240070603\"/>\n+        <int name=\"94\" value=\"240040201\"/>\n+        <int name=\"95\" value=\"240040301\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"273\" height=\"275\">\n         <vector name=\"origin\" x=\"279\" y=\"95\"/>\n@@ -802,6 +818,9 @@\n         <int name=\"7\" value=\"251010402\"/>\n         <int name=\"8\" value=\"251010403\"/>\n         <int name=\"9\" value=\"251010500\"/>\n+        <int name=\"10\" value=\"251000100\"/>\n+        <int name=\"11\" value=\"251000404\"/>\n+        <int name=\"12\" value=\"251010404\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"17\">\n@@ -980,6 +999,15 @@\n         <int name=\"4\" value=\"680000001\"/>\n         <int name=\"5\" value=\"680000002\"/>\n         <int name=\"6\" value=\"680000003\"/>\n+        <int name=\"7\" value=\"680000100\"/>\n+        <int name=\"8\" value=\"680000110\"/>\n+        <int name=\"9\" value=\"680000200\"/>\n+        <int name=\"10\" value=\"680000210\"/>\n+        <int name=\"11\" value=\"680000300\"/>\n+        <int name=\"12\" value=\"680000400\"/>\n+        <int name=\"13\" value=\"680000401\"/>\n+        <int name=\"14\" value=\"680010000\"/>\n+        <int name=\"15\" value=\"680010100\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"22\">\n@@ -1006,6 +1034,7 @@\n         <int name=\"17\" value=\"140090500\"/>\n         <int name=\"18\" value=\"140010110\"/>\n         <int name=\"19\" value=\"140090000\"/>\n+        <int name=\"20\" value=\"140020110\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"29\" height=\"96\">\n         <vector name=\"origin\" x=\"279\" y=\"75\"/>\n@@ -1135,6 +1164,7 @@\n         <int name=\"7\" value=\"600010400\"/>\n         <int name=\"8\" value=\"600010500\"/>\n         <int name=\"9\" value=\"600010600\"/>\n+        <int name=\"17\" value=\"600010002\"/>\n       </imgdir>\n       <int name=\"type\" value=\"3\"/>\n       <vector name=\"spot\" x=\"-222\" y=\"-150\"/>"}, {"sha": "4e7575c7839ac544d0699830817611ed1252cdb2", "filename": "wz/Map.wz/WorldMap/WorldMap010.img.xml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap010.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap010.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap010.img.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -113,6 +113,7 @@\n         <int name=\"41\" value=\"105090700\"/>\n         <int name=\"42\" value=\"105090800\"/>\n         <int name=\"43\" value=\"105090900\"/>\n+        <int name=\"44\" value=\"107000500\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"6\">\n@@ -779,6 +780,9 @@\n         <int name=\"23\" value=\"106021501\"/>\n         <int name=\"24\" value=\"106021600\"/>\n         <int name=\"25\" value=\"106021700\"/>\n+        <int name=\"26\" value=\"106021401\"/>\n+        <int name=\"27\" value=\"106021402\"/>\n+        <int name=\"28\" value=\"106021800\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"92\">"}, {"sha": "5d0ea7f3052a86d0f1c2718f2403f684b4048a31", "filename": "wz/Map.wz/WorldMap/WorldMap020.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap020.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap020.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap020.img.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -287,6 +287,7 @@\n         <int name=\"20\" value=\"211042200\"/>\n         <int name=\"21\" value=\"211042300\"/>\n         <int name=\"22\" value=\"211042400\"/>\n+        <int name=\"23\" value=\"280030000\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"34\">"}, {"sha": "e8bc3cd1325f7976081ea9be145f4f051743b59c", "filename": "wz/Map.wz/WorldMap/WorldMap210.img.xml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap210.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f8cd815aa935fe0612425c48410da0ffda758d0/wz/Map.wz/WorldMap/WorldMap210.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap210.img.xml?ref=8f8cd815aa935fe0612425c48410da0ffda758d0", "patch": "@@ -118,6 +118,8 @@\n         <int name=\"13\" value=\"801040002\"/>\n         <int name=\"14\" value=\"801040003\"/>\n         <int name=\"15\" value=\"801040004\"/>\n+        <int name=\"16\" value=\"801040100\"/>\n+        <int name=\"17\" value=\"801040101\"/>\n       </imgdir>\n       <vector name=\"spot\" x=\"35\" y=\"-55\"/>\n     </imgdir>"}]}]},
