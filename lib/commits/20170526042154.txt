{"fetchDate": "2019-12-19", "content": [{"sha": "702c69897b21de4472b103a183118c7d1ca15645", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NzAyYzY5ODk3YjIxZGU0NDcyYjEwM2ExODMxMThjN2QxY2ExNTY0NQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-26T04:21:54Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-26T04:21:54Z"}, "message": "Fixed Guild Alliances + minor Guild rework\n\nAll Guild Alliances system is now functional. Tweaked guilds in order to\nsync MapleGuildCharacter objects that were supposed to be the same when\nbeing accessed from both MapleGuild and MapleCharacter classes.", "tree": {"sha": "1bcdd861098123461f675fbb1eb04e1d0ab85fcd", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/1bcdd861098123461f675fbb1eb04e1d0ab85fcd"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/702c69897b21de4472b103a183118c7d1ca15645", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/702c69897b21de4472b103a183118c7d1ca15645", "html_url": "https://github.com/ronancpl/HeavenMS/commit/702c69897b21de4472b103a183118c7d1ca15645", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/702c69897b21de4472b103a183118c7d1ca15645/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a636f63114d5a30c94b92963e6a2e2cb83f47563", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a636f63114d5a30c94b92963e6a2e2cb83f47563", "html_url": "https://github.com/ronancpl/HeavenMS/commit/a636f63114d5a30c94b92963e6a2e2cb83f47563"}], "stats": {"total": 387, "additions": 260, "deletions": 127}, "files": [{"sha": "4d411b25400dab621d4c6ff1271d6aef91313305", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -246,4 +246,8 @@ Consertado quest-evento Dollhouse.\n \n 23 - 24 Maio 2017,\n Revamp na DB referente \ufffds Alliances.\n-Solu\ufffd\ufffdo parcial ao problema das Guild Alliances. Pode-se criar uma, sair, expulsar e trocar ranks de jogadores.\n\\ No newline at end of file\n+Solu\ufffd\ufffdo parcial ao problema das Guild Alliances. Pode-se criar uma, sair, expulsar e trocar ranks de jogadores.\n+\n+25 Maio 2017,\n+Solu\ufffd\ufffdo final ao problema das Guild Alliances. Todas as funcionalidades implementadas.\n+Registros de objetos MapleGuildCharacter agora esta sincronizado entre MapleCharacter's e MapleGuild's.\n\\ No newline at end of file"}, {"sha": "6d8d3ad834aa0f91093d897c949e88d3d9e4f615", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 11, "deletions": 13, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -1,18 +1,16 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n-    <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n+    <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"1\">\n+        <file>\n+            <url>src/tools/MaplePacketCreator.java</url>\n+            <bookmark id=\"1\">\n+                <name/>\n+                <line>5939</line>\n+                <key/>\n+            </bookmark>\n+        </file>\n+    </editor-bookmarks>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/AllianceOperationHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleGuild.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleAlliance.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleGuildCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/Server.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/world/World.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/npc/NPCConversationManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/handlers/login/GuestLoginHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/tools/MaplePacketCreator.java</file>\n-        </group>\n+        <group/>\n     </open-files>\n </project-private>"}, {"sha": "4ba70595bb5f9d1f05459b53a32c917f2a3f681a", "filename": "scripts/npc/world0/2010009.js", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/scripts/npc/world0/2010009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/scripts/npc/world0/2010009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2010009.js?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -47,11 +47,6 @@ function action(mode, type, selection) {\n             cm.dispose();\n             return;\n         }\n-        if(!cm.isLeader()) {\n-            cm.sendNext(\"Hello there! I'm #bLenario#k. If you want to form a guild, please tell your party leader to talk to me. He/She will be assigned as the Leader of the Guild Union.\");\n-            cm.dispose();\n-            return;\n-        }\n         \n         cm.sendSimple(\"Hello there! I'm #bLenario#k.\\r\\n#b#L0#Can you please tell me what Guild Union is all about?#l\\r\\n#L1#How do I make a Guild Union?#l\\r\\n#L2#I want to make a Guild Union.#l\\r\\n#L3#I want to add more guilds for the Guild Union.#l\\r\\n#L4#I want to break up the Guild Union.#l\");\n     }\n@@ -64,6 +59,11 @@ function action(mode, type, selection) {\n             cm.sendNext(\"To make a Guild Union, two and only two Guild Masters need to be in a party and both must be present on this room on the same channel. The leader of this party will be assigned as the Guild Union Master.\");\n             cm.dispose();\n         } else if(selection == 2) {\n+            if(!cm.isLeader()) {\n+                cm.sendNext(\"If you want to form a guild union, please tell your party leader to talk to me. He/She will be assigned as the Leader of the Guild Union.\");\n+                cm.dispose();\n+                return;\n+            }\n             if(cm.getPlayer().getGuild().getAllianceId() > 0) {\n                 cm.sendOk(\"You can not create a Guild Union while your guild is already registered in another.\");\n                 cm.dispose();\n@@ -111,6 +111,7 @@ function action(mode, type, selection) {\n             cm.upgradeAlliance();\n             cm.gainMeso(-increaseCost);\n             cm.sendOk(\"Your alliance can now accept one more guild.\");\n+            cm.dispose();\n         } else if (choice == 4) {\n             if (cm.getPlayer().getGuild() == null || cm.getPlayer().getGuild().getAllianceId() <= 0) {\n                 cm.sendNext(\"You cannot disband a non-existant Guild Union.\");\n@@ -131,7 +132,7 @@ function action(mode, type, selection) {\n             choice = 2;\n         } else {\n             if (cm.createAlliance(guildName) == null)\n-                cm.sendOk(\"Please check if you and the other one guild leader in your party are both here on this room right now. No other guild leaders should be present with you 2 on this process.\");\n+                cm.sendOk(\"Please check if you and the other one guild leader in your party are both here on this room right now, and make sure both guilds are currently unregistered on unions. No other guild leaders should be present with you 2 on this process.\");\n             else {\n                 cm.gainMeso(-allianceCost);\n                 cm.sendOk(\"You have successfully formed a Guild Union.\");"}, {"sha": "69176c23466fb420346250ec3fa3348ca5e55271", "filename": "sql/db_database.sql", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -50,8 +50,14 @@ CREATE TABLE IF NOT EXISTS `accounts` (\n CREATE TABLE IF NOT EXISTS `alliance` (\n   `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n   `name` varchar(13) NOT NULL,\n-  `notice` varchar(128) NOT NULL DEFAULT '',\n   `capacity` int(10) unsigned NOT NULL DEFAULT '2',\n+  `notice` varchar(20) NOT NULL DEFAULT '',\n+\n+  `rank1` varchar(11) NOT NULL DEFAULT '',\n+  `rank2` varchar(11) NOT NULL DEFAULT '',\n+  `rank3` varchar(11) NOT NULL DEFAULT '',\n+  `rank4` varchar(11) NOT NULL DEFAULT '',\n+  `rank5` varchar(11) NOT NULL DEFAULT '',\n   PRIMARY KEY (`id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n "}, {"sha": "f16b2199d7e94a3237c46f7311e11b77f0ae83ae", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -1961,7 +1961,7 @@ public int getAccountID() {\n     }\n \n     public int getAllianceRank() {\n-        return this.allianceRank;\n+        return allianceRank;\n     }\n \n     public int getAllowWarpToId() {\n@@ -2200,7 +2200,7 @@ public boolean isMale() {\n \n     public MapleGuild getGuild() {\n         try {\n-            return Server.getInstance().getGuild(getGuildId(), getWorld(), null);\n+            return Server.getInstance().getGuild(getGuildId(), getWorld(), this);\n         } catch (Exception ex) {\n             ex.printStackTrace();\n             return null;\n@@ -2445,6 +2445,10 @@ public int getMessengerPosition() {\n     public MapleGuildCharacter getMGC() {\n         return mgc;\n     }\n+    \n+    public void setMGC(MapleGuildCharacter mgc) {\n+        this.mgc = mgc;\n+    }\n \n     public MaplePartyCharacter getMPC() {\n         if (mpc == null) {\n@@ -2549,6 +2553,16 @@ public int getPartyId() {\n         \n         return list;\n     }\n+    \n+    public boolean isPartyMember(MapleCharacter chr) {\n+        for(MapleCharacter mpc: getPartyMembers()) {\n+            if(mpc.getId() == chr.getId()) {\n+                return true;\n+            }\n+        }\n+        \n+        return false;\n+    }\n \n     public MaplePlayerShop getPlayerShop() {\n         return playerShop;\n@@ -4160,10 +4174,6 @@ public void resetEnteredScript(String script) {\n         }\n     }\n \n-    public void resetMGC(MapleGuildCharacter mgc) {\n-        this.mgc = mgc;\n-    }\n-\n     public synchronized void saveCooldowns() {\n         if (getAllCooldowns().size() > 0) {\n             try {\n@@ -4636,9 +4646,6 @@ public void sendNote(String to, String msg, byte fame) throws SQLException {\n \n     public void setAllianceRank(int rank) {\n         allianceRank = rank;\n-        if (mgc != null) {\n-            mgc.setAllianceRank(rank);\n-        }\n     }\n \n     public void setAllowWarpToId(int id) {"}, {"sha": "42b9b45ea6e0a96e09012b8ea72b4e3bf1ddddfd", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -821,7 +821,7 @@ public final void disconnect(boolean shutdown, boolean cashshop) {//once per Map\n \t\t\t\t\t\t}\t                   \n \t\t\t\t\t\tif (guild != null) {\n \t\t\t\t\t\t\tfinal Server server = Server.getInstance();\n-\t\t\t\t\t\t\tserver.setGuildMemberOnline(chrg, false, player.getClient().getChannel());\n+\t\t\t\t\t\t\tserver.setGuildMemberOnline(player, false, player.getClient().getChannel());\n \t\t\t\t\t\t\tplayer.getClient().announce(MaplePacketCreator.showGuildInfo(player));\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (party != null) {"}, {"sha": "d30ecb7847de5bab69c299a22962605121c6d7d3", "filename": "src/net/server/Server.java", "status": "modified", "additions": 39, "deletions": 12, "changes": 51, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -69,12 +69,12 @@\n     private IoAcceptor acceptor;\n     private List<Map<Integer, String>> channels = new LinkedList<>();\n     private List<World> worlds = new ArrayList<>();\n-    private Properties subnetInfo = new Properties();\n+    private final Properties subnetInfo = new Properties();\n     private static Server instance = null;\n     private List<Pair<Integer, String>> worldRecommendedList = new LinkedList<>();\n-    private Map<Integer, MapleGuild> guilds = new LinkedHashMap<>();\n-    private PlayerBuffStorage buffStorage = new PlayerBuffStorage();\n-    private Map<Integer, MapleAlliance> alliances = new LinkedHashMap<>();\n+    private final Map<Integer, MapleGuild> guilds = new LinkedHashMap<>();\n+    private final PlayerBuffStorage buffStorage = new PlayerBuffStorage();\n+    private final Map<Integer, MapleAlliance> alliances = new LinkedHashMap<>();\n     private boolean online = false;\n     public static long uptime = System.currentTimeMillis();\n     \n@@ -349,6 +349,18 @@ public int createGuild(int leaderId, String name) {\n         return MapleGuild.createGuild(leaderId, name);\n     }\n     \n+    public MapleGuild getGuildByName(String name) {\n+        synchronized (guilds) {\n+            for(MapleGuild mg: guilds.values()) {\n+                if(mg.getName().equalsIgnoreCase(name)) {\n+                    return mg;\n+                }\n+            }\n+            \n+            return null;\n+        }\n+    }\n+    \n     public MapleGuild getGuild(int id) {\n         synchronized (guilds) {\n             if (guilds.get(id) != null) {\n@@ -359,7 +371,7 @@ public MapleGuild getGuild(int id) {\n         }\n     }\n \n-    public MapleGuild getGuild(int id, int world, MapleGuildCharacter mgc) {\n+    public MapleGuild getGuild(int id, int world, MapleCharacter mc) {\n         synchronized (guilds) {\n             if (guilds.get(id) != null) {\n                 return guilds.get(id);\n@@ -368,9 +380,15 @@ public MapleGuild getGuild(int id, int world, MapleGuildCharacter mgc) {\n             if (g.getId() == -1) {\n                 return null;\n             }\n-            if (mgc != null) {\n-                g.setOnline(mgc.getId(), true, mgc.getChannel());\n+            \n+            if(mc != null) {\n+                MapleGuildCharacter mgc = mc.getMGC();\n+                if (mgc != null) {\n+                    g.setOnline(mgc.getId(), true, mgc.getChannel());\n+                    mc.setMGC(g.getMGC(mc.getId()));                    // i really REALLY must make player MGC the same as the guild MGC\n+                }\n             }\n+            \n             guilds.put(id, g);\n             return g;\n         }\n@@ -384,9 +402,9 @@ public void clearGuilds() {//remake\n         //reloadGuildCharacters();\n     }\n \n-    public void setGuildMemberOnline(MapleGuildCharacter mgc, boolean bOnline, int channel) {\n-        MapleGuild g = getGuild(mgc.getGuildId(), mgc.getWorld(), mgc);\n-        g.setOnline(mgc.getId(), bOnline, channel);\n+    public void setGuildMemberOnline(MapleCharacter mc, boolean bOnline, int channel) {\n+        MapleGuild g = getGuild(mc.getGuildId(), mc.getWorld(), mc);\n+        g.setOnline(mc.getId(), bOnline, channel);\n     }\n \n     public int addGuildMember(MapleGuildCharacter mgc) {\n@@ -504,8 +522,17 @@ public PlayerBuffStorage getPlayerBuffStorage() {\n         return buffStorage;\n     }\n \n+    public void deleteGuildCharacter(MapleCharacter mc) {\n+        setGuildMemberOnline(mc, false, (byte) -1);\n+        if (mc.getMGC().getGuildRank() > 1) {\n+            leaveGuild(mc.getMGC());\n+        } else {\n+            disbandGuild(mc.getMGC().getGuildId());\n+        }\n+    }\n+    \n     public void deleteGuildCharacter(MapleGuildCharacter mgc) {\n-        setGuildMemberOnline(mgc, false, (byte) -1);\n+        if(mgc.getCharacter() != null) setGuildMemberOnline(mgc.getCharacter(), false, (byte) -1);\n         if (mgc.getGuildRank() > 1) {\n             leaveGuild(mgc);\n         } else {\n@@ -517,7 +544,7 @@ public void reloadGuildCharacters(int world) {\n         World worlda = getWorld(world);\n         for (MapleCharacter mc : worlda.getPlayerStorage().getAllCharacters()) {\n             if (mc.getGuildId() > 0) {\n-                setGuildMemberOnline(mc.getMGC(), true, worlda.getId());\n+                setGuildMemberOnline(mc, true, worlda.getId());\n                 memberLevelJobUpdate(mc.getMGC());\n             }\n         }"}, {"sha": "86a0089583d20e72bce20eb6cd4d65c310efac9e", "filename": "src/net/server/channel/handlers/AllianceOperationHandler.java", "status": "modified", "additions": 41, "deletions": 33, "changes": 74, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/AllianceOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/AllianceOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AllianceOperationHandler.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -26,6 +26,7 @@\n import net.AbstractMaplePacketHandler;\n import net.SendOpcode;\n import net.server.Server;\n+import net.server.guild.MapleGuild;\n import net.server.guild.MapleGuildCharacter;\n import net.server.guild.MapleAlliance;\n import tools.MaplePacketCreator;\n@@ -40,8 +41,6 @@\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        System.out.print(\"aop \");\n-        \n         MapleAlliance alliance = null;\n         if (c.getPlayer().getGuild() != null && c.getPlayer().getGuild().getAllianceId() > 0) {\n             alliance = c.getPlayer().getAlliance();\n@@ -55,14 +54,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         byte b = slea.readByte();\n-        System.out.print(b);\n         switch (b) {\n             case 0x01:\n-                System.out.print(\" case 1\");\n                 Server.getInstance().allianceMessage(alliance.getId(), sendShowInfo(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId()), -1, -1);\n                 break;\n             case 0x02: { // Leave Alliance\n-                System.out.print(\" case 2\");\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuildId() < 1 || c.getPlayer().getGuildRank() != 1) {\n                     return;\n                 }\n@@ -72,35 +68,52 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Server.getInstance().removeGuildFromAlliance(alliance.getId(), guildid);\n                 \n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, c), -1, -1);\n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), alliance.getNotice()), -1, -1);\n                 Server.getInstance().guildMessage(guildid, MaplePacketCreator.disbandAlliance(alliance.getId()));\n+                \n+                alliance.dropMessage(\"[\" + c.getPlayer().getGuild().getName() + \"] guild has left the union.\");\n                 break;\n             }\n-            case 0x03: // send alliance invite\n-                System.out.print(\" case 3 avail is \" + slea.available());\n-                String charName = slea.readMapleAsciiString();\n+            case 0x03: // send alliance invite... or at least it would be this way if i could find the right way to call it!\n+                String guildName = slea.readMapleAsciiString();\n                 \n                 if(alliance.getGuilds().size() == alliance.getCapacity()) {\n                     c.getPlayer().dropMessage(\"Your alliance can not comport any more guild at the moment.\");\n                 } else {\n-                    int channel;\n-                    channel = c.getWorldServer().find(charName);\n-                    if (channel == -1) {\n-                        c.getPlayer().dropMessage(\"The player is not online.\");\n-                    } else {\n-                        MapleCharacter victim = Server.getInstance().getChannel(c.getWorld(), channel).getPlayerStorage().getCharacterByName(charName);\n-                        if (victim.getGuildId() == 0) {\n-                            c.getPlayer().dropMessage(\"The person you are trying to invite does not have a guild.\");\n-                        } else if (victim.getGuildRank() != 1) {\n-                            c.getPlayer().dropMessage(\"The player is not the leader of his/her guild.\");\n+                    MapleGuild mg = Server.getInstance().getGuildByName(guildName);\n+                    if(mg == null) {\n+                        c.getPlayer().dropMessage(\"The entered guild does not exist.\");\n+                    }\n+                    else {\n+                        MapleCharacter victim = mg.getMGC(mg.getLeaderId()).getCharacter();\n+                        \n+                        if (victim == null) {\n+                            c.getPlayer().dropMessage(\"The master of the guild that you offered an invitation is currently not online.\");\n                         } else {\n-                            Server.getInstance().allianceMessage(alliance.getId(), sendInvitation(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), charName), -1, -1);\n+                            // this doesn't seem to work...\n+                            //Server.getInstance().allianceMessage(alliance.getId(), sendInvitation(c.getPlayer().getGuild().getAllianceId(), victim.getId(), guildName), -1, -1);\n+                            //victim.getClient().announce(sendInvitation(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), guildName));\n+                            \n+                            if(!c.getPlayer().isPartyMember(victim)) {\n+                                c.getPlayer().dropMessage(\"The master of the guild that you offered a invitation must be in the same party as yours.\");\n+                            }\n+                            else {\n+                                int guildid = victim.getGuildId();\n+\n+                                Server.getInstance().addGuildtoAlliance(alliance.getId(), guildid);\n+                                Server.getInstance().resetAllianceGuildPlayersRank(guildid);\n+\n+                                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.addGuildToAlliance(alliance, guildid, c), -1, -1);\n+                                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.updateAllianceInfo(alliance, c), -1, -1);\n+                                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), alliance.getNotice()), -1, -1);\n+                                victim.getGuild().dropMessage(\"Your guild has joined in the [\" + alliance.getName() + \"] union.\");\n+                            }\n                         }\n                     }\n                 }\n                 \n                 break;\n             case 0x04: {\n-                System.out.print(\" case 4\");\n                 int guildid = slea.readInt();\n //                    slea.readMapleAsciiString();//guild name\n                 if (c.getPlayer().getGuild().getAllianceId() != 0 || c.getPlayer().getGuildRank() != 1 || c.getPlayer().getGuildId() < 1) {\n@@ -110,7 +123,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             }\n             case 0x06: { // Expel Guild\n-                System.out.print(\" case 6\");\n                 int guildid = slea.readInt();\n                 int allianceid = slea.readInt();\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuild().getAllianceId() != allianceid) {\n@@ -121,13 +133,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Server.getInstance().removeGuildFromAlliance(alliance.getId(), guildid);\n                 \n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, c), -1, -1);\n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), alliance.getNotice()), -1, -1);\n                 Server.getInstance().guildMessage(guildid, MaplePacketCreator.disbandAlliance(allianceid));\n                 \n-                \n+                alliance.dropMessage(\"[\" + Server.getInstance().getGuild(guildid).getName() + \"] guild has been expelled from the union.\");\n                 break;\n             }\n             case 0x07: { // Change Alliance Leader\n-                System.out.print(\" case 7\");\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuildId() < 1) {\n                     return;\n                 }\n@@ -139,7 +151,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             }\n             case 0x08:\n-                System.out.print(\" case 8\");\n                 String ranks[] = new String[5];\n                 for (int i = 0; i < 5; i++) {\n                     ranks[i] = slea.readMapleAsciiString();\n@@ -148,7 +159,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.changeAllianceRankTitle(alliance.getId(), ranks), -1, -1);\n                 break;\n             case 0x09: {\n-                System.out.print(\" case 9\");\n                 int int1 = slea.readInt();\n                 byte byte1 = slea.readByte();\n                 \n@@ -159,41 +169,39 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             }\n             case 0x0A:\n-                System.out.print(\" case A\");\n                 String notice = slea.readMapleAsciiString();\n                 Server.getInstance().setAllianceNotice(alliance.getId(), notice);\n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), notice), -1, -1);\n                 break;\n             default:\n                 c.getPlayer().dropMessage(\"Feature not available\");\n         }\n-        System.out.println(\"end\");\n         \n         alliance.saveToDB();\n     }\n     \n     private void changeLeaderAllianceRank(MapleAlliance alliance, MapleCharacter newLeader) {\n         MapleGuildCharacter lmgc = alliance.getLeader();\n         MapleCharacter leader = Server.getInstance().getWorld(newLeader.getWorld()).getPlayerStorage().getCharacterById(lmgc.getId());\n-        leader.setAllianceRank(2);\n+        leader.getMGC().setAllianceRank(2);\n         leader.saveGuildStatus();\n         \n-        newLeader.setAllianceRank(1);\n+        newLeader.getMGC().setAllianceRank(1);\n         newLeader.saveGuildStatus();\n         \n         Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, newLeader.getClient()), -1, -1);\n-        alliance.dropAllianceMessage(\"'\" + newLeader.getName() + \"' has been appointed as the new head of this Alliance.\");\n+        alliance.dropMessage(\"'\" + newLeader.getName() + \"' has been appointed as the new head of this Alliance.\");\n     }\n     \n     private void changePlayerAllianceRank(MapleAlliance alliance, MapleCharacter chr, boolean raise) {\n         int newRank = chr.getAllianceRank() + (raise ? -1 : 1);\n-        if(newRank < 2 || newRank > 5) return;\n+        if(newRank < 3 || newRank > 5) return;\n         \n-        chr.setAllianceRank(newRank);\n+        chr.getMGC().setAllianceRank(newRank);\n         chr.saveGuildStatus();\n         \n         Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, chr.getClient()), -1, -1);\n-        alliance.dropAllianceMessage(\"'\" + chr.getName() + \"' has moved ranks to '\" + alliance.getRankTitle(newRank) + \"' in this Alliance.\");\n+        alliance.dropMessage(\"'\" + chr.getName() + \"' has been reassigned as '\" + alliance.getRankTitle(newRank) + \"' in this Alliance.\");\n     }\n \n     private static byte[] sendShowInfo(int allianceid, int playerid) {"}, {"sha": "dda5268203c3507555ffde1b1642cb0b8a8ff763", "filename": "src/net/server/channel/handlers/GuildOperationHandler.java", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/GuildOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/GuildOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GuildOperationHandler.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -30,6 +30,7 @@\n import tools.MaplePacketCreator;\n import client.MapleCharacter;\n import net.server.Server;\n+import net.server.guild.MapleAlliance;\n \n public final class GuildOperationHandler extends AbstractMaplePacketHandler {\n     private boolean isGuildNameAcceptable(String name) {\n@@ -95,6 +96,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         MapleCharacter mc = c.getPlayer();\n         byte type = slea.readByte();\n+        int allianceId = -1;\n         switch (type) {\n             case 0x00:\n                 //c.announce(MaplePacketCreator.showGuildInfo(mc));\n@@ -123,8 +125,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 mc.gainMeso(-MapleGuild.CREATE_GUILD_COST, true, false, true);\n                 mc.setGuildId(gid);\n                 mc.setGuildRank(1);\n-                mc.saveGuildStatus();\n+                mc.setAllianceRank(5);\n+                \n+                MapleGuild guild = Server.getInstance().getGuild(mc.getGuildId(), c.getWorld(), mc);  // initialize guild structure\n+                guild.getMGC(guild.getLeaderId()).setCharacter(mc);\n                 c.announce(MaplePacketCreator.showGuildInfo(mc));\n+                \n                 c.getPlayer().dropMessage(1, \"You have successfully created a Guild.\");\n                 respawnPlayer(mc);\n                 break;\n@@ -171,6 +177,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 mc.setGuildId(gid); // joins the guild\n                 mc.setGuildRank(5); // start at lowest rank\n+                mc.setAllianceRank(5);\n                 int s;\n                 \n                 s = Server.getInstance().addGuildMember(mc.getMGC());\n@@ -179,11 +186,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     mc.setGuildId(0);\n                     return;\n                 }\n+                \n                 c.announce(MaplePacketCreator.showGuildInfo(mc));\n+                \n+                allianceId = mc.getGuild().getAllianceId();\n+                if(allianceId > 0) Server.getInstance().getAlliance(allianceId).updateAlliancePackets(mc);\n+                \n                 mc.saveGuildStatus(); // update database\n                 respawnPlayer(mc);\n                 break;\n             case 0x07:\n+                allianceId = mc.getGuild().getAllianceId();\n+                \n                 cid = slea.readInt();\n                 name = slea.readMapleAsciiString();\n                 if (cid != mc.getId() || !name.equals(mc.getName()) || mc.getGuildId() <= 0) {\n@@ -192,12 +206,17 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 c.announce(MaplePacketCreator.updateGP(mc.getGuildId(), 0));\n                 Server.getInstance().leaveGuild(mc.getMGC());\n+                \n                 c.announce(MaplePacketCreator.showGuildInfo(null));\n+                if(allianceId > 0) Server.getInstance().getAlliance(allianceId).updateAlliancePackets(mc);\n+                \n                 mc.setGuildId(0);\n                 mc.saveGuildStatus();\n                 respawnPlayer(mc);\n                 break;\n             case 0x08:\n+                allianceId = mc.getGuild().getAllianceId();\n+                \n                 cid = slea.readInt();\n                 name = slea.readMapleAsciiString();\n                 if (mc.getGuildRank() > 2 || mc.getGuildId() <= 0) {\n@@ -206,6 +225,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 \n                 Server.getInstance().expelMember(mc.getMGC(), name, cid);\n+                if(allianceId > 0) Server.getInstance().getAlliance(allianceId).updateAlliancePackets(mc);\n                 break;\n             case 0x0d:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() != 1) {\n@@ -237,7 +257,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     return;\n                 }\n                 if (mc.getMeso() < MapleGuild.CHANGE_EMBLEM_COST) {\n-                    c.announce(MaplePacketCreator.serverNotice(1, \"You do not have enough mesos to create a Guild.\"));\n+                    c.announce(MaplePacketCreator.serverNotice(1, \"You do not have enough mesos to change the Guild emblem.\"));\n                     return;\n                 }\n                 short bg = slea.readShort();"}, {"sha": "8cf8bf3b72bb17eb0439f99e2f0672e80cd0086a", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -183,15 +183,15 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.announce(MaplePacketCreator.getFamilyInfo(f.getMember(player.getId())));\n         }\n         if (player.getGuildId() > 0) {\n-            MapleGuild playerGuild = server.getGuild(player.getGuildId(), player.getWorld(), player.getMGC());\n+            MapleGuild playerGuild = server.getGuild(player.getGuildId(), player.getWorld(), player);\n             if (playerGuild == null) {\n                 player.deleteGuild(player.getGuildId());\n-                player.resetMGC(null);\n+                player.setMGC(null);\n                 player.setGuildId(0);\n             } else {\n                 playerGuild.getMGC(player.getId()).setCharacter(player);\n-                player.resetMGC(playerGuild.getMGC(player.getId()));\n-                server.setGuildMemberOnline(player.getMGC(), true, c.getChannel());\n+                player.setMGC(playerGuild.getMGC(player.getId()));\n+                server.setGuildMemberOnline(player, true, c.getChannel());\n                 c.announce(MaplePacketCreator.showGuildInfo(player));\n                 int allianceId = player.getGuild().getAllianceId();\n                 if (allianceId > 0) {\n@@ -205,8 +205,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         }\n                     }\n                     if (newAlliance != null) {\n-                        c.announce(MaplePacketCreator.getAllianceInfo(newAlliance));\n-                        c.announce(MaplePacketCreator.getGuildAlliances(newAlliance, c));\n+                        c.announce(MaplePacketCreator.updateAllianceInfo(newAlliance, c));\n+                        c.announce(MaplePacketCreator.allianceNotice(newAlliance.getId(), newAlliance.getNotice()));\n+                        \n                         server.allianceMessage(allianceId, MaplePacketCreator.allianceMemberOnline(player, true), player.getId(), -1);\n                     }\n                 }"}, {"sha": "2bdf04a03c1047eaebf4b4ce770da6442915355d", "filename": "src/net/server/guild/MapleAlliance.java", "status": "modified", "additions": 69, "deletions": 10, "changes": 79, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleAlliance.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleAlliance.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleAlliance.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -32,8 +32,6 @@\n import net.server.Server;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n-import net.server.guild.MapleGuild;\n-import net.server.guild.MapleGuildCharacter;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n \n@@ -122,12 +120,12 @@ public static MapleAlliance createAlliance(MapleParty party, String name) {\n                     Server.getInstance().resetAllianceGuildPlayersRank(guilds.get(i));\n \n                     MapleCharacter chr = guildMasters.get(i);\n-                    chr.setAllianceRank((i == 0) ? 1 : 2);\n+                    chr.getMGC().setAllianceRank((i == 0) ? 1 : 2);\n                     chr.saveGuildStatus();\n                 }\n \n                 Server.getInstance().addAlliance(id, alliance);\n-                Server.getInstance().allianceMessage(id, MaplePacketCreator.makeNewAlliance(alliance, guildMasters.get(0).getClient()), -1, -1);\n+                Server.getInstance().allianceMessage(id, MaplePacketCreator.updateAllianceInfo(alliance, guildMasters.get(0).getClient()), -1, -1);\n             } catch (Exception e) {\n                 e.printStackTrace();\n                 return null;\n@@ -194,6 +192,14 @@ public static MapleAlliance loadAlliance(int id) {\n             alliance.name = rs.getString(\"name\");\n             alliance.notice = rs.getString(\"notice\");\n             \n+            String ranks[] = new String[5];\n+            ranks[0] = rs.getString(\"rank1\");\n+            ranks[1] = rs.getString(\"rank2\");\n+            ranks[2] = rs.getString(\"rank3\");\n+            ranks[3] = rs.getString(\"rank4\");\n+            ranks[4] = rs.getString(\"rank5\");\n+            alliance.rankTitles = ranks;\n+            \n             ps.close();\n             rs.close();\n             \n@@ -218,10 +224,17 @@ public static MapleAlliance loadAlliance(int id) {\n     public void saveToDB() {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            PreparedStatement ps = con.prepareStatement(\"UPDATE `alliance` SET capacity = ?, notice = ? WHERE id = ?\");\n+            PreparedStatement ps = con.prepareStatement(\"UPDATE `alliance` SET capacity = ?, notice = ?, rank1 = ?, rank2 = ?, rank3 = ?, rank4 = ?, rank5 = ? WHERE id = ?\");\n             ps.setInt(1, this.capacity);\n             ps.setString(2, this.notice);\n-            ps.setInt(3, this.allianceId);\n+            \n+            ps.setString(3, this.rankTitles[0]);\n+            ps.setString(4, this.rankTitles[1]);\n+            ps.setString(5, this.rankTitles[2]);\n+            ps.setString(6, this.rankTitles[3]);\n+            ps.setString(7, this.rankTitles[4]);\n+            \n+            ps.setInt(8, this.allianceId);\n             ps.executeUpdate();\n             ps.close();\n             \n@@ -246,6 +259,48 @@ public void saveToDB() {\n         }\n     }\n     \n+    public static void disbandAlliance(int allianceId) {\n+        PreparedStatement ps = null;\n+        Connection con = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            \n+            ps = con.prepareStatement(\"DELETE FROM `alliance` WHERE id = ?\");\n+            ps.setInt(1, allianceId);\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            ps = con.prepareStatement(\"DELETE FROM `allianceguilds` WHERE allianceid = ?\");\n+            ps.setInt(1, allianceId);\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            con.close();\n+            Server.getInstance().allianceMessage(allianceId, MaplePacketCreator.disbandAlliance(allianceId), -1, -1);\n+            Server.getInstance().disbandAlliance(allianceId);\n+        } catch (SQLException sqle) {\n+            sqle.printStackTrace();\n+        } finally {\n+            try {\n+                if (ps != null && !ps.isClosed()) {\n+                    ps.close();\n+                }\n+                if (con != null && !con.isClosed()) {\n+                    con.close();\n+                }\n+            } catch (SQLException ex) {\n+                ex.printStackTrace();\n+            }\n+        }\n+    }\n+    \n+    public void updateAlliancePackets(MapleCharacter chr) {\n+        if (allianceId > 0) {\n+            this.broadcastMessage(MaplePacketCreator.updateAllianceInfo(this, chr.getClient()));\n+            this.broadcastMessage(MaplePacketCreator.allianceNotice(this.getId(), this.getNotice()));\n+        }\n+    }\n+    \n     public boolean removeGuild(int gid) {\n         synchronized (guilds) {\n             int index = getGuildIndex(gid);\n@@ -334,14 +389,18 @@ public MapleGuildCharacter getLeader() {\n         return null;\n     }\n     \n-    public void dropAllianceMessage(String message) {\n-        dropAllianceMessage(5, message);\n+    public void dropMessage(String message) {\n+        dropMessage(5, message);\n     }\n     \n-    public void dropAllianceMessage(int type, String message) {\n+    public void dropMessage(int type, String message) {\n         for(Integer gId: guilds) {\n             MapleGuild guild = Server.getInstance().getGuild(gId);\n-            guild.dropGuildMessage(type, message);\n+            guild.dropMessage(type, message);\n         }\n     }\n+    \n+    public void broadcastMessage(byte[] packet) {\n+        Server.getInstance().allianceMessage(allianceId, packet, -1, -1);\n+    }\n }"}, {"sha": "d9fa2aaf1ed4f6324ef2e91ae7a1021a9873e663", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 25, "deletions": 6, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -180,6 +180,10 @@ public int getId() {\n     public int getLeaderId() {\n         return leader;\n     }\n+    \n+    public int setLeaderId(int charId) {\n+        return leader = charId;\n+    }\n \n     public int getGP() {\n         return gp;\n@@ -283,15 +287,20 @@ public void guildMessage(final byte[] serverNotice) {\n         }\n     }\n     \n-    public void dropGuildMessage(String message) {\n-        dropGuildMessage(5, message);\n+    public void dropMessage(String message) {\n+        dropMessage(5, message);\n     }\n     \n-    public void dropGuildMessage(int type, String message) {\n+    public void dropMessage(int type, String message) {\n         for (MapleGuildCharacter mgc : members) {\n-            mgc.getCharacter().dropMessage(type, message);\n+            if(mgc.getCharacter() != null)\n+                mgc.getCharacter().dropMessage(type, message);\n         }\n     }\n+    \n+    public void broadcastMessage(byte[] packet) {\n+        Server.getInstance().guildMessage(id, packet);\n+    }\n \n     public final void setOnline(int cid, boolean online, int channel) {\n         boolean bBroadcast = true;\n@@ -332,20 +341,30 @@ public static int createGuild(int leaderId, String name) {\n             }\n             ps.close();\n             rs.close();\n+            \n             ps = con.prepareStatement(\"INSERT INTO guilds (`leader`, `name`, `signature`) VALUES (?, ?, ?)\");\n             ps.setInt(1, leaderId);\n             ps.setString(2, name);\n             ps.setInt(3, (int) System.currentTimeMillis());\n             ps.execute();\n             ps.close();\n+            \n             ps = con.prepareStatement(\"SELECT guildid FROM guilds WHERE leader = ?\");\n             ps.setInt(1, leaderId);\n             rs = ps.executeQuery();\n             rs.first();\n-            int guildid = rs.getInt(\"guildid\");\n+            int guildId = rs.getInt(\"guildid\");\n             rs.close();\n             ps.close();\n-            return guildid;\n+            \n+            ps = con.prepareStatement(\"UPDATE characters SET guildid = ? WHERE id = ?\");\n+            ps.setInt(1, guildId);\n+            ps.setInt(2, leaderId);\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            con.close();\n+            return guildId;\n         } catch (Exception e) {\n             e.printStackTrace();\n             return 0;"}, {"sha": "ce79f188ffbcac9b741a5549ae3f80a75706a0d3", "filename": "src/net/server/guild/MapleGuildCharacter.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleGuildCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/guild/MapleGuildCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuildCharacter.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -135,6 +135,7 @@ public String getName() {\n \n     public void setAllianceRank(int rank) {\n         allianceRank = rank;\n+        if(character != null) character.setAllianceRank(rank);\n     }\n \n     public int getAllianceRank() {"}, {"sha": "f067dfaff6000da83c83570e2c45a2d245f4f15c", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -196,7 +196,7 @@ public MapleFamily getFamily(int id) {\n     public MapleGuild getGuild(MapleGuildCharacter mgc) {\n         int gid = mgc.getGuildId();\n         MapleGuild g;\n-        g = Server.getInstance().getGuild(gid, mgc.getWorld(), mgc);\n+        g = Server.getInstance().getGuild(gid, mgc.getWorld(), mgc.getCharacter());\n         if (gsStore.get(gid) == null) {\n             gsStore.put(gid, new MapleGuildSummary(g));\n         }"}, {"sha": "28d9cfa305a8500a17459115d302192f3f95ed41", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 2, "deletions": 19, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -350,28 +350,11 @@ public void doGachapon() {\n         public void upgradeAlliance() {\n                 MapleAlliance alliance = Server.getInstance().getAlliance(c.getPlayer().getGuild().getAllianceId());\n                 alliance.increaseCapacity(1);\n+                c.announce(MaplePacketCreator.updateAllianceInfo(alliance, c));\n         }\n \n \tpublic void disbandAlliance(MapleClient c, int allianceId) {\n-\t\tPreparedStatement ps = null;\n-\t\ttry {\n-\t\t\tps = DatabaseConnection.getConnection().prepareStatement(\"DELETE FROM `alliance` WHERE id = ?\");\n-\t\t\tps.setInt(1, allianceId);\n-\t\t\tps.executeUpdate();\n-\t\t\tps.close();\n-\t\t\tServer.getInstance().allianceMessage(c.getPlayer().getGuild().getAllianceId(), MaplePacketCreator.disbandAlliance(allianceId), -1, -1);\n-\t\t\tServer.getInstance().disbandAlliance(allianceId);\n-\t\t} catch (SQLException sqle) {\n-\t\t\tsqle.printStackTrace();\n-\t\t} finally {\n-\t\t\ttry {\n-\t\t\t\tif (ps != null && !ps.isClosed()) {\n-\t\t\t\t\tps.close();\n-\t\t\t\t}\n-\t\t\t} catch (SQLException ex) {\n-                                ex.printStackTrace();\n-\t\t\t}\n-\t\t}\n+\t\tMapleAlliance.disbandAlliance(allianceId);\n \t}\n \n \tpublic boolean canBeUsedAllianceName(String name) {"}, {"sha": "ee284ce2ab5bbd88245334fa49679393a4910233", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/702c69897b21de4472b103a183118c7d1ca15645/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/702c69897b21de4472b103a183118c7d1ca15645/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=702c69897b21de4472b103a183118c7d1ca15645", "patch": "@@ -5891,7 +5891,6 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                         mplew.writeInt(mgc.isOnline() ? 1 : 0);\n                         mplew.writeInt(guild.getSignature());\n                         mplew.writeInt(mgc.getAllianceRank());\n-                        System.out.println(\"alliance rank found \" + mgc.getAllianceRank());\n                 }\n                 mplew.writeInt(guild.getCapacity());\n                 mplew.writeShort(guild.getLogoBG());\n@@ -5914,15 +5913,15 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                         mplew.writeMapleAsciiString(alliance.getRankTitle(i));\n                 }\n                 mplew.write(alliance.getGuilds().size());\n-                mplew.writeInt(2); // probably capacity\n+                mplew.writeInt(alliance.getCapacity()); // probably capacity\n                 for (Integer guild : alliance.getGuilds()) {\n                         mplew.writeInt(guild);\n                 }\n                 mplew.writeMapleAsciiString(alliance.getNotice());\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] makeNewAlliance(MapleAlliance alliance, MapleClient c) {\n+        public static byte[] updateAllianceInfo(MapleAlliance alliance, MapleClient c) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.ALLIANCE_OPERATION.getValue());\n                 mplew.write(0x0F);\n@@ -5935,10 +5934,10 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 for (Integer guild : alliance.getGuilds()) {\n                         mplew.writeInt(guild);\n                 }\n-                mplew.writeInt(2); // probably capacity\n+                mplew.writeInt(alliance.getCapacity()); // probably capacity\n                 mplew.writeShort(0);\n                 for (Integer guildd : alliance.getGuilds()) {\n-                        getGuildInfo(mplew, Server.getInstance().getGuild(guildd, c.getWorld(), c.getPlayer().getMGC()));\n+                        getGuildInfo(mplew, Server.getInstance().getGuild(guildd, c.getWorld(), c.getPlayer()));\n                 }\n                 return mplew.getPacket();\n         }\n@@ -5967,7 +5966,7 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 for (Integer guild : alliance.getGuilds()) {\n                         mplew.writeInt(guild);\n                 }\n-                mplew.writeInt(2);\n+                mplew.writeInt(alliance.getCapacity());\n                 mplew.writeMapleAsciiString(alliance.getNotice());\n                 mplew.writeInt(newGuild);\n                 getGuildInfo(mplew, Server.getInstance().getGuild(newGuild, c.getWorld(), null));\n@@ -6030,7 +6029,7 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 for (Integer guild : alliance.getGuilds()) {\n                         mplew.writeInt(guild);\n                 }\n-                mplew.writeInt(2);\n+                mplew.writeInt(alliance.getCapacity());\n                 mplew.writeMapleAsciiString(alliance.getNotice());\n                 mplew.writeInt(expelledGuild);\n                 getGuildInfo(mplew, Server.getInstance().getGuild(expelledGuild, c.getWorld(), null));"}]}]},
