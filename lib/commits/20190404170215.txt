{"fetchDate": "2019-12-19", "content": [{"sha": "a15713dfa2b4fd7c05f683c4a766f78a07da3267", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YTE1NzEzZGZhMmI0ZmQ3YzA1ZjY4M2M0YTc2NmY3OGEwN2RhMzI2Nw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-04T17:02:15Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-04T17:02:15Z"}, "message": "\"Exp-party\" Pi + Event script disabled on dispose + Personal loot fix\n\nRefactored event scripts, no longer triggering after the event is deemed disposed.\nAdded MCPQ access in Dimensional Doors.\nRevised Crusader/Dawn Warrior's Combo Attack, no longer resetting orbs after recasting during active time.\nAdded 4th job advancement handing out Maple Warrior skill book.\nFixed several issues with not being able to collect drops within owned exclusivity time when back-and-forth changing maps.\nRevised visual EXP gain. Players that participated most in the defeat of the mob has the gain displayed in white, else yellow, somewhat similar to GMS.\nFixed client not disconnecting properly after closing the game inside MTS/Cash Shop, leading to no update on account's login state.\nFixed wrongly inputted PIC in anti-multiclient system blocking accounts to login under the same IP.\nFixed parameterless command inputs counting as \"one empty command\".", "tree": {"sha": "223df61c4ec107987d41ffb9a1157cdab935a4fa", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/223df61c4ec107987d41ffb9a1157cdab935a4fa"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/a15713dfa2b4fd7c05f683c4a766f78a07da3267", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a15713dfa2b4fd7c05f683c4a766f78a07da3267", "html_url": "https://github.com/ronancpl/HeavenMS/commit/a15713dfa2b4fd7c05f683c4a766f78a07da3267", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a15713dfa2b4fd7c05f683c4a766f78a07da3267/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b6951527d3803c877205d1f6516911fd8bcc64e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0b6951527d3803c877205d1f6516911fd8bcc64e", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0b6951527d3803c877205d1f6516911fd8bcc64e"}], "stats": {"total": 542, "additions": 344, "deletions": 198}, "files": [{"sha": "e356c6a7d3f9039a6318d7ef97aa88a0e9fcca2e", "filename": "docs/issues.txt", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -5,8 +5,6 @@ Vcoc - Freelance Developer\n \n ---------------------------\n Known issues:\n-- Everytime two people click on an npc at the same time, one of them dcs and the other needs to @dispose to talk to the npc.\n-- If multiple people hit boxes/reactors at the same time, they both dc with invalid pointer error.\n - Some criticals (e.g. from Aran skills) will not show up as crit for other players.\n - Deadlocks may start appearing if the server stays online long enough with many players logged in.\n - If there are multiple bosses that shows HPBar on the map, if a player hits more than one the HPBar may start flickering on the screen.\n@@ -57,6 +55,7 @@ Missing features list:\n ---------------------------\n ** Skills **\n - Check autoban system\n+- Attack speed reference for autoban, brought here thanks to GitGud: https://ayumilovemaple.wordpress.com/2009/09/06/maplestory-attack-speed-reference/\n ---------------------------\n \n "}, {"sha": "76bf3fa705f037c1c9c28ab96c239f52b25af86c", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -1014,7 +1014,7 @@ Modificado sistema de EXP de mounts de forma a favorecer usar Revitalizer quando\n Retirado aspecto aleat\u00f3rio de ganho de closeness em pets ao usar o Pet Food, adicionado prote\u00e7\u00e3o a acesso concorrente.\n Corrigido script da Arwen n\u00e3o retirando itens ao gerar certos itens.\n Corrigido script de viagem para Florina levando jogadores a Lith Harbor mesmo quando entrando por outras regi\u00f5es.\n-Corrigido Stance, Berserk, Ninja Storm, Concentrate, Mage skills and other 4th job skills questlines.\n+Corrigido Stance, Berserk, Ninja Storm, Concentrate, Mage skills e outras questlines de skills de 4th job.\n Novo release: Light.\n \n 05 - 06 Junho 2018,\n@@ -1769,6 +1769,24 @@ Corrigido bug na CPQ em tempo estendido n\u00e3o mostrando devidamente o efeito visu\n \n 27 Mar\u00e7o 2019,\n Corrigido possibilidade de bloqueio de volta do jogador ao jogo, ao utilizar o sistema de MTS/Cash Shop. Problema ocorria devido a mudan\u00e7as concorrentes de login states ao fazer a transi\u00e7\u00e3o de volta ao jogo.\n+Corrigido inst\u00e2ncia de eventos finalizada ainda utilizando os scripts, levando a poss\u00edveis inconsist\u00eancias em jogo. Premissa \u00e9: n\u00e3o deveriam existir mais a\u00e7\u00f5es de script ap\u00f3s se finalizar uma inst\u00e2ncia.\n+Ajustado Dimensional Door, agora permitindo jogadores a entrar no sagu\u00e3o de espera das MCPQs.\n+Corrigido combo resetando orbs ao reusar a skill ainda ativa.\n+Adicionado ganho de skill book Maple Warrior ao iniciar 4th job.\n \n 28 Mar\u00e7o 2019,\n-Corrigido possibilidade de congelamento de tela ao tentar trocar de canais. Problema ocorria devido a mudan\u00e7as concorrentes de login states ao fazer a transi\u00e7\u00e3o de volta ao jogo.\n\\ No newline at end of file\n+Corrigido problema com jogador n\u00e3o conseguindo coletar pr\u00f3prio drop se o mesmo estiver em party e for enviado para outro mapa e o mesmo retornar em tempo de exclusividade de coleta.\n+Corrigido problema com jogador n\u00e3o conseguindo coletar drops de party ap\u00f3s o mesmo voltar do MTS/Cash Shop ainda em tempo de exclusividade de coleta.\n+Corrigido problema com jogador n\u00e3o conseguindo coletar drops com tempo de exclusividade de coleta j\u00e1 expirado.\n+Revisado vis\u00e3o de ganho de EXP. Jogadores que participaram mais no dano de mob percebem o ganho de EXP em branco, caso contr\u00e1rio em amarelo.\n+Corrigido possibilidade de congelamento de tela ao tentar trocar de canais. Problema ocorria devido a mudan\u00e7as concorrentes de login states ao fazer a transi\u00e7\u00e3o de volta ao jogo.\n+\n+01 Abril 2019,\n+Adicionado mensagens ao spawnar mobs em boxes da LMPQ.\n+Revisado conte\u00fado de ganho de EXP, onde mensagens de ganho simples (sem \"party bonus\") aparecem em amarelo caso o jogador ganhou experi\u00eancia sem qualquer contribui\u00e7\u00e3o de dano no mob.\n+Corrigido cliente n\u00e3o desconectando apropriadamente ap\u00f3s fechar o jogo dentro do MTS/Cash Shop, levando a n\u00e3o-update de login state na DB.\n+Corrigido inser\u00e7\u00e3o de PIC errado no sistema anti-multicliente impossibilitando contas de logarem usando um mesmo IP.\n+\n+04 Abril 2019,\n+Corrigido comandos sem par\u00e2metros contabilizando feed de \"um par\u00e2metro vazio\".\n+Ajustado moderadamente drop rate de v\u00e1rios equipamentos na DB.\n\\ No newline at end of file"}, {"sha": "982ee33b5913a2222162fca72656387b29321e4f", "filename": "scripts/event/GuardianNex.js", "status": "modified", "additions": 35, "deletions": 25, "changes": 60, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/event/GuardianNex.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/event/GuardianNex.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/GuardianNex.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -3,6 +3,7 @@ var timeLimit = 15; //15 minutes\n var eventTimer = 1000 * 60 * timeLimit;\n var exitMap = 240070000;\n var eventMap = 240070010;\n+var eventBossIds = [7120100, 7120101, 7120102, 8120100, 8120101, 8140510];\n \n function init(){}\n \n@@ -42,22 +43,27 @@ function playerRevive(eim, player){\n \n function playerDead(eim, player){}\n \n-function playerDisconnected(eim, player){\n-\tvar party = eim.getPlayers();\n-\n-\tfor(var i = 0; i < party.size(); i++){\n-\t\tif(party.get(i).equals(player))\n-\t\t\tremovePlayer(eim, player);\n-\t\telse\n-\t\t\tplayerExit(eim, party.get(i));\n-\t}\n-\teim.dispose();\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n function monsterValue(eim, mobId){\n \treturn -1;\n }\n \n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n function leftParty(eim, player){}\n \n function disbandParty(eim){}\n@@ -69,28 +75,32 @@ function playerExit(eim, player){\n \tplayer.changeMap(exitMap);\n }\n \n-function changedMap(eim, player, mapId){\n-\tif(mapId != (eventMap + 10 * eim.getIntProperty(\"nex\"))){\n-\t\tremovePlayer(eim, player);\n-\t\teim.stopEventTimer();\n-\t\teim.setEventCleared();\n-\t\teim.dispose();\n-\t}\n-}\n-\n-function removePlayer(eim, player){\n-\teim.unregisterPlayer(player);\n-\tplayer.getMap().removePlayer(player);\n-\tplayer.setMap(exitMap);\n+function changedMap(eim, player, mapid){\n+\tif (mapid != (eventMap + 10 * eim.getIntProperty(\"nex\"))) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n }\n \n function cancelSchedule(){}\n \n function dispose(){}\n \n-function clearPQ(eim){}\n+function clearPQ(eim){\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n \n-function monsterKilled(mob, eim){}\n+function monsterKilled(mob, eim){\n+        if (mob.getId() == eventBossIds[eim.getIntProperty(\"nex\")]) {\n+                eim.showClearEffect();\n+                eim.clearPQ();\n+        }\n+}\n \n function allMonstersDead(eim){}\n "}, {"sha": "5008b8ef807f21faa1de98e92c8df8c289639734", "filename": "scripts/npc/2042005.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2042005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2042005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042005.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -6,7 +6,7 @@\n **/\n \n var cpqMinLvl = 51;\n-var cpqMaxLvl = 69;\n+var cpqMaxLvl = 70;\n var cpqMinAmt = 2;\n var cpqMaxAmt = 6;\n "}, {"sha": "eccfb48ef8b6a4f297f283ff607e6c73b6fb39e3", "filename": "scripts/npc/2081100.js", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081100.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -59,19 +59,24 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1) {\n                         if (mode >= 1 && cm.getJobId() % 100 % 10 != 2) {\n-                                cm.changeJobById(cm.getJobId() + 1);\n-                                if(cm.getJobId() == 112) {\n-                                        cm.teachSkill(1121001, 0, 10, -1);\n-                                        cm.teachSkill(1120004, 0, 10, -1);\n-                                        cm.teachSkill(1121008, 0, 10, -1);\n-                                } else if(cm.getJobId() == 122) {\n-                                        cm.teachSkill(1221001, 0, 10, -1);\n-                                        cm.teachSkill(1220005, 0, 10, -1);\n-                                        cm.teachSkill(1221009, 0, 10, -1);\n-                                } else if(cm.getJobId() == 132) {\n-                                        cm.teachSkill(1321001, 0, 10, -1);\n-                                        cm.teachSkill(1320005, 0, 10, -1);\n-                                        cm.teachSkill(1321007, 0, 10, -1);\n+                                if (cm.canHold(2280003, 1)) {\n+                                        cm.changeJobById(cm.getJobId() + 1);\n+                                        if(cm.getJobId() == 112) {\n+                                                cm.teachSkill(1121001, 0, 10, -1);\n+                                                cm.teachSkill(1120004, 0, 10, -1);\n+                                                cm.teachSkill(1121008, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 122) {\n+                                                cm.teachSkill(1221001, 0, 10, -1);\n+                                                cm.teachSkill(1220005, 0, 10, -1);\n+                                                cm.teachSkill(1221009, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 132) {\n+                                                cm.teachSkill(1321001, 0, 10, -1);\n+                                                cm.teachSkill(1320005, 0, 10, -1);\n+                                                cm.teachSkill(1321007, 0, 10, -1);\n+                                        }\n+                                        cm.gainItem(2280003, 1);\n+                                } else {\n+                                        cm.sendOk(\"Please have one slot available on #bUSE#k inventory to receive a skill book.\");\n                                 }\n                         } else if(mode >= 0 && cm.getJobId() % 100 % 10 == 2) {\n                                 // TEMP until I can get the quest fixed..."}, {"sha": "ecb0b3882e6fde075f7370f1ed55a66d24d78dad", "filename": "scripts/npc/2081200.js", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081200.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081200.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081200.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -60,19 +60,24 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1) {\n                         if (mode >= 1 && cm.getJobId() % 100 % 10 != 2) {\n-                                cm.changeJobById(cm.getJobId() + 1);\n-                                if(cm.getJobId() == 212) {\n-                                        cm.teachSkill(2121001, 0, 10, -1);\n-                                        cm.teachSkill(2121002, 0, 10, -1);\n-                                        cm.teachSkill(2121006, 0, 10, -1);\n-                                } else if(cm.getJobId() == 222) {\n-                                        cm.teachSkill(2221001, 0, 10, -1);\n-                                        cm.teachSkill(2221002, 0, 10, -1);\n-                                        cm.teachSkill(2221006, 0, 10, -1);\n-                                } else if(cm.getJobId() == 232) {\n-                                        cm.teachSkill(2321001, 0, 10, -1);\n-                                        cm.teachSkill(2321002, 0, 10, -1);\n-                                        cm.teachSkill(2321005, 0, 10, -1);\n+                                if (cm.canHold(2280003, 1)) {\n+                                        cm.changeJobById(cm.getJobId() + 1);\n+                                        if(cm.getJobId() == 212) {\n+                                                cm.teachSkill(2121001, 0, 10, -1);\n+                                                cm.teachSkill(2121002, 0, 10, -1);\n+                                                cm.teachSkill(2121006, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 222) {\n+                                                cm.teachSkill(2221001, 0, 10, -1);\n+                                                cm.teachSkill(2221002, 0, 10, -1);\n+                                                cm.teachSkill(2221006, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 232) {\n+                                                cm.teachSkill(2321001, 0, 10, -1);\n+                                                cm.teachSkill(2321002, 0, 10, -1);\n+                                                cm.teachSkill(2321005, 0, 10, -1);\n+                                        }\n+                                        cm.gainItem(2280003, 1);\n+                                } else {\n+                                        cm.sendOk(\"Please have one slot available on #bUSE#k inventory to receive a skill book.\");\n                                 }\n                         } else if( mode >= 1 && cm.getJobId() % 100 % 10 == 2) {\n                                 if(cm.getJobId() == 212) {"}, {"sha": "5d8ef07f42e479b8cc8bb0e5e17b62d5bff17531", "filename": "scripts/npc/2081300.js", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081300.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081300.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081300.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -60,15 +60,20 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1) {\n                         if (mode >= 1 && cm.getJobId() % 100 % 10 != 2) {\n-                                cm.changeJobById(cm.getJobId() + 1);\n-                                if(cm.getJobId() == 312) {\n-                                        cm.teachSkill(3121002, 0, 10, -1);\n-                                        cm.teachSkill(3120005, 0, 10, -1);\n-                                        cm.teachSkill(3121007, 0, 10, -1);\n-                                } else if(cm.getJobId() == 322) {\n-                                        cm.teachSkill(3221002, 0, 10, -1);\n-                                        cm.teachSkill(3220004, 0, 10, -1);\n-                                        cm.teachSkill(3221006, 0, 10, -1);\n+                                if (cm.canHold(2280003, 1)) {\n+                                        cm.changeJobById(cm.getJobId() + 1);\n+                                        if(cm.getJobId() == 312) {\n+                                                cm.teachSkill(3121002, 0, 10, -1);\n+                                                cm.teachSkill(3120005, 0, 10, -1);\n+                                                cm.teachSkill(3121007, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 322) {\n+                                                cm.teachSkill(3221002, 0, 10, -1);\n+                                                cm.teachSkill(3220004, 0, 10, -1);\n+                                                cm.teachSkill(3221006, 0, 10, -1);\n+                                        }\n+                                        cm.gainItem(2280003, 1);\n+                                } else {\n+                                        cm.sendOk(\"Please have one slot available on #bUSE#k inventory to receive a skill book.\");\n                                 }\n                         } else if(mode >= 0 && cm.getJobId() % 100 % 10 == 2) {\n                                 if(cm.getJobId() == 312) {"}, {"sha": "c1fd82010e55cd38ef42d06b45972d215c224323", "filename": "scripts/npc/2081400.js", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081400.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081400.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081400.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -60,15 +60,20 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1) {\n                         if (mode >= 1 && cm.getJobId() % 100 % 10 != 2) {\n-                                cm.changeJobById(cm.getJobId() + 1);\n-                                if(cm.getJobId() == 412) {\n-                                        cm.teachSkill(4120002, 0, 10, -1);\n-                                        cm.teachSkill(4120005, 0, 10, -1);\n-                                        cm.teachSkill(4121006, 0, 10, -1);\n-                                } else if(cm.getJobId() == 422) {\n-                                        cm.teachSkill(4220002, 0, 10, -1);\n-                                        cm.teachSkill(4220005, 0, 10, -1);\n-                                        cm.teachSkill(4221007, 0, 10, -1);\n+                                if (cm.canHold(2280003, 1)) {\n+                                        cm.changeJobById(cm.getJobId() + 1);\n+                                        if(cm.getJobId() == 412) {\n+                                                cm.teachSkill(4120002, 0, 10, -1);\n+                                                cm.teachSkill(4120005, 0, 10, -1);\n+                                                cm.teachSkill(4121006, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 422) {\n+                                                cm.teachSkill(4220002, 0, 10, -1);\n+                                                cm.teachSkill(4220005, 0, 10, -1);\n+                                                cm.teachSkill(4221007, 0, 10, -1);\n+                                        }\n+                                        cm.gainItem(2280003, 1);\n+                                } else {\n+                                        cm.sendOk(\"Please have one slot available on #bUSE#k inventory to receive a skill book.\");\n                                 }\n                         } else if(mode >= 1 && cm.getJobId() % 100 % 10 == 2) {\n                                 if(cm.getJobId() == 412) {"}, {"sha": "aa2c83ec929e19dfa5392aa1662e91f13fe2cf22", "filename": "scripts/npc/2081500.js", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081500.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2081500.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081500.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -60,17 +60,22 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1) {\n                         if (mode >= 1 && cm.getJobId() % 100 % 10 != 2) {\n-                                cm.changeJobById(cm.getJobId() + 1);\n-                                if(cm.getJobId() == 512) {\n-                                        cm.teachSkill(5121001, 0, 10, -1);\n-                                        cm.teachSkill(5121002, 0, 10, -1);\n-                                        cm.teachSkill(5121007, 0, 10, -1);\n-                                        cm.teachSkill(5121009, 0, 10, -1);\n-                                } else if(cm.getJobId() == 522) {\n-                                        cm.teachSkill(5220001, 0, 10, -1);\n-                                        cm.teachSkill(5220002, 0, 10, -1);\n-                                        cm.teachSkill(5221004, 0, 10, -1);\n-                                        cm.teachSkill(5220011, 0, 10, -1);\n+                                if (cm.canHold(2280003, 1)) {\n+                                        cm.changeJobById(cm.getJobId() + 1);\n+                                        if(cm.getJobId() == 512) {\n+                                                cm.teachSkill(5121001, 0, 10, -1);\n+                                                cm.teachSkill(5121002, 0, 10, -1);\n+                                                cm.teachSkill(5121007, 0, 10, -1);\n+                                                cm.teachSkill(5121009, 0, 10, -1);\n+                                        } else if(cm.getJobId() == 522) {\n+                                                cm.teachSkill(5220001, 0, 10, -1);\n+                                                cm.teachSkill(5220002, 0, 10, -1);\n+                                                cm.teachSkill(5221004, 0, 10, -1);\n+                                                cm.teachSkill(5220011, 0, 10, -1);\n+                                        }\n+                                        cm.gainItem(2280003, 1);\n+                                } else {\n+                                        cm.sendOk(\"Please have one slot available on #bUSE#k inventory to receive a skill book.\");\n                                 }\n                         } else if(mode >= 1 && cm.getJobId() % 100 % 10 == 2) {\n                                 if(cm.getJobId() == 512) {"}, {"sha": "1ec7ae27a1fb7c54edf6a4e2a7a21745d0d956aa", "filename": "scripts/npc/2100.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/2100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2100.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -56,10 +56,10 @@ function action(mode, type, selection) {\n             cm.sendNext(\"It seems like you want to start your journey without taking the training program. Then, I will let you move on to the training ground. Be careful~\");\n         }else if(status == 1){\n             cm.warp(1, 0);\n-            dispose();\n+            cm.dispose();\n         }else{\n             cm.warp(40000, 0);\n-            dispose();\n+            cm.dispose();\n         }\n     }else\n     if(status == 0)"}, {"sha": "495425e7f0eddd27f4534ac6a3f2627420b33a2c", "filename": "scripts/npc/9010022.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/9010022.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/npc/9010022.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -33,14 +33,15 @@ function action(mode, type, selection) {\n                     selStr += \"#1# Mu Lung Dojo\"; \n                 } \n \n-                /*if (cm.getLevel() >= 30 && cm.getLevel() <= 50) { NOT IMPLEMENTED\n+                if (cm.getLevel() >= 30 && cm.getLevel() <= 50) {   // MC 1 & 2 recalled thanks to ---\n                     selStr += \"#2# Monster Carnival 1\"; \n                 } \n \n-                if (cm.getLevel() >= 51 && cm.getLevel() <= 70) { NOT IMPLEMENTED\n+                if (cm.getLevel() >= 51 && cm.getLevel() <= 70) {\n                     selStr += \"#3# Monster Carnival 2\"; \n                 } \n \n+                /*\n                 if (cm.getLevel() >= 40) { NOT IMPLEMENTED\n                     selStr += \"#5# Nett's Pyramid\"; \n                 } \n@@ -62,9 +63,11 @@ function action(mode, type, selection) {\n                     cm.warp(925020000, 0); \n                     break; \n                 case 2: \n+                    cm.getPlayer().saveLocation(\"MONSTER_CARNIVAL\"); \n                     cm.warp(980000000, 3); \n                     break; \n                 case 3: \n+                    cm.getPlayer().saveLocation(\"MONSTER_CARNIVAL\"); \n                     cm.warp(980030000, 3); \n                     break; \n                 case 5: "}, {"sha": "dea993fd17d7692cbe21538d90fe2f7e593d37b2", "filename": "scripts/quest/21401.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/quest/21401.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/quest/21401.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21401.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -55,8 +55,14 @@ function end(mode, type, selection) {\n \t\t\t\tqm.dispose();\n \t\t\t\treturn;\n \t\t\t}\n+                        if (!qm.canHold(2280003, 1)) {\n+                                qm.sendOk(\"Hey, your #buse#k inventory is full. I need you to make at least 1 empty slot to complete this quest.\");\n+\t\t\t\tqm.dispose();\n+\t\t\t\treturn;\n+                        }\n \t\t\t\n \t\t\tqm.gainItem(1142132, true);\n+                        qm.gainItem(2280003, 1);\n \t\t\tqm.changeJobById(2112);\n \t\t\t\n \t\t\tqm.completeQuest();"}, {"sha": "6705ea90c5dfe2aa6f497546a69d19f75f3b4eb4", "filename": "scripts/reactor/8091000.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/8091000.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -28,4 +28,5 @@\n function act(){\n     rm.spawnMonster(9400210, 2);\n     rm.spawnMonster(9400209, 2);\n+    rm.mapMessage(5, \"Some monsters are summoned.\");\n }\n\\ No newline at end of file"}, {"sha": "b3d8dff1f240c26c346d4b2ae6cd6daec2664267", "filename": "scripts/reactor/8091001.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/8091001.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -28,4 +28,5 @@\n function act(){\n     rm.spawnMonster(9400211, 2);\n     rm.spawnMonster(9400212, 2);\n+    rm.mapMessage(5, \"Some monsters are summoned.\");\n }\n\\ No newline at end of file"}, {"sha": "83fe1c19100704ab96cf568cc419f4d1e5ed3836", "filename": "scripts/reactor/8091002.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/8091002.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -28,4 +28,5 @@\n function act(){\n     rm.spawnMonster(9400213, 2);\n     rm.spawnMonster(9400214, 2);\n+    rm.mapMessage(5, \"Some monsters are summoned.\");\n }\n\\ No newline at end of file"}, {"sha": "69b5724a874074bd78c164e2412c4c48bc7ce312", "filename": "scripts/reactor/8091003.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/8091003.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -28,4 +28,5 @@\n function act(){\n     rm.spawnMonster(9400215, 2);\n     rm.spawnMonster(9400216, 2);\n+    rm.mapMessage(5, \"Some monsters are summoned.\");\n }\n\\ No newline at end of file"}, {"sha": "3ab923251970dfbb447b9d540b606a90c650549c", "filename": "scripts/reactor/8091004.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/scripts/reactor/8091004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/8091004.js?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -28,4 +28,5 @@\n function act(){\n     rm.spawnMonster(9400217, 2);\n     rm.spawnMonster(9400218, 2);\n+    rm.mapMessage(5, \"Some monsters are summoned.\");\n }\n\\ No newline at end of file"}, {"sha": "687eb7f7057a6efa106d45c32a44ea27a4004268", "filename": "sql/db_drops.sql", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -23914,3 +23914,5 @@ SET minimum_quantity = CASE\n                        WHEN dropperid = 9500369 AND itemid = 2060000 THEN 24\n   ELSE maximum_quantity END\n ;\n+\n+  UPDATE drop_data SET `chance`=1287 WHERE `chance`=1500;\n\\ No newline at end of file"}, {"sha": "f3119ff66e73a8f44b2ea6328a1b759921ebb22f", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -2992,8 +2992,7 @@ public void gainExp(int gain, int party, boolean show, boolean inChat, boolean w\n         \n         int equip = (int) Math.min((long)(gain / 10) * pendantExp, Integer.MAX_VALUE);\n         \n-        long total = (long) gain + equip + party;\n-        gainExpInternal(total, equip, party, show, inChat, white);\n+        gainExpInternal((long) gain, equip, party, show, inChat, white);\n     }\n     \n     public void loseExp(int loss, boolean show, boolean inChat) {\n@@ -3004,8 +3003,23 @@ public void loseExp(int loss, boolean show, boolean inChat, boolean white) {\n         gainExpInternal(-loss, 0, 0, show, inChat, white);\n     }\n     \n+    private void announceExpGain(long gain, int equip, int party, boolean inChat, boolean white) {\n+        gain = Math.min(gain, Integer.MAX_VALUE);\n+        if (gain == 0) {\n+            if (party == 0) {\n+                return;\n+            }\n+            \n+            gain = party;\n+            party = 0;\n+            white = false;\n+        }\n+        \n+        client.announce(MaplePacketCreator.getShowExpGain((int) gain, equip, party, inChat, white));\n+    }\n+    \n     private synchronized void gainExpInternal(long gain, int equip, int party, boolean show, boolean inChat, boolean white) {   // need of method synchonization here detected thanks to MedicOP\n-        long total = Math.max(gain, -exp.get());\n+        long total = Math.max(gain + equip + party, -exp.get());\n         \n         if (level < getMaxLevel() && (allowExpGain || this.getEventInstance() != null)) {\n             long leftover = 0;\n@@ -3016,8 +3030,8 @@ private synchronized void gainExpInternal(long gain, int equip, int party, boole\n                 leftover = nextExp - Integer.MAX_VALUE;\n             }\n             updateSingleStat(MapleStat.EXP, exp.addAndGet((int) total));\n-            if (show && gain != 0) {\n-                client.announce(MaplePacketCreator.getShowExpGain((int)Math.min(gain, Integer.MAX_VALUE), equip, party, inChat, white));\n+            if (show) {\n+                announceExpGain(gain, equip, party, inChat, white);\n             }\n             while (exp.get() >= ExpTable.getExpNeededForLevel(level)) {\n                 levelUp(true);"}, {"sha": "224f8db0cc1cc7d4c6f028cb17d048394e995ac5", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -1474,7 +1474,6 @@ public void changeChannel(int channel) {\n                 player.unregisterChairBuff();\n \t\tserver.getPlayerBuffStorage().addBuffsToStorage(player.getId(), player.getAllBuffs());\n                 server.getPlayerBuffStorage().addDiseasesToStorage(player.getId(), player.getAllDiseases());\n-                player.setSessionTransitionState();\n                 player.setDisconnectedFromChannelWorld();\n                 player.notifyMapTransferToPartner(-1);\n                 player.removeIncomingInvites();\n@@ -1491,8 +1490,10 @@ public void changeChannel(int channel) {\n \t\tplayer.getMap().removePlayer(player);\n                 player.clearBanishPlayerData();\n \t\tplayer.getClient().getChannelServer().removePlayer(player);\n-\t\tplayer.getClient().updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-\t\ttry {\n+\t\t\n+                player.getClient().updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+\t\tplayer.setSessionTransitionState();\n+                try {\n \t\t\tannounce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));\n \t\t} catch (IOException e) {\n                     e.printStackTrace();"}, {"sha": "daf53a4f4d864466abd74401a08b89f1f5df2ff5", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -81,7 +81,7 @@ private CommandsExecutor(){\n     }\n     \n     public void handle(MapleClient client, String message){\n-            if (client.tryacquireClient()) {\n+        if (client.tryacquireClient()) {\n             try {\n                 handleInternal(client, message);\n             } finally {\n@@ -113,8 +113,8 @@ private void handleInternal(MapleClient client, String message){\n             return;\n         }\n         String[] params;\n-        if (lowercaseParams.length > 0) {\n-             params = Arrays.copyOfRange(lowercaseParams, 0, lowercaseParams.length);\n+        if (lowercaseParams.length > 0 && !lowercaseParams[0].isEmpty()) {\n+            params = Arrays.copyOfRange(lowercaseParams, 0, lowercaseParams.length);\n         } else {\n             params = new String[]{};\n         }"}, {"sha": "00496f32ebffd55edcfb9aea30cd1a57b46166d2", "filename": "src/client/command/commands/gm6/WarpWorldCommand.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/command/commands/gm6/WarpWorldCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/client/command/commands/gm6/WarpWorldCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/WarpWorldCommand.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -53,6 +53,7 @@ public void execute(MapleClient c, String[] params) {\n                 c.getWorldServer().removePlayer(player);\n                 player.getMap().removePlayer(player);//LOL FORGOT THIS ><\n                 c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+                player.setSessionTransitionState();\n                 player.setWorld(worldb);\n                 player.saveCharToDB();//To set the new world :O (true because else 2 player instances are created, one in both worlds)\n                 c.announce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));"}, {"sha": "49ec85be321bd306cb2a4db15e186e599a2e1e4b", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -150,8 +150,6 @@\n     public static final float PARTY_BONUS_EXP_RATE = 1.0f;          //Rate for the party exp bonus reward.\n     public static final double PQ_BONUS_EXP_RATE = 0.5;             //Rate for the PQ exp reward.\n     \n-    public static final int PARTY_EXPERIENCE_MOD = 1;               //Change for event stuff.\n-    \n     //Miscellaneous Configuration\n     public static String TIMEZONE = \"GMT-3\";\n     public static boolean USE_DISPLAY_NUMBERS_WITH_COMMA = true;        //Enforce comma on displayed strings (use this when USE_UNITPRICE_WITH_COMMA is active and you still want to display comma-separated values)."}, {"sha": "2e374bffe434ee0cc91ee9faa92147effcd2edcb", "filename": "src/net/opcodes/SendOpcode.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/opcodes/SendOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/opcodes/SendOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/opcodes/SendOpcode.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -329,6 +329,7 @@\n     CHARGE_PARAM_RESULT(0x143),\n     QUERY_CASH_RESULT(0x144),\n     CASHSHOP_OPERATION(0x145),\n+    CASHSHOP_PURCHASE_EXP_CHANGED(0x146),   // found thanks to Arnah (Vertisy)\n     CASHSHOP_GIFT_INFO_RESULT(0x147),\n     CASHSHOP_CHECK_NAME_CHANGE(0x148),\n     CASHSHOP_CHECK_NAME_CHANGE_POSSIBLE_RESULT(0x149),"}, {"sha": "7a12f9acc08fb48b031d889283106ac8004a6cb5", "filename": "src/net/server/channel/handlers/CashShopSurpriseHandler.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/CashShopSurpriseHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/CashShopSurpriseHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashShopSurpriseHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -25,6 +25,7 @@\n import server.CashShop;\n import tools.data.input.SeekableLittleEndianAccessor;\n import tools.MaplePacketCreator;\n+import tools.Pair;\n \n /**\n  *\n@@ -36,11 +37,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         CashShop cs = c.getPlayer().getCashShop();\n         \n         if(cs.isOpened()) {\n-            Item cssItem = cs.openCashShopSurprise();\n+            Pair<Item, Item> cssResult = cs.openCashShopSurprise();\n             \n-            if(cssItem != null) {\n+            if(cssResult != null) {\n+                //Item cssItem = cssResult.getLeft(), cssBox = cssResult.getRight();\n+                //c.announce(MaplePacketCreator.onCashGachaponOpenSuccess(c.getAccID(), cssBox.getSN(), cssBox.getQuantity(), cssItem, cssItem.getItemId(), cssItem.getQuantity(), true));\n                 c.announce(MaplePacketCreator.showCashShopMessage((byte) 0xA4));\n             } else {\n+                //c.announce(MaplePacketCreator.onCashItemGachaponOpenFailed());\n                 c.announce(MaplePacketCreator.showCashShopMessage((byte) 0x00));\n             }\n         }"}, {"sha": "f12e865ac744c988a552600e1f6ec0e5f4558f5d", "filename": "src/net/server/channel/handlers/ChangeMapHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/ChangeMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/ChangeMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeMapHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -61,11 +61,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t}\n \t\t\tString[] socket = c.getChannelServer().getIP().split(\":\");\n \t\t\tchr.getCashShop().open(false);\n-\t\t\tc.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+\t\t\t\n+                        c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+                        chr.setSessionTransitionState();\n \t\t\ttry {\n \t\t\t\tc.announce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));\n \t\t\t} catch (UnknownHostException ex) {\n-                            ex.printStackTrace();\n+                                ex.printStackTrace();\n \t\t\t}\n \t\t} else {\n \t\t\tif(chr.getCashShop().isOpened()) {"}, {"sha": "7d86d574b824750e0e88e1505fff63ee36270a25", "filename": "src/net/server/channel/handlers/EnterCashShopHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/EnterCashShopHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/EnterCashShopHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterCashShopHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -65,7 +65,6 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             mc.unregisterChairBuff();\n             Server.getInstance().getPlayerBuffStorage().addBuffsToStorage(mc.getId(), mc.getAllBuffs());\n             Server.getInstance().getPlayerBuffStorage().addDiseasesToStorage(mc.getId(), mc.getAllDiseases());\n-            mc.setSessionTransitionState();\n             mc.setAwayFromChannelWorld();\n             mc.notifyMapTransferToPartner(-1);\n             mc.removeIncomingInvites();"}, {"sha": "4bab7b410f858b76b63670db169afb6f81cd5a03", "filename": "src/net/server/channel/handlers/EnterMTSHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/EnterMTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/channel/handlers/EnterMTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterMTSHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -91,7 +91,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             chr.unregisterChairBuff();\n             Server.getInstance().getPlayerBuffStorage().addBuffsToStorage(chr.getId(), chr.getAllBuffs());\n             Server.getInstance().getPlayerBuffStorage().addDiseasesToStorage(chr.getId(), chr.getAllDiseases());\n-            chr.setSessionTransitionState();\n             chr.setAwayFromChannelWorld();\n             chr.notifyMapTransferToPartner(-1);\n             chr.removeIncomingInvites();"}, {"sha": "f3d351d3f55b563dbe5f10b47d67cedf30f1c593", "filename": "src/net/server/coordinator/MapleSessionCoordinator.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/coordinator/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/coordinator/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleSessionCoordinator.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -439,7 +439,7 @@ public AntiMulticlientResult attemptGameSession(IoSession session, int accountId\n         }\n         \n         try {\n-            String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+            String nibbleHwid = (String) session.getAttribute(MapleClient.CLIENT_NIBBLEHWID);   // thanks Paxum for noticing account stuck after PIC failure\n             if (nibbleHwid != null) {\n                 onlineRemoteHwids.remove(nibbleHwid);\n                 "}, {"sha": "31ac500d9fcf33c8fd8364b8bc964eb9927c7aa9", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -51,11 +51,6 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         c.updateHWID(hwid);\n         \n         IoSession session = c.getSession();\n-        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n-        if (res != AntiMulticlientResult.SUCCESS) {\n-            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n-            return;\n-        }\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n             MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n@@ -82,6 +77,12 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 return;\n             }\n             \n+            AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+            if (res != AntiMulticlientResult.SUCCESS) {\n+                c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+                return;\n+            }\n+            \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n             server.setCharacteridInTransition(session, charId);"}, {"sha": "21cb5447760871cea0ace752c47a258e3507c4f1", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -59,11 +59,6 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         IoSession session = c.getSession();\n-        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n-        if (res != AntiMulticlientResult.SUCCESS) {\n-            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n-            return;\n-        }\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n@@ -88,6 +83,12 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 return;\n             }\n             \n+            AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+            if (res != AntiMulticlientResult.SUCCESS) {\n+                c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+                return;\n+            }\n+            \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n             server.setCharacteridInTransition(session, charId);"}, {"sha": "74b1c5ab793e5cfcb72f78f6b1ee9ef27d47052f", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 34, "deletions": 37, "changes": 71, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -22,8 +22,6 @@\n package scripting.event;\n \n import java.io.File;\n-import java.sql.PreparedStatement;\n-import java.sql.SQLException;\n import tools.Pair;\n import java.util.ArrayList;\n import java.util.LinkedList;\n@@ -51,20 +49,12 @@\n import server.maps.MapleMap;\n import server.maps.MapleMapFactory;\n import server.maps.MapleReactor;\n-import tools.DatabaseConnection;\n import client.MapleCharacter;\n import client.SkillFactory;\n import client.Skill;\n-import client.inventory.Item;\n-import client.inventory.ItemFactory;\n-import client.inventory.MapleInventory;\n-import client.inventory.MapleInventoryType;\n-import client.inventory.manipulator.MapleInventoryManipulator;\n import constants.ItemConstants;\n import constants.ServerConstants;\n import java.awt.Point;\n-import java.sql.Connection;\n-import java.util.Arrays;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n@@ -79,7 +69,6 @@\n import server.life.MapleLifeFactory;\n import server.life.MapleNPC;\n import tools.MaplePacketCreator;\n-import tools.Randomizer;\n \n /**\n  *\n@@ -236,6 +225,14 @@ public void giveEventPlayersMeso(int gain, int mapId) {\n                 }\n                 \n \t}\n+        \n+        public Object invokeScriptFunction(String name, Object... args) throws ScriptException, NoSuchMethodException {\n+                if (!disposed) {\n+                        return em.getIv().invokeFunction(name, args);\n+                } else {\n+                        return null;\n+                }\n+        }\n \n         public synchronized void registerPlayer(final MapleCharacter chr) {\n                 registerPlayer(chr, true);\n@@ -260,7 +257,7 @@ public synchronized void registerPlayer(final MapleCharacter chr, boolean runEnt\n                 \n                 if (runEntryScript) {\n                         try {\n-                                em.getIv().invokeFunction(\"playerEntry\", EventInstanceManager.this, chr);\n+                                invokeScriptFunction(\"playerEntry\", EventInstanceManager.this, chr);\n                         } catch (ScriptException | NoSuchMethodException ex) {\n                                 ex.printStackTrace();\n                         }\n@@ -275,7 +272,7 @@ public void exitPlayer(final MapleCharacter chr) {\n                 unregisterPlayer(chr);\n                 \n                 try {\n-                        em.getIv().invokeFunction(\"playerExit\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"playerExit\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n@@ -306,7 +303,7 @@ public void run() {\n                                 dismissEventTimer();\n                                 \n                                 try {\n-                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n+                                        invokeScriptFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement scheduledTimeout function.\", ex);\n                                 }\n@@ -326,7 +323,7 @@ public void run() {\n                                                 dismissEventTimer();\n \n                                                 try {\n-                                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n+                                                        invokeScriptFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement scheduledTimeout function.\", ex);\n                                                 }\n@@ -395,7 +392,7 @@ private void registerExpeditionTeam(MapleExpedition exped, int recruitMap) {\n \n \tpublic void unregisterPlayer(final MapleCharacter chr) {\n                 try {\n-                        em.getIv().invokeFunction(\"playerUnregistered\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"playerUnregistered\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement playerUnregistered function.\", ex);\n                 }\n@@ -456,27 +453,27 @@ public void registerMonster(MapleMonster mob) {\n \n \tpublic void movePlayer(final MapleCharacter chr) {\n                 try {\n-                        em.getIv().invokeFunction(\"moveMap\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"moveMap\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n \t}\n         \n         public void changedMap(final MapleCharacter chr, final int mapId) {\n                 try {\n-                        em.getIv().invokeFunction(\"changedMap\", EventInstanceManager.this, chr, mapId);\n+                        invokeScriptFunction(\"changedMap\", EventInstanceManager.this, chr, mapId);\n                 } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n         public void afterChangedMap(final MapleCharacter chr, final int mapId) {\n                 try {\n-                        em.getIv().invokeFunction(\"afterChangedMap\", EventInstanceManager.this, chr, mapId);\n+                        invokeScriptFunction(\"afterChangedMap\", EventInstanceManager.this, chr, mapId);\n                 } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n         public synchronized void changedLeader(final MapleCharacter ldr) {\n                 try {\n-                        em.getIv().invokeFunction(\"changedLeader\", EventInstanceManager.this, ldr);\n+                        invokeScriptFunction(\"changedLeader\", EventInstanceManager.this, ldr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n@@ -504,14 +501,14 @@ public void monsterKilled(final MapleMonster mob, final boolean hasKiller) {\n                 \n                 if (scriptResult > 0) {\n                         try {\n-                                em.getIv().invokeFunction(\"monsterKilled\", mob, EventInstanceManager.this, hasKiller);\n+                                invokeScriptFunction(\"monsterKilled\", mob, EventInstanceManager.this, hasKiller);\n                         } catch (ScriptException | NoSuchMethodException ex) {\n                                 ex.printStackTrace();\n                         }\n                         \n                         if (scriptResult > 1) {\n                                 try {\n-                                        em.getIv().invokeFunction(\"allMonstersDead\", EventInstanceManager.this, hasKiller);\n+                                        invokeScriptFunction(\"allMonstersDead\", EventInstanceManager.this, hasKiller);\n                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                         ex.printStackTrace();\n                                 }\n@@ -521,7 +518,7 @@ public void monsterKilled(final MapleMonster mob, final boolean hasKiller) {\n         \n         public void friendlyKilled(final MapleMonster mob, final boolean hasKiller) {\n                 try {\n-                        em.getIv().invokeFunction(\"friendlyKilled\", mob, EventInstanceManager.this, hasKiller);\n+                        invokeScriptFunction(\"friendlyKilled\", mob, EventInstanceManager.this, hasKiller);\n                 } catch (ScriptException | NoSuchMethodException ex) {} //optional\n \t}\n \n@@ -530,21 +527,21 @@ public void playerKilled(final MapleCharacter chr) {\n                         @Override\n                         public void run() {\n                                 try {\n-                                        em.getIv().invokeFunction(\"playerDead\", EventInstanceManager.this, chr);\n+                                        invokeScriptFunction(\"playerDead\", EventInstanceManager.this, chr);\n                                 } catch (ScriptException | NoSuchMethodException ex) {} // optional\n                         }\n                 });\n \t}\n \n         public void reviveMonster(final MapleMonster mob) {\n                 try {\n-                        em.getIv().invokeFunction(\"monsterRevive\", EventInstanceManager.this, mob);\n+                        invokeScriptFunction(\"monsterRevive\", EventInstanceManager.this, mob);\n                 } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n \tpublic boolean revivePlayer(final MapleCharacter chr) {\n                 try {\n-                        Object b = em.getIv().invokeFunction(\"playerRevive\", EventInstanceManager.this, chr);\n+                        Object b = invokeScriptFunction(\"playerRevive\", EventInstanceManager.this, chr);\n                         if (b instanceof Boolean) {\n                                 return (Boolean) b;\n                         }\n@@ -555,7 +552,7 @@ public boolean revivePlayer(final MapleCharacter chr) {\n         \n \tpublic void playerDisconnected(final MapleCharacter chr) {\n                 try {\n-                        em.getIv().invokeFunction(\"playerDisconnected\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"playerDisconnected\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n@@ -568,9 +565,9 @@ public void monsterKilled(MapleCharacter chr, final MapleMonster mob) {\n                         int inc;\n                         \n                         if (ServerConstants.JAVA_8) {\n-                                inc = (int)em.getIv().invokeFunction(\"monsterValue\", EventInstanceManager.this, mob.getId());\n+                                inc = (int)invokeScriptFunction(\"monsterValue\", EventInstanceManager.this, mob.getId());\n                         } else {\n-                                inc = ((Double) em.getIv().invokeFunction(\"monsterValue\", EventInstanceManager.this, mob.getId())).intValue();\n+                                inc = ((Double) invokeScriptFunction(\"monsterValue\", EventInstanceManager.this, mob.getId())).intValue();\n                         }\n                         \n                         if (inc != 0) {\n@@ -609,12 +606,12 @@ public void dispose() {\n         public synchronized void dispose(boolean shutdown) {    // should not trigger any event script method after disposed\n                 if(disposed) return;\n                 \n-                disposed = true;\n                 try {\n-                        em.getIv().invokeFunction(\"dispose\", EventInstanceManager.this);\n+                        invokeScriptFunction(\"dispose\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n+                disposed = true;\n                 \n                 ess.dispose();\n                 \n@@ -690,7 +687,7 @@ public void schedule(final String methodName, long delay) {\n                                         @Override\n                                         public void run() {\n                                                 try {\n-                                                        em.getIv().invokeFunction(methodName, EventInstanceManager.this);\n+                                                        invokeScriptFunction(methodName, EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         ex.printStackTrace();\n                                                 }\n@@ -789,31 +786,31 @@ public Object getObjectProperty(String key) {\n \t\n \tpublic void leftParty(final MapleCharacter chr) {\n                 try {\n-                        em.getIv().invokeFunction(\"leftParty\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"leftParty\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n \t}\n \n \tpublic void disbandParty() {\n \t\ttry {\n-                        em.getIv().invokeFunction(\"disbandParty\", EventInstanceManager.this);\n+                        invokeScriptFunction(\"disbandParty\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n \t}\n \n \tpublic void clearPQ() {\n                 try {\n-                        em.getIv().invokeFunction(\"clearPQ\", EventInstanceManager.this);\n+                        invokeScriptFunction(\"clearPQ\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n \t}\n \n \tpublic void removePlayer(final MapleCharacter chr) {\n                 try {\n-                        em.getIv().invokeFunction(\"playerExit\", EventInstanceManager.this, chr);\n+                        invokeScriptFunction(\"playerExit\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n@@ -1081,7 +1078,7 @@ public final synchronized void startEvent() {\n                 eventStarted = true;\n                 \n                 try {\n-                        em.getIv().invokeFunction(\"afterSetup\", EventInstanceManager.this);\n+                        invokeScriptFunction(\"afterSetup\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }"}, {"sha": "ae07b48907176b0abe77e284f638acefd8ff5329", "filename": "src/server/CashShop.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -557,7 +557,7 @@ private Item getCashShopItemByItemid(int itemid) {\n         return null;\n     }\n     \n-    public synchronized Item openCashShopSurprise() {\n+    public synchronized Pair<Item, Item> openCashShopSurprise() {\n         Item css = getCashShopItemByItemid(5222000);\n         \n         if(css != null) {\n@@ -577,7 +577,7 @@ public synchronized Item openCashShopSurprise() {\n                 Item item = cItem.toItem();\n                 addToInventory(item);\n \n-                return item;\n+                return new Pair<>(item, css);\n             } else {\n                 return null;\n             }"}, {"sha": "10b003ece03911f7c947fcee872716b038c51915", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -1107,7 +1107,7 @@ public void updateBuffEffect(MapleCharacter target, List<Pair<MapleBuffStat, Int\n     }\n \n     private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, boolean primary) {\n-        if (!isMonsterRiding() && !isCouponBuff() && !isMysticDoor() && !isHyperBody()) {     // last mystic door already dispelled if it has been used before.\n+        if (!isMonsterRiding() && !isCouponBuff() && !isMysticDoor() && !isHyperBody() && !isCombo()) {     // last mystic door already dispelled if it has been used before.\n             applyto.cancelEffect(this, true, -1);\n         }\n \n@@ -1190,7 +1190,12 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n                 List<Pair<MapleBuffStat, Integer>> dsstat = Collections.singletonList(new Pair<>(MapleBuffStat.WIND_WALK, 0));\n                 mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), dsstat);\n             } else if (isCombo()) {\n-                mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), statups);\n+                Integer comboCount = applyto.getBuffedValue(MapleBuffStat.COMBO);\n+                if (comboCount == null) comboCount = 0;\n+                \n+                List<Pair<MapleBuffStat, Integer>> cbstat = Collections.singletonList(new Pair<>(MapleBuffStat.COMBO, comboCount));\n+                buff = MaplePacketCreator.giveBuff((skill ? sourceid : -sourceid), localDuration, cbstat);\n+                mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), cbstat);\n             } else if (isMonsterRiding()) {\n                 if (sourceid == Corsair.BATTLE_SHIP) {//hp\n                     if (applyto.getBattleshipHp() <= 0) {"}, {"sha": "8a7e1bcd0709769b49561c3f0ae7dea13dadfb78", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 24, "deletions": 5, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -535,15 +535,34 @@ private int calcThresholdLevel(boolean isPqMob) {\n         }\n     }\n     \n-    private void propagateExperienceGains(Map<MapleCharacter, Float> personalExpReward, Map<MapleCharacter, Float> partyExpReward) {\n+    private static double calcExperienceStandDevThreshold(Map<MapleCharacter, Float> personalExpReward, float exp2) {\n+        float avgExpReward = 0.0f;\n+        for (Float exp : personalExpReward.values()) {\n+            avgExpReward += exp;\n+        }\n+        \n+        avgExpReward -= exp2;   // clear out the 20% raw exp from last hitting\n+        avgExpReward /= personalExpReward.size();\n+        \n+        float varExpReward = 0.0f;\n+        for (Float exp : personalExpReward.values()) {\n+            varExpReward += Math.pow(exp - avgExpReward, 2);\n+        }\n+        varExpReward /= personalExpReward.size();\n+        \n+        return avgExpReward + Math.sqrt(varExpReward);\n+    }\n+    \n+    private void propagateExperienceGains(Map<MapleCharacter, Float> personalExpReward, Map<MapleCharacter, Float> partyExpReward, float exp2) {\n         Set<MapleCharacter> expRewardPlayers = new HashSet<>(personalExpReward.keySet());\n         expRewardPlayers.addAll(partyExpReward.keySet());\n         \n+        double sdevExp = calcExperienceStandDevThreshold(personalExpReward, exp2);\n         for (MapleCharacter chr : expRewardPlayers) {\n             Float personalExp = personalExpReward.get(chr);\n             Float partyExp = partyExpReward.get(chr);\n             \n-            this.giveExpToCharacter(chr, personalExp, partyExp);\n+            this.giveExpToCharacter(chr, personalExp, partyExp, personalExp != null && personalExp >= sdevExp);\n         }\n     }\n     \n@@ -628,7 +647,7 @@ private void distributeExperience(int killerId) {\n             mc.showUnderleveledInfo(this);\n         }\n         \n-        propagateExperienceGains(personalExpReward, partyExpReward);\n+        propagateExperienceGains(personalExpReward, partyExpReward, killerLevel != Integer.MAX_VALUE ? exp2 : 0.0f);\n     }\n     \n     private float getStatusExpMultiplier(MapleCharacter attacker) {\n@@ -663,7 +682,7 @@ private static int expValueToInteger(double exp) {\n         return (int) exp;\n     }\n     \n-    private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Float partyExp) {\n+    private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Float partyExp, boolean white) {\n         if (attacker.isAlive()) {\n             if (personalExp != null) {\n                 personalExp *= getStatusExpMultiplier(attacker);\n@@ -689,7 +708,7 @@ private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Floa\n             \n             int _partyExp = expValueToInteger(partyExp);\n             \n-            attacker.gainExp(_personalExp, _partyExp, true, false, false);\n+            attacker.gainExp(_personalExp, _partyExp, true, false, white);\n             attacker.increaseEquipExp(_personalExp);\n             attacker.updateQuestMobCount(getId());\n         }"}, {"sha": "6e5ded039f6d8185c620c29d76ac8ed551f29db3", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -1069,7 +1069,7 @@ public void sendPackets(MapleClient c) {\n                 if (chr.needQuestItem(questid, idrop.getItemId())) {\n                     mdrop.lockItem();\n                     try {\n-                        c.announce(MaplePacketCreator.dropItemFromMapObject(chr.getParty() != null, mdrop, dropper.getPosition(), dropPos, (byte) 1));\n+                        c.announce(MaplePacketCreator.dropItemFromMapObject(chr, mdrop, dropper.getPosition(), dropPos, (byte) 1));\n                     } finally {\n                         mdrop.unlockItem();\n                     }\n@@ -1091,7 +1091,7 @@ public final void spawnMesoDrop(final int meso, final Point position, final Mapl\n             public void sendPackets(MapleClient c) {\n                 mdrop.lockItem();\n                 try {\n-                    c.announce(MaplePacketCreator.dropItemFromMapObject(c.getPlayer().getParty() != null, mdrop, dropper.getPosition(), droppos, (byte) 1));\n+                    c.announce(MaplePacketCreator.dropItemFromMapObject(c.getPlayer(), mdrop, dropper.getPosition(), droppos, (byte) 1));\n                 } finally {\n                     mdrop.unlockItem();\n                 }\n@@ -2179,7 +2179,7 @@ public final void spawnItemDrop(final MapleMapObject dropper, final MapleCharact\n             public void sendPackets(MapleClient c) {\n                 mdrop.lockItem();\n                 try {\n-                    c.announce(MaplePacketCreator.dropItemFromMapObject(c.getPlayer().getParty() != null, mdrop, dropper.getPosition(), droppos, (byte) 1));\n+                    c.announce(MaplePacketCreator.dropItemFromMapObject(c.getPlayer(), mdrop, dropper.getPosition(), droppos, (byte) 1));\n                 } finally {\n                     mdrop.unlockItem();\n                 }\n@@ -2877,7 +2877,7 @@ private void broadcastItemDropMessage(MapleMapItem mdrop, Point dropperPos, Poin\n         chrRLock.lock();\n         try {\n             for (MapleCharacter chr : characters) {\n-                final byte[] packet = MaplePacketCreator.dropItemFromMapObject(chr.getParty() != null, mdrop, dropperPos, dropPos, mod);\n+                final byte[] packet = MaplePacketCreator.dropItemFromMapObject(chr, mdrop, dropperPos, dropPos, mod);\n                 \n                 if (rangeSq < Double.POSITIVE_INFINITY) {\n                     if (rangedFrom.distanceSq(chr.getPosition()) <= rangeSq) {"}, {"sha": "163845b0121f859d2c6c47edcb855ee4cf897ba0", "filename": "src/server/maps/MapleMapItem.java", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/maps/MapleMapItem.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/server/maps/MapleMapItem.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapItem.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -23,6 +23,7 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Item;\n+import constants.ServerConstants;\n import java.awt.Point;\n import java.util.concurrent.locks.Lock;\n import tools.MaplePacketCreator;\n@@ -35,7 +36,7 @@\n     protected MapleMapObject dropper;\n     protected int character_ownerid, party_ownerid, meso, questid = -1;\n     protected byte type;\n-    protected boolean pickedUp = false, playerDrop;\n+    protected boolean pickedUp = false, playerDrop, partyDrop;\n     protected long dropTime;\n     private Lock itemLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MAP_ITEM);\n \n@@ -45,6 +46,7 @@ public MapleMapItem(Item item, Point position, MapleMapObject dropper, MapleChar\n \tthis.dropper = dropper;\n         this.character_ownerid = owner.getId();\n         this.party_ownerid = owner.getPartyId();\n+        this.partyDrop = this.party_ownerid != -1;\n         this.ownerClient = owner.getClient();\n \tthis.meso = 0;\n \tthis.type = type;\n@@ -57,6 +59,7 @@ public MapleMapItem(Item item, Point position, MapleMapObject dropper, MapleChar\n \tthis.dropper = dropper;\n         this.character_ownerid = owner.getId();\n         this.party_ownerid = owner.getPartyId();\n+        this.partyDrop = this.party_ownerid != -1;\n \tthis.ownerClient = owner.getClient();\n         this.meso = 0;\n \tthis.type = type;\n@@ -70,6 +73,7 @@ public MapleMapItem(int meso, Point position, MapleMapObject dropper, MapleChara\n \tthis.dropper = dropper;\n \tthis.character_ownerid = owner.getId();\n         this.party_ownerid = owner.getPartyId();\n+        this.partyDrop = this.party_ownerid != -1;\n         this.ownerClient = owner.getClient();\n         this.meso = meso;\n \tthis.type = type;\n@@ -105,6 +109,20 @@ public final void setPartyOwnerId(int partyid) {\n         party_ownerid = partyid;\n     }\n     \n+    public final int getClientsideOwnerId(MapleCharacter player) {\n+        if (this.party_ownerid == -1) {\n+            return this.character_ownerid;\n+        } else {\n+            if (!partyDrop && player.getId() == this.character_ownerid) {\n+                return player.getId();\n+            } else if (player.getPartyId() == this.party_ownerid) {\n+                return player.getId();\n+            } else {\n+                return this.party_ownerid;\n+            }\n+        }\n+    }\n+    \n     public final boolean isFFADrop() {\n         return type == 2 || type == 3 || hasExpiredOwnershipTime();\n     }\n@@ -187,7 +205,7 @@ public void sendSpawnData(final MapleClient client) {\n \tif (chr.needQuestItem(questid, getItemId())) {\n \t    this.lockItem();\n             try {\n-                client.announce(MaplePacketCreator.dropItemFromMapObject(chr.getParty() != null, this, null, getPosition(), (byte) 2));\n+                client.announce(MaplePacketCreator.dropItemFromMapObject(chr, this, null, getPosition(), (byte) 2));\n             } finally {\n                 this.unlockItem();\n             }"}, {"sha": "e231aafdd6f46d77da1ca417d6408a3d3242f529", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 27, "deletions": 8, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -1668,17 +1668,15 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 mplew.writeBool(white);\n                 mplew.writeInt(gain);\n                 mplew.writeBool(inChat);\n-                mplew.writeInt(0); // monster book bonus (Bonus Event Exp)\n+                mplew.writeInt(0); // bonus event exp\n                 mplew.write(0); // third monster kill event\n                 mplew.write(0); // RIP byte, this is always a 0\n                 mplew.writeInt(0); //wedding bonus\n                 if (inChat) { // quest bonus rate stuff\n                         mplew.write(0);\n                 }\n \n-                int mod = ServerConstants.PARTY_EXPERIENCE_MOD != 1 ? ServerConstants.PARTY_EXPERIENCE_MOD * 100 : 0;\n-\n-                mplew.write(mod); //0 = party bonus, 100 = 1x Bonus EXP, 200 = 2x Bonus EXP\n+                mplew.write(0); //0 = party bonus, 100 = 1x Bonus EXP, 200 = 2x Bonus EXP\n                 mplew.writeInt(party); // party bonus \n                 mplew.writeInt(equip); //equip bonus\n                 mplew.writeInt(0); //Internet Cafe Bonus\n@@ -1808,15 +1806,15 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] dropItemFromMapObject(boolean recvrInParty, MapleMapItem drop, Point dropfrom, Point dropto, byte mod) {\n+        public static byte[] dropItemFromMapObject(MapleCharacter player, MapleMapItem drop, Point dropfrom, Point dropto, byte mod) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.DROP_ITEM_FROM_MAPOBJECT.getValue());\n                 mplew.write(mod);\n                 mplew.writeInt(drop.getObjectId());\n                 mplew.writeBool(drop.getMeso() > 0); // 1 mesos, 0 item, 2 and above all item meso bag,\n                 mplew.writeInt(drop.getItemId()); // drop object ID\n-                mplew.writeInt(!drop.isFFADrop() ? (recvrInParty ? drop.getPartyOwnerId() : drop.getOwnerId()) : 0); // owner charid/partyid :)\n-                mplew.write(drop.getDropType()); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA\n+                mplew.writeInt(drop.getClientsideOwnerId(player)); // owner charid/partyid :)\n+                mplew.write(!drop.hasExpiredOwnershipTime() ? drop.getDropType() : 2); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA\n                 mplew.writePos(dropto);\n                 mplew.writeInt(drop.getDropper().getObjectId()); // dropper oid, found thanks to Li Jixue\n \n@@ -6759,7 +6757,28 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n \n                 return mplew.getPacket();\n         }\n+        \n+        // Cash Shop Surprise packets found thanks to Arnah (Vertisy)\n+        public static byte[] onCashItemGachaponOpenFailed(){\n+\t\tMaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+\t\tmplew.writeShort(SendOpcode.CASHSHOP_CASH_ITEM_GACHAPON_RESULT.getValue());\n+\t\tmplew.write(189);\n+\t\treturn mplew.getPacket();\n+\t}\n \n+\tpublic static byte[] onCashGachaponOpenSuccess(int accountid, long sn, int remainingBoxes, Item item, int itemid, int nSelectedItemCount, boolean bJackpot){\n+\t\tMaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+\t\tmplew.writeShort(SendOpcode.CASHSHOP_CASH_ITEM_GACHAPON_RESULT.getValue());\n+\t\tmplew.write(190);\n+\t\tmplew.writeLong(sn);// sn of the box used\n+\t\tmplew.writeInt(remainingBoxes);\n+\t\taddCashItemInformation(mplew, item, accountid);\n+\t\tmplew.writeInt(itemid);// the itemid of the liSN?\n+\t\tmplew.write(nSelectedItemCount);// the total count now? o.O\n+\t\tmplew.writeBool(bJackpot);// \"CashGachaponJackpot\"\n+\t\treturn mplew.getPacket();\n+\t}\n+        \n         private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, MapleGuild guild) {\n                 mplew.writeInt(guild.getId());\n                 mplew.writeMapleAsciiString(guild.getName());\n@@ -7495,7 +7514,7 @@ public static void addCashItemInformation(final MaplePacketLittleEndianWriter mp\n \n                 return mplew.getPacket();\n         }\n-\n+        \n         /*\n          * 00 = Due to an unknown error, failed\n          * A4 = Due to an unknown error, failed + warpout"}, {"sha": "1ad0c2a9750ac93a5f92dd6dae0114e7b4d9324b", "filename": "wz/Map.wz/Map/Map0/001010400.img.xml", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Map.wz/Map/Map0/001010400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Map.wz/Map/Map0/001010400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map0/001010400.img.xml?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -103,7 +103,7 @@\n   <imgdir name=\"life\">\n     <imgdir name=\"0\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-374\"/>\n       <int name=\"y\" value=\"-760\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -116,7 +116,7 @@\n     </imgdir>\n     <imgdir name=\"1\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-172\"/>\n       <int name=\"y\" value=\"-764\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -129,7 +129,7 @@\n     </imgdir>\n     <imgdir name=\"2\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"25\"/>\n       <int name=\"y\" value=\"-759\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -142,7 +142,7 @@\n     </imgdir>\n     <imgdir name=\"3\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"211\"/>\n       <int name=\"y\" value=\"-768\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -155,7 +155,7 @@\n     </imgdir>\n     <imgdir name=\"4\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"377\"/>\n       <int name=\"y\" value=\"-756\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -168,7 +168,7 @@\n     </imgdir>\n     <imgdir name=\"5\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"322\"/>\n       <int name=\"y\" value=\"-1111\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -181,7 +181,7 @@\n     </imgdir>\n     <imgdir name=\"6\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"458\"/>\n       <int name=\"y\" value=\"-1119\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -194,7 +194,7 @@\n     </imgdir>\n     <imgdir name=\"7\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"98\"/>\n       <int name=\"y\" value=\"-1064\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -207,7 +207,7 @@\n     </imgdir>\n     <imgdir name=\"8\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-41\"/>\n       <int name=\"y\" value=\"-1062\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -220,7 +220,7 @@\n     </imgdir>\n     <imgdir name=\"9\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-132\"/>\n       <int name=\"y\" value=\"-1241\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -233,7 +233,7 @@\n     </imgdir>\n     <imgdir name=\"10\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-280\"/>\n       <int name=\"y\" value=\"-1242\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -246,7 +246,7 @@\n     </imgdir>\n     <imgdir name=\"11\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"9300274\"/>\n+      <string name=\"id\" value=\"9500102\"/>\n       <int name=\"x\" value=\"-332\"/>\n       <int name=\"y\" value=\"-995\"/>\n       <int name=\"mobTime\" value=\"0\"/>"}, {"sha": "c654dabc566b0203f8f0d4efb0d74b634b072189", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -8339,7 +8339,7 @@\n       <int name=\"npc\" value=\"12100\"/>\n       <imgdir name=\"mob\">\n         <imgdir name=\"0\">\n-          <int name=\"id\" value=\"9300274\"/>\n+          <int name=\"id\" value=\"9500102\"/>\n           <int name=\"count\" value=\"2\"/>\n         </imgdir>\n       </imgdir>"}, {"sha": "4bf2cd8705333e07030f099b5178269695549f1c", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -2541,8 +2541,8 @@\n     <string name=\"name\" value=\"Mai&apos;s Last Training\"/>\n     <string name=\"parent\" value=\"Mai&apos;s Training!\"/>\n     <int name=\"order\" value=\"4\"/>\n-    <string name=\"1\" value=\"I defeated the Slimes and brought back the Squishy Liquid to Mai. She seemed to be impressed, and instructed me this time to hunt a really powerful monster. She then told me to hunt #r2 Cynical Orange Mushrooms#k.\\n\\nCynical Orange Mushroom #r#a10441##k\"/>\n-    <string name=\"2\" value=\"I was able to defeat 2 Cynical Orange Mushrooms and reported the result to Mai.\"/>\n+    <string name=\"1\" value=\"I defeated the Slimes and brought back the Squishy Liquid to Mai. She seemed to be impressed, and instructed me this time to hunt a really powerful monster. She then told me to hunt #r2 Orange Mushrooms#k.\\n\\nOrange Mushroom #r#a10441##k\"/>\n+    <string name=\"2\" value=\"I was able to defeat 2 Orange Mushrooms and reported the result to Mai.\"/>\n     <int name=\"area\" value=\"20\"/>\n   </imgdir>\n   <imgdir name=\"10440\">"}, {"sha": "93d550fc3d723d72b662e8704391b7d4aea912d1", "filename": "wz/Quest.wz/Say.img.xml", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/Say.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a15713dfa2b4fd7c05f683c4a766f78a07da3267/wz/Quest.wz/Say.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Say.img.xml?ref=a15713dfa2b4fd7c05f683c4a766f78a07da3267", "patch": "@@ -4503,22 +4503,21 @@\n     <imgdir name=\"0\">\n       <string name=\"0\" value=\"Oh wow! You really brought me Squishy Liquid from the Slime. You&apos;re doing much better than I expected. I think... you&apos;re now ready to take on a really challenging monster.\"/>\n       <imgdir name=\"yes\">\n-        <string name=\"0\" value=\"Alright, this time, you&apos;ll need to take on #r2 Cynical Orange Mushrooms#k. They are pretty tough and powerful, but thankfully they aren&apos;t the Blue Mushrooms you&apos;ll find at Victoria Island. They are basically regular Orange Mushrooms, so if you focus on the combat, you should be able to handle those two.\"/>\n+        <string name=\"0\" value=\"So, reports of late shows up a growth on masses of Orange Mushrooms around. Your job, as an aspiring Explorer, is to help us cutting out #r2 Orange Mushrooms#k. They are pretty tough and powerful, but don&apos;t take so much fear from this fact! If you trust in your abilities and focus on the combat, you should be able to handle those two handily.\"/>\n       </imgdir>\n       <imgdir name=\"no\">\n         <string name=\"0\" value=\"Hmmm... did I really scare you? Don&apos;t worry. If you are persistent, you&apos;ll be able to handle those two. I won&apos;t make you hunt monsters that you can&apos;t handle, you know.\"/>\n       </imgdir>\n-      <string name=\"1\" value=\"So, reports of late shows up a growth on masses of distempered Orange Mushrooms around. Some explorers seems to not get their job done after they started engaging combat. That has been making some Orange Mushrooms rather... uhh, cynical... towards us humans... \"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"0\" value=\"So you did defeat 2 Cynical Orange Mushrooms. That&apos;s incredible! Seriously, you&apos;re doing much better than I ever thought possible! You may be just a beginner, but I have a feeling that you&apos;ll one day become a legendary hero in Maple World.\"/>\n+      <string name=\"0\" value=\"So you did defeat 2 Orange Mushrooms. That&apos;s incredible! Seriously, you&apos;re doing much better than I ever thought possible! You may be just a beginner, but I have a feeling that you&apos;ll one day become a legendary hero in Maple World.\"/>\n       <imgdir name=\"yes\">\n         <string name=\"0\" value=\"The training is now complete. You may still have some weaknesses here and there, but you&apos;ll be able to overcome that in no time. Keep training!\"/>\n         <string name=\"1\" value=\"Oh, and I have one last #btest#k for you. Think of it as a final exam. If you aren&apos;t satisfied with your current skill level and want to push further, then meet #bBari#k, who will have a test in store for you.\"/>\n       </imgdir>\n       <imgdir name=\"stop\">\n         <imgdir name=\"mob\">\n-          <string name=\"0\" value=\"I don&apos;t think you&apos;ve slayed #r2 Cynical Orange Mushrooms#k yet. Please take care of both, then let me know of the results.\"/>\n+          <string name=\"0\" value=\"I don&apos;t think you&apos;ve slayed #r2 Orange Mushrooms#k yet. Please take care of both, then let me know of the results.\"/>\n         </imgdir>\n       </imgdir>\n     </imgdir>"}]}]},
