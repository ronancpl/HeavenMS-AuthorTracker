{"fetchDate": "2019-12-19", "content": [{"sha": "618d53c7078797ff926ddacd4762a7503a69db42", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NjE4ZDUzYzcwNzg3OTdmZjkyNmRkYWNkNDc2MmE3NTAzYTY5ZGI0Mg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-05-03T19:05:54Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-05-03T19:05:54Z"}, "message": "MoveLifeHandler & Puppets disrupting mobbuffs patch\n\nCleared an issue presented recently that would try to \"apply a mobskill\" when it should be doing a routine check, this resulting on the mob skill not being usable at all (since it'd be in cooldown).\nFixed an issue on where casting puppets on the field would disrupt current mob buffs for the caster bowman.", "tree": {"sha": "13c1ed064027e570cc63d2772ac0771913950ee8", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/13c1ed064027e570cc63d2772ac0771913950ee8"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/618d53c7078797ff926ddacd4762a7503a69db42", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/618d53c7078797ff926ddacd4762a7503a69db42", "html_url": "https://github.com/ronancpl/HeavenMS/commit/618d53c7078797ff926ddacd4762a7503a69db42", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/618d53c7078797ff926ddacd4762a7503a69db42/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "383495a7e91ca85f6dc0c506506ce7a1ec144943", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/383495a7e91ca85f6dc0c506506ce7a1ec144943", "html_url": "https://github.com/ronancpl/HeavenMS/commit/383495a7e91ca85f6dc0c506506ce7a1ec144943"}], "stats": {"total": 40, "additions": 25, "deletions": 15}, "files": [{"sha": "135190d9f88e4ade981d84a998d055e29ff78c9e", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/618d53c7078797ff926ddacd4762a7503a69db42/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/618d53c7078797ff926ddacd4762a7503a69db42/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=618d53c7078797ff926ddacd4762a7503a69db42", "patch": "@@ -1847,4 +1847,6 @@ Corrigido caso de XML parser em MapleSkillBookInformationParser n\u00e3o lidando com\n Corrigido jogadores podendo explorar mec\u00e2nica de checagem de match, n\u00e3o respondendo ao match e sendo permitido se registrar em um novo sem ter respondido ao anterior.\n Corrigido caso de dupe com itens ao serem colocados no storage.\n Adicionado sistema de \"qualquer NPC script\u00e1vel\", com apoio do GabrielSin.\n-Adicionado server flag para checagem de IP's ao logar jogadores.\n\\ No newline at end of file\n+Adicionado server flag para checagem de IP's ao logar jogadores.\n+Corrigido mobskills n\u00e3o sendo devidamente aplicados devido a um deslize anterior que tentaria aplicar indevidamente 2x \"uso de skill\" (uma das vezes deveria ser somente checagem de rotina).\n+Corrigido puppets de arqueiros interrompendo mob statuses para o dono ao serem lan\u00e7ados em campo.\n\\ No newline at end of file"}, {"sha": "727859343d30a7b6fde010ee4664f87bb9f4f318", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/618d53c7078797ff926ddacd4762a7503a69db42/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/618d53c7078797ff926ddacd4762a7503a69db42/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=618d53c7078797ff926ddacd4762a7503a69db42", "patch": "@@ -95,7 +95,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         if (castPos != -1) {\n                                 toUse = MobSkillFactory.getMobSkill(useSkillId, useSkillLevel);\n                                 \n-                                if (monster.canUseSkill(toUse)) {\n+                                if (monster.canUseSkill(toUse, true)) {\n                                         int animationTime = MapleMonsterInformationProvider.getInstance().getMobSkillAnimationTime(toUse);\n                                         if(animationTime > 0 && toUse.getSkillId() != 129) {\n                                                 toUse.applyDelayedEffect(player, monster, true, animationTime);\n@@ -126,7 +126,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 nextSkillLevel = skillToUse.getRight();\n                                 nextUse = MobSkillFactory.getMobSkill(nextSkillId, nextSkillLevel);\n                                 \n-                                if (!(nextUse != null && monster.canUseSkill(nextUse) && nextUse.getHP() >= (int) (((float) monster.getHp() / monster.getMaxHp()) * 100) && mobMp >= nextUse.getMpCon())) {\n+                                if (!(nextUse != null && monster.canUseSkill(nextUse, false) && nextUse.getHP() >= (int) (((float) monster.getHp() / monster.getMaxHp()) * 100) && mobMp >= nextUse.getMpCon())) {\n                                         // thanks OishiiKawaiiDesu for noticing mobs trying to cast skills they are not supposed to be able\n                                         \n                                         nextSkillId = 0;"}, {"sha": "c0ecb38537ff20fd864a45612635399f0854dec3", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 20, "deletions": 12, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/618d53c7078797ff926ddacd4762a7503a69db42/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/618d53c7078797ff926ddacd4762a7503a69db42/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=618d53c7078797ff926ddacd4762a7503a69db42", "patch": "@@ -964,6 +964,19 @@ public boolean hasBossHPBar() {\n         return isBoss() && getTagColor() > 0;\n     }\n     \n+    public void announceMonsterStatus(MapleClient client) {\n+        statiLock.lock();\n+        try {\n+            if (stati.size() > 0) {\n+                for (final MonsterStatusEffect mse : this.stati.values()) {\n+                    client.announce(MaplePacketCreator.applyMonsterStatus(getObjectId(), mse, null));\n+                }\n+            }\n+        } finally {\n+            statiLock.unlock();\n+        }\n+    }\n+    \n     @Override\n     public void sendSpawnData(MapleClient client) {\n         if (hp.get() <= 0) { // mustn't monsterLock this function\n@@ -975,16 +988,7 @@ public void sendSpawnData(MapleClient client) {\n             client.announce(MaplePacketCreator.spawnMonster(this, false));\n         }\n         \n-        statiLock.lock();\n-        try {\n-            if (stati.size() > 0) {\n-                for (final MonsterStatusEffect mse : this.stati.values()) {\n-                    client.announce(MaplePacketCreator.applyMonsterStatus(getObjectId(), mse, null));\n-                }\n-            }\n-        } finally {\n-            statiLock.unlock();\n-        }\n+        announceMonsterStatus(client);\n         \n         if (hasBossHPBar()) {\n             client.announceBossHpBar(this, this.hashCode(), makeBossHPBarPacket());\n@@ -1395,7 +1399,7 @@ public int getSkillPos(int skillId, int level) {\n         return -1;\n     }\n     \n-    public boolean canUseSkill(MobSkill toUse) {\n+    public boolean canUseSkill(MobSkill toUse, boolean apply) {\n         if (toUse == null) {\n             return false;\n         }\n@@ -1426,7 +1430,9 @@ public boolean canUseSkill(MobSkill toUse) {\n             }\n             */\n             \n-            this.usedSkill(toUse);\n+            if (apply) {\n+                this.usedSkill(toUse);\n+            }\n         } finally {\n             monsterLock.unlock();\n         }\n@@ -2072,8 +2078,10 @@ private void aggroRefreshPuppetVisibility(MapleCharacter chrController, MapleSum\n         }\n         chrController.announce(MaplePacketCreator.removeSummon(puppet, false));\n         \n+        MapleClient c = chrController.getClient();\n         for (MapleMonster mob : puppetControlled) {\n             chrController.announce(MaplePacketCreator.controlMonster(mob, false, mob.isControllerHasAggro()));\n+            mob.announceMonsterStatus(c);   // thanks BHB for noticing puppets disrupting mobstatuses for bowmans\n         }\n         chrController.announce(MaplePacketCreator.spawnSummon(puppet, false));\n     }"}]}]},
