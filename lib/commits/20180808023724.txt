{"fetchDate": "2019-12-19", "content": [{"sha": "4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NGMyNWMwN2UyOGEwYjA5NWU0NzA5YmVmMzRhMTRkYjdjMGZhM2VhYQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-08-08T02:37:24Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-08-08T02:37:24Z"}, "message": "Mystic Doors review + Togglable SrvMessage-BossHP + Map-Event patch\n\nReviewed Mystic Doors.\nFixed several issues showing up on Duey in uncommon scenarios.\nFixed a concurrency issue with XMLDomMapleData.\nScheduled forward the \"lock disposal\" action within the source. Now, it's expected that, after a set while, no method should require usage of a disposed lock and, during that while, a supposed \"disposed lock\" is still available to run (although no new processes is expected to require use of these locks).\nFixed concurrency issues with player's current event instance, generating several inconsistencies when swiftly registering/unregistering from events.\nImplemented a mutually exclusive approach for server message - Boss HPbar.\nFixed item-making Kage requiring lv71~80 ETC instead of the expected 81~90.\nRemoved the possibility to buy cosmetic coupons with mesos through the NPCs.\nSleepywood JQ's no longer gives cash items when they finish the quest repeatedly.\nAdded Duey trucks in several maps lacking it. Added NPC Duey in New Leaf City.\nFixed scripted quests not calculating QUEST_RATE (if applied) when rewarding experience and meso.", "tree": {"sha": "8b7c7444dd8d8835acf985cf38f3a97e44c7f425", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/8b7c7444dd8d8835acf985cf38f3a97e44c7f425"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "html_url": "https://github.com/ronancpl/HeavenMS/commit/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc541f39d571673c813ce1bed180f1575caacd60", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/cc541f39d571673c813ce1bed180f1575caacd60", "html_url": "https://github.com/ronancpl/HeavenMS/commit/cc541f39d571673c813ce1bed180f1575caacd60"}], "stats": {"total": 60864, "additions": 30837, "deletions": 30027}, "files": [{"sha": "fbc84a16c60ff6c643f19909e41441453f9ed6f0", "filename": "docs/feature_list.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -101,6 +101,7 @@ Monsters, Maps & Reactors:\n * Implemented Zombify disease status.\n * Added Boss HP Bar for dozens of bosses (needs provided custom wz).\n * If multiple bosses are on the same area, client will prioritize Boss HP bar of the target of the player.\n+* Boss HP Bar and Server Messages now toggles (server message disappears when a boss battle is detected, and returns afterwards). Idea thanks to GabrielSin.\n * Improved map bounding checks for item drop points, assuring most of the items dropped will be available to pickup inside the accessible map area.\n * Boats, elevator and other travelling mechanics fully working.\n * HP decreasing overtime on maps and mechanics to prevent them (consumables, equips) fully functional.\n@@ -132,7 +133,7 @@ Player potentials:\n Server potentials:\n \n * Multi-worlds.\n-* Dynamic World/Channel deployment.\n+* Dynamic World/Channel deployment. While not implemented here, new channel deployment sensitive to quantity of online players was originally resinate's idea.\n * Inventory auto-gather and auto-sorting feature.\n * Enhanced auto-pot system: pet uses as many potions as necessary to reach the desired threshold.\n * Enhanced buff system: smartly checks for the best available buff effects to be active on the player."}, {"sha": "6e87a5eab82a95bdac0632842a02e05f2de8a2f7", "filename": "docs/issues.txt", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -13,6 +13,7 @@ Known issues:\n - Sometimes battleship may behave oddly with the enhanced buff system, making the character d/c in certain scenarios.\n - Dragon Roar doesn't show the stun effect to players.\n - Some monster status such as freeze and weapon/magic reflect doesn't behave properly in certain scenarios. Freeze seems to not work on mobs with low OID or are starters from server boot time.\n+- On low-end connections, things such as command summoning a player that is currently logging in (already visible to other players) may cause the player to freeze, consequently freezing the account as well since the server-side disconnection doesn't happen.\n ---------------------------\n \n ---------------------------\n@@ -21,6 +22,7 @@ Missing features list:\n - Change name/World transfer.\n - Some pirate skills doesn't work for 3rd parties.\n - Cache frequently used SQL data.\n+- Pet commands are not being propagated to 3rd parties, and the commandResponse packet function seems somewhat wonky.\n ---------------------------\n \n "}, {"sha": "c81cf81d0620d9078364206b45e323382e9eb2c6", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -1194,4 +1194,36 @@ Melhorado desempenho do HealOvertimeHandler por fazendo buscar informa\u00e7\u00e3o de m\n Corrigido comando \"maxhpmp\" permitindo efetivar valores negativos ao alvo.\n Corrigido Duey n\u00e3o registrando n\u00edvel e experi\u00eancia de equipamentos ao envi\u00e1-los.\n Buff no buyback: por um curto per\u00edodo ap\u00f3s respawnar o jogador n\u00e3o morre (m\u00ednimo 1 HP), assim permitindo um tempo m\u00ednimo de rea\u00e7\u00e3o.\n-Revisado task do item monitor em MapleMap mal-protegido contra acessos concorrentes.\n\\ No newline at end of file\n+Revisado task do item monitor em MapleMap mal-protegido contra acessos concorrentes.\n+\n+28 - 30 Julho 2018,\n+Revisado v\u00e1rios problemas com Mystic Doors.\n+Corrigido alguns acessos a nulos no Duey.\n+Corrigido erro com XMLDomMapleData em casos onde m\u00faltiplos processos tentam ler dados simultaneamente.\n+Revisado v\u00e1rios casos de \"lock sem unlock\" ocorrendo em casos onde o objeto no qual tal lock est\u00e1 acoplado j\u00e1 teve seus locks liberados.\n+Corrigido falta de prote\u00e7\u00e3o contra registro concorrente de event instances no objeto que representa o jogador.\n+Corrigido jogadores n\u00e3o sendo rapidamente removidos de um evento no momento do dispose deste evento, gerando diversas inconsist\u00eancias ao trocar de mapa pra fora do evento.\n+\n+31 Julho 2018,\n+Corrigido v\u00e1rios casos de nulos na fase de login perante a nova abordagem din\u00e2mica de canais e mundos.\n+Corrigido worker de playershops/hiredmerchs n\u00e3o ativado.\n+Implementado melhoria para o sistema de server messages/boss HP bar, agora com atua\u00e7\u00e3o mutuamente exclusiva.\n+Implementado mostrar novamente server messages (com boss HPbar ao fundo) para casos onde algum tempo se passou sem o cliente trocar ataques com o boss, nesse caso voltando a mensagem do server.\n+Revisado sistema de encerramento de locks por todo o server. Colocado locks para serem devidamente liberados minutos ap\u00f3s a finaliza\u00e7\u00e3o das estruturas, permitindo assim um tempo extra onde processos possam usar esses locks sem gerar conflitos de acesso concorrente.\n+\n+01 Agosto 2018,\n+Corrigido um mapa de mushking empire levando jogador a um portal inexistente, levando o server a inserir o jogador no mapa por um portal default.\n+Corrigido Kage (Item Maker) precisando de cristais n\u00edvel 71~80 ao inv\u00e9s de 81~90.\n+Removido possibilidade de comprar cosm\u00e9ticos por mesos pelos NPCs. Espera-se coupons somente dispon\u00edvel pelo Cash Shop.\n+Corrigido NPC's da JQ de Sleepywood dando itens de cash aos jogadores em casos onde eles completam a JQ sem ter a quest ativa.\n+Corrigido comando \"fly\" ainda n\u00e3o atuando corretamente. Com a busca de informa\u00e7\u00e3o de GMlevel vindo mais cedo, o pacote de autentica\u00e7\u00e3o agora informa o cliente de seu GMlevel devidamente.\n+Colocado comandos de adicionar/remover canais/mundos para rodar em uma nova thread, eliminando assim o GM de ter que esperar para realizar pr\u00f3ximas a\u00e7\u00f5es.\n+Corrigido alguns mapas com o NPC Duey sem caminh\u00e3o caracter\u00edstico ao fundo. Adicionado Duey em New Leaf City.\n+Corrigido quests scriptadas bypassando flags de QUEST_RATE ao gerir EXP e MESO aos jogadores.\n+\n+02 Agosto 2018,\n+Modificado algumas tabelas em ThreadTracker e World para usar Integer ao inv\u00e9s de Short/Byte, n\u00e3o h\u00e1 vantagens em usar tipos menores em Java para \"otimizar uso de mem\u00f3ria\", piora o desempenho geral desta forma.\n+\n+07 Agosto 2018,\n+Corrigido um bug na fase de login que nao construia corretamente overview de characters sem itens equipados, lancando excecoes posteriormente.\n+Revisado alguns casos de borda com doors levando as mesmas a nao sumirem imediatamente em certos cenarios.\n\\ No newline at end of file"}, {"sha": "cb253ffdf6697676fbd6855b51367475472d0644", "filename": "nbproject/private/private.properties", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/nbproject/private/private.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/nbproject/private/private.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.properties?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -1,10 +1,10 @@\n compile.on.save=true\n do.depend=false\n do.jar=true\n-file.reference.mina-core-2.0.7.jar=C:\\\\Nexon\\\\MapleSolaxia\\\\HeavenMS\\\\cores\\\\mina-core-2.0.7.jar\n-file.reference.mysql-connector-java-bin.jar=C:\\\\Nexon\\\\MapleSolaxia\\\\HeavenMS\\\\cores\\\\mysql-connector-java-bin.jar\n-file.reference.slf4j-api-1.6.6.jar=C:\\\\Nexon\\\\MapleSolaxia\\\\HeavenMS\\\\cores\\\\slf4j-api-1.6.6.jar\n-file.reference.slf4j-jdk14-1.7.5.jar=C:\\\\Nexon\\\\MapleSolaxia\\\\HeavenMS\\\\cores\\\\slf4j-jdk14-1.7.5.jar\n+file.reference.mina-core-2.0.7.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\mina-core-2.0.7.jar\n+file.reference.mysql-connector-java-bin.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\mysql-connector-java-bin.jar\n+file.reference.slf4j-api-1.6.6.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\slf4j-api-1.6.6.jar\n+file.reference.slf4j-jdk14-1.7.5.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\slf4j-jdk14-1.7.5.jar\n javac.debug=true\n javadoc.preview=true\n user.properties.file=C:\\\\Users\\\\USER\\\\AppData\\\\Roaming\\\\NetBeans\\\\8.0.2\\\\build.properties"}, {"sha": "09b47fe7c5e2ea1f89c5474bcc8381d9f90240d8", "filename": "scripts/event/KingPepeAndYetis.js", "status": "modified", "additions": 28, "deletions": 51, "changes": 79, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/event/KingPepeAndYetis.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/event/KingPepeAndYetis.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KingPepeAndYetis.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -2,29 +2,23 @@ var minPlayers = 1;\n var timeLimit = 20; //20 minutes\n var eventTimer = 1000 * 60 * timeLimit;\n var exitMap = 106021400;\n+var eventMap = 106021500;\n \n function init(){}\n \n function setup(difficulty, lobbyId){\n \tvar eim = em.newInstance(\"KingPepe_\" +lobbyId);\n-\teim.getInstanceMap(106021500).resetFully();\n-\teim.getInstanceMap(106021500).allowSummonState(false);\n-\trespawn(eim);\n+\teim.getInstanceMap(eventMap).resetFully();\n+\teim.getInstanceMap(eventMap).allowSummonState(false);\n+\t\n \teim.startEventTimer(eventTimer);\n \treturn eim;\n }\n \n function afterSetup(eim){}\n \n-function respawn(eim){\n-\tvar map = eim.getMapInstance(exitMap);\n-\tmap.allowSummonState(true);\n-\tmap.instanceMapRespawn();\n-\teim.schedule(\"respawn\", 10000);\n-}\n-\n function playerEntry(eim, player){\n-\tvar yetiMap = eim.getMapInstance(106021500);\n+\tvar yetiMap = eim.getMapInstance(eventMap);\n \tplayer.changeMap(yetiMap, yetiMap.getPortal(1));\n }\n \n@@ -37,46 +31,31 @@ function scheduledTimeout(eim){\n \teim.dispose();\n }\n \n-function playerRevive(eim, player){\n-\tplayer.setHp(50);\n-\tplayer.setStance(0);\n-\teim.unregisterPlayer(player);\n-\tplayer.changeMap(exitMap);\n-\treturn false;\n-}\n-\n function playerDead(eim, player){}\n \n function playerDisconnected(eim, player){\n-\tvar party = eim.getPlayers();\n-\n-\tfor(var i = 0; i < party.size(); i++){\n-\t\tif(party.get(i).equals(player))\n-\t\t\tremovePlayer(eim, player);\n-\t\telse\n-\t\t\tplayerExit(eim, party.get(i));\n-\t}\n-\teim.dispose();\n+\tif (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n function monsterValue(eim, mobId){\n \treturn -1;\n }\n \n-function leftParty(eim, player){\n-\tvar party = eim.getPlayers();\n-\n-\tif(party.size() < minPlayers){\n-\t\tfor(var i = 0; i < party.size(); i++){\n-\t\t\tplayerExit(eim, party.get(i));\n-\t\t}\n-\t\teim.dispose();\n-\t}\n-\telse{\n-\t\tplayerExit(eim, player);\n-\t}\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n }\n \n+function leftParty(eim, player){}\n+\n function disbandParty(eim){}\n \n function playerUnregistered(eim, player){}\n@@ -86,17 +65,15 @@ function playerExit(eim, player){\n \tplayer.changeMap(exitMap, 2);\n }\n \n-function moveMap(eim, player){\n-\tif(player.getMap().getId() == exitMap){\n-\t\tremovePlayer(eim, player);\n-\t\teim.dispose();\n-\t}\n-}\n-\n-function removePlayer(eim, player){\n-\teim.unregisterPlayer(player);\n-\tplayer.getMap().removePlayer(player);\n-\tplayer.setMap(exitMap);\n+function changedMap(eim, chr, mapid) {\n+        if (mapid != eventMap) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, chr)) {\n+                        eim.unregisterPlayer(chr);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(chr);\n+        }\n }\n \n function cancelSchedule(){}"}, {"sha": "5074166d7f0c3f9674f9e724eaae49ced8eed20b", "filename": "scripts/npc/1012103.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1012103.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1012103.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1012103.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -41,12 +41,9 @@ function action(mode, type, selection) {\n     } else {\n         status++;\n         if (status == 0) \n-            cm.sendSimple(\"I'm the head of this hair salon. If you have a #b#t5150001##k or a #b#t5151001##k allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150001##t5150001##l\\r\\n#L2#Dye your hair: #i5151001##t5151001##l\");\n+            cm.sendSimple(\"I'm the head of this hair salon. If you have a #b#t5150001##k or a #b#t5151001##k allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150001##t5150001##l\\r\\n#L2#Dye your hair: #i5151001##t5151001##l\");\n         else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150001##t5150001##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151001##t5151001##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0)"}, {"sha": "10b4d18e66c2db775de3934643bcb0f91b784ea5", "filename": "scripts/npc/1012104.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1012104.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1012104.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1012104.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm Brittany the assistant. If you have #b#t5150010##k or #b#t5151000##k by any chance, then how about letting me change your hairdo?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150010##t5150010##l\\r\\n#L2#Dye your hair: #i5151000##t5151000##l\");\n+            cm.sendSimple(\"I'm Brittany the assistant. If you have #b#t5150010##k or #b#t5151000##k by any chance, then how about letting me change your hairdo?\\r\\n#L1#Haircut: #i5150010##t5150010##l\\r\\n#L2#Dye your hair: #i5151000##t5151000##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150010##t5150010##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151000##t5151000##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "8e314519a671d2d6c78e1c45251ed24ef9ea29e8", "filename": "scripts/npc/1052004.js", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052004.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,17 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well, hello! Welcome to the Henesys Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152001##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5152001##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well, hello! Welcome to the Henesys Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152001##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152001, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++)"}, {"sha": "988249bc5eda5d33c9ae95bb57e10f3382285ba8", "filename": "scripts/npc/1052005.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052005.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152000##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L1#I would like to buy a #b#t5152000##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152000##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152000, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "424a4282dcb1e3ee9f5180289a761353f7505434", "filename": "scripts/npc/1052100.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052100.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hello! I'm Don Giovanni, head of the beauty salon! If you have either #b#t5150003##k or #b#t5151003##k, why don't you let me take care of the rest? Decide what you want to do with your hair...\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150003##t5150003##l\\r\\n#L2#Dye your hair: #i5151003##t5151003##l\");\n+            cm.sendSimple(\"Hello! I'm Don Giovanni, head of the beauty salon! If you have either #b#t5150003##k or #b#t5151003##k, why don't you let me take care of the rest? Decide what you want to do with your hair...\\r\\n#L1#Haircut: #i5150003##t5150003##l\\r\\n#L2#Dye your hair: #i5151003##t5151003##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150003##t5150003##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151003##t5151003##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "553236cd7a52469eac75ce538642f55946d97d17", "filename": "scripts/npc/1052101.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1052101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052101.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm Andre, Don's assistant. Everyone calls me Andre, though. If you have a #b#t5150011##k or a #b#t5151002##k, please let me change your hairdo!\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150011##t5150011##l\\r\\n#L2#Dye your hair: #i5151002##t5151002##l\");\n+            cm.sendSimple(\"I'm Andre, Don's assistant. Everyone calls me Andre, though. If you have a #b#t5150011##k or a #b#t5151002##k, please let me change your hairdo!\\r\\n#L1#Haircut: #i5150011##t5150011##l\\r\\n#L2#Dye your hair: #i5151002##t5151002##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150011##t5150011##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151002##t5151002##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "f6a447bd6fabd80090f260899ac8dbce499ba8c2", "filename": "scripts/npc/1061006.js", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1061006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1061006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061006.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -27,11 +27,11 @@ var selectedMap = -1;\n \n function start() {\n     cm.sendNext(\"You feel a mysterious force surrounding this statue.\");\n-    if (cm.isQuestStarted(2054))\n+    if (cm.isQuestStarted(2054) || cm.isQuestCompleted(2054))\n         zones = 3;\n-    else if (cm.isQuestStarted(2053))\n+    else if (cm.isQuestStarted(2053) || cm.isQuestCompleted(2053))\n         zones = 2;\n-    else if (cm.isQuestStarted(2052))\n+    else if (cm.isQuestStarted(2052) || cm.isQuestCompleted(2052))\n         zones = 1;\n     else\n         zones = 0;"}, {"sha": "ba1248310b55844b30d4609137dcda6c531a8f49", "filename": "scripts/npc/1063000.js", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1063000.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -21,29 +21,29 @@\n */\n /* John JQ Flower pile #1\n */\n+\n+var repeatablePrizes = [[4010000, 3], [4010001, 3], [4010002, 3], [4010003, 3], [4010004, 3], [4010005, 3]];\n+\n function start() {\n-    var prizes = Array(1040051, 1040127, 1040128, 1040133, 1040138, 1041000, 1041001, 1041110, 1041130, 1041139, 1042015, 1042017, 1042023, 1702001, 1702025);\n-    var chances = Array(10, 10, 10, 10, 5, 10, 10, 10, 10, 5, 8, 8, 8, 9, 7);\n-    var totalodds = 0;\n-    var choice = 0;\n-    for (var i = 0; i < chances.length; i++) {\n-        var itemGender = (Math.floor(prizes[i]/1000)%10);\n-        if ((cm.getPlayer().getGender() != itemGender) && (itemGender != 2))\n-            chances[i] = 0;\n-    }\n-    for (var i = 0; i < chances.length; i++)\n-        totalodds += chances[i];\n-    var randomPick = Math.floor(Math.random()*totalodds)+1;\n-    for (var i = 0; i < chances.length; i++) {\n-        randomPick -= chances[i];\n-        if (randomPick <= 0) {\n-            choice = i;\n-            randomPick = totalodds + 100;\n+    if (cm.isQuestStarted(2052) && !cm.haveItem(4031025,10)) {\n+        if(!cm.canHold(4031025,10)) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\");\n+            cm.dispose();\n+            return;\n         }\n-    }\n-    if (cm.isQuestStarted(2052))\n+        \n         cm.gainItem(4031025,10);\n-    else cm.gainItem(prizes[choice],1);\n+    } else {\n+        if(cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).getNumFreeSlot() < 1) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n+        var itemPrize = repeatablePrizes[Math.floor((Math.random() * repeatablePrizes.length))];\n+        cm.gainItem(itemPrize[0], itemPrize[1]);\n+    }\n+    \n     cm.warp(105040300, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "2d4f3fad09e24561027f2f5fc814b7080a032af0", "filename": "scripts/npc/1063001.js", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1063001.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -21,29 +21,29 @@\n \n /* John JQ Flower pile #2\n */\n+\n+var repeatablePrizes = [[4020000, 4], [4020002, 4], [4020006, 4]];\n+\n function start() {\n-    var prizes = Array(1060034, 1060040, 1060049, 1060113, 1060121, 1061000, 1061001, 1061073, 1061089, 1061142, 1062010, 1062020, 1702140, 1702115);\n-    var chances = Array(10, 10, 10, 10, 5, 10, 10, 10, 10, 5, 8, 8, 8, 8);\n-    var totalodds = 0;\n-    var choice = 0;\n-    for (var i = 0; i < chances.length; i++) {\n-        var itemGender = (Math.floor(prizes[i]/1000)%10);\n-        if ((cm.getPlayer().getGender() != itemGender) && (itemGender != 2))\n-            chances[i] = 0;\n-    }\n-    for (var i = 0; i < chances.length; i++)\n-        totalodds += chances[i];\n-    var randomPick = Math.floor(Math.random()*totalodds)+1;\n-    for (var i = 0; i < chances.length; i++) {\n-        randomPick -= chances[i];\n-        if (randomPick <= 0) {\n-            choice = i;\n-            randomPick = totalodds + 100;\n+    if (cm.isQuestStarted(2053) && !cm.haveItem(4031026,20)) {\n+        if(!cm.canHold(4031026,20)) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\")\n+            cm.dispose();\n+            return;\n         }\n-    }\n-    if (cm.isQuestStarted(2053))\n+        \n         cm.gainItem(4031026,20);\n-    else cm.gainItem(prizes[choice],1);\n+    } else {\n+        if(cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).getNumFreeSlot() < 1) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n+        var itemPrize = repeatablePrizes[Math.floor((Math.random() * repeatablePrizes.length))];\n+        cm.gainItem(itemPrize[0], itemPrize[1]);\n+    }\n+    \n     cm.warp(105040300, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "4b27a9bcd11f55d49658a8d76f69c3d280bc2167", "filename": "scripts/npc/1063002.js", "status": "modified", "additions": 21, "deletions": 21, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/1063002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1063002.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -19,31 +19,31 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n \n-// John JQ Flower pile #3\n+/* John JQ Flower pile #3\n+*/\n+\n+var repeatablePrizes = [[4010006, 4], [4010007, 4], [4020007, 4]];\n \n function start() {\n-    var prizes = Array(1050004, 1050015, 1050041, 1050044, 1050124, 1051021, 1051036, 1051075, 1051111, 1051138, 1052003, 1052006, 1052011, 1702024, 1702026);\n-    var chances = Array(10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 9, 9, 8, 8);\n-    var totalodds = 0;\n-    var choice = 0;\n-    for (var i = 0; i < chances.length; i++) {\n-        var itemGender = (Math.floor(prizes[i]/1000)%10);\n-        if (cm.getPlayer().getGender() != itemGender && itemGender != 2)\n-            chances[i] = 0;\n-    }\n-    for (var i = 0; i < chances.length; i++)\n-        totalodds += chances[i];\n-    var randomPick = Math.floor(Math.random()*totalodds)+1;\n-    for (var i = 0; i < chances.length; i++) {\n-        randomPick -= chances[i];\n-        if (randomPick <= 0) {\n-            choice = i;\n-            randomPick = totalodds + 100;\n+    if (cm.isQuestStarted(2054) && !cm.haveItem(4031028,30)) {\n+        if(!cm.canHold(4031028,30)) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\")\n+            cm.dispose();\n+            return;\n         }\n-    }\n-    if (cm.isQuestStarted(2054))\n+        \n         cm.gainItem(4031028,30);\n-    else cm.gainItem(prizes[choice],1);\n+    } else {\n+        if(cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).getNumFreeSlot() < 1) {\n+            cm.sendNext(\"Check for a available slot on your ETC inventory.\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n+        var itemPrize = repeatablePrizes[Math.floor((Math.random() * repeatablePrizes.length))];\n+        cm.gainItem(itemPrize[0], itemPrize[1]);\n+    }\n+    \n     cm.warp(105040300, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "6df9d450142fde185382db9bf61ccf65d0e58fe2", "filename": "scripts/npc/2010001.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2010001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2010001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2010001.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hello I'm Mino. If you have either a #b#t5150005##k or a #b#t5151005##k, then please let me take care of your hair. Choose what you want to do with it.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150005##t5150005##l\\r\\n#L2#Dye your hair: #i5151005##t5151005##l\");\n+            cm.sendSimple(\"Hello I'm Mino. If you have either a #b#t5150005##k or a #b#t5151005##k, then please let me take care of your hair. Choose what you want to do with it.\\r\\n#L1#Haircut: #i5150005##t5150005##l\\r\\n#L2#Dye your hair: #i5151005##t5151005##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150005##t5150005##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151005##t5151005##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "770c47fb051528f4cc9e5cd2d4dde1c756ed1f03", "filename": "scripts/npc/2010002.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2010002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2010002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2010002.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well well well, welcome to the Orbis Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152005##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5152005##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well well well, welcome to the Orbis Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152005##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152005, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "ae03bab004350a10d54590202ecb1305a0fb5c9f", "filename": "scripts/npc/2012007.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012007.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -31,7 +31,7 @@ var fhair = Array(31040, 31000, 31250, 31220, 31260, 31240, 31110, 31270, 31030,\n var hairnew = Array();\n \n function start() {\n-    cm.sendSimple(\"I'm Rinz, the assistant. Do you have #b#t5150013##k or #b#t5151004##k with you? If so, what do you think about letting me take care of your hairdo? What do you want to do with your hair?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150013##t5150013##l\\r\\n#L2#Dye your hair: #i5151004##t5151004##l\");\n+    cm.sendSimple(\"I'm Rinz, the assistant. Do you have #b#t5150013##k or #b#t5151004##k with you? If so, what do you think about letting me take care of your hairdo? What do you want to do with your hair?\\r\\n#L1#Haircut: #i5150013##t5150013##l\\r\\n#L2#Dye your hair: #i5151004##t5151004##l\");\n }\n \n function action(mode, type, selection) {\n@@ -40,10 +40,7 @@ function action(mode, type, selection) {\n     else {\n         status++;\n         if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150013##t5150013##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151004##t5151004##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0)"}, {"sha": "7e553d706cc04b93b83aadf402b5325a79146531", "filename": "scripts/npc/2012008.js", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012008.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -27,7 +27,7 @@ var price = 1000000;\n var skin = Array(0, 1, 2, 3, 4);\n \n function start() {\n-    cm.sendSimple(\"Well, hello! Welcome to the Orbis Skin-Care~! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153001##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5153001##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+    cm.sendSimple(\"Well, hello! Welcome to the Orbis Skin-Care~! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153001##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n }\n \n function action(mode, type, selection) {\n@@ -43,15 +43,7 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5153001, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2)\n+            if (selection == 2)\n                 cm.sendStyle(\"With our specialized machine, you can see the way you'll look after the treatment PRIOR to the procedure. What kind of a look are you looking for? Go ahead and choose the style of your liking~!\", skin);\n         }\n         else if (status == 2){"}, {"sha": "7de29684d2b1348571acba4b20a098c8f5f76860", "filename": "scripts/npc/2012009.js", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2012009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012009.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -30,7 +30,7 @@ var fface = Array(21000, 21001, 21002, 21003, 21004, 21005, 21006, 21007, 21008,\n var facenew = Array();\n \n function start() {\n-    cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152004##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L1#I would like to buy a #b#t5152004##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+    cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152004##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L2#I already have a Coupon!#l\");\n }\n \n function action(mode, type, selection) {\n@@ -39,15 +39,7 @@ function action(mode, type, selection) {\n     } else {\n         status++;\n         if (status == 1) {\n-            if (selection == 1) {\n-                if (cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152004, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0)\n                     for (var i = 0; i < mface.length; i++)\n@@ -59,13 +51,15 @@ function action(mode, type, selection) {\n             }\n         }\n         else if (status == 2){\n-            cm.dispose();\n             if (cm.haveItem(5152004)){\n                 cm.gainItem(5152004, -1);\n                 cm.setFace(facenew[Math.floor(Math.random() * facenew.length)]);\n                 cm.sendOk(\"Enjoy your new and improved face!\");\n-            } else\n+            } else {\n                 cm.sendOk(\"Hmm ... it looks like you don't have the coupon specifically for this place. Sorry to say this, but without the coupon, there's no plastic surgery for you...\");\n+            }\n+            \n+            cm.dispose();\n         }\n     }\n }"}, {"sha": "33ff4935edd042ce4a6277a1ab85780248752092", "filename": "scripts/npc/2040019.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2040019.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2040019.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040019.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well, I'm bored, so I'll help out the doctor. For a #b#t5152006##k, I will change the way you look. But don't forget, it will be random!\\r\\n#L1#I would like to buy a #b#t5152006##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well, I'm bored, so I'll help out the doctor. For a #b#t5152006##k, I will change the way you look. But don't forget, it will be random!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152006, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "a30220a0e31553b2a7ba04837b93cd2da8fd1884", "filename": "scripts/npc/2041007.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041007.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Welcome, welcome, welcome to the Ludibrium Hair Salon! Do you, by any chance, have a #b#t5150007##k or a #b#t5151007##k? If so, how about letting me take care of your hair? Please choose what you want to do with it...\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150007##t5150007##l\\r\\n#L2#Dye your hair: #i5151007##t5151007##l\");\n+            cm.sendSimple(\"Welcome, welcome, welcome to the Ludibrium Hair Salon! Do you, by any chance, have a #b#t5150007##k or a #b#t5151007##k? If so, how about letting me take care of your hair? Please choose what you want to do with it...\\r\\n#L1#Haircut: #i5150007##t5150007##l\\r\\n#L2#Dye your hair: #i5151007##t5151007##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150007##t5150007##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151007##t5151007##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "6d58b1ee0a03b779b3c776c9e47c21808c463f16", "filename": "scripts/npc/2041009.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041009.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hi, I'm the assistant here. Don't worry, I'm plenty good enough for this. If you have #b#t5150012##k or #b#t5151006##k by any chance, then allow me to take care of the rest, alright?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150012##t5150012##l\\r\\n#L2#Dye your hair: #i5151006##t5151006##l\");\n+            cm.sendSimple(\"Hi, I'm the assistant here. Don't worry, I'm plenty good enough for this. If you have #b#t5150012##k or #b#t5151006##k by any chance, then allow me to take care of the rest, alright?\\r\\n#L1#Haircut: #i5150012##t5150012##l\\r\\n#L2#Dye your hair: #i5151006##t5151006##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150012##t5150012##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151006##t5151006##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "85c2a18ba2c48a36e4d2e2ce9b2b5925c22ea57e", "filename": "scripts/npc/2041010.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041010.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well, hello! Welcome to the Ludibrium Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152007##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5152007##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well, hello! Welcome to the Ludibrium Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152007##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152007, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "cbbeb8e313974295636f1dfa8a9357e510db3f67", "filename": "scripts/npc/2041013.js", "status": "modified", "additions": 3, "deletions": 12, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2041013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041013.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -41,18 +41,9 @@ function action(mode, type, selection) {\n \t\telse\n \t\t\tstatus--;\n \t\tif (status == 0) {\n-\t\t\tcm.sendSimple(\"Oh, hello! Welcome to the Ludibrium Skin-Care! Are you interested in getting tanned and looking sexy? How about a beautiful, snow-white skin? If you have #b#t5153002##k, you can let us take care of the rest and have the kind of skin you've always dreamed of!\\r\\n#L1#I would like to buy a #b#t5153002##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n-\t\t\t} else if (status == 1) {\n-\t\t\tif (selection == 1) {\n-\t\t\t\tif(cm.getMeso() >= price) {\n-\t\t\t\t\tcm.gainMeso(-price);\n-\t\t\t\t\tcm.gainItem(5153002, 1);\n-\t\t\t\t\tcm.sendOk(\"Enjoy!\");\n-\t\t\t\t} else {\n-\t\t\t\t\tcm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-\t\t\t\t}\n-\t\t\t\tcm.dispose();\n-\t\t\t} else if (selection == 2) {\n+\t\t\tcm.sendSimple(\"Oh, hello! Welcome to the Ludibrium Skin-Care! Are you interested in getting tanned and looking sexy? How about a beautiful, snow-white skin? If you have #b#t5153002##k, you can let us take care of the rest and have the kind of skin you've always dreamed of!\\r\\n#L2#I already have a Coupon!#l\");\n+                } else if (status == 1) {\n+\t\t\tif (selection == 2) {\n \t\t\t\tcm.sendStyle(\"With our specialized machine, you can see the way you'll look after the treatment PRIOR to the procedure. What kind of a look are you looking for? Go ahead and choose the style of your liking~!\", skin);\n \t\t\t}\n \t\t}"}, {"sha": "b26fd890172416b80c73ff4a78987698aea588fa", "filename": "scripts/npc/2090100.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090100.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -31,7 +31,7 @@ var fhair = Array(31040, 31250, 31310, 31220, 31300, 31680, 31160, 31030, 31230)\n var hairnew = Array();\n \n function start() {\n-    cm.sendSimple(\"Welcome to the Mu Lung hair shop. If you have a #b#t5150025##k, or a #b#t5151020##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150025##t5150025##l\\r\\n#L2#Dye your hair: #i5151020##t5151020##l\");\n+    cm.sendSimple(\"Welcome to the Mu Lung hair shop. If you have a #b#t5150025##k, or a #b#t5151020##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150025##t5150025##l\\r\\n#L2#Dye your hair: #i5151020##t5151020##l\");\n }\n \n function action(mode, type, selection) {\n@@ -47,10 +47,7 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150025##t5150025##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151020##t5151020##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "ed794588b8dbd92aa50f3c735336abb88a5bbbe9", "filename": "scripts/npc/2090101.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090101.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm a hair assistant in this shop. If you have #b#t5150024##k or #b#t5151019##k by any chance, then how about letting me change your hairdo?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150024##t5150024##l\\r\\n#L2#Dye your hair: #i5151019##t5151019##l\");\n+            cm.sendSimple(\"I'm a hair assistant in this shop. If you have #b#t5150024##k or #b#t5151019##k by any chance, then how about letting me change your hairdo?\\r\\n#L1#Haircut: #i5150024##t5150024##l\\r\\n#L2#Dye your hair: #i5151019##t5151019##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150024##t5150024##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151019##t5151019##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "346b48ff477a8ef3251c3d08934efcc6ccbe3c5a", "filename": "scripts/npc/2090102.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090102.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090102.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090102.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,18 +44,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well, hello! Welcome to the Mu Lung Skin-Care! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153006##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5153006##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well, hello! Welcome to the Mu Lung Skin-Care! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153006##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5153006, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 cm.sendStyle(\"With our specialized machine, you can see the way you'll look after the treatment PRIOR to the procedure. What kind of a look are you looking for? Go ahead and choose the style of your liking~!\", skin);\n             }\n         }"}, {"sha": "f157b7bda003c1b519d6a4b12c8f58d354fbb62b", "filename": "scripts/npc/2090103.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090103.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090103.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090103.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,12 +46,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hey, I'm Pata, and I am a cosmetic lens expert here in Mu Lung. I believe your eyes are the most important feature in your body, and with #b#t5152042##k or #b#t5152041##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Cosmetic Lenses: #i5152042##t5152042##l\\r\\n#L2#Cosmetic Lenses: #i5152041##t5152041##l\");\n+            cm.sendSimple(\"Hey, I'm Pata, and I am a cosmetic lens expert here in Mu Lung. I believe your eyes are the most important feature in your body, and with #b#t5152042##k or #b#t5152041##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to use?\\r\\n#L1#Cosmetic Lenses: #i5152042##t5152042##l\\r\\n#L2#Cosmetic Lenses: #i5152041##t5152041##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Cosmetic Lenses for \" + regprice + \" mesos: #i5152042##t5152042##l\\r\\n#L1#Cosmetic Lenses for \" + vipprice + \" mesos: #i5152041##t5152041##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace()"}, {"sha": "83a0497a933197ffde10701a28bd889bc0c76413", "filename": "scripts/npc/2090104.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090104.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/2090104.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090104.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hey, I'm Noma, and I am assiting Pata in changing faces into beautiful things here in Mu Lung. With #b#t5152027##k or #b#t5152028##k, I can change the way you look. Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Plastic Surgery: #i5152027##t5152027##l\\r\\n#L2#Plastic Surgery: #i5152028##t5152028##l\");\n+            cm.sendSimple(\"Hey, I'm Noma, and I am assiting Pata in changing faces into beautiful things here in Mu Lung. With #b#t5152027##k or #b#t5152028##k, I can change the way you look. Now, what would you like to use?\\r\\n#L1#Plastic Surgery: #i5152027##t5152027##l\\r\\n#L2#Plastic Surgery: #i5152028##t5152028##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Plastic Surgery for \" + regprice + \" mesos: #i5152027##t5152027##l\\r\\n#L1#Plastic Surgery for \" + vipprice + \" mesos: #i5152028##t5152028##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "abeb0e696a164df575c3bc31e5387353af0909cf", "filename": "scripts/npc/9000036.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9000036.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9000036.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000036.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -111,8 +111,8 @@ function action(mode, type, selection) {\n             var matQtySet = [[5,5],[5,5,5],[5,5,5,5,1],[5,5],[5,5,5],[5,5,5,5,1],[1,1],[1,1],[1,1],[1,1]];\n             var costSet = [100000,200000,300000,125000,250000,375000,500000,500000,500000,500000, 25000, 25000, 25000, 25000];\n         }else if (selectedType == 2) { //eye accessory refine\n-            var matSet = [[4001006, 4003002, 4000082, 4031203], [4000073, 4011008], [4000073, 4011008], [4000073, 4011008, 4000082], [4001006, 4003002, 4003000, 4003001]];\n-            var matQtySet = [[2, 2, 5, 10], [50, 2], [75, 3], [75, 3, 10], [2, 2, 10, 5]];\n+            var matSet = [[4001006, 4003002, 4000082, 4031203], [4001005, 4011008], [4001005, 4011008], [4001005, 4011008, 4000082], [4001006, 4003002, 4003000, 4003001]];\n+            var matQtySet = [[2, 2, 5, 10], [3, 2], [4, 3], [5, 3, 10], [2, 2, 10, 5]];\n             var costSet = [250000, 250000, 300000, 400000, 200000];\n         }else if (selectedType == 3) { //belt & medals refine\n             var matSet = [[4001006, 4003005, 4003004], [7777, 7777]];"}, {"sha": "b97c317956621a6b69247585e98262b0c2c4c921", "filename": "scripts/npc/9001108.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9001108.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9001108.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9001108.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -68,7 +68,7 @@ function action(m,t,s) {\n \t\t\t\t\tcm.sendNext(\"Welcome! I heard what happened from Baby Moon Bunny I'm glad you came since I was Planning on requesting some help. Gaga is a friend of mine who has helped me before and often stops by to say hello. Unfortunaley, he was kidnapped by aliens.\"); \n \t\t\t\t} else {\n \t\t\t\t\tselected = 2;\n-\t\t\t\t\tcm.sendYesNo(\"At the Space Mine, you can find special ores called #bKrypto Crystals#k that contain the mysterious power of space. #bKrypto Crystals#l are usually emerald in color, but will turn brown if hit with the Spaceship's #bSpace Beam#k. Remember, in order to thwart this alien conspracy, #b10 Brown Krypto Crystal's and 10 Emerald Krypto Crystal's are needed. But since even #b1 Krypto Crystal#k can be of help, brign me as many as possible. Oh, and one more thing! The Space Mines are protected by the Space Mateons. They are extemely strong due to the power of the #Krypto Crystals#k, so don't try to defeat them. Simply concentrate on quickly collecting the crystals.\"); \n+\t\t\t\t\tcm.sendYesNo(\"At the Space Mine, you can find special ores called #bKrypto Crystals#k that contains the mysterious power of space. #bKrypto Crystals#l are usually emerald in color, but will turn brown if hit with the Spaceship's #bSpace Beam#k. Remember, in order to thwart this alien conspracy, #b10 Brown Krypto Crystal's and 10 Emerald Krypto Crystal's are needed. But since even #b1 Krypto Crystal#k can be of help, brign me as many as possible. Oh, and one more thing! The Space Mines are protected by the Space Mateons. They are extemely strong due to the power of the #Krypto Crystals#k, so don't try to defeat them. Simply concentrate on quickly collecting the crystals.\"); \n \t\t\t\t} \n \t\t\t} else if (status == 2) {\n \t\t\t\tif(selected == 1) {"}, {"sha": "53aa159e583695cd57f852ff2c84364609583dbf", "filename": "scripts/npc/9120100.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9120100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9120100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120100.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Welcome to the Showa hair shop. If you have a #b#t5150009##k, or a #b#t5151009##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150009##t5150009##l\\r\\n#L2#Dye your hair: #i5151009##t5151009##l\");\n+            cm.sendSimple(\"Welcome to the Showa hair shop. If you have a #b#t5150009##k, or a #b#t5151009##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150009##t5150009##l\\r\\n#L2#Dye your hair: #i5151009##t5151009##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150009##t5150009##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151009##t5151009##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "d07f5102d4b926dd78710cd9751335122f860007", "filename": "scripts/npc/9120101.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9120101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9120101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120101.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm the head of Showa hair salon. If you have a #b#t5150009##k or a #b#t5151009##k allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150009##t5150009##l\\r\\n#L2#Dye your hair: #i5151009##t5151009##l\");\n+            cm.sendSimple(\"I'm the head of Showa hair salon. If you have a #b#t5150009##k or a #b#t5151009##k allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150009##t5150009##l\\r\\n#L2#Dye your hair: #i5151009##t5151009##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150009##t5150009##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151009##t5151009##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "d97485e95c98e163517b0fa5fef8cd3f117bbfea", "filename": "scripts/npc/9200100.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9200100.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,12 +44,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0)\n-            cm.sendSimple(\"Hi, there~! I'm Dr. Lenu, in charge of the cosmetic lenses here at the Henesys Plastic Surgery Shop! With #b#t5152010##k or #b#t5152013##k, you can let us take care of the rest and have the kind of beautiful look you've always craved~! Remember, the first thing everyone notices about you is the eyes, and we can help you find the cosmetic lens that most fits you! Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Cosmetic Lenses: #i5152010##t5152010##l\\r\\n#L2#Cosmetic Lenses: #i5152013##t5152013##l\");\n+            cm.sendSimple(\"Hi, there~! I'm Dr. Lenu, in charge of the cosmetic lenses here at the Henesys Plastic Surgery Shop! With #b#t5152010##k or #b#t5152013##k, you can let us take care of the rest and have the kind of beautiful look you've always craved~! Remember, the first thing everyone notices about you is the eyes, and we can help you find the cosmetic lens that most fits you! Now, what would you like to use?\\r\\n#L1#Cosmetic Lenses: #i5152010##t5152010##l\\r\\n#L2#Cosmetic Lenses: #i5152013##t5152013##l\");\n         else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Cosmetic Lenses for \" + regprice + \" mesos: #i5152010##t5152010##l\\r\\n#L1#Cosmetic Lenses for \" + vipprice + \" mesos: #i5152013##t5152013##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 if (cm.getPlayer().getGender() == 0)\n                     var current = cm.getPlayer().getFace()% 100 + 20000;"}, {"sha": "13a3c7ae46bfe4e559560df0a546f961d4d15236", "filename": "scripts/npc/9200101.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9200101.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,12 +46,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hello, I'm Dr. Rhomes, head of the cosmetic lens department here at the Orbis Plastic Surgery Shop.\\r\\nMy goal here is to add personality to everyone's eyes through the wonders of cosmetic lenses, and with #b#t5152011##k or #b#t5152014##k, I can do the same for you, too! Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Cosmetic Lenses: #i5152011##t5152011##l\\r\\n#L2#Cosmetic Lenses: #i5152014##t5152014##l\");\n+            cm.sendSimple(\"Hello, I'm Dr. Rhomes, head of the cosmetic lens department here at the Orbis Plastic Surgery Shop.\\r\\nMy goal here is to add personality to everyone's eyes through the wonders of cosmetic lenses, and with #b#t5152011##k or #b#t5152014##k, I can do the same for you, too! Now, what would you like to use?\\r\\n#L1#Cosmetic Lenses: #i5152011##t5152011##l\\r\\n#L2#Cosmetic Lenses: #i5152014##t5152014##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Cosmetic Lenses for \" + regprice + \" mesos: #i5152011##t5152011##l\\r\\n#L1#Cosmetic Lenses for \" + vipprice + \" mesos: #i5152014##t5152014##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace()"}, {"sha": "3c16150d1eb9822afa086d453bd539d3521c0c93", "filename": "scripts/npc/9200102.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200102.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9200102.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9200102.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,12 +46,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Um... hi, I'm Dr. Bosch, and I am a cosmetic lens expert here at the Ludibrium Plastic Surgery Shop. I believe your eyes are the most important feature in your body, and with #b#t5152012##k or #b#t5152015##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Cosmetic Lenses: #i5152012##t5152012##l\\r\\n#L2#Cosmetic Lenses: #i5152015##t5152015##l\");\t\t\t\t\t\t\n+            cm.sendSimple(\"Um... hi, I'm Dr. Bosch, and I am a cosmetic lens expert here at the Ludibrium Plastic Surgery Shop. I believe your eyes are the most important feature in your body, and with #b#t5152012##k or #b#t5152015##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to use?\\r\\n#L1#Cosmetic Lenses: #i5152012##t5152012##l\\r\\n#L2#Cosmetic Lenses: #i5152015##t5152015##l\");\t\t\t\t\t\t\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Cosmetic Lenses for \" + regprice + \" mesos: #i5152012##t5152012##l\\r\\n#L1#Cosmetic Lenses for \" + vipprice + \" mesos: #i5152015##t5152015##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace() % 100 + 20000;"}, {"sha": "689222d894e83f5a0694595feb9241bbcdf56123", "filename": "scripts/npc/9201015.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201015.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201015.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201015.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Welcome to the Amoria hair shop. If you have a #b#t5150020##k, or a #b#t5151017##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150020##t5150020##l\\r\\n#L2#Dye your hair: #i5151017##t5151017##l\");\n+            cm.sendSimple(\"Welcome to the Amoria hair shop. If you have a #b#t5150020##k, or a #b#t5151017##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150020##t5150020##l\\r\\n#L2#Dye your hair: #i5151017##t5151017##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150020##t5150020##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151017##t5151017##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "da4de68582b4d50c8f238717b4fed7aff11a7c58", "filename": "scripts/npc/9201016.js", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201016.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201016.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201016.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm Salon Seamus. If you have #b#t5150019##k or #b#t5151016##k by any chance, then how about letting me change your hairdo?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150019##t5150019##l\\r\\n#L2#Dye your hair: #i5151016##t5151016##l\");\n+            cm.sendSimple(\"I'm Salon Seamus. If you have #b#t5150019##k or #b#t5151016##k by any chance, then how about letting me change your hairdo?\\r\\n#L1#Haircut: #i5150019##t5150019##l\\r\\n#L2#Dye your hair: #i5151016##t5151016##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150019##t5150019##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151016##t5151016##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n@@ -145,12 +142,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm Salon Seamus. If you have #b#t5150019##k or #b#t5151016##k by any chance, then how about letting me change your hairdo?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150019##t5150019##l\\r\\n#L2#Dye your hair: #i5151016##t5151016##l\");\n+            cm.sendSimple(\"I'm Salon Seamus. If you have #b#t5150019##k or #b#t5151016##k by any chance, then how about letting me change your hairdo?\\r\\n#L1#Haircut: #i5150019##t5150019##l\\r\\n#L2#Dye your hair: #i5151016##t5151016##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150019##t5150019##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151016##t5151016##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "3ca19ca9958b3c556a828c3392378ccc00b0d90d", "filename": "scripts/npc/9201017.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201017.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201017.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201017.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,12 +46,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hi, there~! I'm Dr.Roberts, in charge of the cosmetic lenses here at the Amoria Plastic Surgery Shop! With #b#t5152025##k or #b#t5152026##k, you can let us take care of the rest and have the kind of beautiful look you've always craved~! Remember, the first thing everyone notices about you is the eyes, and we can help you find the cosmetic lens that most fits you! Now, what would you like to use?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Cosmetic Lenses: #i5152025##t5152025##l\\r\\n#L2#Cosmetic Lenses: #i5152026##t5152026##l\");\t\t\t\t\t\t\n+            cm.sendSimple(\"Hi, there~! I'm Dr.Roberts, in charge of the cosmetic lenses here at the Amoria Plastic Surgery Shop! With #b#t5152025##k or #b#t5152026##k, you can let us take care of the rest and have the kind of beautiful look you've always craved~! Remember, the first thing everyone notices about you is the eyes, and we can help you find the cosmetic lens that most fits you! Now, what would you like to use?\\r\\n#L1#Cosmetic Lenses: #i5152025##t5152025##l\\r\\n#L2#Cosmetic Lenses: #i5152026##t5152026##l\");\t\t\t\t\t\t\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Cosmetic Lenses for \" + regprice + \" mesos: #i5152025##t5152025##l\\r\\n#L1#Cosmetic Lenses for \" + vipprice + \" mesos: #i5152026##t5152026##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace() % 100 + 20000;"}, {"sha": "35aac9042b7cb2a50da6dc90d796098501154421", "filename": "scripts/npc/9201018.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201018.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201018.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201018.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Well, hello! Welcome to Amoria Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152022##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5152022##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Well, hello! Welcome to Amoria Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152022##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152022, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "a7948308c417de5568b8e44c11603a07880731e2", "filename": "scripts/npc/9201019.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201019.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201019.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201019.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,18 +47,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152021##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L1#I would like to buy a #b#t5152021##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152021##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152021, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0) {\n                     for(var i = 0; i < mface.length; i++) {"}, {"sha": "477ad87fe26b6dc2e3adf3836f85f4db813c8c99", "filename": "scripts/npc/9201061.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201061.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201061.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201061.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,18 +44,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hi, there~! I'm Bomack. If you have a #b#t5152035##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to do?\\r\\n#L1#I would like to buy a #b#t5152035##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Hi, there~! I'm Bomack. If you have a #b#t5152035##k, I can prescribe the right kind of cosmetic lenses for you. Now, what would you like to do?\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152035, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace() % 100 + 20000;\n                 }"}, {"sha": "7fd8d26eb51132dfee7dc5a8a086fdb6657c76db", "filename": "scripts/npc/9201062.js", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201062.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201062.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201062.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,18 +44,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"Hey, there~! I'm J.J.! I'm in charge of the cosmetic lenses here at NLC Shop! If you have a #b#t5152036##k, I can get you the best cosmetic lenses you have ever had! Now, what would you like to do?\\r\\n#L1#I would like to buy a #b#t5152036##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+            cm.sendSimple(\"Hey, there~! I'm J.J.! I'm in charge of the cosmetic lenses here at NLC Shop! If you have a #b#t5152036##k, I can get you the best cosmetic lenses you have ever had! Now, what would you like to do?\\r\\n#L2#I already have a Coupon!#l\");\n         } else if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152036, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else {\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                }\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 if (cm.getPlayer().getGender() == 0) {\n                     var current = cm.getPlayer().getFace() % 100 + 20000;\n                 }"}, {"sha": "7585600e39240731405dfb3344f365bf7170ea2c", "filename": "scripts/npc/9201063.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201063.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201063.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201063.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,12 +48,9 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 0) {\n-            cm.sendSimple(\"I'm Ari the assistant. If you have #b#t5150030##k or #b#t5151025##k by any chance, then how about letting me change your hairdo?\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150030##t5150030##l\\r\\n#L2#Dye your hair: #i5151025##t5151025##l\");\n+            cm.sendSimple(\"I'm Ari the assistant. If you have #b#t5150030##k or #b#t5151025##k by any chance, then how about letting me change your hairdo?\\r\\n#L1#Haircut: #i5150030##t5150030##l\\r\\n#L2#Dye your hair: #i5151025##t5151025##l\");\n         } else if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150030##t5150030##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151025##t5151025##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0) {"}, {"sha": "1dd52ce4437c1bd875c291bed02dcadb31a41de8", "filename": "scripts/npc/9201064.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201064.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201064.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201064.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -31,7 +31,7 @@ var fhair = Array(31150, 31310, 31220, 31300, 31260, 31160, 31730, 31410, 31410)\n var hairnew = Array();\n \n function start() {\n-    cm.sendSimple(\"I'm the head of this hair salon Mani. If you have a #b#t5150031##k or a #b#t5151026##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L0#I want to buy a coupon!#l\\r\\n#L1#Haircut: #i5150031##t5150031##l\\r\\n#L2#Dye your hair: #i5151026##t5151026##l\");\n+    cm.sendSimple(\"I'm the head of this hair salon Mani. If you have a #b#t5150031##k or a #b#t5151026##k, allow me to take care of your hairdo. Please choose the one you want.\\r\\n#L1#Haircut: #i5150031##t5150031##l\\r\\n#L2#Dye your hair: #i5151026##t5151026##l\");\n }\n \n function action(mode, type, selection) {\n@@ -47,10 +47,7 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 0) {\n-                beauty = 0;\n-                cm.sendSimple(\"Which coupon would you like to buy?\\r\\n#L0#Haircut for \" + hairprice + \" mesos: #i5150031##t5150031##l\\r\\n#L1#Dye your hair for \" + haircolorprice + \" mesos: #i5151026##t5151026##l\");\n-            } else if (selection == 1) {\n+            if (selection == 1) {\n                 beauty = 1;\n                 hairnew = Array();\n                 if (cm.getPlayer().getGender() == 0)"}, {"sha": "7d73da7cdf6ddb2712fed49d5e72d167489ecd60", "filename": "scripts/npc/9201065.js", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201065.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201065.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201065.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -27,7 +27,7 @@ var price = 1000000;\n var skin = Array(0, 1, 2, 3, 4);\n \n function start() {\n-    cm.sendSimple(\"Well, hello! Welcome to the NLC Skin-Care! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153009##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5153009##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+    cm.sendSimple(\"Well, hello! Welcome to the NLC Skin-Care! Would you like to have a firm, tight, healthy looking skin like mine?  With #b#t5153009##k, you can let us take care of the rest and have the kind of skin you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n }\n \n function action(mode, type, selection) {\n@@ -43,25 +43,19 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5153009, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else \n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2) \n+            if (selection == 2) \n                 cm.sendStyle(\"With our specialized machine, you can see the way you'll look after the treatment PRIOR to the procedure. What kind of a look are you looking for? Go ahead and choose the style of your liking~!\", skin);\n         }\n         else if (status == 2){\n-            cm.dispose();\n             if (cm.haveItem(5153009)){\n                 cm.gainItem(5153009, -1);\n                 cm.setSkin(skin[selection]);\n                 cm.sendOk(\"Enjoy your new and improved skin!\");\n-            } else \n+            } else {\n                 cm.sendOk(\"Um...you don't have the skin-care coupon you need to receive the treatment. Sorry, but I am afraid we can't do it for you...\");\n+            }\n+            \n+            cm.dispose();\n         }\n     }\n }\n\\ No newline at end of file"}, {"sha": "0495e04fb5cdaa0d83bfef1e1c005c7c77deadfa", "filename": "scripts/npc/9201069.js", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201069.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201069.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201069.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -30,7 +30,7 @@ var fface = Array(21001, 21002, 21003, 21004, 21005, 21006, 21008, 21012, 21014,\n var facenew = Array();\n \n function start() {\n-    cm.sendSimple(\"Well, hello! Welcome to the New Leaf City Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152034##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L1#I would like to buy a #b#t5152034##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+    cm.sendSimple(\"Well, hello! Welcome to the New Leaf City Plastic Surgery! Would you like to transform your face into something new? With a #b#t5152034##k, you can let us take care of the rest and have the face you've always wanted~!\\r\\n#L2#I already have a Coupon!#l\");\n }\n \n function action(mode, type, selection) {\n@@ -46,15 +46,7 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152034, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else\n-                    cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0)\n                     for(var i = 0; i < mface.length; i++)\n@@ -66,13 +58,15 @@ function action(mode, type, selection) {\n             }\n         }\n         else if (status == 2){\n-            cm.dispose();\n             if (cm.haveItem(5152034)){\n                 cm.gainItem(5152034, -1);\n                 cm.setFace(facenew[selection]);\n                 cm.sendOk(\"Enjoy your new and improved face!\");\n-            } else\n-            cm.sendOk(\"Hmm ... it looks like you don't have the coupon specifically for this place. Sorry to say this, but without the coupon, there's no plastic surgery for you...\");\n+            } else {\n+                cm.sendOk(\"Hmm ... it looks like you don't have the coupon specifically for this place. Sorry to say this, but without the coupon, there's no plastic surgery for you...\");\n+            }\n+            \n+            cm.dispose();\n         }\n     }\n }"}, {"sha": "b0b372f796bec88d903ddff78c216f415c689c74", "filename": "scripts/npc/9201070.js", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201070.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201070.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201070.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -31,7 +31,7 @@ var fface = Array(21001, 21002, 21003, 21004, 21005, 21006, 21008, 21012, 21014,\n var facenew = Array();\n \n function start() {\n-    cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152033##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L1#I would like to buy a #b#t5152033##k for \" + price + \" mesos, please!#l\\r\\n\\#L2#I already have a Coupon!#l\");\n+    cm.sendSimple(\"Hi, I pretty much shouldn't be doing this, but with a #b#t5152033##k, I will do it anyways for you. But don't forget, it will be random!\\r\\n#L2#I already have a Coupon!#l\");\n }\n \n function action(mode, type, selection) {\n@@ -47,15 +47,7 @@ function action(mode, type, selection) {\n         else\n             status--;\n         if (status == 1) {\n-            if (selection == 1) {\n-                if(cm.getMeso() >= price) {\n-                    cm.gainMeso(-price);\n-                    cm.gainItem(5152033, 1);\n-                    cm.sendOk(\"Enjoy!\");\n-                } else\n-                cm.sendOk(\"You don't have enough mesos to buy a coupon!\");\n-                cm.dispose();\n-            } else if (selection == 2) {\n+            if (selection == 2) {\n                 facenew = Array();\n                 if (cm.getPlayer().getGender() == 0)\n                     for(var i = 0; i < mface.length; i++)\n@@ -66,13 +58,15 @@ function action(mode, type, selection) {\n                 cm.sendYesNo(\"If you use the regular coupon, your face may transform into a random new look...do you still want to do it using #b#t5152033##k?\");\n             }\n         } else if (status == 2){\n-            cm.dispose();\n             if (cm.haveItem(5152033)){\n                 cm.gainItem(5152033, -1);\n                 cm.setFace(facenew[Math.floor(Math.random() * facenew.length)]);\n                 cm.sendOk(\"Enjoy your new and improved face!\");\n-            } else \n+            } else {\n                 cm.sendOk(\"Hmm ... it looks like you don't have the coupon specifically for this place. Sorry to say this, but without the coupon, there's no plastic surgery for you...\");\n+            }\n+            \n+            cm.dispose();\n         }\n     }\n }"}, {"sha": "6b0643b3a27178f8ac9aabc04ee5a1a07361a530", "filename": "scripts/npc/9201135.js", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201135.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9201135.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201135.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,6 +47,7 @@ function start() {\n                 if (inMap[i] == cm.getPlayer().getMap().getId()) {\n                         if(inMap[i] == 550000000) {\n                                 toMap[1][1] = cm.getPlayer().peekSavedLocation(\"WORLDTOUR\");\n+                                if(toMap[1][1] == -1) toMap[1][1] = 541000000;\n                         }\n                     \n                         location = i;\n@@ -116,6 +117,7 @@ function action(mode, type, selection) {\n             }\n             else {\n                 travelMap = cm.getPlayer().getSavedLocation(\"WORLDTOUR\");\n+                if(travelMap == -1) travelMap = toMap[1][1];\n             }\n             \n             cm.warp(travelMap, travelSp);"}, {"sha": "73da2a4c3dc95126a17a795e4d29b1818f84ce2a", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -115,6 +115,7 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Implemented Zombify disease status.\");\n         addFeature(\"Added Boss HP Bar for dozens of bosses.\");\n         addFeature(\"Game will favor showing the targeted boss HPbar.\");\n+        addFeature(\"Boss HPBar & Srv Message toggle - GabrielSin's idea.\");\n         addFeature(\"Dmg overtime on maps and neutralizers functional.\");\n         addFeature(\"Items will consistently stay within the walking area.\");\n         addFeature(\"Boats, elevator and other travel mechanics functional.\");"}, {"sha": "79ed3f0c850ae062ba6480c88152807ab0d06fe0", "filename": "scripts/quest/2001.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2001.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,8 +44,8 @@ function end(mode, type, selection) {\n             qm.gainItem(4003000, -30);\n             qm.gainItem(4003001, -30);\n             qm.gainItem(4001004, -1);\n-            qm.gainExp(20000 * qm.getPlayer().getExpRate());\n-            qm.gainMeso(15000 * qm.getPlayer().getMesoRate());\n+            qm.gainExp(20000);\n+            qm.gainMeso(15000);\n             qm.gainFame(2);\n             qm.completeQuest();\n                     "}, {"sha": "d123cc9aa058880989810c87ea3ee540c378ca8b", "filename": "scripts/quest/2034.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2034.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2034.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2034.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -35,7 +35,7 @@ function end(mode, type, selection) {\n             qm.gainItem(item, 1);\n             qm.gainItem(4000007, -150);\n             \n-            qm.gainExp(2200 * qm.getPlayer().getExpRate());\n+            qm.gainExp(2200);\n             qm.completeQuest();\n             \n             qm.sendOk(\"Alright, if you need work sometime down the road, feel free to come back and see me. This town sure can use a person like you for help~\");"}, {"sha": "e4e52c98945695ff20d12b1b835403c98c209639", "filename": "scripts/quest/20522.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/20522.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/20522.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20522.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -78,7 +78,7 @@ function end(mode, type, selection) {\n         \n         qm.forceCompleteQuest();\n         qm.gainItem(4220137, -1);\n-        qm.gainExp(37600 * qm.getPlayer().getExpRate());\n+        qm.gainExp(37600);\n         \n \tqm.dispose();\n     }"}, {"sha": "e597d4190cd73f7fc3cc7a7ef5cf8000d85eb3a4", "filename": "scripts/quest/21703.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21703.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21703.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21703.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -65,7 +65,7 @@ function end(mode, type, selection) {\n \tif (qm.isQuestStarted(21703)) {\n \t    qm.forceCompleteQuest();\n \t    qm.teachSkill(21000000, qm.getPlayer().getSkillLevel(21000000), 10, -1);   // Combo Ability Skill\n-\t    qm.gainExp(2800 * qm.getPlayer().getExpRate());\n+\t    qm.gainExp(2800);\n \t}\n \t\tqm.sendNext(\"(You remembered the #bCombo Ability#k skill! You were skeptical of the training at first, since the old man suffers from Alzheimer's and all, but boy, was it effective!)\", 2);\n \t\tqm.showInfo(\"Effect/BasicEff.img/AranGetSkill\");"}, {"sha": "e8039917d6109623f3bab45bb50cf1af4b6d4c3c", "filename": "scripts/quest/21720.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21720.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21720.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21720.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,7 +37,7 @@ function end(mode, type, selection) {\n \tif (qm.getQuestStatus(21720) == 1) {\n \t    qm.forceCompleteQuest();\n \t    qm.teachSkill(21001003, qm.getPlayer().getSkillLevel(21001003), 20, -1);\n-\t    qm.gainExp(3900 * qm.getPlayer().getExpRate());\n+\t    qm.gainExp(3900);\n \t}\n         qm.showIntro(\"Effect/BasicEff.img/AranGetSkill\");\n         qm.sendNext('#b(You remembered the Polearm Booster skill!)#k', 2);"}, {"sha": "4795cf915ec83f39ac1d3f97fa25bf14b865e123", "filename": "scripts/quest/21728.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21728.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21728.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21728.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -39,7 +39,7 @@ function end(mode, type, selection) {\n                 qm.sendNext(\"You haven't found the #rPuppeteer's cave#k yet, did you?\");\n             } else {\n                 qm.sendNext(\"Hm, so the entrance is blocked by a powerful force? I see, gimme a time to think now...\");\n-                qm.gainExp(200 * qm.getPlayer().getExpRate());\n+                qm.gainExp(200);\n                 qm.forceCompleteQuest();\n             }\n             "}, {"sha": "5f00ad6dab14626094ac1915222feca76fbc5c7e", "filename": "scripts/quest/21733.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21733.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21733.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21733.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -62,7 +62,7 @@ function end(mode, type, selection) {\n         } else if(status == 1) {\n             qm.sendNext(\"I will teach you the #rPolearm Mastery#k skill, to reward your actions here. You will be able to improve your accuracy and the overall mastery of your polearm arts.\");\n         } else {\n-            qm.gainExp(8000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(8000);\n             qm.teachSkill(21100000, 0, 20, -1); // polearm mastery\n             \n             qm.forceCompleteQuest();"}, {"sha": "a5fa4b7f968290db4993c44a4f177815a63c0f0f", "filename": "scripts/quest/21734.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21734.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21734.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21734.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -64,7 +64,7 @@ function end(mode, type, selection) {\n         } else if(status == 2) {\n             qm.sendNext(\"For your bravery inputted on these series of missions, I will now reward you properly. Behold, the #rCombo Drain#k Skill: that let's you heal back a portion of damage dealt to the monsters.\");\n         } else {\n-            qm.gainExp(12500 * qm.getPlayer().getExpRate());\n+            qm.gainExp(12500);\n             qm.teachSkill(21100005, 0, 20, -1); // combo drain\n             \n             qm.forceCompleteQuest();"}, {"sha": "3d4cd3a6de4b06dee97355d365bd04a852eb7e5a", "filename": "scripts/quest/21735.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21735.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21735.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21735.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -72,7 +72,7 @@ function end(mode, type, selection) {\n             }\n         } else if (status == 1) {\n             qm.gainItem(4032323, -1);\n-            qm.gainExp(6037 * qm.getPlayer().getExpRate());\n+            qm.gainExp(6037);\n             qm.forceCompleteQuest();\n             \n             qm.dispose();"}, {"sha": "94f544f74f1e847c66a309e5b386ae1e3399f37e", "filename": "scripts/quest/21739.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21739.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21739.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21739.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,7 +37,7 @@ function end(mode, type, selection) {\n         if(status == 0) {\n             qm.sendNext(\"So, have you defeated the giant? Oh, a Black Wing agent undercover? And he GOT THE SEAL STONE OF ORBIS?! Oh, no. That's horrible! We need to develop countermeasures as soon as possible! Tell the informant on Lith about the situation.\");\n         } else {\n-            qm.gainExp(29500 * qm.getPlayer().getExpRate());\n+            qm.gainExp(29500);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "d77ade41dde62f61ce460a48a14f26219e0ccf9d", "filename": "scripts/quest/21742.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21742.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21742.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21742.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -88,7 +88,7 @@ function end(mode, type, selection) {\n         } else if (status == 1) {\n             qm.gainItem(4032342, -8);\n             qm.gainItem(4220151, -1);\n-            qm.gainExp(10000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(10000);\n             \n             qm.forceCompleteQuest();\n             qm.dispose();"}, {"sha": "d7a641e604c390c97bb555accad181a409ea2e57", "filename": "scripts/quest/21746.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21746.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21746.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21746.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -73,7 +73,7 @@ function end(mode, type, selection) {\n         } else if (status == 1) {\n             qm.gainItem(4032342, -8);\n             qm.gainItem(4220151, -1);\n-            qm.gainExp(10000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(10000);\n             \n             qm.forceCompleteQuest();\n             qm.dispose();"}, {"sha": "c09bd3837584c2dccf0128b02f5bc11fcf894eca", "filename": "scripts/quest/21747.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21747.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21747.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21747.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -64,7 +64,7 @@ function end(mode, type, selection) {\n         } else if (status == 1) {\n             qm.sendNext(\"But yet, something made you unhappy. What could it be? ... No... Black Wings took away the Seal stone? I'm afraid nothing can be done anymore. I suggest you return to your group tactician, Tru is it?, and tell him about the situation now. Tell him about the loss here in Mu Lung. There's no time to lose, hurry!\");\n         } else if (status == 2) {\n-            qm.gainExp(16000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(16000);\n             qm.forceCompleteQuest();\n             \n             qm.dispose();"}, {"sha": "f3044454d2911c7c356900ddf475bb14a97b4942", "filename": "scripts/quest/21748.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21748.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21748.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21748.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -39,7 +39,7 @@ function end(mode, type, selection) {\n         } else if (status == 1) {\n             qm.sendNext(\"I've researched some skill books, trying to trace any lost skills of yours. Good news I found one of them: it's the #rFinal Charge#k! With it you will be able to draw closer opposing monsters at each swipe. It's a fine improvement for your arsenal, isn't it?\");\n         } else if (status == 2) {\n-            qm.gainExp(20000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(20000);\n             qm.teachSkill(21100002, 0, 30, -1); // final charge\n             \n             qm.forceCompleteQuest();"}, {"sha": "e628d27071f2d0819993af09a132046af3457261", "filename": "scripts/quest/21749.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21749.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21749.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21749.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -39,7 +39,7 @@ function start(mode, type, selection) {\n         } else if (status == 1) {\n             qm.sendNext(\"Aran, your next objective will be to use the #btime gate to Ellin#k again. This time you will be retrieving the long lost #rSeal Stone of Ellin Forest#k. According to informations our network have gathered, #b#p2131002##k of that time have a clue about that gem, #rfind her#k. Please be successful on this task, our world is relying on you more than ever!\");\n         } else {\n-            qm.gainExp(500 * qm.getPlayer().getExpRate());\n+            qm.gainExp(500);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "71dcf578058e5826551695f56b1759badf6c8ed7", "filename": "scripts/quest/21757.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21757.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21757.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21757.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,7 +37,7 @@ function end(mode, type, selection) {\n         if (status == 0) {\n             qm.sendNext(\"Oh, a letter for the #rempress#k? From the #bheroes#k?!\");\n         } else {\n-            qm.gainExp(1000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(1000);\n             qm.gainItem(4032330, -1);\n             qm.forceCompleteQuest();\n             "}, {"sha": "8c55c5323dc850bb576e4cd1b6dc2096b36be8e1", "filename": "scripts/quest/21766.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21766.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/21766.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21766.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -17,7 +17,7 @@ function start(mode, type, selection) {\n }\n \n function end(mode, type, selection) {\n-\tqm.gainExp(200 * qm.getPlayer().getExpRate());\n+\tqm.gainExp(200);\n \tqm.forceCompleteQuest();\n \tqm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "5361dd9c9e057efeec45c7b793219e9619c2e69f", "filename": "scripts/quest/2186.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2186.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2186.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2186.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -8,7 +8,7 @@ function end(mode, type, selection){\n         if(qm.haveItem(4031853)){\n             if(qm.canHold(2030019)) {\n                 qm.gainItem(4031853, -1);\n-                qm.gainExp(1700 * qm.getPlayer().getExpRate());\n+                qm.gainExp(1700);\n                 qm.gainItem(2030019, 10);\n \n                 qm.sendOk(\"Geez, you found my glasses! Thank you, thank you so much. Now I'm able to see everything again!\");\n@@ -24,7 +24,7 @@ function end(mode, type, selection){\n                 else\n                     qm.gainItem(4031855, -1);\n                    \n-                qm.gainExp(1000 * qm.getPlayer().getExpRate());\n+                qm.gainExp(1000);\n                 qm.gainItem(2030019, 5);\n  \n                 qm.sendOk(\"Hm, those aren't my glasses... But alas, I'll take it anyway. Thanks.\");"}, {"sha": "e76ce9d2ef80f030ed8a28bfd0813b30dd5c7212", "filename": "scripts/quest/2214.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2214.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2214.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2214.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -57,7 +57,7 @@ function end(mode, type, selection) {\n             \n             qm.sendNext(\"(Ah, there is a crumbled note here... Hm, it contains details about some scheme that is about to happen, that must be what #r#p1052002##k was talking about.)\");\n             qm.gainItem(4031894, 1);\n-            qm.gainExp(20000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(20000);\n             qm.forceCompleteQuest();\n             \n             qm.dispose();"}, {"sha": "081692151247a5ca5590f6d766141a7c2796f6c3", "filename": "scripts/quest/2216.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2216.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2216.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2216.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -36,7 +36,7 @@ function start(mode, type, selection) {\n         \n         if (status == 0) {\n             qm.sendNext(\"I've just gathered an interesting information, #rDyle looks just like regular Ligators#k, but bigger.\");\n-            qm.gainExp(7000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(7000);\n             qm.forceCompleteQuest();\n             \n             if(isAllSubquestsDone() && qm.haveItem(4031894)) {"}, {"sha": "72b4e81f33abd3a2102c8d5170851fbbc6074e7c", "filename": "scripts/quest/2217.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2217.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2217.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2217.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -36,7 +36,7 @@ function start(mode, type, selection) {\n         \n         if (status == 0) {\n             qm.sendNext(\"Hey, did you notice already, it looks like some awful stench is emanating from the sewers... Ewww\");\n-            qm.gainExp(7000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(7000);\n             qm.forceCompleteQuest();\n             \n             if(isAllSubquestsDone() && qm.haveItem(4031894)) {"}, {"sha": "80d8ee774886da6e9a99d6b79d6c34eb7781bc37", "filename": "scripts/quest/2218.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2218.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2218.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2218.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -36,7 +36,7 @@ function start(mode, type, selection) {\n         \n         if (status == 0) {\n             qm.sendNext(\"Hey did you see how strange #rLakelis#k has been acting these days? We should see what's going on aabout her, her actions have been so weird lately...\");\n-            qm.gainExp(7000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(7000);\n             qm.forceCompleteQuest();\n             \n             if(isAllSubquestsDone() && qm.haveItem(4031894)) {"}, {"sha": "ee04b77db9b6e246d66205f6cc7f098c646274dd", "filename": "scripts/quest/2219.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2219.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2219.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2219.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -36,7 +36,7 @@ function start(mode, type, selection) {\n         \n         if (status == 0) {\n             qm.sendNext(\"Did you know, they say someone from the sewers has been trying to #rdevelop a magic powder that let's one to grow#k, isn't that nice?\");\n-            qm.gainExp(7000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(7000);\n             qm.forceCompleteQuest();\n             \n             if(isAllSubquestsDone() && qm.haveItem(4031894)) {"}, {"sha": "e460077dd0fd63b25bfe738c1ec82848435bea20", "filename": "scripts/quest/2236.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2236.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2236.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2236.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -38,7 +38,7 @@ function end(mode, type, selection) {\n \tif(status == 0) {\n \t\tif(qm.getQuestProgress(2236) == 63) {\t//111111\n \t\t\tqm.sendOk(\"I, too, felt it. The force of the Shaman Rocks began to overpower the forces of evil. I think Sleepywood is safe now. The evil has been eliminated.\");\n-\t\t\tqm.gainExp(60000 * qm.getPlayer().getExpRate());\n+\t\t\tqm.gainExp(60000);\n \t\t\tqm.forceCompleteQuest();\n \t\t}\n \t\telse {"}, {"sha": "31b5cbf4f05049f2855e577ca1262080e3cd44df", "filename": "scripts/quest/2251.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2251.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2251.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2251.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -13,7 +13,7 @@ function end(mode, type, selection) {\n     else {\n         qm.gainItem(4032399, -20);\n         qm.sendOk(\"Oh, you brought 20 #b#t4032399##k! Thank you.\");\n-        qm.gainExp(8000 * qm.getPlayer().getExpRate());\n+        qm.gainExp(8000);\n         qm.forceCompleteQuest();\n     }\n     "}, {"sha": "c19bb7064c881dd3935069a1cd93e20480475216", "filename": "scripts/quest/2293.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2293.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2293.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2293.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -102,7 +102,7 @@ function end(mode, type, selection)\n         else if(selection == 3)\n         {\n             qm.sendOk(\"So that was the song he was playing... Well, it wasn't my song after all, but I'm glad I can know that now with certainty. Thank you so much.\");\n-            qm.gainExp(32500 * qm.getPlayer().getExpRate());\n+            qm.gainExp(32500);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "ecf094dc083ba153f978c483db0418d9c0b51cb2", "filename": "scripts/quest/2300.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2300.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2300.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2300.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -57,6 +57,7 @@ function end(mode, type, selection) {\n \t\tqm.sendNextPrev(\"Hmmm... okay. Since the letter is from the job instructor, I suppose you are really the one. I apologize for not introducing myself to you earlier. I'm the #bHead Security Officer#k in charge of protecting King Mush. As you can see, this temporary hideout is protected by the team of security and soldiers. Our situation may be dire, but nevertheless, welcome to Kingdom of Mushroom.\");\n \tif(status == 2){\n \t\tqm.gainItem(4032375, -1);\n+                qm.gainExp(6000);\n \t\tqm.forceCompleteQuest();\n \t\tqm.forceStartQuest(2312);\n \t\tqm.dispose();"}, {"sha": "3b667a8d613727ab51cd831b2403908563cbe059", "filename": "scripts/quest/2312.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2312.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2312.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2312.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,7 +46,7 @@ function end(mode, type, selection) {\n \t\tqm.sendOk(\"Did you teach those Renegade Spores a lesson?\");\n \tif (status == 1){\n \t\tqm.forceCompleteQuest();\n-\t\tqm.gainExp(11500 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(11500);\n \t\tqm.gainItem(4000499, -50);\n \t\tqm.sendOk(\"That was amazing. I apologize for doubting your abilities. Please save our Kingdom of Mushroom from this crisis!\");\n \t\tqm.dispose();"}, {"sha": "40b9d04010fca8e48a0ff17ee4437a5d90de3424", "filename": "scripts/quest/2313.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2313.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2313.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2313.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,7 +44,7 @@ function end(mode, type, selection) {\n \t}\n \tif (status == 0) {\n \t\tqm.forceCompleteQuest(); \n-\t\tqm.gainExp(4000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(4000);\n \t\tqm.dispose();\n \t}\n }"}, {"sha": "cfa542d54f5a202ebb2f05e020204d20999ea8a8", "filename": "scripts/quest/2314.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2314.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2314.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2314.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -28,7 +28,7 @@ function start(mode, type, selection) {\n \tif(status == 2){\n \t\t//qm.forceStartQuest();\n \t\t//qm.forceStartQuest(2314,\"1\");\n-\t\tqm.gainExp(8300 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(8300);\n \t\tqm.sendOk(\"I see, so it was indeed not a regular barrier by any means. Great work there. If not for you help, we wouldn't have had a clue as to what that was all about.\");\n \t\tqm.forceCompleteQuest(); \n \t\tqm.dispose();\n@@ -48,7 +48,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"I see that you have thoroughly investigated the barrier at the Mushroom Forest. What was it like?\");\n \tif (status == 1){\n-\t\tqm.gainExp(8300 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(8300);\n \t\tqm.sendOk(\"I see, so it was indeed not a regular barrier by any means. Great work there. If not for you help, we wouldn't have had a clue as to what that was all about.\");\n \t\tqm.forceCompleteQuest(); \n \t\tqm.dispose();"}, {"sha": "e345ab6e2a77597b1f39bf64538edf4301088f76", "filename": "scripts/quest/2315.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2315.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2315.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2315.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"What? You investigated the barrier at the Mushroom Forest?\");\n \tif (status == 1){\n-\t\tqm.gainExp(4000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(4000);\n \t\tqm.sendOk(\"Hmmm...this is interesting. It's a barrier set up by someone with a powerful force of magic, which means there's no way we can manually break through it.\");\n \t\tqm.forceCompleteQuest(); \n \t\tqm.dispose();"}, {"sha": "3b15ff46e8d67f848e4a28bfec0854c713fa0baf", "filename": "scripts/quest/2316.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2316.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2316.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2316.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Ah, so you're the explorer people were talking about. I'm #bScarrs, the Royal Mushroom Scholar#k representing the Kingdom of Mushroom. So you need some #kKiller Mushroom Spores#k?\");\n \tif (status == 1){\n-\t\tqm.gainExp(4200 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(4200);\n \t\tqm.sendOk(\"#kKiller Mushroom Spores#k... I think i've heard of them before...\");\n \t\tqm.forceCompleteQuest(); \n \t\tqm.dispose();"}, {"sha": "359cd2b951a07a01005a172e0102543e0f868901", "filename": "scripts/quest/2317.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2317.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2317.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2317.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Have you gathered up the 100 Poison Mushroom Caps like I asked you to get?\");\n \tif (status == 1){\n-\t\tqm.gainExp(13500 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(13500);\n \t\tqm.gainItem(4000500, -100);\n \t\tqm.sendOk(\"I am amazed that you were able to gather up these 100 Poison Mushroom Caps, which is considered a difficult feat. I think I'll be able to make #bKiller Mushroom Spores#k our of these.\");\n \t\tqm.forceCompleteQuest(); "}, {"sha": "3babb9a864caf541e434116bf4d948b58fc2a39d", "filename": "scripts/quest/2318.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2318.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2318.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2318.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Did you gather up all the necessary ingredients for it?\")\n \tif (status == 1){\n-\t\tqm.gainExp(11500 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(11500);\n \t\tqm.gainItem(4000499, -50);\n \t\tqm.sendNext(\"Okay, these should be enough for me to make the #bKiller Mushroom Spores.#k Please hold on for a bit.\");\n \t\tqm.forceCompleteQuest();"}, {"sha": "8f5e650664ea04739fa7d60c7d25f5ae62e4afd3", "filename": "scripts/quest/2319.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2319.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2319.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2319.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,7 +46,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Are the #bKiller Mushroom Spores#k finally completed?\");\n \tif (status == 1){\n-\t\tqm.gainExp(4200 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(4200);\n \t\tqm.gainItem(4032389, -1);\n \t\tqm.sendOk(\"Okay, so this is the #bKiller Mushroom Spores.#k Thank you, thank you, and please tell #bScarrs#k the same.\");\n \t\tqm.forceCompleteQuest();"}, {"sha": "cf5e5d389f34adde4cfa51ff6078def11db149c3", "filename": "scripts/quest/2320.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2320.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2320.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2320.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,7 +46,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Oh! You're here on behalf of #bScarrs#k? \\r\\n\\r\\n#fUI/UIWindow.img/QuestIcon/4/0# \\r\\n#fUI/UIWindow.img/QuestIcon/8/0# 8800 exp\");\n \tif (status == 1){\n-\t\tqm.gainExp(8800 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(8800);\n \t\tqm.gainItem(4032389, -1);\n \t\tqm.sendOk(\"Ahh, so this is the #bKiller Mushroom Spores#k that I was working on in the past. I had a tough time gathering up the ingredients, so I left it in theory only, but he was able to complete it, with a sample to show for as well. Please tell him I appreciate his good work.\");\n \t\tqm.forceCompleteQuest();"}, {"sha": "8b54b52f237eff8530b3b4bd22dea4c52f648cb9", "filename": "scripts/quest/2321.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2321.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2321.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2321.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"I have been keeping up on your fabulour work. I am aware that you have successfully created the #bKiller Mushroom Spores#k, which penetrates through the unpenetrable barrier of the forest. Congratulations!\");\n \tif (status == 1){\n-\t\tqm.gainExp(2500 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(2500);\n \t\tqm.sendOk(\"The problem now is to figure out how to enter the castle.\");\n \t\tqm.forceCompleteQuest();\n \t\tqm.dispose();"}, {"sha": "fd114c25d1717b7518f4f3d0123a798d5cf76bbf", "filename": "scripts/quest/2322.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2322.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2322.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2322.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -30,7 +30,7 @@ function start(mode, type, selection) {\n \tif (status == 2){\n \t\t//qm.forceStartQuest();\n \t\t//qm.forceStartQuest(2322, \"1\");\n-\t\tqm.gainExp(11000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(11000);\n \t\tqm.sendOk(\"Good job navigating through the area.\");\n \t\tqm.forceCompleteQuest();\n \t\tqm.dispose();\n@@ -50,7 +50,7 @@ function end(mode, type, selection) {\n \tif (status == 0)\n \t\tqm.sendOk(\"Hmmm I see... so they have completely shut off the entrance and everything.\");\n \tif (status == 1){\n-\t\tqm.gainExp(11000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(11000);\n \t\tqm.sendOk(\"Good job navigating through the area.\");\n \t\tqm.forceCompleteQuest();\n \t\tqm.dispose();"}, {"sha": "4154deb9d5c3aecc67cb5148eb744ca1d3a47b49", "filename": "scripts/quest/2325.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2325.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2325.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2325.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -24,7 +24,7 @@ function end(mode, type, selection){\n \telse if(status == 2){\n \t\tqm.sendOk(\"What? My brother sent you here? Ahhh... I am safe now. Thank you so much...\");\n \t\tqm.forceCompleteQuest();\n-\t\tqm.gainExp(6000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(6000);\n \t\tqm.dispose();\n \t}\n }\n\\ No newline at end of file"}, {"sha": "d8164d0af39976cb44984eb62c9bb90a042eaa78", "filename": "scripts/quest/2333.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2333.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2333.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2333.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -51,7 +51,7 @@ function end(mode, type, selection){\n \t\tqm.sendNext(\"Hurray! #b#h ##k you defeated the #bPrime Minister#k.\");\n \t}\n \telse if(status == 1){\n-\t\tqm.gainExp(15000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(15000);\n \t\tqm.forceCompleteQuest();\n \n \t\tvar eim = qm.getEventInstance();"}, {"sha": "bc0b73998404fc256f811b15811ca43dfc35a5ac", "filename": "scripts/quest/2334.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2334.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/2334.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2334.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,7 +37,7 @@ function start(mode, type, selection){\n \t}\n \telse if(status == 6){\n \t\tqm.forceStartQuest();\n-\t\tqm.gainExp(1000 * qm.getPlayer().getExpRate());\n+\t\tqm.gainExp(1000);\n \t\tqm.forceCompleteQuest();\n \t\tqm.dispose();\n \t}"}, {"sha": "a73a15fdf61e12e60ae74aac1a37568abffa1687", "filename": "scripts/quest/3239.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3239.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3239.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3239.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -17,7 +17,7 @@ function end(mode, type, selection) {\n \t\t\telse if(rnd == 2) qm.gainItem(2040707, 1);\n \t\t\telse qm.gainItem(2040708, 1);\n \n-\t\t\tqm.gainExp(2700 * qm.getPlayer().getExpRate());\n+\t\t\tqm.gainExp(2700);\n \t\t\tqm.forceCompleteQuest();\n \t\t}\n \t\telse {"}, {"sha": "ee0f6e054ead4eaad53c9fa7a0475f44300aeaec", "filename": "scripts/quest/3311.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3311.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3311.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3311.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,7 +37,7 @@ function end(mode, type, selection) {\n         if (status == 0) {\n             if(qm.getQuestProgress(3311, 0) == 1 && qm.getQuestProgress(3311, 1) == 1) {\n                 qm.sendNext(\"Hmm, so the Alcadno doctor wrote something about researching some vanguardist Neo Huroid machine, that could beat by far the existing one, and was about to prepare the last steps of his rehearsal? We don't have a word about him for about three weeks now, something must have gone wrong...\");\n-                qm.gainExp(60000 * qm.getPlayer().getExpRate());\n+                qm.gainExp(60000);\n                 qm.forceCompleteQuest();\n             } else {\n                 qm.sendNext(\"Found nothing yet? Please check out Dr. De Lang's house properly, something there may give out a clue about what is going on.\");"}, {"sha": "576717e7dcec3cbbcbc1b6b3356a53cf7e160cb0", "filename": "scripts/quest/3314.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3314.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3314.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3314.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,7 @@ function end(mode, type, selection) {\n                 if(qm.canHoldAll([2050004, 2022224], [10, 20])) {\n                     qm.sendNext(\"You did took my experiments. Hmm, so THAT is the result of it, hehehehe... Ok, take that as compensation will you? And oh, you can #rspew that#k right away (#bright-click on the pill icon at the top-right corner of the screen#k), no worries.\");\n                 \n-                    qm.gainExp(12500 * qm.getPlayer().getExpRate());\n+                    qm.gainExp(12500);\n                     qm.gainItem(2050004, 10);\n \n                     var i = Math.floor(Math.random() * 5);"}, {"sha": "83cb1b74ac74f317e1859425ebd2ab3293cd706e", "filename": "scripts/quest/3345.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3345.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3345.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3345.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -39,7 +39,7 @@ function end(mode, type, selection) {\n                 qm.sendNext(\"So, you have succeeded. With this, Magatia's upfront demise has been averted, well done brave adventurer!\");\n                 qm.forceCompleteQuest();\n                 \n-                qm.gainExp(20000 * qm.getPlayer().getExpRate());\n+                qm.gainExp(20000);\n             } else {\n                 qm.sendNext(\"Did you not seal the #rmagic circle beneath Magatia#k yet? It is a matter of great importance, please haste yourself.\");\n             }"}, {"sha": "26c5a87acaf100c6686661148ca711d70fcb7121", "filename": "scripts/quest/3414.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3414.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3414.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3414.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,7 +44,7 @@ function end(mode, type, selection) {\n             qm.gainItem(4031104, -1);\n             qm.gainItem(4031105, -1);\n             qm.gainItem(4031106, -1);\n-            qm.gainExp(12000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(12000);\n             qm.completeQuest();\n                     \n             qm.dispose();"}, {"sha": "fa84eab33f62f2e4c8577d7e5f3949e40b0d81b3", "filename": "scripts/quest/3414_free10rate.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3414_free10rate.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3414_free10rate.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3414_free10rate.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -36,7 +36,7 @@ function end(mode, type, selection) {\n             item = qm.gainItem(item, 1);\n             \n             if (item != null) {\n-                qm.gainExp(12000 * qm.getPlayer().getExpRate());\n+                qm.gainExp(12000);\n                 qm.completeQuest();\n             }\n                     "}, {"sha": "2a3f4b1d5f50882090a01646958db32b48fa303f", "filename": "scripts/quest/3437.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3437.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3437.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3437.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -40,7 +40,7 @@ function end(mode, type, selection) {\n             qm.gainItem(item, 1);\n             qm.gainItem(4000122, -120);\n             \n-            qm.gainExp(6100 * qm.getPlayer().getExpRate());\n+            qm.gainExp(6100);\n             qm.completeQuest();\n             \n             qm.sendOk(\"Thank you so much for fulfilling your missions as one of the Mesorangers. I've told the Sector about your successful story, and the Sector seems to be very pleased with you, too. Hopefully you'll keep working with us. Bye~\");"}, {"sha": "82c02a1ab24b800d8a093e13ed84e76014d9e7d3", "filename": "scripts/quest/3452.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3452.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3452.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3452.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -15,7 +15,7 @@ function end(mode, type, selection) {\n \t\tif(qm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.USE).getNumFreeSlot() >= 1) {\n \t\t\tqm.gainItem(4000099, -1);\n \t\t\tqm.gainItem(2000011, 50);\n-\t\t\tqm.gainExp(8000 * qm.getPlayer().getExpRate());\n+\t\t\tqm.gainExp(8000);\n \t\t\tqm.forceCompleteQuest();\n \t\t}\n \t\telse {"}, {"sha": "696e6bbceae26b0f220b6137354d7921eb546c9d", "filename": "scripts/quest/3514.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3514.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3514.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3514.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -78,7 +78,7 @@ function end(mode, type, selection) {\n                         qm.sendOk(\"It seems the potion worked and your emotions are no longer frozen. And, oh, my... You're ailing bad, #bpurge#k that out quickly.\");\n                 }\n         } else if(status == 1) {\n-                qm.gainExp(891500 * qm.getPlayer().getExpRate());\n+                qm.gainExp(891500);\n                 qm.completeQuest(3514);\n                 qm.dispose();\n         }"}, {"sha": "c724911816b3f89b903a8d3e8f82368e4f9be5c8", "filename": "scripts/quest/3714.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3714.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3714.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3714.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -44,7 +44,7 @@ function start(mode, type, selection) {\n             qm.sendNext(\"You have brought a #b#t4001094##k, thank you for the effort!\");\n         } else if (status == 1) {\n             qm.gainItem(4001094, -1);\n-            qm.gainExp(42000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(42000);\n             \n             qm.forceCompleteQuest();\n             qm.dispose();"}, {"sha": "7e1a3a482ba0d901e7070e9c5c4dd65ad3edfafb", "filename": "scripts/quest/3833.js", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3833.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3833.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3833.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -15,40 +15,40 @@ function end(mode, type, selection) {\n \t\t\t\tqm.gainItem(4000294, -1000);\n \t\t\t\tqm.gainItem(2040501, 1);\n \t\t\t\tqm.gainItem(2000005, 50);\n-\t\t\t\tqm.gainExp(54000 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(54000);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \t\t\n \t\t\telse if(qm.haveItem(4000294, 600)) {\n \t\t\t\tqm.gainItem(4000294, -600);\n \t\t\t\tqm.gainItem(2020013, 50);\n-\t\t\t\tqm.gainExp(54000 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(54000);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \n \t\t\telse if(qm.haveItem(4000294, 500)) {\n \t\t\t\tqm.gainItem(4000294, -500);\n-\t\t\t\tqm.gainExp(54000 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(54000);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \n \t\t\telse if(qm.haveItem(4000294, 100)) {\n \t\t\t\tqm.gainItem(4000294, -100);\n-\t\t\t\tqm.gainExp(45000 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(45000);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \n \t\t\telse if(qm.haveItem(4000294, 50)) {\n \t\t\t\tqm.gainItem(4000294, -50);\n \t\t\t\tqm.gainItem(2020007, 50);\n-\t\t\t\tqm.gainExp(10000 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(10000);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \n \t\t\telse if(qm.haveItem(4000294, 1)) {\n \t\t\t\tqm.gainItem(4000294, -1);\n \t\t\t\tqm.gainItem(2000000, 1);\n-\t\t\t\tqm.gainExp(10 * qm.getPlayer().getExpRate());\n+\t\t\t\tqm.gainExp(10);\n \t\t\t\tqm.forceCompleteQuest();\n \t\t\t}\n \t\t}"}, {"sha": "4a6bf56015f65cb61f014cccada14effddbc5d28", "filename": "scripts/quest/3926.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3926.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3926.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3926.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -47,7 +47,7 @@ function end(mode, type, selection) {\n             \n             if(c == 4) {\n                 qm.sendNext(\"You delivered all the jewels, well done!\");\n-                qm.gainExp(6500 * qm.getPlayer().getExpRate());\n+                qm.gainExp(6500);\n                 qm.forceCompleteQuest();\n             } else {\n                 qm.sendNext(\"Have you brought all the jewels from the Red Scorpions? They have to be delivered to the Residential areas of the Sand Bandits.\");"}, {"sha": "5fb43191803d585e7b1fac8a81a8374cf4733935", "filename": "scripts/quest/3927.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3927.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3927.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3927.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -63,7 +63,7 @@ function end(mode, type, selection) {\n                 return;\n             }\n         } else if (status == 3) {\n-            qm.gainExp(1000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(1000);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "205cd60561304e8ef776da5a8cab62c40e475ccf", "filename": "scripts/quest/3929.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3929.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3929.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3929.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,7 +48,7 @@ function end(mode, type, selection) {\n             \n             if(c == 4) {\n                 qm.sendNext(\"You delivered all the food, good.\");\n-                qm.gainExp(2000 * qm.getPlayer().getExpRate());\n+                qm.gainExp(2000);\n                 qm.forceCompleteQuest();\n             } else {\n                 var missed = (4 - qm.getItemQuantity(4031580)) - c;"}, {"sha": "d338f065451511ba8ae9ba964caec1e0b45768e9", "filename": "scripts/quest/3953.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3953.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/3953.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3953.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,7 +46,7 @@ function end(mode, type, selection) {\n             qm.gainItem(4011008, -1);\n             \n             qm.sendNext(\"We're in great trouble, if it is like this. And it really seems like it. If the Royal Cactus Deo has gone insane, Ariant is done for. You, can you do something to defeat Deo? We really need your help now.\");\n-            qm.gainExp(20000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(20000);\n             \n             qm.forceCompleteQuest();\n             qm.dispose();"}, {"sha": "a44563086ffe1df86958d4c106a7d8d6d62d0f16", "filename": "scripts/quest/6033.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/6033.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/6033.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/6033.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -52,7 +52,7 @@ function end(mode, type, selection) {\n             var skillid = Math.floor(qm.getPlayer().getJob().getId() / 1000) * 10000000 + 1007;\n             qm.teachSkill(skillid, 2, 3, -1);\n \n-            qm.gainExp(230000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(230000);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "b04c3e9c850ed1e734df845d862899cb9e897dcf", "filename": "scripts/quest/6036.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/6036.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/6036.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/6036.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -54,7 +54,7 @@ function end(mode, type, selection) {\n             var skillid = Math.floor(qm.getPlayer().getJob().getId() / 1000) * 10000000 + 1007;\n             qm.teachSkill(skillid, 3, 3, -1);\n \n-            qm.gainExp(300000 * qm.getPlayer().getExpRate());\n+            qm.gainExp(300000);\n             qm.forceCompleteQuest();\n             \n             qm.dispose();"}, {"sha": "d99e0bfd81ad4b3651f67092b2d560391d307dbd", "filename": "scripts/quest/8219.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/8219.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/8219.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/8219.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -49,7 +49,7 @@ function end(mode, type, selection) {\n \telse if (status == 2){\n \t\tif(qm.canHold(3992040, 1)) {\n                     qm.gainItem(3992040, 1);\n-                    qm.gainExp(175000 * qm.getPlayer().getExpRate());\n+                    qm.gainExp(175000);\n                     qm.forceCompleteQuest();\n                 }\n \t\telse {"}, {"sha": "afd261e086294517adc9b7fd17f9cd7d5f0b9fc3", "filename": "scripts/quest/8229.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/8229.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/scripts/quest/8229.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/8229.js?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -55,7 +55,7 @@ function end(mode, type, selection) {\n         }\n     } else if (status == 1){\n         qm.gainItem(4032018, -1);\n-        qm.gainExp(50000 * qm.getPlayer().getExpRate());\n+        qm.gainExp(50000);\n         qm.forceCompleteQuest();\n         \n         qm.dispose();"}, {"sha": "ae84f877d2b78902b37a4b8b752226b407f43c2b", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 216, "deletions": 74, "changes": 290, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -261,7 +261,7 @@\n     private Map<Integer, MapleSummon> summons = new LinkedHashMap<>();\n     private Map<Integer, MapleCoolDownValueHolder> coolDowns = new LinkedHashMap<>();\n     private EnumMap<MapleDisease, Pair<MapleDiseaseValueHolder, MobSkill>> diseases = new EnumMap<>(MapleDisease.class);\n-    private Map<Integer, MapleDoor> doors = new LinkedHashMap<>();\n+    private MapleDoor pdoor = null;\n     private Map<MapleQuest, Long> questExpirations = new LinkedHashMap<>();\n     private ScheduledFuture<?> dragonBloodSchedule;\n     private ScheduledFuture<?> hpDecreaseTask;\n@@ -277,6 +277,7 @@\n     private ScheduledFuture<?> pendantOfSpirit = null; //1122017\n     private Lock chrLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_CHR, true);\n     private Lock effLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_EFF, true);\n+    private Lock evtLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_EVT, true);\n     private Lock petLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PET, true); // for quest tasks as well\n     private Lock prtLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PRT);\n     private Map<Integer, Set<Integer>> excluded = new LinkedHashMap<>();\n@@ -343,7 +344,7 @@ private MapleCharacter() {\n         quests = new LinkedHashMap<>();\n         setPosition(new Point(0, 0));\n         \n-        petLootCd = System.currentTimeMillis();\n+        petLootCd = Server.getInstance().getCurrentTime();\n     }\n     \n     private static MapleJob getJobStyleInternal(int jobid, byte opt) {\n@@ -586,25 +587,7 @@ public int addDojoPointsByMap(int mapid) {\n         }\n         return pts;\n     }\n-\n-    public void addDoor(Integer owner, MapleDoor door) {\n-        chrLock.lock();\n-        try {\n-            doors.put(owner, door);\n-        } finally {\n-            chrLock.unlock();\n-        }\n-    }\n     \n-    public void removeDoor(Integer owner) {\n-        chrLock.lock();\n-        try {\n-            doors.remove(owner);\n-        } finally {\n-            chrLock.unlock();\n-        }\n-    }\n-\n     public void addFame(int famechange) {\n         this.fame += famechange;\n     }\n@@ -889,13 +872,13 @@ public void newClient(MapleClient c) {\n         this.loggedIn = true;\n         c.setAccountName(this.client.getAccountName());//No null's for accountName\n         this.client = c;\n+        this.map = c.getChannelServer().getMapFactory().getMap(getMapId());\n         MaplePortal portal = map.findClosestPlayerSpawnpoint(getPosition());\n         if (portal == null) {\n             portal = map.getPortal(0);\n         }\n         this.setPosition(portal.getPosition());\n         this.initialSpawnPoint = portal.getId();\n-        this.map = c.getChannelServer().getMapFactory().getMap(getMapId());\n     }\n \n     public String getMedalText() {\n@@ -1352,9 +1335,13 @@ public void changeMap(int map, MaplePortal portal) {\n     }\n \n     public void changeMap(MapleMap to) {\n-        changeMap(to, to.getPortal(0));\n+        changeMap(to, 0);\n     }\n \n+    public void changeMap(MapleMap to, int portal) {\n+        changeMap(to, to.getPortal(portal));\n+    }\n+    \n     public void changeMap(final MapleMap target, final MaplePortal pto) {\n         canWarpCounter++;\n         \n@@ -1437,7 +1424,7 @@ private boolean buffMapProtection() {\n         return lastVisited;\n     }\n     \n-    public void updateMapDropsUponPartyOperation(List<MapleCharacter> exPartyMembers) {\n+    public void partyOperationUpdate(MapleParty party, List<MapleCharacter> exPartyMembers) {\n         List<WeakReference<MapleMap>> mapids;\n         \n         petLock.lock();\n@@ -1468,6 +1455,84 @@ public void updateMapDropsUponPartyOperation(List<MapleCharacter> exPartyMembers\n                 mapObj.updatePlayerItemDrops(partyId, id, partyMembers, partyLeaver);\n             }\n         }\n+        \n+        updatePartyTownDoors(party, this, partyLeaver, partyMembers);\n+    }\n+    \n+    private static void addPartyPlayerDoor(MapleCharacter target) {\n+        MapleDoor targetDoor = target.getPlayerDoor();\n+        if(targetDoor != null) {\n+            target.applyPartyDoor(targetDoor, true);\n+        }\n+    }\n+    \n+    private static void removePartyPlayerDoor(MapleParty party, MapleCharacter target) {\n+        target.removePartyDoor(party);\n+    }\n+        \n+    private static void updatePartyTownDoors(MapleParty party, MapleCharacter target, MapleCharacter partyLeaver, List<MapleCharacter> partyMembers) {\n+        if(partyLeaver != null) {\n+            removePartyPlayerDoor(party, target);\n+        } else {\n+            addPartyPlayerDoor(target);\n+        }\n+        \n+        Map<Integer, MapleDoor> partyDoors = null;\n+        if(!partyMembers.isEmpty()) {\n+            partyDoors = party.getDoors();\n+            \n+            for(MapleCharacter pchr : partyMembers) {\n+                MapleDoor door = partyDoors.get(pchr.getId());\n+                if(door != null) {\n+                    door.updateDoorPortal(pchr);\n+                }\n+            }\n+            \n+            for(MapleDoor door : partyDoors.values()) {\n+                for(MapleCharacter pchar : partyMembers) {\n+                    door.getTownDoor().sendDestroyData(pchar.getClient(), true);\n+                }\n+            }\n+            \n+            if(partyLeaver != null) {\n+                Collection<MapleDoor> leaverDoors = partyLeaver.getDoors();\n+                for(MapleDoor door : leaverDoors) {\n+                    for(MapleCharacter pchar : partyMembers) {\n+                        door.getTownDoor().sendDestroyData(pchar.getClient(), true);\n+                    }\n+                }\n+            }\n+            \n+            List<Integer> histMembers = party.getMembersSortedByHistory();\n+            for(Integer chrid : histMembers) {\n+                MapleDoor door = partyDoors.get(chrid);\n+\n+                if(door != null) {\n+                    for(MapleCharacter pchar : partyMembers) {\n+                        door.getTownDoor().sendSpawnData(pchar.getClient());\n+                    }\n+                }\n+            }\n+        }\n+        \n+        if(partyLeaver != null) {\n+            Collection<MapleDoor> leaverDoors = partyLeaver.getDoors();\n+            \n+            if(partyDoors != null) {\n+                for(MapleDoor door : partyDoors.values()) {\n+                    door.getTownDoor().sendDestroyData(partyLeaver.getClient(), true);\n+                }\n+            }\n+            \n+            for(MapleDoor door : leaverDoors) {\n+                door.getTownDoor().sendDestroyData(partyLeaver.getClient(), true);\n+            }\n+            \n+            for(MapleDoor door : leaverDoors) {\n+                door.updateDoorPortal(partyLeaver);\n+                door.getTownDoor().sendSpawnData(partyLeaver.getClient());\n+            }\n+        }\n     }\n     \n     private Integer getVisitedMapIndex(MapleMap map) {\n@@ -2238,10 +2303,12 @@ public void disbandGuild() {\n     }\n \n     public void dispel() {\n-        List<MapleBuffStatValueHolder> mbsvhList = getAllStatups();\n-        for (MapleBuffStatValueHolder mbsvh : mbsvhList) {\n-            if (mbsvh.effect.isSkill()) {\n-                cancelEffect(mbsvh.effect, false, mbsvh.startTime);\n+        if(!(ServerConstants.USE_UNDISPEL_HOLY_SHIELD && this.isActiveBuffedValue(Bishop.HOLY_SHIELD))) {\n+            List<MapleBuffStatValueHolder> mbsvhList = getAllStatups();\n+            for (MapleBuffStatValueHolder mbsvh : mbsvhList) {\n+                if (mbsvh.effect.isSkill()) {\n+                    cancelEffect(mbsvh.effect, false, mbsvh.startTime);\n+                }\n             }\n         }\n     }\n@@ -3376,14 +3443,7 @@ private boolean cancelEffect(MapleStatEffect effect, boolean overwrite, long sta\n         }\n         \n         if (effect.isMagicDoor()) {\n-            MapleDoor destroyDoor;\n-                    \n-            chrLock.lock();\n-            try {\n-                destroyDoor = doors.remove(this.getId());\n-            } finally {\n-                chrLock.unlock();\n-            }\n+            MapleDoor destroyDoor = removePartyDoor(false);\n             \n             if (destroyDoor != null) {\n                 destroyDoor.getTarget().removeMapObject(destroyDoor.getAreaDoor());\n@@ -3392,21 +3452,18 @@ private boolean cancelEffect(MapleStatEffect effect, boolean overwrite, long sta\n                 for (MapleCharacter chr : destroyDoor.getTarget().getCharacters()) {\n                     destroyDoor.getAreaDoor().sendDestroyData(chr.getClient());\n                 }\n-                for (MapleCharacter chr : destroyDoor.getTown().getCharacters()) {\n+                \n+                Collection<MapleCharacter> townChars = destroyDoor.getTown().getCharacters();\n+                for (MapleCharacter chr : townChars) {\n                     destroyDoor.getTownDoor().sendDestroyData(chr.getClient());\n                 }\n-\n-                prtLock.lock();\n-                try {\n-                    if (party != null) {\n-                        for (MaplePartyCharacter partyMembers : party.getMembers()) {\n-                            partyMembers.getPlayer().removeDoor(this.getId());\n-                            partyMembers.removeDoor(this.getId());\n+                if(destroyDoor.getTownPortal().getId() == 0x80) {\n+                    for (MapleCharacter chr : townChars) {\n+                        MapleDoor door = chr.getMainTownDoor();\n+                        if(door != null) {\n+                            destroyDoor.getTownDoor().sendSpawnData(chr.getClient());\n                         }\n-                        silentPartyUpdateInternal();\n                     }\n-                } finally {\n-                    prtLock.unlock();\n                 }\n             }\n         } else if (effect.isMapChair()) {\n@@ -3994,21 +4051,86 @@ public int getDojoStage() {\n         return dojoStage;\n     }\n \n-    public Map<Integer, MapleDoor> getDoors() {\n-        chrLock.lock();\n+    public Collection<MapleDoor> getDoors() {\n+        prtLock.lock();\n         try {\n-            return Collections.unmodifiableMap(doors);\n+            return (party != null ? Collections.unmodifiableCollection(party.getDoors().values()) : (pdoor != null ? Collections.singleton(pdoor) : new LinkedHashSet<MapleDoor>()));\n         } finally {\n-            chrLock.unlock();\n+            prtLock.unlock();\n+        }\n+    }\n+    \n+    public MapleDoor getPlayerDoor() {\n+        prtLock.lock();\n+        try {\n+            return pdoor;\n+        } finally {\n+            prtLock.unlock();\n+        }\n+    }\n+    \n+    public MapleDoor getMainTownDoor() {\n+        for (MapleDoor door : getDoors()) {\n+            if (door.getTownPortal().getId() == 0x80) {\n+                return door;\n+            }\n+        }\n+\n+        return null;\n+    }\n+    \n+    public void applyPartyDoor(MapleDoor door, boolean partyUpdate) {\n+        prtLock.lock();\n+        try {\n+            if (!partyUpdate) {\n+                pdoor = door;\n+            }\n+            \n+            if (party != null) {\n+                party.addDoor(id, door);\n+                silentPartyUpdateInternal();\n+            }\n+        } finally {\n+            prtLock.unlock();\n         }\n     }\n+    \n+    private MapleDoor removePartyDoor(boolean partyUpdate) {\n+        MapleDoor ret = null;\n+        \n+        prtLock.lock();\n+        try {\n+            if (party != null) {\n+                party.removeDoor(id);\n+                silentPartyUpdateInternal();\n+            }\n+            \n+            if (!partyUpdate) {\n+                ret = pdoor;\n+                pdoor = null;\n+            }\n+        } finally {\n+            prtLock.unlock();\n+        }\n+        \n+        return ret;\n+    }\n+    \n+    private void removePartyDoor(MapleParty formerParty) {    // player is no longer registered at this party\n+        formerParty.removeDoor(id);\n+    }\n \n     public int getEnergyBar() {\n         return energybar;\n     }\n \n     public EventInstanceManager getEventInstance() {\n-        return eventInstance;\n+        evtLock.lock();\n+        try {\n+            return eventInstance;\n+        } finally {\n+            evtLock.unlock();\n+        }\n     }\n \n     public void resetExcluded(int petId) {\n@@ -4499,23 +4621,14 @@ public void setPlayerAggro(int mobHash) {\n     }\n     \n     public void resetPlayerAggro() {\n+        if(client.getWorldServer().unregisterDisabledServerMessage(id)) {\n+            client.announceServerMessage();\n+        }\n+        \n         setTargetHpBarHash(0);\n         setTargetHpBarTime(0);\n     }\n     \n-    public int getDoorSlot() {\n-        if(doorSlot == -1) {\n-            prtLock.lock();\n-            try {\n-                doorSlot = (party == null) ? 0 : party.getPartyDoor(this.getId());\n-            } finally {\n-                prtLock.unlock();\n-            }\n-        }\n-        \n-        return doorSlot;\n-    }\n-\n     public MapleMiniGame getMiniGame() {\n         return miniGame;\n     }\n@@ -4750,7 +4863,7 @@ public void closeHiredMerchant(boolean closeMerchant) {\n                 merchant.saveItems(false);\n             } catch (SQLException ex) {\n                 ex.printStackTrace();\n-                System.out.println(\"Error while saving Hired Merchant items.\");\n+                FilePrinter.printError(FilePrinter.EXCEPTION_CAUGHT, \"Error while saving \" + name + \"'s Hired Merchant items.\");\n             }\n         }\n     }\n@@ -5895,9 +6008,11 @@ public static MapleCharacter loadCharacterEntryFromDB(ResultSet rs, List<Item> e\n             ret.jobRank = rs.getInt(\"jobRank\");\n             ret.jobRankMove = rs.getInt(\"jobRankMove\");\n             \n-            MapleInventory inv = ret.inventory[MapleInventoryType.EQUIPPED.ordinal()];\n-            for (Item item : equipped) {\n-                inv.addItemFromDB(item);\n+            if(equipped != null) {  // players can have no equipped items at all, ofc\n+                MapleInventory inv = ret.inventory[MapleInventoryType.EQUIPPED.ordinal()];\n+                for (Item item : equipped) {\n+                    inv.addItemFromDB(item);\n+                }\n             }\n         } catch (SQLException sqle) {\n             sqle.printStackTrace();\n@@ -6641,10 +6756,11 @@ public void receivePartyMemberHP() {\n             if (party != null) {\n                 int channel = client.getChannel();\n                 int mapId = getMapId();\n+                World wserv = Server.getInstance().getWorld(world);\n                 \n                 for (MaplePartyCharacter partychar : party.getMembers()) {\n                     if (partychar.getMapId() == mapId && partychar.getChannel() == channel) {\n-                        MapleCharacter other = Server.getInstance().getWorld(world).getChannel(channel).getPlayerStorage().getCharacterByName(partychar.getName());\n+                        MapleCharacter other = wserv.getChannel(channel).getPlayerStorage().getCharacterById(partychar.getId());\n                         if (other != null) {\n                             client.announce(MaplePacketCreator.updatePartyMemberHP(other.getId(), other.getHp(), other.getMaxHpEquipped()));\n                         }\n@@ -7498,7 +7614,12 @@ public void setEnergyBar(int set) {\n     }\n \n     public void setEventInstance(EventInstanceManager eventInstance) {\n-        this.eventInstance = eventInstance;\n+        evtLock.lock();\n+        try {\n+            this.eventInstance = eventInstance;\n+        } finally {\n+            evtLock.unlock();\n+        }\n     }\n \n     public void setExp(int amount) {\n@@ -7806,7 +7927,22 @@ public void changeName(String name) {\n             e.printStackTrace();\n         }\n     }\n-\n+    \n+    public int getDoorSlot() {\n+        if(doorSlot != -1) return doorSlot;\n+        return fetchDoorSlot();\n+    }\n+    \n+    public int fetchDoorSlot() {\n+        prtLock.lock();\n+        try {\n+            doorSlot = (party == null) ? 0 : party.getPartyDoor(this.getId());\n+            return doorSlot;\n+        } finally {\n+            prtLock.unlock();\n+        }\n+    }\n+    \n     public void setParty(MapleParty p) {\n         prtLock.lock();\n         try {\n@@ -8917,11 +9053,17 @@ public final void empty(final boolean remove) {\n             events = null;\n             party = null;\n             family = null;\n-            client = null;\n-            map = null;\n+            \n+            Server.getInstance().getWorld(world).registerTimedMapObject(new Runnable() {\n+                @Override\n+                public void run() {\n+                    client = null;  // clients still triggers handlers a few times after disconnecting\n+                    map = null;\n+                }\n+            }, 5 * 60 * 1000);\n         }\n     }\n-\n+    \n     public void logOff() {\n         this.loggedIn = false;\n     }"}, {"sha": "6b72a2ba6772481099779919b18af7849a2998af", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 24, "deletions": 4, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -112,6 +112,7 @@\n         private static final Lock loginLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CLIENT_LOGIN, true);\n \tprivate int votePoints;\n \tprivate int voteTime = -1;\n+        private int visibleWorlds;\n \tprivate long lastNpcClick;\n \tprivate long sessionId;\n \n@@ -1268,19 +1269,31 @@ public void setGender(byte m) {\n \t\t}\n \t}\n         \n+        private void announceDisableServerMessage() {\n+            if(!this.getWorldServer().registerDisabledServerMessage(player.getId())) {\n+                announce(MaplePacketCreator.serverMessage(\"\"));\n+            }\n+        }\n+        \n+        public void announceServerMessage() {\n+            announce(MaplePacketCreator.serverMessage(this.getChannelServer().getServerMessage()));\n+        }\n+        \n         public synchronized void announceBossHpBar(MapleMonster mm, final int mobHash, final byte[] packet) {\n                 long timeNow = System.currentTimeMillis();\n                 int targetHash = player.getTargetHpBarHash();\n                 \n                 if(mobHash != targetHash) {\n                         if(timeNow - player.getTargetHpBarTime() >= 5 * 1000) {\n                                 // is there a way to INTERRUPT this annoying thread running on the client that drops the boss bar after some time at every attack?\n+                                announceDisableServerMessage();\n                                 announce(packet);\n                                 \n                                 player.setTargetHpBarHash(mobHash);\n                                 player.setTargetHpBarTime(timeNow);\n                         }\n                 } else {\n+                        announceDisableServerMessage();\n                         announce(packet);\n                         \n                         player.setTargetHpBarTime(timeNow);\n@@ -1311,10 +1324,8 @@ public void changeChannel(int channel) {\n \t\t\treturn;\n                 }\n                 \n-                String[] socket;\n-                try {\n-                        socket = Server.getInstance().getIP(getWorld(), channel).split(\":\");\n-                } catch (Exception e) {\n+                String[] socket = Server.getInstance().getInetSocket(getWorld(), channel);\n+                if(socket == null) {\n                         announce(MaplePacketCreator.serverNotice(1, \"Channel \" + channel + \" is currently disabled. Try another channel.\"));\n                         announce(MaplePacketCreator.enableActions());\n \t\t\treturn;\n@@ -1387,6 +1398,15 @@ public void removeClickedNPC(){\n \t\tlastNpcClick = 0;\n \t}\n         \n+        public int getVisibleWorlds(){\n+\t\treturn visibleWorlds;\n+\t}\n+        \n+        public void requestedServerlist(int worlds) {\n+                visibleWorlds = worlds;\n+                setClickedNPC();\n+        }\n+        \n         public void closePlayerScriptInteractions() {\n                 this.removeClickedNPC();\n                 NPCScriptManager.getInstance().dispose(this);"}, {"sha": "dec4b6f6795036a12e6aa39dfd28ddee118a76e9", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 86, "deletions": 49, "changes": 135, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -2755,7 +2755,7 @@ public static boolean executeHeavenMsCommandLv5(Channel cserv, Server srv, Maple\n         }\n         \n         public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, MapleClient c, String[] sub) { //Admin\n-                MapleCharacter player = c.getPlayer();\n+                final MapleCharacter player = c.getPlayer();\n                 MapleCharacter victim;\n         \n                 switch(sub[0]) {\n@@ -2788,16 +2788,20 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n \t\t\tbyte worldb = Byte.parseByte(sub[1]);\n \t\t\tif (worldb <= (server.getWorldsSize() - 1)) {\n \t\t\t\ttry {\n-\t\t\t\t\tString[] socket = server.getIP(worldb, c.getChannel()).split(\":\");\n-\t\t\t\t\tc.getWorldServer().removePlayer(player);\n-\t\t\t\t\tplayer.getMap().removePlayer(player);//LOL FORGOT THIS ><                    \n-\t\t\t\t\tc.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-\t\t\t\t\tplayer.setWorld(worldb);\n-\t\t\t\t\tplayer.saveCharToDB();//To set the new world :O (true because else 2 player instances are created, one in both worlds)\n-\t\t\t\t\tc.announce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));\n+\t\t\t\t\tString[] socket = server.getInetSocket(worldb, c.getChannel());\n+                                        if(socket != null) {\n+                                                c.getWorldServer().removePlayer(player);\n+                                                player.getMap().removePlayer(player);//LOL FORGOT THIS ><\n+                                                c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+                                                player.setWorld(worldb);\n+                                                player.saveCharToDB();//To set the new world :O (true because else 2 player instances are created, one in both worlds)\n+                                                c.announce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));\n+                                        } else {\n+                                            player.message(\"Error when trying to change worlds, are you sure the world you are trying to warp to has the same amount of channels?\");\n+                                        }\n \t\t\t\t} catch (UnknownHostException | NumberFormatException ex) {\n                                         ex.printStackTrace();\n-\t\t\t\t\tplayer.message(\"Error when trying to change worlds, are you sure the world you are trying to warp to has the same amount of channels?\");\n+\t\t\t\t\tplayer.message(\"Unexpected error when changing worlds, are you sure the world you are trying to warp to has the same amount of channels?\");\n \t\t\t\t}\n \n \t\t\t} else {\n@@ -2863,37 +2867,51 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n                                 break;\n \t\t\t}\n                         \n-                        int worldid = Integer.parseInt(sub[1]);\n-                        \n-                        int chid = Server.getInstance().addChannel(worldid);\n-                        if(chid >= 0) {\n-                            player.dropMessage(5, \"NEW Channel \" + chid + \" successfully deployed on world \" + worldid + \".\");\n-                        } else {\n-                            if(chid == -3) {\n-                                player.dropMessage(5, \"Invalid worldid detected. Channel creation aborted.\");\n-                            } else if(chid == -2) {\n-                                player.dropMessage(5, \"Reached channel limit on worldid \" + worldid + \". Channel creation aborted.\");\n-                            } else if(chid == -1) {\n-                                player.dropMessage(5, \"Error detected when loading the 'world.ini' file. Channel creation aborted.\");\n-                            } else {\n-                                player.dropMessage(5, \"NEW Channel failed to be deployed. Check if the needed port is already in use or other limitations are taking place.\");\n+                        final int worldid = Integer.parseInt(sub[1]);\n+                        \n+                        new Thread(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                int chid = Server.getInstance().addChannel(worldid);\n+                                if(player.isLoggedinWorld()) {\n+                                    if(chid >= 0) {\n+                                        player.dropMessage(5, \"NEW Channel \" + chid + \" successfully deployed on world \" + worldid + \".\");\n+                                    } else {\n+                                        if(chid == -3) {\n+                                            player.dropMessage(5, \"Invalid worldid detected. Channel creation aborted.\");\n+                                        } else if(chid == -2) {\n+                                            player.dropMessage(5, \"Reached channel limit on worldid \" + worldid + \". Channel creation aborted.\");\n+                                        } else if(chid == -1) {\n+                                            player.dropMessage(5, \"Error detected when loading the 'world.ini' file. Channel creation aborted.\");\n+                                        } else {\n+                                            player.dropMessage(5, \"NEW Channel failed to be deployed. Check if the needed port is already in use or other limitations are taking place.\");\n+                                        }\n+                                    }\n+                                }\n                             }\n-                        }\n+                        }).start();\n                         \n                         break;\n                         \n                     case \"addworld\":\n-                        int wid = Server.getInstance().addWorld();\n-                        \n-                        if(wid >= 0) {\n-                            player.dropMessage(5, \"NEW World \" + wid + \" successfully deployed.\");\n-                        } else {\n-                            if(wid == -2) {\n-                                player.dropMessage(5, \"Error detected when loading the 'world.ini' file. World creation aborted.\");\n-                            } else {\n-                                player.dropMessage(5, \"NEW World failed to be deployed. Check if needed ports are already in use or maximum world count has been reached.\");\n+                        new Thread(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                int wid = Server.getInstance().addWorld();\n+                        \n+                                if(player.isLoggedinWorld()) {\n+                                    if(wid >= 0) {\n+                                        player.dropMessage(5, \"NEW World \" + wid + \" successfully deployed.\");\n+                                    } else {\n+                                        if(wid == -2) {\n+                                            player.dropMessage(5, \"Error detected when loading the 'world.ini' file. World creation aborted.\");\n+                                        } else {\n+                                            player.dropMessage(5, \"NEW World failed to be deployed. Check if needed ports are already in use or maximum world count has been reached.\");\n+                                        }\n+                                    }\n+                                }\n                             }\n-                        }\n+                        }).start();\n                         \n                         break;\n                     \n@@ -2903,31 +2921,50 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n                             break;\n \t\t\t}\n                         \n-                        int worldId = Integer.parseInt(sub[1]);\n-                        if(Server.getInstance().removeChannel(worldId)) {\n-                            player.dropMessage(5, \"Successfully removed a channel on World \" + worldId + \". Current channel count: \" + Server.getInstance().getWorld(worldId).getChannelsSize() + \".\");\n-                        } else {\n-                            player.dropMessage(5, \"Failed to remove last Channel on world \" + worldId + \". Check if either that world exists or there are people currently playing there.\");\n-                        }\n+                        final int worldId = Integer.parseInt(sub[1]);\n+                        \n+                        new Thread(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                if(Server.getInstance().removeChannel(worldId)) {\n+                                    if(player.isLoggedinWorld()) {\n+                                        player.dropMessage(5, \"Successfully removed a channel on World \" + worldId + \". Current channel count: \" + Server.getInstance().getWorld(worldId).getChannelsSize() + \".\");\n+                                    }\n+                                } else {\n+                                    if(player.isLoggedinWorld()) {\n+                                        player.dropMessage(5, \"Failed to remove last Channel on world \" + worldId + \". Check if either that world exists or there are people currently playing there.\");\n+                                    }\n+                                }\n+                            }\n+                        }).start();\n                         \n                         break;\n                         \n                     case \"removeworld\":\n-                        int rwid = Server.getInstance().getWorldsSize() - 1;\n+                        final int rwid = Server.getInstance().getWorldsSize() - 1;\n                         if(rwid <= 0) {\n                             player.dropMessage(5, \"Unable to remove world 0.\");\n                             break;\n                         }\n                         \n-                        if(Server.getInstance().removeWorld()) {\n-                            player.dropMessage(5, \"Successfully removed a world. Current world count: \" + Server.getInstance().getWorldsSize() + \".\");\n-                        } else {\n-                            if(rwid < 0) {\n-                                player.dropMessage(5, \"No registered worlds to remove.\");\n-                            } else {\n-                                player.dropMessage(5, \"Failed to remove world \" + rwid + \". Check if there are people currently playing there.\");\n+                        new Thread(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                if(Server.getInstance().removeWorld()) {\n+                                    if(player.isLoggedinWorld()) {\n+                                        player.dropMessage(5, \"Successfully removed a world. Current world count: \" + Server.getInstance().getWorldsSize() + \".\");\n+                                    }\n+                                } else {\n+                                    if(player.isLoggedinWorld()) {\n+                                        if(rwid < 0) {\n+                                            player.dropMessage(5, \"No registered worlds to remove.\");\n+                                        } else {\n+                                            player.dropMessage(5, \"Failed to remove world \" + rwid + \". Check if there are people currently playing there.\");\n+                                        }\n+                                    }\n+                                }\n                             }\n-                        }\n+                        }).start();\n                         \n                         break;\n                         "}, {"sha": "4d6dbd1423fa095bc56fc71e46d38ddcbe36b9af", "filename": "src/client/inventory/MaplePet.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/inventory/MaplePet.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/inventory/MaplePet.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MaplePet.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -222,7 +222,6 @@ public void gainClosenessFullness(MapleCharacter owner, int incCloseness, int in\n         }\n         \n         owner.getMap().broadcastMessage(MaplePacketCreator.commandResponse(owner.getId(), slot, type, enjoyed));\n-        if(owner.getMount() != null) owner.getMap().broadcastMessage(MaplePacketCreator.updateMount(owner.getId(), owner.getMount(), false));\n         saveToDb();\n         \n         Item petz = owner.getInventory(MapleInventoryType.CASH).getItem(getPosition());"}, {"sha": "9b694c7e67c73c8661cc7b25f74f97dc451f19e8", "filename": "src/client/processor/DueyProcessor.java", "status": "modified", "additions": 35, "deletions": 32, "changes": 67, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/processor/DueyProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/client/processor/DueyProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/DueyProcessor.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -355,63 +355,66 @@ public static void dueySendItem(MapleClient c, byte inventId, short itemPos, sho\n                 c.disconnect(true, false);\n                 return;\n             }\n+            \n             int finalcost = mesos + fee;\n-            boolean send = false;\n             if (c.getPlayer().getMeso() >= finalcost) {\n                 int accid = getAccIdFromCNAME(recipient, true);\n                 if (accid != -1) {\n-                    if (accid != c.getAccID()) {\n-                        send = true;\n-                    } else {\n+                    if (accid == c.getAccID()) {\n                         c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SAMEACC_ERROR.getCode()));\n+                        return;\n                     }\n                 } else {\n                     c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_NAME_DOES_NOT_EXIST.getCode()));\n+                    return;\n                 }\n             } else {\n                 c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_NOT_ENOUGH_MESOS.getCode()));\n+                return;\n             }\n \n             MapleClient rClient = null;\n-            \n             int channel = c.getWorldServer().find(recipient);\n             if (channel > -1) {\n                 Channel rcserv = c.getWorldServer().getChannel(channel);\n-                rClient = rcserv.getPlayerStorage().getCharacterByName(recipient).getClient();\n+                if(rcserv != null) {\n+                    MapleCharacter rChr = rcserv.getPlayerStorage().getCharacterByName(recipient);\n+                    if(rChr != null) {\n+                        rClient = rChr.getClient();\n+                    }\n+                }\n             }\n             \n-            if (send) {\n-                if (inventId > 0) {\n-                    MapleInventoryType inv = MapleInventoryType.getByType(inventId);\n-                    Item item = c.getPlayer().getInventory(inv).getItem(itemPos);\n-                    if (item != null && c.getPlayer().getItemQuantity(item.getItemId(), false) >= amount) {\n-                        c.getPlayer().gainMeso(-finalcost, false);\n-                        c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));\n-\n-                        if (ItemConstants.isRechargeable(item.getItemId())) {\n-                            MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, item.getQuantity(), true);\n-                        } else {\n-                            MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, amount, true, false);\n-                        }\n+            if (inventId > 0) {\n+                MapleInventoryType inv = MapleInventoryType.getByType(inventId);\n+                Item item = c.getPlayer().getInventory(inv).getItem(itemPos);\n+                if (item != null && c.getPlayer().getItemQuantity(item.getItemId(), false) >= amount) {\n+                    c.getPlayer().gainMeso(-finalcost, false);\n+                    c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));\n \n-                        MapleKarmaManipulator.toggleKarmaFlagToUntradeable(item);\n-                        addItemToDB(item, amount, mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+                    if (ItemConstants.isRechargeable(item.getItemId())) {\n+                        MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, item.getQuantity(), true);\n                     } else {\n-                        if (item != null) {\n-                            c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_INCORRECT_REQUEST.getCode()));\n-                        }\n-                        return;\n+                        MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, amount, true, false);\n                     }\n-                } else {\n-                    c.getPlayer().gainMeso(-finalcost, false);\n-                    c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));    \n \n-                    addMesoToDB(mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+                    MapleKarmaManipulator.toggleKarmaFlagToUntradeable(item);\n+                    addItemToDB(item, amount, mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+                } else {\n+                    if (item != null) {\n+                        c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_INCORRECT_REQUEST.getCode()));\n+                    }\n+                    return;\n                 }\n+            } else {\n+                c.getPlayer().gainMeso(-finalcost, false);\n+                c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));    \n \n-                if (rClient != null && rClient.isLoggedIn() && !rClient.getPlayer().isAwayFromWorld()) {\n-                    showDueyNotification(rClient, rClient.getPlayer());\n-                }\n+                addMesoToDB(mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+            }\n+\n+            if (rClient != null && rClient.isLoggedIn() && !rClient.getPlayer().isAwayFromWorld()) {\n+                showDueyNotification(rClient, rClient.getPlayer());\n             }\n         } finally {\n             c.unlockClient();"}, {"sha": "a0c0ae08b3182d7eab4ba97a5aed5bfc56fd2fc3", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -72,6 +72,7 @@\n     public static final boolean USE_ENFORCE_UNMERCHABLE_CASH = true;//Forces players to not sell CASH items via merchants.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_PET = true; //Forces players to not sell pets via merchants. (since non-named pets gets dirty name and other possible DB-related issues)\n     public static final boolean USE_ENFORCE_MDOOR_POSITION = false; //Forces mystic door to be spawned near spawnpoints.\n+    public static final boolean USE_SPAWN_LOOT_ON_ANIMATION = false;//Makes loot appear some time after the mob has been killed (following the mob death animation, instead of instantly).\n     public static final boolean USE_ERASE_PERMIT_ON_OPENSHOP = true;//Forces \"shop permit\" item to be consumed when player deploy his/her player shop.\n     public static final boolean USE_ERASE_UNTRADEABLE_DROP = true;  //Forces flagged untradeable items to disappear when dropped.\n     public static final boolean USE_ERASE_PET_ON_EXPIRATION = false;//Forces pets to be removed from inventory when expire time comes, rather than converting it to a doll.\n@@ -81,7 +82,6 @@\n     public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;  //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n     public static final boolean USE_ENABLE_SOLO_EXPEDITIONS = true; //Enables start expeditions with any number of players. This will also bypass all the Zakum prequest.\n     public static final boolean USE_ENABLE_FULL_RESPAWN = true;    //At respawn task, always respawn missing mobs when they're available. Spawn count doesn't depend on how many players are currently there.\n-    public static final boolean USE_SPAWN_LOOT_ON_ANIMATION = false;//Makes loot appear some time after the mob has been killed (following the mob death animation, instead of instantly).\n     \n     //Announcement Configuration\n     public static final boolean USE_ANNOUNCE_SHOPITEMSOLD = false;  //Automatic message sent to owner when an item from the Player Shop or Hired Merchant is sold.\n@@ -154,6 +154,7 @@\n     //Other Skills Configuration\n     public static final boolean USE_FAST_REUSE_HERO_WILL = true;//Greatly reduce cooldown on Hero's Will.\n     public static final boolean USE_ANTI_IMMUNITY_CRASH = true; //Crash skills additionally removes the mob's invincibility buffs.\n+    public static final boolean USE_UNDISPEL_HOLY_SHIELD = true;//Holy shield buff also prevents players from suffering dispel from mobs.\n     \n     //Character Configuration\n     public static final boolean USE_ADD_SLOTS_BY_LEVEL = true;  //Slots are added each 20 levels."}, {"sha": "7a573cd5d56ae6256f52f602e24ecfac9c85ff93", "filename": "src/net/server/Server.java", "status": "modified", "additions": 39, "deletions": 10, "changes": 49, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -60,6 +60,7 @@\n import net.server.worker.CharacterDiseaseWorker;\n import net.server.worker.CouponWorker;\n import net.server.worker.RankingWorker;\n+import net.server.worker.ReleaseLockWorker;\n import net.server.world.World;\n \n import org.apache.mina.core.buffer.IoBuffer;\n@@ -206,7 +207,11 @@ private void loadPlayerNpcMapStepFromDb() {\n     public World getWorld(int id) {\n         wldRLock.lock();\n         try {\n-            return worlds.get(id);\n+            try {\n+                return worlds.get(id);\n+            } catch (IndexOutOfBoundsException e) {\n+                return null;\n+            }\n         } finally {\n             wldRLock.unlock();\n         }\n@@ -231,21 +236,33 @@ public int getWorldsSize() {\n     }\n     \n     public Channel getChannel(int world, int channel) {\n-        return this.getWorld(world).getChannel(channel);\n+        try {\n+            return this.getWorld(world).getChannel(channel);\n+        } catch(NullPointerException npe) {\n+            return null;\n+        }\n     }\n \n     public List<Channel> getChannelsFromWorld(int world) {\n-        return this.getWorld(world).getChannels();\n+        try {\n+            return this.getWorld(world).getChannels();\n+        } catch(NullPointerException npe) {\n+            return new ArrayList<>(0);\n+        }\n     }\n     \n     public List<Channel> getAllChannels() {\n-        List<Channel> channelz = new ArrayList<>();\n-        for (World world : this.getWorlds()) {\n-            for (Channel ch : world.getChannels()) {\n-                channelz.add(ch);\n+        try {\n+            List<Channel> channelz = new ArrayList<>();\n+            for (World world : this.getWorlds()) {\n+                for (Channel ch : world.getChannels()) {\n+                    channelz.add(ch);\n+                }\n             }\n+            return channelz;\n+        } catch(NullPointerException npe) {\n+            return new ArrayList<>(0);\n         }\n-        return channelz;\n     }\n     \n     public Set<Integer> getOpenChannels(int world) {\n@@ -257,7 +274,7 @@ public Channel getChannel(int world, int channel) {\n         }\n     }\n     \n-    public String getIP(int world, int channel) {\n+    private String getIP(int world, int channel) {\n         wldRLock.lock();\n         try {\n             return channels.get(world).get(channel);\n@@ -266,6 +283,15 @@ public String getIP(int world, int channel) {\n         }\n     }\n     \n+    public String[] getInetSocket(int world, int channel) {\n+        try {\n+            return getIP(world, channel).split(\":\");\n+        } catch (Exception e) {\n+            return null;\n+        }\n+    }\n+    \n+    \n     private void dumpData() {\n         wldWLock.lock();\n         try {\n@@ -643,6 +669,7 @@ public void init() {\n         \n         long timeLeft = getTimeLeftForNextHour();\n         tMan.register(new CharacterDiseaseWorker(), ServerConstants.UPDATE_INTERVAL, ServerConstants.UPDATE_INTERVAL);\n+        tMan.register(new ReleaseLockWorker(), 2 * 60 * 1000, 2 * 60 * 1000);\n         tMan.register(new CouponWorker(), ServerConstants.COUPON_INTERVAL, timeLeft);\n         tMan.register(new RankingWorker(), ServerConstants.RANKING_INTERVAL, timeLeft);\n         \n@@ -1149,8 +1176,10 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n     }\n     */\n     \n-    public Pair<Pair<Integer, List<MapleCharacter>>, List<Pair<Integer, List<MapleCharacter>>>> loadAccountCharlist(Integer accountId) {\n+    public Pair<Pair<Integer, List<MapleCharacter>>, List<Pair<Integer, List<MapleCharacter>>>> loadAccountCharlist(Integer accountId, int visibleWorlds) {\n         List<World> wlist = this.getWorlds();\n+        if(wlist.size() > visibleWorlds) wlist = wlist.subList(0, visibleWorlds);\n+        \n         List<Pair<Integer, List<MapleCharacter>>> accChars = new ArrayList<>(wlist.size() + 1);\n         int chrTotal = 0;\n         List<MapleCharacter> lastwchars = null;"}, {"sha": "d76ac16a4ebd1e927e2b08bd91f2929f7f786b34", "filename": "src/net/server/audit/LockCollector.java", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/LockCollector.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/LockCollector.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/LockCollector.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -0,0 +1,75 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.audit;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class LockCollector {\n+    \n+    private static final LockCollector instance = new LockCollector();\n+    \n+    private Map<Runnable, Integer> disposableLocks = new HashMap<>(200);\n+    private final Lock lock = new ReentrantLock(true);\n+    \n+    public static LockCollector getInstance() {\n+        return instance;\n+    }\n+    \n+    public void registerDisposeAction(Runnable r) {\n+        lock.lock();\n+        try {\n+            disposableLocks.put(r, 0);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    public void runLockCollector() {\n+        List<Runnable> toDispose = new ArrayList<>();\n+        \n+        lock.lock();\n+        try {\n+            for(Entry<Runnable, Integer> e : disposableLocks.entrySet()) {\n+                Integer eVal = e.getValue();\n+                if(eVal > 5) {  // updates each 2min\n+                    toDispose.add(e.getKey());\n+                } else {\n+                    disposableLocks.put(e.getKey(), ++eVal);\n+                }\n+            }\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n+        for(Runnable r : toDispose) {\n+            r.run();\n+        }\n+    }\n+}"}, {"sha": "ec49dab816f41a9a9cf5d601bd09c979ef5ecadf", "filename": "src/net/server/audit/ThreadTracker.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/ThreadTracker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/ThreadTracker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/ThreadTracker.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -57,7 +57,7 @@\n     private final Map<Long, AtomicInteger> lockCount = new HashMap<>();\n     private final Map<Long, MonitoredLockType> lockIds = new HashMap<>();\n     private final Map<Long, Long> lockThreads = new HashMap<>();\n-    private final Map<Long, Byte> lockUpdate = new HashMap<>();\n+    private final Map<Long, Integer> lockUpdate = new HashMap<>();\n     \n     private final Map<MonitoredLockType, Map<Long, Integer>> locks = new HashMap<>();\n     ScheduledFuture<?> threadTrackerSchedule;\n@@ -169,8 +169,8 @@ public void accessThreadTracker(boolean update, boolean lock, MonitoredLockType\n \n                     toRemove.clear();\n \n-                    for(Entry<Long, Byte> it : lockUpdate.entrySet()) {\n-                        byte val = (byte)(it.getValue() + 1);\n+                    for(Entry<Long, Integer> it : lockUpdate.entrySet()) {\n+                        int val = it.getValue() + 1;\n \n                         if(val < 60) {\n                             lockUpdate.put(it.getKey(), val);\n@@ -202,7 +202,7 @@ public void accessThreadTracker(boolean update, boolean lock, MonitoredLockType\n                         lockCount.put(lockOid, c);\n                         lockIds.put(lockOid, lockId);\n                         lockThreads.put(lockOid, tid);\n-                        lockUpdate.put(lockOid, (byte) 0);\n+                        lockUpdate.put(lockOid, 0);\n                     }\n                     c.incrementAndGet();\n \n@@ -233,7 +233,7 @@ public void accessThreadTracker(boolean update, boolean lock, MonitoredLockType\n                 else {\n                     AtomicInteger c = lockCount.get(lockOid);\n                     c.decrementAndGet();\n-                    lockUpdate.put(lockOid, (byte) 0);\n+                    lockUpdate.put(lockOid, 0);\n \n                     List<MonitoredLockType> list = threadTracker.get(tid);\n                     for(int i = list.size() - 1; i >= 0; i--) {"}, {"sha": "5d4c57b9f356386977f57e21e8a2a662642def38", "filename": "src/net/server/audit/locks/MonitoredLockType.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/MonitoredLockType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/MonitoredLockType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredLockType.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -30,6 +30,7 @@\n     CHARACTER_EFF,\n     CHARACTER_PET,\n     CHARACTER_PRT,\n+    CHARACTER_EVT,\n     CLIENT,\n     CLIENT_ENCODER,\n     CLIENT_LOGIN,\n@@ -40,6 +41,7 @@\n     SRVHANDLER_TEMP,\n     BUFF_STORAGE,\n     PLAYER_STORAGE,\n+    PLAYER_DOOR,\n     SERVER,\n     SERVER_DISEASES,\n     SERVER_LOGIN,\n@@ -59,7 +61,7 @@\n     GUILD,\n     PARTY,\n     WORLD_PARTY,\n-    WORLD_OWL,\n+    WORLD_SRVMESSAGES,\n     WORLD_PETS,\n     WORLD_CHARS,\n     WORLD_CHANNELS,"}, {"sha": "7fac952520306d716ffbbb227046b9f0ac88091f", "filename": "src/net/server/audit/locks/active/TrackerReadLock.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerReadLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -159,11 +159,13 @@ public MonitoredReadLock dispose() {\n                 timeoutSchedule.cancel(false);\n                 timeoutSchedule = null;\n             }\n+            \n+            reentrantCount.set(Integer.MAX_VALUE);\n         } finally {\n             state.unlock();\n         }\n         \n         //unlock();\n-        return new EmptyReadLock();\n+        return new EmptyReadLock(id);\n     }\n }"}, {"sha": "a96862896d2cf6d28b0962df1bb3d76497ef45f5", "filename": "src/net/server/audit/locks/active/TrackerReentrantLock.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerReentrantLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -46,7 +46,7 @@\n     private final int hashcode;\n     private final Lock state = new ReentrantLock(true);\n     private final AtomicInteger reentrantCount = new AtomicInteger(0);\n-   \n+    \n     public TrackerReentrantLock(MonitoredLockType id) {\n         super();\n         this.id = id;\n@@ -161,11 +161,13 @@ public MonitoredReentrantLock dispose() {\n                 timeoutSchedule.cancel(false);\n                 timeoutSchedule = null;\n             }\n+            \n+            reentrantCount.set(Integer.MAX_VALUE);\n         } finally {\n             state.unlock();\n         }\n         \n         //unlock();\n-        return new EmptyReentrantLock();\n+        return new EmptyReentrantLock(id);\n     }\n }"}, {"sha": "41c9e927453a4e3597bd47f602a65f37443a94c5", "filename": "src/net/server/audit/locks/active/TrackerWriteLock.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/active/TrackerWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerWriteLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -157,11 +157,13 @@ public MonitoredWriteLock dispose() {\n                 timeoutSchedule.cancel(false);\n                 timeoutSchedule = null;\n             }\n+            \n+            reentrantCount.set(Integer.MAX_VALUE);\n         } finally {\n             state.unlock();\n         }\n         \n         //unlock();\n-        return new EmptyWriteLock();\n+        return new EmptyWriteLock(id);\n     }\n }"}, {"sha": "41b427930218dd8da54b18281fc0b9d415ea4d92", "filename": "src/net/server/audit/locks/empty/EmptyReadLock.java", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyReadLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -19,26 +19,56 @@\n */\n package net.server.audit.locks.empty;\n \n+import constants.ServerConstants;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.TimeZone;\n+import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReadLock;\n+import tools.FilePrinter;\n \n /**\n  *\n  * @author RonanLana\n  */\n public class EmptyReadLock implements MonitoredReadLock {\n+    private final MonitoredLockType id;\n+    \n+    public EmptyReadLock(MonitoredLockType type) {\n+        this.id = type;\n+    }\n+    \n+    private static String printThreadStack(StackTraceElement[] list) {\n+        DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n+        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        String df = dateFormat.format(new Date());\n+        \n+        String s = \"\\r\\n\" + df + \"\\r\\n\";\n+        for(int i = 0; i < list.length; i++) {\n+            s += (\"    \" + list[i].toString() + \"\\r\\n\");\n+        }\n+        s += \"----------------------------\";\n+        \n+        return s;\n+    }\n+    \n     @Override\n-    public void lock() {}\n+    public void lock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n+    }\n     \n     @Override\n     public void unlock() {}\n     \n     @Override\n     public boolean tryLock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured try-locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n         return false;\n     }\n     \n     @Override\n     public MonitoredReadLock dispose() {\n-        return null;\n+        return this;\n     }\n }"}, {"sha": "39f62a799fbc7a91f5dd175d4c5fe618a2d232f5", "filename": "src/net/server/audit/locks/empty/EmptyReentrantLock.java", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyReentrantLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -19,26 +19,56 @@\n */\n package net.server.audit.locks.empty;\n \n+import constants.ServerConstants;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.TimeZone;\n+import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n+import tools.FilePrinter;\n \n /**\n  *\n  * @author RonanLana\n  */\n public class EmptyReentrantLock implements MonitoredReentrantLock {\n+    private final MonitoredLockType id;\n+    \n+    public EmptyReentrantLock(MonitoredLockType type) {\n+        this.id = type;\n+    }\n+    \n+    private static String printThreadStack(StackTraceElement[] list) {\n+        DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n+        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        String df = dateFormat.format(new Date());\n+        \n+        String s = \"\\r\\n\" + df + \"\\r\\n\";\n+        for(int i = 0; i < list.length; i++) {\n+            s += (\"    \" + list[i].toString() + \"\\r\\n\");\n+        }\n+        s += \"----------------------------\";\n+        \n+        return s;\n+    }\n+    \n     @Override\n-    public void lock() {}\n+    public void lock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n+    }\n     \n     @Override\n     public void unlock() {}\n     \n     @Override\n     public boolean tryLock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured try-locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n         return false;\n     }\n     \n     @Override\n     public MonitoredReentrantLock dispose() {\n-        return null;\n+        return this;\n     }\n }"}, {"sha": "1fa8b5bf95a4b6f373c815335d56c06e9b9ac9d9", "filename": "src/net/server/audit/locks/empty/EmptyWriteLock.java", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/audit/locks/empty/EmptyWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyWriteLock.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -19,26 +19,56 @@\n */\n package net.server.audit.locks.empty;\n \n+import constants.ServerConstants;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.TimeZone;\n+import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredWriteLock;\n+import tools.FilePrinter;\n \n /**\n  *\n  * @author RonanLana\n  */\n public class EmptyWriteLock implements MonitoredWriteLock {\n+    private final MonitoredLockType id;\n+    \n+    public EmptyWriteLock(MonitoredLockType type) {\n+        this.id = type;\n+    }\n+    \n+    private static String printThreadStack(StackTraceElement[] list) {\n+        DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n+        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        String df = dateFormat.format(new Date());\n+        \n+        String s = \"\\r\\n\" + df + \"\\r\\n\";\n+        for(int i = 0; i < list.length; i++) {\n+            s += (\"    \" + list[i].toString() + \"\\r\\n\");\n+        }\n+        s += \"----------------------------\";\n+        \n+        return s;\n+    }\n+    \n     @Override\n-    public void lock() {}\n+    public void lock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n+    }\n     \n     @Override\n     public void unlock() {}\n     \n     @Override\n     public boolean tryLock() {\n+        FilePrinter.printError(FilePrinter.DISPOSED_LOCKS, \"Captured try-locking tentative on disposed lock \" + id + \":\" + printThreadStack(Thread.currentThread().getStackTrace()));\n         return false;\n     }\n     \n     @Override\n     public MonitoredWriteLock dispose() {\n-        return null;\n+        return this;\n     }\n }"}, {"sha": "d91af5ecc111cf991a1be48c03412f9aa64ff249", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 23, "deletions": 2, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -37,6 +37,7 @@\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n@@ -266,7 +267,22 @@ private void closeChannelSchedules() {\n                 channelSchedulers[i].dispose();\n                 channelSchedulers[i] = null;\n             }\n-            \n+        }\n+        \n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n+        for(int i = 0; i < 4; i++) {\n             faceLock[i] = faceLock[i].dispose();\n         }\n         \n@@ -300,6 +316,10 @@ public void addPlayer(MapleCharacter chr) {\n         players.addPlayer(chr);\n         chr.announce(MaplePacketCreator.serverMessage(serverMessage));\n     }\n+    \n+    public String getServerMessage() {\n+        return serverMessage;\n+    }\n \n     public PlayerStorage getPlayerStorage() {\n         return players;\n@@ -443,6 +463,7 @@ public boolean finishedShutdown() {\n     public void setServerMessage(String message) {\n         this.serverMessage = message;\n         broadcastPacket(MaplePacketCreator.serverMessage(message));\n+        Server.getInstance().getWorld(world).resetDisabledServerMessages();\n     }\n     \n     private static String [] getEvents(){\n@@ -540,7 +561,7 @@ public void resetDojo(int dojoMapId) {\n         resetDojo(dojoMapId, 0);\n     }\n     \n-    private void resetDojo(int dojoMapId, int thisStg) {\n+    public void resetDojo(int dojoMapId, int thisStg) {\n         int slot = getDojoSlot(dojoMapId);\n         this.dojoStage[slot] = thisStg;\n         "}, {"sha": "b2a2ea2888edffa68c37e950f1fc8a0110be6b40", "filename": "src/net/server/channel/handlers/DoorHandler.java", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/DoorHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/DoorHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DoorHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -21,13 +21,11 @@\n */\n package net.server.channel.handlers;\n \n-import java.util.Calendar;\n import client.MapleCharacter;\n import client.MapleClient;\n import net.AbstractMaplePacketHandler;\n import server.maps.MapleDoorObject;\n import server.maps.MapleMapObject;\n-import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -43,10 +41,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         MapleCharacter chr = c.getPlayer();\n         if (chr.isChangingMaps() || chr.isBanned()) {\n-            if(chr.isChangingMaps()) {\n-                FilePrinter.printError(FilePrinter.PORTAL_STUCK + chr.getName() + \".txt\", \"Player \" + chr.getName() + \" got stuck when changing maps (using Mystic Door). Timestamp: \" + Calendar.getInstance().getTime().toString() + \" Last visited mapids: \" + chr.getLastVisitedMapids());\n-            }\n-\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         }"}, {"sha": "5898f96d686cbd511d8a1a795b0f3199e8eda842", "filename": "src/net/server/channel/handlers/EnterCashShopHandler.java", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/EnterCashShopHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/EnterCashShopHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterCashShopHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -45,7 +45,13 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 \n             }\n             \n-            if(MapleMiniDungeonInfo.isDungeonMap(c.getPlayer().getMapId())) {\n+            if(mc.getEventInstance() != null) {\n+                c.announce(MaplePacketCreator.serverNotice(5, \"Entering Cash Shop or MTS are disabled when registered on an event.\"));\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n+            \n+            if(MapleMiniDungeonInfo.isDungeonMap(mc.getMapId())) {\n                 c.announce(MaplePacketCreator.serverNotice(5, \"Changing channels or entering Cash Shop or MTS are disabled when inside a Mini-Dungeon.\"));\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;"}, {"sha": "057b81052a79c708c2cb35ba41d17082a0ce22a9", "filename": "src/net/server/channel/handlers/EnterMTSHandler.java", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/EnterMTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/EnterMTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterMTSHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -58,7 +58,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 return;\n             }\n \n-            if(MapleMiniDungeonInfo.isDungeonMap(c.getPlayer().getMapId())) {\n+            if(chr.getEventInstance() != null) {\n+                c.announce(MaplePacketCreator.serverNotice(5, \"Entering Cash Shop or MTS are disabled when registered on an event.\"));\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n+            \n+            if(MapleMiniDungeonInfo.isDungeonMap(chr.getMapId())) {\n                 c.announce(MaplePacketCreator.serverNotice(5, \"Changing channels or entering Cash Shop or MTS are disabled when inside a Mini-Dungeon.\"));\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;"}, {"sha": "67ee473a184ad1324cc3c325ec93ec1bb31c154c", "filename": "src/net/server/channel/handlers/PartyOperationHandler.java", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PartyOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PartyOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PartyOperationHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -82,9 +82,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     player.setMPC(partyplayer);\n                     player.getMap().addPartyMember(player);\n                     player.silentPartyUpdate();\n-                    c.announce(MaplePacketCreator.partyCreated(partyplayer, party.getId()));\n                     \n-                    player.updateMapDropsUponPartyOperation(null);\n+                    player.partyOperationUpdate(party, null);\n+                    c.announce(MaplePacketCreator.partyCreated(party, partyplayer.getId()));\n                 } else {\n                     c.announce(MaplePacketCreator.serverNotice(5, \"You can't create a party as you are already in one.\"));\n                 }\n@@ -94,7 +94,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 List<MapleCharacter> partymembers = player.getPartyMembers();\n                 \n                 leaveParty(party, partyplayer, c);\n-                player.updateMapDropsUponPartyOperation(partymembers);\n+                player.partyOperationUpdate(party, partymembers);\n                 break;\n             }\n             case 3: { // join\n@@ -110,7 +110,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             player.receivePartyMemberHP();\n                             player.updatePartyMemberHP();\n                             \n-                            player.updateMapDropsUponPartyOperation(null);\n+                            player.partyOperationUpdate(party, null);\n                         } else {\n                             c.announce(MaplePacketCreator.partyStatusMessage(17));\n                         }\n@@ -147,9 +147,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             player.setParty(party);\n                             player.setMPC(partyplayer);\n                             player.getMap().addPartyMember(player);\n-                            c.announce(MaplePacketCreator.partyCreated(partyplayer, party.getId()));\n                             \n-                            player.updateMapDropsUponPartyOperation(null);\n+                            player.partyOperationUpdate(party, null);\n+                            c.announce(MaplePacketCreator.partyCreated(party, partyplayer.getId()));\n                         }\n                         if (party.getMembers().size() < 6) {\n                             invited.getClient().announce(MaplePacketCreator.partyInvite(player));\n@@ -184,7 +184,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             emc.setParty(null);\n                             world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n                             \n-                            emc.updateMapDropsUponPartyOperation(partyMembers);\n+                            emc.partyOperationUpdate(party, partyMembers);\n                         } else {\n                             world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n                         }"}, {"sha": "997ec27e74d3069d8ed5b00113867f28d06cbcc3", "filename": "src/net/server/channel/handlers/PetCommandHandler.java", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PetCommandHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PetCommandHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetCommandHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -54,10 +54,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         if (Randomizer.nextInt(101) <= petCommand.getProbability()) {\n             pet.gainClosenessFullness(chr, petCommand.getIncrease(), 0, command);\n-        }\n-        else {\n+        } else {\n             chr.getMap().broadcastMessage(MaplePacketCreator.commandResponse(chr.getId(), petIndex, command, false));\n-            if(chr.getMount() != null) chr.getMap().broadcastMessage(MaplePacketCreator.updateMount(chr.getId(), chr.getMount(), false));\n         }\n     }\n }"}, {"sha": "88a9e8cc35394bea1b330ffb7e00155c27292755", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -103,12 +103,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int state = c.getLoginState();\n         boolean allowLogin = true;\n         \n-        Channel cserv = c.getChannelServer();\n+        World world = server.getWorld(c.getWorld());\n+        if(world == null) {\n+            c.disconnect(true, false);\n+            return;\n+        }\n+        \n+        Channel cserv = world.getChannel(c.getChannel());\n         if(cserv == null) {\n             c.setChannel(1);\n-            cserv = c.getChannelServer();\n+            cserv = world.getChannel(c.getChannel());\n             \n-            if(cserv == null) {  // world server is out\n+            if(cserv == null) {\n                 c.disconnect(true, false);\n                 return;\n             }\n@@ -136,8 +142,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         c.updateLoginState(MapleClient.LOGIN_LOGGEDIN);\n-\n-        World world = server.getWorld(c.getWorld());\n         \n         cserv.addPlayer(player);\n         world.addPlayer(player);"}, {"sha": "833d5e00588f649705b449759160f72e0eca8d77", "filename": "src/net/server/channel/worker/BaseScheduler.java", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/BaseScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/BaseScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/BaseScheduler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -29,6 +29,7 @@\n import java.util.concurrent.ScheduledFuture;\n \n import net.server.Server;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n@@ -196,6 +197,19 @@ public void dispose() {\n             externalLocks.clear();\n         }\n         \n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n         schedulerLock = schedulerLock.dispose();\n     }\n }"}, {"sha": "f313239c8393fccd60c19ae4fb4a3a5e625e252f", "filename": "src/net/server/channel/worker/MobAnimationScheduler.java", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/MobAnimationScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/MobAnimationScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobAnimationScheduler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -24,6 +24,7 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n@@ -76,7 +77,20 @@ public boolean registerAnimationMode(Integer mobHash, long animationTime) {\n     \n     @Override\n     public void dispose() {\n-        animationLock = animationLock.dispose();\n+        disposeLocks();\n         super.dispose();\n     }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n+        animationLock = animationLock.dispose();\n+    }\n }"}, {"sha": "9a69e891d4d3dfc4eff80e64cdb5f159ab7971b9", "filename": "src/net/server/channel/worker/MobStatusScheduler.java", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/MobStatusScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/channel/worker/MobStatusScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobStatusScheduler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -25,6 +25,7 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n@@ -111,7 +112,20 @@ public void interruptMobStatus(MonsterStatusEffect mse) {\n     \n     @Override\n     public void dispose() {\n-        overtimeStatusLock = overtimeStatusLock.dispose();\n+        disposeLocks();\n         super.dispose();\n     }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n+        overtimeStatusLock = overtimeStatusLock.dispose();\n+    }\n }"}, {"sha": "0601d93336997ca29be0a7260c1e5e10d96cd363", "filename": "src/net/server/handlers/login/CharSelectedHandler.java", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -27,6 +27,7 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -52,7 +53,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         c.setWorld(server.getCharacterWorld(charId));\n-        if(c.getWorldServer().isWorldCapacityFull()) {\n+        World wserv = c.getWorldServer();\n+        if(wserv == null || wserv.isWorldCapacityFull()) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(10));\n+            return;\n+        }\n+        \n+        String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n+        if(socket == null) {\n             c.announce(MaplePacketCreator.getAfterLoginError(10));\n             return;\n         }\n@@ -61,7 +69,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n         server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n         \n-        String[] socket = server.getIP(c.getWorld(), c.getChannel()).split(\":\");\n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n         } catch (UnknownHostException | NumberFormatException e) {"}, {"sha": "b2bdcf7cb5eb5736031a59780c5a999abba78e9c", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -6,6 +6,7 @@\n \n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n@@ -34,16 +35,22 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         \n         if (c.checkPic(pic)) {\n             c.setWorld(server.getCharacterWorld(charId));\n-            if(c.getWorldServer().isWorldCapacityFull()) {\n+            World wserv = c.getWorldServer();\n+            if(wserv == null || wserv.isWorldCapacityFull()) {\n+                c.announce(MaplePacketCreator.getAfterLoginError(10));\n+                return;\n+            }\n+            \n+            String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n+            if(socket == null) {\n                 c.announce(MaplePacketCreator.getAfterLoginError(10));\n                 return;\n             }\n             \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n             server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n-\n-            String[] socket = server.getIP(c.getWorld(), c.getChannel()).split(\":\");\n+            \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n             } catch (UnknownHostException | NumberFormatException e) {"}, {"sha": "72f29c06ca58b6407a39396a86eee555b977e387", "filename": "src/net/server/handlers/login/CharlistRequestHandler.java", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharlistRequestHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/CharlistRequestHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharlistRequestHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -24,6 +24,7 @@\n import client.MapleClient;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -33,14 +34,21 @@\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         slea.readByte();\n         int world = slea.readByte();\n-        c.setWorld(world);\n         \n-        if(Server.getInstance().getWorld(world).isWorldCapacityFull()) {\n+        World wserv = Server.getInstance().getWorld(world);\n+        if(wserv == null || wserv.isWorldCapacityFull()) {\n+            c.announce(MaplePacketCreator.getServerStatus(2));\n+            return;\n+        }\n+        \n+        int channel = slea.readByte() + 1;\n+        if(wserv.getChannel(channel) == null) {\n             c.announce(MaplePacketCreator.getServerStatus(2));\n             return;\n         }\n         \n-        c.setChannel(slea.readByte() + 1);\n+        c.setWorld(world);\n+        c.setChannel(channel);\n         c.sendCharList(world);\n     }\n }\n\\ No newline at end of file"}, {"sha": "3b42cf3b8be21a3120f81fb951a5ef4c7c0f59c1", "filename": "src/net/server/handlers/login/RegisterPicHandler.java", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/RegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/RegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/RegisterPicHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -5,6 +5,7 @@\n \n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n@@ -37,7 +38,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.setPic(pic);\n             \n             c.setWorld(server.getCharacterWorld(charId));\n-            if(c.getWorldServer().isWorldCapacityFull()) {\n+            World wserv = c.getWorldServer();\n+            if(wserv == null || wserv.isWorldCapacityFull()) {\n+                c.announce(MaplePacketCreator.getAfterLoginError(10));\n+                return;\n+            }\n+            \n+            String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n+            if(socket == null) {\n                 c.announce(MaplePacketCreator.getAfterLoginError(10));\n                 return;\n             }\n@@ -46,7 +54,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n             server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n             \n-            String[] socket = server.getIP(c.getWorld(), c.getChannel()).split(\":\");\n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n             } catch (UnknownHostException e) {"}, {"sha": "ba29947a4c015c331e4667416b39e4ee6502ea3f", "filename": "src/net/server/handlers/login/ServerlistRequestHandler.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ServerlistRequestHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ServerlistRequestHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ServerlistRequestHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -23,6 +23,7 @@\n \n import client.MapleClient;\n import constants.GameConstants;\n+import java.util.List;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n import net.server.world.World;\n@@ -34,10 +35,10 @@\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n     \tServer server = Server.getInstance();\n-        server.loadAccountCharacters(c);    // locks the login session until data is recovered from the cache or the DB.\n-        c.setClickedNPC();\n+        List<World> worlds = server.getWorlds();\n+        c.requestedServerlist(worlds.size());\n         \n-        for (World world : server.getWorlds()) {\n+        for (World world : worlds) {\n             c.announce(MaplePacketCreator.getServerList(world.getId(), GameConstants.WORLD_NAMES[world.getId()], world.getFlag(), world.getEventMessage(), world.getChannels()));\n         }\n         c.announce(MaplePacketCreator.getEndOfServerList());"}, {"sha": "b438c82633fad2e99d54f372e250d1508ba4fab1", "filename": "src/net/server/handlers/login/ViewAllCharHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -41,7 +41,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             \n             int accountId = c.getAccID();\n-            Pair<Pair<Integer, List<MapleCharacter>>, List<Pair<Integer, List<MapleCharacter>>>> loginBlob = Server.getInstance().loadAccountCharlist(accountId);\n+            Pair<Pair<Integer, List<MapleCharacter>>, List<Pair<Integer, List<MapleCharacter>>>> loginBlob = Server.getInstance().loadAccountCharlist(accountId, c.getVisibleWorlds());\n             \n             List<Pair<Integer, List<MapleCharacter>>> worldChars = loginBlob.getRight();\n             int chrTotal = loginBlob.getLeft().getLeft();"}, {"sha": "9d3fa458a291c0058ca23f23b7f2b425fc91f7ea", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -6,12 +6,12 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n-public final class ViewAllCharRegisterPicHandler extends AbstractMaplePacketHandler { //Gey class name lol\n-\n+public final class ViewAllCharRegisterPicHandler extends AbstractMaplePacketHandler {\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n@@ -26,7 +26,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         c.setWorld(server.getCharacterWorld(charId));\n-        if(c.getWorldServer().isWorldCapacityFull()) {\n+        World wserv = c.getWorldServer();\n+        if(wserv == null || wserv.isWorldCapacityFull()) {\n             c.announce(MaplePacketCreator.getAfterLoginError(10));\n             return;\n         }\n@@ -45,11 +46,16 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         String pic = slea.readMapleAsciiString();\n         c.setPic(pic);\n         \n+        String[] socket = server.getInetSocket(c.getWorld(), channel);\n+        if (socket == null) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(10));\n+            return;\n+        }\n+        \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n         server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n         \n-        String[] socket = server.getIP(c.getWorld(), channel).split(\":\");\n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n         } catch (UnknownHostException e) {"}, {"sha": "0edce280d293c6a3d0a33bc00c224ad044ad35b8", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -27,6 +27,7 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -45,7 +46,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         c.setWorld(server.getCharacterWorld(charId));\n-        if(c.getWorldServer().isWorldCapacityFull()) {\n+        \n+        World wserv = c.getWorldServer();\n+        if(wserv == null || wserv.isWorldCapacityFull()) {\n             c.announce(MaplePacketCreator.getAfterLoginError(10));\n             return;\n         }\n@@ -58,18 +61,23 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         try {\n-            int channel = Randomizer.rand(1, c.getWorldServer().getChannelsSize());\n+            int channel = Randomizer.rand(1, wserv.getChannelsSize());\n             c.setChannel(channel);\n         } catch (Exception e) {\n             e.printStackTrace();\n             c.setChannel(1);\n         }\n         \n+        String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n+        if(socket == null) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(10));\n+            return;\n+        }\n+        \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n         server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n         \n-        String[] socket = server.getIP(c.getWorld(), c.getChannel()).split(\":\");\n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n         } catch (UnknownHostException e) {"}, {"sha": "3dcc5a2aee338694f82c0b89c9870f87866bad62", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -5,6 +5,7 @@\n \n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.world.World;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -27,7 +28,13 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         c.setWorld(server.getCharacterWorld(charId));\n-        int channel = Randomizer.rand(1, c.getWorldServer().getChannelsSize());\n+        World wserv = c.getWorldServer();\n+        if(wserv == null || wserv.isWorldCapacityFull()) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(10));\n+            return;\n+        }\n+        \n+        int channel = Randomizer.rand(1, wserv.getChannelsSize());\n         c.setChannel(channel);\n         \n         String macs = slea.readMapleAsciiString();\n@@ -38,16 +45,16 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         if (c.checkPic(pic)) {\n-            if(c.getWorldServer().isWorldCapacityFull()) {\n+            String[] socket = server.getInetSocket(c.getWorld(), c.getChannel());\n+            if(socket == null) {\n                 c.announce(MaplePacketCreator.getAfterLoginError(10));\n                 return;\n             }\n             \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n             server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n-\n-            String[] socket = server.getIP(c.getWorld(), c.getChannel()).split(\":\");\n+            \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));\n             } catch (UnknownHostException e) {"}, {"sha": "ee567ee02c6296cdeddec185b8f18b988953f0d5", "filename": "src/net/server/worker/ReleaseLockWorker.java", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/worker/ReleaseLockWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/worker/ReleaseLockWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/ReleaseLockWorker.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -0,0 +1,33 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.worker;\n+\n+import net.server.audit.LockCollector;\n+\n+/**\n+ * @author Ronan\n+ * @info   Thread responsible for expiring locks signalized for dispose.\n+ */\n+public class ReleaseLockWorker implements Runnable {\n+    @Override\n+    public void run() {\n+        LockCollector.getInstance().runLockCollector();\n+    }\n+}"}, {"sha": "aab7456b6450d8aab1994a4e20645db449629313", "filename": "src/net/server/worker/ServerMessageWorker.java", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/worker/ServerMessageWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/worker/ServerMessageWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/ServerMessageWorker.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -0,0 +1,40 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.worker;\n+\n+import net.server.world.World;\n+\n+/**\n+ * @author Ronan\n+ */\n+public class ServerMessageWorker extends BaseWorker implements Runnable {\n+    \n+    @Override\n+    public void run() {\n+        // It's purpose is for tracking whether the player client currently displays a boss HPBar and, if so,\n+        // temporarily disable the server message for that player.\n+        \n+        wserv.runDisabledServerMessagesSchedule();\n+    }\n+    \n+    public ServerMessageWorker(World world) {\n+        super(world);\n+    }\n+}"}, {"sha": "721a5e11319d850b742b2ea3796e6f8602ea53df", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 54, "deletions": 5, "changes": 59, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -30,9 +30,11 @@\n import java.util.Map.Entry;\n import java.util.Map;\n import java.util.Comparator;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.maps.MapleDoor;\n \n public class MapleParty {\n     private int id;\n@@ -44,11 +46,12 @@\n     private Map<Integer, Integer> histMembers = new HashMap<>();\n     private int nextEntry = 0;\n     \n+    private Map<Integer, MapleDoor> doors = new HashMap<>();\n+    \n     private MonitoredReentrantLock lock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.PARTY, true);\n     \n     public MapleParty(int id, MaplePartyCharacter chrfor) {\n         this.leaderId = chrfor.getId();\n-        this.members.add(chrfor);\n         this.id = id;\n     }\n \n@@ -169,7 +172,7 @@ public MaplePartyCharacter getLeader() {\n         }\n     }\n     \n-    public byte getPartyDoor(int cid) {\n+    public List<Integer> getMembersSortedByHistory() {\n         List<Entry<Integer, Integer>> histList;\n         \n         lock.lock();\n@@ -187,16 +190,53 @@ public int compare( Entry<Integer, Integer> o1, Entry<Integer, Integer> o2 )\n                     return ( o1.getValue() ).compareTo( o2.getValue() );\n                 }\n             });\n-\n+        \n+        List<Integer> histSort = new LinkedList<>();\n+        for(Entry<Integer, Integer> e : histList) {\n+            histSort.add(e.getKey());\n+        }\n+        \n+        return histSort;\n+    }\n+    \n+    public byte getPartyDoor(int cid) {\n+        List<Integer> histList = getMembersSortedByHistory();\n         byte slot = 0;\n-        for(Entry<Integer, Integer> e: histList) {\n-            if(e.getKey() == cid) break;\n+        for(Integer e: histList) {\n+            if(e == cid) break;\n             slot++;\n         }\n \n         return slot;\n     }\n     \n+    public void addDoor(Integer owner, MapleDoor door) {\n+        lock.lock();\n+        try {\n+            this.doors.put(owner, door);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    public void removeDoor(Integer owner) {\n+    \tlock.lock();\n+        try {\n+            this.doors.remove(owner);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    public Map<Integer, MapleDoor> getDoors() {\n+    \tlock.lock();\n+        try {\n+            return Collections.unmodifiableMap(doors);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n     public void assignNewLeader(MapleClient c) {\n         World world = c.getWorldServer();\n         MaplePartyCharacter newLeadr = null;\n@@ -216,6 +256,15 @@ public void assignNewLeader(MapleClient c) {\n     }\n     \n     public void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n         lock = lock.dispose();\n     }\n     "}, {"sha": "70d4f50cab3060ad1c5ac8bec4c15dfad8939603", "filename": "src/net/server/world/MaplePartyCharacter.java", "status": "modified", "additions": 0, "deletions": 23, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/MaplePartyCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/MaplePartyCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MaplePartyCharacter.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -21,15 +21,8 @@\n */\n package net.server.world;\n \n-import java.util.Map;\n-import java.util.Map.Entry;\n-import java.util.LinkedHashMap;\n-import java.util.Collection;\n-\n-import server.maps.MapleDoor;\n import client.MapleCharacter;\n import client.MapleJob;\n-import java.util.Collections;\n \n public class MaplePartyCharacter {\n     private String name;\n@@ -38,7 +31,6 @@\n     private int channel, world;\n     private int jobid;\n     private int mapid;\n-    private Map<Integer, MapleDoor> doors = new LinkedHashMap<>();\n     private boolean online;\n     private MapleJob job;\n     private MapleCharacter character;\n@@ -54,9 +46,6 @@ public MaplePartyCharacter(MapleCharacter maplechar) {\n         this.mapid = maplechar.getMapId();\n         this.online = true;\n         this.job = maplechar.getJob();\n-        for (Entry<Integer, MapleDoor> entry : maplechar.getDoors().entrySet()) {\n-            doors.put(entry.getKey(), entry.getValue());\n-        }\n     }\n \n     public MaplePartyCharacter() {\n@@ -118,18 +107,6 @@ public int getJobId() {\n     public int getGuildId() {\n         return character.getGuildId();\n     }\n-\n-    public void addDoor(Integer owner, MapleDoor door) {\n-    \tthis.doors.put(owner, door);\n-    }\n-    \n-    public void removeDoor(Integer owner) {\n-    \tthis.doors.remove(owner);\n-    }\n-    \n-    public Collection<MapleDoor> getDoors() {\n-    \treturn Collections.unmodifiableCollection(doors.values());\n-    }\n     \n     @Override\n     public int hashCode() {"}, {"sha": "8fa3cb2eb883268e5e32ed6b4a84258a50738680", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 130, "deletions": 32, "changes": 162, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -63,12 +63,15 @@\n import server.maps.MaplePlayerShopItem;\n import server.maps.AbstractMapleMapObject;\n import net.server.worker.CharacterAutosaverWorker;\n+import net.server.worker.HiredMerchantWorker;\n import net.server.worker.MountTirednessWorker;\n import net.server.worker.PetFullnessWorker;\n+import net.server.worker.ServerMessageWorker;\n import net.server.worker.TimedMapObjectWorker;\n import net.server.worker.WeddingReservationWorker;\n import net.server.PlayerStorage;\n import net.server.Server;\n+import net.server.audit.LockCollector;\n import net.server.channel.Channel;\n import net.server.channel.CharacterIdChannelPair;\n import net.server.guild.MapleGuild;\n@@ -119,23 +122,26 @@\n     private MonitoredReentrantLock partyLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_PARTY, true);\n     \n     private Map<Integer, Integer> owlSearched = new LinkedHashMap<>();\n-    private MonitoredReentrantLock owlLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_OWL);\n+    private Map<Integer, Integer> disabledServerMessages = new HashMap<>();    // reuse owl lock\n+    private MonitoredReentrantLock srvMessagesLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_SRVMESSAGES);\n+    private ScheduledFuture<?> srvMessagesSchedule;\n     \n     private MonitoredReentrantLock activePetsLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_PETS, true);\n-    private Map<Integer, Byte> activePets = new LinkedHashMap<>();\n+    private Map<Integer, Integer> activePets = new LinkedHashMap<>();\n     private ScheduledFuture<?> petsSchedule;\n     private long petUpdate;\n     \n     private MonitoredReentrantLock activeMountsLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_MOUNTS, true);\n-    private Map<Integer, Byte> activeMounts = new LinkedHashMap<>();\n+    private Map<Integer, Integer> activeMounts = new LinkedHashMap<>();\n     private ScheduledFuture<?> mountsSchedule;\n     private long mountUpdate;\n     \n     private MonitoredReentrantLock activePlayerShopsLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_PSHOPS, true);\n     private Map<Integer, MaplePlayerShop> activePlayerShops = new LinkedHashMap<>();\n     \n     private MonitoredReentrantLock activeMerchantsLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_MERCHS, true);\n-    private Map<Integer, Pair<MapleHiredMerchant, Byte>> activeMerchants = new LinkedHashMap<>();\n+    private Map<Integer, Pair<MapleHiredMerchant, Integer>> activeMerchants = new LinkedHashMap<>();\n+    private ScheduledFuture<?> merchantSchedule;\n     private long merchantUpdate;\n     \n     private Map<Runnable, Long> registeredTimedMapObjects = new LinkedHashMap<>();\n@@ -161,7 +167,9 @@ public World(int world, int flag, String eventmsg, int exprate, int droprate, in\n         \n         TimerManager tman = TimerManager.getInstance();\n         petsSchedule = tman.register(new PetFullnessWorker(this), 60 * 1000, 60 * 1000);\n+        srvMessagesSchedule = tman.register(new ServerMessageWorker(this), 10 * 1000, 10 * 1000);\n         mountsSchedule = tman.register(new MountTirednessWorker(this), 60 * 1000, 60 * 1000);\n+        merchantSchedule = tman.register(new HiredMerchantWorker(this), 10 * 60 * 1000, 10 * 60 * 1000);\n         timedMapObjectsSchedule = tman.register(new TimedMapObjectWorker(this), 60 * 1000, 60 * 1000);\n         charactersSchedule = tman.register(new CharacterAutosaverWorker(this), 60 * 60 * 1000, 60 * 60 * 1000);\n         marriagesSchedule = tman.register(new WeddingReservationWorker(this), ServerConstants.WEDDING_RESERVATION_INTERVAL * 60 * 1000, ServerConstants.WEDDING_RESERVATION_INTERVAL * 60 * 1000);\n@@ -189,7 +197,11 @@ public int getChannelsSize() {\n     public Channel getChannel(int channel) {\n         chnRLock.lock();\n         try {\n-            return channels.get(channel - 1);\n+            try {\n+                return channels.get(channel - 1);\n+            } catch (IndexOutOfBoundsException e) {\n+                return null;\n+            }\n         } finally {\n             chnRLock.unlock();\n         }\n@@ -731,6 +743,7 @@ public MapleParty createParty(MaplePartyCharacter chrfor) {\n             partyLock.unlock();\n         }\n         \n+        party.addMember(chrfor);\n         return party;\n     }\n \n@@ -784,7 +797,7 @@ private void updateParty(MapleParty party, PartyOperation operation, MaplePartyC\n         updateCharacterParty(party, operation, target, partyMembers);\n         \n         for (MaplePartyCharacter partychar : partyMembers) {\n-            MapleCharacter chr = getPlayerStorage().getCharacterByName(partychar.getName());\n+            MapleCharacter chr = getPlayerStorage().getCharacterById(partychar.getId());\n             if (chr != null) {\n                 if (operation == PartyOperation.DISBAND) {\n                     chr.setParty(null);\n@@ -799,7 +812,7 @@ private void updateParty(MapleParty party, PartyOperation operation, MaplePartyC\n         switch (operation) {\n             case LEAVE:\n             case EXPEL:\n-                MapleCharacter chr = getPlayerStorage().getCharacterByName(target.getName());\n+                MapleCharacter chr = getPlayerStorage().getCharacterById(target.getId());\n                 if (chr != null) {\n                     chr.getClient().announce(MaplePacketCreator.updateParty(chr.getClient().getChannel(), party, operation, target));\n                     chr.setParty(null);\n@@ -1126,7 +1139,7 @@ private static Integer getPetKey(MapleCharacter chr, byte petSlot) {    // assum\n     }\n     \n     public void addOwlItemSearch(Integer itemid) {\n-        owlLock.lock();\n+        srvMessagesLock.lock();\n         try {\n             Integer cur = owlSearched.get(itemid);\n             if(cur != null) {\n@@ -1135,7 +1148,7 @@ public void addOwlItemSearch(Integer itemid) {\n                 owlSearched.put(itemid, 1);\n             }\n         } finally {\n-            owlLock.unlock();\n+            srvMessagesLock.unlock();\n         }\n     }\n     \n@@ -1144,7 +1157,7 @@ public void addOwlItemSearch(Integer itemid) {\n             return new ArrayList<>(0);\n         }\n         \n-        owlLock.lock();\n+        srvMessagesLock.lock();\n         try {\n             List<Pair<Integer, Integer>> searchCounts = new ArrayList<>(owlSearched.size());\n             \n@@ -1154,7 +1167,7 @@ public void addOwlItemSearch(Integer itemid) {\n             \n             return searchCounts;\n         } finally {\n-            owlLock.unlock();\n+            srvMessagesLock.unlock();\n         }\n     }\n     \n@@ -1167,7 +1180,7 @@ public void registerPetHunger(MapleCharacter chr, byte petSlot) {\n         \n         activePetsLock.lock();\n         try {\n-            byte initProc;\n+            int initProc;\n             if(System.currentTimeMillis() - petUpdate > 55000) initProc = ServerConstants.PET_EXHAUST_COUNT - 2;\n             else initProc = ServerConstants.PET_EXHAUST_COUNT - 1;\n             \n@@ -1189,7 +1202,7 @@ public void unregisterPetHunger(MapleCharacter chr, byte petSlot) {\n     }\n     \n     public void runPetSchedule() {\n-        Map<Integer, Byte> deployedPets;\n+        Map<Integer, Integer> deployedPets;\n         \n         activePetsLock.lock();\n         try {\n@@ -1199,11 +1212,11 @@ public void runPetSchedule() {\n             activePetsLock.unlock();\n         }\n         \n-        for(Map.Entry<Integer, Byte> dp: deployedPets.entrySet()) {\n+        for(Map.Entry<Integer, Integer> dp: deployedPets.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey() / 4);\n             if(chr == null || !chr.isLoggedinWorld()) continue;\n             \n-            Byte dpVal = (byte)(dp.getValue() + 1);\n+            Integer dpVal = dp.getValue() + 1;\n             if(dpVal == ServerConstants.PET_EXHAUST_COUNT) {\n                 chr.runFullnessSchedule(dp.getKey() % 4);\n                 dpVal = 0;\n@@ -1226,7 +1239,7 @@ public void registerMountHunger(MapleCharacter chr) {\n         Integer key = chr.getId();\n         activeMountsLock.lock();\n         try {\n-            byte initProc;\n+            int initProc;\n             if(System.currentTimeMillis() - mountUpdate > 45000) initProc = ServerConstants.MOUNT_EXHAUST_COUNT - 2;\n             else initProc = ServerConstants.MOUNT_EXHAUST_COUNT - 1;\n             \n@@ -1248,7 +1261,7 @@ public void unregisterMountHunger(MapleCharacter chr) {\n     }\n     \n     public void runMountSchedule() {\n-        Map<Integer, Byte> deployedMounts;\n+        Map<Integer, Integer> deployedMounts;\n         activeMountsLock.lock();\n         try {\n             mountUpdate = System.currentTimeMillis();\n@@ -1257,11 +1270,11 @@ public void runMountSchedule() {\n             activeMountsLock.unlock();\n         }\n         \n-        for(Map.Entry<Integer, Byte> dp: deployedMounts.entrySet()) {\n+        for(Map.Entry<Integer, Integer> dp: deployedMounts.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey());\n             if(chr == null || !chr.isLoggedinWorld()) continue;\n             \n-            Byte dpVal = (byte)(dp.getValue() + 1);\n+            int dpVal = dp.getValue() + 1;\n             if(dpVal == ServerConstants.MOUNT_EXHAUST_COUNT) {\n                 chr.runTirednessSchedule();\n                 dpVal = 0;\n@@ -1320,8 +1333,8 @@ public MaplePlayerShop getPlayerShop(int ownerid) {\n     public void registerHiredMerchant(MapleHiredMerchant hm) {\n         activeMerchantsLock.lock();\n         try {\n-            byte initProc;\n-            if(System.currentTimeMillis() - merchantUpdate > 5 * 60 * 1000) initProc = 1;\n+            int initProc;\n+            if(Server.getInstance().getCurrentTime() - merchantUpdate > 5 * 60 * 1000) initProc = 1;\n             else initProc = 0;\n             \n             activeMerchants.put(hm.getOwnerId(), new Pair<>(hm, initProc));\n@@ -1340,18 +1353,18 @@ public void unregisterHiredMerchant(MapleHiredMerchant hm) {\n     }\n     \n     public void runHiredMerchantSchedule() {\n-        Map<Integer, Pair<MapleHiredMerchant, Byte>> deployedMerchants;\n+        Map<Integer, Pair<MapleHiredMerchant, Integer>> deployedMerchants;\n         activeMerchantsLock.lock();\n         try {\n-            merchantUpdate = System.currentTimeMillis();\n+            merchantUpdate = Server.getInstance().getCurrentTime();\n             deployedMerchants = new LinkedHashMap<>(activeMerchants);\n         \n-            for(Map.Entry<Integer, Pair<MapleHiredMerchant, Byte>> dm: deployedMerchants.entrySet()) {\n-                byte timeOn = dm.getValue().getRight();\n+            for(Map.Entry<Integer, Pair<MapleHiredMerchant, Integer>> dm: deployedMerchants.entrySet()) {\n+                int timeOn = dm.getValue().getRight();\n                 MapleHiredMerchant hm = dm.getValue().getLeft();\n                 \n                 if(timeOn <= 144) {   // 1440 minutes == 24hrs\n-                    activeMerchants.put(hm.getOwnerId(), new Pair<>(dm.getValue().getLeft(), (byte)(timeOn + 1)));\n+                    activeMerchants.put(hm.getOwnerId(), new Pair<>(dm.getValue().getLeft(), timeOn + 1));\n                 } else {\n                     hm.forceClose();\n                     this.getChannel(hm.getChannel()).removeHiredMerchant(hm.getOwnerId());\n@@ -1368,7 +1381,7 @@ public void runHiredMerchantSchedule() {\n         List<MapleHiredMerchant> hmList = new ArrayList<>();\n         activeMerchantsLock.lock();\n         try {\n-            for(Pair<MapleHiredMerchant, Byte> hmp : activeMerchants.values()) {\n+            for(Pair<MapleHiredMerchant, Integer> hmp : activeMerchants.values()) {\n                 MapleHiredMerchant hm = hmp.getLeft();\n                 if(hm.isOpen()) {\n                     hmList.add(hm);\n@@ -1397,7 +1410,7 @@ public MapleHiredMerchant getHiredMerchant(int ownerid) {\n     public void registerTimedMapObject(Runnable r, long duration) {\n         timedMapObjectLock.lock();\n         try {\n-            long expirationTime = System.currentTimeMillis() + duration;\n+            long expirationTime = Server.getInstance().getCurrentTime() + duration;\n             registeredTimedMapObjects.put(r, expirationTime);\n         } finally {\n             timedMapObjectLock.unlock();\n@@ -1409,7 +1422,7 @@ public void runTimedMapObjectSchedule() {\n         \n         timedMapObjectLock.lock();\n         try {\n-            long timeNow = System.currentTimeMillis();\n+            long timeNow = Server.getInstance().getCurrentTime();\n             \n             for(Entry<Runnable, Long> rtmo : registeredTimedMapObjects.entrySet()) {\n                 if(rtmo.getValue() <= timeNow) {\n@@ -1429,6 +1442,68 @@ public void runTimedMapObjectSchedule() {\n         }\n     }\n     \n+    public void resetDisabledServerMessages() {\n+        srvMessagesLock.lock();\n+        try {\n+            disabledServerMessages.clear();\n+        } finally {\n+            srvMessagesLock.unlock();\n+        }\n+    }\n+    \n+    public boolean registerDisabledServerMessage(int chrid) {\n+        srvMessagesLock.lock();\n+        try {\n+            boolean alreadyDisabled = disabledServerMessages.containsKey(chrid);\n+            disabledServerMessages.put(chrid, 0);\n+            \n+            return alreadyDisabled;\n+        } finally {\n+            srvMessagesLock.unlock();\n+        }\n+    }\n+    \n+    public boolean unregisterDisabledServerMessage(int chrid) {\n+        srvMessagesLock.lock();\n+        try {\n+            return disabledServerMessages.remove(chrid) != null;\n+        } finally {\n+            srvMessagesLock.unlock();\n+        }\n+    }\n+    \n+    public void runDisabledServerMessagesSchedule() {\n+        List<Integer> toRemove = new LinkedList<>();\n+        \n+        srvMessagesLock.lock();\n+        try {\n+            for(Entry<Integer, Integer> dsm : disabledServerMessages.entrySet()) {\n+                int b = dsm.getValue();\n+                if(b >= 4) {   // ~35sec duration, 10sec update\n+                    toRemove.add(dsm.getKey());\n+                } else {\n+                    disabledServerMessages.put(dsm.getKey(), ++b);\n+                }\n+            }\n+            \n+            for(Integer chrid : toRemove) {\n+                disabledServerMessages.remove(chrid);\n+            }\n+        } finally {\n+            srvMessagesLock.unlock();\n+        }\n+        \n+        if(!toRemove.isEmpty()) {\n+            for(Integer chrid : toRemove) {\n+                MapleCharacter chr = players.getCharacterById(chrid);\n+\n+                if(chr != null && chr.isLoggedinWorld()) {\n+                    chr.announce(MaplePacketCreator.serverMessage(chr.getClient().getChannelServer().getServerMessage()));\n+                }\n+            }\n+        }\n+    }\n+    \n     public void setPlayerNpcMapStep(int mapid, int step) {\n         setPlayerNpcMapData(mapid, step, -1, false);\n     }\n@@ -1670,7 +1745,7 @@ public void dropMessage(int type, String message) {\n         }\n     }\n     \n-    private void disposeLocks() {\n+    private void clearWorldData() {\n         List<MapleParty> pList;\n         partyLock.lock();\n         try {\n@@ -1683,9 +1758,22 @@ private void disposeLocks() {\n             p.disposeLocks();\n         }\n         \n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n         accountCharsLock = accountCharsLock.dispose();\n         partyLock = partyLock.dispose();\n-        owlLock = owlLock.dispose();\n+        srvMessagesLock = srvMessagesLock.dispose();\n         activePetsLock = activePetsLock.dispose();\n         activeMountsLock = activeMountsLock.dispose();\n         activePlayerShopsLock = activePlayerShopsLock.dispose();\n@@ -1703,11 +1791,21 @@ public final void shutdown() {\n             petsSchedule = null;\n         }\n         \n+        if(srvMessagesSchedule != null) {\n+            srvMessagesSchedule.cancel(false);\n+            srvMessagesSchedule = null;\n+        }\n+        \n         if(mountsSchedule != null) {\n             mountsSchedule.cancel(false);\n             mountsSchedule = null;\n         }\n         \n+        if(merchantSchedule != null) {\n+            merchantSchedule.cancel(false);\n+            merchantSchedule = null;\n+        }\n+        \n         if(timedMapObjectsSchedule != null) {\n             timedMapObjectsSchedule.cancel(false);\n             timedMapObjectsSchedule = null;\n@@ -1726,6 +1824,6 @@ public final void shutdown() {\n         players.disconnectAll();\n         players = null;\n         \n-        disposeLocks();\n+        clearWorldData();\n     }\n }"}, {"sha": "60da8a96fdbb899e7aca7939aa66b42dcf6a808f", "filename": "src/provider/wz/XMLDomMapleData.java", "status": "modified", "additions": 115, "deletions": 100, "changes": 215, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/provider/wz/XMLDomMapleData.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/provider/wz/XMLDomMapleData.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/provider/wz/XMLDomMapleData.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -22,16 +22,13 @@\n package provider.wz;\n \n import constants.GameConstants;\n-import constants.ServerConstants;\n import java.awt.Point;\n import java.io.File;\n import java.io.FileInputStream;\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Iterator;\n import java.util.List;\n-import java.util.Locale;\n-import java.text.NumberFormat;\n import javax.xml.parsers.DocumentBuilder;\n import javax.xml.parsers.DocumentBuilderFactory;\n import javax.xml.parsers.ParserConfigurationException;\n@@ -74,133 +71,151 @@ public MapleData getChildByPath(String path) {\n \t\t\treturn ((MapleData) getParent()).getChildByPath(path.substring(path.indexOf(\"/\") + 1));\n \t\t}\n \n-\t\tNode myNode = node;\n-\t\tfor (int x = 0; x < segments.length; x++) {\n-\t\t\tNodeList childNodes = myNode.getChildNodes();\n-\t\t\tboolean foundChild = false;\n-\t\t\tfor (int i = 0; i < childNodes.getLength(); i++) {\n-\t\t\t\tNode childNode = childNodes.item(i);\n-\t\t\t\tif (childNode.getNodeType() == Node.ELEMENT_NODE && childNode.getAttributes().getNamedItem(\"name\").getNodeValue().equals(segments[x])) {\n-\t\t\t\t\tmyNode = childNode;\n-\t\t\t\t\tfoundChild = true;\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (!foundChild) {\n-\t\t\t\treturn null;\n-\t\t\t}\n-\t\t}\n+                Node myNode;\n+                synchronized (this) {   // the whole XML reading system seems susceptible to give nulls on strenuous read scenarios\n+                        myNode = node;\n+                        for (int x = 0; x < segments.length; x++) {\n+                                NodeList childNodes = myNode.getChildNodes();\n+                                boolean foundChild = false;\n+                                for (int i = 0; i < childNodes.getLength(); i++) {\n+                                        Node childNode = childNodes.item(i);\n+                                        if (childNode.getNodeType() == Node.ELEMENT_NODE && childNode.getAttributes().getNamedItem(\"name\").getNodeValue().equals(segments[x])) {\n+                                                myNode = childNode;\n+                                                foundChild = true;\n+                                                break;\n+                                        }\n+                                }\n+                                if (!foundChild) {\n+                                        return null;\n+                                }\n+                        }\n+                }\n+                \n \t\tXMLDomMapleData ret = new XMLDomMapleData(myNode);\n \t\tret.imageDataDir = new File(imageDataDir, getName() + \"/\" + path).getParentFile();\n \t\treturn ret;\n \t}\n \n \t@Override\n \tpublic List<MapleData> getChildren() {\n-\t\tList<MapleData> ret = new ArrayList<MapleData>();\n-\t\tNodeList childNodes = node.getChildNodes();\n-\t\tfor (int i = 0; i < childNodes.getLength(); i++) {\n-\t\t\tNode childNode = childNodes.item(i);\n-\t\t\tif (childNode.getNodeType() == Node.ELEMENT_NODE) {\n-\t\t\t\tXMLDomMapleData child = new XMLDomMapleData(childNode);\n-\t\t\t\tchild.imageDataDir = new File(imageDataDir, getName());\n-\t\t\t\tret.add(child);\n-\t\t\t}\n-\t\t}\n+\t\tList<MapleData> ret = new ArrayList<>();\n+                synchronized (this) {\n+                        NodeList childNodes = node.getChildNodes();\n+                        for (int i = 0; i < childNodes.getLength(); i++) {\n+                                Node childNode = childNodes.item(i);\n+                                if (childNode.getNodeType() == Node.ELEMENT_NODE) {\n+                                        XMLDomMapleData child = new XMLDomMapleData(childNode);\n+                                        child.imageDataDir = new File(imageDataDir, getName());\n+                                        ret.add(child);\n+                                }\n+                        }\n+                }\n \t\treturn ret;\n \t}\n \n \t@Override\n \tpublic Object getData() {\n-\t\tNamedNodeMap attributes = node.getAttributes();\n-\t\tMapleDataType type = getType();\n-\t\tswitch (type) {\n-                        case DOUBLE:\n-                        case FLOAT:\n-                        case INT:\n-                        case SHORT: {\n-                                String value = attributes.getNamedItem(\"value\").getNodeValue();\n-                                Number nval = GameConstants.parseNumber(value);\n-\n-                                switch (type) {\n-                                        case DOUBLE:\n-                                                return nval.doubleValue();\n-                                        case FLOAT:\n-                                                return nval.floatValue();\n-                                        case INT:\n-                                                return nval.intValue();\n-                                        case SHORT:\n-                                                return nval.shortValue();\n-                                        default:\n-                                                return null;\n+                synchronized (this) {\n+                        NamedNodeMap attributes = node.getAttributes();\n+                        MapleDataType type = getType();\n+                        switch (type) {\n+                                case DOUBLE:\n+                                case FLOAT:\n+                                case INT:\n+                                case SHORT: {\n+                                        String value = attributes.getNamedItem(\"value\").getNodeValue();\n+                                        Number nval = GameConstants.parseNumber(value);\n+\n+                                        switch (type) {\n+                                                case DOUBLE:\n+                                                        return nval.doubleValue();\n+                                                case FLOAT:\n+                                                        return nval.floatValue();\n+                                                case INT:\n+                                                        return nval.intValue();\n+                                                case SHORT:\n+                                                        return nval.shortValue();\n+                                                default:\n+                                                        return null;\n+                                        }\n                                 }\n+                                case STRING:\n+                                case UOL: {\n+                                        String value = attributes.getNamedItem(\"value\").getNodeValue();\n+                                        return value;\n+                                }\n+                                case VECTOR: {\n+                                        String x = attributes.getNamedItem(\"x\").getNodeValue();\n+                                        String y = attributes.getNamedItem(\"y\").getNodeValue();\n+                                        return new Point(Integer.parseInt(x), Integer.parseInt(y));\n+                                }\n+                                case CANVAS: {\n+                                        String width = attributes.getNamedItem(\"width\").getNodeValue();\n+                                        String height = attributes.getNamedItem(\"height\").getNodeValue();\n+                                        return new FileStoredPngMapleCanvas(Integer.parseInt(width), Integer.parseInt(height), new File(\n+                                                        imageDataDir, getName() + \".png\"));\n+                                }\n+                                default:\n+                                        return null;\n                         }\n-                        case STRING:\n-                        case UOL: {\n-                                String value = attributes.getNamedItem(\"value\").getNodeValue();\n-                                return value;\n-                        }\n-                        case VECTOR: {\n-                                String x = attributes.getNamedItem(\"x\").getNodeValue();\n-                                String y = attributes.getNamedItem(\"y\").getNodeValue();\n-                                return new Point(Integer.parseInt(x), Integer.parseInt(y));\n-                        }\n-                        case CANVAS: {\n-                                String width = attributes.getNamedItem(\"width\").getNodeValue();\n-                                String height = attributes.getNamedItem(\"height\").getNodeValue();\n-                                return new FileStoredPngMapleCanvas(Integer.parseInt(width), Integer.parseInt(height), new File(\n-                                                imageDataDir, getName() + \".png\"));\n-                        }\n-                        default:\n-                                return null;\n-\t\t}\n+                }\n \t}\n \n \t@Override\n \tpublic MapleDataType getType() {\n-\t\tString nodeName = node.getNodeName();\n-\t\tif (nodeName.equals(\"imgdir\")) {\n-\t\t\treturn MapleDataType.PROPERTY;\n-\t\t} else if (nodeName.equals(\"canvas\")) {\n-\t\t\treturn MapleDataType.CANVAS;\n-\t\t} else if (nodeName.equals(\"convex\")) {\n-\t\t\treturn MapleDataType.CONVEX;\n-\t\t} else if (nodeName.equals(\"sound\")) {\n-\t\t\treturn MapleDataType.SOUND;\n-\t\t} else if (nodeName.equals(\"uol\")) {\n-\t\t\treturn MapleDataType.UOL;\n-\t\t} else if (nodeName.equals(\"double\")) {\n-\t\t\treturn MapleDataType.DOUBLE;\n-\t\t} else if (nodeName.equals(\"float\")) {\n-\t\t\treturn MapleDataType.FLOAT;\n-\t\t} else if (nodeName.equals(\"int\")) {\n-\t\t\treturn MapleDataType.INT;\n-\t\t} else if (nodeName.equals(\"short\")) {\n-\t\t\treturn MapleDataType.SHORT;\n-\t\t} else if (nodeName.equals(\"string\")) {\n-\t\t\treturn MapleDataType.STRING;\n-\t\t} else if (nodeName.equals(\"vector\")) {\n-\t\t\treturn MapleDataType.VECTOR;\n-\t\t} else if (nodeName.equals(\"null\")) {\n-\t\t\treturn MapleDataType.IMG_0x00;\n-\t\t}\n+                String nodeName;\n+                synchronized(this) {\n+                        nodeName = node.getNodeName();\n+                }\n+\t\t\n+                switch (nodeName) {\n+                    case \"imgdir\":\n+                        return MapleDataType.PROPERTY;\n+                    case \"canvas\":\n+                        return MapleDataType.CANVAS;\n+                    case \"convex\":\n+                        return MapleDataType.CONVEX;\n+                    case \"sound\":\n+                        return MapleDataType.SOUND;\n+                    case \"uol\":\n+                        return MapleDataType.UOL;\n+                    case \"double\":\n+                        return MapleDataType.DOUBLE;\n+                    case \"float\":\n+                        return MapleDataType.FLOAT;\n+                    case \"int\":\n+                        return MapleDataType.INT;\n+                    case \"short\":\n+                        return MapleDataType.SHORT;\n+                    case \"string\":\n+                        return MapleDataType.STRING;\n+                    case \"vector\":\n+                        return MapleDataType.VECTOR;\n+                    case \"null\":\n+                        return MapleDataType.IMG_0x00;\n+                }\n \t\treturn null;\n \t}\n \n \t@Override\n \tpublic MapleDataEntity getParent() {\n-\t\tNode parentNode = node.getParentNode();\n-\t\tif (parentNode.getNodeType() == Node.DOCUMENT_NODE) {\n-\t\t\treturn null;\n-\t\t}\n+                Node parentNode;\n+                synchronized(this) {\n+                        parentNode = node.getParentNode();\n+                        if (parentNode.getNodeType() == Node.DOCUMENT_NODE) {\n+                                return null;\n+                        }\n+                }\n \t\tXMLDomMapleData parentData = new XMLDomMapleData(parentNode);\n \t\tparentData.imageDataDir = imageDataDir.getParentFile();\n \t\treturn parentData;\n \t}\n \n \t@Override\n \tpublic String getName() {\n-\t\treturn node.getAttributes().getNamedItem(\"name\").getNodeValue();\n+                synchronized (this) {\n+                        return node.getAttributes().getNamedItem(\"name\").getNodeValue();\n+                }\n \t}\n \n \t@Override"}, {"sha": "8746f822c46845bf57c7006dc154c262b0f7ee96", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 30, "deletions": 12, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -35,6 +35,7 @@\n import java.util.Iterator;\n import java.util.Properties;\n import javax.script.ScriptException;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n@@ -232,12 +233,11 @@ public void registerPlayer(MapleCharacter chr) {\n                         wL.lock();\n                         try {\n                                 chars.put(chr.getId(), chr);\n+                                chr.setEventInstance(this);\n                         } finally {\n                                 wL.unlock();\n                         }\n                         \n-\t\t\tchr.setEventInstance(this);\n-                        \n                         sL.lock();\n                         try {\n                                 em.getIv().invokeFunction(\"playerEntry\", this, chr);\n@@ -403,14 +403,13 @@ public void unregisterPlayer(MapleCharacter chr) {\n                 wL.lock();\n                 try {\n                         chars.remove(chr.getId());\n+                        chr.setEventInstance(null);\n                 } finally {\n                         wL.unlock();\n                 }\n                 \n                 gridRemove(chr);\n                 dropExclusiveItems(chr);\n-                \n-\t\tchr.setEventInstance(null);\n \t}\n \t\n \tpublic int getPlayerCount() {\n@@ -635,6 +634,13 @@ public int getKillCount(MapleCharacter chr) {\n \t}\n         \n         public void dispose() {\n+                rL.lock();\n+                try {\n+                        for(MapleCharacter chr: chars.values()) chr.setEventInstance(null);\n+                } finally {\n+                        rL.unlock();\n+                }\n+            \n                 Thread t = new Thread( new Runnable() {\n                         @Override\n                         public void run() {\n@@ -645,7 +651,7 @@ public void run() {\n                 t.start();\n         }\n         \n-        public synchronized void dispose(boolean shutdown) {\n+        public synchronized void dispose(boolean shutdown) {    // should not trigger any event script method after disposed\n                 if(disposed) return;\n                 \n                 disposed = true;\n@@ -660,14 +666,12 @@ public synchronized void dispose(boolean shutdown) {\n                         ex.printStackTrace();\n                 }\n \n+                mapFactory.dispose();\n                 wL.lock();\n                 try {\n                         for(MapleCharacter chr: chars.values()) chr.setEventInstance(null);\n                         chars.clear();\n-                        \n                         mobs.clear();\n-                        \n-                        mapFactory.dispose();\n                         mapFactory = null;\n                 } finally {\n                         wL.unlock();\n@@ -696,6 +700,15 @@ public synchronized void dispose(boolean shutdown) {\n \t}\n         \n         private void disposeLocks() {\n+            LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+                @Override\n+                public void run() {\n+                    emptyLocks();\n+                }\n+            });\n+        }\n+        \n+        private void emptyLocks() {\n                 pL = pL.dispose();\n                 sL = sL.dispose();\n         }\n@@ -878,9 +891,9 @@ public boolean isEventLeader(MapleCharacter chr) {\n \t\treturn (chr.getId() == getLeaderId());\n \t}\n         \n-        public final MapleMap getInstanceMap(final int mapid) { //gets instance map from the channelserv\n+        public final MapleMap getInstanceMap(final int mapid) {\n                 if (disposed) {\n-                        return getMapFactory().getMap(mapid);\n+                        return null;\n                 }\n                 mapIds.add(mapid);\n                 return getMapFactory().getMap(mapid);\n@@ -1310,15 +1323,20 @@ public final void showClearEffect(boolean hasGate, int mapId, String mapObj, int\n         }\n         \n         public final void recoverOpenedGate(MapleCharacter chr, int thisMapId) {\n+                Pair<String, Integer> gateData = null;\n+            \n                 rL.lock();\n                 try {\n                         if(openedGates.containsKey(thisMapId)) {\n-                                Pair<String, Integer> gateData = openedGates.get(thisMapId);\n-                                chr.announce(MaplePacketCreator.environmentChange(gateData.getLeft(), gateData.getRight()));\n+                                gateData = openedGates.get(thisMapId);\n                         }\n                 } finally {\n                         rL.unlock();\n                 }\n+                \n+                if(gateData != null) {\n+                        chr.announce(MaplePacketCreator.environmentChange(gateData.getLeft(), gateData.getRight()));\n+                }\n         }\n         \n         public final void giveEventPlayersStageReward(int thisStage) {"}, {"sha": "3ca2b74ea02481614fd8049a5acfc42378655bf4", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 31, "deletions": 7, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -52,6 +52,7 @@\n import java.util.ArrayList;\n import java.util.LinkedList;\n import java.util.Queue;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n@@ -131,6 +132,15 @@ public void cancel() {  // make sure to only call this when there are NO PLAYERS\n     }\n     \n     private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n         lobbyLock = lobbyLock.dispose();\n         queueLock = queueLock.dispose();\n     }\n@@ -333,7 +343,9 @@ public boolean startInstance(int lobbyId, MapleExpedition exped, MapleCharacter\n             \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", leader.getClient().getChannel()));\n             if(eim == null) {\n-                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                if(lobbyId > -1) {\n+                    setLockLobby(lobbyId, false);\n+                }\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n@@ -363,15 +375,21 @@ public boolean startInstance(int lobbyId, MapleCharacter chr, MapleCharacter lea\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n-                if(lobbyId == -1) return false;\n+                if(lobbyId == -1) {\n+                    return false;\n+                }\n             }\n             else {\n-                if(!startLobbyInstance(lobbyId)) return false;\n+                if(!startLobbyInstance(lobbyId)) {\n+                    return false;\n+                }\n             }\n             \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId()));\n             if(eim == null) {\n-                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                if(lobbyId > -1) {\n+                    setLockLobby(lobbyId, false);\n+                }\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n@@ -408,7 +426,9 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, MapleC\n             \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n             if(eim == null) {\n-                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                if(lobbyId > -1) {\n+                    setLockLobby(lobbyId, false);\n+                }\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n@@ -446,7 +466,9 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n             \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId()));\n             if(eim == null) {\n-                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                if(lobbyId > -1) {\n+                    setLockLobby(lobbyId, false);\n+                }\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n@@ -487,7 +509,9 @@ public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr,\n             }\n             \n             if(eim == null) {\n-                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                if(lobbyId > -1) {\n+                    setLockLobby(lobbyId, false);\n+                }\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);"}, {"sha": "665be893845dc2631ebb2bb9df802d84dd91a2e2", "filename": "src/scripting/event/worker/EventScriptScheduler.java", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/worker/EventScriptScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/event/worker/EventScriptScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/worker/EventScriptScheduler.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -28,6 +28,7 @@\n import java.util.concurrent.ScheduledFuture;\n import server.TimerManager;\n import net.server.Server;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n@@ -161,10 +162,23 @@ public void run() {\n                                 schedulerLock.unlock();\n                             }\n                             \n-                            schedulerLock = schedulerLock.dispose();\n+                            disposeLocks();\n                         }\n                     });\n         \n         t.start();\n     }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n+        schedulerLock = schedulerLock.dispose();\n+    }\n }"}, {"sha": "26081fa2c2aa979a08a918ade0e74ffc2d174cb0", "filename": "src/scripting/quest/QuestActionManager.java", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/quest/QuestActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/scripting/quest/QuestActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/quest/QuestActionManager.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -25,6 +25,8 @@\n import scripting.npc.NPCConversationManager;\n import server.MapleItemInformationProvider;\n import server.quest.MapleQuest;\n+import server.quest.actions.ExpAction;\n+import server.quest.actions.MesoAction;\n \n /**\n  *\n@@ -71,6 +73,16 @@ public void completeQuest() {\n         forceCompleteQuest();\n     }\n     \n+    @Override\n+    public void gainExp(int gain) {\n+        ExpAction.runAction(getPlayer(), gain);\n+    }\n+    \n+    @Override\n+    public void gainMeso(int gain) {\n+        MesoAction.runAction(getPlayer(), gain);\n+    }\n+    \n     public String getMedalName() {  // usable only for medal quests (id 299XX)\n         MapleQuest q = MapleQuest.getInstance(quest);\n         return MapleItemInformationProvider.getInstance().getName(q.getMedalRequirement());"}, {"sha": "5576be91f8db3022bc58c8cae89188664b0f3f24", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -897,15 +897,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             MapleDoor door = new MapleDoor(applyto, doorPosition);\n             \n             if(door.getOwnerId() >= 0) {\n-                if (applyto.getParty() != null) {\n-                    for (MaplePartyCharacter partyMember : applyto.getParty().getMembers()) {\n-                        partyMember.getPlayer().addDoor(door.getOwnerId(), door);\n-                        partyMember.addDoor(door.getOwnerId(), door);\n-                    }\n-                    applyto.silentPartyUpdate();\n-                } else {\n-                    applyto.addDoor(door.getOwnerId(), door);\n-                }\n+                applyto.applyPartyDoor(door, false);\n \n                 door.getTarget().spawnDoor(door.getAreaDoor());\n                 door.getTown().spawnDoor(door.getTownDoor());"}, {"sha": "f7bb54ec9dff87c2e9644a97b1dc98d802dc11d3", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -69,6 +69,7 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;\n+import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n@@ -823,10 +824,6 @@ public void sendSpawnData(MapleClient c) {\n         }\n         \n         if (hasBossHPBar()) {\n-            if (this.getMap().countMonster(8810026) > 0 && this.getMap().getId() == 240060200) {\n-                this.getMap().killAllMonsters();\n-                return;\n-            }\n             c.announceBossHpBar(this, this.hashCode(), makeBossHPBarPacket());\n         }\n     }\n@@ -855,12 +852,7 @@ public ElementalEffectiveness getElementalEffectiveness(Element e) {\n             statiLock.unlock();\n         }\n         \n-        monsterLock.lock();\n-        try {\n-            return stats.getEffectiveness(e);\n-        } finally {\n-            monsterLock.unlock();\n-        }\n+        return getMonsterEffectiveness(e);\n     }\n     \n     private ElementalEffectiveness getMonsterEffectiveness(Element e) {\n@@ -1478,6 +1470,15 @@ public final void changeDifficulty(final int difficulty, boolean pqMob) {\n     }\n     \n     public final void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n         externalLock = externalLock.dispose();\n         monsterLock = monsterLock.dispose();\n         statiLock = statiLock.dispose();"}, {"sha": "7da336de0d447ccd5cb3920307d36de2c6fd601e", "filename": "src/server/maps/MapleDoor.java", "status": "modified", "additions": 14, "deletions": 15, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleDoor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleDoor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDoor.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -22,7 +22,6 @@\n package server.maps;\n \n import java.awt.Point;\n-import java.util.List;\n import tools.Pair;\n \n import server.MaplePortal;\n@@ -43,7 +42,7 @@\n     \n     private MapleDoorObject townDoor;\n     private MapleDoorObject areaDoor;\n-\n+    \n     public MapleDoor(MapleCharacter owner, Point targetPosition) {\n         this.ownerId = owner.getId();\n         this.target = owner.getMap();\n@@ -55,11 +54,11 @@ public MapleDoor(MapleCharacter owner, Point targetPosition) {\n             \n             if(posStatus == null) {\n                 this.town = this.target.getReturnMap();\n-                this.townPortal = getDoorPortal(owner.getDoorSlot());\n+                this.townPortal = getTownDoorPortal(owner.getDoorSlot());\n \n                 if(townPortal != null) {\n-                    this.areaDoor = new MapleDoorObject(ownerId, town, target, false, targetPosition, townPortal.getPosition());\n-                    this.townDoor = new MapleDoorObject(ownerId, target, town, true, townPortal.getPosition(), targetPosition);\n+                    this.areaDoor = new MapleDoorObject(ownerId, town, target, townPortal.getId(), targetPosition, townPortal.getPosition());\n+                    this.townDoor = new MapleDoorObject(ownerId, target, town, -1, townPortal.getPosition(), targetPosition);\n \n                     this.areaDoor.setPairOid(this.townDoor.getObjectId());\n                     this.townDoor.setPairOid(this.areaDoor.getObjectId());\n@@ -74,20 +73,20 @@ public MapleDoor(MapleCharacter owner, Point targetPosition) {\n         }\n     }\n     \n-    private MaplePortal getDoorPortal(int slot) {\n-        List<MaplePortal> avail = town.getAvailableDoorPortals();\n+    public void updateDoorPortal(MapleCharacter owner) {\n+        int slot = owner.fetchDoorSlot();\n         \n-        try {\n-            return avail.get(slot);\n-        } catch (IndexOutOfBoundsException e) {\n-            try {\n-                return avail.get(0);\n-            } catch (IndexOutOfBoundsException ex) {\n-                return null;\n-            }\n+        MaplePortal nextTownPortal = getTownDoorPortal(slot);\n+        if(nextTownPortal != null) {\n+            townPortal = nextTownPortal;\n+            areaDoor.update(nextTownPortal.getId(), nextTownPortal.getPosition());\n         }\n     }\n     \n+    private MaplePortal getTownDoorPortal(int doorid) {\n+        return town.getDoorPortal(doorid);\n+    }\n+    \n     public int getOwnerId() {\n         return ownerId;\n     }"}, {"sha": "3dcded4632118ce1b973b0b1b73331dd56c26380", "filename": "src/server/maps/MapleDoorObject.java", "status": "modified", "additions": 64, "deletions": 16, "changes": 80, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleDoorObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleDoorObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDoorObject.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -20,37 +20,78 @@\n package server.maps;\n \n import java.awt.Point;\n+import java.util.concurrent.locks.ReentrantReadWriteLock;\n import client.MapleCharacter;\n import client.MapleClient;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import tools.MaplePacketCreator;\n \n /**\n  *\n  * @author Ronan\n  */\n public class MapleDoorObject extends AbstractMapleMapObject {\n-    private int ownerId;\n+    private final int ownerId;\n     private int pairOid;\n     \n-    private boolean isTown;\n-    private MapleMap from;\n-    private MapleMap to;\n-    private Point toPos;\n+    private final MapleMap from;\n+    private final MapleMap to;\n+    private int linkedPortalId;\n+    private Point linkedPos;\n     \n-    public MapleDoorObject(int owner, MapleMap destination, MapleMap origin, boolean town, Point targetPosition, Point toPosition) {\n+    private final ReentrantReadWriteLock locks = new MonitoredReentrantReadWriteLock(MonitoredLockType.PLAYER_DOOR, true);\n+    private ReentrantReadWriteLock.ReadLock rlock = locks.readLock();\n+    private ReentrantReadWriteLock.WriteLock wlock = locks.writeLock();\n+    \n+    public MapleDoorObject(int owner, MapleMap destination, MapleMap origin, int townPortalId, Point targetPosition, Point toPosition) {\n         super();\n         setPosition(targetPosition);\n         \n         ownerId = owner;\n-        isTown = town;\n+        linkedPortalId = townPortalId;\n         from = origin;\n         to = destination;\n-        toPos = toPosition;\n+        linkedPos = toPosition;\n+    }\n+    \n+    public void update(int townPortalId, Point toPosition) {\n+        wlock.lock();\n+        try {\n+            linkedPortalId = townPortalId;\n+            linkedPos = toPosition;\n+        } finally {\n+            wlock.unlock();\n+        }\n+    }\n+    \n+    private int getLinkedPortalId() {\n+        rlock.lock();\n+        try {\n+            return linkedPortalId;\n+        } finally {\n+            rlock.unlock();\n+        }\n+    }\n+    \n+    private Point getLinkedPortalPosition() {\n+        rlock.lock();\n+        try {\n+            return linkedPos;\n+        } finally {\n+            rlock.unlock();\n+        }\n     }\n     \n     public void warp(final MapleCharacter chr) {\n-        if (chr.getId() == ownerId || (chr.getParty() != null && chr.getParty().getMemberById(ownerId) != null)) {\n-            chr.changeMap(to, toPos);\n+        boolean onParty = chr.getParty() != null;\n+        \n+        if (chr.getId() == ownerId || (onParty && chr.getParty().getMemberById(ownerId) != null)) {\n+            if(!inTown() && !onParty) {\n+                chr.changeMap(to, getLinkedPortalId());\n+            } else {\n+                chr.changeMap(to, getLinkedPortalPosition());\n+            }\n         } else {\n             chr.getClient().announce(MaplePacketCreator.blockedMessage(6));\n             chr.getClient().announce(MaplePacketCreator.enableActions());\n@@ -75,7 +116,14 @@ public void sendDestroyData(MapleClient client) {\n             if (client.getPlayer().getParty() != null && (ownerId == client.getPlayer().getId() || client.getPlayer().getParty().getMemberById(ownerId) != null)) {\n                 client.announce(MaplePacketCreator.partyPortal(999999999, 999999999, new Point(-1, -1)));\n             }\n-            client.announce(MaplePacketCreator.removeDoor(ownerId, isTown));\n+            client.announce(MaplePacketCreator.removeDoor(ownerId, inTown()));\n+        }\n+    }\n+    \n+    public void sendDestroyData(MapleClient client, boolean partyUpdate) {\n+        if (client != null && from.getId() == client.getPlayer().getMapId()) {\n+            client.announce(MaplePacketCreator.partyPortal(999999999, 999999999, new Point(-1, -1)));\n+            client.announce(MaplePacketCreator.removeDoor(ownerId, inTown()));\n         }\n     }\n     \n@@ -92,7 +140,7 @@ public int getPairOid() {\n     }\n     \n     public boolean inTown() {\n-        return isTown;\n+        return getLinkedPortalId() == -1;\n     }\n     \n     public MapleMap getFrom() {\n@@ -104,19 +152,19 @@ public MapleMap getTo() {\n     }\n     \n     public MapleMap getTown() {\n-        return isTown ? from : to;\n+        return inTown() ? from : to;\n     }\n     \n     public MapleMap getArea() {\n-        return !isTown ? from : to;\n+        return !inTown() ? from : to;\n     }\n     \n     public Point getAreaPosition() {\n-        return !isTown ? getPosition() : toPos;\n+        return !inTown() ? getPosition() : getLinkedPortalPosition();\n     }\n     \n     public Point toPosition() {\n-        return toPos;\n+        return getLinkedPortalPosition();\n     }\n     \n     @Override"}, {"sha": "bb030829a35adbf37e13f05785cb2a334d888cbb", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 16, "deletions": 22, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -982,7 +982,7 @@ public void pickItemDrop(byte[] pickupPacket, MapleMapItem mdrop) { // mdrop mus\n     }\n     \n     private static boolean shouldShowQuestItem(MapleCharacter chr, int questid, int itemid) {\n-        return questid <= 0 || (chr.getQuestStatus(questid) == 1 && chr.needQuestItem(questid, itemid));\n+        return questid <= 0 || chr.needQuestItem(questid, itemid);\n     }\n     \n     public void updatePlayerItemDrops(int partyid, int charid, List<MapleCharacter> partyMembers, MapleCharacter partyLeaver) {\n@@ -1462,7 +1462,7 @@ public void destroyReactor(int oid) {\n         removeMapObject(reactor);\n         \n         if (reactor.getDelay() > 0) {\n-            TimerManager.getInstance().schedule(new Runnable() {\n+            registerMapSchedule(new Runnable() {\n                 @Override\n                 public void run() {\n                     respawnReactor(reactor);\n@@ -1857,14 +1857,14 @@ private void applyRemoveAfter(final MapleMonster monster) {\n         final selfDestruction selfDestruction = monster.getStats().selfDestruction();\n         if (monster.getStats().removeAfter() > 0 || selfDestruction != null && selfDestruction.getHp() < 0) {\n             if (selfDestruction == null) {\n-                TimerManager.getInstance().schedule(new Runnable() {\n+                registerMapSchedule(new Runnable() {\n                     @Override\n                     public void run() {\n                         killMonster(monster, null, false);\n                     }\n                 }, monster.getStats().removeAfter() * 1000);\n             } else {\n-                TimerManager.getInstance().schedule(new Runnable() {\n+                registerMapSchedule(new Runnable() {\n                     @Override\n                     public void run() {\n                         killMonster(monster, null, false, selfDestruction.getAction());\n@@ -2037,23 +2037,16 @@ public boolean canSpawn(MapleCharacter chr) {\n         });\n     }\n     \n-    public List<MaplePortal> getAvailableDoorPortals() {\n-        objectRLock.lock();\n-        try {\n-            List<MaplePortal> availablePortals = new ArrayList<>();\n-\n-            for (MaplePortal port : portals.values()) {\n-                if (port.getType() == MaplePortal.DOOR_PORTAL) {\n-                    availablePortals.add(port);\n-                }\n-            }\n-\n-            return availablePortals;\n-        } finally {\n-            objectRLock.unlock();\n+    public MaplePortal getDoorPortal(int doorid) {\n+        MaplePortal doorPortal = portals.get(0x80 + doorid);\n+        if(doorPortal == null) {\n+            FilePrinter.printError(FilePrinter.EXCEPTION, \"[DOOR] \" + mapName + \"(\" + mapid + \") does not contain door portalid \" + doorid);\n+            return portals.get(0x80);\n         }\n+        \n+        return doorPortal;\n     }\n-\n+    \n     public void spawnSummon(final MapleSummon summon) {\n         spawnAndAddRangedMapObject(summon, new DelayedPacketCreation() {\n             @Override\n@@ -2945,7 +2938,7 @@ public MaplePortal getPortal(String portalname) {\n     public MaplePortal getPortal(int portalid) {\n         return portals.get(portalid);\n     }\n-\n+    \n     public void addMapleArea(Rectangle rec) {\n         areas.add(rec);\n     }\n@@ -3323,8 +3316,9 @@ public void run() {\n                             reactor.hitReactor(c);\n \n                             if (reactor.getDelay() > 0) {\n-                                TimerManager tMan = TimerManager.getInstance();\n-                                tMan.schedule(new Runnable() {\n+                                MapleMap reactorMap = reactor.getMap();\n+                                \n+                                reactorMap.getChannelServer().registerOverallAction(reactorMap.getId(), new Runnable() {\n                                     @Override\n                                     public void run() {\n                                         reactor.lockReactor();"}, {"sha": "2a2624bf7fb532f32407cc442e8292b5c389a79a", "filename": "src/server/maps/MapleMapItem.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleMapItem.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/maps/MapleMapItem.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapItem.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -184,7 +184,7 @@ public final MapleMapObjectType getType() {\n     public void sendSpawnData(final MapleClient client) {\n         MapleCharacter chr = client.getPlayer();\n         \n-\tif (questid <= 0 || (chr.getQuestStatus(questid) == 1 && chr.needQuestItem(questid, item.getItemId()))) {\n+\tif (questid <= 0 || chr.needQuestItem(questid, item.getItemId())) {\n \t    this.lockItem();\n             try {\n                 client.announce(MaplePacketCreator.dropItemFromMapObject(chr.getParty() != null, this, null, getPosition(), (byte) 2));"}, {"sha": "7fa62aac6f06cbdeae8595c842bc19238d279959", "filename": "src/server/quest/actions/ExpAction.java", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/quest/actions/ExpAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/quest/actions/ExpAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ExpAction.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -48,14 +48,18 @@ public void processData(MapleData data) {\n \t\n \t@Override\n \tpublic void run(MapleCharacter chr, Integer extSelection) {\n-\t\tif (chr.isBeginnerJob() && chr.getLevel() < 10) {\n-\t\t\tchr.gainExp(exp, true, true);\n+\t\trunAction(chr, exp);\n+\t}\n+        \n+        public static void runAction(MapleCharacter chr, int gain) {\n+                if (chr.isBeginnerJob() && chr.getLevel() < 10) {\n+\t\t\tchr.gainExp(gain, true, true);\n \t\t} else {\n                         if(!ServerConstants.USE_QUEST_RATE) {\n-                                chr.gainExp(exp * chr.getExpRate(), true, true);\n+                                chr.gainExp(gain * chr.getExpRate(), true, true);\n                         } else {\n-                                chr.gainExp(exp * ServerConstants.EXP_RATE * ServerConstants.QUEST_RATE, true, true);\n+                                chr.gainExp(gain * ServerConstants.EXP_RATE * ServerConstants.QUEST_RATE, true, true);\n                         }\n \t\t}\n-\t}\n+        }\n } "}, {"sha": "791c39f3928cc99bb3f0ef79b2463eb3a2baebee", "filename": "src/server/quest/actions/MesoAction.java", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/quest/actions/MesoAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/server/quest/actions/MesoAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/MesoAction.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -49,14 +49,18 @@ public void processData(MapleData data) {\n \t\n \t@Override\n \tpublic void run(MapleCharacter chr, Integer extSelection) {\n-                if(mesos < 0) {\n-                        chr.gainMeso(mesos, true, false, true);\n+                runAction(chr, mesos);\n+\t}\n+        \n+        public static void runAction(MapleCharacter chr, int gain) {\n+                if(gain < 0) {\n+                        chr.gainMeso(gain, true, false, true);\n                 } else {\n                         if(!ServerConstants.USE_QUEST_RATE) {\n-                                chr.gainMeso(mesos * chr.getMesoRate(), true, false, true);\n+                                chr.gainMeso(gain * chr.getMesoRate(), true, false, true);\n                         } else {\n-                                chr.gainMeso(mesos * ServerConstants.MESO_RATE * ServerConstants.QUEST_RATE, true, false, true);\n+                                chr.gainMeso(gain * ServerConstants.MESO_RATE * ServerConstants.QUEST_RATE, true, false, true);\n                         }\n                 }\n-\t}\n+        }\n } "}, {"sha": "95e798e2f8baf8bb815fcb3bebd7e3db10211997", "filename": "src/tools/FilePrinter.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/tools/FilePrinter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/tools/FilePrinter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/FilePrinter.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -49,7 +49,8 @@\n             DEADLOCK_ERROR = \"deadlocks.txt\",\n             DEADLOCK_STACK = \"deadlocks/path.txt\",\n             DEADLOCK_LOCKS = \"deadlocks/locks.txt\",\n-            DEADLOCK_STATE = \"deadlocks/state.txt\";\n+            DEADLOCK_STATE = \"deadlocks/state.txt\",\n+            DISPOSED_LOCKS = \"deadlocks/disposed.txt\";\n     \n     private static final SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd\"); //for file system purposes, it's nice to use yyyy-MM-dd\n     private static final String FILE_PATH = \"logs/\" + sdf.format(Calendar.getInstance().getTime()) + \"/\"; // + sdf.format(Calendar.getInstance().getTime()) + \"/\""}, {"sha": "9735bd1739f9f0f9b8efbcee19ec47669e69bb17", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 28, "deletions": 35, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -628,7 +628,7 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n         public static byte[] getAfterLoginError(int reason) {//same as above o.o\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(8);\n                 mplew.writeShort(SendOpcode.SELECT_CHARACTER_BY_VAC.getValue());\n-                mplew.writeShort(reason);//using other types then stated above = CRASH\n+                mplew.writeShort(reason);//using other types than stated above = CRASH\n                 return mplew.getPacket();\n         }\n \n@@ -677,6 +677,8 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n          * @return the successful authentication packet\n          */\n         public static byte[] getAuthSuccess(MapleClient c) {\n+                Server.getInstance().loadAccountCharacters(c);    // locks the login session until data is recovered from the cache or the DB.\n+            \n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.LOGIN_STATUS.getValue());\n                 mplew.writeInt(0);\n@@ -686,7 +688,7 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n                 \n                 boolean canFly = Server.getInstance().canFly(c.getAccID());\n                 mplew.writeBool((ServerConstants.USE_ENFORCE_ADMIN_ACCOUNT || canFly) ? c.getGMLevel() > 1 : false);    // thanks Steve(kaito1410) for pointing the GM account boolean here\n-                mplew.write((c.getGMLevel() > 1 && canFly) ? 0x80 : 0); // Admin Byte. 0x80,0x40,0x20.. Rubbish.\n+                mplew.write(((ServerConstants.USE_ENFORCE_ADMIN_ACCOUNT || canFly) && c.getGMLevel() > 1) ? 0x80 : 0);  // Admin Byte. 0x80,0x40,0x20.. Rubbish.\n                 mplew.write(0); // Country Code.\n                 \n                 mplew.writeMapleAsciiString(c.getAccountName());\n@@ -3689,27 +3691,23 @@ private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] partyCreated(MaplePartyCharacter partychar, int partyId) {\n+        public static byte[] partyCreated(MapleParty party, int partycharid) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.PARTY_OPERATION.getValue());\n                 mplew.write(8);\n-                mplew.writeInt(partyId);\n-                if (partychar.getDoors().size() > 0) {\n-                        boolean deployedPortal = false;\n-                    \n-                        for (MapleDoor door : partychar.getDoors()) {\n-                                if(door.getOwnerId() == partychar.getId()) {\n-                                        MapleDoorObject mdo = door.getAreaDoor();\n-                                        mplew.writeInt(mdo.getTo().getId());\n-                                        mplew.writeInt(mdo.getFrom().getId());\n-                                        mplew.writeInt(mdo.getPosition().x);\n-                                        mplew.writeInt(mdo.getPosition().y);\n-                                        \n-                                        deployedPortal = true;\n-                                }\n-                        }\n+                mplew.writeInt(party.getId());\n+                \n+                Map<Integer, MapleDoor> partyDoors = party.getDoors();\n+                if (partyDoors.size() > 0) {\n+                        MapleDoor door = partyDoors.get(partycharid);\n                         \n-                        if(!deployedPortal) {\n+                        if(door != null) {\n+                                MapleDoorObject mdo = door.getAreaDoor();\n+                                mplew.writeInt(mdo.getTo().getId());\n+                                mplew.writeInt(mdo.getFrom().getId());\n+                                mplew.writeInt(mdo.getPosition().x);\n+                                mplew.writeInt(mdo.getPosition().y);\n+                        } else {\n                                 mplew.writeInt(999999999);\n                                 mplew.writeInt(999999999);\n                                 mplew.writeInt(0);\n@@ -3798,24 +3796,19 @@ private static void addPartyStatus(int forchannel, MapleParty party, LittleEndia\n                                 lew.writeInt(0);\n                         }\n                 }\n+                \n+                Map<Integer, MapleDoor> partyDoors = party.getDoors();\n                 for (MaplePartyCharacter partychar : partymembers) {\n                         if (partychar.getChannel() == forchannel && !leaving) {\n-                                if (partychar.getDoors().size() > 0) {\n-                                        boolean deployedPortal = false;\n-                                        \n-                                        for (MapleDoor door : partychar.getDoors()) {\n-                                                if(door.getOwnerId() == partychar.getId()) {\n-                                                        MapleDoorObject mdo = door.getTownDoor();\n-                                                        lew.writeInt(mdo.getTown().getId());\n-                                                        lew.writeInt(mdo.getArea().getId());\n-                                                        lew.writeInt(mdo.getPosition().x);\n-                                                        lew.writeInt(mdo.getPosition().y);\n-                                                        \n-                                                        deployedPortal = true;\n-                                                }\n-                                        }\n-                                        \n-                                        if(!deployedPortal) {\n+                                if (partyDoors.size() > 0) {\n+                                        MapleDoor door = partyDoors.get(partychar.getId());\n+                                        if(door != null) {\n+                                                MapleDoorObject mdo = door.getTownDoor();\n+                                                lew.writeInt(mdo.getTown().getId());\n+                                                lew.writeInt(mdo.getArea().getId());\n+                                                lew.writeInt(mdo.getPosition().x);\n+                                                lew.writeInt(mdo.getPosition().y);\n+                                        } else {\n                                                 lew.writeInt(999999999);\n                                                 lew.writeInt(999999999);\n                                                 lew.writeInt(0);"}, {"sha": "e41772117057c996b8d01e59578c365aa773141d", "filename": "wz/Etc.wz/ItemMake.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Etc.wz/ItemMake.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Etc.wz/ItemMake.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Etc.wz/ItemMake.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -8702,7 +8702,7 @@\n           <int name=\"count\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"1\">\n-          <int name=\"item\" value=\"4260003\"/>\n+          <int name=\"item\" value=\"4260004\"/>\n           <int name=\"count\" value=\"26\"/>\n         </imgdir>\n       </imgdir>"}, {"sha": "52eb310c2925825a184e097308a4513a8ff63998", "filename": "wz/Item.wz/Consume/0204.img.xml", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Item.wz/Consume/0204.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Item.wz/Consume/0204.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Consume/0204.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -2561,6 +2561,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incSTR\" value=\"2\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2579,6 +2580,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incINT\" value=\"2\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2597,6 +2599,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incLUK\" value=\"2\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2615,6 +2618,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incDEX\" value=\"2\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2633,6 +2637,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incMHP\" value=\"30\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2651,6 +2656,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incMMP\" value=\"30\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2669,6 +2675,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incSpeed\" value=\"3\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2687,6 +2694,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incJump\" value=\"5\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2705,6 +2713,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incACC\" value=\"5\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2723,6 +2732,7 @@\n       <int name=\"success\" value=\"30\"/>\n       <int name=\"incEVA\" value=\"5\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2742,6 +2752,7 @@\n       <int name=\"incPDD\" value=\"10\"/>\n       <int name=\"incMDD\" value=\"10\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>\n@@ -2771,6 +2782,7 @@\n       <int name=\"incMHP\" value=\"40\"/>\n       <int name=\"incMMP\" value=\"40\"/>\n       <int name=\"tradeBlock\" value=\"1\"/>\n+      <int name=\"slotMax\" value=\"100\"/>\n     </imgdir>\n     <imgdir name=\"req\">\n       <int name=\"0\" value=\"1072375\"/>"}, {"sha": "ba876f778e267bf96d36359a8c82af30ddb9bbc3", "filename": "wz/Map.wz/Map/Map1/106021400.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map1/106021400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map1/106021400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map1/106021400.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -2423,7 +2423,7 @@\n       <int name=\"delay\" value=\"0\"/>\n     </imgdir>\n     <imgdir name=\"2\">\n-      <string name=\"pn\" value=\"TD_MC_enterboss1\"/>\n+      <string name=\"pn\" value=\"right00\"/>\n       <int name=\"pt\" value=\"7\"/>\n       <int name=\"x\" value=\"268\"/>\n       <int name=\"y\" value=\"-699\"/>"}, {"sha": "e02373cbb09e6fe3f822d4921494436b4d9d5606", "filename": "wz/Map.wz/Map/Map2/250000000.img.xml", "status": "modified", "additions": 8750, "deletions": 8707, "changes": 17457, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map2/250000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map2/250000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/250000000.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa"}, {"sha": "d86ffae50e3a26c5c64999abf9966761b827f4f6", "filename": "wz/Map.wz/Map/Map2/261000000.img.xml", "status": "modified", "additions": 11217, "deletions": 11172, "changes": 22389, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map2/261000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map2/261000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/261000000.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa"}, {"sha": "34ff620cb8c91ab6a4d009f5ecd7eccdb51af470", "filename": "wz/Map.wz/Map/Map6/600000000.img.xml", "status": "modified", "additions": 9171, "deletions": 9120, "changes": 18291, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map6/600000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/Map.wz/Map/Map6/600000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map6/600000000.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa"}, {"sha": "6f616145288082df3c1dd553d046d970e1832c06", "filename": "wz/String.wz/Npc.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/String.wz/Npc.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/4c25c07e28a0b095e4709bef34a14db7c0fa3eaa/wz/String.wz/Npc.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Npc.img.xml?ref=4c25c07e28a0b095e4709bef34a14db7c0fa3eaa", "patch": "@@ -3938,7 +3938,7 @@\n     <string name=\"name\" value=\"Slyn\"/>\n     <string name=\"func\" value=\"Crew\"/>\n     <string name=\"n0\" value=\"We are leaving soon. Wait a moment please.\"/>\n-    <string name=\"n1\" value=\"Please Pay attention to safety onboard.\"/>\n+    <string name=\"n1\" value=\"Please pay attention to safety onboard.\"/>\n   </imgdir>\n   <imgdir name=\"2102002\">\n     <string name=\"name\" value=\"Syras\"/>"}]}]},
