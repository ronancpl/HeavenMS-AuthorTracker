{"fetchDate": "2019-12-19", "content": [{"sha": "de7e686a92be172de4df8974b3139d12e0a46dac", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZGU3ZTY4NmE5MmJlMTcyZGU0ZGY4OTc0YjMxMzlkMTJlMGE0NmRhYw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-09-26T03:18:14Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-09-26T03:18:14Z"}, "message": "Protected Hired Merchant + Buff system patch\n\nFixed some issues with Fredrick not retrieving the right amount of items\nfrom Hired Merchants. Added concurrency protection for HM. Patched a\nminor issue on buff system.", "tree": {"sha": "f34e1a79a41a70d6e2858d44790288bb5fdf33c5", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/f34e1a79a41a70d6e2858d44790288bb5fdf33c5"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/de7e686a92be172de4df8974b3139d12e0a46dac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/de7e686a92be172de4df8974b3139d12e0a46dac", "html_url": "https://github.com/ronancpl/HeavenMS/commit/de7e686a92be172de4df8974b3139d12e0a46dac", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/de7e686a92be172de4df8974b3139d12e0a46dac/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "28258530e4920ad5eb6a12f64d099ed6f64d9f87", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/28258530e4920ad5eb6a12f64d099ed6f64d9f87", "html_url": "https://github.com/ronancpl/HeavenMS/commit/28258530e4920ad5eb6a12f64d099ed6f64d9f87"}], "stats": {"total": 625, "additions": 497, "deletions": 128}, "files": [{"sha": "61c2adeeb436104bad0057eacac3445dcb01c8d0", "filename": "build/built-jar.properties", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/built-jar.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/built-jar.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/built-jar.properties?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -1,4 +1,4 @@\n-#Mon, 25 Sep 2017 01:46:09 -0300\n+#Tue, 26 Sep 2017 00:15:28 -0300\n \n \n C\\:\\\\Nexon\\\\MapleSolaxia\\\\MapleSolaxiaV2="}, {"sha": "6a628387460b84d31c70be54dd1d80ce85949752", "filename": "build/classes/client/MapleCharacter$12.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$12.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$12.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$12.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "d3f52fd50a7e821169aa955ab65613d61270ed20", "filename": "build/classes/client/MapleCharacter$13.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$13.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$13.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$13.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "255c64f4c759a2d5786fbb77c85af1982cde2ff1", "filename": "build/classes/client/MapleCharacter$14.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$14.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$14.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$14.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "fa7d6068674ce65c7071ae408748ef7f9f7e7bf2", "filename": "build/classes/client/MapleCharacter$15.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$15.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$15.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$15.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "1ab3d761bd2de630cebf3581c7302d013ad19be7", "filename": "build/classes/client/MapleCharacter$16.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$16.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$16.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$16.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "a4e3b6e033238379c0c822d8b119c245caae7f80", "filename": "build/classes/client/MapleCharacter$17.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$17.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$17.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$17.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "b6e98f3a0101d21da2b95b26d5136989e51a3681", "filename": "build/classes/client/MapleCharacter$18.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$18.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$18.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$18.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "167759f2c9392f374178d36db23091a7ca5e6aea", "filename": "build/classes/client/MapleCharacter$19.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$19.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$19.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$19.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "9afef495173e30a8e4765c8bbb36eb6dcb625d7e", "filename": "build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "5ad57c5686eeb252bc844aeb9960c7a8efa8dbd2", "filename": "build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "bcc52c1fc71c414cc4a8cd6db3f0a3a7321e4502", "filename": "build/classes/client/MapleCharacter$SkillEntry.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$SkillEntry.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter$SkillEntry.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$SkillEntry.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "bc92c84f4402641ff856ffdef72138bded2ea84d", "filename": "build/classes/client/MapleCharacter.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/MapleCharacter.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "de06d0915bd490926eb62a976a7f4b74a634cd76", "filename": "build/classes/client/inventory/ItemFactory.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/inventory/ItemFactory.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/client/inventory/ItemFactory.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/inventory/ItemFactory.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "0f084b32abd0a8102bca6de2b65c00289e9904f6", "filename": "build/classes/constants/ServerConstants.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/constants/ServerConstants.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/constants/ServerConstants.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/constants/ServerConstants.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "03815bf333fecaf01ba3922b34a187a218c0dce8", "filename": "build/classes/net/server/Server$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/Server$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/Server$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/Server$1.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "22d554a6ab937a7ae2e912342c68f5ea083f17ea", "filename": "build/classes/net/server/Server.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/Server.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/Server.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/Server.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "d2fb39fd7366b274035cab59360b807f6c59337d", "filename": "build/classes/net/server/channel/handlers/HiredMerchantRequest.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/HiredMerchantRequest.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/HiredMerchantRequest.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/HiredMerchantRequest.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "463158ce7a935567a010171c97f448c8e80b4eff", "filename": "build/classes/net/server/channel/handlers/PlayerInteractionHandler$Action.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/PlayerInteractionHandler$Action.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/PlayerInteractionHandler$Action.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/PlayerInteractionHandler$Action.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "92dd331d9e75397f23f5397e3f1d9d2a218c0fba", "filename": "build/classes/net/server/channel/handlers/PlayerInteractionHandler.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/PlayerInteractionHandler.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/PlayerInteractionHandler.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/PlayerInteractionHandler.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "35a4bde059705846c1f2ed515de2f109e32bbf7d", "filename": "build/classes/net/server/channel/handlers/TakeDamageHandler.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/TakeDamageHandler.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/channel/handlers/TakeDamageHandler.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/TakeDamageHandler.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "d522d36d64ffb14949e60fe68d6a1e57889034aa", "filename": "build/classes/net/server/world/World$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/world/World$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/world/World$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/world/World$1.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "22bd854aeda15ba98f86e66ce72bba557418b15f", "filename": "build/classes/net/server/world/World.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/world/World.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/net/server/world/World.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/world/World.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "0f41d3e8e13753e180b2d6dc05ff77e42f98f8b9", "filename": "build/classes/server/maps/HiredMerchant$SoldItem.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/server/maps/HiredMerchant$SoldItem.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/server/maps/HiredMerchant$SoldItem.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/maps/HiredMerchant$SoldItem.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "177d1481fb7b8af9675bb8436f47b24bd815314c", "filename": "build/classes/server/maps/HiredMerchant.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/server/maps/HiredMerchant.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/server/maps/HiredMerchant.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/maps/HiredMerchant.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "f9657fa2386e051d7f8386601f13c460d84e66e9", "filename": "build/classes/tools/MaplePacketCreator.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/tools/MaplePacketCreator.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/build/classes/tools/MaplePacketCreator.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/tools/MaplePacketCreator.class?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "b0954fde1290d2d9d4b51667455f8a441046ad26", "filename": "dist/MapleSolaxia.jar", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/dist/MapleSolaxia.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/dist/MapleSolaxia.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/dist/MapleSolaxia.jar?ref=de7e686a92be172de4df8974b3139d12e0a46dac"}, {"sha": "b4d5d2856e274d73cffa7df37319743ac690171c", "filename": "docs/feature_list.txt", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/docs/feature_list.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/docs/feature_list.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.txt?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -67,6 +67,7 @@ Server potentials:\n * Custom jail system (needs provided custom wz).\n * Delete Character 100% (requires ENABLE_PIC activated).\n * Boats, elevator and other travelling mechanics fully working.\n+* Eanbled Hired Merchant can be used anywhere but FM Entrance.\n * Vega's spell.\n * Pet item ignore.\n * Autosaver (periodically saves on DB current state of every player in-game)."}, {"sha": "453e227721a0a52ca6920a263dd4cd662bf8ead2", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -549,4 +549,8 @@ Consertado GPQ n\n \n 23 Setembro 2017,\n Adicionado Water of Life.\n-Consertado bug com sistema novo de buffs ao entrar no cash shop e em outros cen\ufffdrios onde n\ufffdo se detectava o melhor buff corretamente.\n\\ No newline at end of file\n+Consertado bug com sistema novo de buffs ao entrar no cash shop e em outros cen\ufffdrios onde n\ufffdo se detectava o melhor buff corretamente.\n+\n+25 Setembro 2017,\n+Adicionado prote\ufffd\ufffdo de acesso concorrente a a\ufffd\ufffdes de Hired Merchant.\n+Corrigido alguns problemas com Hired Merchant n\ufffdo retornando a quantidade correta de itens.\n\\ No newline at end of file"}, {"sha": "d11e7eb3df22d60e115e323a8ff7eb31625d7c21", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 25, "deletions": 1, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -2,6 +2,30 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"1\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group/>\n+        <group>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/PlayerLoggedinHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/TakeDamageHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/command/Commands.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/HiredMerchant.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleStatEffect.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/inventory/Item.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/9030000.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleMapObject.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/constants/ExpTable.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/constants/ServerConstants.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/world/World.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/worker/HiredMerchantWorker.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/FredrickHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/PlayerInteractionHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/tools/MaplePacketCreator.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/HiredMerchantRequest.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/AutoAssignHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/inventory/ItemFactory.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/Server.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/npc/NPCConversationManager.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleMap.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/Channel.java</file>\n+        </group>\n     </open-files>\n </project-private>"}, {"sha": "36024833ee44f26ad2f457e95c4a62491d3f29f9", "filename": "sql/db_database.sql", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -12984,6 +12984,15 @@ CREATE TABLE IF NOT EXISTS `inventoryitems` (\n   KEY `CHARID` (`characterid`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n \n+CREATE TABLE IF NOT EXISTS `inventorymerchant` (\n+  `inventorymerchantid` int(10) unsigned NOT NULL AUTO_INCREMENT,\n+  `inventoryitemid` int(10) unsigned NOT NULL DEFAULT '0',\n+  `characterid` int(11) DEFAULT NULL,\n+  `bundles` int(10) NOT NULL DEFAULT '0',\n+  PRIMARY KEY (`inventorymerchantid`),\n+  KEY `INVENTORYITEMID` (`inventoryitemid`)\n+) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n+\n CREATE TABLE IF NOT EXISTS `ipbans` (\n   `ipbanid` int(10) unsigned NOT NULL AUTO_INCREMENT,\n   `ip` varchar(40) NOT NULL DEFAULT '',"}, {"sha": "8578d0642403e9be8be8af8e88bcf60b590b0653", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -2574,7 +2574,7 @@ private void addItemEffectHolder(Integer sourceid, long expirationtime, Map<Mapl\n         buffExpires.put(sourceid, expirationtime);\n     }\n     \n-    private void removeEffectFromItemEffectHolder(Integer sourceid, MapleBuffStat buffStat) {\n+    private boolean removeEffectFromItemEffectHolder(Integer sourceid, MapleBuffStat buffStat) {\n         Map<MapleBuffStat, MapleBuffStatValueHolder> lbe = buffEffects.get(sourceid);\n         \n         if(lbe.remove(buffStat) != null) {        \n@@ -2584,7 +2584,11 @@ private void removeEffectFromItemEffectHolder(Integer sourceid, MapleBuffStat bu\n                 buffEffects.remove(sourceid);\n                 buffExpires.remove(sourceid);\n             }\n+            \n+            return true;\n         }\n+        \n+        return false;\n     }\n     \n     private void removeItemEffectHolder(Integer sourceid) {\n@@ -2634,9 +2638,7 @@ private MapleBuffStatValueHolder fetchBestEffectFromItemEffectHolder(MapleBuffSt\n     private void extractBuffValue(int sourceid, MapleBuffStat stat) {\n         chrLock.lock();\n         try {\n-            if(buffEffects.get(sourceid).remove(stat) != null) {\n-                buffEffectsCount.put(stat, (byte)(buffEffectsCount.get(stat) - 1));\n-            }\n+            removeEffectFromItemEffectHolder(sourceid, stat);\n         } finally {\n             chrLock.unlock();\n         }\n@@ -2755,7 +2757,7 @@ private void dropBuffStats(List<Pair<MapleBuffStat, MapleBuffStatValueHolder>> e\n             for (Entry<MapleBuffStat, MapleBuffStatValueHolder> stat : stats.entrySet()) {\n                 int sourceid = stat.getValue().effect.getBuffSourceId();\n                 \n-                if(buffEffects.get(sourceid) == null) {\n+                if(!buffEffects.containsKey(sourceid)) {\n                     buffExpires.remove(sourceid);\n                 }\n                 \n@@ -6537,10 +6539,15 @@ public void setHasMerchant(boolean set) {\n     }\n \n     public void addMerchantMesos(int add) {\n+        int newAmount;\n+        \n         try {\n+            newAmount = (int)Math.min((long)merchantmeso + add, Integer.MAX_VALUE);\n+            System.out.println(\"adding\" + add + \" now\" + newAmount);\n+            \n             Connection con = DatabaseConnection.getConnection();\n             try (PreparedStatement ps = con.prepareStatement(\"UPDATE characters SET MerchantMesos = ? WHERE id = ?\", Statement.RETURN_GENERATED_KEYS)) {\n-                ps.setInt(1, merchantmeso + add);\n+                ps.setInt(1, newAmount);\n                 ps.setInt(2, id);\n                 ps.executeUpdate();\n             }\n@@ -6550,7 +6557,7 @@ public void addMerchantMesos(int add) {\n             e.printStackTrace();\n             return;\n         }\n-        merchantmeso += add;\n+        merchantmeso = newAmount;\n     }\n \n     public void setMerchantMeso(int set) {"}, {"sha": "6812e63554756c0d89e821c0fbfe2945e1ed079b", "filename": "src/client/inventory/ItemFactory.java", "status": "modified", "additions": 223, "deletions": 1, "changes": 224, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/client/inventory/ItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/client/inventory/ItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ItemFactory.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -57,6 +57,20 @@ public int getValue() {\n     }\n \n     public List<Pair<Item, MapleInventoryType>> loadItems(int id, boolean login) throws SQLException {\n+        if(value != 6) return loadItemsCommon(id, login);\n+        else return loadItemsMerchant(id, login);\n+    }\n+    \n+    public void saveItems(List<Pair<Item, MapleInventoryType>> items, int id, Connection con) throws SQLException {\n+        saveItems(items, null, id, con);\n+    }\n+    \n+    public synchronized void saveItems(List<Pair<Item, MapleInventoryType>> items, List<Short> bundlesList, int id, Connection con) throws SQLException {\n+        if(value != 6) saveItemsCommon(items, id, con);\n+        else saveItemsMerchant(items, bundlesList, id, con);\n+    }\n+    \n+    private List<Pair<Item, MapleInventoryType>> loadItemsCommon(int id, boolean login) throws SQLException {\n         List<Pair<Item, MapleInventoryType>> items = new ArrayList<>();\n \t\t\n         PreparedStatement ps = null;\n@@ -135,7 +149,7 @@ public int getValue() {\n         return items;\n     }\n \n-    public synchronized void saveItems(List<Pair<Item, MapleInventoryType>> items, int id, Connection con) throws SQLException {\n+    private void saveItemsCommon(List<Pair<Item, MapleInventoryType>> items, int id, Connection con) throws SQLException {\n         PreparedStatement ps = null;\n         PreparedStatement pse = null;\n         ResultSet rs = null;\n@@ -227,4 +241,212 @@ public synchronized void saveItems(List<Pair<Item, MapleInventoryType>> items, i\n             lock.unlock();\n         }\n     }\n+    \n+    private List<Pair<Item, MapleInventoryType>> loadItemsMerchant(int id, boolean login) throws SQLException {\n+        List<Pair<Item, MapleInventoryType>> items = new ArrayList<>();\n+\t\t\n+        PreparedStatement ps = null, ps2 = null;\n+        ResultSet rs = null, rs2 = null;\n+        Connection con = DatabaseConnection.getConnection();\n+        try {\n+            StringBuilder query = new StringBuilder();\n+            query.append(\"SELECT * FROM `inventoryitems` LEFT JOIN `inventoryequipment` USING(`inventoryitemid`) WHERE `type` = ? AND `\");\n+            query.append(account ? \"accountid\" : \"characterid\").append(\"` = ?\");\n+\n+            if (login) {\n+                query.append(\" AND `inventorytype` = \").append(MapleInventoryType.EQUIPPED.getType());\n+            }\n+\n+            ps = con.prepareStatement(query.toString());\n+            ps.setInt(1, value);\n+            ps.setInt(2, id);\n+            rs = ps.executeQuery();\n+\n+            while (rs.next()) {\n+                ps2 = con.prepareStatement(\"SELECT `bundles` FROM `inventorymerchant` WHERE `inventoryitemid` = ?\");\n+                ps2.setInt(1, rs.getInt(\"inventoryitemid\"));\n+                rs2 = ps2.executeQuery();\n+                \n+                short bundles = 0;\n+                if(rs2.next()) {\n+                    bundles = rs2.getShort(\"bundles\");\n+                }\n+                \n+                MapleInventoryType mit = MapleInventoryType.getByType(rs.getByte(\"inventorytype\"));\n+\n+                if (mit.equals(MapleInventoryType.EQUIP) || mit.equals(MapleInventoryType.EQUIPPED)) {\n+                    Equip equip = new Equip(rs.getInt(\"itemid\"), (short) rs.getInt(\"position\"));\n+                    equip.setOwner(rs.getString(\"owner\"));\n+                    equip.setQuantity((short) rs.getInt(\"quantity\"));\n+                    equip.setAcc((short) rs.getInt(\"acc\"));\n+                    equip.setAvoid((short) rs.getInt(\"avoid\"));\n+                    equip.setDex((short) rs.getInt(\"dex\"));\n+                    equip.setHands((short) rs.getInt(\"hands\"));\n+                    equip.setHp((short) rs.getInt(\"hp\"));\n+                    equip.setInt((short) rs.getInt(\"int\"));\n+                    equip.setJump((short) rs.getInt(\"jump\"));\n+                    equip.setVicious((short) rs.getInt(\"vicious\"));\n+                    equip.setFlag((byte) rs.getInt(\"flag\"));\n+                    equip.setLuk((short) rs.getInt(\"luk\"));\n+                    equip.setMatk((short) rs.getInt(\"matk\"));\n+                    equip.setMdef((short) rs.getInt(\"mdef\"));\n+                    equip.setMp((short) rs.getInt(\"mp\"));\n+                    equip.setSpeed((short) rs.getInt(\"speed\"));\n+                    equip.setStr((short) rs.getInt(\"str\"));\n+                    equip.setWatk((short) rs.getInt(\"watk\"));\n+                    equip.setWdef((short) rs.getInt(\"wdef\"));\n+                    equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n+                    equip.setLevel((byte) rs.getByte(\"level\"));\n+                    equip.setItemExp(rs.getInt(\"itemexp\"));\n+                    equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                    equip.setExpiration(rs.getLong(\"expiration\"));\n+                    equip.setGiftFrom(rs.getString(\"giftFrom\"));\n+                    equip.setRingId(rs.getInt(\"ringid\"));\n+                    items.add(new Pair<Item, MapleInventoryType>(equip, mit));\n+                } else {\n+                    if(bundles > 0) {\n+                        Item item = new Item(rs.getInt(\"itemid\"), (byte) rs.getInt(\"position\"), (short)(bundles * rs.getInt(\"quantity\")), rs.getInt(\"petid\"));\n+                        item.setOwner(rs.getString(\"owner\"));\n+                        item.setExpiration(rs.getLong(\"expiration\"));\n+                        item.setGiftFrom(rs.getString(\"giftFrom\"));\n+                        item.setFlag((byte) rs.getInt(\"flag\"));\n+                        items.add(new Pair<>(item, mit));\n+                    }\n+                }\n+                \n+                rs2.close();\n+                ps2.close();\n+            }\n+\n+            rs.close();\n+            ps.close();\n+            con.close();\n+        } finally {\n+            if (rs2 != null && !rs2.isClosed()) {\n+                rs2.close();\n+            }\n+            if (ps2 != null && !ps2.isClosed()) {\n+                ps2.close();\n+            }\n+            if (rs != null && !rs.isClosed()) {\n+                rs.close();\n+            }\n+            if (ps != null && !ps.isClosed()) {\n+                ps.close();\n+            }\n+            if (con != null && !con.isClosed()) {\n+                con.close();\n+            }\n+        }\n+        return items;\n+    }\n+\n+    private void saveItemsMerchant(List<Pair<Item, MapleInventoryType>> items, List<Short> bundlesList, int id, Connection con) throws SQLException {\n+        PreparedStatement ps = null;\n+        PreparedStatement pse = null;\n+        ResultSet rs = null;\n+\n+        lock.lock();\n+        try {\n+            ps = con.prepareStatement(\"DELETE FROM `inventorymerchant` WHERE `characterid` = ?\");\n+            ps.setInt(1, id);\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            StringBuilder query = new StringBuilder();\n+            query.append(\"DELETE `inventoryitems`, `inventoryequipment` FROM `inventoryitems` LEFT JOIN `inventoryequipment` USING(`inventoryitemid`) WHERE `type` = ? AND `\");\n+            query.append(account ? \"accountid\" : \"characterid\").append(\"` = ?\");\n+            ps = con.prepareStatement(query.toString());\n+            ps.setInt(1, value);\n+            ps.setInt(2, id);\n+            ps.executeUpdate();\n+            ps.close();\n+            ps = con.prepareStatement(\"INSERT INTO `inventoryitems` VALUES (DEFAULT, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\", Statement.RETURN_GENERATED_KEYS);\n+\n+            if (!items.isEmpty()) {\n+                int i = 0;\n+                for (Pair<Item, MapleInventoryType> pair : items) {\n+                    Item item = pair.getLeft();\n+                    Short bundles = bundlesList.get(i);\n+                    MapleInventoryType mit = pair.getRight();\n+                    i++;\n+                    \n+                    ps.setInt(1, value);\n+                    ps.setString(2, account ? null : String.valueOf(id));\n+                    ps.setString(3, account ? String.valueOf(id) : null);\n+                    ps.setInt(4, item.getItemId());\n+                    ps.setInt(5, mit.getType());\n+                    ps.setInt(6, item.getPosition());\n+                    ps.setInt(7, item.getQuantity());\n+                    ps.setString(8, item.getOwner());\n+                    ps.setInt(9, item.getPetId());\n+                    ps.setInt(10, item.getFlag());\n+                    ps.setLong(11, item.getExpiration());\n+                    ps.setString(12, item.getGiftFrom());\n+                    ps.executeUpdate();\n+\n+                    rs = ps.getGeneratedKeys();\n+                    if (!rs.next()) {\n+                        throw new RuntimeException(\"Inserting item failed.\");\n+                    }\n+\n+                    int genKey = rs.getInt(1);\n+                    rs.close();\n+                    \n+                    pse = con.prepareStatement(\"INSERT INTO `inventorymerchant` VALUES (DEFAULT, ?, ?, ?)\", Statement.RETURN_GENERATED_KEYS);\n+                    pse.setInt(1, genKey);\n+                    pse.setInt(2, id);\n+                    pse.setInt(3, bundles);\n+                    pse.executeUpdate();\n+                    pse.close();\n+\n+                    if (mit.equals(MapleInventoryType.EQUIP) || mit.equals(MapleInventoryType.EQUIPPED)) {\n+                        pse = con.prepareStatement(\"INSERT INTO `inventoryequipment` VALUES (DEFAULT, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n+                        pse.setInt(1, genKey);\n+\t\t\t\t\t\t\n+                        Equip equip = (Equip) item;\n+                        pse.setInt(2, equip.getUpgradeSlots());\n+                        pse.setInt(3, equip.getLevel());\n+                        pse.setInt(4, equip.getStr());\n+                        pse.setInt(5, equip.getDex());\n+                        pse.setInt(6, equip.getInt());\n+                        pse.setInt(7, equip.getLuk());\n+                        pse.setInt(8, equip.getHp());\n+                        pse.setInt(9, equip.getMp());\n+                        pse.setInt(10, equip.getWatk());\n+                        pse.setInt(11, equip.getMatk());\n+                        pse.setInt(12, equip.getWdef());\n+                        pse.setInt(13, equip.getMdef());\n+                        pse.setInt(14, equip.getAcc());\n+                        pse.setInt(15, equip.getAvoid());\n+                        pse.setInt(16, equip.getHands());\n+                        pse.setInt(17, equip.getSpeed());\n+                        pse.setInt(18, equip.getJump());\n+                        pse.setInt(19, 0);\n+                        pse.setInt(20, equip.getVicious());\n+                        pse.setInt(21, equip.getItemLevel());\n+                        pse.setInt(22, equip.getItemExp());\n+                        pse.setInt(23, equip.getRingId());\n+                        pse.executeUpdate();\n+                        \n+                        pse.close();\n+                    }\n+                }\n+            }\n+\t\t\t\n+            ps.close();\n+        } finally {\n+            if (ps != null && !ps.isClosed()) {\n+                ps.close();\n+            }\n+            if (pse != null && !pse.isClosed()) {\n+                pse.close();\n+            }\n+            if(rs != null && !rs.isClosed()) {\n+\t\trs.close();\n+            }\n+\t\t\t\n+            lock.unlock();\n+        }\n+    }\n }\n\\ No newline at end of file"}, {"sha": "3c64e28177fc6d19195bc2cc160dd511f3c66075", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -43,10 +43,12 @@\n     public static final boolean USE_ITEM_SORT = true;\n     public static final boolean USE_ITEM_SORT_BY_NAME = false;      //Item sorting based on name rather than id.\n     public static final boolean USE_PARTY_SEARCH = false;\n+    public static final boolean USE_MERCHANT_ANYWHERE = true;       //Enables player shops and hired merchants outside FM rooms (except FM entrance).\n     public static final boolean USE_AUTOBAN = false;                //Commands the server to detect infractors automatically.\n     public static final boolean USE_AUTOSAVE = true;                //Enables server autosaving feature (saves characters to DB each 1 hour).\n     public static final boolean USE_SERVER_AUTOASSIGNER = true;     //Server-builtin autoassigner, uses algorithm based on distributing AP accordingly with required secondary stat on equipments.\n     public static final boolean USE_REFRESH_RANK_MOVE = true;\n+    public static final boolean USE_ENFORCE_UNMERCHABLE_PET = true; //Forces players to not sell pets via merchants. (since non-named pets gets dirty name and other possible DB-related issues)\n     public static final boolean USE_ENFORCE_MDOOR_POSITION = true;  //Forces mystic door to be spawned near spawnpoints. (since things bugs out other way, and this helps players to locate the door faster)\n     public static final boolean USE_ERASE_UNTRADEABLE_DROP = true;  //Forces flagged untradeable items to disappear when dropped.\n     public static final boolean USE_ERASE_PET_ON_EXPIRATION = false;//Forces pets to be removed from inventory when expire time comes, rather than converting it to a doll."}, {"sha": "3005d290301ed97dcf70c2b516954abdf043dda3", "filename": "src/net/server/Server.java", "status": "modified", "additions": 65, "deletions": 54, "changes": 119, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -39,6 +39,8 @@\n import java.util.Map;\n import java.util.Properties;\n import java.util.Set;\n+import java.util.concurrent.locks.ReentrantLock;\n+import java.util.concurrent.locks.Lock;\n \n import net.MapleServerHandler;\n import net.mina.MapleCodecFactory;\n@@ -79,6 +81,7 @@\n     private static Server instance = null;\n     private List<Pair<Integer, String>> worldRecommendedList = new LinkedList<>();\n     private final Map<Integer, MapleGuild> guilds = new LinkedHashMap<>();\n+    private final Lock shutdownLock = new ReentrantLock();\n     private final PlayerBuffStorage buffStorage = new PlayerBuffStorage();\n     private final Map<Integer, MapleAlliance> alliances = new LinkedHashMap<>();\n     private boolean online = false;\n@@ -99,14 +102,16 @@ public boolean isOnline() {\n         return worldRecommendedList;\n     }\n \n-    public void removeChannel(int worldid, int channel) {\n+    /*\n+    public void removeChannel(int worldid, int channel) {   //lol don't!\n         channels.remove(channel);\n \n         World world = worlds.get(worldid);\n         if (world != null) {\n             world.removeChannel(channel);\n         }\n     }\n+    */\n \n     public Channel getChannel(int world, int channel) {\n         return worlds.get(world).getChannel(channel);\n@@ -702,69 +707,75 @@ public World getWorld(int id) {\n         return worlds;\n     }\n \n-    public final Runnable shutdown(final boolean restart) {//only once :D\n+    public final Runnable shutdown(final boolean restart) {//no player should be online when trying to shutdown!\n         return new Runnable() {\n             @Override\n             public void run() {\n-                System.out.println((restart ? \"Restarting\" : \"Shutting down\") + \" the server!\\r\\n\");\n-                if (getWorlds() == null) return;//already shutdown\n-                for (World w : getWorlds()) {\n-                    w.shutdown();\n-                }\n-                /*for (World w : getWorlds()) {\n-                    while (w.getPlayerStorage().getAllCharacters().size() > 0) {\n-                        try {\n-                            Thread.sleep(1000);\n-                        } catch (InterruptedException ie) {\n-                            System.err.println(\"FUCK MY LIFE\");\n+                shutdownLock.lock();\n+                \n+                try {\n+                    System.out.println((restart ? \"Restarting\" : \"Shutting down\") + \" the server!\\r\\n\");\n+                    if (getWorlds() == null) return;//already shutdown\n+                    for (World w : getWorlds()) {\n+                        w.shutdown();\n+                    }\n+                    /*for (World w : getWorlds()) {\n+                        while (w.getPlayerStorage().getAllCharacters().size() > 0) {\n+                            try {\n+                                Thread.sleep(1000);\n+                            } catch (InterruptedException ie) {\n+                                System.err.println(\"FUCK MY LIFE\");\n+                            }\n                         }\n                     }\n-                }\n-                for (Channel ch : getAllChannels()) {\n-                    while (ch.getConnectedClients() > 0) {\n-                        try {\n-                            Thread.sleep(1000);\n-                        } catch (InterruptedException ie) {\n-                            System.err.println(\"FUCK MY LIFE\");\n+                    for (Channel ch : getAllChannels()) {\n+                        while (ch.getConnectedClients() > 0) {\n+                            try {\n+                                Thread.sleep(1000);\n+                            } catch (InterruptedException ie) {\n+                                System.err.println(\"FUCK MY LIFE\");\n+                            }\n+                        }\n+                    }*/\n+\n+                    TimerManager.getInstance().purge();\n+                    TimerManager.getInstance().stop();\n+\n+                    for (Channel ch : getAllChannels()) {\n+                        while (!ch.finishedShutdown()) {\n+                            try {\n+                                Thread.sleep(1000);\n+                            } catch (InterruptedException ie) {\n+                                ie.printStackTrace();\n+                                System.err.println(\"FUCK MY LIFE\");\n+                            }\n                         }\n                     }\n-                }*/\n-\n-                TimerManager.getInstance().purge();\n-                TimerManager.getInstance().stop();\n-\n-                for (Channel ch : getAllChannels()) {\n-                    while (!ch.finishedShutdown()) {\n+                    worlds.clear();\n+                    worlds = null;\n+                    channels.clear();\n+                    channels = null;\n+                    worldRecommendedList.clear();\n+                    worldRecommendedList = null;\n+\n+                    System.out.println(\"Worlds + Channels are offline.\");\n+                    acceptor.unbind();\n+                    acceptor = null;\n+                    if (!restart) {\n+                        System.exit(0);\n+                    } else {\n+                        System.out.println(\"\\r\\nRestarting the server....\\r\\n\");\n                         try {\n-                            Thread.sleep(1000);\n-                        } catch (InterruptedException ie) {\n-                            ie.printStackTrace();\n-                            System.err.println(\"FUCK MY LIFE\");\n+                            instance.finalize();//FUU I CAN AND IT'S FREE\n+                        } catch (Throwable ex) {\n+                            ex.printStackTrace();\n                         }\n+                        instance = null;\n+                        System.gc();\n+                        getInstance().run();//DID I DO EVERYTHING?! D:\n                     }\n-                }\n-                worlds.clear();\n-                worlds = null;\n-                channels.clear();\n-                channels = null;\n-                worldRecommendedList.clear();\n-                worldRecommendedList = null;\n-\n-                System.out.println(\"Worlds + Channels are offline.\");\n-                acceptor.unbind();\n-                acceptor = null;\n-                if (!restart) {\n-                    System.exit(0);\n-                } else {\n-                    System.out.println(\"\\r\\nRestarting the server....\\r\\n\");\n-                    try {\n-                        instance.finalize();//FUU I CAN AND IT'S FREE\n-                    } catch (Throwable ex) {\n-                        ex.printStackTrace();\n-                    }\n-                    instance = null;\n-                    System.gc();\n-                    getInstance().run();//DID I DO EVERYTHING?! D:\n+                } finally {\n+                    shutdownLock.unlock();\n                 }\n             }\n         };"}, {"sha": "0af9a7835395bef039a7f880f3cf8736122df872", "filename": "src/net/server/channel/handlers/FredrickHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/FredrickHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/FredrickHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/FredrickHandler.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -72,10 +72,10 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                             chr.getHiredMerchant().clearItems();\n                         \n                         for (int i = 0; i < items.size(); i++) {\n-                        \tItem item = items.get(i).getLeft();\n+                            Item item = items.get(i).getLeft();\n                             MapleInventoryManipulator.addFromDrop(c, item, false);\n                             String itemName = MapleItemInformationProvider.getInstance().getName(item.getItemId());\n-        \t\t\t\t\tFilePrinter.printError(FilePrinter.FREDRICK + chr.getName() + \".txt\", chr.getName() + \" gained \" + item.getQuantity() + \" \" + itemName + \" (\" + item.getItemId() + \")\\r\\n\");\t        \t\t\t\t\n+                            FilePrinter.printError(FilePrinter.FREDRICK + chr.getName() + \".txt\", chr.getName() + \" gained \" + item.getQuantity() + \" \" + itemName + \" (\" + item.getItemId() + \")\\r\\n\");\n                         }\n                         c.announce(MaplePacketCreator.fredrickMessage((byte) 0x1E));\n                         "}, {"sha": "58b21a7c56b32bdc40430874a74b8bcf4558f1ab", "filename": "src/net/server/channel/handlers/HiredMerchantRequest.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/HiredMerchantRequest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/HiredMerchantRequest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/HiredMerchantRequest.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -26,6 +26,7 @@\n import java.sql.SQLException;\n import java.util.Arrays;\n import client.MapleClient;\n+import constants.ServerConstants;\n import net.AbstractMaplePacketHandler;\n import server.maps.MapleMapObjectType;\n import tools.MaplePacketCreator;\n@@ -38,7 +39,7 @@\n public final class HiredMerchantRequest extends AbstractMaplePacketHandler {\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n-        if (chr.getMap().getMapObjectsInRange(chr.getPosition(), 23000, Arrays.asList(MapleMapObjectType.HIRED_MERCHANT)).isEmpty() && chr.getMapId() > 910000000 && chr.getMapId() < 910000023) {\n+        if (chr.getMap().getMapObjectsInRange(chr.getPosition(), 23000, Arrays.asList(MapleMapObjectType.HIRED_MERCHANT)).isEmpty() && ((ServerConstants.USE_MERCHANT_ANYWHERE && chr.getMapId() != 910000000) || (chr.getMapId() > 910000000 && chr.getMapId() < 910000023))) {\n             if (!chr.hasMerchant()) {\n                 try {\n                     if (ItemFactory.MERCHANT.loadItems(chr.getId(), false).isEmpty() && chr.getMerchantMeso() == 0) {"}, {"sha": "20a91415a67fd62c66a11382d63ba03a3504400b", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -28,6 +28,7 @@\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import constants.ItemConstants;\n+import constants.ServerConstants;\n \n import java.util.Arrays;\n \n@@ -234,7 +235,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     } else if (!merchant.isOpen()) {\n                         chr.dropMessage(1, \"This shop is in maintenance, please come by later.\");\n                         return;\n-                    } else if (merchant.getFreeSlot() == -1) {\n+                    } else if (merchant.getFreeSlotThreadsafe() == -1) {\n                         chr.dropMessage(1, \"This shop has reached it's maximum capacity, please come by later.\");\n                         return;\n                     } else {\n@@ -259,10 +260,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     game.chat(c, slea.readMapleAsciiString());\n                 }\n             } else if (merchant != null) {\n-                String message = chr.getName() + \" : \" + slea.readMapleAsciiString();\n-                byte slot = (byte) (merchant.getVisitorSlot(c.getPlayer()) + 1);\n-                merchant.getMessages().add(new Pair<>(message, slot));\n-                merchant.broadcastToVisitors(MaplePacketCreator.hiredMerchantChat(message, slot));\n+                merchant.sendMessage(c.getPlayer(), slea.readMapleAsciiString());\n             }\n         } else if (mode == Action.EXIT.getCode()) {\n             if (chr.getTrade() != null) {\n@@ -408,7 +406,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         } else if (mode == Action.CONFIRM.getCode()) {\n             MapleTrade.completeTrade(c.getPlayer());\n         } else if (mode == Action.ADD_ITEM.getCode() || mode == Action.PUT_ITEM.getCode()) {\n-        \tMapleInventoryType type = MapleInventoryType.getByType(slea.readByte());\n+            MapleInventoryType type = MapleInventoryType.getByType(slea.readByte());\n             short slot = slea.readShort();\n             short bundles = slea.readShort();\n             if (chr.getInventory(type).getItem(slot) == null || chr.getItemQuantity(chr.getInventory(type).getItem(slot).getItemId(), false) < bundles || chr.getInventory(type).getItem(slot).getFlag() == ItemConstants.UNTRADEABLE) {\n@@ -425,6 +423,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             Item sellItem = ivItem.copy();\n             if (chr.getItemQuantity(ivItem.getItemId(), false) < perBundle * bundles) {\n                 return;\n+            } else if (ServerConstants.USE_ENFORCE_UNMERCHABLE_PET && ItemConstants.isPet(ivItem.getItemId())) {\n+                c.announce(MaplePacketCreator.serverNotice(1, \"Pets are not allowed to be sold on the Player Shop.\"));\n+                return;\n             }\n             sellItem.setQuantity(perBundle);\n             MaplePlayerShopItem item = new MaplePlayerShopItem(sellItem, bundles, price);\n@@ -521,7 +522,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 shop.broadcast(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n             } else if (merchant != null) {\n                 merchant.buy(c, item, quantity);\n-                merchant.broadcastToVisitors(MaplePacketCreator.updateHiredMerchant(merchant, c.getPlayer()));\n+                merchant.broadcastToVisitorsThreadsafe(MaplePacketCreator.updateHiredMerchant(merchant, c.getPlayer()));\n             }\n         } else if (mode == Action.TAKE_ITEM_BACK.getCode()) {\n             HiredMerchant merchant = chr.getHiredMerchant();\n@@ -555,7 +556,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 chr.setHasMerchant(false);\n             }\n             if (merchant != null && merchant.isOwner(c.getPlayer())) {\n-                merchant.getMessages().clear();\n+                merchant.clearMessages();\n                 merchant.setOpen(true);\n             }\n             chr.setHiredMerchant(null);"}, {"sha": "9f1e5e9759958869280089879ebb7731c6938495", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -117,8 +117,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     return;\n                 }\n             } catch(ClassCastException e) {\n-                e.printStackTrace();\n-                FilePrinter.printError(FilePrinter.EXCEPTION_CAUGHT, \"Attacker is not a mob-type, rather is a \" + map.getMapObject(oid).getClass().getName() + \" entity.\");\n+                //this happens due to mob on last map damaging player just before changing maps\n+                \n+                if(ServerConstants.USE_DEBUG) {\n+                    e.printStackTrace();\n+                    FilePrinter.printError(FilePrinter.EXCEPTION_CAUGHT, \"Attacker is not a mob-type, rather is a \" + map.getMapObject(oid).getClass().getName() + \" entity.\");\n+                }\n+                \n+                return;\n             }\n             \n             direction = slea.readByte();"}, {"sha": "17683c65a16fe91d3138e86bfe73a3e964c01305", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -86,7 +86,6 @@\n     private long mountUpdate;\n     \n     private Map<HiredMerchant, Byte> activeMerchants = new LinkedHashMap<>();\n-    private ScheduledFuture<?> MerchantsSchedule;\n     private long merchantUpdate;\n     \n     private ScheduledFuture<?> charactersSchedule;"}, {"sha": "4761df7a3ccca2c5d19bbdde89abbc211588edeb", "filename": "src/server/maps/HiredMerchant.java", "status": "modified", "additions": 123, "deletions": 43, "changes": 166, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/server/maps/HiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/server/maps/HiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/HiredMerchant.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -73,7 +73,13 @@ public HiredMerchant(final MapleCharacter owner, int itemId, String desc) {\n         this.map = owner.getMap();\n     }\n \n-    public void broadcastToVisitors(final byte[] packet) {\n+    public void broadcastToVisitorsThreadsafe(final byte[] packet) {\n+        synchronized(visitors) {\n+            broadcastToVisitors(packet);\n+        }\n+    }\n+    \n+    private void broadcastToVisitors(final byte[] packet) {\n         for (MapleCharacter visitor : visitors) {\n             if (visitor != null) {\n                 visitor.getClient().announce(packet);\n@@ -82,27 +88,37 @@ public void broadcastToVisitors(final byte[] packet) {\n     }\n \n     public void addVisitor(MapleCharacter visitor) {\n-        int i = this.getFreeSlot();\n-        if (i > -1) {\n-            visitors[i] = visitor;\n-            broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorAdd(visitor, i + 1));\n+        synchronized(visitors) {\n+            int i = this.getFreeSlot();\n+            if (i > -1) {\n+                visitors[i] = visitor;\n+                broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorAdd(visitor, i + 1));\n+            }\n         }\n     }\n \n     public void removeVisitor(MapleCharacter visitor) {\n-        int slot = getVisitorSlot(visitor);\n-        if (slot < 0){ //Not found\n-        \treturn;\n-        }\n-        if (visitors[slot] != null && visitors[slot].getId() == visitor.getId()) {\n-            visitors[slot] = null;\n-            if (slot != -1) {\n-                broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorLeave(slot + 1));\n+        synchronized(visitors) {\n+            int slot = getVisitorSlot(visitor);\n+            if (slot < 0){ //Not found\n+                    return;\n+            }\n+            if (visitors[slot] != null && visitors[slot].getId() == visitor.getId()) {\n+                visitors[slot] = null;\n+                if (slot != -1) {\n+                    broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorLeave(slot + 1));\n+                }\n             }\n         }\n     }\n \n-    public int getVisitorSlot(MapleCharacter visitor) {\n+    public int getVisitorSlotThreadsafe(MapleCharacter visitor) {\n+        synchronized(visitors) {\n+            return getVisitorSlot(visitor);\n+        }\n+    }\n+    \n+    private int getVisitorSlot(MapleCharacter visitor) {\n         for (int i = 0; i < 3; i++) {\n             if (visitors[i] != null && visitors[i].getId() == visitor.getId()){\n                 return i;\n@@ -112,21 +128,24 @@ public int getVisitorSlot(MapleCharacter visitor) {\n     }\n \n     public void removeAllVisitors(String message) {\n-        for (int i = 0; i < 3; i++) {\n-            if (visitors[i] != null) {\n-                visitors[i].setHiredMerchant(null);\n-                visitors[i].getClient().announce(MaplePacketCreator.leaveHiredMerchant(i + 1, 0x11));\n-                if (message.length() > 0) {\n-                    visitors[i].dropMessage(1, message);\n+        synchronized(visitors) {\n+            for (int i = 0; i < 3; i++) {\n+                if (visitors[i] != null) {\n+                    visitors[i].setHiredMerchant(null);\n+                    visitors[i].getClient().announce(MaplePacketCreator.leaveHiredMerchant(i + 1, 0x11));\n+                    if (message.length() > 0) {\n+                        visitors[i].dropMessage(1, message);\n+                    }\n+                    visitors[i] = null;\n                 }\n-                visitors[i] = null;\n             }\n         }\n     }\n \n     public void buy(MapleClient c, int item, short quantity) {\n-        MaplePlayerShopItem pItem = items.get(item);\n         synchronized (items) {\n+            MaplePlayerShopItem pItem = items.get(item);\n+            \n             Item newItem = pItem.getItem().copy();\n             newItem.setQuantity((short) ((pItem.getItem().getQuantity() * quantity)));\n             if ((newItem.getFlag() & ItemConstants.KARMA) == ItemConstants.KARMA) {\n@@ -142,11 +161,15 @@ public void buy(MapleClient c, int item, short quantity) {\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n             }\n-            int price = pItem.getPrice() * quantity;\n+            int price = (int)Math.min((long)pItem.getPrice() * quantity, Integer.MAX_VALUE);\n             if (c.getPlayer().getMeso() >= price) {\n                 if (MapleInventoryManipulator.addFromDrop(c, newItem, true)) {\n                     c.getPlayer().gainMeso(-price, false);\n-                    sold.add(new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), quantity, price));\n+                    \n+                    synchronized (sold) {\n+                        sold.add(new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), quantity, price));\n+                    }\n+                    \n                     pItem.setBundles((short) (pItem.getBundles() - quantity));\n                     if (pItem.getBundles() < 1) {\n                         pItem.setDoesExist(false);\n@@ -187,7 +210,9 @@ public void forceClose() {\n         \n         try {\n             saveItems(true);\n-            items.clear();\n+            synchronized (items) {\n+                items.clear();\n+            }\n         } catch (SQLException ex) {\n             ex.printStackTrace();\n         }\n@@ -234,15 +259,19 @@ public void closeShop(MapleClient c, boolean timeout) {\n                         con.close();\n                 }\n \n-                if (check(c.getPlayer(), getItems()) && !timeout) {\n-                    for (MaplePlayerShopItem mpsi : getItems()) {\n+                List<MaplePlayerShopItem> copyItems = getItems();\n+                if (check(c.getPlayer(), copyItems) && !timeout) {\n+                    for (MaplePlayerShopItem mpsi : copyItems) {\n                         if (mpsi.isExist() && (mpsi.getItem().getType() == MapleInventoryType.EQUIP.getType())) {\n                             MapleInventoryManipulator.addFromDrop(c, mpsi.getItem(), false);\n                         } else if (mpsi.isExist()) {\n                             MapleInventoryManipulator.addById(c, mpsi.getItem().getItemId(), (short) (mpsi.getBundles() * mpsi.getItem().getQuantity()), null, -1, mpsi.getItem().getFlag(), mpsi.getItem().getExpiration());\n                         }\n                     }\n-                    items.clear();\n+                    \n+                    synchronized (items) {\n+                        items.clear();\n+                    }\n                 }\n \n                 try {\n@@ -251,7 +280,9 @@ public void closeShop(MapleClient c, boolean timeout) {\n                     e.printStackTrace();\n                 }\n \n-                items.clear();\n+                synchronized (items) {\n+                    items.clear();\n+                }\n             } catch (Exception e) {\n                 e.printStackTrace();\n             }\n@@ -264,7 +295,9 @@ public String getOwner() {\n     }\n     \n     public void clearItems() {\n-        items.clear();\n+        synchronized (items) {\n+            items.clear();\n+        }\n     }\n \n     public int getOwnerId() {\n@@ -276,15 +309,25 @@ public String getDescription() {\n     }\n \n     public MapleCharacter[] getVisitors() {\n-        return visitors;\n+        synchronized(visitors) {\n+            MapleCharacter[] copy = new MapleCharacter[3];\n+            for(int i = 0; i < visitors.length; i++) copy[i] = visitors[i];\n+                    \n+            return copy;\n+        }\n     }\n \n     public List<MaplePlayerShopItem> getItems() {\n-        return Collections.unmodifiableList(items);\n+        synchronized (items) {\n+            return Collections.unmodifiableList(items);\n+        }\n     }\n \n     public void addItem(MaplePlayerShopItem item) {\n-        items.add(item);\n+        synchronized (items) {\n+            items.add(item);\n+        }\n+        \n         try {\n             this.saveItems(false);\n         } catch (SQLException ex) {\n@@ -293,16 +336,24 @@ public void addItem(MaplePlayerShopItem item) {\n     }\n \n     public void removeFromSlot(int slot) {\n-        items.remove(slot);\n+        synchronized (items) {\n+            items.remove(slot);\n+        }\n+        \n         try {\n             this.saveItems(false);\n         } catch (SQLException ex) {\n             ex.printStackTrace();\n         }\n     }\n     \n+    public int getFreeSlotThreadsafe() {\n+        synchronized(visitors) {\n+            return getFreeSlot();\n+        }\n+    }\n     \n-    public int getFreeSlot() {\n+    private int getFreeSlot() {\n         for (int i = 0; i < 3; i++) {\n             if (visitors[i] == null) {\n                 return i;\n@@ -330,24 +381,38 @@ public int getItemId() {\n     public boolean isOwner(MapleCharacter chr) {\n         return chr.getId() == ownerId;\n     }\n+    \n+    public void sendMessage(MapleCharacter chr, String msg) {\n+        String message = chr.getName() + \" : \" + msg;\n+        byte slot = (byte) (getVisitorSlot(chr) + 1);\n+        \n+        synchronized (messages) {\n+            messages.add(new Pair<>(message, slot));\n+        }\n+        broadcastToVisitors(MaplePacketCreator.hiredMerchantChat(message, slot));\n+    }\n \n     public void saveItems(boolean shutdown) throws SQLException {\n         List<Pair<Item, MapleInventoryType>> itemsWithType = new ArrayList<>();\n+        List<Short> bundles = new ArrayList<>();\n \n-        for (MaplePlayerShopItem pItems : items) {\n+        for (MaplePlayerShopItem pItems : getItems()) {\n             Item newItem = pItems.getItem();\n-            if (shutdown) {\n-                newItem.setQuantity((short) (pItems.getItem().getQuantity() * pItems.getBundles()));\n+            short newBundle = pItems.getBundles();\n+            \n+            if (shutdown) { //is \"shutdown\" really necessary?\n+                newItem.setQuantity((short) (pItems.getItem().getQuantity()));\n             } else {\n-                newItem.setQuantity(pItems.getItem().getQuantity());\n+                newItem.setQuantity((short) (pItems.getItem().getQuantity()));\n             }\n-            if (pItems.getBundles() > 0) {\n+            if (newBundle > 0) {\n                 itemsWithType.add(new Pair<>(newItem, MapleInventoryType.getByType(newItem.getType())));\n+                bundles.add(newBundle);\n             }\n         }\n \t\n         Connection con = DatabaseConnection.getConnection();\n-        ItemFactory.MERCHANT.saveItems(itemsWithType, this.ownerId, con);\n+        ItemFactory.MERCHANT.saveItems(itemsWithType, bundles, this.ownerId, con);\n         con.close();\n     }\n \n@@ -405,16 +470,31 @@ public int getTimeLeft() {\n         return (int) ((System.currentTimeMillis() - start) / 1000);\n     }\n \n+    public void clearMessages() {\n+        synchronized (messages) {\n+            messages.clear();\n+        }\n+    }\n+    \n     public List<Pair<String, Byte>> getMessages() {\n-        return messages;\n+        synchronized (messages) {\n+            List<Pair<String, Byte>> msgList = new LinkedList<>();\n+            for(Pair<String, Byte> m : messages) {\n+                msgList.add(m);\n+            }\n+            \n+            return msgList;\n+        }\n     }\n \n     public int getMapId() {\n         return map.getId();\n     }\n \n     public List<SoldItem> getSold() {\n-        return sold;\n+        synchronized (sold) {\n+            return Collections.unmodifiableList(sold);\n+        }\n     }\n \n     public int getMesos() {"}, {"sha": "528b9955e45319d5042dc1a12d82124d89ab353c", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/de7e686a92be172de4df8974b3139d12e0a46dac/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/de7e686a92be172de4df8974b3139d12e0a46dac/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=de7e686a92be172de4df8974b3139d12e0a46dac", "patch": "@@ -4959,7 +4959,7 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                                 mplew.writeInt(item.getBundles());\n                                 mplew.writeInt(item.getPrice());\n                                 mplew.writeInt(hm.getOwnerId());\n-                                mplew.write(hm.getFreeSlot() == -1 ? 1 : 0);\n+                                mplew.write(hm.getFreeSlotThreadsafe() == -1 ? 1 : 0);\n                                 MapleCharacter chr = c.getChannelServer().getPlayerStorage().getCharacterById(hm.getOwnerId());\n                                 if ((chr != null) && (c.getChannel() == hm.getChannel())) {\n                                         mplew.write(1);\n@@ -5004,7 +5004,7 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 mplew.write(PlayerInteractionHandler.Action.ROOM.getCode());\n                 mplew.write(0x05);\n                 mplew.write(0x04);\n-                mplew.writeShort(hm.getVisitorSlot(chr) + 1);\n+                mplew.writeShort(hm.getVisitorSlotThreadsafe(chr) + 1);\n                 mplew.writeInt(hm.getItemId());\n                 mplew.writeMapleAsciiString(\"Hired Merchant\");\n                 for (int i = 0; i < 3; i++) {\n@@ -5016,10 +5016,12 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 }\n                 mplew.write(-1);\n                 if (hm.isOwner(chr)) {\n-                        mplew.writeShort(hm.getMessages().size());\n-                        for (int i = 0; i < hm.getMessages().size(); i++) {\n-                                mplew.writeMapleAsciiString(hm.getMessages().get(i).getLeft());\n-                                mplew.write(hm.getMessages().get(i).getRight());\n+                        List<Pair<String, Byte>> msgList = hm.getMessages();\n+                    \n+                        mplew.writeShort(msgList.size());\n+                        for (int i = 0; i < msgList.size(); i++) {\n+                                mplew.writeMapleAsciiString(msgList.get(i).getLeft());\n+                                mplew.write(msgList.get(i).getRight());\n                         }\n                 } else {\n                         mplew.writeShort(0);"}]}]},
