{"fetchDate": "2019-12-19", "content": [{"sha": "bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YmVlOGI1MjU5YjY4MzAzN2NmY2QxNTlhOWYyOTdiYmY5MGU2ZDJmZA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-07-21T17:40:46Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-07-21T17:40:46Z"}, "message": "Heal GMS + Improved chnl workers & Pshop tooltip + Equips on party HP\n\nSlightly improved channel and disease announce workers performance.\nCompletion of repeatable quests no longer generates fame to players.\nEquipment drop rates of Leprechaun were slightly decreased.\nFixed Pet Item Ignore not checking certain exploit cases correctly.\nOptimized Pet Item Ignore server handler performance.\nFixed some exploits and improved performance on PetLootHandler.\nImproved concurrency protection on MapleInventoryManipulator.\nHeal skill effect on players now works GMS-intended, as description says. Also removed the delayed Heal cast effect to others.\nFixed party player HPBar not accounting the player's HP stat gained on equips towards the effective MaxHP.\nThe duration of mists generated by mobs has been rescaled to 10x longer than what has been displayed until now (wz duration property is supposed to actually be in 100ms).\nOptimized timer management for mob skill cooldown and elemental effectiveness.\nImplemented an additional inventory check system, to be used in cases where it's expected to remove a set group for items (with quantity) to then add a new group of items.\nFixed Player Shop/Hired Merchant \"vacancy\" tooltip, now properly showing whether the store has a visitor room or is already full at that time.\nFixed Player Shops only using the standard stand type.\nFixed cash pet food ignoring certain pet itemids when reading data from WZ.", "tree": {"sha": "09be10df27005c3dfb3d9984ed52438c0b4d64c7", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/09be10df27005c3dfb3d9984ed52438c0b4d64c7"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "html_url": "https://github.com/ronancpl/HeavenMS/commit/bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3752ebbae5b03f184015e13296ecb0629d4de3e6", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/3752ebbae5b03f184015e13296ecb0629d4de3e6", "html_url": "https://github.com/ronancpl/HeavenMS/commit/3752ebbae5b03f184015e13296ecb0629d4de3e6"}], "stats": {"total": 1820, "additions": 1193, "deletions": 627}, "files": [{"sha": "020d711cc9c08c760dc2299f52c1dbafc19e5b24", "filename": "docs/feature_list.md", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -32,7 +32,7 @@ PQs:\n \n Skills:\n \n-* Some skills behaving oddly have been patched, such as Steal, Venomous Star/Stab and Mystic Doors.\n+* Some skills behaving oddly have been patched, such as Steal, Venomous Star/Stab, Heal and Mystic Doors.\n * Maker skill features properly developed.\n * Improved current Battleship skill, now showing the HP properly on buff tab and making visible for others after changing maps.\n * Server is using heuristics to calculate fee costs for the Maker (errors sums up to 8k mesos, reagent errors stacks up comformant with it's level).\n@@ -59,7 +59,9 @@ Player Social Network:\n * Guild and Alliance system fully functional.\n * Implemented Marriage system from the ground-up (excluding character packet encoding parts that were already present, proper credits given throughout the source files).\n * Beginners can create and join a \"beginner-only\" party (characters up to level 10).\n+* HP bar of party members now properly calculates the HP gain from equipments.\n * Enhanced synchronization on Player Shops and Hired Merchants. Transactions made are instantly informed to the owner.\n+* Player Shops and Hired Merchants properly displaying the correct shop image to other players, and informing whether the shop is available to visit or full.\n * Game minirooms such as match cards and omok now has a functional password system.\n * Item pickup cooldown on non-owned/non-partyowned items functional.\n * Further improved the server's ranking system, now displaying properly daily player ranking movement.\n@@ -134,6 +136,8 @@ Server potentials:\n * Enhanced auto-pot system: pet uses as many potions as necessary to reach the desired threshold.\n * Enhanced buff system: smartly checks for the best available buff effects to be active on the player.\n * Enhanced AP auto-assigner: exactly matches AP with the needed for the player's current level, surplus assigned to the primary attribute.\n+* Enhanced inventory check: free slots on inventory smartly fetched on demand.\n+* Enhanced auto-loot handler: optimized the brute-force checks for some cash items on the player equipped inventory at every requisition.\n * Tweaked pet/mount hunger: calculations for fullness/tiredness takes active time of the subject into account.\n * Consistent experience gain system.\n * NPC crafters (equips, plates/jewels, etc) now won't take items freely if the requirement conditions are not properly met.\n@@ -150,6 +154,7 @@ Server potentials:\n * Centralized getcurrenttime throughout several server handlers, boosting it's performance overall.\n * Autosaver (periodically saves on DB current state of every player in-game).\n * Both fixed and randomized versions of HP/MP growth rate available, regarding player job (enable one at ServerConstants). Placeholder for HP/MP washing feature.\n+* Implemented methods to get the current Players' MaxHP/MaxMP method with equipment HP/MP gains already summed up.\n * Reallocated mapobjectids utilization throughout the source, preventing issues such as \"NPC disappearing mysteriously after some server time\" from happening.\n * Implemented old GMS statup mechanic for novices level 10 or below. Usage of the edited localhost is mandatory on this.\n * Accounts can be created automatically when trying to login on an inexistent account -- credits to shavit."}, {"sha": "ec9dde1bfe14c0d600a45b7ff70102eaa99adf49", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -1143,4 +1143,24 @@ Normalizado String.wz: agora todos os itens sem \"name\" o tem.\n Nova ferramenta: MapleInvalidItemWithNoNameFetcher. Busca por itemids sem as propriedades \"cash\" e \"name\" nos conjuntos de wz.xml.\n \n 17 Julho 2018,\n-Corrigido problema cr\u00edtico no novo sistema de login, que impedia contas rec\u00e9m-criadas de logar no jogo.\n\\ No newline at end of file\n+Corrigido problema cr\u00edtico no novo sistema de login, que impedia contas rec\u00e9m-criadas de logar no jogo.\n+\n+18 - 19 Julho 2018,\n+Suavemente otimizado desempenho geral de channel workers e disease announce worker.\n+Quests repetiveis no mesmo dia n\u00e3o geram fama.\n+Equip drops de Leprechaun mais raros de aparecer (chance 2000 -> 1200).\n+Corrigido Pet Item Ignore n\u00e3o checando certos casos corretamente e otimizado busca nos handlers pelos cash itens equipados.\n+Corrigido alguns exploits e otimizado alguns recursos usados pelo PetLootHandler.\n+Protegido contra acesso concorrente certos trechos de c\u00f3digo cr\u00edticos do MapleInventoryManipulator.\n+Corrigido Heal para contabilizar ganho de HP GMS-like.\n+Corrigido efeito de Heal para outros atuando extremamente lento.\n+Corrigido maxHP sendo mostrado nas barras de HP de colegas de party para mostrar o HP efetivo (maxhp + aumento de HP equipado).\n+Dura\u00e7\u00e3o da mist foi rescalado pra 10x mais que a dura\u00e7\u00e3o passada (wz representa dura\u00e7\u00e3o de mist em 100ms).\n+Otimizado manuten\u00e7\u00e3o de temporizadores em cooldown de skills de mobs e em elemental effectiveness.\n+Implementado um sistema adicional de checagem de slots dispon\u00edveis no invent\u00e1rio, para casos onde se espera retirada de um vetor de (itemid, quantidade) para inser\u00e7\u00e3o de outro vetor de (itemid, quantidade).\n+\n+20 Julho 2018,\n+Corrigido tooltip de player shops e hired merchants, agora com \u00edcone mostrando se h\u00e1 como visitar uma loja ou est\u00e1 ocupada.\n+Corrigido player shop permits diferentes do comum n\u00e3o sendo consumidos ao usar.\n+Corrigido player shop sempre aparecendo como o tipo b\u00e1sico (sem estandes), para qualquer permit itemid.\n+Corrigido cash pet food ignorando certos petids ao ler dados do WZ.\n\\ No newline at end of file"}, {"sha": "5ef9bca5ba09f1dbce6f125857fe0162df59a388", "filename": "scripts/event/Elevator.js", "status": "added", "additions": 88, "deletions": 0, "changes": 88, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/event/Elevator.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/event/Elevator.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Elevator.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -0,0 +1,88 @@\n+/*\n+This file is part of the OdinMS Maple Story Server\n+Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc> \n+\t\t\t\t   Matthias Butz <matze@odinms.de>\n+\t\t\t\t   Jan Christian Meyer <vimes@odinms.de>\n+\n+This program is free software: you can redistribute it and/or modify\n+it under the terms of the GNU Affero General Public License as\n+published by the Free Software Foundation version 3 as published by\n+the Free Software Foundation. You may not use, modify or distribute\n+this program under any other version of the GNU Affero General Public\n+License.\n+\n+This program is distributed in the hope that it will be useful,\n+but WITHOUT ANY WARRANTY; without even the implied warranty of\n+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+GNU Affero General Public License for more details.\n+\n+You should have received a copy of the GNU Affero General Public License\n+along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+//Time Setting is in millisecond\n+var beginTime = 60 * 1000; //The time to begin the ride\n+var  rideTime = 60 * 1000; //The time that require move to destination\n+\n+function init() {\n+    beginTime = em.getTransportationTime(beginTime);\n+     rideTime = em.getTransportationTime(rideTime);\n+    \n+    em.getChannelServer().getMapFactory().getMap(222020100).resetReactors();\n+    em.getChannelServer().getMapFactory().getMap(222020200).resetReactors();\n+    \n+    scheduleNew();\n+}\n+\n+function scheduleNew() {\n+    em.setProperty(\"goingUp\", \"false\");\n+    em.setProperty(\"goingDown\", \"true\");\n+    \n+    em.getChannelServer().getMapFactory().getMap(222020100).resetReactors();\n+    em.getChannelServer().getMapFactory().getMap(222020200).setReactorState();\n+    em.schedule(\"goingUpNow\", beginTime);\n+}\n+\n+function goUp() {\n+    em.schedule(\"goingUpNow\", beginTime);\n+}\n+\n+function goDown() {\n+    em.schedule(\"goingDownNow\", beginTime);\n+}\n+\n+function goingUpNow() {\n+    em.getChannelServer().getMapFactory().getMap(222020110).warpEveryone(222020111);\n+    em.setProperty(\"goingUp\", \"true\");\n+    em.schedule(\"isUpNow\", rideTime);\n+    \n+    em.getChannelServer().getMapFactory().getMap(222020100).setReactorState();\n+}\n+\n+function goingDownNow() {\n+    em.getChannelServer().getMapFactory().getMap(222020210).warpEveryone(222020211);\n+    em.setProperty(\"goingDown\", \"true\");\n+    em.schedule(\"isDownNow\", rideTime);\n+    \n+    em.getChannelServer().getMapFactory().getMap(222020200).setReactorState();\n+}\n+\n+function isUpNow() {\n+    em.setProperty(\"goingDown\", \"false\"); // clear\n+    em.getChannelServer().getMapFactory().getMap(222020200).resetReactors();\n+    em.getChannelServer().getMapFactory().getMap(222020111).warpEveryone(222020200, 0);\n+\n+    goDown();\n+}\n+\n+function isDownNow() {\n+    em.setProperty(\"goingUp\", \"false\"); // clear\n+    em.getChannelServer().getMapFactory().getMap(222020100).resetReactors();\n+    em.getChannelServer().getMapFactory().getMap(222020211).warpEveryone(222020100, 4);\n+    \n+    goUp();\n+}\n+\n+function cancelSchedule() {\n+    \n+}\n\\ No newline at end of file"}, {"sha": "1d539fa0b35adc7b6e3f421cdf6b576ce4096812", "filename": "scripts/npc/2042000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -146,7 +146,7 @@ function refineItems(refineType) {\n             itemqty = refineQty * 10;\n         \n             var fee = getRefineFee(refineFees[refineType][(itemid % 100) | 0] * refineQty);\n-            if(cm.canHold(itemid + 1000, refineQty) && cm.getMeso() >= fee) {\n+            if(cm.canHold(itemid + 1000, refineQty, itemid, itemqty) && cm.getMeso() >= fee) {\n                 cm.gainMeso(-fee);\n                 cm.gainItem(itemid, -itemqty);\n                 cm.gainItem(itemid + (itemid != 4010007 ? 1000 : 1001), refineQty);"}, {"sha": "1d539fa0b35adc7b6e3f421cdf6b576ce4096812", "filename": "scripts/npc/2042001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042001.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -146,7 +146,7 @@ function refineItems(refineType) {\n             itemqty = refineQty * 10;\n         \n             var fee = getRefineFee(refineFees[refineType][(itemid % 100) | 0] * refineQty);\n-            if(cm.canHold(itemid + 1000, refineQty) && cm.getMeso() >= fee) {\n+            if(cm.canHold(itemid + 1000, refineQty, itemid, itemqty) && cm.getMeso() >= fee) {\n                 cm.gainMeso(-fee);\n                 cm.gainItem(itemid, -itemqty);\n                 cm.gainItem(itemid + (itemid != 4010007 ? 1000 : 1001), refineQty);"}, {"sha": "1d539fa0b35adc7b6e3f421cdf6b576ce4096812", "filename": "scripts/npc/2042002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/2042002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042002.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -146,7 +146,7 @@ function refineItems(refineType) {\n             itemqty = refineQty * 10;\n         \n             var fee = getRefineFee(refineFees[refineType][(itemid % 100) | 0] * refineQty);\n-            if(cm.canHold(itemid + 1000, refineQty) && cm.getMeso() >= fee) {\n+            if(cm.canHold(itemid + 1000, refineQty, itemid, itemqty) && cm.getMeso() >= fee) {\n                 cm.gainMeso(-fee);\n                 cm.gainItem(itemid, -itemqty);\n                 cm.gainItem(itemid + (itemid != 4010007 ? 1000 : 1001), refineQty);"}, {"sha": "b1c1d2e223a61f105c37b2edf66b2d6d7a827177", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -51,6 +51,7 @@ function writeFeatureTab_PQs() {\n \n function writeFeatureTab_Skills() {\n         addFeature(\"Reviewed many skills, such as Steal and M. Door.\");\n+        addFeature(\"Heal GMS-like: fixed HP gain & Heal skill packet.\");\n         addFeature(\"Improved battleship: HP visible and map-persistent.\");\n         addFeature(\"Maker skill features properly developed.\");\n         addFeature(\"Chair Mastery - map chair boosts HP/MP rec.\");\n@@ -71,6 +72,7 @@ function writeFeatureTab_Quests() {\n function writeFeatureTab_PlayerSocialNetwork() {\n         addFeature(\"Guild and Alliance system fully functional.\");\n         addFeature(\"Party for novices-only.\");\n+        addFeature(\"P. members' HPBar accounts HP gain on equips.\");\n         addFeature(\"Thoroughly reviewed P. Shops and H. Merchants.\");\n         addFeature(\"Transactions on Merchs instantly announced to owner.\");\n         addFeature(\"Game minirooms with functional pw system.\");\n@@ -149,6 +151,8 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Enhanced auto-pot system: smart pet potion handle.\");\n         addFeature(\"Enhanced buff system: best buffs effects takes place.\");\n         addFeature(\"Enhanced AP auto-assigner: focus on eqp demands.\");\n+        addFeature(\"Enhanced inventory check: free slots smartly fetched.\");\n+        addFeature(\"Enhanced petloot handler: no brute-force inv. checks.\");\n         addFeature(\"Tweaked pet/mount hunger to a balanced growth rate.\");\n         addFeature(\"Consistent experience gain system.\");\n         addFeature(\"NPC crafters won't take items freely anymore.\");\n@@ -165,6 +169,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Centralized servertime, boosting handler performance.\");\n         addFeature(\"Autosaver (periodically saves player's data on DB).\");\n         addFeature(\"Fixed and randomized HP/MP growth rate available.\");\n+        addFeature(\"Players' MaxHP/MaxMP method accounting equip gain.\");\n         addFeature(\"Prevented 'NPC gone after some uptime' issue.\");\n         addFeature(\"Implemented starters' AP assigning for under level 11.\");\n         addFeature(\"AP assigning available for novices level 10 or below.\");\n@@ -202,7 +207,7 @@ function writeFeatureTab_Localhostedits() {\n function writeFeatureTab_Project() {\n         addFeature(\"Organized project code.\");\n         addFeature(\"Highly updated drop data.\");\n-        addFeature(\"Highly configurable server.\");\n+        addFeature(\"Highly configurable & optimized server.\");\n         addFeature(\"Fixed/added many missing packet opcodes.\");\n         addFeature(\"Uncovered many opcodes throughout the source.\");\n         addFeature(\"Reviewed many Java aspects that needed attention.\");"}, {"sha": "6b2f0fc3822147101fff4a6e30ec8d16cdc2fc24", "filename": "scripts/npc/commands.js", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/commands.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/scripts/npc/commands.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/commands.js?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -77,6 +77,7 @@ function writeHeavenMSCommandsLv5() {    //Developer\n         addCommand(\"debugplayercoupons\", \"\");\n         addCommand(\"debugtimer\", \"\");\n         addCommand(\"debugmarriage\", \"\");\n+        addCommand(\"showpackets\", \"\");\n         addCommand(\"set\", \"\");\n }\n \n@@ -99,7 +100,7 @@ function writeHeavenMSCommandsLv4() {    //SuperGM\n         addCommand(\"pap\", \"\");\n         addCommand(\"pianus\", \"\");\n         addCommand(\"cake\", \"\");\n-        addCommand(\"pnpcremove\", \"\");\n+        addCommand(\"playernpcremove\", \"\");\n         addCommand(\"playernpc\", \"\");\n }\n \n@@ -117,6 +118,7 @@ function writeHeavenMSCommandsLv3() {    //GM\n         addCommand(\"reloaddrops\", \"\");\n         addCommand(\"reloadportals\", \"\");\n         addCommand(\"reloadmap\", \"\");\n+        addCommand(\"reloadshops\", \"\");\n         addCommand(\"hpmp\", \"\");\n         addCommand(\"maxhpmp\", \"\");\n         addCommand(\"music\", \"\");"}, {"sha": "1e5414add2ec055132ccc0cbe00f731f93953413", "filename": "sql/db_drops.sql", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -19613,22 +19613,22 @@ USE `heavenms`;\n (9400583, 2041030, 1, 1, 0, 5000),\n (9400583, 4006000, 1, 1, 0, 20000),\n (9400583, 2070005, 1, 1, 0, 400),\n-(9400583, 1002391, 1, 1, 0, 2000),\n-(9400583, 1302096, 1, 1, 0, 2000),\n-(9400583, 1041099, 1, 1, 0, 2000),\n-(9400583, 1422012, 1, 1, 0, 2000),\n-(9400583, 1412004, 1, 1, 0, 2000),\n-(9400583, 1051010, 1, 1, 0, 2000),\n-(9400583, 1051058, 1, 1, 0, 2000),\n-(9400583, 1082056, 1, 1, 0, 2000),\n-(9400583, 1092029, 1, 1, 0, 2000),\n-(9400583, 1382010, 1, 1, 0, 2000),\n-(9400583, 1072114, 1, 1, 0, 2000),\n-(9400583, 1050064, 1, 1, 0, 2000),\n-(9400583, 1002276, 1, 1, 0, 2000),\n-(9400583, 1050077, 1, 1, 0, 2000),\n-(9400583, 1061101, 1, 1, 0, 2000),\n-(9400583, 1002328, 1, 1, 0, 2000),\n+(9400583, 1002391, 1, 1, 0, 1200),\n+(9400583, 1302096, 1, 1, 0, 1200),\n+(9400583, 1041099, 1, 1, 0, 1200),\n+(9400583, 1422012, 1, 1, 0, 1200),\n+(9400583, 1412004, 1, 1, 0, 1200),\n+(9400583, 1051010, 1, 1, 0, 1200),\n+(9400583, 1051058, 1, 1, 0, 1200),\n+(9400583, 1082056, 1, 1, 0, 1200),\n+(9400583, 1092029, 1, 1, 0, 1200),\n+(9400583, 1382010, 1, 1, 0, 1200),\n+(9400583, 1072114, 1, 1, 0, 1200),\n+(9400583, 1050064, 1, 1, 0, 1200),\n+(9400583, 1002276, 1, 1, 0, 1200),\n+(9400583, 1050077, 1, 1, 0, 1200),\n+(9400583, 1061101, 1, 1, 0, 1200),\n+(9400583, 1002328, 1, 1, 0, 1200),\n (9400549, 0, 2000, 3000, 0, 400000),\n (9400638, 0, 100, 200, 0, 400000),\n (9400638, 4011007, 1, 1, 0, 1000),"}, {"sha": "7740d01a19bf9d6cdf5d64f577a506a4feade294", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 82, "deletions": 19, "changes": 101, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -64,7 +64,6 @@\n import net.server.world.World;\n import scripting.event.EventInstanceManager;\n import server.CashShop;\n-import client.inventory.manipulator.MapleInventoryManipulator;\n import server.MapleItemInformationProvider;\n import server.MaplePortal;\n import server.MapleShop;\n@@ -104,19 +103,20 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;\n-import tools.locks.MonitoredReentrantLock;\n import tools.packets.Wedding;\n import client.autoban.AutobanManager;\n import client.creator.CharacterFactoryRecipe;\n import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.ItemFactory;\n import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryProof;\n import client.inventory.MapleInventoryType;\n import client.inventory.MaplePet;\n import client.inventory.MapleWeaponType;\n import client.inventory.ModifyInventory;\n import client.inventory.PetDataFactory;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n import client.newyear.NewYearCardRecord;\n import constants.ExpTable;\n import constants.GameConstants;\n@@ -156,7 +156,8 @@\n import net.server.channel.handlers.PartyOperationHandler;\n import scripting.item.ItemScriptManager;\n import server.maps.MapleMapItem;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n public class MapleCharacter extends AbstractAnimatedMapleMapObject {\n     private static MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n@@ -168,7 +169,7 @@\n     private int world;\n     private int accountid, id;\n     private int rank, rankMove, jobRank, jobRankMove;\n-    private int level, str, dex, luk, int_, hp, maxhp, mp, maxmp;\n+    private int level, str, dex, luk, int_, hp, maxhp, eqphp, mp, maxmp, eqpmp;\n     private int hpMpApUsed;\n     private int hair;\n     private int face;\n@@ -202,6 +203,7 @@\n     private long lastfametime, lastUsedCashItem, lastExpression = 0, lastHealed, lastBuyback = 0, lastDeathtime, lastMesoDrop = -1, jailExpiration = -1;\n     private transient int localmaxhp, localmaxmp, localstr, localdex, localluk, localint_, magic, watk;\n     private boolean hidden, canDoor = true, berserk, hasMerchant, hasSandboxItem = false, whiteChat = false;\n+    private boolean equippedMesoMagnet = false, equippedItemPouch = false, equippedPetItemIgnore = false;\n     private int linkedLevel = 0;\n     private String linkedName = null;\n     private boolean finishedDojoTutorial;\n@@ -325,13 +327,16 @@ private MapleCharacter() {\n         for (int i = 0; i < remainingSp.length; i++) {\n             remainingSp[i] = 0;\n         }\n+        \n         for (MapleInventoryType type : MapleInventoryType.values()) {\n             byte b = 24;\n             if (type == MapleInventoryType.CASH) {\n                 b = 96;\n             }\n             inventory[type.ordinal()] = new MapleInventory(this, type, (byte) b);\n         }\n+        inventory[MapleInventoryType.CANHOLD.ordinal()] = new MapleInventoryProof(this);\n+        \n         for (int i = 0; i < SavedLocationType.values().length; i++) {\n             savedLocations[i] = null;\n         }\n@@ -4392,6 +4397,18 @@ public int getMasterLevel(Skill skill) {\n     public int getMaxHp() {\n         return maxhp;\n     }\n+    \n+    public int getMaxMp() {\n+        return maxmp;\n+    }\n+    \n+    public int getMaxHpEquipped() {\n+        return Math.min(maxhp + eqphp, 30000);\n+    }\n+    \n+    public int getMaxMpEquipped() {\n+        return Math.min(maxmp + eqpmp, 30000);\n+    }\n \n     public int getMaxClassLevel() {\n         return isCygnus() ? 120 : 200;\n@@ -4404,11 +4421,7 @@ public int getMaxLevel() {\n         \n         return GameConstants.getJobMaxLevel(job);\n     }\n-\n-    public int getMaxMp() {\n-        return maxmp;\n-    }\n-\n+    \n     public int getMeso() {\n         return meso.get();\n     }\n@@ -4693,7 +4706,7 @@ public void closeMiniGame() {\n         \n         this.setMiniGame(null);\n         if (game.isOwner(this)) {\n-            this.getMap().broadcastMessage(MaplePacketCreator.removeCharBox(this));\n+            this.getMap().broadcastMessage(MaplePacketCreator.removeMinigameBox(this));\n             game.broadcastToVisitor(MaplePacketCreator.getMiniGameClose(3));\n         } else {\n             game.removeVisitor(this);\n@@ -5176,8 +5189,7 @@ public void hasGivenFame(MapleCharacter to) {\n                 ps.setInt(1, getId());\n                 ps.setInt(2, to.getId());\n                 ps.executeUpdate();\n-            }\n-            finally {\n+            } finally {\n                 con.close();\n             }\n         } catch (SQLException e) {\n@@ -6610,7 +6622,7 @@ public void receivePartyMemberHP() {\n                     if (partychar.getMapId() == mapId && partychar.getChannel() == channel) {\n                         MapleCharacter other = Server.getInstance().getWorld(world).getChannel(channel).getPlayerStorage().getCharacterByName(partychar.getName());\n                         if (other != null) {\n-                            client.announce(MaplePacketCreator.updatePartyMemberHP(other.getId(), other.getHp(), other.getCurrentMaxHp()));\n+                            client.announce(MaplePacketCreator.updatePartyMemberHP(other.getId(), other.getHp(), other.getMaxHpEquipped()));\n                         }\n                     }\n                 }\n@@ -7388,7 +7400,7 @@ public void sendNote(String to, String msg, byte fame) throws SQLException {\n             ps.setString(1, to);\n             ps.setString(2, this.getName());\n             ps.setString(3, msg);\n-            ps.setLong(4, System.currentTimeMillis());\n+            ps.setLong(4, Server.getInstance().getCurrentTime());\n             ps.setByte(5, fame);\n             ps.executeUpdate();\n         } finally {\n@@ -8149,11 +8161,12 @@ private void updatePartyMemberHPInternal() {\n             int channel = client.getChannel();\n             int mapId = getMapId();\n             \n+            int curmaxhp = getMaxHpEquipped();\n             for (MaplePartyCharacter partychar : party.getMembers()) {\n                 if (partychar.getMapId() == mapId && partychar.getChannel() == channel) {\n                     MapleCharacter other = Server.getInstance().getWorld(world).getChannel(channel).getPlayerStorage().getCharacterByName(partychar.getName());\n                     if (other != null) {\n-                        other.client.announce(MaplePacketCreator.updatePartyMemberHP(getId(), this.hp, maxhp));\n+                        other.client.announce(MaplePacketCreator.updatePartyMemberHP(getId(), this.hp, curmaxhp));\n                     }\n                 }\n             }\n@@ -8202,8 +8215,9 @@ public void updateQuest(MapleQuestStatus quest) {\n             }\n             announce(MaplePacketCreator.updateQuestInfo((short) quest.getQuest().getId(), quest.getNpc()));\n         } else if (quest.getStatus().equals(MapleQuestStatus.Status.COMPLETED)) {\n-            short questid = quest.getQuest().getId();\n-            if(!MapleQuest.isExploitableQuest(questid)) {\n+            MapleQuest mquest = quest.getQuest();\n+            short questid = mquest.getId();\n+            if(!mquest.isSameDayRepeatable() && !MapleQuest.isExploitableQuest(questid)) {\n                 quest_fame += 1;\n                 if(ServerConstants.FAME_GAIN_BY_QUEST > 0)\n                     fameGainByQuest();\n@@ -8679,7 +8693,56 @@ public AutobanManager getAutobanManager() {\n         return autoban;\n     }\n \n-    public void equipPendantOfSpirit() {\n+    public void resetEquippedHpMp() {\n+        eqphp = 0;\n+        eqpmp = 0;\n+    }\n+    \n+    public void equippedItem(Equip equip) {\n+        int itemid = equip.getItemId();\n+        eqphp += equip.getHp();\n+        eqpmp += equip.getMp();\n+        \n+        if (itemid == 1122017) {\n+            this.equipPendantOfSpirit();\n+        } else if (itemid == 1812000) { // meso magnet\n+            equippedMesoMagnet = true;\n+        } else if (itemid == 1812001) { // item pouch\n+            equippedItemPouch = true;\n+        } else if (itemid == 1812007) { // item ignore pendant\n+            equippedPetItemIgnore = true;\n+        }\n+    }\n+    \n+    public void unequippedItem(Equip equip) {\n+        int itemid = equip.getItemId();\n+        eqphp -= equip.getHp();\n+        eqpmp -= equip.getMp();\n+        \n+        if (itemid == 1122017) {\n+            this.unequipPendantOfSpirit();\n+        } else if (itemid == 1812000) { // meso magnet\n+            equippedMesoMagnet = false;\n+        } else if (itemid == 1812001) { // item pouch\n+            equippedItemPouch = false;\n+        } else if (itemid == 1812007) { // item ignore pendant\n+            equippedPetItemIgnore = false;\n+        }\n+    }\n+    \n+    public boolean isEquippedMesoMagnet() {\n+        return equippedMesoMagnet;\n+    }\n+    \n+    public boolean isEquippedItemPouch() {\n+        return equippedItemPouch;\n+    }\n+    \n+    public boolean isEquippedPetItemIgnore() {\n+        return equippedPetItemIgnore;\n+    }\n+    \n+    private void equipPendantOfSpirit() {\n         if (pendantOfSpirit == null) {\n             pendantOfSpirit = TimerManager.getInstance().register(new Runnable() {\n                 @Override\n@@ -8695,7 +8758,7 @@ public void run() {\n         }\n     }\n \n-    public void unequipPendantOfSpirit() {\n+    private void unequipPendantOfSpirit() {\n         if (pendantOfSpirit != null) {\n             pendantOfSpirit.cancel(false);\n             pendantOfSpirit = null;"}, {"sha": "1d82fb62bac9eea2a55de638ee15b478ab0fc8a3", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -44,7 +44,6 @@\n import java.util.concurrent.locks.Lock;\n \n import tools.*;\n-import tools.locks.MonitoredReentrantLock;\n \n import javax.script.ScriptEngine;\n \n@@ -74,7 +73,9 @@\n import server.MapleTrade;\n import server.maps.*;\n import server.quest.MapleQuest;\n-import tools.locks.MonitoredLockType;\n+\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n public class MapleClient {\n \n@@ -793,20 +794,19 @@ private void removePlayer() {\n \t\ttry {\n                         player.setAwayFromWorld(true);\n                         player.notifyMapTransferToPartner(-1);\n-\t\t\tplayer.cancelAllBuffs(true);\n-\t\t\tplayer.cancelAllDebuffs();\n+                        player.cancelAllBuffs(true);\n+                        player.cancelAllDebuffs();\n                         \n                         player.closePlayerInteractions();\n-\t\t\tQuestScriptManager.getInstance().dispose(this);\n+                        QuestScriptManager.getInstance().dispose(this);\n \t\t\t\n                         EventInstanceManager eim = player.getEventInstance();\n \t\t\tif (eim != null) {\n \t\t\t\teim.playerDisconnected(player);\n \t\t\t}\n-\t\t\tif (player.getMap() != null) {\n+                        if (player.getMap() != null) {\n                                 int mapId = player.getMapId();\n-\t\t\t\tplayer.getMap().removePlayer(player);\n-                                \n+                                player.getMap().removePlayer(player);\n                                 if(GameConstants.isDojo(mapId)) {\n                                         this.getChannelServer().freeDojoSectionIfEmpty(mapId);\n                                 }\n@@ -842,15 +842,15 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n                                 removePlayer();\n                                 player.saveCooldowns();\n                                 player.saveCharToDB(true);\n-                            \n+                                \n                                 clear();\n-\t\t\t\treturn;\n+                                return;\n \t\t\t}\n                         \n                         removePlayer();\n \t\t\t\n \t\t\tfinal World worlda = getWorldServer();\n-\t\t\ttry {\n+                        try {\n \t\t\t\tif (!cashshop) {\n \t\t\t\t\tif (!this.serverTransition) { // meaning not changing channels\n \t\t\t\t\t\tif (messengerid > 0) {\n@@ -861,7 +861,7 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n                                                         final MapleFamily family = worlda.getFamily(fid);\n                                                         family.\n                                                 }\n-                                                */                  \n+                                                */\n \t\t\t\t\t\tfor (MapleQuestStatus status : player.getStartedQuests()) { //This is for those quests that you have to stay logged in for a certain amount of time\n \t\t\t\t\t\t\tMapleQuest quest = status.getQuest();\n \t\t\t\t\t\t\tif (quest.getTimeLimit() > 0) {\n@@ -870,7 +870,7 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n \t\t\t\t\t\t\t\tplayer.updateQuest(newStatus);\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\t                   \n-\t\t\t\t\t\tif (guild != null) {\n+                                                if (guild != null) {\n \t\t\t\t\t\t\tfinal Server server = Server.getInstance();\n \t\t\t\t\t\t\tserver.setGuildMemberOnline(player, false, player.getClient().getChannel());\n \t\t\t\t\t\t\tplayer.getClient().announce(MaplePacketCreator.showGuildInfo(player));\n@@ -890,7 +890,7 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}                   \n-\t\t\t\t\t\tif (bl != null) {\n+                                                if (bl != null) {\n \t\t\t\t\t\t\tworlda.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n@@ -910,7 +910,7 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n \t\t\t\t\t\t\t\t\tworlda.updateParty(party.getId(), PartyOperation.CHANGE_LEADER, lchr);\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\t                \t\n+\t\t\t\t\t\t}\t                \n \t\t\t\t\t\tif (bl != null) {\n \t\t\t\t\t\t\tworlda.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n \t\t\t\t\t\t}"}, {"sha": "0175f3e63323ec99fbafa0207932b740620ee0e3", "filename": "src/client/MonsterBook.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MonsterBook.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/MonsterBook.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MonsterBook.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -32,10 +32,10 @@\n import java.util.Set;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.Semaphore;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n public final class MonsterBook {\n     private static final Semaphore semaphore = new Semaphore(10);"}, {"sha": "68225c4c7b5defcdb86d506b4a6d5751e2d36d53", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -1768,8 +1768,12 @@ public static boolean executeHeavenMsCommandLv3(Channel cserv, Server srv, Maple\n \t\t\t}\n \t\t\tnewMap.respawn();\n                     break;\n+                    \n+                case \"reloadshops\":\n+                        MapleShopFactory.getInstance().reloadShops();\n+                    break;\n \n-               case \"hpmp\":\n+                case \"hpmp\":\n                         victim = player;\n                         int statUpdate = 1;\n                         \n@@ -2611,9 +2615,9 @@ public static boolean executeHeavenMsCommandLv4(Channel cserv, Server srv, Maple\n                         player.getMap().spawnMonsterOnGroundBelow(monster, player.getPosition());\n                         break;\n                     \n-                    case \"pnpcremove\":\n+                    case \"playernpcremove\":\n                         if (sub.length < 2) {\n-                            player.yellowMessage(\"Syntax: !pnpcremove <playername>\");\n+                            player.yellowMessage(\"Syntax: !playernpcremove <playername>\");\n                             break;\n                         }\n                         \n@@ -2654,7 +2658,7 @@ public static boolean executeHeavenMsCommandLv5(Channel cserv, Server srv, Maple\n                     case \"debugpacket\":\n                         player.getMap().broadcastMessage(MaplePacketCreator.customPacket(joinStringFrom(sub, 1)));\n                         break;\n-                    \n+                        \n                     case \"debugportal\":\n                         MaplePortal portal = player.getMap().findClosestPortal(player.getPosition());\n                         if(portal != null) player.dropMessage(6, \"Closest portal: \" + portal.getId() + \" '\" + portal.getName() + \"' Type: \" + portal.getType() + \" --> toMap: \" + portal.getTargetMapId() + \" scriptname: '\" + portal.getScriptName() + \"' state: \" + portal.getPortalState() + \".\");\n@@ -2731,6 +2735,10 @@ public static boolean executeHeavenMsCommandLv5(Channel cserv, Server srv, Maple\n                         c.getChannelServer().debugMarriageStatus();\n                         break;\n                     \n+                    case \"showpackets\":\n+                        ServerConstants.USE_DEBUG_SHOW_RCVD_PACKET = !ServerConstants.USE_DEBUG_SHOW_RCVD_PACKET;\n+                        break;\n+                        \n                     case \"set\":\n                         for(int i = 0; i < sub.length - 1; i++) {\n                                 ServerConstants.DEBUG_VALUES[i] = Integer.parseInt(sub[i + 1]);"}, {"sha": "9399d842b08defed91731e27969e7d88ed48a648", "filename": "src/client/inventory/ItemFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/ItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/ItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ItemFactory.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -28,10 +28,10 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import tools.DatabaseConnection;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "1963dc9f83a8732ad27f1c0493476ebd423c9eaa", "filename": "src/client/inventory/MapleInventory.java", "status": "modified", "additions": 28, "deletions": 20, "changes": 48, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventory.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -32,7 +32,7 @@\n import java.util.Map.Entry;\n import java.util.Map;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n import tools.Pair;\n import client.MapleCharacter;\n@@ -41,19 +41,19 @@\n import server.MapleItemInformationProvider;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import tools.FilePrinter;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *\n  * @author Matze, Ronan\n  */\n public class MapleInventory implements Iterable<Item> {\n-    private MapleCharacter owner;\n-    private Map<Short, Item> inventory = new LinkedHashMap<>();\n-    private byte slotLimit;\n-    private MapleInventoryType type;\n-    private boolean checked = false;\n-    private Lock lock = new MonitoredReentrantLock(MonitoredLockType.INVENTORY, true);\n+    protected MapleCharacter owner;\n+    protected Map<Short, Item> inventory = new LinkedHashMap<>();\n+    protected byte slotLimit;\n+    protected MapleInventoryType type;\n+    protected boolean checked = false;\n+    protected Lock lock = new MonitoredReentrantLock(MonitoredLockType.INVENTORY, true);\n     \n     public MapleInventory(MapleCharacter mc, MapleInventoryType type, byte slotLimit) {\n         this.owner = mc;\n@@ -301,7 +301,7 @@ public void removeItem(short slot, short quantity, boolean allowZero) {\n         }\n     }\n \n-    private short addSlot(Item item) {\n+    protected short addSlot(Item item) {\n         if(item == null) {\n             return -1;\n         }\n@@ -324,7 +324,7 @@ private short addSlot(Item item) {\n         }\n     }\n     \n-    private void addSlotFromDB(short slot, Item item) {\n+    protected void addSlotFromDB(short slot, Item item) {\n         lock.lock();\n         try {\n             inventory.put(slot, item);\n@@ -418,18 +418,22 @@ public short getNumFreeSlot() {\n     }\n     \n     public static boolean checkSpot(MapleCharacter chr, Item item) {\n-    \tif (chr.getInventory(item.getInventoryType()).isFull()) return false;\n-    \treturn true;\n+        return !chr.getInventory(item.getInventoryType()).isFull();\n     }\n     \n     public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items) {\n-        List<Integer> zeroedList = new ArrayList<>(5);\n-        for(byte i = 0; i < 5; i++) zeroedList.add(0);\n+        return checkSpots(chr, items, false);\n+    }\n+    \n+    public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, boolean useProofInv) {\n+        int invTypesSize = MapleInventoryType.values().length;\n+        List<Integer> zeroedList = new ArrayList<>(invTypesSize);\n+        for(byte i = 0; i < invTypesSize; i++) zeroedList.add(0);\n         \n-        return checkSpots(chr, items, zeroedList);\n+        return checkSpots(chr, items, zeroedList, useProofInv);\n     }\n     \n-    public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed) {\n+    public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed, boolean useProofInv) {\n         // assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0.\n         \n         Map<Integer, Short> rcvItems = new LinkedHashMap<>();\n@@ -452,7 +456,7 @@ public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInvent\n                 int itemType = rcvTypes.get(it.getKey()) - 1;\n                 int usedSlots = typesSlotsUsed.get(itemType);\n                 \n-                int result = MapleInventoryManipulator.checkSpaceProgressively(c, it.getKey(), it.getValue(), \"\", usedSlots);\n+                int result = MapleInventoryManipulator.checkSpaceProgressively(c, it.getKey(), it.getValue(), \"\", usedSlots, useProofInv);\n                 boolean hasSpace = ((result % 2) != 0);\n                 \n                 if(!hasSpace) return false;\n@@ -481,13 +485,17 @@ private static Long hashKey(Integer itemId, String owner) {\n     }\n     \n     public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items) {\n+        return checkSpotsAndOwnership(chr, items, false);\n+    }\n+    \n+    public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, boolean useProofInv) {\n         List<Integer> zeroedList = new ArrayList<>(5);\n         for(byte i = 0; i < 5; i++) zeroedList.add(0);\n         \n-        return checkSpotsAndOwnership(chr, items, zeroedList);\n+        return checkSpotsAndOwnership(chr, items, zeroedList, useProofInv);\n     }\n     \n-    public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed) {\n+    public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed, boolean useProofInv) {\n         //assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0 and item list to be checked is a legal one.\n         \n         Map<Long, Short> rcvItems = new LinkedHashMap<>();\n@@ -516,7 +524,7 @@ public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item,\n                 \n                 //System.out.print(\"inserting \" + itemId.intValue() + \" with type \" + itemType + \" qty \" + it.getValue() + \" owner '\" + rcvOwners.get(it.getKey()) + \"' current usedSlots:\");\n                 //for(Integer i : typesSlotsUsed) System.out.print(\" \" + i);\n-                int result = MapleInventoryManipulator.checkSpaceProgressively(c, itemId.intValue(), it.getValue(), rcvOwners.get(it.getKey()), usedSlots);\n+                int result = MapleInventoryManipulator.checkSpaceProgressively(c, itemId.intValue(), it.getValue(), rcvOwners.get(it.getKey()), usedSlots, useProofInv);\n                 boolean hasSpace = ((result % 2) != 0);\n                 //System.out.print(\" -> hasSpace: \" + hasSpace + \" RESULT : \" + result + \"\\n\");\n                 "}, {"sha": "be8f7955ab8ce2c71cde0f6378f5787ca83bd05a", "filename": "src/client/inventory/MapleInventoryProof.java", "status": "added", "additions": 99, "deletions": 0, "changes": 99, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventoryProof.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventoryProof.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventoryProof.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -0,0 +1,99 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package client.inventory;\n+\n+import client.MapleCharacter;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleInventoryProof extends MapleInventory {\n+    \n+    public MapleInventoryProof(MapleCharacter mc) {\n+        super(mc, MapleInventoryType.CANHOLD, (byte) 0);\n+    }\n+    \n+    public void cloneContents(MapleInventory inv) {\n+        inv.lockInventory();\n+\tlock.lock();\n+        try {\n+            inventory.clear();\n+            this.setSlotLimit(inv.getSlotLimit());\n+            \n+            for(Item it : inv.list()) {\n+                Item item = new Item(it.getItemId(), it.getPosition(), it.getQuantity());\n+                inventory.put(item.getPosition(), item);\n+            }\n+        } finally {\n+            lock.unlock();\n+            inv.unlockInventory();\n+        }\n+    }\n+    \n+    public void flushContents() {\n+        lock.lock();\n+        try {\n+            inventory.clear();\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    @Override\n+    protected short addSlot(Item item) {\n+        if(item == null) {\n+            return -1;\n+        }\n+        \n+        lock.lock();\n+        try {\n+            short slotId = getNextFreeSlot();\n+            if (slotId < 0) {\n+                return -1;\n+            }\n+            inventory.put(slotId, item);\n+            \n+            return slotId;\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    @Override\n+    protected void addSlotFromDB(short slot, Item item) {\n+        lock.lock();\n+        try {\n+            inventory.put(slot, item);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    @Override\n+    public void removeSlot(short slot) {\n+        lock.lock();\n+        try {\n+            inventory.remove(slot);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+}"}, {"sha": "778262f463e38e42888b32a5a92e5d8c9f6aa4f7", "filename": "src/client/inventory/MapleInventoryType.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventoryType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MapleInventoryType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventoryType.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -31,6 +31,7 @@\n     SETUP(3),\n     ETC(4),\n     CASH(5),\n+    CANHOLD(6),   //Proof-guard for inserting after removal checks\n     EQUIPPED(-1); //Seems nexon screwed something when removing an item T_T\n     final byte type;\n "}, {"sha": "aa1e479e00b83ee4e23f3e0c3022057f13b665f2", "filename": "src/client/inventory/MaplePet.java", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MaplePet.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/MaplePet.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MaplePet.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -36,6 +36,7 @@\n import client.MapleCharacter;\n import java.sql.Connection;\n import tools.MaplePacketCreator;\n+import tools.Pair;\n \n /**\n  *\n@@ -273,13 +274,8 @@ public void setSummoned(boolean yes) {\n         this.summoned = yes;\n     }\n \n-    public boolean canConsume(int itemId) {\n-        for (int petId : MapleItemInformationProvider.getInstance().petsCanConsume(itemId)) {\n-            if (petId == this.getItemId()) {\n-                return true;\n-            }\n-        }\n-        return false;\n+    public Pair<Integer, Boolean> canConsume(int itemId) {\n+        return MapleItemInformationProvider.getInstance().canPetConsume(this.getItemId(), itemId);\n     }\n \n     public void updatePosition(List<LifeMovementFragment> movement) {"}, {"sha": "e85f4d8048aecbfa1c70762d773cbdbaf47cadc5", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 181, "deletions": 107, "changes": 288, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -22,6 +22,7 @@\n package client.inventory.manipulator;\n \n import client.MapleBuffStat;\n+import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Equip;\n import client.inventory.Item;\n@@ -38,13 +39,15 @@\n import java.util.Iterator;\n import java.util.List;\n import server.MapleItemInformationProvider;\n+import server.maps.MapleMap;\n import tools.FilePrinter;\n \n import tools.MaplePacketCreator;\n \n /**\n  *\n  * @author Matze\n+ * @author Ronan (improved check space feature & removed redundant object calls)\n  */\n public class MapleInventoryManipulator {\n \n@@ -67,9 +70,11 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n     public static boolean addById(MapleClient c, int itemId, short quantity, String owner, int petid, byte flag, long expiration) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         MapleInventoryType type = ItemConstants.getInventoryType(itemId);\n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory inv = chr.getInventory(type);\n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemId);\n-            List<Item> existing = c.getPlayer().getInventory(type).listById(itemId);\n+            List<Item> existing = inv.listById(itemId);\n             if (!ItemConstants.isRechargeable(itemId) && petid == -1) {\n                 if (existing.size() > 0) { // first update all existing slots to slotMax\n                     Iterator<Item> i = existing.iterator();\n@@ -97,7 +102,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                         Item nItem = new Item(itemId, (short) 0, newQ, petid);\n                         nItem.setFlag(flag);\n                         nItem.setExpiration(expiration);\n-                        short newSlot = c.getPlayer().getInventory(type).addItem(nItem);\n+                        short newSlot = inv.addItem(nItem);\n                         if (newSlot == -1) {\n                             c.announce(MaplePacketCreator.getInventoryFull());\n                             c.announce(MaplePacketCreator.getShowInventoryFull());\n@@ -107,7 +112,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                             nItem.setOwner(owner);\n                         }\n                         c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n-                        if(sandboxItem) c.getPlayer().setHasSandboxItem();\n+                        if(sandboxItem) chr.setHasSandboxItem();\n                         if ((ItemConstants.isRechargeable(itemId)) && quantity == 0) {\n                             break;\n                         }\n@@ -120,14 +125,14 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n                 Item nItem = new Item(itemId, (short) 0, quantity, petid);\n                 nItem.setFlag(flag);\n                 nItem.setExpiration(expiration);\n-                short newSlot = c.getPlayer().getInventory(type).addItem(nItem);\n+                short newSlot = inv.addItem(nItem);\n                 if (newSlot == -1) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return false;\n                 }\n                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n-                if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n+                if(MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n             }\n         } else if (quantity == 1) {\n             Item nEquip = ii.getEquipById(itemId);\n@@ -136,14 +141,14 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n             if (owner != null) {\n                 nEquip.setOwner(owner);\n             }\n-            short newSlot = c.getPlayer().getInventory(type).addItem(nEquip);\n+            short newSlot = inv.addItem(nEquip);\n             if (newSlot == -1) {\n                 c.announce(MaplePacketCreator.getInventoryFull());\n                 c.announce(MaplePacketCreator.getShowInventoryFull());\n                 return false;\n             }\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nEquip))));\n-            if(MapleInventoryManipulator.isSandboxItem(nEquip)) c.getPlayer().setHasSandboxItem();\n+            if(MapleInventoryManipulator.isSandboxItem(nEquip)) chr.setHasSandboxItem();\n         } else {\n             throw new RuntimeException(\"Trying to create equip with non-one quantity\");\n         }\n@@ -159,17 +164,19 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show) {\n     }\n \n     public static boolean addFromDrop(MapleClient c, Item item, boolean show, int petId) {\n+        MapleCharacter chr = c.getPlayer();\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         MapleInventoryType type = item.getInventoryType();\n-        if (ii.isPickupRestricted(item.getItemId()) && c.getPlayer().haveItemWithId(item.getItemId(), true)) {\n+        if (ii.isPickupRestricted(item.getItemId()) && chr.haveItemWithId(item.getItemId(), true)) {\n             c.announce(MaplePacketCreator.getInventoryFull());\n             c.announce(MaplePacketCreator.showItemUnavailable());\n             return false;\n         }\n         short quantity = item.getQuantity();\n+        MapleInventory inv = chr.getInventory(type);\n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, item.getItemId());\n-            List<Item> existing = c.getPlayer().getInventory(type).listById(item.getItemId());\n+            List<Item> existing = inv.listById(item.getItemId());\n             if (!ItemConstants.isRechargeable(item.getItemId()) && petId == -1) {\n                 if (existing.size() > 0) { // first update all existing slots to slotMax\n                     Iterator<Item> i = existing.iterator();\n@@ -195,40 +202,40 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                     nItem.setExpiration(item.getExpiration());\n                     nItem.setOwner(item.getOwner());\n                     nItem.setFlag(item.getFlag());\n-                    short newSlot = c.getPlayer().getInventory(type).addItem(nItem);\n+                    short newSlot = inv.addItem(nItem);\n                     if (newSlot == -1) {\n                         c.announce(MaplePacketCreator.getInventoryFull());\n                         c.announce(MaplePacketCreator.getShowInventoryFull());\n                         item.setQuantity((short) (quantity + newQ));\n                         return false;\n                     }\n                     c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n-                    if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n+                    if(MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n                 }\n             } else {\n                 Item nItem = new Item(item.getItemId(), (short) 0, quantity, petId);\n                 nItem.setExpiration(item.getExpiration());\n                 nItem.setFlag(item.getFlag());\n                 \n-                short newSlot = c.getPlayer().getInventory(type).addItem(nItem);\n+                short newSlot = inv.addItem(nItem);\n                 if (newSlot == -1) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return false;\n                 }\n                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n-                if(MapleInventoryManipulator.isSandboxItem(nItem)) c.getPlayer().setHasSandboxItem();\n+                if(MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n                 c.announce(MaplePacketCreator.enableActions());\n             }\n         } else if (quantity == 1) {\n-            short newSlot = c.getPlayer().getInventory(type).addItem(item);\n+            short newSlot = inv.addItem(item);\n             if (newSlot == -1) {\n                 c.announce(MaplePacketCreator.getInventoryFull());\n                 c.announce(MaplePacketCreator.getShowInventoryFull());\n                 return false;\n             }\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, item))));\n-            if(MapleInventoryManipulator.isSandboxItem(item)) c.getPlayer().setHasSandboxItem();\n+            if(MapleInventoryManipulator.isSandboxItem(item)) chr.setHasSandboxItem();\n         } else {\n             FilePrinter.printError(FilePrinter.ITEM, \"Tried to pickup Equip id \" + item.getItemId() + \" containing more than 1 quantity --> \" + quantity);\n             c.announce(MaplePacketCreator.getInventoryFull());\n@@ -248,14 +255,16 @@ private static boolean haveItemWithId(MapleInventory inv, int itemid) {\n     public static boolean checkSpace(MapleClient c, int itemid, int quantity, String owner) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory inv = chr.getInventory(type);\n         \n-        if(ii.isPickupRestricted(itemid) && haveItemWithId(c.getPlayer().getInventory(type), itemid)) {\n+        if(ii.isPickupRestricted(itemid) && haveItemWithId(inv, itemid)) {\n             return false;\n         }\n         \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemid);\n-            List<Item> existing = c.getPlayer().getInventory(type).listById(itemid);\n+            List<Item> existing = inv.listById(itemid);\n             if (!ItemConstants.isRechargeable(itemid)) {\n                 if (existing.size() > 0) // first update all existing slots to slotMax\n                 {\n@@ -279,30 +288,32 @@ public static boolean checkSpace(MapleClient c, int itemid, int quantity, String\n             } else {\n                 numSlotsNeeded = 1;\n             }\n-            return !c.getPlayer().getInventory(type).isFull(numSlotsNeeded - 1);\n+            return !inv.isFull(numSlotsNeeded - 1);\n         } else {\n-            return !c.getPlayer().getInventory(type).isFull();\n+            return !inv.isFull();\n         }\n     }\n \n-    public static int checkSpaceProgressively(MapleClient c, int itemid, int quantity, String owner, int usedSlots) {\n+    public static int checkSpaceProgressively(MapleClient c, int itemid, int quantity, String owner, int usedSlots, boolean useProofInv) {\n         // return value --> bit0: if has space for this one;\n         //                  value after: new slots filled;\n         // assumption: equipments always have slotMax == 1.\n         \n         int returnValue;\n         \n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+        MapleInventoryType type = !useProofInv ? ItemConstants.getInventoryType(itemid) : MapleInventoryType.CANHOLD;\n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory inv = chr.getInventory(type);\n         \n-        if(ii.isPickupRestricted(itemid) && haveItemWithId(c.getPlayer().getInventory(type), itemid)) {\n+        if(ii.isPickupRestricted(itemid) && haveItemWithId(inv, itemid)) {\n             return 0;\n         }\n         \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemid);\n             if (!ItemConstants.isRechargeable(itemid)) {\n-                List<Item> existing = c.getPlayer().getInventory(type).listById(itemid);\n+                List<Item> existing = inv.listById(itemid);\n                 \n                 if (existing.size() > 0) // first update all existing slots to slotMax\n                 {\n@@ -328,11 +339,11 @@ public static int checkSpaceProgressively(MapleClient c, int itemid, int quantit\n             }\n             \n             returnValue = ((numSlotsNeeded + usedSlots) << 1);\n-            returnValue += (numSlotsNeeded == 0 || !c.getPlayer().getInventory(type).isFullAfterSomeItems(numSlotsNeeded - 1, usedSlots)) ? 1 : 0;\n+            returnValue += (numSlotsNeeded == 0 || !inv.isFullAfterSomeItems(numSlotsNeeded - 1, usedSlots)) ? 1 : 0;\n             //System.out.print(\" needed \" + numSlotsNeeded + \" used \" + usedSlots + \" rval \" + returnValue);\n         } else {\n             returnValue = ((quantity + usedSlots) << 1);\n-            returnValue += (!c.getPlayer().getInventory(type).isFullAfterSomeItems(0, usedSlots)) ? 1 : 0;\n+            returnValue += (!inv.isFullAfterSomeItems(0, usedSlots)) ? 1 : 0;\n             //System.out.print(\" eqpneeded \" + 1 + \" used \" + usedSlots + \" rval \" + returnValue);\n         }\n         \n@@ -344,9 +355,30 @@ public static void removeFromSlot(MapleClient c, MapleInventoryType type, short\n     }\n \n     public static void removeFromSlot(MapleClient c, MapleInventoryType type, short slot, short quantity, boolean fromDrop, boolean consume) {\n-        Item item = c.getPlayer().getInventory(type).getItem(slot);\n+        MapleInventory inv = c.getPlayer().getInventory(type);\n+        Item item = inv.getItem(slot);\n         boolean allowZero = consume && ItemConstants.isRechargeable(item.getItemId());\n-        c.getPlayer().getInventory(type).removeItem(slot, quantity, allowZero);\n+        \n+        if(type == MapleInventoryType.EQUIPPED) {\n+            inv.lockInventory();\n+            try {\n+                c.getPlayer().unequippedItem((Equip) item);\n+                inv.removeItem(slot, quantity, allowZero);\n+            } finally {\n+                inv.unlockInventory();\n+            }\n+            \n+            announceModifyInventory(c, item, fromDrop, allowZero);\n+        } else {\n+            inv.removeItem(slot, quantity, allowZero);\n+            \n+            if(type != MapleInventoryType.CANHOLD) {\n+                announceModifyInventory(c, item, fromDrop, allowZero);\n+            }\n+        }\n+    }\n+    \n+    private static void announceModifyInventory(MapleClient c, Item item, boolean fromDrop, boolean allowZero) {\n         if (item.getQuantity() == 0 && !allowZero) {\n             c.announce(MaplePacketCreator.modifyInventory(fromDrop, Collections.singletonList(new ModifyInventory(3, item))));\n         } else {\n@@ -374,7 +406,7 @@ public static void removeById(MapleClient c, MapleInventoryType type, int itemId\n                 }\n             }\n         }\n-        if (removeQuantity > 0) {\n+        if (removeQuantity > 0 && type != MapleInventoryType.CANHOLD) {\n             throw new RuntimeException(\"[HACK] Not enough items available of Item:\" + itemId + \", Quantity (After Quantity/Over Current Quantity): \" + (quantity - removeQuantity) + \"/\" + quantity);\n         }\n     }\n@@ -384,15 +416,17 @@ private static boolean isSameOwner(Item source, Item target) {\n     }\n     \n     public static void move(MapleClient c, MapleInventoryType type, short src, short dst) {\n+        MapleInventory inv = c.getPlayer().getInventory(type);\n+        \n         if (src < 0 || dst < 0) {\n             return;\n         }\n-        if(dst > c.getPlayer().getInventory(type).getSlotLimit()) {\n+        if(dst > inv.getSlotLimit()) {\n             return;\n         }\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        Item source = c.getPlayer().getInventory(type).getItem(src);\n-        Item initialTarget = c.getPlayer().getInventory(type).getItem(dst);\n+        Item source = inv.getItem(src);\n+        Item initialTarget = inv.getItem(dst);\n         if (source == null) {\n             return;\n         }\n@@ -402,7 +436,7 @@ public static void move(MapleClient c, MapleInventoryType type, short src, short\n         }\n         short oldsrcQ = source.getQuantity();\n         short slotMax = ii.getSlotMax(c, source.getItemId());\n-        c.getPlayer().getInventory(type).move(src, dst, slotMax);\n+        inv.move(src, dst, slotMax);\n         final List<ModifyInventory> mods = new ArrayList<>();\n         if (!(type.equals(MapleInventoryType.EQUIP) || type.equals(MapleInventoryType.CASH)) && initialTarget != null && initialTarget.getItemId() == source.getItemId() && !ItemConstants.isRechargeable(source.getItemId()) && isSameOwner(source, initialTarget)) {\n             if ((olddstQ + oldsrcQ) > slotMax) {\n@@ -419,76 +453,83 @@ public static void move(MapleClient c, MapleInventoryType type, short src, short\n     }\n \n     public static void equip(MapleClient c, short src, short dst) {\n-        Equip source = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem(src);\n-        if (source == null || !MapleItemInformationProvider.getInstance().canWearEquipment(c.getPlayer(), source, dst)) {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        \n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory eqpInv = chr.getInventory(MapleInventoryType.EQUIP);\n+        MapleInventory eqpdInv = chr.getInventory(MapleInventoryType.EQUIPPED);\n+        \n+        Equip source = (Equip) eqpInv.getItem(src);\n+        if (source == null || !ii.canWearEquipment(chr, source, dst)) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n-        } else if ((((source.getItemId() >= 1902000 && source.getItemId() <= 1902002) || source.getItemId() == 1912000) && c.getPlayer().isCygnus()) || ((source.getItemId() >= 1902005 && source.getItemId() <= 1902007) || source.getItemId() == 1912005) && !c.getPlayer().isCygnus()) {// Adventurer taming equipment\n+        } else if ((((source.getItemId() >= 1902000 && source.getItemId() <= 1902002) || source.getItemId() == 1912000) && chr.isCygnus()) || ((source.getItemId() >= 1902005 && source.getItemId() <= 1902007) || source.getItemId() == 1912005) && !chr.isCygnus()) {// Adventurer taming equipment\n             return;\n         }\n         boolean itemChanged = false;\n-        if (MapleItemInformationProvider.getInstance().isUntradeableOnEquip(source.getItemId())) {\n+        if (ii.isUntradeableOnEquip(source.getItemId())) {\n             source.setFlag((byte) ItemConstants.UNTRADEABLE);\n             itemChanged = true;\n         }\n-        if (source.getRingId() > -1) {\n-            c.getPlayer().getRingById(source.getRingId()).equip();\n-        }\n         if (dst == -6) { // unequip the overall\n-            Item top = c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem((short) -5);\n+            Item top = eqpdInv.getItem((short) -5);\n             if (top != null && ItemConstants.isOverall(top.getItemId())) {\n-                if (c.getPlayer().getInventory(MapleInventoryType.EQUIP).isFull()) {\n+                if (eqpInv.isFull()) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return;\n                 }\n-                unequip(c, (byte) -5, c.getPlayer().getInventory(MapleInventoryType.EQUIP).getNextFreeSlot());\n+                unequip(c, (byte) -5, eqpInv.getNextFreeSlot());\n             }\n         } else if (dst == -5) {\n-            final Item bottom = c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem((short) -6);\n+            final Item bottom = eqpdInv.getItem((short) -6);\n             if (bottom != null && ItemConstants.isOverall(source.getItemId())) {\n-                if (c.getPlayer().getInventory(MapleInventoryType.EQUIP).isFull()) {\n+                if (eqpInv.isFull()) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return;\n                 }\n-                unequip(c, (byte) -6, c.getPlayer().getInventory(MapleInventoryType.EQUIP).getNextFreeSlot());\n+                unequip(c, (byte) -6, eqpInv.getNextFreeSlot());\n             }\n         } else if (dst == -10) {// check if weapon is two-handed\n-            Item weapon = c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem((short) -11);\n-            if (weapon != null && MapleItemInformationProvider.getInstance().isTwoHanded(weapon.getItemId())) {\n-                if (c.getPlayer().getInventory(MapleInventoryType.EQUIP).isFull()) {\n+            Item weapon = eqpdInv.getItem((short) -11);\n+            if (weapon != null && ii.isTwoHanded(weapon.getItemId())) {\n+                if (eqpInv.isFull()) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return;\n                 }\n-                unequip(c, (byte) -11, c.getPlayer().getInventory(MapleInventoryType.EQUIP).getNextFreeSlot());\n+                unequip(c, (byte) -11, eqpInv.getNextFreeSlot());\n             }\n         } else if (dst == -11) {\n-            Item shield = c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem((short) -10);\n-            if (shield != null && MapleItemInformationProvider.getInstance().isTwoHanded(source.getItemId())) {\n-                if (c.getPlayer().getInventory(MapleInventoryType.EQUIP).isFull()) {\n+            Item shield = eqpdInv.getItem((short) -10);\n+            if (shield != null && ii.isTwoHanded(source.getItemId())) {\n+                if (eqpInv.isFull()) {\n                     c.announce(MaplePacketCreator.getInventoryFull());\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return;\n                 }\n-                unequip(c, (byte) -10, c.getPlayer().getInventory(MapleInventoryType.EQUIP).getNextFreeSlot());\n+                unequip(c, (byte) -10, eqpInv.getNextFreeSlot());\n             }\n         }\n         if (dst == -18) {\n-            if (c.getPlayer().getMount() != null) {\n-                c.getPlayer().getMount().setItemId(source.getItemId());\n+            if (chr.getMount() != null) {\n+                chr.getMount().setItemId(source.getItemId());\n             }\n         }\n-        if (source.getItemId() == 1122017) {\n-            c.getPlayer().equipPendantOfSpirit();\n-        }\n+        \n         //1112413, 1112414, 1112405 (Lilin's Ring)\n-        source = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem(src);\n-        Equip target = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem(dst);\n-        c.getPlayer().getInventory(MapleInventoryType.EQUIP).removeSlot(src);\n+        source = (Equip) eqpInv.getItem(src);\n+        Equip target = (Equip) eqpdInv.getItem(dst);\n+        eqpInv.removeSlot(src);\n         if (target != null) {\n-            c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).removeSlot(dst);\n+            eqpdInv.lockInventory();\n+            try {\n+                chr.unequippedItem(target);\n+                eqpdInv.removeSlot(dst);\n+            } finally {\n+                eqpdInv.unlockInventory();\n+            }\n         }\n \n         final List<ModifyInventory> mods = new ArrayList<>();\n@@ -498,23 +539,38 @@ public static void equip(MapleClient c, short src, short dst) {\n         }\n         \n         source.setPosition(dst);\n-        c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).addItemFromDB(source);\n+        \n+        eqpdInv.lockInventory();\n+        try {\n+            if (source.getRingId() > -1) {\n+                chr.getRingById(source.getRingId()).equip();\n+            }\n+            chr.equippedItem(source);\n+            eqpdInv.addItemFromDB(source);\n+        } finally {\n+            eqpdInv.unlockInventory();\n+        }\n+        \n         if (target != null) {\n             target.setPosition(src);\n-            c.getPlayer().getInventory(MapleInventoryType.EQUIP).addItemFromDB(target);\n+            eqpInv.addItemFromDB(target);\n         }\n-        if (c.getPlayer().getBuffedValue(MapleBuffStat.BOOSTER) != null && ItemConstants.isWeapon(source.getItemId())) {\n-            c.getPlayer().cancelBuffStats(MapleBuffStat.BOOSTER);\n+        if (chr.getBuffedValue(MapleBuffStat.BOOSTER) != null && ItemConstants.isWeapon(source.getItemId())) {\n+            chr.cancelBuffStats(MapleBuffStat.BOOSTER);\n         }\n         \n         mods.add(new ModifyInventory(2, source, src));\n         c.announce(MaplePacketCreator.modifyInventory(true, mods));\n-        c.getPlayer().equipChanged();\n+        chr.equipChanged();\n     }\n \n     public static void unequip(MapleClient c, short src, short dst) {\n-        Equip source = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem(src);\n-        Equip target = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem(dst);\n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory eqpInv = chr.getInventory(MapleInventoryType.EQUIP);\n+        MapleInventory eqpdInv = chr.getInventory(MapleInventoryType.EQUIPPED);\n+        \n+        Equip source = (Equip) eqpdInv.getItem(src);\n+        Equip target = (Equip) eqpInv.getItem(dst);\n         if (dst < 0) {\n             return;\n         }\n@@ -525,55 +581,62 @@ public static void unequip(MapleClient c, short src, short dst) {\n             c.announce(MaplePacketCreator.getInventoryFull());\n             return;\n         }\n-        if (source.getItemId() == 1122017) {\n-            c.getPlayer().unequipPendantOfSpirit();\n-        }\n-        if (source.getRingId() > -1) {\n-            c.getPlayer().getRingById(source.getRingId()).unequip();\n+        \n+        eqpdInv.lockInventory();\n+        try {\n+            if (source.getRingId() > -1) {\n+                chr.getRingById(source.getRingId()).unequip();\n+            }\n+            chr.unequippedItem(source);\n+            eqpdInv.removeSlot(src);\n+        } finally {\n+            eqpdInv.unlockInventory();\n         }\n-        c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).removeSlot(src);\n+        \n         if (target != null) {\n-            c.getPlayer().getInventory(MapleInventoryType.EQUIP).removeSlot(dst);\n+            eqpInv.removeSlot(dst);\n         }\n         source.setPosition(dst);\n-        c.getPlayer().getInventory(MapleInventoryType.EQUIP).addItemFromDB(source);\n+        eqpInv.addItemFromDB(source);\n         if (target != null) {\n             target.setPosition(src);\n-            c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).addItemFromDB(target);\n+            eqpdInv.addItemFromDB(target);\n         }\n         c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(2, source, src))));\n-        c.getPlayer().equipChanged();\n+        chr.equipChanged();\n     }\n \n     public static void drop(MapleClient c, MapleInventoryType type, short src, short quantity) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         if (src < 0) {\n             type = MapleInventoryType.EQUIPPED;\n         }\n-        Item source = c.getPlayer().getInventory(type).getItem(src);\n+        \n+        MapleCharacter chr = c.getPlayer();\n+        MapleInventory inv = chr.getInventory(type);\n+        Item source = inv.getItem(src);\n \n-        if (c.getPlayer().getTrade() != null || c.getPlayer().getMiniGame() != null || source == null) { //Only check needed would prob be merchants (to see if the player is in one)\n+        if (chr.getTrade() != null || chr.getMiniGame() != null || source == null) { //Only check needed would prob be merchants (to see if the player is in one)\n         \treturn;\n         }\n         int itemId = source.getItemId();\n         if (ItemConstants.isPet(itemId)) {\n             return;\n         }\n-        if (type == MapleInventoryType.EQUIPPED && itemId == 1122017) {\n-            c.getPlayer().unequipPendantOfSpirit();\n-        }\n-        if (c.getPlayer().getItemEffect() == itemId && source.getQuantity() == 1) {\n-            c.getPlayer().setItemEffect(0);\n-            c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.itemEffect(c.getPlayer().getId(), 0));\n+        \n+        MapleMap map = chr.getMap();\n+        if (chr.getItemEffect() == itemId && source.getQuantity() == 1) {\n+            chr.setItemEffect(0);\n+            map.broadcastMessage(MaplePacketCreator.itemEffect(chr.getId(), 0));\n         } else if (itemId == 5370000 || itemId == 5370001) {\n-            if (c.getPlayer().getItemQuantity(itemId, false) == 1) {\n-                c.getPlayer().setChalkboard(null);\n+            if (chr.getItemQuantity(itemId, false) == 1) {\n+                chr.setChalkboard(null);\n             }\n         }\n         if ((!ItemConstants.isRechargeable(itemId) && source.getQuantity() < quantity) || quantity < 0) {\n             return;\n         }\n-        Point dropPos = new Point(c.getPlayer().getPosition());\n+        Point dropPos = new Point(chr.getPosition());\n         if (quantity < source.getQuantity() && !ItemConstants.isRechargeable(itemId)) {\n             Item target = source.copy();\n             target.setQuantity(quantity);\n@@ -582,50 +645,61 @@ public static void drop(MapleClient c, MapleInventoryType type, short src, short\n             \n             if(ItemConstants.isNewYearCardEtc(itemId)) {\n                 if(itemId == 4300000) {\n-                    NewYearCardRecord.removeAllNewYearCard(true, c.getPlayer());\n+                    NewYearCardRecord.removeAllNewYearCard(true, chr);\n                     c.getAbstractPlayerInteraction().removeAll(4300000);\n                 } else {\n-                    NewYearCardRecord.removeAllNewYearCard(false, c.getPlayer());\n+                    NewYearCardRecord.removeAllNewYearCard(false, chr);\n                     c.getAbstractPlayerInteraction().removeAll(4301000);\n                 }\n             } else if (ItemConstants.isWeddingRing(source.getItemId())) {\n-                c.getPlayer().getMap().disappearingItemDrop(c.getPlayer(), c.getPlayer(), target, dropPos);\n-            } else if (c.getPlayer().getMap().getEverlast()) {\n+                map.disappearingItemDrop(chr, chr, target, dropPos);\n+            } else if (map.getEverlast()) {\n                 if (ii.isDropRestricted(target.getItemId()) || ii.isCash(target.getItemId()) || isDroppedItemRestricted(target)) {\n-                    c.getPlayer().getMap().disappearingItemDrop(c.getPlayer(), c.getPlayer(), target, dropPos);\n+                    map.disappearingItemDrop(chr, chr, target, dropPos);\n                 } else {\n-                    c.getPlayer().getMap().spawnItemDrop(c.getPlayer(), c.getPlayer(), target, dropPos, true, true);\n+                    map.spawnItemDrop(chr, chr, target, dropPos, true, true);\n                 }\n             } else if (ii.isDropRestricted(target.getItemId()) || ii.isCash(target.getItemId()) || isDroppedItemRestricted(target)) {\n-                c.getPlayer().getMap().disappearingItemDrop(c.getPlayer(), c.getPlayer(), target, dropPos);\n+                map.disappearingItemDrop(chr, chr, target, dropPos);\n             } else {\n-                c.getPlayer().getMap().spawnItemDrop(c.getPlayer(), c.getPlayer(), target, dropPos, true, true);\n+                map.spawnItemDrop(chr, chr, target, dropPos, true, true);\n             }\n         } else {\n-            c.getPlayer().getInventory(type).removeSlot(src);\n+            if (type == MapleInventoryType.EQUIPPED) {\n+                inv.lockInventory();\n+                try {\n+                    chr.unequippedItem((Equip) source);\n+                    inv.removeSlot(src);\n+                } finally {\n+                    inv.unlockInventory();\n+                }\n+            } else {\n+                inv.removeSlot(src);\n+            }\n+            \n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(3, source))));\n             if (src < 0) {\n-                c.getPlayer().equipChanged();\n+                chr.equipChanged();\n             } else if(ItemConstants.isNewYearCardEtc(itemId)) {\n                 if(itemId == 4300000) {\n-                    NewYearCardRecord.removeAllNewYearCard(true, c.getPlayer());\n+                    NewYearCardRecord.removeAllNewYearCard(true, chr);\n                     c.getAbstractPlayerInteraction().removeAll(4300000);\n                 } else {\n-                    NewYearCardRecord.removeAllNewYearCard(false, c.getPlayer());\n+                    NewYearCardRecord.removeAllNewYearCard(false, chr);\n                     c.getAbstractPlayerInteraction().removeAll(4301000);\n                 }\n             }\n             \n-            if (c.getPlayer().getMap().getEverlast()) {\n+            if (map.getEverlast()) {\n                 if (ii.isDropRestricted(itemId) || ii.isCash(itemId) || isDroppedItemRestricted(source)) {\n-                    c.getPlayer().getMap().disappearingItemDrop(c.getPlayer(), c.getPlayer(), source, dropPos);\n+                    map.disappearingItemDrop(chr, chr, source, dropPos);\n                 } else {\n-                    c.getPlayer().getMap().spawnItemDrop(c.getPlayer(), c.getPlayer(), source, dropPos, true, true);\n+                    map.spawnItemDrop(chr, chr, source, dropPos, true, true);\n                 }\n             } else if (ii.isDropRestricted(itemId) || ii.isCash(itemId) || isDroppedItemRestricted(source)) {\n-                c.getPlayer().getMap().disappearingItemDrop(c.getPlayer(), c.getPlayer(), source, dropPos);           \n+                map.disappearingItemDrop(chr, chr, source, dropPos);           \n             } else {\n-                c.getPlayer().getMap().spawnItemDrop(c.getPlayer(), c.getPlayer(), source, dropPos, true, true);\n+                map.spawnItemDrop(chr, chr, source, dropPos, true, true);\n             }\n         }\n     }"}, {"sha": "d806d2b6144b1724113e9a70d9c43673804c9188", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -41,8 +41,8 @@\n     //Server Flags\n     public static final boolean USE_CUSTOM_KEYSET = true;           //Enables auto-setup of the HeavenMS's custom keybindings when creating characters.\n     public static final boolean USE_DEBUG = false;                  //Will enable some text prints on the client, oriented for debugging purposes.\n-    public static final boolean USE_DEBUG_SHOW_RCVD_PACKET = false; //Prints on the cmd all received packet ids.\n     public static final boolean USE_DEBUG_SHOW_INFO_EQPEXP = false; //Prints on the cmd all equip exp gain info.\n+    public static       boolean USE_DEBUG_SHOW_RCVD_PACKET = false; //Prints on the cmd all received packet ids.\n     \n     public static final boolean USE_MAXRANGE_ECHO_OF_HERO = true;\n     public static final boolean USE_MAXRANGE = true;                //Will send and receive packets from all events on a map, rather than those of only view range.\n@@ -74,7 +74,6 @@\n     public static final boolean USE_ERASE_UNTRADEABLE_DROP = true;  //Forces flagged untradeable items to disappear when dropped.\n     public static final boolean USE_ERASE_PET_ON_EXPIRATION = false;//Forces pets to be removed from inventory when expire time comes, rather than converting it to a doll.\n     public static final boolean USE_BUFF_MOST_SIGNIFICANT = true;   //When applying buffs, the player will stick with the highest stat boost among the listed, rather than overwriting stats.\n-    public static final boolean USE_QUEST_RATE = false;             //Exp/Meso gained by quests uses fixed server exp/meso rate times quest rate as multiplier, instead of player rates.\n     public static final boolean USE_MULTIPLE_SAME_EQUIP_DROP = true;//Enables multiple drops by mobs of the same equipment, number of possible drops based on the quantities provided at the drop data.\n     public static final boolean USE_BANISHABLE_TOWN_SCROLL = true;  //Enables town scrolls to act as if it's a \"player banish\", rendering the antibanish scroll effect available.\n     public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;  //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n@@ -155,6 +154,10 @@\n     public static final boolean USE_ADD_RATES_BY_LEVEL = true;  //Rates are added each 20 levels.\n     public static final boolean USE_STACK_COUPON_RATES = true;  //Multiple coupons effects builds up together.\n     public static final boolean USE_PERFECT_PITCH = true;       //For lvl 30 or above, each lvlup grants player 1 perfect pitch.\n+    \n+    //Quest Configuration\n+    public static final boolean USE_QUEST_RATE = false;         //Exp/Meso gained by quests uses fixed server exp/meso rate times quest rate as multiplier, instead of player rates.\n+    public static final int FAME_GAIN_MIN_HOUR_INTERVAL = 24;   //Minimum time interval in hours the repeatable quest must have to be accounted for the \"fame gain by quest\".\n     public static final int FAME_GAIN_BY_QUEST = 4;             //Fame gain each N quest completes, set 0 to disable.\n     \n     //Guild Configuration"}, {"sha": "aa5409c5eb3c4a3d7c2729992899e049c9743d0c", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -28,6 +28,8 @@\n import java.util.Calendar;\n import java.util.concurrent.atomic.AtomicLong;\n \n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.Server;\n \n import org.apache.mina.core.service.IoHandlerAdapter;\n@@ -46,14 +48,12 @@\n import java.util.Arrays;\n \n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n import java.util.concurrent.ScheduledFuture;\n \n import java.util.HashMap;\n import java.util.Map;\n import java.util.Map.Entry;\n import server.TimerManager;\n-import tools.locks.MonitoredLockType;\n \n public class MapleServerHandler extends IoHandlerAdapter {\n     private final static Set<Short> ignoredDebugRecvPackets = new HashSet<>(Arrays.asList((short) 167, (short) 197, (short) 89, (short) 91, (short) 41, (short) 188, (short) 107));"}, {"sha": "df97a58a4c7f875c53de0647408210655488f638", "filename": "src/net/server/CreateINI.java", "status": "removed", "additions": 0, "deletions": 131, "changes": 131, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3752ebbae5b03f184015e13296ecb0629d4de3e6/src/net/server/CreateINI.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3752ebbae5b03f184015e13296ecb0629d4de3e6/src/net/server/CreateINI.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/CreateINI.java?ref=3752ebbae5b03f184015e13296ecb0629d4de3e6", "patch": "@@ -1,131 +0,0 @@\n-package net.server;\n-\n-import java.io.Console;\n-import java.io.FileOutputStream;\n-import java.io.IOException;\n-\n-/**\n- *\n- * @author kevintjuh93\n- */\n-public class CreateINI {\n-\n-    public static void main(String args[]) {\n-        StringBuilder sb = new StringBuilder();\n-        String nextline = \"\\r\\n\";//Because I can, and it's free.\n-        byte worlds;\n-        Console con = System.console();\n-\n-        System.out.println(\"Welcome to MoopleDEV's .ini creator\\r\\n\\r\\n\");\n-\n-        sb.append(\"#MoopleDEV's INI file. Do NOT modify it if you are an idiot (:\\r\\n\");\n-        sb.append(\"#Flag types: 0 = nothing, 1 = event, 2 = new, 3 = hot\\r\\n\\r\\n\");\n-\n-        System.out.println(\"Flag types: 0 = nothing, 1 = event, 2 = new, 3 = hot\\r\\n\\r\\n\");\n-\n-        worlds = Byte.parseByte(con.readLine(\"Number of worlds: \"));\n-        sb.append(\"worlds=\").append(worlds).append(\"\\r\\n\\r\\n\");\n-\n-        System.out.println(\"\\r\\n\");\n-\n-\n-        for (byte b = 0; b < worlds; b++) {\n-            sb.append(\"#Properties for world \").append(b).append(\"\\r\\n\");\n-\n-            System.out.println(\"Properties for world \" + b);\n-            if (b > 1) {\n-                System.out.println(\"Make sure you create a npc folder for this world!\");\n-            }\n-            sb.append(\"flag\").append(b).append(\"=\").append(\n-                    Integer.parseInt(con.readLine(\"   Flag: \"))).append(\"\\r\\n\");\n-\n-            sb.append(\"servermessage\").append(b).append(\"=\").append(\n-                    con.readLine(\"   Server message: \")).append(\"\\r\\n\");\n-\n-            sb.append(\"eventmessage\").append(b).append(\"=\").append(\n-                    con.readLine(\"   Event message: \")).append(\"\\r\\n\");\n-\n-            sb.append(\"whyamirecommended\").append(b).append(\"=\").append(\n-                    con.readLine(\"   Recommend message: \")).append(\"\\r\\n\");\n-\n-            sb.append(\"channels\").append(b).append(\"=\").append(\n-                    Byte.parseByte(con.readLine(\"   Number of channels: \"))).append(\"\\r\\n\");\n-\n-            sb.append(\"exprate\").append(b).append(\"=\").append(\n-                    Integer.parseInt(con.readLine(\"   Exp rate: \"))).append(\"\\r\\n\");\n-\n-            sb.append(\"droprate\").append(b).append(\"=\").append(\n-                    Integer.parseInt(con.readLine(\"   Drop rate: \"))).append(\"\\r\\n\");\n-\n-            sb.append(\"mesorate\").append(b).append(\"=\").append(\n-                    Integer.parseInt(con.readLine(\"   Meso rate: \"))).append(\"\\r\\n\");\n-\n-            sb.append(\"questrate\").append(b).append(\"=\").append(\n-                    Integer.parseInt(con.readLine(\"   Quest rate: \"))).append(\"\\r\\n\");\n-\n-            System.out.println(nextline);\n-            sb.append(\"\\r\\n\");\n-        }\n-\n-        sb.append(\"\\r\\n\").append(\"gmserver=\").append(Boolean.parseBoolean(con.readLine(\"Do you want a GM Server? (true/false)\")));\n-        FileOutputStream out = null;\n-        try {\n-            out = new FileOutputStream(\"moople.ini\", false);\n-            out.write(sb.toString().getBytes());\n-        } catch (Exception ex) {\n-            ex.printStackTrace();\n-        } finally {\n-            try {\n-                if (out != null) {\n-                    out.close();\n-                }\n-            } catch (IOException ex) {\n-                ex.printStackTrace();\n-            }\n-        }\n-\n-        sb = new StringBuilder();\n-        try {\n-            System.out.println(\"\\r\\nYou are about to set the Java Heap Size, if you don't know what it is, type '?'.\");\n-            String heapsize = con.readLine(\"Java Heap Size (in MB): \");\n-            while (heapsize.equals(\"?\")) {\n-                System.out.println(\"\\r\\n\");\n-                System.out.println(\"WikiAnswers: Java heap is the heap size allocated to JVM applications which takes care of the new objects being created. If the objects being created exceed the heap size, it will throw an error saying memoryOutof Bound\\r\\n\");\n-                System.out.println(\"I recommend using 64 bit with the heap size around 4000, if you have 4 gb RAM.\");\n-                heapsize = con.readLine(\"Java Heap Size (in MB): \");\n-            }\n-            String linux = con.readLine(\"\\r\\nAre you using a Linux platform or not? (y/n):\");\n-            while (!linux.equals(\"y\") && !linux.equals(\"n\")) {\n-                System.out.println(\"Type 'y' if you use linux else type 'n'.\");\n-                linux = con.readLine(\"Are you using a Linux platform or not? (y/n):\");\n-            }\n-            if (linux.equals(\"n\")) {\n-                out = new FileOutputStream(\"launch_server.bat\", false);\n-                sb.append(\"@echo off\").append(\"\\r\\n\").append(\"@title MoopleDEV Server v83\").append(\"\\r\\n\");\n-                sb.append(\"set CLASSPATH=.;dist\\\\*\\r\\n\");\n-                sb.append(\"java -Xmx\").append(heapsize).append(\"m -Dwzpath=wz\\\\ net.server.Server\\r\\n\");\n-                sb.append(\"pause\");\n-            } else {//test\n-                out = new FileOutputStream(\"launch_server.sh\", false);\n-                sb.append(\"#!/bin/sh\").append(\"\\r\\n\\r\\n\");\n-                sb.append(\"export CLASSPATH=\\\".:dist/*\\\" \\r\\n\\r\\n\");\n-                sb.append(\"java -Dwzpath=wz/ \\\\\\r\\n\");\n-                sb.append(\"-Xmx\").append(heapsize).append(\"m \").append(\"net.server.Server\");\n-                System.out.println(\"Use DOS2UNIX command to convert the .sh file once again.\");\n-            }\n-            out.write(sb.toString().getBytes());\n-        } catch (Exception ex) {\n-            ex.printStackTrace();\n-        } finally {\n-            try {\n-                if (out != null) {\n-                    out.close();\n-                }\n-            } catch (IOException ex) {\n-                ex.printStackTrace();\n-            }\n-        }\n-        System.out.println(\"\\r\\nMake sure that ServerConstants in modified too, and clean+compiled before you start the server.\");\n-        System.out.println(\"If you want other settings; restart this .bat or modify the moople.ini\");\n-    }\n-}"}, {"sha": "5efb6029e791ece3c2650af166bdd43c2b06db22", "filename": "src/net/server/PlayerBuffStorage.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/PlayerBuffStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/PlayerBuffStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/PlayerBuffStorage.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -28,8 +28,8 @@\n import java.util.concurrent.locks.Lock;\n import server.life.MobSkill;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n  *"}, {"sha": "ae6d59542963796ef6ccb2a40e4b983aab91ee54", "filename": "src/net/server/PlayerStorage.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/PlayerStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/PlayerStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/PlayerStorage.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -27,11 +27,11 @@\n import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n \n public class PlayerStorage {\n     private final ReentrantReadWriteLock locks = new MonitoredReentrantReadWriteLock(MonitoredLockType.PLAYER_STORAGE, true);"}, {"sha": "e45c35f36600f50a80505c7832a1654280427030", "filename": "src/net/server/Server.java", "status": "modified", "additions": 25, "deletions": 14, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -41,12 +41,16 @@\n import java.util.Properties;\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicLong;\n-import tools.locks.MonitoredReentrantLock;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n+\n+import net.server.audit.ThreadTracker;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n+\n import net.MapleServerHandler;\n import net.mina.MapleCodecFactory;\n import net.server.channel.Channel;\n@@ -75,7 +79,6 @@\n import constants.ItemConstants;\n import constants.GameConstants;\n import constants.ServerConstants;\n-import net.server.audit.ThreadTracker;\n import server.CashShop.CashItemFactory;\n import server.TimerManager;\n import server.life.MaplePlayerNPCFactory;\n@@ -84,7 +87,6 @@\n import tools.DatabaseConnection;\n import tools.FilePrinter;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n \n public class Server {\n     private static final Set<Integer> activeFly = new HashSet<>();\n@@ -325,18 +327,27 @@ public void updateActiveCoupons() throws SQLException {\n     }\n     \n     public void runAnnouncePlayerDiseasesSchedule() {\n+        List<MapleClient> processDiseaseAnnounceClients;\n         disLock.lock();\n         try {\n-            while(!processDiseaseAnnouncePlayers.isEmpty()) {\n-                MapleClient c = processDiseaseAnnouncePlayers.remove(0);\n-                MapleCharacter player = c.getPlayer();\n-                if(player != null && player.isLoggedinWorld()) {\n-                    for(MapleCharacter chr : player.getMap().getCharacters()) {\n-                        chr.announceDiseases(c);\n-                    }\n+            processDiseaseAnnounceClients = new LinkedList<>(processDiseaseAnnouncePlayers);\n+            processDiseaseAnnouncePlayers.clear();\n+        } finally {\n+            disLock.unlock();\n+        }\n+        \n+        while(!processDiseaseAnnounceClients.isEmpty()) {\n+            MapleClient c = processDiseaseAnnounceClients.remove(0);\n+            MapleCharacter player = c.getPlayer();\n+            if(player != null && player.isLoggedinWorld()) {\n+                for(MapleCharacter chr : player.getMap().getCharacters()) {\n+                    chr.announceDiseases(c);\n                 }\n             }\n-            \n+        }\n+        \n+        disLock.lock();\n+        try {\n             // this is to force the system to wait for at least one complete tick before releasing disease info for the registered clients\n             while(!registeredDiseaseAnnouncePlayers.isEmpty()) {\n                 MapleClient c = registeredDiseaseAnnouncePlayers.remove(0);\n@@ -362,7 +373,7 @@ public void init() {\n             p.load(new FileInputStream(\"world.ini\"));\n         } catch (Exception e) {\n             e.printStackTrace();\n-            System.out.println(\"Please start create_server.bat\");\n+            System.out.println(\"[SEVERE] Could not find/open 'world.ini'.\");\n             System.exit(0);\n         }\n \n@@ -453,7 +464,7 @@ public void init() {\n             loadPlayerNpcMapStepFromDb();\n         } catch (Exception e) {\n             e.printStackTrace();//For those who get errors\n-            System.out.println(\"Error in moople.ini, start CreateINI.bat to re-make the file.\");\n+            System.out.println(\"[SEVERE] Syntax error in 'world.ini'.\");\n             System.exit(0);\n         }\n "}, {"sha": "3566d2ed7182539f8d26385e85921389312a093d", "filename": "src/net/server/audit/ThreadTracker.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/ThreadTracker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/ThreadTracker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/ThreadTracker.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -34,10 +34,11 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantLock;\n+\n+import constants.ServerConstants;\n+import net.server.audit.locks.MonitoredLockType;\n import server.TimerManager;\n import tools.FilePrinter;\n-import tools.locks.MonitoredLockType;\n-import constants.ServerConstants;\n \n /**\n  *"}, {"sha": "6312af1f20a4a42b43fddbf12f2b57e9c1448376", "filename": "src/net/server/audit/locks/MonitoredLockType.java", "status": "renamed", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredLockType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredLockType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredLockType.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -17,7 +17,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package tools.locks;\n+package net.server.audit.locks;\n \n /**\n  *\n@@ -49,6 +49,8 @@\n     CHANNEL_FACESCHDL,\n     CHANNEL_MOBACTION,\n     CHANNEL_MOBANIMAT,\n+    CHANNEL_MOBMIST,\n+    CHANNEL_MOBSKILL,\n     CHANNEL_MOBSTATUS,\n     CHANNEL_OVTSTATUS,\n     CHANNEL_OVERALL,", "previous_filename": "src/tools/locks/MonitoredLockType.java"}, {"sha": "3484412f2781755e43f0644c9c8c50ac553ab9d4", "filename": "src/net/server/audit/locks/MonitoredReadLock.java", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredReadLock.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -17,7 +17,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package tools.locks;\n+package net.server.audit.locks;\n \n import constants.ServerConstants;\n import java.text.DateFormat;", "previous_filename": "src/tools/locks/MonitoredReadLock.java"}, {"sha": "bb44cf35b7bef42db728d27c4343098cf738d527", "filename": "src/net/server/audit/locks/MonitoredReentrantLock.java", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredReentrantLock.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -17,7 +17,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package tools.locks;\n+package net.server.audit.locks;\n \n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.locks.Lock;", "previous_filename": "src/tools/locks/MonitoredReentrantLock.java"}, {"sha": "96a2a9e71239bfe029525e8a940ded6803fbe638", "filename": "src/net/server/audit/locks/MonitoredReentrantReadWriteLock.java", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReentrantReadWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredReentrantReadWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredReentrantReadWriteLock.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -17,7 +17,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package tools.locks;\n+package net.server.audit.locks;\n \n import java.util.concurrent.locks.ReentrantReadWriteLock;\n ", "previous_filename": "src/tools/locks/MonitoredReentrantReadWriteLock.java"}, {"sha": "ecbd800af800387095fd67c0974c0efebffd1569", "filename": "src/net/server/audit/locks/MonitoredWriteLock.java", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/audit/locks/MonitoredWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredWriteLock.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -17,7 +17,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package tools.locks;\n+package net.server.audit.locks;\n \n import constants.ServerConstants;\n import java.text.DateFormat;", "previous_filename": "src/tools/locks/MonitoredWriteLock.java"}, {"sha": "45668ae0df104d903c0d6b100022d97f8197fa96", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -34,11 +34,12 @@\n import java.util.Set;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n \n import net.MapleServerHandler;\n import net.mina.MapleCodecFactory;\n@@ -76,7 +77,6 @@\n import client.status.MonsterStatusEffect;\n import constants.ServerConstants;\n import server.maps.MapleMiniDungeonInfo;\n-import tools.locks.MonitoredLockType;\n \n public final class Channel {\n \n@@ -89,6 +89,8 @@\n     private EventScriptManager eventSM;\n     private MobStatusScheduler mobStatusSchedulers[] = new MobStatusScheduler[4];\n     private MobAnimationScheduler mobAnimationSchedulers[] = new MobAnimationScheduler[4];\n+    private MobClearSkillScheduler mobClearSkillSchedulers[] = new MobClearSkillScheduler[4];\n+    private MobMistScheduler mobMistSchedulers[] = new MobMistScheduler[4];\n     private FaceExpressionScheduler faceExpressionSchedulers[] = new FaceExpressionScheduler[4];\n     private OverallScheduler channelSchedulers[] = new OverallScheduler[4];\n     private Map<Integer, MapleHiredMerchant> hiredMerchants = new HashMap<>();\n@@ -164,6 +166,8 @@ public Channel(final int world, final int channel, long startTime) {\n                 \n                 mobStatusSchedulers[i] = new MobStatusScheduler();\n                 mobAnimationSchedulers[i] = new MobAnimationScheduler();\n+                mobClearSkillSchedulers[i] = new MobClearSkillScheduler();\n+                mobMistSchedulers[i] = new MobMistScheduler();\n                 faceExpressionSchedulers[i] = new FaceExpressionScheduler(faceLock[i]);\n                 channelSchedulers[i] = new OverallScheduler();\n             }\n@@ -868,6 +872,14 @@ public boolean registerMobOnAnimationEffect(int mapid, int mobHash, long delay)\n         return mobAnimationSchedulers[getChannelSchedulerIndex(mapid)].registerAnimationMode(mobHash, delay);\n     }\n     \n+    public void registerMobClearSkillAction(int mapid, Runnable runAction, long delay) {\n+        mobClearSkillSchedulers[getChannelSchedulerIndex(mapid)].registerClearSkillAction(runAction, delay);\n+    }\n+    \n+    public void registerMobMistCancelAction(int mapid, Runnable runAction, long delay) {\n+        mobMistSchedulers[getChannelSchedulerIndex(mapid)].registerMistCancelAction(runAction, delay);\n+    }\n+    \n     public void registerOverallAction(int mapid, Runnable runAction, long delay) {\n         channelSchedulers[getChannelSchedulerIndex(mapid)].registerDelayedAction(runAction, delay);\n     }"}, {"sha": "4b36d262534785e61dd69fdcb755013ce9941715", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -674,6 +674,8 @@ protected AttackInfo parseDamage(LittleEndianAccessor lea, MapleCharacter chr, b\n                     // This formula is still a bit wonky, but it is fairly accurate.\n                     calcDmgMax = (int) Math.round((chr.getTotalInt() * 4.8 + chr.getTotalLuk() * 4) * chr.getTotalMagic() / 1000);\n                     calcDmgMax = calcDmgMax * effect.getHp() / 100; \n+                    \n+                    ret.speed = 7;\n                 }\n             } else if(ret.skill == Hermit.SHADOW_MESO) {\n                 // Shadow Meso also has its own formula"}, {"sha": "bcbe2d810ded10080f25ee84f350c34f20e18be0", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -230,7 +230,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         } else if (action == 0x0E) { // Put into Cash Inventory\n             int cashId = slea.readInt();\n             slea.skip(4);\n-            MapleInventory mi = chr.getInventory(MapleInventoryType.getByType(slea.readByte()));\n+            \n+            byte invType = slea.readByte();\n+            if (invType < 1 || invType > 5) {\n+                c.disconnect(false, false);\n+                return;\n+            }\n+            \n+            MapleInventory mi = chr.getInventory(MapleInventoryType.getByType(invType));\n             Item item = mi.findByCashId(cashId);\n             if (item == null) {\n                 c.announce(MaplePacketCreator.enableActions());"}, {"sha": "cbc2f2162138768c744d737bb5677f7dca72655c", "filename": "src/net/server/channel/handlers/InventoryMergeHandler.java", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/InventoryMergeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/InventoryMergeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/InventoryMergeHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -39,13 +39,19 @@\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         chr.getAutobanManager().setTimestamp(2, slea.readInt(), 3);\n-        MapleInventoryType inventoryType = MapleInventoryType.getByType(slea.readByte());\n-                \n-\tif(!ServerConstants.USE_ITEM_SORT) {\n+        \n+        if(!ServerConstants.USE_ITEM_SORT) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n \t}\n-\t\t\n+        \n+        byte invType = slea.readByte();\n+        if (invType < 1 || invType > 5) {\n+            c.disconnect(false, false);\n+            return;\n+        }\n+        \n+        MapleInventoryType inventoryType = MapleInventoryType.getByType(invType);\t\n \tMapleInventory inventory = c.getPlayer().getInventory(inventoryType);\n         inventory.lockInventory();\n         try {"}, {"sha": "26e088a5d684498c1f9ee6f52f21624e2668ed2c", "filename": "src/net/server/channel/handlers/InventorySortHandler.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/InventorySortHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/InventorySortHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/InventorySortHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -188,22 +188,22 @@ public PairedQuicksort(ArrayList<Item> A, int primarySort, int secondarySort) {\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         chr.getAutobanManager().setTimestamp(3, slea.readInt(), 3);\n-        byte inventoryType = slea.readByte();\n         \n         if(!ServerConstants.USE_ITEM_SORT) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         }\n-\t\t\n-\tif (inventoryType < 1 || inventoryType > 5) {\n+        \n+        byte invType = slea.readByte();\n+        if (invType < 1 || invType > 5) {\n             c.disconnect(false, false);\n             return;\n         }\n \t\n         ArrayList<Item> itemarray = new ArrayList<>();\n         List<ModifyInventory> mods = new ArrayList<>();\n         \n-        MapleInventory inventory = chr.getInventory(MapleInventoryType.getByType(inventoryType));\n+        MapleInventory inventory = chr.getInventory(MapleInventoryType.getByType(invType));\n         inventory.lockInventory();\n         try {\n             for (short i = 1; i <= inventory.getSlotLimit(); i++) {\n@@ -218,7 +218,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     mods.add(new ModifyInventory(3, item));\n             }\n \n-            int invTypeCriteria = (MapleInventoryType.getByType(inventoryType) == MapleInventoryType.EQUIP) ? 3 : 1;\n+            int invTypeCriteria = (MapleInventoryType.getByType(invType) == MapleInventoryType.EQUIP) ? 3 : 1;\n             int sortCriteria = (ServerConstants.USE_ITEM_SORT_BY_NAME == true) ? 2 : 0;\n             PairedQuicksort pq = new PairedQuicksort(itemarray, sortCriteria, invTypeCriteria);\n \n@@ -232,7 +232,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         c.announce(MaplePacketCreator.modifyInventory(true, mods));\n-        c.announce(MaplePacketCreator.finishedSort2(inventoryType));\n+        c.announce(MaplePacketCreator.finishedSort2(invType));\n         c.announce(MaplePacketCreator.enableActions());\n     }\n }"}, {"sha": "d12960167b070fc0f827360c2227f82352da140a", "filename": "src/net/server/channel/handlers/NPCAnimationHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/NPCAnimationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/NPCAnimationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NPCAnimationHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -28,6 +28,7 @@\n import tools.data.output.MaplePacketLittleEndianWriter;\n \n public final class NPCAnimationHandler extends AbstractMaplePacketHandler {\n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n         int length = (int) slea.available();"}, {"sha": "2107b11d615dda2ac3df77a9a772bac4dea5951d", "filename": "src/net/server/channel/handlers/PetAutoPotHandler.java", "status": "modified", "additions": 2, "deletions": 16, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PetAutoPotHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PetAutoPotHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetAutoPotHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -161,22 +161,8 @@ private boolean cursorOnNextAvailablePot(MapleCharacter chr) {\n         return false;\n     }\n     \n-    private Pair<Short, Short> calcEffectivePool(MapleCharacter chr) {\n-        short hp = 0, mp = 0;\n-        \n-        if(ServerConstants.USE_EQUIPS_ON_AUTOPOT) {\n-            for(Item i : chr.getInventory(MapleInventoryType.EQUIPPED).list()) {\n-                Equip e = (Equip) i;\n-\n-                hp += e.getHp();\n-                mp += e.getMp();\n-            }\n-        }\n-\n-        hp = (short) Math.min(chr.getMaxHp() + hp, 30000);\n-        mp = (short) Math.min(chr.getMaxMp() + mp, 30000);\n-        \n-        return new Pair<>(hp, mp);\n+    private static Pair<Short, Short> calcEffectivePool(MapleCharacter chr) {\n+        return new Pair<>((short) chr.getMaxHpEquipped(), (short) chr.getMaxMpEquipped());\n     }\n     \n     private boolean shouldReusePot() {"}, {"sha": "c6723d348c0177a7371647c5f4ef55bfcecb19b0", "filename": "src/net/server/channel/handlers/PetLootHandler.java", "status": "modified", "additions": 25, "deletions": 16, "changes": 41, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PetLootHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PetLootHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetLootHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -25,7 +25,6 @@\n \n import client.MapleCharacter;\n import client.MapleClient;\n-import client.inventory.MapleInventoryType;\n import client.inventory.MaplePet;\n import net.AbstractMaplePacketHandler;\n import server.maps.MapleMapItem;\n@@ -58,25 +57,35 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int oid = slea.readInt();\n         MapleMapObject ob = chr.getMap().getMapObject(oid);\n         if(ob == null) {\n-            c.getSession().write(MaplePacketCreator.enableActions());\n+            c.announce(MaplePacketCreator.enableActions());\n             return;\n         }\n         \n-        if (chr.getInventory(MapleInventoryType.EQUIPPED).findById(1812007) != null) {\n-            final Set<Integer> petIgnore = chr.getExcludedItems();\n-            MapleMapItem mapitem = (MapleMapItem) ob;\n+        MapleMapItem mapitem = (MapleMapItem) ob;\n+        if (mapitem.getMeso() > 0) {\n+            if (!chr.isEquippedMesoMagnet()) {\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n+            \n+            if (chr.isEquippedPetItemIgnore()) {\n+                final Set<Integer> petIgnore = chr.getExcludedItems();\n+                if(!petIgnore.isEmpty() && petIgnore.contains(Integer.MAX_VALUE)) {\n+                    c.announce(MaplePacketCreator.enableActions());\n+                    return;\n+                }\n+            }\n+        } else {\n+            if (!chr.isEquippedItemPouch()) {\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n             \n-            if(!petIgnore.isEmpty()) {\n-                if (chr.getInventory(MapleInventoryType.EQUIPPED).findById(1812000) != null) { // Meso magnet\n-                    if (mapitem.getMeso() > 0 && petIgnore.contains(Integer.MAX_VALUE)) {\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                } else if (chr.getInventory(MapleInventoryType.EQUIPPED).findById(1812001) != null) { // Item Pouch\n-                    if (petIgnore.contains(mapitem.getItem().getItemId())) {\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n+            if (chr.isEquippedPetItemIgnore()) {\n+                final Set<Integer> petIgnore = chr.getExcludedItems();\n+                if(!petIgnore.isEmpty() && petIgnore.contains(mapitem.getItem().getItemId())) {\n+                    c.announce(MaplePacketCreator.enableActions());\n+                    return;\n                 }\n             }\n         }"}, {"sha": "375ce9ad8a85ea658a7fab83d4e5c9ec94c45a8b", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -203,14 +203,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 \n                 if (ItemConstants.isPlayerShop(itemId)) {\n-                    MaplePlayerShop shop = new MaplePlayerShop(chr, desc);\n+                    MaplePlayerShop shop = new MaplePlayerShop(chr, desc, itemId);\n                     chr.setPlayerShop(shop);\n                     chr.getMap().addMapObject(shop);\n                     shop.sendShop(c);\n                     c.getWorldServer().registerPlayerShop(shop);\n                     //c.announce(MaplePacketCreator.getPlayerShopRemoveVisitor(1));\n                 } else if (ItemConstants.isHiredMerchant(itemId)) {\n-                    MapleHiredMerchant merchant = new MapleHiredMerchant(chr, itemId, desc);\n+                    MapleHiredMerchant merchant = new MapleHiredMerchant(chr, desc, itemId);\n                     chr.setHiredMerchant(merchant);\n                     c.getWorldServer().registerHiredMerchant(merchant);\n                     chr.getClient().getChannelServer().addHiredMerchant(chr.getId(), merchant);\n@@ -304,18 +304,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \n                 if(ServerConstants.USE_ERASE_PERMIT_ON_OPENSHOP) {\n                     try {\n-                        MapleInventoryManipulator.removeById(c, MapleInventoryType.CASH, 5140000, 1, true, false);\n+                        MapleInventoryManipulator.removeById(c, MapleInventoryType.CASH, shop.getItemId(), 1, true, false);\n                     } catch(RuntimeException re) {} // fella does not have a player shop permit...\n                 }\n                 \n-                chr.getMap().broadcastMessage(MaplePacketCreator.addCharBox(chr, 4));\n+                chr.getMap().broadcastMessage(MaplePacketCreator.updatePlayerShopBox(shop));\n                 shop.setOpen(true);\n             } else if (merchant != null && merchant.isOwner(chr)) {\n                 chr.setHasMerchant(true);\n                 merchant.setOpen(true);\n                 chr.getMap().addMapObject(merchant);\n                 chr.setHiredMerchant(null);\n-                chr.getMap().broadcastMessage(MaplePacketCreator.spawnHiredMerchant(merchant));\n+                chr.getMap().broadcastMessage(MaplePacketCreator.spawnHiredMerchantBox(merchant));\n                 slea.readByte();\n             }\n         } else if (mode == Action.READY.getCode()) {"}, {"sha": "b89692ebcc98fcb9389f4408b1b8976b5342af74", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -49,6 +49,9 @@\n import client.MapleDisease;\n import client.MapleFamily;\n import client.SkillFactory;\n+import client.inventory.Equip;\n+import client.inventory.Item;\n+import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.inventory.MaplePet;\n import constants.GameConstants;\n@@ -223,9 +226,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             player.updatePartyMemberHP();\n         }\n         \n-        if (player.getInventory(MapleInventoryType.EQUIPPED).findById(1122017) != null) {\n-            player.equipPendantOfSpirit();\n+        MapleInventory eqpInv = player.getInventory(MapleInventoryType.EQUIPPED);\n+        eqpInv.lockInventory();\n+        try {\n+            player.resetEquippedHpMp();\n+            \n+            for(Item it : eqpInv.list()) {\n+                player.equippedItem((Equip) it);\n+            }\n+        } finally {\n+            eqpInv.unlockInventory();\n         }\n+        \n         c.announce(MaplePacketCreator.updateBuddylist(player.getBuddylist().getBuddies()));\n         \n         CharacterNameAndId pendingBuddyRequest = c.getPlayer().getBuddylist().pollPendingRequest();"}, {"sha": "d11d92438b220bf984e25dd1c20d010e9429cca8", "filename": "src/net/server/channel/handlers/ScrollHandler.java", "status": "modified", "additions": 22, "deletions": 12, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/ScrollHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/ScrollHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ScrollHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -22,6 +22,7 @@\n package net.server.channel.handlers;\n \n import client.MapleClient;\n+import client.MapleCharacter;\n import client.Skill;\n import client.SkillFactory;\n import client.inventory.Equip;\n@@ -35,7 +36,6 @@\n import java.util.List;\n import net.AbstractMaplePacketHandler;\n import client.inventory.manipulator.MapleInventoryManipulator;\n-import constants.ServerConstants;\n import server.MapleItemInformationProvider;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -57,16 +57,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         if ((ws & 2) == 2) {\n             whiteScroll = true;\n         }\n+        \n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        Equip toScroll = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).getItem(dst);\n+        MapleCharacter chr = c.getPlayer();\n+        Equip toScroll = (Equip) chr.getInventory(MapleInventoryType.EQUIPPED).getItem(dst);\n         Skill LegendarySpirit = SkillFactory.getSkill(1003);\n-        if (c.getPlayer().getSkillLevel(LegendarySpirit) > 0 && dst >= 0) {\n+        if (chr.getSkillLevel(LegendarySpirit) > 0 && dst >= 0) {\n             legendarySpirit = true;\n-            toScroll = (Equip) c.getPlayer().getInventory(MapleInventoryType.EQUIP).getItem(dst);\n+            toScroll = (Equip) chr.getInventory(MapleInventoryType.EQUIP).getItem(dst);\n         }\n         byte oldLevel = toScroll.getLevel();\n         byte oldSlots = toScroll.getUpgradeSlots();\n-        MapleInventory useInventory = c.getPlayer().getInventory(MapleInventoryType.USE);\n+        MapleInventory useInventory = chr.getInventory(MapleInventoryType.USE);\n         Item scroll = useInventory.getItem(slot);\n         Item wscroll = null;\n \n@@ -81,7 +83,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         if (whiteScroll) {\n             wscroll = useInventory.findById(2340000);\n-            if (wscroll == null || wscroll.getItemId() != 2340000) {\n+            if (wscroll == null) {\n                 whiteScroll = false;\n             }\n         }\n@@ -96,7 +98,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n-        Equip scrolled = (Equip) ii.scrollEquipWithId(toScroll, scroll.getItemId(), whiteScroll, 0, c.getPlayer().isGM());\n+        Equip scrolled = (Equip) ii.scrollEquipWithId(toScroll, scroll.getItemId(), whiteScroll, 0, chr.isGM());\n         ScrollResult scrollSuccess = Equip.ScrollResult.FAIL; // fail\n         if (scrolled == null) {\n             scrollSuccess = Equip.ScrollResult.CURSE;\n@@ -112,9 +114,17 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             if(!ItemConstants.isWeddingRing(toScroll.getItemId())) {\n                 mods.add(new ModifyInventory(3, toScroll));\n                 if (dst < 0) {\n-                    c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).removeItem(toScroll.getPosition());\n+                    MapleInventory inv = chr.getInventory(MapleInventoryType.EQUIPPED);\n+                    \n+                    inv.lockInventory();\n+                    try {\n+                        chr.unequippedItem(toScroll);\n+                        inv.removeItem(toScroll.getPosition());\n+                    } finally {\n+                        inv.unlockInventory();\n+                    }\n                 } else {\n-                    c.getPlayer().getInventory(MapleInventoryType.EQUIP).removeItem(toScroll.getPosition());\n+                    chr.getInventory(MapleInventoryType.EQUIP).removeItem(toScroll.getPosition());\n                 }\n             } else {\n                 scrolled = toScroll;\n@@ -128,13 +138,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             mods.add(new ModifyInventory(0, scrolled));\n         }\n         c.announce(MaplePacketCreator.modifyInventory(true, mods));\n-        c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.getScrollEffect(c.getPlayer().getId(), scrollSuccess, legendarySpirit));\n+        chr.getMap().broadcastMessage(MaplePacketCreator.getScrollEffect(chr.getId(), scrollSuccess, legendarySpirit));\n         if (dst < 0 && (scrollSuccess == Equip.ScrollResult.SUCCESS || scrollSuccess == Equip.ScrollResult.CURSE)) {\n-            c.getPlayer().equipChanged();\n+            chr.equipChanged();\n         }\n     }\n \n-    public boolean canScroll(int scrollid, int itemid) {\n+    private static boolean canScroll(int scrollid, int itemid) {\n         int sid = scrollid / 100;\n         \n         switch(sid) {"}, {"sha": "4cbf68167c402adbd02991128fa79de5b083a6fd", "filename": "src/net/server/channel/handlers/SpecialMoveHandler.java", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/SpecialMoveHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/SpecialMoveHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SpecialMoveHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -26,16 +26,13 @@\n import net.AbstractMaplePacketHandler;\n import server.MapleStatEffect;\n import server.life.MapleMonster;\n-import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleCharacter;\n-import client.autoban.AutobanFactory;\n import client.MapleClient;\n import client.MapleStat;\n import client.Skill;\n import client.SkillFactory;\n-import constants.GameConstants;\n import constants.ServerConstants;\n import constants.skills.Brawler;\n import constants.skills.Corsair;"}, {"sha": "65fea04f2a54eaf77b07800f9aef93c2a0db5500", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -484,8 +484,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             for (byte i = 0; i < 3; i++) {\n                 MaplePet pet = player.getPet(i);\n                 if (pet != null) {\n-                    if (pet.canConsume(itemId)) {\n-                        pet.gainClosenessFullness(player, 100, 100, 1);\n+                    Pair<Integer, Boolean> p = pet.canConsume(itemId);\n+                    \n+                    if (p.getRight()) {\n+                        pet.gainClosenessFullness(player, p.getLeft(), 100, 1);\n                         remove(c, itemId);\n                         break;\n                     }"}, {"sha": "c4d51e5fbef115db683c357ac6c59e49f13606aa", "filename": "src/net/server/channel/worker/BaseScheduler.java", "status": "modified", "additions": 27, "deletions": 17, "changes": 44, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/BaseScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/BaseScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/BaseScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -30,8 +30,8 @@\n import java.util.concurrent.locks.Lock;\n import server.TimerManager;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n  *\n@@ -89,6 +89,7 @@ private void unlockScheduler() {\n     \n     private void runBaseSchedule() {\n         List<Object> toRemove;\n+        Map<Object, Pair<Runnable, Long>> registeredEntriesCopy;\n         \n         lockScheduler();\n         try {\n@@ -104,26 +105,35 @@ private void runBaseSchedule() {\n                 \n                 return;\n             }\n-            idleProcs = 0;\n-            \n-            long timeNow = System.currentTimeMillis();\n-            toRemove = new LinkedList<>();\n-            for(Entry<Object, Pair<Runnable, Long>> rmd : registeredEntries.entrySet()) {\n-                Pair<Runnable, Long> r = rmd.getValue();\n-                \n-                if(r.getRight() < timeNow) {\n-                    r.getLeft().run();  // runs the cancel action\n-                    toRemove.add(rmd.getKey());\n-                }\n-            }\n             \n-            for(Object mse : toRemove) {\n-                registeredEntries.remove(mse);\n-            }\n+            idleProcs = 0;\n+            registeredEntriesCopy = new HashMap<>(registeredEntries);\n         } finally {\n             unlockScheduler();\n         }\n         \n+        long timeNow = System.currentTimeMillis();\n+        toRemove = new LinkedList<>();\n+        for(Entry<Object, Pair<Runnable, Long>> rmd : registeredEntriesCopy.entrySet()) {\n+            Pair<Runnable, Long> r = rmd.getValue();\n+\n+            if(r.getRight() < timeNow) {\n+                r.getLeft().run();  // runs the cancel action\n+                toRemove.add(rmd.getKey());\n+            }\n+        }\n+        \n+        if(!toRemove.isEmpty()) {\n+            lockScheduler();\n+            try {\n+                for(Object o : toRemove) {\n+                    registeredEntries.remove(o);\n+                }\n+            } finally {\n+                unlockScheduler();\n+            }\n+        }\n+        \n         dispatchRemovedEntries(toRemove, true);\n     }\n     "}, {"sha": "ffba7a2c4f115ec0ccaf40d806581ae3a7dbb3c8", "filename": "src/net/server/channel/worker/FaceExpressionScheduler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/FaceExpressionScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/FaceExpressionScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/FaceExpressionScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -21,7 +21,7 @@\n \n import java.util.Collections;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "0aa3408a10b9a267bea174d29034ca7c4ac3a397", "filename": "src/net/server/channel/worker/MobAnimationScheduler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobAnimationScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobAnimationScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobAnimationScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -19,13 +19,13 @@\n */\n package net.server.channel.worker;\n \n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n  *"}, {"sha": "6f40945f265e1e533873f1816d5b639a441ef82a", "filename": "src/net/server/channel/worker/MobClearSkillScheduler.java", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobClearSkillScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobClearSkillScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobClearSkillScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -0,0 +1,36 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.channel.worker;\n+\n+import net.server.audit.locks.MonitoredLockType;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MobClearSkillScheduler extends BaseScheduler {\n+    public MobClearSkillScheduler() {\n+        super(MonitoredLockType.CHANNEL_MOBSKILL);\n+    }\n+    \n+    public void registerClearSkillAction(Runnable runAction, long delay) {\n+        registerEntry(runAction, runAction, delay);\n+    }\n+}"}, {"sha": "920604d0969fff9a1c68a3d4d6d5a467d69f033c", "filename": "src/net/server/channel/worker/MobMistScheduler.java", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobMistScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobMistScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobMistScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -0,0 +1,36 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.channel.worker;\n+\n+import net.server.audit.locks.MonitoredLockType;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MobMistScheduler extends BaseScheduler {\n+    public MobMistScheduler() {\n+        super(MonitoredLockType.CHANNEL_MOBMIST);\n+    }\n+    \n+    public void registerMistCancelAction(Runnable runAction, long delay) {\n+        registerEntry(runAction, runAction, delay);\n+    }\n+}"}, {"sha": "5f8705cdc3d47ab460ed34a38a9d2c5866d31bc2", "filename": "src/net/server/channel/worker/MobStatusScheduler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobStatusScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/MobStatusScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobStatusScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -26,8 +26,8 @@\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredLockType;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n  *"}, {"sha": "ef404e289e552382785e0b1bf9bbdbe9dab7003f", "filename": "src/net/server/channel/worker/OverallScheduler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/OverallScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/channel/worker/OverallScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/OverallScheduler.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -19,7 +19,7 @@\n */\n package net.server.channel.worker;\n \n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "cdb518f3277cf158f591e22a5a29c2a3d57c5a26", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -36,13 +36,13 @@\n import java.util.Set;\n \n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n import net.server.Server;\n import net.server.channel.Channel;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n public class MapleGuild {\n     "}, {"sha": "93e7741d370eb730f7c5daa8dbfc4324b0f60145", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -30,9 +30,9 @@\n import java.util.Map.Entry;\n import java.util.Map;\n import java.util.Comparator;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n public class MapleParty {\n     private int id;"}, {"sha": "6fa93ed188c8067fb8d2f7e42950eecde43f3e1a", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -48,7 +48,7 @@\n import java.util.TreeMap;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import java.util.Set;\n import java.util.HashSet;\n import java.util.concurrent.ScheduledFuture;\n@@ -75,7 +75,7 @@\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "d1f70dc879a268d5b18f554285d1ff4e824fdb8d", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 70, "deletions": 2, "changes": 72, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -23,6 +23,7 @@\n \n import java.awt.Point;\n import java.util.Arrays;\n+import java.util.ArrayList;\n import java.util.Calendar;\n import java.util.Collections;\n import java.util.LinkedList;\n@@ -36,7 +37,6 @@\n import scripting.event.EventInstanceManager;\n import scripting.event.EventManager;\n import scripting.npc.NPCScriptManager;\n-import client.inventory.manipulator.MapleInventoryManipulator;\n import server.MapleItemInformationProvider;\n import server.expeditions.MapleExpedition;\n import server.expeditions.MapleExpeditionType;\n@@ -58,9 +58,11 @@\n import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryProof;\n import client.inventory.MapleInventoryType;\n import client.inventory.MaplePet;\n import client.inventory.ModifyInventory;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n import constants.GameConstants;\n import constants.ItemConstants;\n import constants.ServerConstants;\n@@ -247,7 +249,73 @@ private boolean canHoldAll(List<Integer> itemids, List<Integer> quantity, boolea\n                 addedItems.add(new Pair<>(it, ItemConstants.getInventoryType(itemids.get(i))));\n             }\n             \n-            return MapleInventory.checkSpots(c.getPlayer(), addedItems);\n+            return MapleInventory.checkSpots(c.getPlayer(), addedItems, false);\n+        }\n+        \n+        public boolean canHold(int itemid, int quantity, int removeItemid, int removeQuantity) {\n+            return canHoldAllAfterRemoving(Collections.singletonList(itemid), Collections.singletonList(quantity), Collections.singletonList(removeItemid), Collections.singletonList(removeQuantity));\n+        }\n+        \n+        private static List<Pair<Item, MapleInventoryType>> prepareProofInventoryItems(List<Pair<Integer, Integer>> items) {\n+            List<Pair<Item, MapleInventoryType>> addedItems = new LinkedList<>();\n+            for(Pair<Integer, Integer> p : items) {\n+                Item it = new Item(p.getLeft(), (short) 0, p.getRight().shortValue());\n+                addedItems.add(new Pair<>(it, MapleInventoryType.CANHOLD));\n+            }\n+            \n+            return addedItems;\n+        }\n+        \n+        private static List<List<Pair<Integer, Integer>>> prepareInventoryItemList(List<Integer> itemids, List<Integer> quantity) {\n+            int size = Math.min(itemids.size(), quantity.size());\n+            \n+            List<List<Pair<Integer, Integer>>> invList = new ArrayList<>(6);\n+            for(int i = MapleInventoryType.UNDEFINED.getType(); i < MapleInventoryType.CASH.getType(); i++) {\n+                invList.add(new LinkedList<Pair<Integer, Integer>>());\n+            }\n+            \n+            for(int i = 0; i < size; i++) {\n+                int itemid = itemids.get(i);\n+                invList.get(ItemConstants.getInventoryType(itemid).getType()).add(new Pair<>(itemid, quantity.get(i)));\n+            }\n+            \n+            return invList;\n+        }\n+        \n+        public boolean canHoldAllAfterRemoving(List<Integer> toAddItemids, List<Integer> toAddQuantity, List<Integer> toRemoveItemids, List<Integer> toRemoveQuantity) {\n+            List<List<Pair<Integer, Integer>>> toAddItemList = prepareInventoryItemList(toAddItemids, toAddQuantity);\n+            List<List<Pair<Integer, Integer>>> toRemoveItemList = prepareInventoryItemList(toRemoveItemids, toRemoveQuantity);\n+            \n+            MapleInventoryProof prfInv = (MapleInventoryProof) this.getInventory(MapleInventoryType.CANHOLD);\n+            prfInv.lockInventory();\n+            try {\n+                for(int i = MapleInventoryType.EQUIP.getType(); i < MapleInventoryType.CASH.getType(); i++) {\n+                    List<Pair<Integer, Integer>> toAdd = toAddItemList.get(i);\n+                    \n+                    if(!toAdd.isEmpty()) {\n+                        List<Pair<Integer, Integer>> toRemove = toRemoveItemList.get(i);\n+                        \n+                        MapleInventory inv = this.getInventory(i);\n+                        prfInv.cloneContents(inv);\n+                        \n+                        for(Pair<Integer, Integer> p : toRemove) {\n+                            MapleInventoryManipulator.removeById(c, MapleInventoryType.CANHOLD, p.getLeft(), p.getRight(), false, false);\n+                        }\n+                        \n+                        List<Pair<Item, MapleInventoryType>> addItems = prepareProofInventoryItems(toAdd);\n+                        \n+                        boolean canHold = MapleInventory.checkSpots(c.getPlayer(), addItems, true);\n+                        if(!canHold) {\n+                            return false;\n+                        }\n+                    }\n+                }\n+            } finally {\n+                prfInv.flushContents();\n+                prfInv.unlockInventory();\n+            }\n+            \n+            return true;\n         }\n      \n         //---- \\/ \\/ \\/ \\/ \\/ \\/ \\/  NOT TESTED  \\/ \\/ \\/ \\/ \\/ \\/ \\/ \\/ \\/ ----"}, {"sha": "ce58960fd758f88dff5255593047cf61d817daf0", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -35,14 +35,13 @@\n import java.util.Iterator;\n import java.util.Properties;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n-\n import javax.script.ScriptException;\n-\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n import provider.MapleDataProviderFactory;\n@@ -70,7 +69,6 @@\n import server.life.MapleLifeFactory;\n import server.life.MapleNPC;\n import tools.MaplePacketCreator;\n-import tools.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "92eef6147d7ac9493bdf7b9585856f37997e3b10", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -54,8 +54,8 @@\n import java.util.LinkedList;\n import java.util.Queue;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredLockType;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n  *"}, {"sha": "42fd4da30aac9c67767b66bb19abfcdeaf566815", "filename": "src/server/CashShop.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -32,7 +32,7 @@\n import java.util.Map;\n import java.util.Map.Entry;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n import provider.MapleData;\n import provider.MapleDataProvider;\n@@ -47,7 +47,7 @@\n import client.inventory.MaplePet;\n import constants.ItemConstants;\n import java.util.Collections;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /*\n  * @author Flav"}, {"sha": "a7d5e255d42e678900b62e8f6bcc9114b28bf14a", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 30, "deletions": 10, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -123,6 +123,7 @@\n     protected Map<Integer, Integer> makerCatalystCache = new HashMap<>();\n     protected Map<Integer, Map<String, Integer>> skillUpgradeCache = new HashMap<>();\n     protected Map<Integer, MapleData> skillUpgradeInfoCache = new HashMap<>();\n+    protected Map<Integer, Pair<Integer, Set<Integer>>> cashPetFoodCache = new HashMap<>();\n \n     private MapleItemInformationProvider() {\n         loadCardIdData();\n@@ -1298,18 +1299,37 @@ public boolean isPickupRestricted(int itemId) {\n         return ret;\n     }\n \n-    public List<Integer> petsCanConsume(int itemId) {\n-        List<Integer> ret = new ArrayList<>();\n-        MapleData data = getItemData(itemId);\n-        int curPetId;\n-        for (int i = 0; i < data.getChildren().size(); i++) {\n-            curPetId = MapleDataTool.getInt(\"spec/\" + Integer.toString(i), data, 0);\n-            if (curPetId == 0) {\n-                break;\n+    public Pair<Integer, Boolean> canPetConsume(Integer petId, Integer itemId) {\n+        Pair<Integer, Set<Integer>> foodData = cashPetFoodCache.get(itemId);\n+        \n+        if(foodData == null) {\n+            Set<Integer> pets = new HashSet<>(4);\n+            int inc = 1;\n+            \n+            MapleData data = getItemData(itemId);\n+            if(data != null) {\n+                MapleData specData = data.getChildByPath(\"spec\");\n+                for(MapleData specItem : specData.getChildren()) {\n+                    String itemName = specItem.getName();\n+                    \n+                    try {\n+                        Integer.parseInt(itemName); // check if it's a petid node\n+                        \n+                        Integer petid = MapleDataTool.getInt(specItem, 0);\n+                        pets.add(petid);\n+                    } catch(NumberFormatException npe) {\n+                        if(itemName.contentEquals(\"inc\")) {\n+                            inc = MapleDataTool.getInt(specItem, 1);\n+                        }\n+                    }\n+                }\n             }\n-            ret.add(Integer.valueOf(curPetId));\n+            \n+            foodData = new Pair<>(inc, pets);\n+            cashPetFoodCache.put(itemId, foodData);\n         }\n-        return ret;\n+        \n+        return new Pair<>(foodData.getLeft(), foodData.getRight().contains(petId));\n     }\n \n     public boolean isQuestItem(int itemId) {"}, {"sha": "f13ac63df2ae362899a467ab1f7e32187957dd49", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 42, "deletions": 22, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -718,27 +718,30 @@ public void applyPassive(MapleCharacter applyto, MapleMapObject obj, int attack)\n     }\n \n     public boolean applyTo(MapleCharacter chr) {\n-        return applyTo(chr, chr, true, null, false);\n+        return applyTo(chr, chr, true, null, false, 1);\n     }\n     \n     public boolean applyTo(MapleCharacter chr, boolean useMaxRange) {\n-        return applyTo(chr, chr, true, null, useMaxRange);\n+        return applyTo(chr, chr, true, null, useMaxRange, 1);\n     }\n \n     public boolean applyTo(MapleCharacter chr, Point pos) {\n-        return applyTo(chr, chr, true, pos, false);\n+        return applyTo(chr, chr, true, pos, false, 1);\n     }\n \n     // primary: the player caster of the buff\n-    private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolean primary, Point pos, boolean useMaxRange) {\n+    private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolean primary, Point pos, boolean useMaxRange, int affectedPlayers) {\n         if (skill && (sourceid == GM.HIDE || sourceid == SuperGM.HIDE)) {\n             applyto.toggleHide(false);\n             return true;\n         }\n         \n-        int hpchange = calcHPChange(applyfrom, primary);\n-        int mpchange = calcMPChange(applyfrom, primary);\n+        if (primary && isHeal()) {\n+            affectedPlayers = applyBuff(applyfrom, useMaxRange);\n+        }\n         \n+        int hpchange = calcHPChange(applyfrom, primary, affectedPlayers);\n+        int mpchange = calcMPChange(applyfrom, primary);\n         if (primary) {\n             if (itemConNo != 0) {\n                 if(!applyto.getClient().getAbstractPlayerInteraction().hasItem(itemCon, itemConNo)) {\n@@ -747,9 +750,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                 }\n                 MapleInventoryManipulator.removeById(applyto.getClient(), ItemConstants.getInventoryType(itemCon), itemCon, itemConNo, false, true);\n             }\n-        }\n-        List<Pair<MapleStat, Integer>> hpmpupdate = new ArrayList<>(2);\n-        if (!primary) {\n+        } else {\n             if(isResurrection()) {\n                 hpchange = applyto.getMaxHp();\n                 applyto.setStance(0);\n@@ -758,6 +759,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                 applyto.getMap().broadcastMessage(applyto, MaplePacketCreator.spawnPlayerMapObject(applyto), false);\n             }\n         }\n+        \n         if (isDispel() && makeChanceResult()) {\n             applyto.dispelDebuffs();\n         } else if (isCureAllAbnormalStatus()) {\n@@ -770,6 +772,8 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         /*if (applyfrom.getMp() < getMpCon()) {\n          AutobanFactory.MPCON.addPoint(applyfrom.getAutobanManager(), \"mpCon hack for skill:\" + sourceid + \"; Player MP: \" + applyto.getMp() + \" MP Needed: \" + getMpCon());\n          } */\n+        \n+        List<Pair<MapleStat, Integer>> hpmpupdate = new ArrayList<>(2);\n         if (hpchange != 0) {\n             if (hpchange < 0 && (-hpchange) >= applyto.getHp() && (!applyto.hasDisease(MapleDisease.ZOMBIFY) || hpCon > 0)) {\n                 if(!applyto.isGM()) {\n@@ -784,8 +788,9 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             applyto.setHp(newHp);\n             hpmpupdate.add(new Pair<>(MapleStat.HP, Integer.valueOf(applyto.getHp())));\n         }\n-        int newMp = applyto.getMp() + mpchange;\n+        \n         if (mpchange != 0) {\n+            int newMp = applyto.getMp() + mpchange;\n             if (mpchange < 0 && -mpchange > applyto.getMp()) {\n                 if(!applyto.isGM()) {\n                     applyto.getClient().announce(MaplePacketCreator.enableActions());\n@@ -860,14 +865,16 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             applyBuffEffect(applyfrom, applyto, primary);\n         }\n \n-        if (primary && (overTime || isHeal())) {\n-            applyBuff(applyfrom, useMaxRange);\n-        }\n+        if (primary) {\n+            if (overTime) {\n+                applyBuff(applyfrom, useMaxRange);\n+            }\n \n-        if (primary && isMonsterBuff()) {\n-            applyMonsterBuff(applyfrom);\n+            if (isMonsterBuff()) {\n+                applyMonsterBuff(applyfrom);\n+            }\n         }\n-\n+        \n         if (this.getFatigue() != 0) {\n             applyto.getMount().setTiredness(applyto.getMount().getTiredness() + this.getFatigue());\n         }\n@@ -927,25 +934,37 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         return true;\n     }\n \n-    private void applyBuff(MapleCharacter applyfrom, boolean useMaxRange) {\n+    private int applyBuff(MapleCharacter applyfrom, boolean useMaxRange) {\n+        int affectedc = 1;\n+        \n         if (isPartyBuff() && (applyfrom.getParty() != null || isGmBuff())) {\n             Rectangle bounds = (!useMaxRange) ? calculateBoundingBox(applyfrom.getPosition(), applyfrom.isFacingLeft()) : new Rectangle(Integer.MIN_VALUE / 2, Integer.MIN_VALUE / 2, Integer.MAX_VALUE, Integer.MAX_VALUE);\n             List<MapleMapObject> affecteds = applyfrom.getMap().getMapObjectsInRect(bounds, Arrays.asList(MapleMapObjectType.PLAYER));\n             List<MapleCharacter> affectedp = new ArrayList<>(affecteds.size());\n             for (MapleMapObject affectedmo : affecteds) {\n                 MapleCharacter affected = (MapleCharacter) affectedmo;\n                 if (affected != applyfrom && (isGmBuff() || applyfrom.getParty().equals(affected.getParty()))) {\n-                    if ((!isResurrection() && affected.isAlive()) || (isResurrection() && !affected.isAlive())) {\n-                        affectedp.add(affected);\n+                    if (!isResurrection()) {\n+                        if (affected.isAlive()) {\n+                            affectedp.add(affected);\n+                        }\n+                    } else {\n+                        if (!affected.isAlive()) {\n+                            affectedp.add(affected);\n+                        }\n                     }\n                 }\n             }\n+            \n+            affectedc += affectedp.size();   // used for heal\n             for (MapleCharacter affected : affectedp) {\n-                applyTo(applyfrom, affected, false, null, useMaxRange);\n+                applyTo(applyfrom, affected, false, null, useMaxRange, affectedc);\n                 affected.getClient().announce(MaplePacketCreator.showOwnBuffEffect(sourceid, 2));\n                 affected.getMap().broadcastMessage(affected, MaplePacketCreator.showBuffeffect(affected.getId(), sourceid, 2), false);\n             }\n         }\n+        \n+        return affectedc;\n     }\n \n     private void applyMonsterBuff(MapleCharacter applyfrom) {\n@@ -1158,7 +1177,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n         }\n     }\n \n-    private int calcHPChange(MapleCharacter applyfrom, boolean primary) {\n+    private int calcHPChange(MapleCharacter applyfrom, boolean primary, int affectedPlayers) {\n         int hpchange = 0;\n         if (hp != 0) {\n             if (!skill) {\n@@ -1171,7 +1190,8 @@ private int calcHPChange(MapleCharacter applyfrom, boolean primary) {\n                     hpchange /= 2;\n                 }\n             } else { // assumption: this is heal\n-                hpchange += makeHealHP(hp / 100.0, applyfrom.getTotalMagic(), 3, 5);\n+                float hpHeal = (applyfrom.getMaxHpEquipped() * (float) hp / (100.0f * affectedPlayers));\n+                hpchange += hpHeal;\n                 if (applyfrom.hasDisease(MapleDisease.ZOMBIFY)) {\n                     hpchange = -hpchange;\n                     hpCon = 0;"}, {"sha": "cd148a6d07ff5ee5dfacf111fc43a75726a6008c", "filename": "src/server/MapleStorage.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/MapleStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStorage.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -39,11 +39,11 @@\n import provider.MapleDataProvider;\n import provider.MapleDataProviderFactory;\n import provider.MapleDataTool;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "462623a6ecf35e8c50a6831fc0fb62c37e5a1e13", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 17, "deletions": 13, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -55,7 +55,7 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.Server;\n import net.server.channel.Channel;\n import net.server.world.World;\n@@ -70,7 +70,7 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n public class MapleMonster extends AbstractLoadedMapleLife {\n     private ChangeableStats ostats = null;  //unused, v83 WZs offers no support for changeable stats.\n@@ -1248,14 +1248,15 @@ public void usedSkill(final int skillId, final int level, long cooltime) {\n         }\n         \n         final MapleMonster mons = this;\n-        TimerManager.getInstance().schedule(\n-            new Runnable() {\n-\n-                @Override\n-                public void run() {\n-                    mons.clearSkill(skillId, level);\n-                }\n-            }, cooltime);\n+        MapleMap mmap = mons.getMap();\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                mons.clearSkill(skillId, level);\n+            }\n+        };\n+        \n+        mmap.getChannelServer().registerMobClearSkillAction(mmap.getId(), r, cooltime);\n     }\n \n     public void clearSkill(int skillId, int level) {\n@@ -1359,8 +1360,9 @@ public void setTempEffectiveness(Element e, ElementalEffectiveness ee, long mill\n             final ElementalEffectiveness fEE = stats.getEffectiveness(e);\n             if (!fEE.equals(ElementalEffectiveness.WEAK)) {\n                 stats.setEffectiveness(e, ee);\n-                TimerManager.getInstance().schedule(new Runnable() {\n-\n+                \n+                MapleMap mmap = this.getMap();\n+                Runnable r = new Runnable() {\n                     @Override\n                     public void run() {\n                         monsterLock.lock();\n@@ -1371,7 +1373,9 @@ public void run() {\n                             monsterLock.unlock();\n                         }\n                     }\n-                }, milli);\n+                };\n+                \n+                mmap.getChannelServer().registerMobClearSkillAction(mmap.getId(), r, milli);\n             }\n         } finally {\n             monsterLock.unlock();"}, {"sha": "384e678e550fc251ac79f2443a80b583a186e19d", "filename": "src/server/life/MobSkill.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MobSkill.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MobSkill.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkill.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -196,7 +196,7 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n                 }\n                 break;\n             case 131: // Mist\n-                monster.getMap().spawnMist(new MapleMist(calculateBoundingBox(monster.getPosition(), true), monster, this), x * 10, false, false, false);\n+                monster.getMap().spawnMist(new MapleMist(calculateBoundingBox(monster.getPosition(), true), monster, this), x * 100, false, false, false);\n                 break;\n             case 132:\n                 disease = MapleDisease.CONFUSE;"}, {"sha": "d6f9a416e685985581028b06388ec16499298fac", "filename": "src/server/life/MobSkillFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MobSkillFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/life/MobSkillFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkillFactory.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -27,15 +27,15 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import provider.MapleData;\n import provider.MapleDataProvider;\n import provider.MapleDataProviderFactory;\n import provider.MapleDataTool;\n-import tools.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "957d8c0ac0ba55b988db039a888e631c6a17aff6", "filename": "src/server/maps/MapleGenericPortal.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleGenericPortal.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleGenericPortal.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleGenericPortal.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -27,8 +27,8 @@\n import server.MaplePortal;\n import tools.MaplePacketCreator;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredLockType;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n public class MapleGenericPortal implements MaplePortal {\n "}, {"sha": "8f9a366fdaed7885fe70fee232885029e13ac7cf", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 32, "deletions": 10, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -40,13 +40,13 @@\n import java.util.List;\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.Server;\n import server.MapleItemInformationProvider;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *\n@@ -67,7 +67,7 @@\n     private MapleMap map;\n     private Lock visitorLock = new MonitoredReentrantLock(MonitoredLockType.VISITOR_MERCH, true);\n \n-    public MapleHiredMerchant(final MapleCharacter owner, int itemId, String desc) {\n+    public MapleHiredMerchant(final MapleCharacter owner, String desc, int itemId) {\n         this.setPosition(owner.getPosition());\n         this.start = System.currentTimeMillis();\n         this.ownerId = owner.getId();\n@@ -96,13 +96,30 @@ private void broadcastToVisitors(final byte[] packet) {\n         }\n     }\n \n+    public byte[] getShopRoomInfo() {\n+        visitorLock.lock();\n+        try {\n+            byte count = 0;\n+            for (MapleCharacter visitor : visitors) {\n+                if (visitor != null) {\n+                    count++;\n+                }\n+            }\n+            \n+            return new byte[]{count, (byte) (visitors.length + 1)};\n+        } finally {\n+            visitorLock.unlock();\n+        }\n+    }\n+    \n     public boolean addVisitor(MapleCharacter visitor) {\n         visitorLock.lock();\n         try {\n             int i = this.getFreeSlot();\n             if (i > -1) {\n                 visitors[i] = visitor;\n                 broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorAdd(visitor, i + 1));\n+                this.getMap().broadcastMessage(MaplePacketCreator.updateHiredMerchantBox(this));\n                 \n                 return true;\n             }\n@@ -123,6 +140,7 @@ public void removeVisitor(MapleCharacter visitor) {\n             if (visitors[slot] != null && visitors[slot].getId() == visitor.getId()) {\n                 visitors[slot] = null;\n                 broadcastToVisitors(MaplePacketCreator.hiredMerchantVisitorLeave(slot + 1));\n+                this.getMap().broadcastMessage(MaplePacketCreator.updateHiredMerchantBox(this));\n             }\n         } finally {\n             visitorLock.unlock();\n@@ -151,15 +169,19 @@ private void removeAllVisitors() {\n         visitorLock.lock();\n         try {\n             for (int i = 0; i < 3; i++) {\n-                if (visitors[i] != null) {\n-                    visitors[i].setHiredMerchant(null);\n+                MapleCharacter visitor = visitors[i];\n+                \n+                if (visitor != null) {\n+                    visitor.setHiredMerchant(null);\n                     \n-                    visitors[i].getClient().announce(MaplePacketCreator.leaveHiredMerchant(i + 1, 0x11));\n-                    visitors[i].getClient().announce(MaplePacketCreator.hiredMerchantMaintenanceMessage());\n+                    visitor.getClient().announce(MaplePacketCreator.leaveHiredMerchant(i + 1, 0x11));\n+                    visitor.getClient().announce(MaplePacketCreator.hiredMerchantMaintenanceMessage());\n                     \n                     visitors[i] = null;\n                 }\n             }\n+            \n+            this.getMap().broadcastMessage(MaplePacketCreator.updateHiredMerchantBox(this));\n         } finally {\n             visitorLock.unlock();\n         }\n@@ -272,7 +294,7 @@ private void announceItemSold(Item item, int mesos) {\n \n     public void forceClose() {\n         //Server.getInstance().getChannel(world, channel).removeHiredMerchant(ownerId);\n-        map.broadcastMessage(MaplePacketCreator.destroyHiredMerchant(getOwnerId()));\n+        map.broadcastMessage(MaplePacketCreator.removeHiredMerchantBox(getOwnerId()));\n         map.removeMapObject(this);\n         \n         MapleCharacter owner = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterById(ownerId);\n@@ -331,7 +353,7 @@ public void closeOwnerMerchant(MapleCharacter chr) {\n     \n     public void closeShop(MapleClient c, boolean timeout) {\n         map.removeMapObject(this);\n-        map.broadcastMessage(MaplePacketCreator.destroyHiredMerchant(ownerId));\n+        map.broadcastMessage(MaplePacketCreator.removeHiredMerchantBox(ownerId));\n         c.getChannelServer().removeHiredMerchant(ownerId);\n \n         try {\n@@ -634,7 +656,7 @@ public MapleMapObjectType getType() {\n \n     @Override\n     public void sendSpawnData(MapleClient client) {\n-        client.announce(MaplePacketCreator.spawnHiredMerchant(this));\n+        client.announce(MaplePacketCreator.spawnHiredMerchantBox(this));\n     }\n \n     public class SoldItem {"}, {"sha": "ddfd51276f0b044746b47345d429e46661cf3541", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 18, "deletions": 17, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -52,9 +52,10 @@\n import java.util.Random;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.atomic.AtomicInteger;\n-import tools.locks.MonitoredReentrantLock;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.Lock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n@@ -90,7 +91,6 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;\n-import tools.locks.MonitoredLockType;\n \n public class MapleMap {\n     private static final List<MapleMapObjectType> rangedMapobjectTypes = Arrays.asList(MapleMapObjectType.SHOP, MapleMapObjectType.ITEM, MapleMapObjectType.NPC, MapleMapObjectType.MONSTER, MapleMapObjectType.DOOR, MapleMapObjectType.SUMMON, MapleMapObjectType.REACTOR);\n@@ -1512,8 +1512,10 @@ public void updateMonsterController(MapleMonster monster) {\n             chrRLock.lock();\n             try {\n                 for (MapleCharacter chr : characters) {\n-                    if (!chr.isHidden() && (chr.getControlledMonsters().size() < mincontrolled || mincontrolled == -1)) {\n-                        mincontrolled = chr.getControlledMonsters().size();\n+                    int ctrlMonsSize = chr.getControlledMonsters().size();\n+                    \n+                    if (!chr.isHidden() && (ctrlMonsSize < mincontrolled || mincontrolled == -1)) {\n+                        mincontrolled = ctrlMonsSize;\n                         newController = chr;\n                     }\n                 }\n@@ -1538,8 +1540,7 @@ public void updateMonsterController(MapleMonster monster) {\n         objectRLock.lock();\n         try {\n             return new LinkedList(mapobjects.values());\n-        }\n-        finally {\n+        } finally {\n             objectRLock.unlock();\n         }\n     }\n@@ -1997,8 +1998,9 @@ public void run() {\n             poisonSchedule = tMan.register(poisonTask, 2000, 2500);\n         } else {\n             poisonSchedule = null;\n-        }      \n-        tMan.schedule(new Runnable() {\n+        }\n+        \n+        Runnable mistSchedule = new Runnable() {\n             @Override\n             public void run() {\n                 removeMapObject(mist);\n@@ -2007,7 +2009,9 @@ public void run() {\n                 }\n                 broadcastMessage(mist.makeDestroyData());\n             }\n-        }, duration);\n+        };\n+        \n+        this.getChannelServer().registerMobMistCancelAction(mapid, mistSchedule, duration);\n     }\n     \n     public void spawnKite(final MapleKite kite) {\n@@ -2899,8 +2903,7 @@ public void reportMonsterSpawnPoints(MapleCharacter chr) {\n             }\n             \n             return mapChars;\n-        }\n-        finally {\n+        } finally {\n             chrRLock.unlock();\n         }\n     }\n@@ -2909,8 +2912,7 @@ public void reportMonsterSpawnPoints(MapleCharacter chr) {\n         chrRLock.lock();\n         try {\n             return Collections.unmodifiableCollection(this.characters);\n-        }\n-        finally {\n+        } finally {\n             chrRLock.unlock();\n         }\n     }\n@@ -2929,7 +2931,7 @@ public MapleCharacter getCharacterById(int id) {\n         return null;\n     }\n \n-    private void updateMapObjectVisibility(MapleCharacter chr, MapleMapObject mo) {\n+    private static void updateMapObjectVisibility(MapleCharacter chr, MapleMapObject mo) {\n         if (!chr.isMapObjectVisible(mo)) { // item entered view range\n             if (mo.getType() == MapleMapObjectType.SUMMON || mo.getPosition().distanceSq(chr.getPosition()) <= getRangedDistance()) {\n                 chr.addVisibleMapObject(mo);\n@@ -3291,8 +3293,7 @@ public void respawn() {\n             if(characters.isEmpty()) {\n                 return;\n             }\n-        }\n-        finally {\n+        } finally {\n             chrRLock.unlock();\n         }\n         "}, {"sha": "0ea7a9bbf743bb13b98c43dbc9a0d9c6bd9aa16e", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -33,10 +33,11 @@\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n-import tools.locks.MonitoredReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import provider.MapleData;\n import provider.MapleDataProvider;\n import provider.MapleDataTool;\n@@ -49,7 +50,7 @@\n import scripting.event.EventInstanceManager;\n import tools.DatabaseConnection;\n import tools.StringUtil;\n-import tools.locks.MonitoredLockType;\n+\n \n public class MapleMapFactory {\n "}, {"sha": "77a7da89bbd58954ece372898335876f65a2388e", "filename": "src/server/maps/MapleMapItem.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMapItem.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMapItem.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapItem.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -25,9 +25,9 @@\n import client.inventory.Item;\n import java.awt.Point;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import tools.MaplePacketCreator;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n public class MapleMapItem extends AbstractMapleMapObject {\n     protected MapleClient ownerClient;"}, {"sha": "487bf5a25aa0d347664f2004de7d7b982f59175b", "filename": "src/server/maps/MapleMiniDungeon.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMiniDungeon.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleMiniDungeon.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMiniDungeon.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -26,9 +26,9 @@\n import java.util.ArrayList;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import tools.MaplePacketCreator;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "12ffd58a662e7c48b153b6db4b0fec9a07b5c6de", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 35, "deletions": 10, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -37,13 +37,12 @@\n import java.util.Map;\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n import net.opcodes.SendOpcode;\n-import server.MapleItemInformationProvider;\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.data.output.MaplePacketLittleEndianWriter;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *\n@@ -53,6 +52,8 @@\n public class MaplePlayerShop extends AbstractMapleMapObject {\n     private AtomicBoolean open = new AtomicBoolean(false);\n     private MapleCharacter owner;\n+    private int itemid;\n+    \n     private MapleCharacter[] visitors = new MapleCharacter[3];\n     private List<MaplePlayerShopItem> items = new ArrayList<>();\n     private List<SoldItem> sold = new LinkedList<>();\n@@ -63,10 +64,11 @@\n     private Map<Integer, Byte> chatSlot = new LinkedHashMap<>();\n     private Lock visitorLock = new MonitoredReentrantLock(MonitoredLockType.VISITOR_PSHOP, true);\n \n-    public MaplePlayerShop(MapleCharacter owner, String description) {\n+    public MaplePlayerShop(MapleCharacter owner, String description, int itemid) {\n         this.setPosition(owner.getPosition());\n         this.owner = owner;\n         this.description = description;\n+        this.itemid = itemid;\n     }\n \n     public int getChannel() {\n@@ -77,6 +79,10 @@ public int getMapId() {\n         return owner.getMapId();\n     }\n     \n+    public int getItemId() {\n+        return itemid;\n+    }\n+    \n     public boolean isOpen() {\n         return open.get();\n     }\n@@ -93,6 +99,22 @@ public boolean hasFreeSlot() {\n             visitorLock.unlock();\n         }\n     }\n+    \n+    public byte[] getShopRoomInfo() {\n+        visitorLock.lock();\n+        try {\n+            byte count = 0;\n+            for (MapleCharacter visitor : visitors) {\n+                if (visitor != null) {\n+                    count++;\n+                }\n+            }\n+            \n+            return new byte[]{count, (byte) visitors.length};\n+        } finally {\n+            visitorLock.unlock();\n+        }\n+    }\n \n     public boolean isOwner(MapleCharacter c) {\n         return owner.equals(c);\n@@ -103,9 +125,9 @@ private void addVisitor(MapleCharacter visitor) {\n             if (visitors[i] == null) {\n                 visitors[i] = visitor;\n                 visitor.setSlot(i);\n+                \n                 this.broadcast(MaplePacketCreator.getPlayerShopNewVisitor(visitor, i + 1));\n-\n-                if(i == 2) visitor.getMap().broadcastMessage(MaplePacketCreator.addCharBox(owner, 1));\n+                owner.getMap().broadcastMessage(MaplePacketCreator.updatePlayerShopBox(this));\n                 break;\n             }\n         }\n@@ -123,7 +145,9 @@ public void forceRemoveVisitor(MapleCharacter visitor) {\n                 if (visitors[i] != null && visitors[i].getId() == visitor.getId()) {\n                     visitors[i] = null;\n                     visitor.setSlot(-1);\n+                    \n                     this.broadcast(MaplePacketCreator.getPlayerShopRemoveVisitor(i + 1));\n+                    owner.getMap().broadcastMessage(MaplePacketCreator.updatePlayerShopBox(this));\n                     return;\n                 }\n             }\n@@ -154,14 +178,15 @@ public void removeVisitor(MapleCharacter visitor) {\n                         }\n                         \n                         this.broadcastRestoreToVisitors();\n+                        owner.getMap().broadcastMessage(MaplePacketCreator.updatePlayerShopBox(this));\n                         return;\n                     }\n                 }\n             } finally {\n                 visitorLock.unlock();\n             }\n             \n-            if(owner.getPlayerShop() != null) visitor.getMap().broadcastMessage(MaplePacketCreator.addCharBox(owner, 4));\n+            owner.getMap().broadcastMessage(MaplePacketCreator.updatePlayerShopBox(this));\n         }\n     }\n \n@@ -394,7 +419,7 @@ private void clearChatLog() {\n     }\n     \n     public void closeShop() {\n-        owner.getMap().broadcastMessage(MaplePacketCreator.removeCharBox(owner));\n+        owner.getMap().broadcastMessage(MaplePacketCreator.removePlayerShopBox(this));\n         clearChatLog();\n         removeVisitors();\n     }\n@@ -527,12 +552,12 @@ public synchronized boolean visitShop(MapleCharacter chr) {\n \n     @Override\n     public void sendDestroyData(MapleClient client) {\n-        client.announce(MaplePacketCreator.removeCharBox(owner));\n+        client.announce(MaplePacketCreator.removePlayerShopBox(this));\n     }\n \n     @Override\n     public void sendSpawnData(MapleClient client) {\n-        client.announce(MaplePacketCreator.addCharBox(owner, 4));\n+        client.announce(MaplePacketCreator.updatePlayerShopBox(this));\n     }\n \n     @Override"}, {"sha": "f0d1aceff40a9088a245efdf80f143ec09ecf543", "filename": "src/server/maps/MapleReactor.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleReactor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/maps/MapleReactor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleReactor.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -29,13 +29,13 @@\n \n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.Lock;\n-import tools.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.MonitoredReentrantLock;\n \n import scripting.reactor.ReactorScriptManager;\n import server.TimerManager;\n import tools.MaplePacketCreator;\n import tools.Pair;\n-import tools.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredLockType;\n \n /**\n  *"}, {"sha": "07251f9b1bd937c988c6faee9b92a95c875d935c", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 25, "deletions": 22, "changes": 47, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -54,7 +54,7 @@\n     \n     private static final Set<Short> exploitableQuests = new HashSet<>();\n     static {\n-        exploitableQuests.add((short) 2338);\n+        exploitableQuests.add((short) 2338);    // there are a lot more exploitable quests, they need to be nit-picked\n         exploitableQuests.add((short) 3637);\n         exploitableQuests.add((short) 3714);\n         exploitableQuests.add((short) 21752);\n@@ -106,25 +106,22 @@ private MapleQuest(int id) {\n                 MapleQuestRequirementType type = MapleQuestRequirementType.getByWZName(startReq.getName());\n                 if (type.equals(MapleQuestRequirementType.INTERVAL)) {\n                     repeatable = true;\n-                }\n-\t\t\t\t\n-                if (type.equals(MapleQuestRequirementType.INFO_NUMBER)) {\n+                } else if (type.equals(MapleQuestRequirementType.INFO_NUMBER)) {\n                     infoNumber = (short) MapleDataTool.getInt(startReq, 0);\n-                }\n-\t\t\t\t\n-                MapleQuestRequirement req = this.getRequirement(type, startReq);\n-\t\t\t\t\n-                if(req == null)\n-                        continue;\n-\t\t\t\t\n-                if (type.equals(MapleQuestRequirementType.MOB)) {\n+                } else if (type.equals(MapleQuestRequirementType.MOB)) {\n                     for (MapleData mob : startReq.getChildren()) {\n                         relevantMobs.add(MapleDataTool.getInt(mob.getChildByPath(\"id\")));\n                     }\n                 }\n+\t\t\n+                MapleQuestRequirement req = this.getRequirement(type, startReq);\n+                if(req == null)\n+                        continue;\n+\t\t\n                 startReqs.put(type, req);\n             }\n         }\n+        \n         MapleData completeReqData = reqData.getChildByPath(\"1\");\n         if (completeReqData != null) {\n             for (MapleData completeReq : completeReqData.getChildren()) {\n@@ -136,8 +133,7 @@ private MapleQuest(int id) {\n \t\t\t\t\n                 if (type.equals(MapleQuestRequirementType.INFO_NUMBER)) {\n                     infoNumber = (short) MapleDataTool.getInt(completeReq, 0);\n-                }\n-                if (type.equals(MapleQuestRequirementType.MOB)) {\n+                } else if (type.equals(MapleQuestRequirementType.MOB)) {\n                     for (MapleData mob : completeReq.getChildren()) {\n                         relevantMobs.add(MapleDataTool.getInt(mob.getChildByPath(\"id\")));\n                     }\n@@ -175,13 +171,13 @@ private MapleQuest(int id) {\n         }\n     }\n \t\n-\tpublic boolean isAutoComplete() {\n-            return autoPreComplete || autoComplete;\n-\t}\n-\t\n-\tpublic boolean isAutoStart() {\n-            return autoStart;\n-\t}\n+    public boolean isAutoComplete() {\n+        return autoPreComplete || autoComplete;\n+    }\n+\n+    public boolean isAutoStart() {\n+        return autoStart;\n+    }\n \n     public static MapleQuest getInstance(int id) {\n         MapleQuest ret = quests.get(id);\n@@ -226,7 +222,14 @@ private String getIntervalTimeLeft(MapleCharacter c, IntervalRequirement r) {\n         \n         return str.toString();\n     }\n-\n+    \n+    public boolean isSameDayRepeatable() {\n+        if(!repeatable) return false;\n+        \n+        IntervalRequirement ir = (IntervalRequirement) startReqs.get(MapleQuestRequirementType.INTERVAL);\n+        return ir.getInterval() < ServerConstants.FAME_GAIN_MIN_HOUR_INTERVAL * 60 * 60 * 1000;\n+    }\n+    \n     public boolean canStartWithoutRequirements(MapleCharacter c) {\n         MapleQuestStatus mqs = c.getQuest(this);\n         return !(mqs.getStatus() != Status.NOT_STARTED && !(mqs.getStatus() == Status.COMPLETED && repeatable));"}, {"sha": "b5b949d09fa206c63258ef5894a5ac562900cbfc", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -212,7 +212,7 @@ public boolean check(MapleCharacter chr, Integer extSelection) {\n                         for(Pair<Item, MapleInventoryType> it: randomList) {\n                                 int idx = it.getRight().getType() - 1;\n                             \n-                                result = MapleInventoryManipulator.checkSpaceProgressively(c, it.getLeft().getItemId(), it.getLeft().getQuantity(), \"\", rndUsed.get(idx));\n+                                result = MapleInventoryManipulator.checkSpaceProgressively(c, it.getLeft().getItemId(), it.getLeft().getQuantity(), \"\", rndUsed.get(idx), false);\n                                 if(result % 2 == 0) {\n                                     chr.dropMessage(1, \"Please check if you have enough space in your inventory.\");\n                                     return false;\n@@ -227,7 +227,7 @@ public boolean check(MapleCharacter chr, Integer extSelection) {\n                         gainList.add(selected);\n                 }\n                 \n-\t\tif (!MapleInventory.checkSpots(chr, gainList, allSlotUsed)) {\n+\t\tif (!MapleInventory.checkSpots(chr, gainList, allSlotUsed, false)) {\n \t\t\tchr.dropMessage(1, \"Please check if you have enough space in your inventory.\");\n \t\t\treturn false;\n \t\t}"}, {"sha": "2fd54726948f86f6baf914b847a0cc6ece41bfaa", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 58, "deletions": 33, "changes": 91, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -2182,6 +2182,55 @@ private static void spawnAnnounceBox(final MaplePacketLittleEndianWriter mplew,\n                 mplew.write(joinable);\n         }\n         \n+        private static void updateHiredMerchantBoxInfo(MaplePacketLittleEndianWriter mplew, MapleHiredMerchant hm) {\n+                byte[] roomInfo = hm.getShopRoomInfo();\n+                \n+                mplew.write(5);\n+                mplew.writeInt(hm.getObjectId());\n+                mplew.writeMapleAsciiString(hm.getDescription());\n+                mplew.write(hm.getItemId() % 100);\n+                mplew.write(roomInfo);\n+        }\n+        \n+        public static byte[] updateHiredMerchantBox(MapleHiredMerchant hm) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.UPDATE_HIRED_MERCHANT.getValue());\n+                mplew.writeInt(hm.getOwnerId());\n+\n+                updateHiredMerchantBoxInfo(mplew, hm);\n+                return mplew.getPacket();\n+        }\n+        \n+        private static void updatePlayerShopBoxInfo(final MaplePacketLittleEndianWriter mplew, MaplePlayerShop shop) {\n+                byte[] roomInfo = shop.getShopRoomInfo();    \n+            \n+                mplew.write(4);\n+                mplew.writeInt(shop.getObjectId());\n+                mplew.writeMapleAsciiString(shop.getDescription());\n+                mplew.write(0);                 // pw\n+                mplew.write(shop.getItemId() % 100);\n+                mplew.write(roomInfo[0]);       // curPlayers\n+                mplew.write(roomInfo[1]);       // maxPlayers\n+                mplew.write(0);\n+        }\n+        \n+        public static byte[] updatePlayerShopBox(MaplePlayerShop shop) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n+                mplew.writeInt(shop.getOwner().getId());\n+                \n+                updatePlayerShopBoxInfo(mplew, shop);\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] removePlayerShopBox(MaplePlayerShop shop) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(7);\n+                mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n+                mplew.writeInt(shop.getOwner().getId());\n+                mplew.write(0);\n+                return mplew.getPacket();\n+        }\n+        \n         public static byte[] facialExpression(MapleCharacter from, int expression) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(10);\n                 mplew.writeShort(SendOpcode.FACIAL_EXPRESSION.getValue());\n@@ -3241,23 +3290,7 @@ private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew\n                 mplew.write(2);\n                 return mplew.getPacket();\n         }\n-\n-        public static byte[] addCharBox(MapleCharacter c, int type) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n-                mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n-                mplew.writeInt(c.getId());\n-                addAnnounceBox(mplew, c.getPlayerShop(), type);\n-                return mplew.getPacket();\n-        }\n-\n-        public static byte[] removeCharBox(MapleCharacter c) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(7);\n-                mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n-                mplew.writeInt(c.getId());\n-                mplew.write(0);\n-                return mplew.getPacket();\n-        }\n-\n+        \n         /**\n          * Possible values for <code>speaker</code>:<br> 0: Npc talking (left)<br>\n          * 1: Npc talking (right)<br> 2: Player talking (left)<br> 3: Player talking\n@@ -5291,27 +5324,19 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 addAnnounceBox(mplew, c.getMiniGame(), 0, ammount, type);\n                 return mplew.getPacket();\n         }\n-\n-        public static byte[] removeOmokBox(MapleCharacter c) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(7);\n-                mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n-                mplew.writeInt(c.getId());\n-                mplew.write(0);\n-                return mplew.getPacket();\n-        }\n-\n+        \n         public static byte[] addMatchCardBox(MapleCharacter c, int ammount, int type) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n                 mplew.writeInt(c.getId());\n                 addAnnounceBox(mplew, c.getMiniGame(), 0, ammount, type);\n                 return mplew.getPacket();\n         }\n-\n-        public static byte[] removeMatchCardBox(MapleCharacter c) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+        \n+        public static byte[] removeMinigameBox(MapleCharacter chr) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(7);\n                 mplew.writeShort(SendOpcode.UPDATE_CHAR_BOX.getValue());\n-                mplew.writeInt(c.getId());\n+                mplew.writeInt(chr.getId());\n                 mplew.write(0);\n                 return mplew.getPacket();\n         }\n@@ -5576,7 +5601,7 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] spawnHiredMerchant(MapleHiredMerchant hm) {\n+        public static byte[] spawnHiredMerchantBox(MapleHiredMerchant hm) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.SPAWN_HIRED_MERCHANT.getValue());\n                 mplew.writeInt(hm.getOwnerId());\n@@ -5588,12 +5613,12 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 mplew.write(0x05);\n                 mplew.writeInt(hm.getObjectId());\n                 mplew.writeMapleAsciiString(hm.getDescription());\n-                mplew.write(hm.getItemId() % 10);\n+                mplew.write(hm.getItemId() % 100);\n                 mplew.write(new byte[]{1, 4});\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] destroyHiredMerchant(int id) {\n+        public static byte[] removeHiredMerchantBox(int id) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.DESTROY_HIRED_MERCHANT.getValue());\n                 mplew.writeInt(id);"}, {"sha": "be0554cadc0d10bad53178d891e01a625668583d", "filename": "tools/MapleIdRetriever/dist/MapleIdRetriever.jar", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/dist/MapleIdRetriever.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/dist/MapleIdRetriever.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleIdRetriever/dist/MapleIdRetriever.jar?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd"}, {"sha": "6807a2ba1902a255b464065dd83188d73fbe6d01", "filename": "tools/MapleIdRetriever/nbproject/private/private.xml", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleIdRetriever/nbproject/private/private.xml?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -2,8 +2,6 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/tools/MapleIdRetriever/src/mapleidretriever/MapleIdRetriever.java</file>\n-        </group>\n+        <group/>\n     </open-files>\n </project-private>"}, {"sha": "b5ac91d48aa7fe9704f35886711fb2588b6c4558", "filename": "tools/MapleIdRetriever/src/mapleidretriever/MapleIdRetriever.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/src/mapleidretriever/MapleIdRetriever.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bee8b5259b683037cfcd159a9f297bbf90e6d2fd/tools/MapleIdRetriever/src/mapleidretriever/MapleIdRetriever.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleIdRetriever/src/mapleidretriever/MapleIdRetriever.java?ref=bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "patch": "@@ -46,7 +46,7 @@\n  * \n  */\n public class MapleIdRetriever {\n-    private final static boolean INSTALL_SQLTABLE = false;\n+    private final static boolean INSTALL_SQLTABLE = true;\n     \n     static String host = \"jdbc:mysql://localhost:3306/heavenms\";\n     static String driver = \"com.mysql.jdbc.Driver\";"}]}]},
