{"fetchDate": "2019-12-19", "content": [{"sha": "7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6N2QwNTc1YWVlNDBhNTcxYzFjOTY0MWJhMGIxNjY0NGExZjNhMWY4Ng==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-20T00:20:46Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-20T00:20:46Z"}, "message": "Maplers' Well-known Battlegrounds\n\nFulfilled merge of Drago's AriantPQ PR #438 into the source!\nAdjusted MCPQ map limits predicted within battlefield's map info node.\nAdded max number-of-players option when creating a AriantPQ lobby.\nAdded party creation check when trying to create one inside the AriantPQ rooms.\nAdjusted several AriantPQ mechanics, in order to either improve the existent features or make those that was still unavailable work seamlessly (score update, ariant batlle points).", "tree": {"sha": "8e9759ed2e91245f239fdf171d98116a2c0471bd", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/8e9759ed2e91245f239fdf171d98116a2c0471bd"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b80389971c486b286d7286b70b98b1112c75834", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0b80389971c486b286d7286b70b98b1112c75834", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0b80389971c486b286d7286b70b98b1112c75834"}, {"sha": "0d7e8daf8e62f0173a6260a6f028591d756c082e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0d7e8daf8e62f0173a6260a6f028591d756c082e", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0d7e8daf8e62f0173a6260a6f028591d756c082e"}], "stats": {"total": 2067, "additions": 1585, "deletions": 482}, "files": [{"sha": "c99613399853926b0fe03bf36d057d7f0ea4d641", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1794,4 +1794,17 @@ Ajustado moderadamente drop rate de v\u00e1rios equipamentos na DB.\n 06 Abril 2019,\n Corrigido loot de party n\u00e3o funcionando adequadamente ap\u00f3s updates recentes.\n Implementado loot de party agora atualizando tamb\u00e9m loots de jogadores ao entrar numa party (pronta permiss\u00e3o de coleta de loots de outros membros da party).\n-Corrigido cooldown de skills de mob n\u00e3o atuando adequadamente.\n\\ No newline at end of file\n+Corrigido cooldown de skills de mob n\u00e3o atuando adequadamente.\n+\n+15 Abril 2019,\n+Iniciado opera\u00e7\u00e3o de introdu\u00e7\u00e3o da AriantPQ no fonte, a partir do pull request feito pelo Dragohe4rt.\n+Ajustado Dimensional Door, agora permitindo jogadores a entrar no sagu\u00e3o de entrada da AriantPQ.\n+Refatorado diversos m\u00f3dulos referentes \u00e0 AriantPQ para uma nova classe, semelhante ao modelo usado pela MCPQ.\n+\n+19 Abril 2019,\n+Ajustado limites de spawn de objetos em inst\u00e2ncias de MCPQ, agora utilizando dados previstos pelo WZ.\n+Adicionado mec\u00e2nica de n\u00famero de jogadores requerido pelo l\u00edder de um lobby na AriantPQ.\n+Corrigido jogadores podendo criar/entrar em party dentro de inst\u00e2ncias da AriantPQ.\n+Ajustado inst\u00e2ncia da AriantPQ para perdurar ap\u00f3s o fim das batalhas (acesso a King's room ainda faz parte da inst\u00e2ncia, para adquirir os valores dos resultados do evento).\n+Ajustado drops de mobs, agora sendo buscado na DB.\n+Ajustado diversas mec\u00e2nicas da AriantPQ, tais como update visual da pontua\u00e7\u00e3o de jogadores (ao dropar itens, ganhar itens, acessar mapa de evento), pontos de batalha persistindo na DB, etc.\n\\ No newline at end of file"}, {"sha": "57d9b2d6ec77c96d90fd9ffc43bb77a50bcc1679", "filename": "launch_server_linux.sh", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/launch_server_linux.sh", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/launch_server_linux.sh", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/launch_server_linux.sh?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -0,0 +1,3 @@\n+#!/bin/sh\n+export CLASSPATH=\".:dist/*\" \n+java -Xmx2048m -Dwzpath=wz/ net.server.Server\n\\ No newline at end of file"}, {"sha": "a075c820e3d468408f5f2a67d9e4353b6f27d62a", "filename": "scripts/event/AirPlane.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/event/AirPlane.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/event/AirPlane.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/AirPlane.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -15,7 +15,7 @@ var  rideTime = 1 * 60 * 1000; //The time that require move to destination\n function init() {\n     closeTime = em.getTransportationTime(closeTime);\n     beginTime = em.getTransportationTime(beginTime);\n-     rideTime = em.getTransportationTime(rideTime);\n+    rideTime = em.getTransportationTime(rideTime);\n     \n     KC_bfd = em.getChannelServer().getMapFactory().getMap(540010100);\n     CBD_bfd = em.getChannelServer().getMapFactory().getMap(540010001);"}, {"sha": "0ce5d454586411dfd56ed3ebee3a6cc418185dc6", "filename": "scripts/npc/1061014.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/1061014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/1061014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061014.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -99,8 +99,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "db793791d9a3500c113fd7db2f8ab4804b2612b5", "filename": "scripts/npc/2030013.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2030013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2030013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030013.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -106,8 +106,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "c8bb6c0190ca5f7766de6bad4a83359aa3719c58", "filename": "scripts/npc/2083004.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2083004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2083004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2083004.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -98,8 +98,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "54a97819b4144cfd00fceec5a8c6b4b01bf6d858", "filename": "scripts/npc/2101014.js", "status": "modified", "additions": 160, "deletions": 90, "changes": 250, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101014.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1,108 +1,178 @@\n-/*\n-    This file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-    Matthias Butz <matze@odinms.de>\n-    Jan Christian Meyer <vimes@odinms.de>\n+/*2101014.js - Lobby and Entrance\n+ * @author Jvlaple\n+ * For Jvlaple's AriantPQ\n+ */\n \n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n+importPackage(Packages.server.expeditions);\n \n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  \n-    See the GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-\n-/*\n-\tNPC NAME: Cesar (2)\n-\tNPC ID: 2101014\n-\tAuthor: Vcoc\n-\tFunction: AriantPQ\n-*/\n-\n-status = -1;\n-var sel;\n-empty = [false, false, false];\n+var status = 0;\n+var toBan = -1;\n+var choice;\n+var arenaType;\n+var arena;\n+var arenaName;\n+var type;\n+var map;\n+var exped = MapleExpeditionType.ARIANT;\n+var exped1 = MapleExpeditionType.ARIANT1;\n+var exped2 = MapleExpeditionType.ARIANT2;\n \n function start() {\n-    if((cm.getPlayer().getLevel() < 19 || cm.getPlayer().getLevel() > 30) && !cm.getPlayer().isGM()){\n-        cm.sendNext(\"You're not between level 20 and 30. Sorry, you may not participate.\");\n-        cm.dispose();\n-        return;\n-    }\n-    var text = \"What do you want?#b\";\n-    for(var i = 0; i < 3; i += 1)\n-        if (cm.getPlayerCount(980010100 + (i * 100)) > 0)\n-            if(cm.getPlayerCount(980010101 + (i * 100)) > 0)\n-                continue;\n-            else\n-                text += \"\\r\\n#L\" + i + \"# Battle Arena \" + (i + 1) + \"([\" + cm.getPlayerCount(980010100 + (i * 100)) + \"/\" + cm.getPlayer().getAriantSlotsRoom(i) + \"]  users: \" + cm.getPlayer().getAriantRoomLeaderName(i) + \")#l\";\n-        else{\n-            empty[i] = true;\n-            text += \"\\r\\n#L\" + i + \"# Battle Arena \" + (i + 1) + \"( Empty )#l\";\n-            if(cm.getPlayer().getAriantRoomLeaderName(i) != \"\")\n-                cm.getPlayer().removeAriantRoom(i);\n-        }\n-    cm.sendSimple(text + \"\\r\\n#L3# I'd like to know more about the competition.#l\");\n+    status = -1;\n+    action(1, 0, 0);\n }\n \n-function action(mode, type, selection){\n-    status++;\n-    if(mode != 1){\n-        if(mode == 0 && type == 0)\n-            status -= 2;\n-        else{\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && status == 0) {\n             cm.dispose();\n             return;\n         }\n-    }\n-    if (status == 0){\n-        if(sel == undefined)\n-            sel = selection;\n-        if(sel == 3)\n-            cm.sendNext(\"What do you need to do? You must be new to this. Allow me explain in detail.\");\n-        else{\n-            if(cm.getPlayer().getAriantRoomLeaderName(sel) != \"\" && empty[sel])\n-                empty[sel] = false;\n-            else if(cm.getPlayer().getAriantRoomLeaderName(sel) != \"\"){\n-                cm.warp(980010100 + (sel * 100));\n+        if (mode == 1) {\n+            status++;\n+        } else {\n+            status--;\n+        }\n+        if (cm.getPlayer().getMapId() == 980010000) {\n+            if (cm.getLevel() > 30) {\n+                cm.sendOk(\"You are already over #rlevel 30#k, therefore you can't participate in this instance anymore.\");\n                 cm.dispose();\n                 return;\n             }\n-            if(!empty[sel]){\n-                cm.sendNext(\"Another combatant has created the battle arena first. I advise you to either set up a new one, or join the battle arena that's already been set up.\");\n-                cm.dispose();\n-                return;\n+            \n+            if (status == 0) {\n+                var expedicao = cm.getExpedition(exped);\n+                var expedicao1 = cm.getExpedition(exped1);\n+                var expedicao2 = cm.getExpedition(exped2);\n+                \n+                var channelMaps = cm.getClient().getChannelServer().getMapFactory();\n+                var startSnd = \"Voc\ufffd gostaria de participar do Desafio #eAriant Coliseu#n?\\r\\n\\r\\n#e#r       (Escolha uma arena)#n#k\\r\\n#b\";\n+                var toSnd = startSnd;\n+\n+                if (expedicao == null) {\n+                    toSnd += \"#L0#Comece Ariant Coliseu (1)#l\\r\\n\";\n+                } else if (channelMaps.getMap(980010101).getCharacters().isEmpty()) {\n+                    toSnd += \"#L0#Junte-se ao Ariant Coliseu (1)  Dono (\" + expedicao.getLeader().getName() + \")\" + \" Membros Atuais: \" + cm.getExpeditionMemberNames(exped) + \"\\r\\n\";\n+                }\n+                if (expedicao1 == null) {\n+                    toSnd += \"#L1#Comece Ariant Coliseu (2)#l\\r\\n\";\n+                } else if (channelMaps.getMap(980010201).getCharacters().isEmpty()) {\n+                    toSnd += \"#L1#Junte-se ao Ariant Coliseu (2)  Dono (\" + expedicao1.getLeader().getName() + \")\" + \" Membros Atuais: \" + cm.getExpeditionMemberNames(exped1) + \"\\r\\n\";\n+                }\n+                if (expedicao2 == null) {\n+                    toSnd += \"#L2#Comece Ariant Coliseu (3)#l\\r\\n\";\n+                } else if (channelMaps.getMap(980010301).getCharacters().isEmpty()) {\n+                    toSnd += \"#L2#Junte-se ao Ariant Coliseu (3)  Dono (\" + expedicao2.getLeader().getName() + \")\" + \" Membros Atuais: \" + cm.getExpeditionMemberNames(exped2) + \"\\r\\n\";\n+                }\n+                if (toSnd.equals(startSnd)) {\n+                    cm.sendOk(\"Todas as arenas esta ocupadas agora. Eu sugiro que voc\ufffd volte mais tarde ou mudar de canal.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(toSnd);\n+                }\n+            } else if (status == 1) {\n+                arenaType = selection;\n+                expedicao = fetchArenaType();\n+                if (expedicao == \"\") {\n+                    cm.dispose();\n+                    return;\n+                }\n+                \n+                if (expedicao != null) {\n+                    enterArena(-1);\n+                } else {\n+                    cm.sendGetText(\"Quantos jogadores voce quer em sua instancia?\");\n+                }\n+            } else if (status == 2) {\n+                var players = parseInt(cm.getText());   // AriantPQ option limit found thanks to NarutoFury (iMrSiN)\n+                if (isNaN(players)) {\n+                    cm.sendNext(\"Por favor insira um valor num\u00e9rico de limite de jogadores permitidos em sua instancia.\");\n+                    status = 0;\n+                } else if (players < 2) {\n+                    cm.sendNext(\"Sua instancia precisa ter ao menos 2 jogadores.\");\n+                    status = 0;\n+                } else {\n+                    enterArena(players);\n+                } \n             }\n-            cm.sendGetNumber(\"Up to how many participants can join in this match? (2~6 ppl)\", 0, 2, 6);\n         }\n-    }else if (status == 1){\n-        if(sel == 3)\n-            cm.sendNextPrev(\"It's really simple, actually. You'll receive #b#t2270002##k from me, and your task is to eliminate a set amount of HP from the monster, then use #b#t2270002##k to absorb its monstrous power.\");\n-        else{\n-            if(cm.getPlayer().getAriantRoomLeaderName(sel) != \"\" && empty[sel])\n-                empty[sel] = false;\n-            if(!empty[sel]){\n-                cm.sendNext(\"Another combatant has created the battle arena first. I advise you to either set up a new one, or join the battle arena that's already been set up.\");\n-                cm.dispose();\n-                return;\n+    }\n+}\n+\n+function fetchArenaType() {\n+    switch (arenaType) {\n+        case 0 :\n+            exped = MapleExpeditionType.ARIANT;\n+            expedicao = cm.getExpedition(exped);\n+            map = 980010100;\n+            break;\n+        case 1 :\n+            exped = MapleExpeditionType.ARIANT1;\n+            expedicao = cm.getExpedition(exped);\n+            map = 980010200;\n+            break;\n+        case 2 :\n+            exped = MapleExpeditionType.ARIANT2;\n+            expedicao = cm.getExpedition(exped);\n+            map = 980010300;\n+            break;\n+        default :\n+            exped = null;\n+            map = 0;\n+            expedicao = \"\";\n+    }\n+    \n+    return expedicao;\n+}\n+\n+function enterArena(arenaPlayers) {\n+    expedicao = fetchArenaType();\n+    if (expedicao == \"\") {\n+        cm.dispose();\n+        return;\n+    } else if (expedicao == null) {\n+        if (arenaPlayers != -1) {\n+            if (cm.createExpedition(exped, true, 0, arenaPlayers)) {\n+                cm.warp(map, 0);\n+                cm.getPlayer().dropMessage(\"Sua Arena foi criada. Aguarde as pessoas entrarem agora!\");\n+            } else {\n+                cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n             }\n-            cm.getPlayer().setAriantRoomLeader(sel, cm.getPlayer().getName());\n-            cm.getPlayer().setAriantSlotRoom(sel, selection);\n-            cm.warp(980010100 + (sel * 100));\n-            cm.dispose();\n+        } else {\n+            cm.sendOk(\"An unexpected error has occurred when locating the expedition, please try again later.\");\n         }\n-    }else if (status == 2)\n-        cm.sendNextPrev(\"It's simple. If you absorb the power of the monster #b#t2270002##k, then you'll make #b#t4031868##k, which is something Queen Areda loves. The combatant with the most jewels wins the match. It's actually a smart idea to prevent others from absorbing in order to win.\");\n-    else if (status == 3)\n-        cm.sendNextPrev(\"One thing. Using #b#t2100067##k, you can steal #b#t4031868##k from your enemies. Warning: #rYou may not use pets for this.#k Understood?!\");\n-    else if (status == 4)\n+        \n         cm.dispose();\n+    } else {\n+        if (playerAlreadyInLobby(cm.getPlayer())) {\n+            cm.sendOk(\"Desculpe, voc\u00ea j\u00e1 pertence a alguma Lobby.\");\n+            cm.dispose();\n+            return;\n+        }\n+\n+        var playerAdd = expedicao.addMemberInt(cm.getPlayer());\n+        if (playerAdd == 3) {\n+            cm.sendOk(\"Desculpe, a Lobby esta cheia agora.\");\n+            cm.dispose();\n+        } else {\n+            if (playerAdd == 0) {\n+                cm.warp(map, 0);\n+                cm.dispose();\n+            } else if (playerAdd == 2) {\n+                cm.sendOk(\"Desculpe, mas o l\ufffdder pediu para nao ser autorizado a entrar.\");\n+                cm.dispose();\n+            } else {\n+                cm.sendOk(\"erro.\");\n+                cm.dispose();\n+            }\n+        }\n+    }\n }\n+\n+function playerAlreadyInLobby(player) {\n+    return cm.getExpedition(MapleExpeditionType.ARIANT) != null && cm.getExpedition(MapleExpeditionType.ARIANT).contains(player) ||\n+            cm.getExpedition(MapleExpeditionType.ARIANT1) != null && cm.getExpedition(MapleExpeditionType.ARIANT1).contains(player) ||\n+            cm.getExpedition(MapleExpeditionType.ARIANT2) != null && cm.getExpedition(MapleExpeditionType.ARIANT2).contains(player);\n+}\n\\ No newline at end of file"}, {"sha": "418bf8b337eb94d009571079790780f4b38fef97", "filename": "scripts/npc/2101015.js", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101015.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101015.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101015.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -0,0 +1,63 @@\n+var arena;\n+var status = 0;\n+\n+importPackage(Packages.client);\n+\n+function start() {\n+    arena = cm.getPlayer().getAriantColiseum();\n+    if (arena == null) {\n+        cm.sendOk(\"Ei, n\u00e3o vi voc\u00ea em campo durante as atividades do coliseu! O que voc\u00ea est\u00e1 fazendo aqui?\");\n+        cm.dispose();\n+        return;\n+    }\n+    \n+    status = -1;\n+    action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && status == 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        if (status == 0) {\n+            menuStr = generateSelectionMenu([\"Gostaria de verificar meus pontos de batalha / adquirir a minha Cadeira de Praia com Palmeira\", \"Gostaria de saber mais sobre os pontos da Arena de Batalha\"]);\n+            cm.sendSimple(\"Ol\u00e1, o que posso fazer por voc\u00ea?\\r\\n\\r\\n\" + menuStr);\n+        } else if (status == 1) {\n+            if (selection == 0) {\n+                apqpoints = cm.getPlayer().getAriantPoints();\n+                if (apqpoints < 100) {\n+                    cm.sendOk(\"A sua Pontua\ufffd\ufffdo de Arena de Batalha \ufffd #b\" + apqpoints + \"#k Pontos. Voc\ufffd precisa ultrapassar os #b100 Pontos#k para que eu possa lhe dar a #bCadeira de Praia com Palmeira#k. Fale comigo novamente somente quando voc\ufffd tiver pontos suficientes.\");\n+                    cm.dispose();\n+                } else if (apqpoints + arena.getAriantRewardTier(cm.getPlayer()) >= 100) {\n+                    cm.sendOk(\"A sua Pontua\ufffd\ufffdo de Arena de Batalha \ufffd #b\" + apqpoints + \"#k Pontos, e voc\ufffd praticamente j\u00e1 possui essa pontua\u00e7\u00e3o! Converse com minha esposa, #p2101016#, para adquiri-los e ent\u00e3o torne a conversar comigo!\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendNext(\"Uaaau, parece que voc\ufffd conseguiu os #b100 Pontos#k necess\ufffdrios para troca, vamos l\ufffd?!\");\n+                }\n+            } else if (selection == 1) {\n+                cm.sendOk(\"O objetivo maior das Arenas de Batalha \u00e9 permitir ao jogador acumular pontos para ent\u00e3o troc\u00e1-los honrosamente pelo pr\u00eamio maior: a #bCadeira de Praia com Palmeira#k. Acumule pontos durante as batalhas e fale comigo quando chegar a hora de adquirir seu item.\\r\\n\\r\\nEm cada batalha, \u00e9 dado ao jogador a oportunidade de #bsomar pontos baseando-se na quantidade de joias#k que o jogador possui ao final. Contudo tome cuidado! Se sua dist\u00e2ncia de pontos dentre os outros jogadores #rfor muito alto#k, isso ter\u00e1 sido tudo por nada e voc\u00ea ganhar\u00e1 mero #r1 ponto#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 2) {\n+            cm.getPlayer().gainAriantPoints(-100);\n+            cm.gainItem(3010018, 1);\n+            cm.dispose();\n+        }\n+    }\n+}\n+\n+function generateSelectionMenu(array) {     // nice tool for generating a string for the sendSimple functionality\n+    var menu = \"\";\n+    for (var i = 0; i < array.length; i++) {\n+        menu += \"#L\" + i + \"##b\" + array[i] + \"#l#k\\r\\n\";\n+    }\n+    return menu;\n+}\n\\ No newline at end of file"}, {"sha": "2e6070a93c91e9e202f73879e3b7c0c5c953ccba", "filename": "scripts/npc/2101016.js", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101016.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101016.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101016.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -0,0 +1,50 @@\n+var arena;\n+var status = 0;\n+\n+importPackage(Packages.client);\n+\n+function start() {\n+    arena = cm.getPlayer().getAriantColiseum();\n+    if (arena == null) {\n+        cm.sendOk(\"Ei, n\u00e3o vi voc\u00ea em campo durante as atividades do coliseu! O que voc\u00ea est\u00e1 fazendo aqui?\");\n+        cm.dispose();\n+        return;\n+    }\n+    \n+    status = -1;\n+    action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && status == 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        if (status == 0) {\n+            copns = arena.getAriantScore(cm.getPlayer());\n+            if (copns < 1 && !cm.getPlayer().isGM()) {\n+                cm.sendOk(\"Que pena, voc\ufffd nao conseguiu nenhuma j\ufffdia!\");\n+                cm.dispose();\n+            } else {\n+                cm.sendNext(\"Ok, vamos ver...Voc\ufffd foi muito bem, e voc\ufffd trouxe #b\" + copns + \"#k j\ufffdias que eu adoro. Como voc\ufffd completou a partida, vou recompens\ufffd-lo com a pontua\ufffd\ufffdo da Arena de Batalhas de #b\" + arena.getAriantRewardTier(cm.getPlayer()) + \" Pontos#k. Se voc\ufffd quiser saber mais sobre a pontua\ufffd\ufffdo de Arena de Batalha, ent\ufffdo fale com #b#p2101015##k.\");\n+            }\n+        } else if (status == 1) {\n+            //cm.warp(980010020, 0);\n+            copns = arena.getAriantRewardTier(cm.getPlayer());\n+            arena.clearAriantRewardTier(cm.getPlayer());\n+            arena.clearAriantScore(cm.getPlayer());\n+            cm.removeAll(4031868);\n+            \n+            cm.getPlayer().gainExp(92.7 * cm.getPlayer().getExpRate() * copns, true, true);\n+            cm.getPlayer().gainAriantPoints(copns);\n+            cm.dispose();\n+        }\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "acc2fab71dd6998c6d804eb9cd6361113ea1359e", "filename": "scripts/npc/2101017.js", "status": "modified", "additions": 126, "deletions": 126, "changes": 252, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101017.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2101017.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101017.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1,150 +1,150 @@\n-/*\n-    This file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-    Matthias Butz <matze@odinms.de>\n-    Jan Christian Meyer <vimes@odinms.de>\n+/*2101017.js\n+ *Cesar\n+ *@author Jvlaple\n+ */\n \n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n+importPackage(Packages.server.expeditions);\n \n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  \n-    See the GNU Affero General Public License for more details.\n \n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-\n-/*\n-\tNPC NAME: Cesar (3)\n-\tNPC ID: 2101017\n-\tAuthor: Vcoc\n-\tFunction: AriantPQ\n-*/\n-\n-importPackage(Packages.tools);\n-importPackage(Packages.client);\n-\n-status = -1;\n-var sel;\n+var status = 0;\n+var toBan = -1;\n+var choice;\n+var arena;\n+var arenaName;\n+var type;\n+var map;\n+var exped;\n+var expedicao;\n+var expedMembers;\n \n function start() {\n-    if((cm.getPlayer().getLevel() < 19 || cm.getPlayer().getLevel() > 30) && !cm.getPlayer().isGM()){\n-        cm.sendNext(\"You're not between level 20 and 30. Sorry, you may not participate.\");\n-        cm.dispose();\n-        return;\n-    }\n-    if(cm.getPlayer().getMapId() % 10 == 1)\n-        cm.sendSimple(\"Do you have a request for me?\\r\\n#b#L0# Give me #t2270002# and #t2100067#.#l\\r\\n#L1# What should I do?#l\\r\\n#L2# Get me out of here.#l\");\n-    else\n-        cm.sendSimple(cm.getPlayer().getAriantRoomLeaderName(((cm.getPlayer().getMapId() / 100) % 10) - 1) == cm.getPlayer().getName() ? \"Would you like to start the match?#b\\r\\n#b#L3# Ready to enter the Battle Arena!!#l\\r\\n#L1# I'd like to kick another character.#l\\r\\n#L2# Get me out of here.#l\" : \"What do you want?#b\\r\\n#L2# Get me out of here.#l\");\n+    action(1, 0, 0);\n }\n \n-function action(mode, type, selection){\n-    status++;\n-    if(mode != 1){\n-        if(mode == 0 && type == 0)\n-            status -= 2;\n-        else{\n+function action(mode, type, selection) {\n+    \n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0) {\n             cm.dispose();\n             return;\n         }\n-    }\n-    if(cm.getPlayer().getMapId() % 10 == 1){\n-        if (status == 0){\n-            if (sel == undefined)\n-                sel = selection;\n-            if(sel == 0){\n-                if(cm.haveItem(2270002))\n-                    cm.sendNext(\"You already have #b#t2270002##k.\");\n-            else if(cm.canHold(2270002) && cm.canHold(2100067)){\n-                if(cm.haveItem(2100067))\n-                    cm.removeAll(2100067);\n-                    cm.gainItem(2270002, 50);\n-                    cm.gainItem(2100067, 5);\n-                    cm.sendNext(\"Now lower the HP of the monsters, and use #b#t2270002##k to absorb their power!\");\n-                }else\n-                    cm.sendNext(\"Check and see if your Use inventory is full or not\");\n-                cm.dispose();\n-            }else if(sel == 1)\n-                cm.sendNext(\"What do you need to do? You must be new to this. Allow me explain in detail.\");\n-            else\n-                cm.sendYesNo(\"Are you sure you want to leave?\"); //No GMS like.\n-        } else if (status == 1){\n-            if(type == 1){\n-                cm.removeAll(4031868);\n-                cm.removeAll(2270002);\n-                cm.removeAll(2100067);\n-                cm.warp(980010020);\n+\n+        if (cm.getPlayer().getMapId() == 980010100 || cm.getPlayer().getMapId() == 980010200 || cm.getPlayer().getMapId() == 980010300) {\n+            if (cm.getPlayer().getMapId() == 980010100) {\n+                exped = MapleExpeditionType.ARIANT;\n+                expedicao = cm.getExpedition(exped);\n+\n+            } else if (cm.getPlayer().getMapId() == 980010200) {\n+                exped = MapleExpeditionType.ARIANT1;\n+                expedicao = cm.getExpedition(exped);\n+            } else {\n+                exped = MapleExpeditionType.ARIANT2;\n+                expedicao = cm.getExpedition(exped);\n+            }\n+            \n+            if (expedicao == null) {\n                 cm.dispose();\n                 return;\n             }\n-            cm.sendNextPrev(\"It's really simple, actually. You'll receive #b#t2270002##k from me, and your task is to eliminate a set amount of HP from the monster, then use #b#t2270002##k to absorb its monstrous power.\");\n-        } else if (status == 2)\n-            cm.sendNextPrev(\"It's simple. If you absorb the power of the monster #b#t2270002##k, then you'll make #b#t4031868##k, which is something Queen Areda loves. The combatant with the most jewels wins the match. It's actually a smart idea to prevent others from absorbing in order to win.\");\n-        else if (status == 3)\n-            cm.sendNextPrev(\"One thing. Using #b#t2100067##k, you can steal #b#t4031868##k from your enemies. Warning: #rYou may not use pets for this.#k Understood?!\");\n-        else if (status == 4)\n-            cm.dispose();\n-    }else{\n-        var nextchar = cm.getMap(cm.getPlayer().getMapId()).getCharacters().iterator();\n-        if(status == 0){\n-            if (sel == undefined)\n-                sel = selection;\n-            if(sel == 1)\n-                if(cm.getPlayerCount(cm.getPlayer().getMapId()) > 1){\n-                    var text = \"Who would you like to kick from room?\"; //Not GMS like text\n-                    var name;\n-                    for(var i = 0; nextchar.hasNext(); i++){\n-                        name = nextchar.next().getName();\n-                        if(!cm.getPlayer().getAriantRoomLeaderName(((cm.getPlayer().getMapId() / 100) % 10) - 1).equals(name))\n-                            text += \"\\r\\n#b#L\" + i + \"#\" + name + \"#l\";\n+            \n+            expedMembers = expedicao.getMemberList();\n+            if (status == 0) {\n+                if (cm.isLeaderExpedition(exped)) {\n+                    cm.sendSimple(\"O que voce gostaria de fazer?#b\\r\\n\\r\\n#L1#Ver registro atual da arena!#l\\r\\n#L2#Banir player!#l\\r\\n#L3#Comece a luta!#l\\r\\n#L4#Sair desta arena!#l\");\n+                    status = 1;\n+                } else {\n+                    var toSend = \"Voce tem atualmente essas pessoas em sua arena :\\r\\n#b\";\n+                    toSend += cm.getExpeditionMemberNames(exped);\n+                    cm.sendOk(toSend);\n+                    cm.dispose();\n+                }\n+            } else if (status == 1) {\n+                if (selection == 1) {\n+                    var toSend = \"Voce tem atualmente essas pessoas em sua arena :\\r\\n#b\";\n+                    toSend += cm.getExpeditionMemberNames(exped);\n+                    cm.sendOk(toSend);\n+                    cm.dispose();\n+                } else if (selection == 2) {\n+                    var size = expedMembers.size();\n+                    if (size == 1) {\n+                        cm.sendOk(\"You are the only member of the expedition.\");\n+                        cm.dispose();\n+                        return;\n+                    }\n+                    var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n+                    text += \"\\r\\n\\t\\t1.\" + expedicao.getLeader().getName();\n+                    for (var i = 1; i < size; i++) {\n+                        text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                     }\n                     cm.sendSimple(text);\n-                }else{\n-                    cm.sendNext(\"There's no character that can be kicked right now.\");\n+                    status = 6;\n+                } else if (selection == 3) {\n+                    if (expedicao.getMembers().size() < 1) {\n+                        cm.sendOk(\"Voc\ufffd precisa de mais que 2 jogadores para iniciar.\");\n+                        cm.dispose();\n+                    } else {\n+                        if (cm.getParty() != null) {\n+                            cm.sendOk(\"Voc\ufffd n\ufffdo pode entrar na batalha em um grupo.\");\n+                            cm.dispose();\n+                            return;\n+                        }\n+                        \n+                        var errorMsg = cm.startAriantBattle(exped, cm.getPlayer().getMapId());\n+                        if (errorMsg != \"\") {\n+                            cm.sendOk(errorMsg);\n+                        }\n+                        \n+                        cm.dispose();\n+                    }\n+                } else if (selection == 4) {\n+                    cm.mapMessage(5, \"O lider da Arena saiu.\");\n+                    expedicao.warpExpeditionTeam(980010000);\n+                    cm.endExpedition(expedicao);\n                     cm.dispose();\n                 }\n-            else if(sel == 2){\n-                if(cm.getPlayer().getAriantRoomLeaderName(((cm.getPlayer().getMapId() / 100) % 10) - 1) == cm.getPlayer().getName())\n-                    cm.sendYesNo(\"Are you sure you want to leave? You're the leader of the Arena, so if you leave, the whole Battle Arena will close.\");\n-                else\n-                    cm.sendYesNo(\"Are you sure you want to leave?\"); //No GMS like.\n-            }else if(sel == 3)\n-                if(cm.getPlayerCount(cm.getPlayer().getMapId()) > 1)\n-                    cm.sendYesNo(\"The room is all set, and no other character may join this Battle Arena. Do you want to start the game right now?\");\n-                else{\n-                    cm.sendNext(\"You'll need at least 2 participants inside in order to start the match.\");\n+            } else if (status == 6) {\n+                if (selection > 0) {\n+                    var banned = expedMembers.get(selection - 1);\n+                    expedicao.ban(banned);\n+                    cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                     cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n                 }\n-        }else if (status == 1){\n-            if(sel == 1){\n-                for(var i = 0; nextchar.hasNext(); i++)\n-                    if(i == selection){\n-                        nextchar.next().changeMap(cm.getMap(980010000));\n-                        break;\n-                    }else\n-                        nextchar.next();\n-                cm.sendNext(\"Player have been kicked out of the Arena.\"); //Not GMS like\n-            }else if(sel == 2){\n-                if(cm.getPlayer().getAriantRoomLeaderName(((cm.getPlayer().getMapId() / 100) % 10) - 1) != cm.getPlayer().getName())\n-                    cm.warp(980010000);\n-                else{\n-                    cm.getPlayer().removeAriantRoom((cm.getPlayer().getMapId() / 100) % 10);\n-                    cm.mapMessage(6, cm.getPlayer().getName() + \" has left the Arena, so the Arena will now close.\");\n-                    cm.warpMap(980010000);\n+            }\n+        } else if (Packages.constants.GameConstants.isAriantColiseumArena(cm.getPlayer().getMapId())) {\n+            if (cm.getPlayer().getMapId() == 980010101) {\n+                exped = MapleExpeditionType.ARIANT;\n+                expedicao = cm.getExpedition(exped);\n+            } else if (cm.getPlayer().getMapId() == 980010201) {\n+                exped = MapleExpeditionType.ARIANT1;\n+                expedicao = cm.getExpedition(exped);\n+            } else {\n+                exped = MapleExpeditionType.ARIANT2;\n+                expedicao = cm.getExpedition(exped);\n+            }\n+            if (status == 0) {\n+                var gotTheBombs = expedicao.getProperty(\"gotBomb\" + cm.getChar().getId());\n+                if (gotTheBombs != null) {\n+                    cm.sendOk(\"Eu ja lhe dei as bombas, por favor, mate os #eEscorpioes#n para conseguir mais delas!\");\n+                    cm.dispose();\n+                } else if (cm.canHoldAll([2270002, 2100067], [50, 5])) {\n+                    cm.sendOk(\"Eu lhe dei (5) #b#eBombas#k#n e (50) #b#eRochas Elementais#k#n.\\r\\nUse as rochas elementais para capturar os escorpioes para Sra.#r#eSpirit Jewels#k#n!\");\n+                    expedicao.setProperty(\"gotBomb\" + cm.getChar().getId(), \"1\");\n+                    cm.gainItem(2270002, 50);\n+                    cm.gainItem(2100067, 5);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"Por favor encontre 2 espa\u00e7os no seu invent\u00e1rio de USE antes de receber seus itens!\");\n+                    cm.dispose();\n                 }\n-            }else{\n-                cm.warpMap(cm.getPlayer().getMapId() + 1);\n-            //}\n-            //cm.getPlayer().getMap().broadcastMessage(MaplePacketCreator.updateAriantPQRanking(cm.getPlayer().getName(), 0, true));\n             }\n+        } else {\n+            cm.sendOk(\"Ol\u00e1, j\u00e1 ouviu falar da Ariant Coliseum Battle Arena? \u00c9 um evento competitivo dispon\u00edvel para jogadores entre n\u00edveis 20 a 30.\");\n             cm.dispose();\n-        }\n+        } \n     }\n }"}, {"sha": "77bbe35f65c467e4e6ec6363167dbe10987f77e8", "filename": "scripts/npc/2141001.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2141001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/2141001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2141001.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -101,8 +101,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "a7c160e6e42da979af4c7e75162889fdd8bc0953", "filename": "scripts/npc/9010022.js", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9010022.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9010022.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -20,14 +20,14 @@ function action(mode, type, selection) {\n         else \n             status--; \n             if (status == 0) { \n-            if (cm.getLevel() < 25) { \n+            if (cm.getLevel() < 20) { \n                 cm.sendDimensionalMirror(\"#-1# There is no place for you to transport to from here.\"); \n                 cm.dispose(); \n             } else { \n                 var selStr = \"\"; \n-                /*if (cm.getLevel() >= 20 && cm.getLevel() <= 30) { NOT IMPLEMENTED\n+                if (cm.getLevel() >= 20 && cm.getLevel() <= 30) {\n                     selStr += \"#0# Ariant Coliseum\"; \n-                } */\n+                }\n \n                 if (cm.getLevel() >= 25) { \n                     selStr += \"#1# Mu Lung Dojo\"; "}, {"sha": "ac660b742de81c6c7e286d0527ef19b23769c895", "filename": "scripts/npc/9120201.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9120201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9120201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120201.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -105,8 +105,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "67f6147b293b3aa2e5b2e5949a0471daebc58168", "filename": "scripts/npc/9201113.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9201113.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9201113.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201113.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -89,8 +89,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(cwkpq);\n-                cm.sendOk(\"The #rCrimsonwood Keep Party Quest Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(cwkpq)) {\n+                    cm.sendOk(\"The #rCrimsonwood Keep Party Quest Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "1f1a745553a11bfcfa6e4c8e37ad495cc62f47ae", "filename": "scripts/npc/9270047.js", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9270047.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9270047.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9270047.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -106,8 +106,12 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                cm.createExpedition(exped);\n-                cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                if (cm.createExpedition(exped)) {\n+                    cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else {\n+                    cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n+                }\n+                \n                 cm.dispose();\n                 return;\n             } else if (selection == 2) {"}, {"sha": "7692ad766ecb6d1b926c2baaaa187a1a531c027e", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -47,6 +47,7 @@ function writeFeatureTab_PQs() {\n         addFeature(\"Brand-new PQs: BossRushPQ, CafePQ.\");\n         addFeature(\"Mu Lung Dojo.\");\n         addFeature(\"Monster Carnival 1 & 2 - thanks Dragohe4rt & Jayd!\");\n+        addFeature(\"AriantPQ - thanks Dragohe4rt!\");\n         addFeature(\"Capt. Latanica with party fighting the boss.\");\n         addFeature(\"Filled up missing obligatory event script methods.\");\n         addFeature(\"Secured uniquety of active lobby-name instances.\");\n@@ -207,6 +208,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Custom jail system.\");\n         addFeature(\"Custom buyback system, uses mesos / NX, via MTS.\");\n         addFeature(\"Custom fishing system having 'seasonal' catch times.\");\n+        addFeature(\"Actual fishing handling w/ F. Net - thanks Dragohe4rt!\");\n         addFeature(\"Custom map leasing system.\");\n         addFeature(\"Delete Character.\");\n         addFeature(\"Smooth view-all-char, now showing all account chars.\");"}, {"sha": "eab384ba11776e0b73e37487ebc0fff2234b77f6", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -171,6 +171,7 @@ CREATE TABLE IF NOT EXISTS `characters` (\n   `monsterbookcover` int(11) NOT NULL DEFAULT '0',\n   `allianceRank` int(10) NOT NULL DEFAULT '5',\n   `vanquisherStage` int(11) unsigned NOT NULL DEFAULT '0',\n+  `ariantPoints` int(11) unsigned NOT NULL DEFAULT '0',\n   `dojoPoints` int(11) unsigned NOT NULL DEFAULT '0',\n   `lastDojoStage` int(10) unsigned NOT NULL DEFAULT '0',\n   `finishedDojoTutorial` tinyint(1) unsigned NOT NULL DEFAULT '0',"}, {"sha": "910413bf4355219211517ee9909ac01ac21264a7", "filename": "sql/db_drops.sql", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -21092,6 +21092,14 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300324, 2022178, 1, 1, 0, 200000),\n (9300324, 4001129, 1, 1, 0, 12987);\n \n+# add AriantPQ items, AriantPQ specific items found thanks to Dragohe4rt\n+  INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n+(9300157, 2100067, 1, 1, 0, 100000),\n+(9300157, 2022266, 1, 1, 0, 200000),\n+(9300157, 2022267, 1, 1, 0, 200000),\n+(9300157, 2022268, 1, 1, 0, 200000),\n+(9300157, 2022269, 1, 1, 0, 200000);\n+\n   CREATE TABLE IF NOT EXISTS `drop_data` (\n     `id` bigint(20) NOT NULL AUTO_INCREMENT,\n     `dropperid` int(11) NOT NULL,"}, {"sha": "57d3689910365daaaf804b3cd6d8fc45b06827dc", "filename": "src/client/MapleBuffStat.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleBuffStat.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleBuffStat.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleBuffStat.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -47,6 +47,7 @@\n     GHOST_MORPH(0x20000L),\n     AURA(0x40000L),\n     CONFUSE(0x80000L),\n+    ARIANT_PQ_SHIELD(0x40000L),\n     \n     // ------ COUPON feature ------\n     "}, {"sha": "7e9facfa6f903ed0f26c4ff72372668dac5e7f54", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 58, "deletions": 19, "changes": 77, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -100,6 +100,7 @@\n import server.life.MonsterDropEntry;\n import server.maps.SavedLocation;\n import server.maps.SavedLocationType;\n+import server.partyquest.AriantColiseum;\n import server.partyquest.MonsterCarnival;\n import server.partyquest.MonsterCarnivalParty;\n import server.partyquest.PartyQuest;\n@@ -131,7 +132,6 @@\n import constants.ExpTable;\n import constants.GameConstants;\n import constants.ItemConstants;\n-import constants.LanguageConstants;\n import constants.ServerConstants;\n import constants.skills.Aran;\n import constants.skills.Beginner;\n@@ -166,7 +166,6 @@\n import server.maps.MapleMapItem;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n-import scripting.AbstractPlayerInteraction;\n \n public class MapleCharacter extends AbstractMapleCharacterObject {\n     private static final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n@@ -196,7 +195,7 @@\n     private int battleshipHp = 0;\n     private int mesosTraded = 0;\n     private int possibleReports = 10;\n-    private int dojoPoints, vanquisherStage, dojoStage, dojoEnergy, vanquisherKills;\n+    private int ariantPoints, dojoPoints, vanquisherStage, dojoStage, dojoEnergy, vanquisherKills;\n     private int expRate = 1, mesoRate = 1, dropRate = 1, expCoupon = 1, mesoCoupon = 1, dropCoupon = 1;\n     private int omokwins, omokties, omoklosses, matchcardwins, matchcardties, matchcardlosses;\n     private int owlSearch;\n@@ -1979,13 +1978,14 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                         showHint(\"You have earned #e#b\" + nxGain + \" NX#k#n. (\" + this.getCashShop().getCash(1) + \" NX)\", 300);\n                     } else if (applyConsumeOnPickup(mItem.getItemId())) {\n                     } else if (MapleInventoryManipulator.addFromDrop(client, mItem, true)) {\n-                    } else if (mItem.getItemId() == 4031868) {\n-                        this.getMap().broadcastMessage(MaplePacketCreator.updateAriantPQRanking(this.getName(), this.getItemQuantity(4031868, false), false));\n+                        if (mItem.getItemId() == 4031868) {\n+                            updateAriantScore();\n+                        }\n                     } else {\n                         client.announce(MaplePacketCreator.enableActions());\n                         return;\n                     }\n-                    \n+\n                     this.getMap().pickItemDrop(pickupPacket, mapitem);\n                 } else if(!hasSpaceInventory) {\n                     client.announce(MaplePacketCreator.getInventoryFull());\n@@ -3175,6 +3175,21 @@ public static String getAriantRoomLeaderName(int room) {\n     public static int getAriantSlotsRoom(int room) {\n         return ariantroomslot[room];\n     }\n+    \n+    public void updateAriantScore() {\n+        updateAriantScore(0);\n+    }\n+    \n+    public void updateAriantScore(int dropQty) {\n+        AriantColiseum arena = this.getAriantColiseum();\n+        if (arena != null) {\n+            arena.updateAriantScore(this, countItem(4031868));\n+            \n+            if (dropQty > 0) {\n+                arena.addLostShards(dropQty);\n+            }\n+        }\n+    }\n \n     public int getBattleshipHp() {\n         return battleshipHp;\n@@ -5894,6 +5909,11 @@ public void leaveMap() {\n         if (map.unclaimOwnership(this)) {\n             map.dropMessage(5, \"This lawn is now free real estate.\");\n         }\n+        \n+        AriantColiseum arena = this.getAriantColiseum();\n+        if (arena != null) {\n+            arena.leaveArena(this);\n+        }\n     }\n     \n     private int getChangedJobSp(MapleJob newJob) {\n@@ -6685,6 +6705,7 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             ret.monsterbook = new MonsterBook();\n             ret.monsterbook.loadCards(charid);\n             ret.vanquisherStage = rs.getInt(\"vanquisherStage\");\n+            ret.ariantPoints = rs.getInt(\"ariantPoints\");\n             ret.dojoPoints = rs.getInt(\"dojoPoints\");\n             ret.dojoStage = rs.getInt(\"lastDojoStage\");\n             ret.dataString = rs.getString(\"dataString\");\n@@ -7137,12 +7158,12 @@ public void mount(int id, int skillid) {\n \n     private void playerDead() {\n         if (this.getMap().isCPQMap()) {\n-            int lost = getCP();\n-            if (lost > 6) {\n-                lost = 6;\n+            int losing = getMap().getDeathCP();\n+            if (getCP() < losing) {\n+                losing = getCP();\n             }\n-            getMap().broadcastMessage(MaplePacketCreator.playerDiedMessage(getName(), lost, getTeam()));\n-            gainCP(-lost);\n+            getMap().broadcastMessage(MaplePacketCreator.playerDiedMessage(getName(), losing, getTeam()));\n+            gainCP(-losing);\n             return;\n         }\n         \n@@ -7952,7 +7973,7 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n             con.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);\n             con.setAutoCommit(false);\n             PreparedStatement ps;\n-            ps = con.prepareStatement(\"UPDATE characters SET level = ?, fame = ?, str = ?, dex = ?, luk = ?, `int` = ?, exp = ?, gachaexp = ?, hp = ?, mp = ?, maxhp = ?, maxmp = ?, sp = ?, ap = ?, gm = ?, skincolor = ?, gender = ?, job = ?, hair = ?, face = ?, map = ?, meso = ?, hpMpUsed = ?, spawnpoint = ?, party = ?, buddyCapacity = ?, messengerid = ?, messengerposition = ?, mountlevel = ?, mountexp = ?, mounttiredness= ?, equipslots = ?, useslots = ?, setupslots = ?, etcslots = ?,  monsterbookcover = ?, vanquisherStage = ?, dojoPoints = ?, lastDojoStage = ?, finishedDojoTutorial = ?, vanquisherKills = ?, matchcardwins = ?, matchcardlosses = ?, matchcardties = ?, omokwins = ?, omoklosses = ?, omokties = ?, dataString = ?, fquest = ?, jailexpire = ?, partnerId = ?, marriageItemId = ?, lastExpGainTime = ? WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n+            ps = con.prepareStatement(\"UPDATE characters SET level = ?, fame = ?, str = ?, dex = ?, luk = ?, `int` = ?, exp = ?, gachaexp = ?, hp = ?, mp = ?, maxhp = ?, maxmp = ?, sp = ?, ap = ?, gm = ?, skincolor = ?, gender = ?, job = ?, hair = ?, face = ?, map = ?, meso = ?, hpMpUsed = ?, spawnpoint = ?, party = ?, buddyCapacity = ?, messengerid = ?, messengerposition = ?, mountlevel = ?, mountexp = ?, mounttiredness= ?, equipslots = ?, useslots = ?, setupslots = ?, etcslots = ?,  monsterbookcover = ?, vanquisherStage = ?, dojoPoints = ?, lastDojoStage = ?, finishedDojoTutorial = ?, vanquisherKills = ?, matchcardwins = ?, matchcardlosses = ?, matchcardties = ?, omokwins = ?, omoklosses = ?, omokties = ?, dataString = ?, fquest = ?, jailexpire = ?, partnerId = ?, marriageItemId = ?, lastExpGainTime = ?, ariantPoints = ? WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n             if (gmLevel < 1 && level > 199) {\n                 ps.setInt(1, isCygnus() ? 120 : 200);\n             } else {\n@@ -8066,7 +8087,8 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n             ps.setInt(51, partnerId);\n             ps.setInt(52, marriageItemid);\n             ps.setTimestamp(53, new Timestamp(lastExpGainTime));\n-            ps.setInt(54, id);\n+            ps.setInt(54, ariantPoints);\n+            ps.setInt(55, id);\n \n             int updateRows = ps.executeUpdate();\n             ps.close();\n@@ -10231,13 +10253,16 @@ public void setLastSnowballAttack(long time) {\n     \n     // MCPQ\n     \n-    private int cp = 0;\n-    private int totCP = 0;\n+    public AriantColiseum ariantColiseum;\n     private MonsterCarnival monsterCarnival;\n     private MonsterCarnivalParty monsterCarnivalParty = null;\n+    \n+    private int cp = 0;\n+    private int totCP = 0;\n     private int FestivalPoints;\n     private boolean challenged = false;\n-\n+    public short totalCP, availableCP;\n+    \n     public void gainFestivalPoints(int gain) {\n         this.FestivalPoints += gain;\n     }\n@@ -10254,8 +10279,6 @@ public int getCP() {\n         return cp;\n     }\n \n-    public short totalCP, availableCP;\n-\n     public void addCP(int ammount) {\n         totalCP += ammount;\n         availableCP += ammount;\n@@ -10318,6 +10341,14 @@ public void setMonsterCarnival(MonsterCarnival monsterCarnival) {\n         this.monsterCarnival = monsterCarnival;\n     }\n     \n+    public AriantColiseum getAriantColiseum() {\n+        return ariantColiseum;\n+    }\n+\n+    public void setAriantColiseum(AriantColiseum ariantColiseum) {\n+        this.ariantColiseum = ariantColiseum;\n+    }\n+    \n     public MonsterCarnivalParty getMonsterCarnivalParty() {\n         return this.monsterCarnivalParty;\n     }\n@@ -10333,6 +10364,14 @@ public boolean isChallenged() {\n     public void setChallenged(boolean challenged) {\n         this.challenged = challenged;\n     }\n+    \n+    public void gainAriantPoints(int points) {\n+        this.ariantPoints += points;\n+    }\n+    \n+    public int getAriantPoints() {\n+        return this.ariantPoints;\n+    }\n \n     public void setLanguage(int num) {\n         getClient().setLanguage(num);\n@@ -10354,4 +10393,4 @@ public int getLanguage() {\n         return getClient().getLanguage();\n     }\n     \n-}\n\\ No newline at end of file\n+}"}, {"sha": "66d36d4956342dafa8ba04c665feec3e7f477693", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -901,6 +901,10 @@ private void removePlayer(World wserv, boolean serverTransition) {\n                                 if (player.getMonsterCarnival() != null) {\n                                         player.getMonsterCarnival().playerDisconnected(getPlayer().getId());\n                                 }\n+                                \n+                                if (player.getAriantColiseum() != null) {\n+                                        player.getAriantColiseum().playerDisconnected(getPlayer());\n+                                }\n                         }\n                         \n                         if (player.getMap() != null) {"}, {"sha": "14984e729322fabd11e490169852c7d4a168dd89", "filename": "src/client/MapleDisease.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleDisease.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/MapleDisease.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleDisease.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -29,7 +29,7 @@\n     SEDUCE(0x80, 128),\n     FISHABLE(0x100),\n     ZOMBIFY(0x4000),\n-    CONFUSE(0x80000),\n+    CONFUSE(0x80000, 132),\n     STUN(0x2000000000000L, 123),\n     POISON(0x4000000000000L, 125),\n     SEAL(0x8000000000000L, 120),"}, {"sha": "5174fa903bd66d96bdf92d6f7e3ac2ba5eda13e0", "filename": "src/client/command/commands/gm1/BossHpCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm1/BossHpCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm1/BossHpCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm1/BossHpCommand.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -36,7 +36,7 @@\n     @Override\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n-        for(MapleMonster monster : player.getMap().getMonsters()) {\n+        for(MapleMonster monster : player.getMap().getAllMonsters()) {\n             if(monster != null && monster.isBoss() && monster.getHp() > 0) {\n                 long percent = monster.getHp() * 100L / monster.getMaxHp();\n                 String bar = \"[\";"}, {"sha": "3398dfd1faaf2f387e6673e0fdd0ba18b94b865d", "filename": "src/client/command/commands/gm1/MobHpCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm1/MobHpCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm1/MobHpCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm1/MobHpCommand.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -36,7 +36,7 @@\n     @Override\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n-        for(MapleMonster monster : player.getMap().getMonsters()) {\n+        for(MapleMonster monster : player.getMap().getAllMonsters()) {\n             if (monster != null && monster.getHp() > 0) {\n                 player.yellowMessage(monster.getName() + \" (\" + monster.getId() + \") has \" + monster.getHp() + \" / \" + monster.getMaxHp() + \" HP.\");\n "}, {"sha": "b8eda3c1a20b021bf9947981dbaa3bb01baea7b6", "filename": "src/client/command/commands/gm3/ExpedsCommand.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm3/ExpedsCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm3/ExpedsCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/ExpedsCommand.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -30,6 +30,7 @@\n import net.server.channel.Channel;\n import server.expeditions.MapleExpedition;\n \n+import java.util.List;\n import java.util.Map.Entry;\n \n public class ExpedsCommand extends Command {\n@@ -41,13 +42,14 @@\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n         for (Channel ch : Server.getInstance().getChannelsFromWorld(c.getWorld())) {\n-            if (ch.getExpeditions().isEmpty()) {\n+            List<MapleExpedition> expeds = ch.getExpeditions();\n+            if (expeds.isEmpty()) {\n                 player.yellowMessage(\"No Expeditions in Channel \" + ch.getId());\n                 continue;\n             }\n             player.yellowMessage(\"Expeditions in Channel \" + ch.getId());\n             int id = 0;\n-            for (MapleExpedition exped : ch.getExpeditions()) {\n+            for (MapleExpedition exped : expeds) {\n                 id++;\n                 player.yellowMessage(\"> Expedition \" + id);\n                 player.yellowMessage(\">> Type: \" + exped.getType().toString());"}, {"sha": "0c7f9da6352a09062dda072653f3d6e7ecf1ada6", "filename": "src/client/command/commands/gm4/ForceVacCommand.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm4/ForceVacCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/command/commands/gm4/ForceVacCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/ForceVacCommand.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -64,8 +64,10 @@ public void execute(MapleClient c, String[] params) {\n                         continue;\n                     }\n                     MapleInventoryManipulator.addById(c, mapItem.getItem().getItemId(), mapItem.getItem().getQuantity(), null, petId);\n-                } else {\n-                    MapleInventoryManipulator.addFromDrop(c, mapItem.getItem(), true);\n+                } else if (MapleInventoryManipulator.addFromDrop(c, mapItem.getItem(), true)) {\n+                    if (mapItem.getItemId() == 4031868) {\n+                        player.updateAriantScore();\n+                    }\n                 }\n \n                 player.getMap().pickItemDrop(MaplePacketCreator.removeItemFromMap(mapItem.getObjectId(), 2, player.getId()), mapItem);"}, {"sha": "a3fe13d19b83a0f451de9307c1964e4b564c1526", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -658,14 +658,6 @@ public static void drop(MapleClient c, MapleInventoryType type, short src, short\n         }\n         \n         MapleMap map = chr.getMap();\n-        if (chr.getItemEffect() == itemId && source.getQuantity() == 1) {\n-            chr.setItemEffect(0);\n-            map.broadcastMessage(MaplePacketCreator.itemEffect(chr.getId(), 0));\n-        } else if (itemId == 5370000 || itemId == 5370001) {\n-            if (chr.getItemQuantity(itemId, false) == 1) {\n-                chr.setChalkboard(null);\n-            }\n-        }\n         if ((!ItemConstants.isRechargeable(itemId) && source.getQuantity() < quantity) || quantity < 0) {\n             return;\n         }\n@@ -735,6 +727,20 @@ public static void drop(MapleClient c, MapleInventoryType type, short src, short\n                 map.spawnItemDrop(chr, chr, source, dropPos, true, true);\n             }\n         }\n+        \n+        int quantityNow = chr.getItemQuantity(itemId, false);\n+        if (itemId == chr.getItemEffect()) {\n+            if (quantityNow <= 0) {\n+                chr.setItemEffect(0);\n+                map.broadcastMessage(MaplePacketCreator.itemEffect(chr.getId(), 0));\n+            }\n+        } else if (itemId == 5370000 || itemId == 5370001) {\n+            if (source.getQuantity() <= 0) {\n+                chr.setChalkboard(null);\n+            }\n+        } else if (itemId == 4031868) {\n+            chr.updateAriantScore(quantityNow);\n+        }\n     }\n \n     private static boolean isDroppedItemRestricted(Item it) {"}, {"sha": "75c7e03954353ef610502d0ccae1e4e842fa7a77", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -21,6 +21,7 @@\n public class GameConstants {\n     public static String[] WORLD_NAMES = {\"Scania\", \"Bera\", \"Broa\", \"Windia\", \"Khaini\", \"Bellocan\", \"Mardia\", \"Kradia\", \"Yellonde\", \"Demethos\", \"Galicia\", \"El Nido\", \"Zenith\", \"Arcenia\", \"Kastia\", \"Judis\", \"Plana\", \"Kalluna\", \"Stius\", \"Croa\", \"Medere\"};\n     public static final int[]  OWL_DATA = new int[]{1082002, 2070005, 2070006, 1022047, 1102041, 2044705, 2340000, 2040017, 1092030, 2040804};\n+    public static final String[] stats = {\"tuc\", \"reqLevel\", \"reqJob\", \"reqSTR\", \"reqDEX\", \"reqINT\", \"reqLUK\", \"reqPOP\", \"cash\", \"cursed\", \"success\", \"setItemID\", \"equipTradeBlock\", \"durability\", \"randOption\", \"randStat\", \"masterLevel\", \"reqSkillLevel\", \"elemDefault\", \"incRMAS\", \"incRMAF\", \"incRMAI\", \"incRMAL\", \"canLevel\", \"skill\", \"charmEXP\"};\n     public static final int[] CASH_DATA = new int[]{50200004, 50200069, 50200117, 50100008, 50000047};\n     \n     // Ronan's rates upgrade system\n@@ -592,6 +593,16 @@ public static boolean isPyramid(int mapid) {\n     \treturn mapid >= 926010010 & mapid <= 930010000;\n     }\n     \n+    public static boolean isAriantColiseumLobby(int mapid) {\n+        int mapbranch = mapid / 1000;\n+    \treturn mapbranch == 980010 && mapid % 10 == 0;\n+    }\n+    \n+    public static boolean isAriantColiseumArena(int mapid) {\n+        int mapbranch = mapid / 1000;\n+    \treturn mapbranch == 980010 && mapid % 10 == 1;\n+    }\n+    \n     public static boolean isPqSkillMap(int mapid) {\n     \treturn isDojo(mapid) || isPyramid(mapid);\n     }"}, {"sha": "cf3032cdfb39014c1bd4c46c4a5cf9cdca818d7b", "filename": "src/net/server/Server.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -927,8 +927,7 @@ public void init() {\n         System.out.println(\"Skills loaded in \" + ((System.currentTimeMillis() - timeToTake) / 1000.0) + \" seconds\");\n \n         timeToTake = System.currentTimeMillis();\n-        //MapleItemInformationProvider.getInstance().getAllItems(); //unused, rofl\n-\n+        \n         CashItemFactory.getSpecialCashItems();\n         System.out.println(\"Items loaded in \" + ((System.currentTimeMillis() - timeToTake) / 1000.0) + \" seconds\");\n         "}, {"sha": "76fdf66f45d32b7cc1b7cc536e9f081b0d8d37f7", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -100,7 +100,7 @@\n     private Map<Integer, MapleHiredMerchant> hiredMerchants = new HashMap<>();\n     private final Map<Integer, Integer> storedVars = new HashMap<>();\n     private Set<Integer> playersAway = new HashSet<>();\n-    private List<MapleExpedition> expeditions = new ArrayList<>();\n+    private Map<MapleExpeditionType, MapleExpedition> expeditions = new HashMap<>();\n     private List<MapleExpeditionType> expedType = new ArrayList<>();\n     private Set<MapleMap> ownedMaps = Collections.synchronizedSet(Collections.newSetFromMap(new WeakHashMap<MapleMap, Boolean>()));\n     private MapleEvent event;\n@@ -468,8 +468,31 @@ public void removeHiredMerchant(int chrid) {\n         return retArr;\n     }\n     \n+    public boolean addExpedition(MapleExpedition exped) {\n+        synchronized (expeditions) {\n+            if (expeditions.containsKey(exped.getType())) {\n+                return false;\n+            }\n+            \n+            expeditions.put(exped.getType(), exped);\n+            return true;\n+        }\n+    }\n+    \n+    public void removeExpedition(MapleExpedition exped) {\n+        synchronized (expeditions) {\n+            expeditions.remove(exped.getType());\n+        }\n+    }\n+    \n+    public MapleExpedition getExpedition(MapleExpeditionType type) {\n+        return expeditions.get(type);\n+    }\n+    \n     public List<MapleExpedition> getExpeditions() {\n-    \treturn expeditions;\n+        synchronized (expeditions) {\n+            return new ArrayList<>(expeditions.values());\n+        }\n     }\n     \n     public boolean isConnected(String name) {"}, {"sha": "9c5aaace6692daf5d02000ad44bcd6438a3434ba", "filename": "src/net/server/channel/handlers/MonsterCarnivalHandler.java", "status": "modified", "additions": 29, "deletions": 14, "changes": 43, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MonsterCarnivalHandler.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -63,13 +63,13 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n \n                         final MapleMonster mob = MapleLifeFactory.getMonster(mobs.get(num).left);\n                         MonsterCarnival mcpq = c.getPlayer().getMonsterCarnival();\n-                        if (mcpq != null) {                        \n+                        if (mcpq != null) {\n                             if (!mcpq.canSummonR() && c.getPlayer().getTeam() == 0 || !mcpq.canSummonB() && c.getPlayer().getTeam() == 1) {\n                                 c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n                                 c.announce(MaplePacketCreator.enableActions());\n                                 return;\n                             }\n-\n+                            \n                             if (c.getPlayer().getTeam() == 0) {\n                                 mcpq.summonR();\n                             } else {\n@@ -135,19 +135,34 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                             c.announce(MaplePacketCreator.enableActions());\n                             return;\n                         }\n-                        int success = c.getPlayer().getMap().spawnGuardian(c.getPlayer().getTeam(), num);\n-                        if (success == -1 || success == 0 || success == 2) {\n-                            if (success == -1) {\n-                                c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n-                            } else if (success == 0) {\n-                                c.announce(MaplePacketCreator.CPQMessage((byte) 4));\n-                            } else if (success == 2) {\n-                                c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                        \n+                        MonsterCarnival mcpq = c.getPlayer().getMonsterCarnival();\n+                        if (mcpq != null) {\n+                            if (!mcpq.canGuardianR() && c.getPlayer().getTeam() == 0 || !mcpq.canGuardianB() && c.getPlayer().getTeam() == 1) {\n+                                c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            }\n+\n+                            int success = c.getPlayer().getMap().spawnGuardian(c.getPlayer().getTeam(), num);\n+                            if (success != 1) {\n+                                switch (success) {\n+                                    case -1:\n+                                        c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                                        break;\n+\n+                                    case 0:\n+                                        c.announce(MaplePacketCreator.CPQMessage((byte) 4));\n+                                        break;\n+\n+                                    default:\n+                                        c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                                }\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            } else {\n+                                neededCP = skill.cpLoss;\n                             }\n-                            c.announce(MaplePacketCreator.enableActions());\n-                            return;\n-                        } else {\n-                            neededCP = skill.cpLoss;\n                         }\n                     }\n                     c.getPlayer().gainCP(-neededCP);"}, {"sha": "4dc7677ed0a9fc1626a96f34a4b775c4a3146e02", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 45, "deletions": 18, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -27,14 +27,14 @@\n import client.Skill;\n import client.SkillFactory;\n import client.inventory.Item;\n+import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.status.MonsterStatus;\n import client.status.MonsterStatusEffect;\n import constants.GameConstants;\n import constants.ItemConstants;\n import constants.ServerConstants;\n import constants.skills.Aran;\n-import constants.skills.Corsair;\n \n import java.awt.Point;\n import java.util.Collections;\n@@ -44,6 +44,7 @@\n import net.AbstractMaplePacketHandler;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import server.MapleStatEffect;\n+import server.life.MapleLifeFactory;\n import server.life.MapleLifeFactory.loseItem;\n import server.life.MapleMonster;\n import server.life.MobAttackInfo;\n@@ -87,39 +88,65 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     }\n                 }\n                 \n+                if (monsteridfrom == 9300166 && attacker == null) {\n+                    if (c.tryacquireClient()) {\n+                        try {\n+                            attacker = MapleLifeFactory.getMonster(monsteridfrom);\n+                        } finally {\n+                            c.releaseClient();\n+                        }\n+                    }\n+                }\n+                \n                 if (attacker != null) {\n-                    List<loseItem> loseItems;\n-                    \n                     if (attacker.isBuffed(MonsterStatus.NEUTRALISE)) {\n                         return;\n                     }\n+                    \n+                    List<loseItem> loseItems;\n                     if (damage > 0) {\n-                        MapleMonster assaulter = map.getMonsterById(monsteridfrom);\n-                        \n-                        if(assaulter != null) {\n-                            loseItems = assaulter.getStats().loseItem();\n-                            if (loseItems != null) {\n+                        loseItems = attacker.getStats().loseItem();\n+                        if (loseItems != null) {\n+                            if (chr.getBuffEffect(MapleBuffStat.ARIANT_PQ_SHIELD) == null) {\n                                 MapleInventoryType type;\n                                 final int playerpos = chr.getPosition().x;\n                                 byte d = 1;\n                                 Point pos = new Point(0, chr.getPosition().y);\n                                 for (loseItem loseItem : loseItems) {\n                                     type = ItemConstants.getInventoryType(loseItem.getId());\n-                                    for (byte b = 0; b < loseItem.getX(); b++) {//LOL?\n+                                    \n+                                    int dropCount = 0;\n+                                    for (byte b = 0; b < loseItem.getX(); b++) {\n                                         if (Randomizer.nextInt(100) < loseItem.getChance()) {\n-                                            if (chr.haveItem(loseItem.getId())) {\n-                                                pos.x = (int) (playerpos + ((d % 2 == 0) ? (25 * (d + 1) / 2) : -(25 * (d / 2))));\n-                                                MapleInventoryManipulator.removeById(c, type, loseItem.getId(), 1, false, false);\n-                                                map.spawnItemDrop(chr, chr, new Item(loseItem.getId(), (short) 0, (short) 1), map.calcDropPos(pos, chr.getPosition()), true, true);\n-                                                d++;\n-                                            } else {\n-                                                break;\n-                                            }\n+                                            dropCount += 1;\n+                                        }\n+                                    }\n+                                    \n+                                    if (dropCount > 0) {\n+                                        int qty;\n+                                    \n+                                        MapleInventory inv = chr.getInventory(type);\n+                                        inv.lockInventory();\n+                                        try {\n+                                            qty = Math.min(chr.countItem(loseItem.getId()), dropCount);\n+                                            MapleInventoryManipulator.removeById(c, type, loseItem.getId(), qty, false, false);\n+                                        } finally {\n+                                            inv.unlockInventory();\n+                                        }\n+                                        \n+                                        if (loseItem.getId() == 4031868) {\n+                                            chr.updateAriantScore();\n+                                        }\n+\n+                                        for (byte b = 0; b < qty; b++) {\n+                                            pos.x = (int) (playerpos + ((d % 2 == 0) ? (25 * (d + 1) / 2) : -(25 * (d / 2))));\n+                                            map.spawnItemDrop(chr, chr, new Item(loseItem.getId(), (short) 0, (short) 1), map.calcDropPos(pos, chr.getPosition()), true, true);\n+                                            d++;\n                                         }\n                                     }\n                                 }\n-                                map.removeMapObject(attacker);\n                             }\n+                            map.removeMapObject(attacker);\n                         }\n                     }\n                 } else {"}, {"sha": "97e55b0ff3eb6150049c9b973eaa731016680816", "filename": "src/net/server/channel/handlers/UseCatchItemHandler.java", "status": "modified", "additions": 43, "deletions": 9, "changes": 52, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/UseCatchItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/UseCatchItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCatchItemHandler.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -29,6 +29,7 @@\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n import client.inventory.manipulator.MapleInventoryManipulator;\n+import server.MapleItemInformationProvider;\n import server.life.MapleMonster;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -47,7 +48,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         slea.readShort();\n         int itemId = slea.readInt();\n         int monsterid = slea.readInt();\n-\n+        \n         MapleMonster mob = chr.getMap().getMonsterByOid(monsterid);\n         if (chr.getInventory(ItemConstants.getInventoryType(itemId)).countById(itemId) <= 0) {\n            return;\n@@ -85,20 +86,25 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if (mob.getId() == 9300157) {\n                     if ((abm.getLastSpam(10) + 800) < currentServerTime()) {\n                         if (mob.getHp() < ((mob.getMaxHp() / 10) * 4)) {\n-                            if (Math.random() < 0.5) { // 50% chance\n-                                chr.getMap().broadcastMessage(MaplePacketCreator.catchMonster(monsterid, itemId, (byte) 1));\n-                                mob.getMap().killMonster(mob, null, false);\n-                                MapleInventoryManipulator.removeById(c, MapleInventoryType.USE, itemId, 1, true, true);\n-                                MapleInventoryManipulator.addById(c, 4031868, (short) 1, \"\", -1);\n+                            if (chr.canHold(4031868, 1)) {\n+                                if (Math.random() < 0.5) { // 50% chance\n+                                    chr.getMap().broadcastMessage(MaplePacketCreator.catchMonster(monsterid, itemId, (byte) 1));\n+                                    mob.getMap().killMonster(mob, null, false);\n+                                    MapleInventoryManipulator.removeById(c, MapleInventoryType.USE, itemId, 1, true, true);\n+                                    MapleInventoryManipulator.addById(c, 4031868, (short) 1, \"\", -1);\n+                                } else {\n+                                    chr.getMap().broadcastMessage(MaplePacketCreator.catchMonster(monsterid, itemId, (byte) 0));\n+                                }\n                             } else {\n-                                chr.getMap().broadcastMessage(MaplePacketCreator.catchMonster(monsterid, itemId, (byte) 0));\n+                                chr.dropMessage(5, \"Make a ETC slot available before using this item.\");\n                             }\n+                            \n                             abm.spam(10);\n                         } else {\n                             c.announce(MaplePacketCreator.catchMessage(0));\n                         }\n                     }\n-                c.announce(MaplePacketCreator.enableActions());\n+                    c.announce(MaplePacketCreator.enableActions());\n                 }\n                 break;\n             case 2270003:\n@@ -181,7 +187,35 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 break;\n             default:\n-               // System.out.println(\"UseCatchItemHandler: \\r\\n\" + slea.toString());\n+                // proper Fish catch, thanks to Dragohe4rt\n+                \n+                MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+                int itemGanho = ii.getCreateItem(itemId);\n+                int mobItem = ii.getMobItem(itemId);\n+                \n+                if (itemGanho != 0 && mobItem == mob.getId()) {\n+                    int timeCatch = ii.getUseDelay(itemId);\n+                    int mobHp = ii.getMobHP(itemId);\n+                    \n+                    if (timeCatch != 0 && (abm.getLastSpam(10) + timeCatch) < currentServerTime()) {\n+                        if (mobHp != 0 && mob.getHp() < ((mob.getMaxHp() / 100) * mobHp)) {\n+                            chr.getMap().broadcastMessage(MaplePacketCreator.catchMonster(monsterid, itemId, (byte) 1));\n+                            mob.getMap().killMonster(mob, null, false);\n+                            MapleInventoryManipulator.removeById(c, MapleInventoryType.USE, itemId, 1, true, true);\n+                            MapleInventoryManipulator.addById(c, itemGanho, (short) 1, \"\", -1);\n+                        } else if (mob.getId() != 9500336) {\n+                            if (mobHp != 0) {\n+                                abm.spam(10);\n+                                c.announce(MaplePacketCreator.catchMessage(0));\n+                            }\n+                        } else {\n+                            chr.message(\"You cannot use the Fishing Net yet.\");\n+                        }\n+                    }\n+                }\n+                c.announce(MaplePacketCreator.enableActions());\n+                \n+                // System.out.println(\"UseCatchItemHandler: \\r\\n\" + slea.toString());\n         }\n     }\n }"}, {"sha": "d750301b40e05ff4ffcc210c7666935ab98c7b42", "filename": "src/net/server/channel/handlers/UseDeathItemHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/UseDeathItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/channel/handlers/UseDeathItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseDeathItemHandler.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -27,6 +27,7 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class UseDeathItemHandler extends AbstractMaplePacketHandler {\n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int itemId = slea.readInt();\n         c.getPlayer().setItemEffect(itemId);"}, {"sha": "714710596cce3d9f3c68c1931cc5955fa4f7d216", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -327,9 +327,12 @@ public boolean equals(Object obj) {\n     public static boolean createParty(MapleCharacter player, boolean silentCheck) {\n         MapleParty party = player.getParty();\n         if (party == null) {\n-            if(player.getLevel() < 10 && !ServerConstants.USE_PARTY_FOR_STARTERS) {\n+            if (player.getLevel() < 10 && !ServerConstants.USE_PARTY_FOR_STARTERS) {\n                 player.announce(MaplePacketCreator.partyStatusMessage(10));\n                 return false;\n+            } else if (player.getAriantColiseum() != null) {\n+                player.dropMessage(5, \"You cannot request a party creation while participating the Ariant Battle Arena.\");\n+                return false;\n             }\n \n             MaplePartyCharacter partyplayer = new MaplePartyCharacter(player);"}, {"sha": "f06412de259ff1c1be48455ebc102c5610d64201", "filename": "src/provider/MapleDataTool.java", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/provider/MapleDataTool.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/provider/MapleDataTool.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/provider/MapleDataTool.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -72,6 +72,25 @@ public static int getIntConvert(MapleData data) {\n             return getInt(data);\n         }\n     }\n+    \n+    public static int getIntConvert(MapleData data, int def) {\n+        if (data == null) {\n+            return def;\n+        }\n+        if (data.getType() == MapleDataType.STRING) {\n+\t    String dd = getString(data);\n+\t    if (dd.endsWith(\"%\")) {\n+\t\tdd = dd.substring(0, dd.length() - 1);\n+\t    }\n+            try {\n+                return Integer.parseInt(dd);\n+            } catch (NumberFormatException nfe) {\n+                return def;\n+            }\n+        } else {\n+            return getInt(data, def);\n+        }\n+    }\n \n     public static int getIntConvert(String path, MapleData data) {\n         MapleData d = data.getChildByPath(path);"}, {"sha": "1d118e8c670d404928f7def13c28a2f9ce443aaf", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 23, "deletions": 10, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1009,25 +1009,38 @@ public Pyramid getPyramid() {\n \t\treturn (Pyramid) getPlayer().getPartyQuest();\n \t}\n \n-\tpublic void createExpedition(MapleExpeditionType type) {\n-\t\tMapleExpedition exped = new MapleExpedition(getPlayer(), type);\n-\t\tgetPlayer().getClient().getChannelServer().getExpeditions().add(exped);\n+        public boolean createExpedition(MapleExpeditionType type) {\n+                return createExpedition(type, false, 0, 0);\n+        }\n+        \n+\tpublic boolean createExpedition(MapleExpeditionType type, boolean silent, int minPlayers, int maxPlayers) {\n+\t\tMapleExpedition exped = new MapleExpedition(getPlayer(), type, silent, minPlayers, maxPlayers);\n+\t\treturn getPlayer().getClient().getChannelServer().addExpedition(exped);\n \t}\n \n \tpublic void endExpedition(MapleExpedition exped) {\n \t\texped.dispose(true);\n-\t\tgetPlayer().getClient().getChannelServer().getExpeditions().remove(exped);\n+\t\tgetPlayer().getClient().getChannelServer().removeExpedition(exped);\n \t}\n \n \tpublic MapleExpedition getExpedition(MapleExpeditionType type) {\n-\t\tfor (MapleExpedition exped : getPlayer().getClient().getChannelServer().getExpeditions()) {\n-\t\t\tif (exped.getType().equals(type)) {\n-\t\t\t\treturn exped;\n-\t\t\t}\n-\t\t}\n-\t\treturn null;\n+                return getPlayer().getClient().getChannelServer().getExpedition(type);\n \t}\n         \n+        public String getExpeditionMemberNames(MapleExpeditionType type) {\n+                String members = \"\";\n+                MapleExpedition exped = getExpedition(type);\n+                for (String memberName : exped.getMembers().values()) {\n+                       members += \"\" + memberName + \", \";\n+                }\n+                return members;\n+        }\n+\n+        public boolean isLeaderExpedition(MapleExpeditionType type) {\n+                MapleExpedition exped = getExpedition(type);\n+                return exped.isLeader(getPlayer());\n+        }\n+        \n         public long getJailTimeLeft() {\n                 return getPlayer().getJailExpirationTimeLeft();\n         }"}, {"sha": "9c327273a93cbe8f19f58ab4587e8195d783a237", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1065,7 +1065,7 @@ private void disposeExpedition() {\n                         \n                         sL.lock();\n                         try {\n-                                em.getChannelServer().getExpeditions().remove(expedition);\n+                                em.getChannelServer().removeExpedition(expedition);\n                         } finally {\n                                 sL.unlock();\n                         }"}, {"sha": "fa110996f1c52b9b843898741e27fbcc338cf185", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -67,6 +67,9 @@\n import server.TimerManager;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n+import server.expeditions.MapleExpedition;\n+import server.expeditions.MapleExpeditionType;\n+import server.partyquest.AriantColiseum;\n import server.partyquest.MonsterCarnival;\n import tools.packets.Wedding;\n \n@@ -1000,6 +1003,56 @@ public void challengeParty(int field) {\n             }\n         }\n         \n+        private synchronized boolean setupAriantBattle(MapleExpedition exped, int mapid) {\n+            MapleMap arenaMap = this.getMap().getChannelServer().getMapFactory().getMap(mapid + 1);\n+            if (!arenaMap.getAllPlayers().isEmpty()) {\n+                return false;\n+            }\n+            \n+            new AriantColiseum(arenaMap, exped);\n+            return true;\n+        }\n+        \n+        public String startAriantBattle(MapleExpeditionType expedType, int mapid) {\n+            if (!GameConstants.isAriantColiseumLobby(mapid)) {\n+                return \"You cannot start an Ariant tournament from outside the Battle Arena Entrance.\";\n+            }\n+            \n+            MapleExpedition exped = this.getMap().getChannelServer().getExpedition(expedType);\n+            if (exped == null) {\n+                return \"Please register on an expedition before attempting to start an Ariant tournament.\";\n+            }\n+            \n+            List<MapleCharacter> players = exped.getActiveMembers();\n+            \n+            int playersSize = players.size();\n+            if (!(playersSize >= exped.getMinSize() && playersSize <= exped.getMaxSize())) {\n+                return \"Make sure there are between #r\" + exped.getMinSize() + \" ~ \" + exped.getMaxSize() + \" players#k in this room to start the battle.\";\n+            }\n+            \n+            MapleMap leaderMap = this.getMap();\n+            for (MapleCharacter mc : players) {\n+                if (mc.getMap() != leaderMap) {\n+                    return \"All competing players should be on this area to start the battle.\";\n+                }\n+                \n+                if (mc.getParty() != null) {\n+                    return \"All competing players must not be on a party to start the battle.\";\n+                }\n+                \n+                int level = mc.getLevel();\n+                if (!(level >= expedType.getMinLevel() && level <= expedType.getMaxLevel())) {\n+                    return \"There are competing players outside of the acceptable level range in this room. All players must be on #blevel between 20~30#k to start the battle.\";\n+                }\n+            }\n+            \n+            if (setupAriantBattle(exped, mapid)) {\n+                return \"\";\n+            } else {\n+                return \"Other players are already competing on the Ariant tournament in this room. Please wait a while until the arena becomes available again.\";\n+            }\n+        }\n+        \n         public void sendMarriageWishlist(boolean groom) {\n             MapleCharacter player = this.getPlayer();\n             MapleMarriage marriage = player.getMarriageInstance();"}, {"sha": "44237c5630c1d9dd770edaeef6417620ef486477", "filename": "src/scripting/reactor/ReactorActionManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/reactor/ReactorActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/scripting/reactor/ReactorActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorActionManager.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -317,7 +317,7 @@ public void run() {\n     public void dispelAllMonsters(int num, int team) { //dispels all mobs, cpq\n         final MCSkill skil = MapleCarnivalFactory.getInstance().getGuardian(num);\n         if (skil != null) {\n-            for (MapleMonster mons : getMap().getMonsters()) {\n+            for (MapleMonster mons : getMap().getAllMonsters()) {\n                 if(mons.getTeam() == team) {\n                     mons.dispelSkill(skil.getSkill());\n                 }"}, {"sha": "3191072343f4ff3e33f001d7ae290d86357734aa", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 48, "deletions": 35, "changes": 83, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -116,6 +116,10 @@ public static MapleItemInformationProvider getInstance() {\n     protected Map<Integer, Boolean> karmaCache = new HashMap<>();\n     protected Map<Integer, Integer> triggerItemCache = new HashMap<>();\n     protected Map<Integer, Integer> expCache = new HashMap<>();\n+    protected Map<Integer, Integer> createItem = new HashMap<>();\n+    protected Map<Integer, Integer> mobItem = new HashMap<>();\n+    protected Map<Integer, Integer> useDelay = new HashMap<>();\n+    protected Map<Integer, Integer> mobHP = new HashMap<>();\n     protected Map<Integer, Integer> levelCache = new HashMap<>();\n     protected Map<Integer, Pair<Integer, List<RewardItem>>> rewardCache = new HashMap<>();\n     protected List<Pair<Integer, String>> itemNameCache = new ArrayList<>();\n@@ -150,40 +154,6 @@ private MapleItemInformationProvider() {\n         isPartyQuestItemCache.put(0, false);\n     }\n \n-//    public MapleInventoryType getInventoryType(int itemId) {\n-//        if (inventoryTypeCache.containsKey(itemId)) {\n-//            return inventoryTypeCache.get(itemId);\n-//        }\n-//        MapleInventoryType ret;\n-//        String idStr = \"0\" + String.valueOf(itemId);\n-//        MapleDataDirectoryEntry root = itemData.getRoot();\n-//        for (MapleDataDirectoryEntry topDir : root.getSubdirectories()) {\n-//            for (MapleDataFileEntry iFile : topDir.getFiles()) {\n-//                if (iFile.getName().equals(idStr.substring(0, 4) + \".img\")) {\n-//                    ret = MapleInventoryType.getByWZName(topDir.getName());\n-//                    inventoryTypeCache.put(itemId, ret);\n-//                    return ret;\n-//                } else if (iFile.getName().equals(idStr.substring(1) + \".img\")) {\n-//                    ret = MapleInventoryType.getByWZName(topDir.getName());\n-//                    inventoryTypeCache.put(itemId, ret);\n-//                    return ret;\n-//                }\n-//            }\n-//        }\n-//        root = equipData.getRoot();\n-//        for (MapleDataDirectoryEntry topDir : root.getSubdirectories()) {\n-//            for (MapleDataFileEntry iFile : topDir.getFiles()) {\n-//                if (iFile.getName().equals(idStr + \".img\")) {\n-//                    ret = MapleInventoryType.EQUIP;\n-//                    inventoryTypeCache.put(itemId, ret);\n-//                    return ret;\n-//                }\n-//            }\n-//        }\n-//        ret = MapleInventoryType.UNDEFINED;\n-//        inventoryTypeCache.put(itemId, ret);\n-//        return ret;\n-//    }\n \n     public List<Pair<Integer, String>> getAllItems() {\n         if (!itemNameCache.isEmpty()) {\n@@ -1176,7 +1146,10 @@ public MapleStatEffect getItemEffect(int itemId) {\n             if (item == null) {\n                 return null;\n             }\n-            MapleData spec = item.getChildByPath(\"spec\");\n+            MapleData spec = item.getChildByPath(\"specEx\");\n+            if (spec == null) {\n+                spec = item.getChildByPath(\"spec\");\n+            }\n             ret = MapleStatEffect.loadItemEffectFromData(spec, itemId);\n             itemEffects.put(Integer.valueOf(itemId), ret);\n         }\n@@ -1479,6 +1452,46 @@ public int getStateChangeItem(int itemId) {\n             return triggerItem;\n         }\n     }\n+    \n+    public int getCreateItem(int itemId) {\n+        if (createItem.containsKey(itemId)) {\n+            return createItem.get(itemId);\n+        } else {\n+            int itemFrom = MapleDataTool.getIntConvert(\"info/create\", getItemData(itemId), 0);\n+            createItem.put(itemId, itemFrom);\n+            return itemFrom;\n+        }\n+    }\n+    \n+    public int getMobItem(int itemId) {\n+        if (mobItem.containsKey(itemId)) {\n+            return mobItem.get(itemId);\n+        } else {\n+            int mobItemCatch = MapleDataTool.getIntConvert(\"info/mob\", getItemData(itemId), 0);\n+            mobItem.put(itemId, mobItemCatch);\n+            return mobItemCatch;\n+        }\n+    }\n+    \n+    public int getUseDelay(int itemId) {\n+        if (useDelay.containsKey(itemId)) {\n+            return useDelay.get(itemId);\n+        } else {\n+            int mobUseDelay = MapleDataTool.getIntConvert(\"info/useDelay\", getItemData(itemId), 0);\n+            useDelay.put(itemId, mobUseDelay);\n+            return mobUseDelay;\n+        }\n+    }\n+    \n+    public int getMobHP(int itemId) {\n+        if (mobHP.containsKey(itemId)) {\n+            return mobHP.get(itemId);\n+        } else {\n+            int mobHPItem = MapleDataTool.getIntConvert(\"info/mobHP\", getItemData(itemId), 0);\n+            mobHP.put(itemId, mobHPItem);\n+            return mobHPItem;\n+        }\n+    }\n \n     public int getExpById(int itemId) {\n         if (expCache.containsKey(itemId)) {"}, {"sha": "2c08b7354f4189c8e7d8723fe0b4e4bdd0c4973f", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 50, "deletions": 5, "changes": 55, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -112,6 +112,8 @@\n import constants.skills.WindArcher;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n+import server.life.MobSkill;\n+import server.life.MobSkillFactory;\n import server.partyquest.MapleCarnivalFactory;\n import server.partyquest.MapleCarnivalFactory.MCSkill;\n \n@@ -125,10 +127,10 @@\n     private short watk, matk, wdef, mdef, acc, avoid, speed, jump;\n     private short hp, mp;\n     private double hpR, mpR;\n-    private short mhpRRate, mmpRRate;\n+    private short mhpRRate, mmpRRate, mobSkill, mobSkillLevel;\n     private byte mhpR, mmpR;\n     private short mpCon, hpCon;\n-    private int duration;\n+    private int duration, target, barrier, mob;\n     private boolean overTime, repeatEffect;\n     private int sourceid;\n     private int moveTo;\n@@ -208,6 +210,23 @@ private static MapleStatEffect loadFromData(MapleData source, int sourceid, bool\n         ret.fatigue = MapleDataTool.getInt(\"incFatigue\", source, 0);\n         ret.repeatEffect = MapleDataTool.getInt(\"repeatEffect\", source, 0) > 0;\n \n+        MapleData mdd = source.getChildByPath(\"0\");\n+        if (mdd != null && mdd.getChildren().size() > 0) {\n+            ret.mobSkill = (short) MapleDataTool.getInt(\"mobSkill\", mdd, 0);\n+            ret.mobSkillLevel = (short) MapleDataTool.getInt(\"level\", mdd, 0);\n+            ret.target = MapleDataTool.getInt(\"target\", mdd, 0);\n+        } else {\n+            ret.mobSkill = 0;\n+            ret.mobSkillLevel = 0;\n+            ret.target = 0;\n+        }\n+        \n+        MapleData mdds = source.getChildByPath(\"mob\");\n+        if (mdds != null) {\n+            if (mdds.getChildren()!= null && mdds.getChildren().size() > 0) {\n+                ret.mob = MapleDataTool.getInt(\"mob\", mdds, 0);\n+            }\n+        }\n         ret.sourceid = sourceid;\n         ret.skill = skill;\n         if (!ret.skill && ret.duration > -1) {\n@@ -228,9 +247,12 @@ private static MapleStatEffect loadFromData(MapleData source, int sourceid, bool\n         ret.speed = (short) MapleDataTool.getInt(\"speed\", source, 0);\n         ret.jump = (short) MapleDataTool.getInt(\"jump\", source, 0);\n \n+        ret.barrier = MapleDataTool.getInt(\"barrier\", source, 0);\n+        addBuffStatPairToListIfNotZero(statups, MapleBuffStat.ARIANT_PQ_SHIELD, ret.barrier);\n+        \n         ret.mapProtection = mapProtection(sourceid);\n         addBuffStatPairToListIfNotZero(statups, MapleBuffStat.MAP_PROTECTION, Integer.valueOf(ret.mapProtection));\n-\n+        \n         if (ret.overTime && ret.getSummonMovementType() == null) {\n             if (!skill) {\n                 if (isPyramidBuff(sourceid)) {\n@@ -978,8 +1000,20 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                     applyfrom.dispelDebuff(debuff);\n                 }\n             }\n+        } else if (mobSkill > 0 && mobSkillLevel > 0) {\n+            MobSkill ms = MobSkillFactory.getMobSkill(mobSkill, mobSkillLevel);\n+            MapleDisease dis = MapleDisease.getBySkill(mobSkill);\n+            \n+            if (target > 0) {\n+                for (MapleCharacter chr : applyto.getMap().getAllPlayers()) {\n+                    if (chr.getId() != applyto.getId()) {\n+                        chr.giveDebuff(dis, ms);\n+                    }\n+                }\n+            } else {\n+                applyto.giveDebuff(dis, ms);\n+            }\n         }\n-\n         return true;\n     }\n \n@@ -1204,7 +1238,6 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n \n                     localstatups = statups;\n                 }\n-\n                 buff = MaplePacketCreator.giveBuff(localsourceid, localDuration, localstatups);\n                 mbuff = MaplePacketCreator.showMonsterRiding(applyto.getId(), givemount);\n                 localDuration = duration;\n@@ -1219,6 +1252,9 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n             } else if (isMorph()) {\n                 List<Pair<MapleBuffStat, Integer>> stat = Collections.singletonList(new Pair<>(MapleBuffStat.MORPH, Integer.valueOf(getMorph(applyto))));\n                 mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), stat);\n+            } else if (isAriantShield()) {\n+                List<Pair<MapleBuffStat, Integer>> stat = Collections.singletonList(new Pair<>(MapleBuffStat.ARIANT_PQ_SHIELD, 1));\n+                mbuff = MaplePacketCreator.giveForeignBuff(applyto.getId(), stat);\n             }\n \n             if (buff != null) {\n@@ -1455,6 +1491,10 @@ public static boolean isRateCoupon(int sourceid) {\n     public static boolean isExpIncrease(int sourceid) {\n         return sourceid >= 2022450 && sourceid <= 2022452;\n     }\n+    \n+    public static boolean isAriantShield(int sourceid) {\n+        return sourceid == 2022269;\n+    }\n \n     private boolean isDs() {\n         return skill && (sourceid == Rogue.DARK_SIGHT || sourceid == NightWalker.DARK_SIGHT);\n@@ -1487,6 +1527,11 @@ private boolean isChakra() {\n     private boolean isCouponBuff() {\n         return isRateCoupon(sourceid);\n     }\n+    \n+    private boolean isAriantShield() {\n+        int itemid = sourceid;\n+        return isAriantShield(itemid);\n+    }\n \n     private boolean isMysticDoor() {\n         return skill && sourceid == Priest.MYSTIC_DOOR;"}, {"sha": "5a3c0dab036f796acbf89c73ca41bd80b4f1f062", "filename": "src/server/expeditions/MapleExpedition.java", "status": "modified", "additions": 154, "deletions": 39, "changes": 193, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/expeditions/MapleExpedition.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/expeditions/MapleExpedition.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/expeditions/MapleExpedition.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -41,6 +41,11 @@\n import tools.LogHelper;\n import tools.MaplePacketCreator;\n import client.MapleCharacter;\n+import java.util.Iterator;\n+import java.util.Properties;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n /**\n  *\n@@ -89,21 +94,38 @@\n \tprivate Map<Integer, String> members = new ConcurrentHashMap<>();\n \tprivate List<Integer> banned = new CopyOnWriteArrayList<>();\n \tprivate long startTime;\n+        private Properties props = new Properties();\n+        private boolean silent;\n+        private int minSize, maxSize;\n+        private MonitoredReentrantLock pL = MonitoredReentrantLockFactory.createLock(MonitoredLockType.EIM_PARTY, true);\n \n-\tpublic MapleExpedition(MapleCharacter player, MapleExpeditionType met) {\n+\tpublic MapleExpedition(MapleCharacter player, MapleExpeditionType met, boolean sil, int minPlayers, int maxPlayers) {\n \t\tleader = player;\n \t\tmembers.put(player.getId(), player.getName());\n                 startMap = player.getMap();\n \t\ttype = met;\n+                silent = sil;\n+                minSize = (minPlayers != 0) ? minPlayers : type.getMinSize();\n+                maxSize = (maxPlayers != 0) ? maxPlayers : type.getMaxSize();\n \t\tbossLogs = new CopyOnWriteArrayList<>();\n \t\tbeginRegistration();\n \t}\n+        \n+        public int getMinSize() {\n+                return minSize;\n+        }\n+        \n+        public int getMaxSize() {\n+                return maxSize;\n+        }\n \n \tprivate void beginRegistration() {\n \t\tregistering = true;\n                 leader.announce(MaplePacketCreator.getClock(type.getRegistrationTime() * 60));\n-\t\tstartMap.broadcastMessage(leader, MaplePacketCreator.serverNotice(6, \"[Expedition] \" + leader.getName() + \" has been declared the expedition captain. Please register for the expedition.\"), false);\n-                leader.announce(MaplePacketCreator.serverNotice(6, \"[Expedition] You have become the expedition captain. Gather enough people for your team then talk to the NPC to start.\"));\n+\t\tif (!silent) {\n+                        startMap.broadcastMessage(leader, MaplePacketCreator.serverNotice(6, \"[Expedition] \" + leader.getName() + \" has been declared the expedition captain. Please register for the expedition.\"), false);\n+                        leader.announce(MaplePacketCreator.serverNotice(6, \"[Expedition] You have become the expedition captain. Gather enough people for your team then talk to the NPC to start.\"));\n+                }\n \t\tscheduleRegistrationEnd();\n \t}\n \n@@ -115,8 +137,8 @@ private void scheduleRegistrationEnd() {\n \t\t\t@Override\n \t\t\tpublic void run() {\n \t\t\t\tif (registering){\n-                                        startMap.getChannelServer().getExpeditions().remove(exped);\n-\t\t\t\t\tstartMap.broadcastMessage(MaplePacketCreator.serverNotice(6, \"[Expedition] The time limit has been reached. Expedition has been disbanded.\"));\n+                                        startMap.getChannelServer().removeExpedition(exped);\n+\t\t\t\t\tif (!silent) startMap.broadcastMessage(MaplePacketCreator.serverNotice(6, \"[Expedition] The time limit has been reached. Expedition has been disbanded.\"));\n                                         \n                                         dispose(false);\n \t\t\t\t}\n@@ -134,11 +156,15 @@ public void dispose(boolean log){\n \t\t\tLogHelper.logExpedition(this);\n \t\t}\n \t}\n+        \n+        public void finishRegistration() {\n+                registering = false;\n+        }\n \n \tpublic void start(){\n-\t\tregistering = false;\n+\t\tfinishRegistration();\n \t\tbroadcastExped(MaplePacketCreator.removeClock());\n-\t\tbroadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] The expedition has started! Good luck, brave heroes!\"));\n+\t\tif (!silent) broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] The expedition has started! Good luck, brave heroes!\"));\n \t\tstartTime = System.currentTimeMillis();\n \t\tServer.getInstance().broadcastGMMessage(startMap.getWorld(), MaplePacketCreator.serverNotice(6, \"[Expedition] \" + type.toString() + \" Expedition started with leader: \" + leader.getName()));\n \t}\n@@ -150,15 +176,32 @@ public String addMember(MapleCharacter player) {\n \t\tif (banned.contains(player.getId())){\n \t\t\treturn \"Sorry, you've been banned from this expedition by #b\" + leader.getName() + \"#k.\";\n \t\t}\n-\t\tif (members.size() >= type.getMaxSize()){ //Would be a miracle if anybody ever saw this\n+\t\tif (members.size() >= this.getMaxSize()){ //Would be a miracle if anybody ever saw this\n \t\t\treturn \"Sorry, this expedition is full!\";\n \t\t}\n                 \n                 members.put(player.getId(), player.getName());\n                 player.announce(MaplePacketCreator.getClock((int)(startTime - System.currentTimeMillis()) / 1000));\n-                broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has joined the expedition!\"));\n+                if (!silent) broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has joined the expedition!\"));\n                 return \"You have registered for the expedition successfully!\";\n \t}\n+        \n+        public int addMemberInt(MapleCharacter player) {\n+                if (!registering) {\n+                        return 1; //\"Sorry, this expedition is already underway. Registration is closed!\";\n+                }\n+                if (banned.contains(player.getId())) {\n+                        return 2; //\"Sorry, you've been banned from this expedition by #b\" + leader.getName() + \"#k.\";\n+                }\n+                if (members.size() >= this.getMaxSize()) { //Would be a miracle if anybody ever saw this\n+                       return 3; //\"Sorry, this expedition is full!\";\n+                }\n+\n+                members.put(player.getId(), player.getName());\n+                player.announce(MaplePacketCreator.getClock((int) (startTime - System.currentTimeMillis()) / 1000));\n+                if (!silent) broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has joined the expedition!\"));\n+                return 0; //\"You have registered for the expedition successfully!\";\n+        }\n \n \tprivate void broadcastExped(byte[] packet){\n \t\tfor (MapleCharacter chr : getActiveMembers()){\n@@ -169,13 +212,62 @@ private void broadcastExped(byte[] packet){\n \tpublic boolean removeMember(MapleCharacter chr) {\n \t\tif(members.remove(chr.getId()) != null) {\n                     chr.announce(MaplePacketCreator.removeClock());\n-                    broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getName() + \" has left the expedition.\"));\n-                    chr.dropMessage(6, \"[Expedition] You have left this expedition.\");\n+                    if (!silent) {\n+                        broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getName() + \" has left the expedition.\"));\n+                        chr.dropMessage(6, \"[Expedition] You have left this expedition.\");\n+                    }\n                     return true;\n                 }\n                 \n                 return false;\n \t}\n+        \n+        public void ban(Entry<Integer, String> chr) {\n+            int cid = chr.getKey();\n+            if (!banned.contains(cid)) {\n+                banned.add(cid);\n+                members.remove(cid);\n+\n+                if (!silent) broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getValue() + \" has been banned from the expedition.\"));\n+\n+                MapleCharacter player = startMap.getWorldServer().getPlayerStorage().getCharacterById(cid);\n+                if (player != null && player.isLoggedinWorld()) {\n+                    player.announce(MaplePacketCreator.removeClock());\n+                    if (!silent) player.dropMessage(6, \"[Expedition] You have been banned from this expedition.\");\n+                    if (MapleExpeditionType.ARIANT.equals(type) || MapleExpeditionType.ARIANT1.equals(type) || MapleExpeditionType.ARIANT2.equals(type)) {\n+                        player.changeMap(980010000);\n+                    }\n+                }\n+            }\n+        }\n+\n+        public void monsterKilled(MapleCharacter chr, MapleMonster mob) {\n+            for (int i = 0; i < EXPEDITION_BOSSES.length; i++) {\n+                if (mob.getId() == EXPEDITION_BOSSES[i]) { //If the monster killed was a boss\n+                    String timeStamp = new SimpleDateFormat(\"HH:mm:ss\").format(new Date());\n+                    bossLogs.add(\">\" + mob.getName() + \" was killed after \" + LogHelper.getTimeString(startTime) + \" - \" + timeStamp + \"\\r\\n\");\n+                    return;\n+                }\n+            }\n+        }\n+\n+        public void setProperty(String key, String value) {\n+            pL.lock();\n+            try {\n+                props.setProperty(key, value);\n+            } finally {\n+                pL.unlock();\n+            }\n+        }\n+\n+        public String getProperty(String key) {\n+            pL.lock();\n+            try {\n+                return props.getProperty(key);\n+            } finally {\n+                pL.unlock();\n+            }\n+        }\n \n \tpublic MapleExpeditionType getType() {\n \t\treturn type;\n@@ -217,6 +309,56 @@ public MapleExpeditionType getType() {\n             \n                 return memberList;\n \t}\n+        \n+        public final boolean isExpeditionTeamTogether() {\n+                List<MapleCharacter> chars = getActiveMembers();\n+                if(chars.size() <= 1) return true;\n+\n+                Iterator<MapleCharacter> iterator = chars.iterator();\n+                MapleCharacter mc = iterator.next();\n+                int mapId = mc.getMapId();\n+\n+                for (; iterator.hasNext();) {\n+                        mc = iterator.next();\n+                        if(mc.getMapId() != mapId) return false;\n+                }\n+\n+                return true;\n+        }\n+        \n+        public final void warpExpeditionTeam(int warpFrom, int warpTo) {\n+                List<MapleCharacter> players = getActiveMembers();\n+                \n+                for (MapleCharacter chr : players) {\n+                        if(chr.getMapId() == warpFrom)\n+                                chr.changeMap(warpTo);\n+                }\n+        }\n+        \n+        public final void warpExpeditionTeam(int warpTo) {\n+                List<MapleCharacter> players = getActiveMembers();\n+                \n+                for (MapleCharacter chr : players) {\n+                        chr.changeMap(warpTo);\n+                }\n+        }\n+        \n+        public final void warpExpeditionTeamToMapSpawnPoint(int warpFrom, int warpTo, int toSp) {\n+                List<MapleCharacter> players = getActiveMembers();\n+                \n+                for (MapleCharacter chr : players) {\n+                        if(chr.getMapId() == warpFrom)\n+                                chr.changeMap(warpTo, toSp);\n+                }\n+        }\n+        \n+        public final void warpExpeditionTeamToMapSpawnPoint(int warpTo, int toSp) {\n+                List<MapleCharacter> players = getActiveMembers();\n+                \n+                for (MapleCharacter chr : players) {\n+                        chr.changeMap(warpTo, toSp);\n+                }\n+        }\n \n \tpublic MapleCharacter getLeader(){\n \t\treturn leader;\n@@ -245,39 +387,12 @@ public boolean isRegistering(){\n \tpublic boolean isInProgress(){\n \t\treturn !registering;\n \t}\n-\n-\tpublic void ban(Entry<Integer, String> chr) {\n-                int cid = chr.getKey();\n-                \n-\t\tif (!banned.contains(cid)) {\n-\t\t\tbanned.add(cid);\n-\t\t\tmembers.remove(cid);\n-                        \n-                        broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getValue() + \" has been banned from the expedition.\"));\n-                        \n-                        MapleCharacter player = startMap.getWorldServer().getPlayerStorage().getCharacterById(cid);\n-                        if (player != null && player.isLoggedinWorld()) {\n-                                player.announce(MaplePacketCreator.removeClock());\n-                                player.dropMessage(6, \"[Expedition] You have been banned from this expedition.\");\n-                        }\n-\t\t}\n-\t}\n-\n+        \n \tpublic long getStartTime(){\n \t\treturn startTime;\n \t}\n \t\n \tpublic List<String> getBossLogs(){\n \t\treturn bossLogs;\n \t}\n-\t\n-\tpublic void monsterKilled(MapleCharacter chr, MapleMonster mob) {\n-\t\tfor (int i = 0; i < EXPEDITION_BOSSES.length; i++){\n-\t\t\tif (mob.getId() == EXPEDITION_BOSSES[i]){ //If the monster killed was a boss\n-\t\t\t\tString timeStamp = new SimpleDateFormat(\"HH:mm:ss\").format(new Date());\n-\t\t\t\tbossLogs.add(\">\" + mob.getName() + \" was killed after \" + LogHelper.getTimeString(startTime) + \" - \" + timeStamp + \"\\r\\n\");\n-\t\t\t\treturn;\n-\t\t\t}\n-\t\t}\n-\t}\n }"}, {"sha": "c94007f17607f69ac4baaccb41963e5f34aae1e5", "filename": "src/server/expeditions/MapleExpeditionType.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/expeditions/MapleExpeditionType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/expeditions/MapleExpeditionType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/expeditions/MapleExpeditionType.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -39,6 +39,9 @@\n     HORNTAIL(6, 30, 100, 255, 5),\n     CHAOS_ZAKUM(6, 30, 120, 255, 5),\n     CHAOS_HORNTAIL(6, 30, 120, 255, 5),\n+    ARIANT(2, 7, 20, 30, 5),\n+    ARIANT1(2, 7, 20, 30, 5),\n+    ARIANT2(2, 7, 20, 30, 5),\n     PINKBEAN(6, 30, 120, 255, 5),\n     CWKPQ(6, 30, 90, 255, 5);   // CWKPQ min-level 90, found thanks to Cato\n     "}, {"sha": "9d22fd9b8a6f6e99f52315aeae33db6b1e554572", "filename": "src/server/life/Element.java", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/life/Element.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/life/Element.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/Element.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -22,8 +22,23 @@\n package server.life;\n \n public enum Element {\n-    NEUTRAL, FIRE, ICE, LIGHTING, POISON, HOLY, DARK;\n+    NEUTRAL(0), PHYSICAL(1), FIRE(2, true), ICE(3, true), LIGHTING(4), POISON(5), HOLY(6, true), DARKNESS(7);\n \n+    private int value;\n+    private boolean special = false;\n+    private Element(int v) {\n+\tthis.value = v;\n+    }\n+\n+    private Element(int v, boolean special) {\n+\tthis.value = v;\n+\tthis.special = special;\n+    }\n+\n+    public boolean isSpecial() {\n+\treturn special;\n+    }\n+    \n     public static Element getFromChar(char c) {\n         switch (Character.toUpperCase(c)) {\n             case 'F':\n@@ -37,10 +52,14 @@ public static Element getFromChar(char c) {\n             case 'H':\n                 return HOLY;\n             case 'D':\n-            \treturn DARK;\n+            \treturn DARKNESS;\n             case 'P':\n                 return NEUTRAL;\n         }\n         throw new IllegalArgumentException(\"unknown elemnt char \" + c);\n     }\n+    \n+    public int getValue() {\n+\treturn value;\n+    }\n }"}, {"sha": "aa303158568e70aa6d6565c83bc564f99ac44287", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 92, "deletions": 18, "changes": 110, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -85,9 +85,9 @@\n import server.life.MonsterGlobalDropEntry;\n import server.life.SpawnPoint;\n import scripting.event.EventInstanceManager;\n+import server.expeditions.MapleExpedition;\n+import server.expeditions.MapleExpeditionType;\n import server.life.MaplePlayerNPC;\n-import server.life.MobSkill;\n-import server.life.MobSkillFactory;\n import server.life.MonsterListener;\n import server.partyquest.GuardianSpawnPoint;\n import server.partyquest.MapleCarnivalFactory;\n@@ -166,6 +166,13 @@\n     private MapleSnowball snowball1 = null;\n     private MapleCoconut coconut;\n     \n+    //CPQ\n+    private int maxMobs;\n+    private int maxReactors;\n+    private int deathCP;\n+    private int timeDefault;\n+    private int timeExpand;\n+\n     //locks\n     private ReadLock chrRLock;\n     private WriteLock chrWLock;\n@@ -1009,6 +1016,17 @@ private void spawnMobItemDrops() {\n         }\n     }\n     \n+    public int getDroppedItemsCountById(int itemid) {\n+        int count = 0;\n+        for (MapleMapItem mmi : getDroppedItems()) {\n+            if (mmi.getItemId() == itemid) {\n+                count++;\n+            }\n+        }\n+        \n+        return count;\n+    }\n+    \n     public void pickItemDrop(byte[] pickupPacket, MapleMapItem mdrop) { // mdrop must be already locked and not-pickedup checked by now\n         broadcastMessage(pickupPacket, mdrop.getPosition());\n         \n@@ -1200,6 +1218,28 @@ public int countReactors() {\n         return getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.REACTOR));\n     }\n     \n+    public final List<MapleMapObject> getMonsters() {\n+        return getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.MONSTER));\n+    }\n+    \n+    public final List<MapleReactor> getAllReactors() {\n+        List<MapleReactor> list = new LinkedList<>();\n+        for (MapleMapObject mmo : getReactors()) {\n+            list.add((MapleReactor) mmo);\n+        }\n+        \n+        return list;\n+    }\n+    \n+    public final List<MapleMonster> getAllMonsters() {\n+        List<MapleMonster> list = new LinkedList<>();\n+        for (MapleMapObject mmo : getMonsters()) {\n+            list.add((MapleMonster) mmo);\n+        }\n+        \n+        return list;\n+    }\n+    \n     public int countItems() {\n         return getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.ITEM)).size();\n     }\n@@ -1284,16 +1324,6 @@ public boolean damageMonster(final MapleCharacter chr, final MapleMonster monste\n         }\n         return false;\n     }\n-\n-    public List<MapleMonster> getMonsters() {\n-        List<MapleMonster> mobs = new ArrayList<>();\n-        for (MapleMapObject object : this.getMapObjects()) {\n-            if (object instanceof MapleMonster) {\n-                mobs.add((MapleMonster)object);\n-            }\n-        }\n-        return mobs;\n-    }\n     \n     public void broadcastBalrogVictory(String leaderName) {\n         getWorldServer().dropMessage(6, \"[Victory] \" + leaderName + \"'s party has successfully defeated the Balrog! Praise to them, they finished with \" + countAlivePlayers() + \" players alive.\");\n@@ -1429,7 +1459,7 @@ public void killFriendlies(MapleMonster mob) {\n \n     public void killMonster(int mobId) {\n         MapleCharacter chr = (MapleCharacter) getPlayers().get(0);\n-        List<MapleMonster> mobList = getMonsters();\n+        List<MapleMonster> mobList = getAllMonsters();\n         \n         for (MapleMonster mob : mobList) {    \n             if (mob.getId() == mobId) {\n@@ -1443,7 +1473,7 @@ public void killMonsterWithDrops(int mobId) {\n         \n         if(!mapChars.isEmpty()) {\n             MapleCharacter defaultChr = mapChars.entrySet().iterator().next().getValue();\n-            List<MapleMonster> mobList = getMonsters();\n+            List<MapleMonster> mobList = getAllMonsters();\n             \n             for (MapleMonster mob : mobList) {\n                 if (mob.getId() == mobId) {\n@@ -2539,6 +2569,9 @@ public void run() {\n             if (mmd != null) {\n                 mmd.registerPlayer(chr);\n             }\n+        } else if (GameConstants.isAriantColiseumArena(mapid)) {\n+            int pqTimer = (10 * 60 * 1000);\n+            chr.announce(MaplePacketCreator.getClock(pqTimer / 1000));\n         }\n         \n         MaplePet[] pets = chr.getPets();\n@@ -2738,13 +2771,13 @@ public MaplePortal findMarketPortal() {\n     */\n     \n     public void addPlayerPuppet(MapleCharacter player) {\n-        for (MapleMonster mm : this.getMonsters()) {\n+        for (MapleMonster mm : this.getAllMonsters()) {\n             mm.aggroAddPuppet(player);\n         }\n     }\n     \n     public void removePlayerPuppet(MapleCharacter player) {\n-        for (MapleMonster mm : this.getMonsters()) {\n+        for (MapleMonster mm : this.getAllMonsters()) {\n             mm.aggroRemovePuppet(player);\n         }\n     }\n@@ -4459,7 +4492,7 @@ public boolean isCPQLoserMap() {\n     }\n     \n     public void dispose() {\n-        for(MapleMonster mm : this.getMonsters()) {\n+        for(MapleMonster mm : this.getAllMonsters()) {\n             mm.dispose();\n         }\n         \n@@ -4498,4 +4531,45 @@ public void dispose() {\n             chrWLock.unlock();\n         }\n     }\n-}\n\\ No newline at end of file\n+    \n+    public int getMaxMobs() {\n+        return maxMobs;\n+    }\n+\n+    public void setMaxMobs(int maxMobs) {\n+        this.maxMobs = maxMobs;\n+    }\n+\n+    public int getMaxReactors() {\n+        return maxReactors;\n+    }\n+\n+    public void setMaxReactors(int maxReactors) {\n+        this.maxReactors = maxReactors;\n+    }\n+\n+    public int getDeathCP() {\n+        return deathCP;\n+    }\n+\n+    public void setDeathCP(int deathCP) {\n+        this.deathCP = deathCP;\n+    }\n+\n+    public int getTimeDefault() {\n+        return timeDefault;\n+    }\n+\n+    public void setTimeDefault(int timeDefault) {\n+        this.timeDefault = timeDefault;\n+    }\n+\n+    public int getTimeExpand() {\n+        return timeExpand;\n+    }\n+\n+    public void setTimeExpand(int timeExpand) {\n+        this.timeExpand = timeExpand;\n+    }\n+\n+}"}, {"sha": "8da376a8f4684532d935bb13451e9775f240bdca", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -94,12 +94,12 @@ private void loadLifeFromWz(MapleMap map, MapleData mapData) {\n             String type = MapleDataTool.getString(life.getChildByPath(\"type\"));\n             int team = MapleDataTool.getInt(\"team\", life, -1);\n             if (map.isCPQMap2() && type.equals(\"m\")) {\n-                if((Integer.parseInt(life.getName()) % 2) == 0)  {\n+                if ((Integer.parseInt(life.getName()) % 2) == 0) {\n                     team = 0;\n                 } else {\n                     team = 1;\n                 }\n-            } \n+            }\n             int cy = MapleDataTool.getInt(life.getChildByPath(\"cy\"));\n             MapleData dF = life.getChildByPath(\"f\");\n             int f = (dF != null) ? MapleDataTool.getInt(dF) : 0;\n@@ -214,7 +214,7 @@ private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid, boolean c\n         MapleData timeMob = infoData.getChildByPath(\"timeMob\");\n         if (timeMob != null) {\n             map.timeMob(MapleDataTool.getInt(timeMob.getChildByPath(\"id\")),\n-                    MapleDataTool.getString(timeMob.getChildByPath(\"message\")));\n+            MapleDataTool.getString(timeMob.getChildByPath(\"message\")));\n         }\n \n         int bounds[] = new int[4];\n@@ -315,25 +315,31 @@ private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid, boolean c\n         if (map.isCPQMap()) {\n             MapleData mcData = mapData.getChildByPath(\"monsterCarnival\");\n             if (mcData != null) {\n+                map.setDeathCP(MapleDataTool.getIntConvert(\"deathCP\", mcData, 0));\n+                map.setMaxMobs(MapleDataTool.getIntConvert(\"mobGenMax\", mcData, 0));\n+                map.setTimeDefault(MapleDataTool.getIntConvert(\"timeDefault\", mcData, 0));\n+                map.setTimeExpand(MapleDataTool.getIntConvert(\"timeExpand\", mcData, 0));\n+                map.setMaxReactors(MapleDataTool.getIntConvert(\"guardianGenMax\", mcData, 0));\n                 MapleData guardianGenData = mcData.getChildByPath(\"guardianGenPos\");\n                 for (MapleData node : guardianGenData.getChildren()) {\n                     GuardianSpawnPoint pt = new GuardianSpawnPoint(new Point(MapleDataTool.getIntConvert(\"x\", node), MapleDataTool.getIntConvert(\"y\", node)));\n                     pt.setTeam(MapleDataTool.getIntConvert(\"team\", node, -1));\n                     pt.setTaken(false);\n                     map.addGuardianSpawnPoint(pt);\n                 }\n-            }\n-            if (mcData.getChildByPath(\"skill\") != null) {\n-                for (MapleData area : mcData.getChildByPath(\"skill\")) {\n-                    map.addSkillId(MapleDataTool.getInt(area));\n+                if (mcData.getChildByPath(\"skill\") != null) {\n+                    for (MapleData area : mcData.getChildByPath(\"skill\")) {\n+                        map.addSkillId(MapleDataTool.getInt(area));\n+                    }\n                 }\n-            }\n-            \n-            if (mcData.getChildByPath(\"mob\") != null) {\n-                for (MapleData area : mcData.getChildByPath(\"mob\")) {\n-                    map.addMobSpawn(MapleDataTool.getInt(area.getChildByPath(\"id\")), MapleDataTool.getInt(area.getChildByPath(\"spendCP\")));\n+\n+                if (mcData.getChildByPath(\"mob\") != null) {\n+                    for (MapleData area : mcData.getChildByPath(\"mob\")) {\n+                        map.addMobSpawn(MapleDataTool.getInt(area.getChildByPath(\"id\")), MapleDataTool.getInt(area.getChildByPath(\"spendCP\")));\n+                    }\n                 }\n             }\n+\n         }\n \n         if (mapData.getChildByPath(\"reactor\") != null) {"}, {"sha": "ea965367899d1751dc041881bfaf9bb72517d0a2", "filename": "src/server/partyquest/AriantColiseum.java", "status": "added", "additions": 302, "deletions": 0, "changes": 302, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/partyquest/AriantColiseum.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/partyquest/AriantColiseum.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/AriantColiseum.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -0,0 +1,302 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server.partyquest;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.concurrent.ScheduledFuture;\n+import client.MapleCharacter;\n+import constants.GameConstants;\n+import server.TimerManager;\n+import server.expeditions.MapleExpedition;\n+import server.expeditions.MapleExpeditionType;\n+import server.maps.MapleMap;\n+import tools.MaplePacketCreator;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class AriantColiseum {\n+    \n+    private MapleExpedition exped;\n+    private MapleMap map;\n+    \n+    private Map<MapleCharacter, Integer> score;\n+    private Map<MapleCharacter, Integer> rewardTier;\n+    private boolean scoreDirty = false;\n+    \n+    private ScheduledFuture<?> ariantUpdate;\n+    private ScheduledFuture<?> ariantFinish;\n+    private ScheduledFuture<?> ariantScoreboard;\n+    \n+    private int lostShards = 0;\n+    \n+    private boolean eventClear = false;\n+    \n+    public AriantColiseum(MapleMap eventMap, MapleExpedition expedition) {\n+        exped = expedition;\n+        exped.finishRegistration();\n+        \n+        map = eventMap;\n+        map.resetFully();\n+        \n+        int pqTimer = 10 * 60 * 1000;\n+        int pqTimerBoard = (9 * 60 * 1000) + 50 * 1000;\n+        \n+        List<MapleCharacter> players = exped.getActiveMembers();\n+        score = new HashMap<>();\n+        rewardTier = new HashMap<>();\n+        for (MapleCharacter mc : players) {\n+            mc.changeMap(map, 0);\n+            mc.setAriantColiseum(this);\n+            mc.updateAriantScore();\n+            rewardTier.put(mc, 0);\n+        }\n+        \n+        for (MapleCharacter mc : players) {\n+            mc.announce(MaplePacketCreator.updateAriantPQRanking(score));\n+        }\n+        \n+        setAriantScoreBoard(TimerManager.getInstance().schedule(new Runnable() {\n+            @Override\n+            public void run() {\n+                showArenaResults();\n+            }\n+        }, pqTimerBoard));\n+        \n+        setArenaFinish(TimerManager.getInstance().schedule(new Runnable() {\n+            @Override\n+            public void run() {\n+                enterKingsRoom();\n+            }\n+        }, pqTimer));\n+        \n+        setArenaUpdate(TimerManager.getInstance().register(new Runnable() {\n+            @Override\n+            public void run() {\n+                broadcastAriantScoreUpdate();\n+            }\n+        }, 500, 500));\n+    }\n+    \n+    private void setArenaUpdate(ScheduledFuture<?> ariantUpdate) {\n+        this.ariantUpdate = ariantUpdate;\n+    }\n+    \n+    private void setArenaFinish(ScheduledFuture<?> arenaFinish) {\n+        this.ariantFinish = arenaFinish;\n+    }\n+    \n+    private void setAriantScoreBoard(ScheduledFuture<?> ariantScore) {\n+        this.ariantScoreboard = ariantScore;\n+    }\n+    \n+    private void cancelArenaUpdate() {\n+        if (ariantUpdate != null) {\n+            ariantUpdate.cancel(true);\n+            ariantUpdate = null;\n+        }\n+    }\n+    \n+    private void cancelArenaFinish() {\n+        if (ariantFinish != null) {\n+            ariantFinish.cancel(true);\n+            ariantFinish = null;\n+        }\n+    }\n+    \n+    private void cancelAriantScoreBoard() {\n+        if (ariantScoreboard != null) {\n+            ariantScoreboard.cancel(true);\n+            ariantScoreboard = null;\n+        }\n+    }\n+    \n+    private void cancelAriantSchedules() {\n+        cancelArenaUpdate();\n+        cancelArenaFinish();\n+        cancelAriantScoreBoard();\n+    }\n+    \n+    public int getAriantScore(MapleCharacter chr) {\n+        Integer chrScore = score.get(chr);\n+        return chrScore != null ? chrScore : 0;\n+    }\n+    \n+    public void clearAriantScore(MapleCharacter chr) {\n+        score.remove(chr);\n+    }\n+    \n+    public void updateAriantScore(MapleCharacter chr, int points) {\n+        if (map != null) {\n+            score.put(chr, points);\n+            scoreDirty = true;\n+        }\n+    }\n+    \n+    private void broadcastAriantScoreUpdate() {\n+        if (scoreDirty) {\n+            for (MapleCharacter chr : score.keySet()) {\n+                chr.announce(MaplePacketCreator.updateAriantPQRanking(score));\n+            }\n+            scoreDirty = false;\n+        }\n+    }\n+    \n+    public int getAriantRewardTier(MapleCharacter chr) {\n+        Integer reward = rewardTier.get(chr);\n+        return reward != null ? reward : 0;\n+    }\n+    \n+    public void clearAriantRewardTier(MapleCharacter chr) {\n+        rewardTier.remove(chr);\n+    }\n+    \n+    public void addLostShards(int quantity) {\n+        lostShards += quantity;\n+    }\n+    \n+    public void leaveArena(MapleCharacter chr) {\n+        if (!(eventClear && GameConstants.isAriantColiseumArena(chr.getMapId()))) {\n+            leaveArenaInternal(chr);\n+        }\n+    }\n+    \n+    private synchronized void leaveArenaInternal(MapleCharacter chr) {\n+        if (exped != null) {\n+            if (exped.removeMember(chr)) {\n+                int minSize = eventClear ? 1 : 2;\n+                if (exped.getActiveMembers().size() < minSize) {\n+                    dispose();\n+                }\n+                chr.setAriantColiseum(null);\n+                \n+                int shards = chr.countItem(4031868);\n+                chr.getClient().getAbstractPlayerInteraction().removeAll(4031868);\n+                chr.updateAriantScore(shards);\n+            }\n+        }\n+    }\n+    \n+    public void playerDisconnected(MapleCharacter chr) {\n+        leaveArenaInternal(chr);\n+    }\n+    \n+    private void showArenaResults() {\n+        eventClear = true;\n+        \n+        if (map != null) {\n+            map.broadcastMessage(MaplePacketCreator.showAriantScoreBoard());\n+            map.killAllMonsters();\n+            \n+            distributeAriantPoints();\n+        }\n+    }\n+    \n+    private static boolean isUnfairMatch(Integer winnerScore, Integer secondScore, Integer lostShardsScore, List<Integer> runnerupsScore) {\n+        if (winnerScore <= 0) {\n+            return false;\n+        }\n+        \n+        double runnerupsScoreCount = 0;\n+        for (Integer i : runnerupsScore) {\n+            runnerupsScoreCount += i;\n+        }\n+        \n+        runnerupsScoreCount += lostShardsScore;\n+        secondScore += lostShardsScore;\n+        \n+        double matchRes = runnerupsScoreCount / winnerScore;\n+        double runnerupRes = ((double) secondScore) / winnerScore;\n+        \n+        return matchRes < 0.81770726891980117713114871015349 && (runnerupsScoreCount < 7 || runnerupRes < 0.5929);\n+    }\n+    \n+    public void distributeAriantPoints() {\n+        Integer firstTop = -1, secondTop = -1;\n+        MapleCharacter winner = null;\n+        List<Integer> runnerups = new ArrayList<>();\n+        \n+        for (Entry<MapleCharacter, Integer> e : score.entrySet()) {\n+            Integer s = e.getValue();\n+            if (s > firstTop) {\n+                secondTop = firstTop;\n+                firstTop = s;\n+                winner = e.getKey();\n+            } else if (s > secondTop) {\n+                secondTop = s;\n+            }\n+            \n+            runnerups.add(s);\n+            rewardTier.put(e.getKey(), (int) Math.floor(s / 10));\n+        }\n+        \n+        runnerups.remove(firstTop);\n+        if (isUnfairMatch(firstTop, secondTop, map.getDroppedItemsCountById(4031868) + lostShards, runnerups)) {\n+            rewardTier.put(winner, 1);\n+        }\n+    }\n+    \n+    private MapleExpeditionType getExpeditionType() {\n+        MapleExpeditionType type;\n+        if (map.getId() == 980010101) {\n+            type = MapleExpeditionType.ARIANT;\n+        } else if (map.getId() == 980010201) {\n+            type = MapleExpeditionType.ARIANT1;\n+        } else {\n+            type = MapleExpeditionType.ARIANT2;\n+        }\n+        \n+        return type;\n+    }\n+    \n+    private void enterKingsRoom() {\n+        map.getChannelServer().removeExpedition(exped);\n+        cancelAriantSchedules();\n+        \n+        for (MapleCharacter chr : map.getAllPlayers()) {\n+            chr.changeMap(980010010, 0);\n+        }\n+    }\n+    \n+    private synchronized void dispose() {\n+        if (exped != null) {\n+            exped.dispose(false);\n+            \n+            for (MapleCharacter chr : exped.getActiveMembers()) {\n+                chr.setAriantColiseum(null);\n+                chr.changeMap(980010000, 0);\n+            }\n+            \n+            map.getWorldServer().registerTimedMapObject(new Runnable() {\n+                @Override\n+                public void run() {\n+                    score.clear();\n+                    exped = null;\n+                    map = null;\n+                }\n+            }, 5 * 60 * 1000);\n+        }\n+    }\n+}"}, {"sha": "5fde37b3a4250544ee3e2eafc3898c37547d8aa9", "filename": "src/server/partyquest/MonsterCarnival.java", "status": "modified", "additions": 40, "deletions": 14, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/partyquest/MonsterCarnival.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/server/partyquest/MonsterCarnival.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnival.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -1,5 +1,6 @@\n package server.partyquest;\n \n+import java.util.List;\n import java.util.concurrent.ScheduledFuture;\n import client.MapleCharacter;\n import constants.LanguageConstants;\n@@ -9,13 +10,15 @@\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n import server.TimerManager;\n+import server.life.MapleMonster;\n import server.maps.MapleMap;\n+import server.maps.MapleMapObject;\n+import server.maps.MapleReactor;\n import tools.MaplePacketCreator;\n \n /**\n  * @author Drago/Dragohe4rt\n  */\n-\n public class MonsterCarnival {\n \n     public static int D = 3;\n@@ -27,7 +30,7 @@\n     private MapleMap map;\n     private ScheduledFuture<?> timer, effectTimer, respawnTask;\n     private long startTime = 0;\n-    private int summonsR = 8, summonsB = 8, room = 0;\n+    private int summonsR = 0, summonsB = 0, room = 0;\n     private MapleCharacter leader1, leader2, Grupo1, Grupo2;\n     private int redCP, blueCP, redTotalCP, blueTotalCP, redTimeupCP, blueTimeupCP;\n     private boolean cpq1;\n@@ -94,13 +97,13 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                 public void run() {\n                     timeUp();\n                 }\n-            }, 10 * 60 * 1000);\n+            }, (map.getTimeDefault() - 10) * 1000);\n             effectTimer = TimerManager.getInstance().schedule(new Runnable() {\n                 @Override\n                 public void run() {\n                     complete();\n                 }\n-            }, 10 * 60 * 1000 - 10 * 1000);\n+            }, map.getTimeDefault() * 1000 - 10 * 1000);\n             respawnTask = TimerManager.getInstance().register(new Runnable() {\n                 @Override\n                 public void run() {\n@@ -160,20 +163,42 @@ protected void dispose() {\n         dispose(false);\n     }\n \n+    public boolean canSummonR() {\n+        return summonsR < map.getMaxMobs();\n+    }\n+    \n     public void summonR() {\n-        this.summonsR--;\n+        summonsR++;\n     }\n \n-    public boolean canSummonR() {\n-        return this.summonsR > 0;\n+    public boolean canSummonB() {\n+        return summonsB < map.getMaxMobs();\n     }\n-\n+    \n     public void summonB() {\n-        this.summonsB--;\n+        summonsB++;\n     }\n-\n-    public boolean canSummonB() {\n-        return this.summonsB > 0;\n+    \n+    public boolean canGuardianR() {\n+        int teamReactors = 0;\n+        for (MapleReactor react : map.getAllReactors()) {\n+            if (react.getName().substring(0, 1).contentEquals(\"0\")) {\n+                teamReactors += 1;\n+            }\n+        }\n+        \n+        return teamReactors < map.getMaxReactors();\n+    }\n+    \n+    public boolean canGuardianB() {\n+        int teamReactors = 0;\n+        for (MapleReactor react : map.getAllReactors()) {\n+            if (react.getName().substring(0, 1).contentEquals(\"1\")) {\n+                teamReactors += 1;\n+            }\n+        }\n+        \n+        return teamReactors < map.getMaxReactors();\n     }\n \n     protected void dispose(boolean warpout) {\n@@ -337,13 +362,14 @@ private void extendTime() {\n             public void run() {\n                 timeUp();\n             }\n-        }, 3 * 60 * 1000);\n+        }, map.getTimeExpand() * 1000);\n         effectTimer = TimerManager.getInstance().schedule(new Runnable() {\n             @Override\n             public void run() {\n                 complete();\n             }\n-        }, 3 * 60 * 1000 - 10 * 1000); // thanks Vcoc for noticing a time set issue here\n+\n+        }, map.getTimeExpand() * 1000 - 10 * 1000); // thanks Vcoc for noticing a time set issue here\n     }\n \n     public void complete() {"}, {"sha": "83cffa4be59e8e72b0f5273ec312306f901a5674", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 40, "deletions": 30, "changes": 70, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/7d0575aee40a571c1c9641ba0b16644a1f3a1f86/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=7d0575aee40a571c1c9641ba0b16644a1f3a1f86", "patch": "@@ -405,7 +405,7 @@ protected static void addItemInfo(final MaplePacketLittleEndianWriter mplew, Ite\n                         mplew.writeShort(pet.getCloseness());\n                         mplew.write(pet.getFullness());\n                         addExpirationTime(mplew, item.getExpiration());\n-                        mplew.writeInt(pet.getPetFlag());  /* pet flags found by -- Irenex & Spoon */\n+                        mplew.writeInt(pet.getPetFlag());  /* pet flags found by -- lrenex & Spoon */\n                         \n                         mplew.write(new byte[]{(byte) 0x50, (byte) 0x46}); //wonder what this is\n                         mplew.writeInt(0);\n@@ -2534,7 +2534,46 @@ private static int doubleToShortBits(double d) {\n                 mplew.writeInt(cid);\n                 return mplew.getPacket();\n         }\n+        \n+        public static byte[] catchMessage(int message) { // not done, I guess\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.BRIDLE_MOB_CATCH_FAIL.getValue());\n+                mplew.write(message); // 1 = too strong, 2 = Elemental Rock\n+                mplew.writeInt(0);//Maybe itemid?\n+                mplew.writeInt(0);\n+                return mplew.getPacket();\n+        }\n \n+        public static byte[] showAllCharacter(int chars, int unk) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(11);\n+                mplew.writeShort(SendOpcode.VIEW_ALL_CHAR.getValue());\n+                mplew.write(chars > 0 ? 1 : 5); // 2: already connected to server, 3 : unk error (view-all-characters), 5 : cannot find any\n+                mplew.writeInt(chars);\n+                mplew.writeInt(unk);\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] showAriantScoreBoard() {   // thanks lrenex for pointing match's end scoreboard packet\n+                MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.ARIANT_ARENA_SHOW_RESULT.getValue());\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] updateAriantPQRanking(final MapleCharacter chr, final int score) {\n+                return updateAriantPQRanking(new LinkedHashMap<MapleCharacter, Integer>(){{put(chr, score);}});\n+        }\n+        \n+        public static byte[] updateAriantPQRanking(Map<MapleCharacter, Integer> playerScore) {\n+                MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.ARIANT_ARENA_USER_SCORE.getValue());\n+                mplew.write(playerScore.size());\n+                for (Entry<MapleCharacter, Integer> e : playerScore.entrySet()) {\n+                        mplew.writeMapleAsciiString(e.getKey().getName());\n+                        mplew.writeInt(e.getValue());\n+                }\n+                return mplew.getPacket();\n+        }\n+        \n         public static byte[] silentRemoveItemFromMap(int oid) {\n                 return removeItemFromMap(oid, 1, 0);\n         }\n@@ -5015,35 +5054,6 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] updateAriantPQRanking(String name, int score, boolean empty) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n-                mplew.writeShort(SendOpcode.ARIANT_SCORE.getValue());\n-                mplew.write(empty ? 0 : 1);\n-                if (!empty) {\n-                        mplew.writeMapleAsciiString(name);\n-                        mplew.writeInt(score);\n-                }\n-                return mplew.getPacket();\n-        }\n-\n-        public static byte[] catchMessage(int message) { // not done, I guess\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n-                mplew.writeShort(SendOpcode.BRIDLE_MOB_CATCH_FAIL.getValue());\n-                mplew.write(message); // 1 = too strong, 2 = Elemental Rock\n-                mplew.writeInt(0);//Maybe itemid?\n-                mplew.writeInt(0);\n-                return mplew.getPacket();\n-        }\n-\n-        public static byte[] showAllCharacter(int chars, int unk) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(11);\n-                mplew.writeShort(SendOpcode.VIEW_ALL_CHAR.getValue());\n-                mplew.write(chars > 0 ? 1 : 5); // 2: already connected to server, 3 : unk error (view-all-characters), 5 : cannot find any\n-                mplew.writeInt(chars);\n-                mplew.writeInt(unk);\n-                return mplew.getPacket();\n-        }\n-\n         public static byte[] showAllCharacterInfo(int worldid, List<MapleCharacter> chars, boolean usePic) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.VIEW_ALL_CHAR.getValue());"}]}]},
