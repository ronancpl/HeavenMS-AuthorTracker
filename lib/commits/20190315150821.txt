{"fetchDate": "2019-12-19", "content": [{"sha": "3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6M2JkZjhjYjJiZTVmMGIyMzJjNTg2YWNiMmIzNDFkOGQ0ZWFmZWJhNQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-03-15T15:08:21Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-03-15T15:08:21Z"}, "message": "The great MCPQ Merge offensive\n\nFulfilled the lovely pull request #427 from @dragoso, which added in backing code content to HeavenMS.\nImplemented structural changes for the Marriage wishlist, in order to receive, maintain and distribute gifts to spouses.\nAdded untradeable check on wishlist gift handler.\nAdjusted CPQ drops to actually load from DB rathe than hard-coded.\nFixed CPQ \"random disease to player/party\" functionality not applying properly.\nAdjusted how CPQ maps are generated. It directly loads a new area from WZ (this process should at least removes the player's spawned mobs) rather than reset the cache at every MCPQ creation.", "tree": {"sha": "f294b7259c65f2d7ae004e7ae3024b013375242f", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/f294b7259c65f2d7ae004e7ae3024b013375242f"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "html_url": "https://github.com/ronancpl/HeavenMS/commit/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1383efd6c36a63b493645eff1e9c4b00443216f2", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/1383efd6c36a63b493645eff1e9c4b00443216f2", "html_url": "https://github.com/ronancpl/HeavenMS/commit/1383efd6c36a63b493645eff1e9c4b00443216f2"}], "stats": {"total": 2916, "additions": 2248, "deletions": 668}, "files": [{"sha": "8d9539354567c93d958a49b7d7f20100dda8f505", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1711,4 +1711,18 @@ Implementado mec\u00e2nica de pescaria no c\u00f3digo-fonte.\n \n 09 Mar\u00e7o 2019,\n Corrigido membros de party n\u00e3o recebendo bonus devidamente ap\u00f3s membros sairem do mapa/party em alguns casos.\n-Revisado sistema de experi\u00eancia em party. Ganhos de bonus agora levam em conta valores-base que membros de party ganham ao derrotar um mob para definir o ganho geral da equipe. Contabiliza\u00e7\u00e3o de ganhos remodelado, buscando por um modo de distribui\u00e7\u00e3o mais coerente.\n\\ No newline at end of file\n+Revisado sistema de experi\u00eancia em party. Ganhos de bonus agora levam em conta valores-base que membros de party ganham ao derrotar um mob para definir o ganho geral da equipe. Contabiliza\u00e7\u00e3o de ganhos remodelado, buscando por um modo de distribui\u00e7\u00e3o mais coerente.\n+\n+12 - 13 Mar\u00e7o 2019,\n+Iniciado opera\u00e7\u00e3o de introdu\u00e7\u00e3o da wishlist de casamento e MCPQ no fonte, a partir do pull request feito pelo Dragohe4rt.\n+Implementado estrutura back-end para comportar e manter (em DB) o wishlist de casamento.\n+Ajustado mec\u00e2nicas de wishlist iniciadas nos scripts do evento de casamento.\n+\n+14 Mar\u00e7o 2019,\n+Adicionado checagem por itens untradeable no handler de wishlist ao enviar itens.\n+Adicionado drops da CPQ na DB.\n+Corrigido diversas diseases da CPQ n\u00e3o funcionando corretamente ao pegar do ch\u00e3o item que aleatoriza disease no time/pessoa oponente.\n+Modificado gera\u00e7\u00e3o de mapas da CPQ, agora sempre carregando um novo mapa da WZ ao inv\u00e9s de sempre buscar e resetar o mapa carregado na cache.\n+\n+15 Mar\u00e7o 2019,\n+Adicionado SFX nos portais da CPQ.\n\\ No newline at end of file"}, {"sha": "7d811fac40227efa470c6b65a228a0ef98fea2ef", "filename": "scripts/event/WeddingCathedral.js", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/event/WeddingCathedral.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/event/WeddingCathedral.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/WeddingCathedral.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -77,7 +77,7 @@ function spawnCakeBoss(eim) {\n }\n \n function setup(level, lobbyid) {\n-        var eim = em.newInstance(\"Wedding\" + lobbyid);\n+        var eim = em.newMarriage(\"Wedding\" + lobbyid);\n         eim.setProperty(\"weddingId\", \"0\");\n         eim.setProperty(\"weddingStage\", \"0\");   // 0: gathering time, 1: wedding time, 2: ready to fulfill the wedding, 3: just married\n         eim.setProperty(\"guestBlessings\", \"0\");\n@@ -86,6 +86,9 @@ function setup(level, lobbyid) {\n         eim.setProperty(\"groomId\", \"0\");\n         eim.setProperty(\"brideId\", \"0\");\n         eim.setProperty(\"confirmedVows\", \"-1\");\n+        eim.setProperty(\"groomWishlist\", \"\");\n+        eim.setProperty(\"brideWishlist\", \"\");\n+        eim.initializeGiftItems();\n         \n         eim.getInstanceMap(680000400).resetPQ(level);\n         if(eventBoss) spawnCakeBoss(eim);\n@@ -105,9 +108,11 @@ function respawnStages(eim) {\n }\n \n function playerEntry(eim, player) {\n-        var map = eim.getMapInstance(entryMap);\n-        \n+        eim.setProperty(\"giftedItemG\" + player.getId(), \"0\");\n+        eim.setProperty(\"giftedItemB\" + player.getId(), \"0\");\n         player.getClient().getAbstractPlayerInteraction().gainItem(4000313, 1);\n+        \n+        var map = eim.getMapInstance(entryMap);\n         player.changeMap(map, map.getPortal(0));\n }\n "}, {"sha": "259e790c3278d4168b299951dc980cba69256402", "filename": "scripts/event/WeddingChapel.js", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/event/WeddingChapel.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/event/WeddingChapel.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/WeddingChapel.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -77,7 +77,7 @@ function spawnCakeBoss(eim) {\n }\n \n function setup(level, lobbyid) {\n-        var eim = em.newInstance(\"Wedding\" + lobbyid);\n+        var eim = em.newMarriage(\"Wedding\" + lobbyid);\n         eim.setProperty(\"weddingId\", \"0\");\n         eim.setProperty(\"weddingStage\", \"0\");   // 0: gathering time, 1: wedding time, 2: ready to fulfill the wedding, 3: just married\n         eim.setProperty(\"guestBlessings\", \"0\");\n@@ -86,6 +86,9 @@ function setup(level, lobbyid) {\n         eim.setProperty(\"groomId\", \"0\");\n         eim.setProperty(\"brideId\", \"0\");\n         eim.setProperty(\"confirmedVows\", \"-1\");\n+        eim.setProperty(\"groomWishlist\", \"\");\n+        eim.setProperty(\"brideWishlist\", \"\");\n+        eim.initializeGiftItems();\n         \n         eim.getInstanceMap(680000400).resetPQ(level);\n         if(eventBoss) spawnCakeBoss(eim);\n@@ -105,9 +108,11 @@ function respawnStages(eim) {\n }\n \n function playerEntry(eim, player) {\n-        var map = eim.getMapInstance(entryMap);\n-        \n+        eim.setProperty(\"giftedItemG\" + player.getId(), \"0\");\n+        eim.setProperty(\"giftedItemB\" + player.getId(), \"0\");\n         player.getClient().getAbstractPlayerInteraction().gainItem(4000313, 1);\n+        \n+        var map = eim.getMapInstance(entryMap);\n         player.changeMap(map, map.getPortal(0));\n }\n "}, {"sha": "bc837166a24252a96e17cd1e895ff7397204ea7a", "filename": "scripts/npc/2042000.js", "status": "modified", "additions": 532, "deletions": 49, "changes": 581, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,8 +1,23 @@\n-var map = 980000000;\n-var minLvl = 0;\n-var maxLvl = 255;\n-var minAmt = 0;\n-var maxAmt = 6;\n+\n+var status = 0;\n+var rnk = -1;\n+var n1 = 50; //???\n+var n2 = 40; //??? ???\n+var n3 = 7; //35\n+var n4 = 10; //40\n+var n5 = 20; //50\n+\n+var cpqMap = 980000000;\n+var cpqMinLvl = 0;\n+var cpqMaxLvl = 255;\n+var cpqMinAmt = 0;\n+var cpqMaxAmt = 6;\n+\n+// Ronan's custom ore refiner NPC\n+var refineRocks = true;     // enables moon rock, star rock\n+var refineCrystals = true;  // enables common crystals\n+var refineSpecials = true;  // enables lithium, special crystals\n+var feeMultiplier = 7.0;\n \n function start() {\n     status = -1;\n@@ -13,72 +28,540 @@ function action(mode, type, selection) {\n     if (mode == -1) {\n         cm.dispose();\n     } else {\n-        if (mode == 0 && status == 0) {\n+        if (status >= 0 && mode == 0) {\n             cm.dispose();\n             return;\n         }\n         if (mode == 1)\n             status++;\n         else\n             status--;\n-        if (status == 0) {\n-            if (cm.getParty() == null) {\n-                status = 10;\n-                cm.sendOk(\"#e\ufffd necess\ufffdrio criar um grupo antes de come\ufffdar o Festival de Monstros!#k\");\n-            } else if (!cm.isLeader()) {\n-                status = 10;\n-                cm.sendOk(\"Se voc\ufffd quer come\ufffdar o Festival, avise o #bl\ufffdder do grupo#k para falar comigo.\");\n-            } else {\n-                var party = cm.getParty().getMembers();\n-                var inMap = cm.partyMembersInMap();\n-                var lvlOk = 0;\n-                var isInMap = 0;\n-                for (var i = 0; i < party.size(); i++) {\n-                    if (party.get(i).getLevel() >= minLvl && party.get(i).getLevel() <= maxLvl) {\n-                        lvlOk++;\n+        \n+        if (cm.getPlayer().getMapId() == 980000010) {\n+            if (status == 0) {\n+                cm.sendNext(\"Eu espero que voc\ufffd tenha divertido na Folia dos Monstros!\");\n+            } else if (status > 0) {\n+                cm.warp(980000000, 0);\n+                cm.dispose();\n+            }\n+        } else if (cm.getChar().getMap().isCPQLoserMap()) {\n+            if (status == 0) {\n+                if (cm.getChar().getParty() != null) {\n+                    var shiu = \"\";\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n+                        shiu += \"#rA#k\";\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        rnk = 10;\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                        shiu += \"#rB#k\";\n+                        rnk = 20;\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n+                        shiu += \"#rC#k\";\n+                        rnk = 30;\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                    } else {\n+                        shiu += \"#rD#k\";\n+                        rnk = 40;\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                     }\n-                    if (party.get(i).getPlayer().getMapId() != 980000000) {\n-                        //isInMap = false;\n-                        isInMap++\n+                } else {\n+                    cm.warp(980000000, 0);\n+                    cm.dispose();\n+                }\n+            } else if (status == 1) {\n+                switch (rnk) {\n+                    case 10:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(17500);\n+                        cm.dispose();\n+                        break;\n+                    case 20:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(1200);\n+                        cm.dispose();\n+                        break;\n+                    case 30:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(5000);\n+                        cm.dispose();\n+                        break;\n+                    case 40:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(2500);\n+                        cm.dispose();\n+                        break;\n+                    default:\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        break;\n+                }\n+            }\n+        } else if (cm.getChar().getMap().isCPQWinnerMap()) {\n+            if (status == 0) {\n+                if (cm.getChar().getParty() != null) {\n+                    var shi = \"\";\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n+                        shi += \"#rA#k\";\n+                        rnk = 1;\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                        shi += \"#rB#k\";\n+                        rnk = 2;\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n+                        shi += \"#rC#k\";\n+                        rnk = 3;\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else {\n+                        shi += \"#rD#k\";\n+                        rnk = 4;\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n                     }\n+                } else {\n+                    cm.warp(980000000, 0);\n+                    cm.dispose();\n                 }\n-\n-                if (party >= 1) {\n-                    status = 10;\n-                    cm.sendOk(\"Voc\ufffd n\ufffdo tem n\ufffdmero suficiente de pessoas em seu grupo. Voc\ufffd precisa de um grupo com #b\" + minAmt + \"#k - #r\" + maxAmt + \"#k membros e eles devem estar no mapa com voc\ufffd.\");\n-                } else if (lvlOk != inMap) {\n+            } else if (status == 1) {\n+                switch (rnk) {\n+                    case 1:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(50000);\n+                        cm.dispose();\n+                        break;\n+                    case 2:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(25500);\n+                        cm.dispose();\n+                        break;\n+                    case 3:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(21000);\n+                        cm.dispose();\n+                        break;\n+                    case 4:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(19505);\n+                        cm.dispose();\n+                        break;\n+                    default:\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        break;\n+                }\n+            }\n+        } else if (cm.getMapId() == cpqMap) {   // only CPQ1\n+            if (status == 0) {\n+                if (cm.getParty() == null) {\n                     status = 10;\n-                    cm.sendOk(\"Certifique se todos em seu grupo est\ufffdo dentre os n\ufffdveis corretos (\" + minLvl + \"~\" + maxLvl + \")!\");\n-                } else if (isInMap > 0) {\n+                    cm.sendOk(\"#e\u00c9 necess\u00e1rio criar um grupo antes de come\u00e7ar o Festival de Monstros!#k\");\n+                } else if (!cm.isLeader()) {\n                     status = 10;\n-                    cm.sendOk(\"Existe algu\ufffdm do grupo que n\ufffdo esta no mapa!\");\n+                    cm.sendOk(\"Se voc\u00ea quer come\u00e7ar o Festival, avise o #bl\u00edder do grupo#k para falar comigo.\");\n+                } else {\n+                    var party = cm.getParty().getMembers();\n+                    var inMap = cm.partyMembersInMap();\n+                    var lvlOk = 0;\n+                    var isOutMap = 0;\n+                    for (var i = 0; i < party.size(); i++) {\n+                        if (party.get(i).getLevel() >= cpqMinLvl && party.get(i).getLevel() <= cpqMaxLvl) {\n+                            lvlOk++;\n+\n+                            if (party.get(i).getPlayer().getMapId() != cpqMap) {\n+                                isOutMap++;\n+                            }\n+                        }\n+                    }\n+\n+                    if (party >= 1) {\n+                        status = 10;\n+                        cm.sendOk(\"Voc\u00ea n\u00e3o tem n\u00famero suficiente de pessoas em seu grupo. Voc\u00ea precisa de um grupo com #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k membros e eles devem estar no mapa com voc\u00ea.\");\n+                    } else if (lvlOk != inMap) {\n+                        status = 10;\n+                        cm.sendOk(\"Certifique se todos em seu grupo est\u00e3o dentre os n\u00edveis corretos (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                    } else if (isOutMap > 0) {\n+                        status = 10;\n+                        cm.sendOk(\"Existe algu\u00e9m do grupo que n\u00e3o esta no mapa!\");\n+                    } else {\n+                        cm.sendCPQMapLists();\n+                    }\n+                }\n+            } else if (status == 1) {\n+                if (cm.fieldTaken(selection)) {\n+                    if (cm.fieldLobbied(selection)) {\n+                        cm.challengeParty(selection);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"A sala esta cheia.\");\n+                        cm.dispose();\n+                    }\n                 } else {\n-                    cm.sendCPQMapLists();\n+                    var party = cm.getParty().getMembers();\n+                    if ((selection >= 0 && selection <= 3) && party.size() < 1) {\n+                        cm.sendOk(\"Voc\u00ea precisa de no m\u00ednimo 2 player para entrar na competi\u00e7\u00e3o.\");\n+                    } else if ((selection >= 4 && selection <= 5) && party.size() < 1) {\n+                        cm.sendOk(\"Voc\u00ea precisa de no m\u00ednimo 3 player para entrar na competi\u00e7\u00e3o.\");\n+                    } else {\n+                        cm.cpqLobby(selection);\n+                    }\n+                    cm.dispose();\n                 }\n+            } else if (status == 11) {\n+                cm.dispose();\n             }\n-        } else if (status == 1) {\n-            \n-            if (cm.fieldTaken(selection)) {\n-                if (cm.fieldLobbied(selection)) {\n-                    cm.challengeParty(selection);\n+        } else {\n+            if (status == 0) {\n+                var talk = \"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L3# Ir para o campo da Folia de Monstros 2.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\";\n+                if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                    talk += \"\\r\\n#L4# ... Can I just refine my ores?#l\";\n+                }\n+                cm.sendSimple(talk);\n+            } else if (status == 1) {\n+                if (selection == 0) {\n+                    if ((cm.getLevel() > 29 && cm.getLevel() < 51) || cm.getPlayer().isGM()) {\n+                        cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        return;\n+                    } else if (cm.getLevel() < 30) {\n+                        cm.sendOk(\"Voc\ufffd precisa ser no m\ufffdnimo n\ufffdvel 30 para participar da Folia de Monstros. Fale comigo quando for forte o bastante.\");\n+                        cm.dispose();\n+                        return;\n+                    } else {\n+                        cm.sendOk(\"Sinto muito, mas apenas os jogadores de n\ufffdvel 30~50 podem participar da Folia de Monstros.\");\n+                        cm.dispose();\n+                        return;\n+                    }\n+                } else if (selection == 1) {\n+                    status = 60;\n+                    cm.sendSimple(\"O que gostaria de fazer?\\r\\n#b#L0# O que \ufffd a Folia de Monstros?#l\\r\\n#L1# Vis\ufffdo geral sobre a Folia de Monstros#l\\r\\n#L2# Informa\ufffd\ufffdes detalhadas sobre a Folia de Monstros#l\\r\\n#L3# Nada, de verdade. Mudei de ideia.#l\");\n+                } else if (selection == 2) {\n+                    cm.sendSimple(\"Lembre-se se voc\ufffd possui #t4001129#, voc\ufffd pode troc\ufffd-las por itens. Tenha certeza que voc\ufffd possui #t4001129# suficientes para o item que voc\ufffd deseja. Selecione o item que voc\ufffd gostaria de troc\ufffd-las! \\r\\n#b#L0# #t1122007#(\" + n1 + \" moedas)#l\\r\\n#L1# #t2041211#(\" + n2 + \" moedas)#l\\r\\n#L2# Armas para Guerreiros#l\\r\\n#L3# Armas para Bruxos#l\\r\\n#L4# Armas para Arqueiros#l\\r\\n#L5# Armas para Gatunos#l\");\n+                } else if (selection == 3) {\n+                    cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n+                    cm.warp(980030000, 0);\n                     cm.dispose();\n+                    return;\n+                } else if (selection == 4) {\n+                    var selStr = \"Very well, instead I offer a steadfast #bore refining#k service for you, taxing #r\" + ((feeMultiplier * 100) | 0) + \"%#k over the usual fee to synthetize them. What will you do?#b\";\n+\n+                    var options = new Array(\"Refine mineral ores\",\"Refine jewel ores\");\n+                    if(refineCrystals) {\n+                        options.push(\"Refine crystal ores\");\n+                    }\n+                    if(refineRocks) {\n+                        options.push(\"Refine plates/jewels\");\n+                    }\n+\n+                    for (var i = 0; i < options.length; i++){\n+                        selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n+                    }\n+\n+                    cm.sendSimple(selStr);\n+                    \n+                    status = 76;\n+                }\n+            } else if (status == 2) {\n+                select = selection;\n+                if (select == 0) {\n+                    if (cm.haveItem(4001129, n1) && cm.canHold(4001129)) {\n+                        cm.gainItem(1122007, 1);\n+                        cm.gainItem(4001129, -n1);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Equipamentos est\ufffd cheio.\");\n+                        cm.dispose();\n+                    }\n+                } else if (select == 1) {\n+                    if (cm.haveItem(4001129, n2) && cm.canHold(2041211)) {\n+                        cm.gainItem(2041211, 1);\n+                        cm.gainItem(4001129, -n2);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Uso est\ufffd cheio.\");\n+                        cm.dispose();\n+                    }\n+                } else if (select == 2) {//S2 Warrior 26 S3 Magician 6 S4 Bowman 6 S5 Thief 8\n+                    status = 10;\n+                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                } else if (select == 3) {\n+                    status = 20;\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1372001#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1382018#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1372012#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1382019#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1382001#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1372007#(\" + n5 + \" moedas)#l\");\n+                } else if (select == 4) {\n+                    status = 30;\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1452006#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1452007#(\" + n4 + \" moedas)#l\\r\\n#L2# #z1452008#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1462005#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1462006#(\" + n4 + \" moedas)#l\\r\\n#L5# #z1462007#(\" + n5 + \" moedas)#l\");\n+                } else if (select == 5) {\n+                    status = 40;\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar por. As armas que eu tenho s\ufffdo da maior qualidade. Seleciona a mais atraente para voc\ufffd! \\r\\n#b#L0# #z1472013#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1472017#(\" + n4 + \"moedas)#l\\r\\n#L2# #z1472021#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1332014#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1332031#(\" + n4 + \"moedas)#l\\r\\n#L5# #z1332011#(\" + n4 + \"moedas)#l\\r\\n#L6# #z1332016#(\" + n5 + \" moedas)#l\\r\\n#L7# #z1332003#(\" + n5 + \" moedas)#l\");\n+                }\n+            } else if (status == 11) {\n+                if (selection == 12) {\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente \ufffdteis. D\ufffd uma olhada! \\r\\n#b#L0# #z1322015#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1422008#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1322016#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1422007#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1322017#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1422005#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1432003#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1442003#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1432005#(\" + n4 + \"moedas)#l\\r\\n#L9# #z1442009#(\" + n4 + \"moedas)#l\\r\\n#L10# #z1442005#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1432004#(\" + n5 + \" moedas)#l\\r\\n#L12# Voltar para a p\ufffdgina inicial(2/2)#l\");\n                 } else {\n-                    cm.sendOk(\"A sala esta cheia.\");\n+                    var item = new Array(1302004, 1402006, 1302009, 1402007, 1302010, 1402003, 1312006, 1412004, 1312007, 1412005, 1312008, 1412003);\n+                    var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5);\n+                    if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                        cm.gainItem(item[selection], 1);\n+                        cm.gainItem(4001129, -cost[selection]);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.dispose();\n+                    }\n+                }\n+            } else if (status == 12) {\n+                if (selection == 12) {\n+                    status = 10;\n+                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                } else {\n+                    var item = new Array(1322015, 1422008, 1322016, 1422007, 1322017, 1422005, 1432003, 1442003, 1432005, 1442009, 1442005, 1432004);\n+                    var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5, n5);\n+                    if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                        cm.gainItem(item[selection], 1);\n+                        cm.gainItem(4001129, -cost[selection]);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.dispose();\n+                    }\n+                }\n+            } else if (status == 21) {\n+                var item = new Array(1372001, 1382018, 1372012, 1382019, 1382001, 1372007);\n+                var cost = new Array(n3, n3, n4, n4, n5, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                     cm.dispose();\n                 }\n-            } else {\n-                var party = cm.getParty().getMembers();\n-                if ((selection === 0 || selection === 1 || selection === 2 || selection === 3) && party.size() < 2) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 2 player para entrar na competi\ufffd\ufffdo.\");\n-                } else if ((selection === 4 || selection === 5) && party.size() < 3) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 3 player para entrar na competi\ufffd\ufffdo.\");\n+            } else if (status == 31) {\n+                var item = new Array(1452006, 1452007, 1452008, 1462005, 1462006, 1462007);\n+                var cost = new Array(n3, n4, n5, n3, n4, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 41) {\n+                var item = new Array(1472013, 1472017, 1472021, 1332014, 1332031, 1332011, 1332016, 1332003);\n+                var cost = new Array(n3, n4, n5, n3, n4, n4, n5, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n                 } else {\n-                    cm.cpqLobby(selection);\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 61) {\n+                select = selection;\n+                if (selection == 0) {\n+                    cm.sendNext(\"Haha! Eu sou Spiegelmann, o l\ufffdder dessa Folia. Eu comecei a primeira #bFolia de Monstros#k aqui, aguardando por viajantes como voc\ufffd para participar dessa extravaganza!\");\n+                } else if (selection == 1) {\n+                    cm.sendNext(\"#bFolia de Monstros#k consiste em 2 grupos entrando no campo de batalha, e ca\ufffdando os monstros invocados pelo outro grupo. \ufffd uma #bmiss\ufffdo de combate que determina o vitorioso pela quantia de Pontos de Folia (CP) recebidos#k.\");\n+                } else if (selection == 2) {\n+                    cm.sendNext(\"Quando entrar no Campo da Folia, voc\ufffd ver\ufffd a janela da Folia de Monstros aparecer. Tudo que precisa fazer \ufffd #bselecionar o que voc\ufffde quer usar, e pressionar OK#k. Muito f\ufffdcil, n\ufffd?\");\n+                } else {\n+                    cm.dispose();\n+                }\n+            } else if (status == 62) {\n+                if (select == 0) {\n+                    cm.sendNext(\"O que \ufffd a #bFolia de Monstros#k? Hahaha! Vamos dizer que \ufffd uma experi\ufffdncia que jamais esquecer\ufffd! \ufffd uma #bbatalha contra outros viajantes assim como voc\ufffd!#k\");\n+                } else if (select == 1) {\n+                    cm.sendNext(\"Quando entrar no Campo da Folia, sua tarefa \ufffd #breceber CP ca\ufffdando os monstros do grupo oposto, e usar estes CP's para distrair o grupo oposto de ca\ufffdar monstros.#k.\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"Assim que se acostumar com os comandos, tente usar #bas teclas TAB e F1 ~ F12#k. #bTAB alterna entre Invoca\ufffd\ufffdo de Monstros/Habilidades/Protetor,#k e, #bF1~ F12 possibilita-o de acessar uma das janelas diretamente#k.\");\n+                }\n+            } else if (status == 63) {\n+                if (select == 0) {\n+                    cm.sendNext(\"Eu sei que \ufffd muito perigoso para voc\ufffds lutarem uns com os outros usando armas de verdade; e eu n\ufffdo sugeriria um ato t\ufffdo barb\ufffdrico. N\ufffdo meu amigo, o que eu ofere\ufffdo \ufffd competi\ufffd\ufffdo. A emo\ufffd\ufffdo da batalha e a emo\ufffd\ufffdo de competir contra pessoas t\ufffdo fortes e motivadas. Eu ofere\ufffdo a premissa de que seu grupo e o grupo oposto ambos #binvoquem os monstros, e derrote os monstros invocados pelo grupo advers\ufffdrio. Essa \ufffd a ess\ufffdncia da Folia de Monstros. Al\ufffdm disso, voc\ufffd pode usar Maple Coins ganhos durante a Folia de Monstros para obter novos itens e armas! #k\");\n+                } else if (select == 1) {\n+                    cm.sendNext(\"Existem 3 maneiras de distrair o grupo advers\ufffdrio: #bInvodar um monstro, Habilidade, and Protetor#k. Vou dar-lhe um olhar mais aprofundado, se voc\ufffd quiser saber mais sobre 'Instru\ufffd\ufffdes detalhadas'.\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bInvocar um Monstro#k chama um monstro que ataca o grupo advers\ufffdrio, sob seu controle. Use CP para trazer um Monstro Invocado, e ele ir\ufffd aparecer na mesma \ufffdrea, atacando o grupo oposto.\");\n+                }\n+            } else if (status == 64) {\n+                if (select == 0) {\n+                    cm.sendNext(\"Claro, n\ufffdo \ufffd t\ufffdo simples assim. Existem outras maneiras de prevenir o outro grupo de ca\ufffdar monstros, e cabe a voc\ufffd descobrir como faz\ufffd-lo. O que acha? Interessado em uma competi\ufffd\ufffdo amig\ufffdvel?\");\n+                    cm.dispose();\n+                } else if (select == 1) {\n+                    cm.sendNext(\"Por favor lembre-se. Nunca \ufffd uma boa ideia guardar seus CP's. #bOs CP's que voc\ufffd usou ir\ufffdo ajudar a determinar o vencedor e o perdedor da Folia.\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bHabilidade#k \ufffd uma op\ufffd\ufffdo de usar habilidades tais como Escurid\ufffdo, Fraqueza, e outras para prevenir o grupo oposto de matar outros monstros. S\ufffdo necess\ufffdrios muitos CP's, mas vale muito a pena. O \ufffdnico problema \ufffd que eles n\ufffdo duram muito. Use essa t\ufffdtica com sabedoria!\");\n+                }\n+            } else if (status == 65) {\n+                if (select == 1) {\n+                    cm.sendNext(\"Oh, e n\ufffdo se preocupe em tranformar-se em um fantasma. Na Folia de Monstros, #bvoc\ufffd n\ufffdo perder\ufffd EXP ap\ufffds a morte#k. \ufffd realmente uma exper\ufffdncia como nenhuma outra!\");\n+                    cm.dispose();\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bProtetor#k \ufffd basicamente um item invocado que aumenta dr\ufffdsticamente as habilidades dos monstros invocados pelo seu grupo. Protetor funciona enquanto n\ufffdo for demolido pelo grupo oposto, ent\ufffdo eu surigo que voc\ufffd invoque v\ufffdrios monstros primeiro, e ent\ufffdo traga o Protetor.\");\n+                }\n+            } else if (status == 66) {\n+                cm.sendNext(\"Por \ufffdltimo, enquanto estiver na Folia de Monstros, #bvoc\ufffd n\ufffdo pode usar items/po\ufffd\ufffdes de recupera\ufffd\ufffdo que voc\ufffd leva por ai contigo.#k Entretanto, os monstros deixam esses items cair de vez em quando, e #bassim que peg\ufffd-los, o item ativar\ufffd imediatamente#k. \ufffd por isso que \ufffd importante saber quando pegar estes items.\");\n+                cm.dispose();\n+            } else if (status == 77) {\n+                var allDone;\n+\n+                if (selection == 0) {\n+                    allDone = refineItems(0); // minerals\n+                } else if (selection == 1) {\n+                    allDone = refineItems(1); // jewels\n+                } else if (selection == 2 && refineCrystals) {\n+                    allDone = refineItems(2); // crystals\n+                } else if (selection == 2 && !refineCrystals || selection == 3) {\n+                    allDone = refineRockItems(); // moon/star rock\n+                }\n+\n+                if(allDone) {\n+                    cm.sendOk(\"Done. Thanks for showing up~.\");\n+                } else {\n+                    cm.sendOk(\"Done. Be aware some of the items #rcould not be synthetized#k because either you have a lack of space on your ETC inventory or there's not enough mesos to cover the fee.\");\n                 }\n                 cm.dispose();\n             }\n-        } else if (status == 11) {\n-            cm.dispose();\n         }\n     }\n-}\n\\ No newline at end of file\n+}\n+\n+function getRefineFee(fee) {\n+    return ((feeMultiplier * fee) | 0);\n+}\n+\n+function isRefineTarget(refineType, refineItemid) {\n+    if(refineType == 0) { //mineral refine\n+        return refineItemid >= 4010000 && refineItemid <= 4010007 && !(refineItemid == 4010007 && !refineSpecials);\n+    } else if(refineType == 1) { //jewel refine\n+        return refineItemid >= 4020000 && refineItemid <= 4020008 && !(refineItemid == 4020008 && !refineSpecials);\n+    } else if(refineType == 2) { //crystal refine\n+        return refineItemid >= 4004000 && refineItemid <= 4004004 && !(refineItemid == 4004004 && !refineSpecials);\n+    }\n+    \n+    return false;\n+}\n+\n+function getRockRefineTarget(refineItemid) {\n+    if(refineItemid >= 4011000 && refineItemid <= 4011006) {\n+        return 0;\n+    } else if(refineItemid >= 4021000 && refineItemid <= 4021008) {\n+        return 1;\n+    }\n+    \n+    return -1;\n+}\n+\n+function refineItems(refineType) {\n+    var allDone = true;\n+    \n+    var refineFees = [[300,300,300,500,500,500,800,270],[500,500,500,500,500,500,500,1000,3000],[5000,5000,5000,5000,1000000]];\n+    var itemCount = {};\n+    \n+    var iter = cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).iterator();\n+    while (iter.hasNext()) {\n+        var it = iter.next();\n+        var itemid = it.getItemId();\n+\n+        if(isRefineTarget(refineType, itemid)) {\n+            var ic = itemCount[itemid];\n+            \n+            if(ic != undefined) {\n+                itemCount[itemid] += it.getQuantity();\n+            } else {\n+                itemCount[itemid] = it.getQuantity();\n+            }\n+        }\n+    }\n+    \n+    for(var key in itemCount) {\n+        var itemqty = itemCount[key];\n+        var itemid = parseInt(key);\n+        \n+        var refineQty = ((itemqty / 10) | 0);\n+        if(refineQty <= 0) continue;\n+        \n+        while(true) {\n+            itemqty = refineQty * 10;\n+        \n+            var fee = getRefineFee(refineFees[refineType][(itemid % 100) | 0] * refineQty);\n+            if(cm.canHold(itemid + 1000, refineQty, itemid, itemqty) && cm.getMeso() >= fee) {\n+                cm.gainMeso(-fee);\n+                cm.gainItem(itemid, -itemqty);\n+                cm.gainItem(itemid + (itemid != 4010007 ? 1000 : 1001), refineQty);\n+                \n+                break;\n+            } else if(refineQty <= 1) {\n+                allDone = false;\n+                break;\n+            } else {\n+                refineQty--;\n+            }\n+        }\n+    }\n+    \n+    return allDone;\n+}\n+\n+function refineRockItems() {\n+    var allDone = true;\n+    var minItems = [[0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0]];\n+    var minRocks = [2147483647, 2147483647];\n+    \n+    var rockItems = [4011007, 4021009];\n+    var rockFees = [10000, 15000];\n+\n+    var iter = cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).iterator();\n+    while (iter.hasNext()) {\n+        var it = iter.next();\n+        var itemid = it.getItemId();\n+        var rockRefine = getRockRefineTarget(itemid);\n+        if(rockRefine >= 0) {\n+            var rockItem = ((itemid % 100) | 0);\n+            var itemqty = it.getQuantity();\n+            \n+            minItems[rockRefine][rockItem] += itemqty;\n+        }\n+    }\n+    \n+    for(var i = 0; i < minRocks.length; i++) {\n+        for(var j = 0; j < minItems[i].length; j++) {\n+            if(minRocks[i] > minItems[i][j]) {\n+                minRocks[i] = minItems[i][j];\n+            }\n+        }\n+        if(minRocks[i] <= 0 || minRocks[i] == 2147483647) continue;\n+        \n+        var refineQty = minRocks[i];\n+        while(true) {\n+            var fee = getRefineFee(rockFees[i] * refineQty);\n+            if(cm.canHold(rockItems[i], refineQty) && cm.getMeso() >= fee) {\n+                cm.gainMeso(-fee);\n+\n+                var j;\n+                if(i == 0) {\n+                    for(j = 4011000; j < 4011007; j++) {\n+                        cm.gainItem(j, -refineQty);\n+                    }\n+                    cm.gainItem(j, refineQty);\n+                } else {\n+                    for(j = 4021000; j < 4021009; j++) {\n+                        cm.gainItem(j, -refineQty);\n+                    }\n+                    cm.gainItem(j, refineQty);\n+                }\n+                \n+                break;\n+            } else if(refineQty <= 1) {\n+                allDone = false;\n+                break;\n+            } else {\n+                refineQty--;\n+            }\n+        }\n+    }\n+    \n+    return allDone;\n+}"}, {"sha": "914181d11db7582624ef789bbceb0c1d58c30edf", "filename": "scripts/npc/2042002.js", "status": "modified", "additions": 232, "deletions": 50, "changes": 282, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042002.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,4 +1,3 @@\n-importPackage(Packages.server.maps);\n \n var status = 0;\n var rnk = -1;\n@@ -8,6 +7,12 @@ var n3 = 7; //35\n var n4 = 10; //40\n var n5 = 20; //50\n \n+// Ronan's custom ore refiner NPC\n+var refineRocks = true;     // enables moon rock, star rock\n+var refineCrystals = true;  // enables common crystals\n+var refineSpecials = true;  // enables lithium, special crystals\n+var feeMultiplier = 7.0;\n+\n function start() {\n     status = -1;\n     action(1, 0, 0);\n@@ -25,9 +30,10 @@ function action(mode, type, selection) {\n             status++;\n         else\n             status--;\n+        \n         if (cm.getPlayer().getMapId() == 980000010) {\n             if (status == 0) {\n-                cm.sendNext(\"Eu espero que voc\ufffd tinha divertido na Folia dos Monstros!\");\n+                cm.sendNext(\"Eu espero que voc\ufffd tenha divertido na Folia dos Monstros!\");\n             } else if (status > 0) {\n                 cm.warp(980000000, 0);\n                 cm.dispose();\n@@ -36,22 +42,22 @@ function action(mode, type, selection) {\n             if (status == 0) {\n                 if (cm.getChar().getParty() != null) {\n                     var shiu = \"\";\n-                    if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shiu += \"#rA#k\";\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                         rnk = 10;\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 50 && cm.getPlayer().getFestivalPoints() < 100) {\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shiu += \"#rB#k\";\n                         rnk = 20;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 30 && cm.getPlayer().getFestivalPoints() < 50) {\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shiu += \"#rC#k\";\n                         rnk = 30;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                     } else {\n                         shiu += \"#rD#k\";\n                         rnk = 40;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -92,19 +98,19 @@ function action(mode, type, selection) {\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shi += \"#rA#k\";\n                         rnk = 1;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 100 && cm.getPlayer().getFestivalPoints() < 300) {\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shi += \"#rB#k\";\n                         rnk = 2;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 50 && cm.getPlayer().getFestivalPoints() < 100) {\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shi += \"#rC#k\";\n                         rnk = 3;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n                     } else {\n                         shi += \"#rD#k\";\n                         rnk = 4;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -140,8 +146,11 @@ function action(mode, type, selection) {\n             }\n         } else {\n             if (status == 0) {\n-               // cm.sendSimple(\"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\");\n-                cm.sendSimple(\"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L3# Ir para o campo da Folia de Monstros 2.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\");\n+                var talk = \"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L3# Ir para o campo da Folia de Monstros 2.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\";\n+                if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                    talk += \"\\r\\n#L4# ... Can I just refine my ores?#l\";\n+                }\n+                cm.sendSimple(talk);\n             } else if (status == 1) {\n                 if (selection == 0) {\n                     if ((cm.getLevel() > 29 && cm.getLevel() < 51) || cm.getPlayer().isGM()) {\n@@ -150,26 +159,43 @@ function action(mode, type, selection) {\n                         cm.dispose();\n                         return;\n                     } else if (cm.getLevel() < 30) {\n-                        cm.sendOk(\"Voc\ufffd precisa ser no m\ufffdnimo n\ufffdvel 30 para participar da Folia de Monstros. Fale comigo quando for forte o bastante.\");\n+                        cm.sendOk(\"Voc\ufffd precisa ser no m\ufffdnimo n\ufffdvel 30 para participar da Folia de Monstros. Fale comigo quando for forte o bastante.\");\n                         cm.dispose();\n                         return;\n                     } else {\n-                        cm.sendOk(\"Sinto muito, mas apenas os jogadores de n\ufffdvel 30~50 podem participar da Folia de Monstros.\");\n+                        cm.sendOk(\"Sinto muito, mas apenas os jogadores de n\ufffdvel 30~50 podem participar da Folia de Monstros.\");\n                         cm.dispose();\n                         return;\n                     }\n                 } else if (selection == 1) {\n                     status = 60;\n-                    cm.sendSimple(\"O que gostaria de fazer?\\r\\n#b#L0# O que \ufffd a Folia de Monstros?#l\\r\\n#L1# Vis\ufffdo geral sobre a Folia de Monstros#l\\r\\n#L2# Informa\ufffd\ufffdes detalhadas sobre a Folia de Monstros#l\\r\\n#L3# Nada, de verdade. Mudei de ideia.#l\");\n+                    cm.sendSimple(\"O que gostaria de fazer?\\r\\n#b#L0# O que \ufffd a Folia de Monstros?#l\\r\\n#L1# Vis\ufffdo geral sobre a Folia de Monstros#l\\r\\n#L2# Informa\ufffd\ufffdes detalhadas sobre a Folia de Monstros#l\\r\\n#L3# Nada, de verdade. Mudei de ideia.#l\");\n                 } else if (selection == 2) {\n-                    cm.sendSimple(\"Lembre-se se voc\ufffd possui #t4001129#, voc\ufffd pode troc\ufffd-las por itens. Tenha certeza que voc\ufffd possui #t4001129# suficientes para o item que voc\ufffd deseja. Selecione o item que voc\ufffd gostaria de troc\ufffd-las! \\r\\n#b#L0# #t1122007#(\" + n1 + \" moedas)#l\\r\\n#L1# #t2041211#(\" + n2 + \" moedas)#l\\r\\n#L2# Armas para Guerreiros#l\\r\\n#L3# Armas para Bruxos#l\\r\\n#L4# Armas para Arqueiros#l\\r\\n#L5# Armas para Gatunos#l\");\n+                    cm.sendSimple(\"Lembre-se se voc\ufffd possui #t4001129#, voc\ufffd pode troc\ufffd-las por itens. Tenha certeza que voc\ufffd possui #t4001129# suficientes para o item que voc\ufffd deseja. Selecione o item que voc\ufffd gostaria de troc\ufffd-las! \\r\\n#b#L0# #t1122007#(\" + n1 + \" moedas)#l\\r\\n#L1# #t2041211#(\" + n2 + \" moedas)#l\\r\\n#L2# Armas para Guerreiros#l\\r\\n#L3# Armas para Bruxos#l\\r\\n#L4# Armas para Arqueiros#l\\r\\n#L5# Armas para Gatunos#l\");\n                 } else if (selection == 3) {\n                     cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n                     cm.warp(980030000, 0);\n                     cm.dispose();\n                     return;\n-                }\n+                } else if (selection == 4) {\n+                    var selStr = \"Very well, instead I offer a steadfast #bore refining#k service for you, taxing #r\" + ((feeMultiplier * 100) | 0) + \"%#k over the usual fee to synthetize them. What will you do?#b\";\n+\n+                    var options = new Array(\"Refine mineral ores\",\"Refine jewel ores\");\n+                    if(refineCrystals) {\n+                        options.push(\"Refine crystal ores\");\n+                    }\n+                    if(refineRocks) {\n+                        options.push(\"Refine plates/jewels\");\n+                    }\n \n+                    for (var i = 0; i < options.length; i++){\n+                        selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n+                    }\n+\n+                    cm.sendSimple(selStr);\n+                    \n+                    status = 76;\n+                }\n             } else if (status == 2) {\n                 select = selection;\n                 if (select == 0) {\n@@ -178,7 +204,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n1);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Equipamentos est\ufffd cheio.\");\n+                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Equipamentos est\ufffd cheio.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 1) {\n@@ -187,25 +213,25 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n2);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Uso est\ufffd cheio.\");\n+                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Uso est\ufffd cheio.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 2) {//S2 Warrior 26 S3 Magician 6 S4 Bowman 6 S5 Thief 8\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n                 } else if (select == 3) {\n                     status = 20;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1372001#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1382018#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1372012#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1382019#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1382001#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1372007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1372001#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1382018#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1372012#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1382019#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1382001#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1372007#(\" + n5 + \" moedas)#l\");\n                 } else if (select == 4) {\n                     status = 30;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1452006#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1452007#(\" + n4 + \" moedas)#l\\r\\n#L2# #z1452008#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1462005#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1462006#(\" + n4 + \" moedas)#l\\r\\n#L5# #z1462007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1452006#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1452007#(\" + n4 + \" moedas)#l\\r\\n#L2# #z1452008#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1462005#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1462006#(\" + n4 + \" moedas)#l\\r\\n#L5# #z1462007#(\" + n5 + \" moedas)#l\");\n                 } else if (select == 5) {\n                     status = 40;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar por. As armas que eu tenho s\ufffdo da maior qualidade. Seleciona a mais atraente para voc\ufffd! \\r\\n#b#L0# #z1472013#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1472017#(\" + n4 + \"moedas)#l\\r\\n#L2# #z1472021#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1332014#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1332031#(\" + n4 + \"moedas)#l\\r\\n#L5# #z1332011#(\" + n4 + \"moedas)#l\\r\\n#L6# #z1332016#(\" + n5 + \" moedas)#l\\r\\n#L7# #z1332003#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar por. As armas que eu tenho s\ufffdo da maior qualidade. Seleciona a mais atraente para voc\ufffd! \\r\\n#b#L0# #z1472013#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1472017#(\" + n4 + \"moedas)#l\\r\\n#L2# #z1472021#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1332014#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1332031#(\" + n4 + \"moedas)#l\\r\\n#L5# #z1332011#(\" + n4 + \"moedas)#l\\r\\n#L6# #z1332016#(\" + n5 + \" moedas)#l\\r\\n#L7# #z1332003#(\" + n5 + \" moedas)#l\");\n                 }\n             } else if (status == 11) {\n                 if (selection == 12) {\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente \ufffdteis. D\ufffd uma olhada! \\r\\n#b#L0# #z1322015#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1422008#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1322016#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1422007#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1322017#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1422005#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1432003#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1442003#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1432005#(\" + n4 + \"moedas)#l\\r\\n#L9# #z1442009#(\" + n4 + \"moedas)#l\\r\\n#L10# #z1442005#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1432004#(\" + n5 + \" moedas)#l\\r\\n#L12# Voltar para a p\ufffdgina inicial(2/2)#l\");\n+                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente \ufffdteis. D\ufffd uma olhada! \\r\\n#b#L0# #z1322015#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1422008#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1322016#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1422007#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1322017#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1422005#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1432003#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1442003#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1432005#(\" + n4 + \"moedas)#l\\r\\n#L9# #z1442009#(\" + n4 + \"moedas)#l\\r\\n#L10# #z1442005#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1432004#(\" + n5 + \" moedas)#l\\r\\n#L12# Voltar para a p\ufffdgina inicial(2/2)#l\");\n                 } else {\n                     var item = new Array(1302004, 1402006, 1302009, 1402007, 1302010, 1402003, 1312006, 1412004, 1312007, 1412005, 1312008, 1412003);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5);\n@@ -214,14 +240,14 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                         cm.dispose();\n                     }\n                 }\n             } else if (status == 12) {\n                 if (selection == 12) {\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n                 } else {\n                     var item = new Array(1322015, 1422008, 1322016, 1422007, 1322017, 1422005, 1432003, 1442003, 1432005, 1442009, 1442005, 1432004);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5, n5);\n@@ -230,7 +256,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                         cm.dispose();\n                     }\n                 }\n@@ -242,7 +268,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                     cm.dispose();\n                 }\n             } else if (status == 31) {\n@@ -253,7 +279,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                     cm.dispose();\n                 }\n             } else if (status == 41) {\n@@ -264,57 +290,213 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n                     cm.dispose();\n                 }\n             } else if (status == 61) {\n                 select = selection;\n                 if (selection == 0) {\n-                    cm.sendNext(\"Haha! Eu sou Spiegelmann, o l\ufffdder dessa Folia. Eu comecei a primeira #bFolia de Monstros#k aqui, aguardando por viajantes como voc\ufffd para participar dessa extravaganza!\");\n+                    cm.sendNext(\"Haha! Eu sou Spiegelmann, o l\ufffdder dessa Folia. Eu comecei a primeira #bFolia de Monstros#k aqui, aguardando por viajantes como voc\ufffd para participar dessa extravaganza!\");\n                 } else if (selection == 1) {\n-                    cm.sendNext(\"#bFolia de Monstros#k consiste em 2 grupos entrando no campo de batalha, e ca\ufffdando os monstros invocados pelo outro grupo. \ufffd uma #bmiss\ufffdo de combate que determina o vitorioso pela quantia de Pontos de Folia (CP) recebidos#k.\");\n+                    cm.sendNext(\"#bFolia de Monstros#k consiste em 2 grupos entrando no campo de batalha, e ca\ufffdando os monstros invocados pelo outro grupo. \ufffd uma #bmiss\ufffdo de combate que determina o vitorioso pela quantia de Pontos de Folia (CP) recebidos#k.\");\n                 } else if (selection == 2) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, voc\ufffd ver\ufffd a janela da Folia de Monstros aparecer. Tudo que precisa fazer \ufffd #bselecionar o que voc\ufffde quer usar, e pressionar OK#k. Muito f\ufffdcil, n\ufffd?\");\n+                    cm.sendNext(\"Quando entrar no Campo da Folia, voc\ufffd ver\ufffd a janela da Folia de Monstros aparecer. Tudo que precisa fazer \ufffd #bselecionar o que voc\ufffde quer usar, e pressionar OK#k. Muito f\ufffdcil, n\ufffd?\");\n                 } else {\n                     cm.dispose();\n                 }\n             } else if (status == 62) {\n                 if (select == 0) {\n-                    cm.sendNext(\"O que \ufffd a #bFolia de Monstros#k? Hahaha! Vamos dizer que \ufffd uma experi\ufffdncia que jamais esquecer\ufffd! \ufffd uma #bbatalha contra outros viajantes assim como voc\ufffd!#k\");\n+                    cm.sendNext(\"O que \ufffd a #bFolia de Monstros#k? Hahaha! Vamos dizer que \ufffd uma experi\ufffdncia que jamais esquecer\ufffd! \ufffd uma #bbatalha contra outros viajantes assim como voc\ufffd!#k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, sua tarefa \ufffd #breceber CP ca\ufffdando os monstros do grupo oposto, e usar estes CP's para distrair o grupo oposto de ca\ufffdar monstros.#k.\");\n+                    cm.sendNext(\"Quando entrar no Campo da Folia, sua tarefa \ufffd #breceber CP ca\ufffdando os monstros do grupo oposto, e usar estes CP's para distrair o grupo oposto de ca\ufffdar monstros.#k.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"Assim que se acostumar com os comandos, tente usar #bas teclas TAB e F1 ~ F12#k. #bTAB alterna entre Invoca\ufffd\ufffdo de Monstros/Habilidades/Protetor,#k e, #bF1~ F12 possibilita-o de acessar uma das janelas diretamente#k.\");\n+                    cm.sendNext(\"Assim que se acostumar com os comandos, tente usar #bas teclas TAB e F1 ~ F12#k. #bTAB alterna entre Invoca\ufffd\ufffdo de Monstros/Habilidades/Protetor,#k e, #bF1~ F12 possibilita-o de acessar uma das janelas diretamente#k.\");\n                 }\n             } else if (status == 63) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Eu sei que \ufffd muito perigoso para voc\ufffds lutarem uns com os outros usando armas de verdade; e eu n\ufffdo sugeriria um ato t\ufffdo barb\ufffdrico. N\ufffdo meu amigo, o que eu ofere\ufffdo \ufffd competi\ufffd\ufffdo. A emo\ufffd\ufffdo da batalha e a emo\ufffd\ufffdo de competir contra pessoas t\ufffdo fortes e motivadas. Eu ofere\ufffdo a premissa de que seu grupo e o grupo oposto ambos #binvoquem os monstros, e derrote os monstros invocados pelo grupo advers\ufffdrio. Essa \ufffd a ess\ufffdncia da Folia de Monstros. Al\ufffdm disso, voc\ufffd pode usar Maple Coins ganhos durante a Folia de Monstros para obter novos itens e armas! #k\");\n+                    cm.sendNext(\"Eu sei que \ufffd muito perigoso para voc\ufffds lutarem uns com os outros usando armas de verdade; e eu n\ufffdo sugeriria um ato t\ufffdo barb\ufffdrico. N\ufffdo meu amigo, o que eu ofere\ufffdo \ufffd competi\ufffd\ufffdo. A emo\ufffd\ufffdo da batalha e a emo\ufffd\ufffdo de competir contra pessoas t\ufffdo fortes e motivadas. Eu ofere\ufffdo a premissa de que seu grupo e o grupo oposto ambos #binvoquem os monstros, e derrote os monstros invocados pelo grupo advers\ufffdrio. Essa \ufffd a ess\ufffdncia da Folia de Monstros. Al\ufffdm disso, voc\ufffd pode usar Maple Coins ganhos durante a Folia de Monstros para obter novos itens e armas! #k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Existem 3 maneiras de distrair o grupo advers\ufffdrio: #bInvodar um monstro, Habilidade, and Protetor#k. Vou dar-lhe um olhar mais aprofundado, se voc\ufffd quiser saber mais sobre 'Instru\ufffd\ufffdes detalhadas'.\");\n+                    cm.sendNext(\"Existem 3 maneiras de distrair o grupo advers\ufffdrio: #bInvodar um monstro, Habilidade, and Protetor#k. Vou dar-lhe um olhar mais aprofundado, se voc\ufffd quiser saber mais sobre 'Instru\ufffd\ufffdes detalhadas'.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bInvocar um Monstro#k chama um monstro que ataca o grupo advers\ufffdrio, sob seu controle. Use CP para trazer um Monstro Invocado, e ele ir\ufffd aparecer na mesma \ufffdrea, atacando o grupo oposto.\");\n+                    cm.sendNext(\"#bInvocar um Monstro#k chama um monstro que ataca o grupo advers\ufffdrio, sob seu controle. Use CP para trazer um Monstro Invocado, e ele ir\ufffd aparecer na mesma \ufffdrea, atacando o grupo oposto.\");\n                 }\n             } else if (status == 64) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Claro, n\ufffdo \ufffd t\ufffdo simples assim. Existem outras maneiras de prevenir o outro grupo de ca\ufffdar monstros, e cabe a voc\ufffd descobrir como faz\ufffd-lo. O que acha? Interessado em uma competi\ufffd\ufffdo amig\ufffdvel?\");\n+                    cm.sendNext(\"Claro, n\ufffdo \ufffd t\ufffdo simples assim. Existem outras maneiras de prevenir o outro grupo de ca\ufffdar monstros, e cabe a voc\ufffd descobrir como faz\ufffd-lo. O que acha? Interessado em uma competi\ufffd\ufffdo amig\ufffdvel?\");\n                     cm.dispose();\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Por favor lembre-se. Nunca \ufffd uma boa ideia guardar seus CP's. #bOs CP's que voc\ufffd usou ir\ufffdo ajudar a determinar o vencedor e o perdedor da Folia.\");\n+                    cm.sendNext(\"Por favor lembre-se. Nunca \ufffd uma boa ideia guardar seus CP's. #bOs CP's que voc\ufffd usou ir\ufffdo ajudar a determinar o vencedor e o perdedor da Folia.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bHabilidade#k \ufffd uma op\ufffd\ufffdo de usar habilidades tais como Escurid\ufffdo, Fraqueza, e outras para prevenir o grupo oposto de matar outros monstros. S\ufffdo necess\ufffdrios muitos CP's, mas vale muito a pena. O \ufffdnico problema \ufffd que eles n\ufffdo duram muito. Use essa t\ufffdtica com sabedoria!\");\n+                    cm.sendNext(\"#bHabilidade#k \ufffd uma op\ufffd\ufffdo de usar habilidades tais como Escurid\ufffdo, Fraqueza, e outras para prevenir o grupo oposto de matar outros monstros. S\ufffdo necess\ufffdrios muitos CP's, mas vale muito a pena. O \ufffdnico problema \ufffd que eles n\ufffdo duram muito. Use essa t\ufffdtica com sabedoria!\");\n                 }\n             } else if (status == 65) {\n                 if (select == 1) {\n-                    cm.sendNext(\"Oh, e n\ufffdo se preocupe em tranformar-se em um fantasma. Na Folia de Monstros, #bvoc\ufffd n\ufffdo perder\ufffd EXP ap\ufffds a morte#k. \ufffd realmente uma exper\ufffdncia como nenhuma outra!\");\n+                    cm.sendNext(\"Oh, e n\ufffdo se preocupe em tranformar-se em um fantasma. Na Folia de Monstros, #bvoc\ufffd n\ufffdo perder\ufffd EXP ap\ufffds a morte#k. \ufffd realmente uma exper\ufffdncia como nenhuma outra!\");\n                     cm.dispose();\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bProtetor#k \ufffd basicamente um item invocado que aumenta dr\ufffdsticamente as habilidades dos monstros invocados pelo seu grupo. Protetor funciona enquanto n\ufffdo for demolido pelo grupo oposto, ent\ufffdo eu surigo que voc\ufffd invoque v\ufffdrios monstros primeiro, e ent\ufffdo traga o Protetor.\");\n+                    cm.sendNext(\"#bProtetor#k \ufffd basicamente um item invocado que aumenta dr\ufffdsticamente as habilidades dos monstros invocados pelo seu grupo. Protetor funciona enquanto n\ufffdo for demolido pelo grupo oposto, ent\ufffdo eu surigo que voc\ufffd invoque v\ufffdrios monstros primeiro, e ent\ufffdo traga o Protetor.\");\n                 }\n             } else if (status == 66) {\n-                cm.sendNext(\"Por \ufffdltimo, enquanto estiver na Folia de Monstros, #bvoc\ufffd n\ufffdo pode usar items/po\ufffd\ufffdes de recupera\ufffd\ufffdo que voc\ufffd leva por ai contigo.#k Entretanto, os monstros deixam esses items cair de vez em quando, e #bassim que peg\ufffd-los, o item ativar\ufffd imediatamente#k. \ufffd por isso que \ufffd importante saber quando pegar estes items.\");\n+                cm.sendNext(\"Por \ufffdltimo, enquanto estiver na Folia de Monstros, #bvoc\ufffd n\ufffdo pode usar items/po\ufffd\ufffdes de recupera\ufffd\ufffdo que voc\ufffd leva por ai contigo.#k Entretanto, os monstros deixam esses items cair de vez em quando, e #bassim que peg\ufffd-los, o item ativar\ufffd imediatamente#k. \ufffd por isso que \ufffd importante saber quando pegar estes items.\");\n+                cm.dispose();\n+            } else if (status == 77) {\n+                var allDone;\n+\n+                if (selection == 0) {\n+                    allDone = refineItems(0); // minerals\n+                } else if (selection == 1) {\n+                    allDone = refineItems(1); // jewels\n+                } else if (selection == 2 && refineCrystals) {\n+                    allDone = refineItems(2); // crystals\n+                } else if (selection == 2 && !refineCrystals || selection == 3) {\n+                    allDone = refineRockItems(); // moon/star rock\n+                }\n+\n+                if(allDone) {\n+                    cm.sendOk(\"Done. Thanks for showing up~.\");\n+                } else {\n+                    cm.sendOk(\"Done. Be aware some of the items #rcould not be synthetized#k because either you have a lack of space on your ETC inventory or there's not enough mesos to cover the fee.\");\n+                }\n                 cm.dispose();\n             }\n         }\n     }\n }\n \n+function getRefineFee(fee) {\n+    return ((feeMultiplier * fee) | 0);\n+}\n+\n+function isRefineTarget(refineType, refineItemid) {\n+    if(refineType == 0) { //mineral refine\n+        return refineItemid >= 4010000 && refineItemid <= 4010007 && !(refineItemid == 4010007 && !refineSpecials);\n+    } else if(refineType == 1) { //jewel refine\n+        return refineItemid >= 4020000 && refineItemid <= 4020008 && !(refineItemid == 4020008 && !refineSpecials);\n+    } else if(refineType == 2) { //crystal refine\n+        return refineItemid >= 4004000 && refineItemid <= 4004004 && !(refineItemid == 4004004 && !refineSpecials);\n+    }\n+    \n+    return false;\n+}\n+\n+function getRockRefineTarget(refineItemid) {\n+    if(refineItemid >= 4011000 && refineItemid <= 4011006) {\n+        return 0;\n+    } else if(refineItemid >= 4021000 && refineItemid <= 4021008) {\n+        return 1;\n+    }\n+    \n+    return -1;\n+}\n+\n+function refineItems(refineType) {\n+    var allDone = true;\n+    \n+    var refineFees = [[300,300,300,500,500,500,800,270],[500,500,500,500,500,500,500,1000,3000],[5000,5000,5000,5000,1000000]];\n+    var itemCount = {};\n+    \n+    var iter = cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).iterator();\n+    while (iter.hasNext()) {\n+        var it = iter.next();\n+        var itemid = it.getItemId();\n+\n+        if(isRefineTarget(refineType, itemid)) {\n+            var ic = itemCount[itemid];\n+            \n+            if(ic != undefined) {\n+                itemCount[itemid] += it.getQuantity();\n+            } else {\n+                itemCount[itemid] = it.getQuantity();\n+            }\n+        }\n+    }\n+    \n+    for(var key in itemCount) {\n+        var itemqty = itemCount[key];\n+        var itemid = parseInt(key);\n+        \n+        var refineQty = ((itemqty / 10) | 0);\n+        if(refineQty <= 0) continue;\n+        \n+        while(true) {\n+            itemqty = refineQty * 10;\n+        \n+            var fee = getRefineFee(refineFees[refineType][(itemid % 100) | 0] * refineQty);\n+            if(cm.canHold(itemid + 1000, refineQty, itemid, itemqty) && cm.getMeso() >= fee) {\n+                cm.gainMeso(-fee);\n+                cm.gainItem(itemid, -itemqty);\n+                cm.gainItem(itemid + (itemid != 4010007 ? 1000 : 1001), refineQty);\n+                \n+                break;\n+            } else if(refineQty <= 1) {\n+                allDone = false;\n+                break;\n+            } else {\n+                refineQty--;\n+            }\n+        }\n+    }\n+    \n+    return allDone;\n+}\n+\n+function refineRockItems() {\n+    var allDone = true;\n+    var minItems = [[0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0]];\n+    var minRocks = [2147483647, 2147483647];\n+    \n+    var rockItems = [4011007, 4021009];\n+    var rockFees = [10000, 15000];\n+\n+    var iter = cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.ETC).iterator();\n+    while (iter.hasNext()) {\n+        var it = iter.next();\n+        var itemid = it.getItemId();\n+        var rockRefine = getRockRefineTarget(itemid);\n+        if(rockRefine >= 0) {\n+            var rockItem = ((itemid % 100) | 0);\n+            var itemqty = it.getQuantity();\n+            \n+            minItems[rockRefine][rockItem] += itemqty;\n+        }\n+    }\n+    \n+    for(var i = 0; i < minRocks.length; i++) {\n+        for(var j = 0; j < minItems[i].length; j++) {\n+            if(minRocks[i] > minItems[i][j]) {\n+                minRocks[i] = minItems[i][j];\n+            }\n+        }\n+        if(minRocks[i] <= 0 || minRocks[i] == 2147483647) continue;\n+        \n+        var refineQty = minRocks[i];\n+        while(true) {\n+            var fee = getRefineFee(rockFees[i] * refineQty);\n+            if(cm.canHold(rockItems[i], refineQty) && cm.getMeso() >= fee) {\n+                cm.gainMeso(-fee);\n+\n+                var j;\n+                if(i == 0) {\n+                    for(j = 4011000; j < 4011007; j++) {\n+                        cm.gainItem(j, -refineQty);\n+                    }\n+                    cm.gainItem(j, refineQty);\n+                } else {\n+                    for(j = 4021000; j < 4021009; j++) {\n+                        cm.gainItem(j, -refineQty);\n+                    }\n+                    cm.gainItem(j, refineQty);\n+                }\n+                \n+                break;\n+            } else if(refineQty <= 1) {\n+                allDone = false;\n+                break;\n+            } else {\n+                refineQty--;\n+            }\n+        }\n+    }\n+    \n+    return allDone;\n+}"}, {"sha": "6b205c1098e6fe82d6ef7e6a20c7ff5c2ef595f4", "filename": "scripts/npc/2042005.js", "status": "modified", "additions": 21, "deletions": 21, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042005.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,8 +1,7 @@\n-var map = 980030000;\n-var minLvl = 30;\n-var maxLvl = 255;\n-var minAmt = 0;\n-var maxAmt = 6;\n+var cpqMinLvl = 30;\n+var cpqMaxLvl = 255;\n+var cpqMinAmt = 0;\n+var cpqMaxAmt = 6;\n \n function start() {\n     status = -1;\n@@ -24,34 +23,35 @@ function action(mode, type, selection) {\n         if (status == 0) {\n             if (cm.getParty() == null) {\n                 status = 10;\n-                cm.sendOk(\"#e\ufffd necess\ufffdrio criar um grupo antes de come\ufffdar o Festival de Monstros!#k\");\n+                cm.sendOk(\"#e\ufffd necess\ufffdrio criar um grupo antes de come\ufffdar o Festival de Monstros!#k\");\n             } else if (!cm.isLeader()) {\n                 status = 10;\n-                cm.sendOk(\"Se voc\ufffd quer come\ufffdar o Festival, avise o #bl\ufffdder do grupo#k para falar comigo.\");\n+                cm.sendOk(\"Se voc\ufffd quer come\ufffdar o Festival, avise o #bl\ufffdder do grupo#k para falar comigo.\");\n             } else {\n+                var leaderMapid = cm.getMapId();\n                 var party = cm.getParty().getMembers();\n                 var inMap = cm.partyMembersInMap();\n                 var lvlOk = 0;\n-                var isInMap = 0;\n+                var isOutMap = 0;\n                 for (var i = 0; i < party.size(); i++) {\n-                    if (party.get(i).getLevel() >= minLvl && party.get(i).getLevel() <= maxLvl) {\n+                    if (party.get(i).getLevel() >= cpqMinLvl && party.get(i).getLevel() <= cpqMaxLvl) {\n                         lvlOk++;\n-                    }\n-                    if (party.get(i).getPlayer().getMapId()!= 980030000) {\n-                        //isInMap = false;\n-                        isInMap++\n+                        \n+                        if (party.get(i).getPlayer().getMapId() != leaderMapid) {\n+                            isOutMap++;\n+                        }\n                     }\n                 }\n \n                 if (party >= 1) {\n                     status = 10;\n-                    cm.sendOk(\"Voc\ufffd n\ufffdo tem n\ufffdmero suficiente de pessoas em seu grupo. Voc\ufffd precisa de um grupo com #b\" + minAmt + \"#k - #r\" + maxAmt + \"#k membros e eles devem estar no mapa com voc\ufffd.\");\n+                    cm.sendOk(\"Voc\ufffd n\ufffdo tem n\ufffdmero suficiente de pessoas em seu grupo. Voc\ufffd precisa de um grupo com #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k membros e eles devem estar no mapa com voc\ufffd.\");\n                 } else if (lvlOk != inMap) {\n                     status = 10;\n-                    cm.sendOk(\"Certifique se todos em seu grupo est\ufffdo dentre os n\ufffdveis corretos (\" + minLvl + \"~\" + maxLvl + \")!\");\n-                } else if (isInMap > 0) {\n+                    cm.sendOk(\"Certifique se todos em seu grupo est\ufffdo dentre os n\ufffdveis corretos (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                } else if (isOutMap > 0) {\n                     status = 10;\n-                    cm.sendOk(\"Existe algu\ufffdm do grupo que n\ufffdo esta no mapa!\");\n+                    cm.sendOk(\"Existe algu\ufffdm do grupo que n\ufffdo esta no mapa!\");\n                 } else {\n                     cm.sendCPQMapLists2();\n                 }\n@@ -67,10 +67,10 @@ function action(mode, type, selection) {\n                 }\n             } else {\n                 var party = cm.getParty().getMembers();\n-                if ((selection === 0 || selection === 1 ) && party.size() < 2) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 2 player para entrar na competi\ufffd\ufffdo.\");\n-                } else if ((selection === 2 ) && party.size() < 3) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 3 player para entrar na competi\ufffd\ufffdo.\");\n+                if ((selection === 0 || selection === 1 ) && party.size() < 1) {\n+                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 2 player para entrar na competi\ufffd\ufffdo.\");\n+                } else if ((selection === 2 ) && party.size() < 1) {\n+                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 3 player para entrar na competi\ufffd\ufffdo.\");\n                 } else {\n                     cm.cpqLobby2(selection);\n                 }"}, {"sha": "887b7b65c8859ca743e998fa0b5ffa3e772837a0", "filename": "scripts/npc/2042007.js", "status": "modified", "additions": 14, "deletions": 14, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042007.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,4 +1,3 @@\n-importPackage(net.sf.odinms.server.maps);\n \n var status = 0;\n var rnk = -1;\n@@ -21,26 +20,27 @@ function action(mode, type, selection) {\n             status++;\n         else\n             status--;\n+        \n         if (cm.getChar().getMap().isCPQLoserMap()) {\n             if (status == 0) {\n                 if (cm.getChar().getParty() != null) {\n                     var shiu = \"\";\n-                    if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shiu += \"#rA#k\";\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                         rnk = 10;\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 50 && cm.getPlayer().getFestivalPoints() < 100) {\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shiu += \"#rB#k\";\n                         rnk = 20;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 30 && cm.getPlayer().getFestivalPoints() < 50) {\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shiu += \"#rC#k\";\n                         rnk = 30;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                     } else {\n                         shiu += \"#rD#k\";\n                         rnk = 40;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n                     }\n                 } else {\n                     cm.warp(980030000, 0);\n@@ -81,19 +81,19 @@ function action(mode, type, selection) {\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shi += \"#rA#k\";\n                         rnk = 1;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 100 && cm.getPlayer().getFestivalPoints() < 300) {\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shi += \"#rB#k\";\n                         rnk = 2;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n-                    } else if (cm.getPlayer().getFestivalPoints() >= 50 && cm.getPlayer().getFestivalPoints() < 100) {\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shi += \"#rC#k\";\n                         rnk = 3;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n                     } else {\n                         shi += \"#rD#k\";\n                         rnk = 4;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n                     }\n                 } else {\n                     cm.warp(980030000, 0);"}, {"sha": "24cf9806cc9a121aada1927c5b908710ae95cc1a", "filename": "scripts/npc/2091005.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -24,7 +24,7 @@\n * @Name:   So Gong\n * @Map(s): Dojo Hall\n */\n-importPackage(Packages.server.maps);\n+\n importPackage(Packages.constants);\n \n var disabled = false;"}, {"sha": "ffaae970cf1f583168b1d1fe4188c44c99b1fc95", "filename": "scripts/npc/2091005_old.js", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2091005_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2091005_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005_old.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -25,7 +25,6 @@\n * @Name:   So Gong\n * @Map(s): Dojo Hall\n */\n-importPackage(Packages.server.maps);\n \n var disabled = false;\n var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);"}, {"sha": "e98268eac30b4c6841b9d0cd1bebe908defa416e", "filename": "scripts/npc/9010022.js", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9010022.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9010022.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,6 +1,4 @@\n-importPackage(Packages.client); \n-importPackage(Packages.server.maps); \n-\n+ \n var status; \n var sel; \n "}, {"sha": "d62b2984b5da6b683c68a80c4447a4ff57d54556", "filename": "scripts/npc/9010022_old.js", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9010022_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9010022_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022_old.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,5 +1,3 @@\n-importPackage(Packages.client); \n-importPackage(Packages.server.maps); \n \n var status; \n var sel; "}, {"sha": "5785d6d2f419d34b242a64d7f8546cf712e54aa0", "filename": "scripts/npc/9201005.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201005.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -158,6 +158,12 @@ function action(mode, type, selection) {\n                                         cm.dispose();\n                                         return;\n                                     }\n+                                    \n+                                    if(!cm.getUnclaimedMarriageGifts().isEmpty() || !partner.getClient().getAbstractPlayerInteraction().getUnclaimedMarriageGifts().isEmpty()) {\n+                                        cm.sendOk(\"Eerhm... I'm sorry, something doesn't seem right according to the Amoria's Wedding Gift Registry reserve. Please check in the situation with #b#p9201014##k.\");\n+                                        cm.dispose();\n+                                        return;\n+                                    }\n \n                                     var hasCommon = cm.haveItem(weddingEntryTicketCommon);\n                                     var hasPremium = cm.haveItem(weddingEntryTicketPremium);"}, {"sha": "761cc2fa193066613c7944b961f7d6311d0515f5", "filename": "scripts/npc/9201006.js", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201006.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -50,7 +50,6 @@ function action(mode, type, selection) {\n     var eim = cm.getEventInstance();\n     if(eim == null) {\n         cm.warp(680000000,0);\n-        //cm.criarLista();\n         cm.dispose();\n         return;\n     }\n@@ -72,7 +71,9 @@ function action(mode, type, selection) {\n                     cm.sendOk(\"Congratulations on your wedding. Please talk to #b#p9201007##k to start the afterparty.\");\n                     cm.dispose();\n                 } else if(hasEngagement) {\n-                    cm.criarLista();\n+                    if (!cm.createMarriageWishlist()) {\n+                        cm.sendOk(\"You have already sent your wishlist...\");\n+                    }\n                     cm.dispose();\n                 } else {\n                     cm.sendOk(\"You do not have the required item to continue through this wedding. Unfortunately, it's over...\");"}, {"sha": "e3dee07937ab33efa3bec25d90993cbf8c1ab769", "filename": "scripts/npc/9201008.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201008.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -158,6 +158,12 @@ function action(mode, type, selection) {\n                                         cm.dispose();\n                                         return;\n                                     }\n+                                    \n+                                    if(!cm.getUnclaimedMarriageGifts().isEmpty() || !partner.getClient().getAbstractPlayerInteraction().getUnclaimedMarriageGifts().isEmpty()) {\n+                                        cm.sendOk(\"Eerhm... I'm sorry, something doesn't seem right according to the Amoria's Wedding Gift Registry reserve. Please check in the situation with #b#p9201014##k.\");\n+                                        cm.dispose();\n+                                        return;\n+                                    }\n \n                                     var hasCommon = cm.haveItem(weddingEntryTicketCommon);\n                                     var hasPremium = cm.haveItem(weddingEntryTicketPremium);"}, {"sha": "2ba82e77267b310cf1c055a7ac7cf239d302a6f9", "filename": "scripts/npc/9201010.js", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201010.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -74,7 +74,9 @@ function action(mode, type, selection) {\n                         cm.sendOk(\"You guys totally rocked the stage!!! Go go, talk to #b#p9201007##k to start the afterparty.\");\n                         cm.dispose();\n                     } else if(hasEngagement) {\n-                        cm.sendOk(\"Please continue rocking on the stage, you are our superstars today!\");\n+                        if (!cm.createMarriageWishlist()) {\n+                            cm.sendOk(\"You have already sent your wishlist...\");\n+                        }\n                         cm.dispose();\n                     } else {\n                         cm.sendOk(\"Oh, hey, where are the credentials for the this so-lauded party? Oh man, we can't continue at this rate now... Sorry, the party is over.\");"}, {"sha": "4f2c1a514ce5028f4ea2e6921903c403f84645bc", "filename": "scripts/npc/9201014.js", "status": "modified", "additions": 90, "deletions": 4, "changes": 94, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/9201014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201014.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -27,12 +27,22 @@\n \t1.0 - First Version by Angel\n         2.0 - Second Version by happydud3 & XotiCraze\n         3.0 - Third Version by RonanLana (HeavenMS)\n-        4.0 - Four Version bby Drago(MapleStorySA)\n+        4.0 - Four Version bby Drago (MapleStorySA)\n ---------------------------------------------------------------------------------------------------\n **/\n var status = -1;\n \n+var marriageRoom;\n+var marriageAction = 0;\n+var marriageGifts;\n+\n function start() {\n+    marriageRoom = cm.getPlayer().getMarriageInstance() != null;\n+    if (!marriageRoom) {\n+        marriageGifts = cm.getUnclaimedMarriageGifts();\n+        marriageAction = (!marriageGifts.isEmpty() ? 2 : ((cm.haveItem(4031423) || cm.haveItem(4031424)) ? 1 : 0));\n+    }\n+    \n     status = -1;\n     action(1, 0, 0);\n }\n@@ -44,8 +54,84 @@ function action(mode, type, selection) {\n         cm.dispose();\n         return;\n     }\n-    if (status == 0) {\n-        cm.enviarLista();\n-        cm.dispose();\n+    if (marriageRoom) {\n+        if (status == 0) {\n+            var talk = \"Hi there, welcome to the wedding's Gift Registry. From which spouse's wishlist would you like to take a look?\";\n+            var options = [\"Groom\", \"Bride\"];\n+\n+            cm.sendSimple(talk + \"\\r\\n\\r\\n#b\" + generateSelectionMenu(options) + \"#k\");        \n+        } else {\n+            cm.sendMarriageWishlist(selection == 0);\n+            cm.dispose();\n+        }\n+    } else {\n+        if (marriageAction == 2) {     // unclaimed gifts\n+            if (status == 0) {\n+                var talk = \"Hi there, it seems you have unclaimed gifts from your wedding. Claim them here on the wedding's Gift Registry reserve.\";\n+                cm.sendNext(talk);\n+            } else {\n+                cm.sendMarriageGifts(marriageGifts);\n+                cm.dispose();\n+            }\n+        } else if (marriageAction == 1) {     // onyx prizes\n+            if (status == 0) {\n+                var msg = \"Hello I exchange Onyx Chest for Bride and Groom and the Onyx Chest for prizes!#b\";\n+                var choice1 = new Array(\"I have an Onyx Chest for Bride and Groom\", \"I have an Onyx Chest\");\n+                for (var i = 0; i < choice1.length; i++) {\n+                    msg += \"\\r\\n#L\" + i + \"#\" + choice1[i] + \"#l\";\n+                }\n+                cm.sendSimple(msg);\n+            } else if (status == 1) {\n+                if (selection == 0) {\n+                    if (cm.haveItem(4031424)) {\n+                        if (cm.getPlayer().isMarried()) {   // thanks MedicOP for solving an issue here\n+                            if(cm.getInventory(2).getNextFreeSlot() >= 0) {\n+                                var rand = Math.floor(Math.random() * bgPrizes.length);\n+                                cm.gainItem(bgPrizes[rand][0], bgPrizes[rand][1]);\n+\n+                                cm.gainItem(4031424,-1);\n+                                cm.dispose();\n+                            } else {\n+                                cm.sendOk(\"You don't have a free USE slot right now.\");\n+                                cm.dispose();\n+                            }\n+                        } else {\n+                            cm.sendOk(\"You must be married to claim the prize for this box.\");\n+                            cm.dispose();\n+                        }\n+                    } else {\n+                        cm.sendOk(\"You don't have an Onyx Chest for Bride and Groom.\");\n+                        cm.dispose();\n+                    }\n+                } else if (selection == 1) {\n+                    if (cm.haveItem(4031423)) {\n+                        if(cm.getInventory(2).getNextFreeSlot() >= 0) {\n+                            var rand = Math.floor(Math.random() * cmPrizes.length);\n+                            cm.gainItem(cmPrizes[rand][0], cmPrizes[rand][1]);\n+\n+                            cm.gainItem(4031423,-1);\n+                            cm.dispose();\n+                        } else {\n+                            cm.sendOk(\"You don't have a free USE slot right now.\");\n+                            cm.dispose();\n+                        }\n+                    } else {\n+                        cm.sendOk(\"You don't have an Onyx Chest.\");\n+                        cm.dispose();\n+                    }\n+                }\n+            }\n+        } else {\n+            cm.sendOk(\"Hi there, welcome to Amoria's Wedding Gift Registry reserve. We redistribute and tender gifts for both wedding spouses and lucky ceremonial attenders.\");\n+            cm.dispose();\n+        }        \n     }\n+}\n+\n+function generateSelectionMenu(array) {\n+        var menu = \"\";\n+        for (var i = 0; i < array.length; i++) {\n+                menu += \"#L\" + i + \"#\" + array[i] + \"#l\\r\\n\";\n+        }\n+        return menu;\n }\n\\ No newline at end of file"}, {"sha": "f768e4627460fd74f39d6364cc5fb664bb1fcd1f", "filename": "scripts/npc/cpqchallenge.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/cpqchallenge.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/cpqchallenge.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/cpqchallenge.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -15,7 +15,6 @@ function action(mode, type, selection) {\n         cm.dispose();\n     } else {\n         if (mode == 0) {\n-            cm.sendOk(\"Come back once you have thought about it some more.\");\n             cm.getChar().setChallenged(false);\n             cm.dispose();\n             return;\n@@ -46,7 +45,7 @@ function action(mode, type, selection) {\n                 cm.getChar().getParty().setEnemy(ch.getParty());\n                 cm.getChar().setChallenged(false);\n             } else {\n-                cm.sendOk(\"O numero de players entre os times n\ufffdo esta igual.\");\n+                cm.sendOk(\"O numero de players entre os times nao esta igual.\");\n             }\n             cm.dispose();\n         }"}, {"sha": "80e89b9d26aad0ddcfade2509212107c283a754a", "filename": "scripts/portal/MCRevive1.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive1.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,10 +1,10 @@\n-importPackage(Packages.server.maps);\n \n /*\n  [CelticMS] Monster Carnival Reviving Field 1\n  */\n \n function enter(pi) {\n     pi.warp(980000101, 0);\n+    pi.playPortalSound();\n     return true;\n }"}, {"sha": "77696a166716f87cc0e481715967c786ef8b18f7", "filename": "scripts/portal/MCRevive2.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive2.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,10 +1,10 @@\n-importPackage(Packages.server.maps);\n \n /*\n  [CelticMS] Monster Carnival Reviving Field 1\n  */\n \n function enter(pi) {\n     pi.warp(980000201, 0);\n+    pi.playPortalSound();\n     return true;\n }"}, {"sha": "f11c3e54ef0be3dd23fec7529280776e656a7739", "filename": "scripts/portal/MCRevive3.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive3.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive3.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive3.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,4 +1,3 @@\n-importPackage(Packages.server.maps);\n \n /*\n [CelticMS] Monster Carnival Reviving Field 1\n@@ -15,5 +14,6 @@ function enter(pi) {\n \t\t\tbreak;\n \t}\n \tpi.warp(980000301, portal);\n+        pi.playPortalSound();\n \treturn true;\n }"}, {"sha": "747706887e007b882f3385fd2377891c7378ae20", "filename": "scripts/portal/MCRevive4.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive4.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,4 +1,3 @@\n-importPackage(Packages.server.maps);\n \n /*\n [CelticMS] Monster Carnival Reviving Field 1\n@@ -15,5 +14,6 @@ function enter(pi) {\n \t\t\tbreak;\n \t}\n \tpi.warp(980000401, portal);\n+        pi.playPortalSound();\n \treturn true;\n }"}, {"sha": "f89c28b366a6337ad651ddcc475208dc75dffdca", "filename": "scripts/portal/MCRevive5.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive5.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive5.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive5.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,10 +1,10 @@\n-importPackage(Packages.server.maps);\n \n /*\n [CelticMS] Monster Carnival Reviving Field 1\n */\n \n function enter(pi) {\n \tpi.warp(980000501, 0);\n+        pi.playPortalSound();\n \treturn true;\n }"}, {"sha": "f9e0ae6ad179f8cb896e178c65f52ef857da0093", "filename": "scripts/portal/MCRevive6.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive6.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/MCRevive6.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MCRevive6.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,10 +1,10 @@\n-importPackage(Packages.server.maps);\n \n /*\n [CelticMS] Monster Carnival Reviving Field 1\n */\n \n function enter(pi) {\n \tpi.warp(980000601, 0);\n+        pi.playPortalSound();\n \treturn true;\n }"}, {"sha": "11f62ff8fbb32162a156d2812c78c01f363a4b00", "filename": "scripts/portal/mc_out.js", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/mc_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/portal/mc_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/mc_out.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -19,17 +19,13 @@\n  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n  */\n \n-importPackage(Packages.server.maps);\n-\n-/*\n- */\n-\n function enter(pi) {\n     var returnMap = pi.getPlayer().getSavedLocation(\"MONSTER_CARNIVAL\");\n     if (returnMap < 0) {\n         returnMap = 102000000; // Just Incase there is no saved location.\n     }\n     var target = pi.getPlayer().getClient().getChannelServer().getMapFactory().getMap(returnMap);\n     pi.getPlayer().changeMap(target);\n+    pi.playPortalSound();\n     return true;\n }\n\\ No newline at end of file"}, {"sha": "bd979c80bab9141d6d08f07d8639746f1a5fbcd8", "filename": "sql/db_drops.sql", "status": "modified", "additions": 466, "deletions": 0, "changes": 466, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -20765,6 +20765,472 @@ USE `heavenms`;\n (9400606, 4031348, 1, 1, 0, 100000),\n (9400606, 0, 25000, 30000, 0, 600000);\n \n+DELETE FROM temp_data WHERE dropperid >= 9300127 AND dropperid <= 9300136;\n+DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n+\n+# add CPQ items, CPQ specific items found thanks to Dragohe4rt\n+  INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n+(9300127, 2022157, 1, 1, 0, 200000),\n+(9300127, 2022158, 1, 1, 0, 200000),\n+(9300127, 2022159, 1, 1, 0, 200000),\n+(9300127, 2022160, 1, 1, 0, 200000),\n+(9300127, 2022161, 1, 1, 0, 200000),\n+(9300127, 2022162, 1, 1, 0, 200000),\n+(9300127, 2022163, 1, 1, 0, 200000),\n+(9300127, 2022164, 1, 1, 0, 200000),\n+(9300127, 2022165, 1, 1, 0, 200000),\n+(9300127, 2022166, 1, 1, 0, 200000),\n+(9300127, 2022167, 1, 1, 0, 200000),\n+(9300127, 2022168, 1, 1, 0, 200000),\n+(9300127, 2022169, 1, 1, 0, 200000),\n+(9300127, 2022170, 1, 1, 0, 200000),\n+(9300127, 2022171, 1, 1, 0, 200000),\n+(9300127, 2022172, 1, 1, 0, 200000),\n+(9300127, 2022173, 1, 1, 0, 200000),\n+(9300127, 2022174, 1, 1, 0, 200000),\n+(9300127, 2022175, 1, 1, 0, 200000),\n+(9300127, 2022176, 1, 1, 0, 200000),\n+(9300127, 2022177, 1, 1, 0, 200000),\n+(9300127, 2022178, 1, 1, 0, 200000),\n+(9300127, 4001129, 1, 1, 0, 12987),\n+(9300128, 2022157, 1, 1, 0, 200000),\n+(9300128, 2022158, 1, 1, 0, 200000),\n+(9300128, 2022159, 1, 1, 0, 200000),\n+(9300128, 2022160, 1, 1, 0, 200000),\n+(9300128, 2022161, 1, 1, 0, 200000),\n+(9300128, 2022162, 1, 1, 0, 200000),\n+(9300128, 2022163, 1, 1, 0, 200000),\n+(9300128, 2022164, 1, 1, 0, 200000),\n+(9300128, 2022165, 1, 1, 0, 200000),\n+(9300128, 2022166, 1, 1, 0, 200000),\n+(9300128, 2022167, 1, 1, 0, 200000),\n+(9300128, 2022168, 1, 1, 0, 200000),\n+(9300128, 2022169, 1, 1, 0, 200000),\n+(9300128, 2022170, 1, 1, 0, 200000),\n+(9300128, 2022171, 1, 1, 0, 200000),\n+(9300128, 2022172, 1, 1, 0, 200000),\n+(9300128, 2022173, 1, 1, 0, 200000),\n+(9300128, 2022174, 1, 1, 0, 200000),\n+(9300128, 2022175, 1, 1, 0, 200000),\n+(9300128, 2022176, 1, 1, 0, 200000),\n+(9300128, 2022177, 1, 1, 0, 200000),\n+(9300128, 2022178, 1, 1, 0, 200000),\n+(9300128, 4001129, 1, 1, 0, 12987),\n+(9300129, 2022157, 1, 1, 0, 200000),\n+(9300129, 2022158, 1, 1, 0, 200000),\n+(9300129, 2022159, 1, 1, 0, 200000),\n+(9300129, 2022160, 1, 1, 0, 200000),\n+(9300129, 2022161, 1, 1, 0, 200000),\n+(9300129, 2022162, 1, 1, 0, 200000),\n+(9300129, 2022163, 1, 1, 0, 200000),\n+(9300129, 2022164, 1, 1, 0, 200000),\n+(9300129, 2022165, 1, 1, 0, 200000),\n+(9300129, 2022166, 1, 1, 0, 200000),\n+(9300129, 2022167, 1, 1, 0, 200000),\n+(9300129, 2022168, 1, 1, 0, 200000),\n+(9300129, 2022169, 1, 1, 0, 200000),\n+(9300129, 2022170, 1, 1, 0, 200000),\n+(9300129, 2022171, 1, 1, 0, 200000),\n+(9300129, 2022172, 1, 1, 0, 200000),\n+(9300129, 2022173, 1, 1, 0, 200000),\n+(9300129, 2022174, 1, 1, 0, 200000),\n+(9300129, 2022175, 1, 1, 0, 200000),\n+(9300129, 2022176, 1, 1, 0, 200000),\n+(9300129, 2022177, 1, 1, 0, 200000),\n+(9300129, 2022178, 1, 1, 0, 200000),\n+(9300129, 4001129, 1, 1, 0, 12987),\n+(9300130, 2022157, 1, 1, 0, 200000),\n+(9300130, 2022158, 1, 1, 0, 200000),\n+(9300130, 2022159, 1, 1, 0, 200000),\n+(9300130, 2022160, 1, 1, 0, 200000),\n+(9300130, 2022161, 1, 1, 0, 200000),\n+(9300130, 2022162, 1, 1, 0, 200000),\n+(9300130, 2022163, 1, 1, 0, 200000),\n+(9300130, 2022164, 1, 1, 0, 200000),\n+(9300130, 2022165, 1, 1, 0, 200000),\n+(9300130, 2022166, 1, 1, 0, 200000),\n+(9300130, 2022167, 1, 1, 0, 200000),\n+(9300130, 2022168, 1, 1, 0, 200000),\n+(9300130, 2022169, 1, 1, 0, 200000),\n+(9300130, 2022170, 1, 1, 0, 200000),\n+(9300130, 2022171, 1, 1, 0, 200000),\n+(9300130, 2022172, 1, 1, 0, 200000),\n+(9300130, 2022173, 1, 1, 0, 200000),\n+(9300130, 2022174, 1, 1, 0, 200000),\n+(9300130, 2022175, 1, 1, 0, 200000),\n+(9300130, 2022176, 1, 1, 0, 200000),\n+(9300130, 2022177, 1, 1, 0, 200000),\n+(9300130, 2022178, 1, 1, 0, 200000),\n+(9300130, 4001129, 1, 1, 0, 12987),\n+(9300131, 2022157, 1, 1, 0, 200000),\n+(9300131, 2022158, 1, 1, 0, 200000),\n+(9300131, 2022159, 1, 1, 0, 200000),\n+(9300131, 2022160, 1, 1, 0, 200000),\n+(9300131, 2022161, 1, 1, 0, 200000),\n+(9300131, 2022162, 1, 1, 0, 200000),\n+(9300131, 2022163, 1, 1, 0, 200000),\n+(9300131, 2022164, 1, 1, 0, 200000),\n+(9300131, 2022165, 1, 1, 0, 200000),\n+(9300131, 2022166, 1, 1, 0, 200000),\n+(9300131, 2022167, 1, 1, 0, 200000),\n+(9300131, 2022168, 1, 1, 0, 200000),\n+(9300131, 2022169, 1, 1, 0, 200000),\n+(9300131, 2022170, 1, 1, 0, 200000),\n+(9300131, 2022171, 1, 1, 0, 200000),\n+(9300131, 2022172, 1, 1, 0, 200000),\n+(9300131, 2022173, 1, 1, 0, 200000),\n+(9300131, 2022174, 1, 1, 0, 200000),\n+(9300131, 2022175, 1, 1, 0, 200000),\n+(9300131, 2022176, 1, 1, 0, 200000),\n+(9300131, 2022177, 1, 1, 0, 200000),\n+(9300131, 2022178, 1, 1, 0, 200000),\n+(9300131, 4001129, 1, 1, 0, 12987),\n+(9300132, 2022157, 1, 1, 0, 200000),\n+(9300132, 2022158, 1, 1, 0, 200000),\n+(9300132, 2022159, 1, 1, 0, 200000),\n+(9300132, 2022160, 1, 1, 0, 200000),\n+(9300132, 2022161, 1, 1, 0, 200000),\n+(9300132, 2022162, 1, 1, 0, 200000),\n+(9300132, 2022163, 1, 1, 0, 200000),\n+(9300132, 2022164, 1, 1, 0, 200000),\n+(9300132, 2022165, 1, 1, 0, 200000),\n+(9300132, 2022166, 1, 1, 0, 200000),\n+(9300132, 2022167, 1, 1, 0, 200000),\n+(9300132, 2022168, 1, 1, 0, 200000),\n+(9300132, 2022169, 1, 1, 0, 200000),\n+(9300132, 2022170, 1, 1, 0, 200000),\n+(9300132, 2022171, 1, 1, 0, 200000),\n+(9300132, 2022172, 1, 1, 0, 200000),\n+(9300132, 2022173, 1, 1, 0, 200000),\n+(9300132, 2022174, 1, 1, 0, 200000),\n+(9300132, 2022175, 1, 1, 0, 200000),\n+(9300132, 2022176, 1, 1, 0, 200000),\n+(9300132, 2022177, 1, 1, 0, 200000),\n+(9300132, 2022178, 1, 1, 0, 200000),\n+(9300132, 4001129, 1, 1, 0, 12987),\n+(9300133, 2022157, 1, 1, 0, 200000),\n+(9300133, 2022158, 1, 1, 0, 200000),\n+(9300133, 2022159, 1, 1, 0, 200000),\n+(9300133, 2022160, 1, 1, 0, 200000),\n+(9300133, 2022161, 1, 1, 0, 200000),\n+(9300133, 2022162, 1, 1, 0, 200000),\n+(9300133, 2022163, 1, 1, 0, 200000),\n+(9300133, 2022164, 1, 1, 0, 200000),\n+(9300133, 2022165, 1, 1, 0, 200000),\n+(9300133, 2022166, 1, 1, 0, 200000),\n+(9300133, 2022167, 1, 1, 0, 200000),\n+(9300133, 2022168, 1, 1, 0, 200000),\n+(9300133, 2022169, 1, 1, 0, 200000),\n+(9300133, 2022170, 1, 1, 0, 200000),\n+(9300133, 2022171, 1, 1, 0, 200000),\n+(9300133, 2022172, 1, 1, 0, 200000),\n+(9300133, 2022173, 1, 1, 0, 200000),\n+(9300133, 2022174, 1, 1, 0, 200000),\n+(9300133, 2022175, 1, 1, 0, 200000),\n+(9300133, 2022176, 1, 1, 0, 200000),\n+(9300133, 2022177, 1, 1, 0, 200000),\n+(9300133, 2022178, 1, 1, 0, 200000),\n+(9300133, 4001129, 1, 1, 0, 12987),\n+(9300134, 2022157, 1, 1, 0, 200000),\n+(9300134, 2022158, 1, 1, 0, 200000),\n+(9300134, 2022159, 1, 1, 0, 200000),\n+(9300134, 2022160, 1, 1, 0, 200000),\n+(9300134, 2022161, 1, 1, 0, 200000),\n+(9300134, 2022162, 1, 1, 0, 200000),\n+(9300134, 2022163, 1, 1, 0, 200000),\n+(9300134, 2022164, 1, 1, 0, 200000),\n+(9300134, 2022165, 1, 1, 0, 200000),\n+(9300134, 2022166, 1, 1, 0, 200000),\n+(9300134, 2022167, 1, 1, 0, 200000),\n+(9300134, 2022168, 1, 1, 0, 200000),\n+(9300134, 2022169, 1, 1, 0, 200000),\n+(9300134, 2022170, 1, 1, 0, 200000),\n+(9300134, 2022171, 1, 1, 0, 200000),\n+(9300134, 2022172, 1, 1, 0, 200000),\n+(9300134, 2022173, 1, 1, 0, 200000),\n+(9300134, 2022174, 1, 1, 0, 200000),\n+(9300134, 2022175, 1, 1, 0, 200000),\n+(9300134, 2022176, 1, 1, 0, 200000),\n+(9300134, 2022177, 1, 1, 0, 200000),\n+(9300134, 2022178, 1, 1, 0, 200000),\n+(9300134, 4001129, 1, 1, 0, 12987),\n+(9300135, 2022157, 1, 1, 0, 200000),\n+(9300135, 2022158, 1, 1, 0, 200000),\n+(9300135, 2022159, 1, 1, 0, 200000),\n+(9300135, 2022160, 1, 1, 0, 200000),\n+(9300135, 2022161, 1, 1, 0, 200000),\n+(9300135, 2022162, 1, 1, 0, 200000),\n+(9300135, 2022163, 1, 1, 0, 200000),\n+(9300135, 2022164, 1, 1, 0, 200000),\n+(9300135, 2022165, 1, 1, 0, 200000),\n+(9300135, 2022166, 1, 1, 0, 200000),\n+(9300135, 2022167, 1, 1, 0, 200000),\n+(9300135, 2022168, 1, 1, 0, 200000),\n+(9300135, 2022169, 1, 1, 0, 200000),\n+(9300135, 2022170, 1, 1, 0, 200000),\n+(9300135, 2022171, 1, 1, 0, 200000),\n+(9300135, 2022172, 1, 1, 0, 200000),\n+(9300135, 2022173, 1, 1, 0, 200000),\n+(9300135, 2022174, 1, 1, 0, 200000),\n+(9300135, 2022175, 1, 1, 0, 200000),\n+(9300135, 2022176, 1, 1, 0, 200000),\n+(9300135, 2022177, 1, 1, 0, 200000),\n+(9300135, 2022178, 1, 1, 0, 200000),\n+(9300135, 4001129, 1, 1, 0, 12987),\n+(9300136, 2022157, 1, 1, 0, 200000),\n+(9300136, 2022158, 1, 1, 0, 200000),\n+(9300136, 2022159, 1, 1, 0, 200000),\n+(9300136, 2022160, 1, 1, 0, 200000),\n+(9300136, 2022161, 1, 1, 0, 200000),\n+(9300136, 2022162, 1, 1, 0, 200000),\n+(9300136, 2022163, 1, 1, 0, 200000),\n+(9300136, 2022164, 1, 1, 0, 200000),\n+(9300136, 2022165, 1, 1, 0, 200000),\n+(9300136, 2022166, 1, 1, 0, 200000),\n+(9300136, 2022167, 1, 1, 0, 200000),\n+(9300136, 2022168, 1, 1, 0, 200000),\n+(9300136, 2022169, 1, 1, 0, 200000),\n+(9300136, 2022170, 1, 1, 0, 200000),\n+(9300136, 2022171, 1, 1, 0, 200000),\n+(9300136, 2022172, 1, 1, 0, 200000),\n+(9300136, 2022173, 1, 1, 0, 200000),\n+(9300136, 2022174, 1, 1, 0, 200000),\n+(9300136, 2022175, 1, 1, 0, 200000),\n+(9300136, 2022176, 1, 1, 0, 200000),\n+(9300136, 2022177, 1, 1, 0, 200000),\n+(9300136, 2022178, 1, 1, 0, 200000),\n+(9300136, 4001129, 1, 1, 0, 12987),\n+(9300315, 2022157, 1, 1, 0, 200000),\n+(9300315, 2022158, 1, 1, 0, 200000),\n+(9300315, 2022159, 1, 1, 0, 200000),\n+(9300315, 2022160, 1, 1, 0, 200000),\n+(9300315, 2022161, 1, 1, 0, 200000),\n+(9300315, 2022162, 1, 1, 0, 200000),\n+(9300315, 2022163, 1, 1, 0, 200000),\n+(9300315, 2022164, 1, 1, 0, 200000),\n+(9300315, 2022165, 1, 1, 0, 200000),\n+(9300315, 2022166, 1, 1, 0, 200000),\n+(9300315, 2022167, 1, 1, 0, 200000),\n+(9300315, 2022168, 1, 1, 0, 200000),\n+(9300315, 2022169, 1, 1, 0, 200000),\n+(9300315, 2022170, 1, 1, 0, 200000),\n+(9300315, 2022171, 1, 1, 0, 200000),\n+(9300315, 2022172, 1, 1, 0, 200000),\n+(9300315, 2022173, 1, 1, 0, 200000),\n+(9300315, 2022174, 1, 1, 0, 200000),\n+(9300315, 2022175, 1, 1, 0, 200000),\n+(9300315, 2022176, 1, 1, 0, 200000),\n+(9300315, 2022177, 1, 1, 0, 200000),\n+(9300315, 2022178, 1, 1, 0, 200000),\n+(9300315, 4001129, 1, 1, 0, 12987),\n+(9300316, 2022157, 1, 1, 0, 200000),\n+(9300316, 2022158, 1, 1, 0, 200000),\n+(9300316, 2022159, 1, 1, 0, 200000),\n+(9300316, 2022160, 1, 1, 0, 200000),\n+(9300316, 2022161, 1, 1, 0, 200000),\n+(9300316, 2022162, 1, 1, 0, 200000),\n+(9300316, 2022163, 1, 1, 0, 200000),\n+(9300316, 2022164, 1, 1, 0, 200000),\n+(9300316, 2022165, 1, 1, 0, 200000),\n+(9300316, 2022166, 1, 1, 0, 200000),\n+(9300316, 2022167, 1, 1, 0, 200000),\n+(9300316, 2022168, 1, 1, 0, 200000),\n+(9300316, 2022169, 1, 1, 0, 200000),\n+(9300316, 2022170, 1, 1, 0, 200000),\n+(9300316, 2022171, 1, 1, 0, 200000),\n+(9300316, 2022172, 1, 1, 0, 200000),\n+(9300316, 2022173, 1, 1, 0, 200000),\n+(9300316, 2022174, 1, 1, 0, 200000),\n+(9300316, 2022175, 1, 1, 0, 200000),\n+(9300316, 2022176, 1, 1, 0, 200000),\n+(9300316, 2022177, 1, 1, 0, 200000),\n+(9300316, 2022178, 1, 1, 0, 200000),\n+(9300316, 4001129, 1, 1, 0, 12987),\n+(9300317, 2022157, 1, 1, 0, 200000),\n+(9300317, 2022158, 1, 1, 0, 200000),\n+(9300317, 2022159, 1, 1, 0, 200000),\n+(9300317, 2022160, 1, 1, 0, 200000),\n+(9300317, 2022161, 1, 1, 0, 200000),\n+(9300317, 2022162, 1, 1, 0, 200000),\n+(9300317, 2022163, 1, 1, 0, 200000),\n+(9300317, 2022164, 1, 1, 0, 200000),\n+(9300317, 2022165, 1, 1, 0, 200000),\n+(9300317, 2022166, 1, 1, 0, 200000),\n+(9300317, 2022167, 1, 1, 0, 200000),\n+(9300317, 2022168, 1, 1, 0, 200000),\n+(9300317, 2022169, 1, 1, 0, 200000),\n+(9300317, 2022170, 1, 1, 0, 200000),\n+(9300317, 2022171, 1, 1, 0, 200000),\n+(9300317, 2022172, 1, 1, 0, 200000),\n+(9300317, 2022173, 1, 1, 0, 200000),\n+(9300317, 2022174, 1, 1, 0, 200000),\n+(9300317, 2022175, 1, 1, 0, 200000),\n+(9300317, 2022176, 1, 1, 0, 200000),\n+(9300317, 2022177, 1, 1, 0, 200000),\n+(9300317, 2022178, 1, 1, 0, 200000),\n+(9300317, 4001129, 1, 1, 0, 12987),\n+(9300318, 2022157, 1, 1, 0, 200000),\n+(9300318, 2022158, 1, 1, 0, 200000),\n+(9300318, 2022159, 1, 1, 0, 200000),\n+(9300318, 2022160, 1, 1, 0, 200000),\n+(9300318, 2022161, 1, 1, 0, 200000),\n+(9300318, 2022162, 1, 1, 0, 200000),\n+(9300318, 2022163, 1, 1, 0, 200000),\n+(9300318, 2022164, 1, 1, 0, 200000),\n+(9300318, 2022165, 1, 1, 0, 200000),\n+(9300318, 2022166, 1, 1, 0, 200000),\n+(9300318, 2022167, 1, 1, 0, 200000),\n+(9300318, 2022168, 1, 1, 0, 200000),\n+(9300318, 2022169, 1, 1, 0, 200000),\n+(9300318, 2022170, 1, 1, 0, 200000),\n+(9300318, 2022171, 1, 1, 0, 200000),\n+(9300318, 2022172, 1, 1, 0, 200000),\n+(9300318, 2022173, 1, 1, 0, 200000),\n+(9300318, 2022174, 1, 1, 0, 200000),\n+(9300318, 2022175, 1, 1, 0, 200000),\n+(9300318, 2022176, 1, 1, 0, 200000),\n+(9300318, 2022177, 1, 1, 0, 200000),\n+(9300318, 2022178, 1, 1, 0, 200000),\n+(9300318, 4001129, 1, 1, 0, 12987),\n+(9300319, 2022157, 1, 1, 0, 200000),\n+(9300319, 2022158, 1, 1, 0, 200000),\n+(9300319, 2022159, 1, 1, 0, 200000),\n+(9300319, 2022160, 1, 1, 0, 200000),\n+(9300319, 2022161, 1, 1, 0, 200000),\n+(9300319, 2022162, 1, 1, 0, 200000),\n+(9300319, 2022163, 1, 1, 0, 200000),\n+(9300319, 2022164, 1, 1, 0, 200000),\n+(9300319, 2022165, 1, 1, 0, 200000),\n+(9300319, 2022166, 1, 1, 0, 200000),\n+(9300319, 2022167, 1, 1, 0, 200000),\n+(9300319, 2022168, 1, 1, 0, 200000),\n+(9300319, 2022169, 1, 1, 0, 200000),\n+(9300319, 2022170, 1, 1, 0, 200000),\n+(9300319, 2022171, 1, 1, 0, 200000),\n+(9300319, 2022172, 1, 1, 0, 200000),\n+(9300319, 2022173, 1, 1, 0, 200000),\n+(9300319, 2022174, 1, 1, 0, 200000),\n+(9300319, 2022175, 1, 1, 0, 200000),\n+(9300319, 2022176, 1, 1, 0, 200000),\n+(9300319, 2022177, 1, 1, 0, 200000),\n+(9300319, 2022178, 1, 1, 0, 200000),\n+(9300319, 4001129, 1, 1, 0, 12987),\n+(9300320, 2022157, 1, 1, 0, 200000),\n+(9300320, 2022158, 1, 1, 0, 200000),\n+(9300320, 2022159, 1, 1, 0, 200000),\n+(9300320, 2022160, 1, 1, 0, 200000),\n+(9300320, 2022161, 1, 1, 0, 200000),\n+(9300320, 2022162, 1, 1, 0, 200000),\n+(9300320, 2022163, 1, 1, 0, 200000),\n+(9300320, 2022164, 1, 1, 0, 200000),\n+(9300320, 2022165, 1, 1, 0, 200000),\n+(9300320, 2022166, 1, 1, 0, 200000),\n+(9300320, 2022167, 1, 1, 0, 200000),\n+(9300320, 2022168, 1, 1, 0, 200000),\n+(9300320, 2022169, 1, 1, 0, 200000),\n+(9300320, 2022170, 1, 1, 0, 200000),\n+(9300320, 2022171, 1, 1, 0, 200000),\n+(9300320, 2022172, 1, 1, 0, 200000),\n+(9300320, 2022173, 1, 1, 0, 200000),\n+(9300320, 2022174, 1, 1, 0, 200000),\n+(9300320, 2022175, 1, 1, 0, 200000),\n+(9300320, 2022176, 1, 1, 0, 200000),\n+(9300320, 2022177, 1, 1, 0, 200000),\n+(9300320, 2022178, 1, 1, 0, 200000),\n+(9300320, 4001129, 1, 1, 0, 12987),\n+(9300321, 2022157, 1, 1, 0, 200000),\n+(9300321, 2022158, 1, 1, 0, 200000),\n+(9300321, 2022159, 1, 1, 0, 200000),\n+(9300321, 2022160, 1, 1, 0, 200000),\n+(9300321, 2022161, 1, 1, 0, 200000),\n+(9300321, 2022162, 1, 1, 0, 200000),\n+(9300321, 2022163, 1, 1, 0, 200000),\n+(9300321, 2022164, 1, 1, 0, 200000),\n+(9300321, 2022165, 1, 1, 0, 200000),\n+(9300321, 2022166, 1, 1, 0, 200000),\n+(9300321, 2022167, 1, 1, 0, 200000),\n+(9300321, 2022168, 1, 1, 0, 200000),\n+(9300321, 2022169, 1, 1, 0, 200000),\n+(9300321, 2022170, 1, 1, 0, 200000),\n+(9300321, 2022171, 1, 1, 0, 200000),\n+(9300321, 2022172, 1, 1, 0, 200000),\n+(9300321, 2022173, 1, 1, 0, 200000),\n+(9300321, 2022174, 1, 1, 0, 200000),\n+(9300321, 2022175, 1, 1, 0, 200000),\n+(9300321, 2022176, 1, 1, 0, 200000),\n+(9300321, 2022177, 1, 1, 0, 200000),\n+(9300321, 2022178, 1, 1, 0, 200000),\n+(9300321, 4001129, 1, 1, 0, 12987),\n+(9300322, 2022157, 1, 1, 0, 200000),\n+(9300322, 2022158, 1, 1, 0, 200000),\n+(9300322, 2022159, 1, 1, 0, 200000),\n+(9300322, 2022160, 1, 1, 0, 200000),\n+(9300322, 2022161, 1, 1, 0, 200000),\n+(9300322, 2022162, 1, 1, 0, 200000),\n+(9300322, 2022163, 1, 1, 0, 200000),\n+(9300322, 2022164, 1, 1, 0, 200000),\n+(9300322, 2022165, 1, 1, 0, 200000),\n+(9300322, 2022166, 1, 1, 0, 200000),\n+(9300322, 2022167, 1, 1, 0, 200000),\n+(9300322, 2022168, 1, 1, 0, 200000),\n+(9300322, 2022169, 1, 1, 0, 200000),\n+(9300322, 2022170, 1, 1, 0, 200000),\n+(9300322, 2022171, 1, 1, 0, 200000),\n+(9300322, 2022172, 1, 1, 0, 200000),\n+(9300322, 2022173, 1, 1, 0, 200000),\n+(9300322, 2022174, 1, 1, 0, 200000),\n+(9300322, 2022175, 1, 1, 0, 200000),\n+(9300322, 2022176, 1, 1, 0, 200000),\n+(9300322, 2022177, 1, 1, 0, 200000),\n+(9300322, 2022178, 1, 1, 0, 200000),\n+(9300322, 4001129, 1, 1, 0, 12987),\n+(9300323, 2022157, 1, 1, 0, 200000),\n+(9300323, 2022158, 1, 1, 0, 200000),\n+(9300323, 2022159, 1, 1, 0, 200000),\n+(9300323, 2022160, 1, 1, 0, 200000),\n+(9300323, 2022161, 1, 1, 0, 200000),\n+(9300323, 2022162, 1, 1, 0, 200000),\n+(9300323, 2022163, 1, 1, 0, 200000),\n+(9300323, 2022164, 1, 1, 0, 200000),\n+(9300323, 2022165, 1, 1, 0, 200000),\n+(9300323, 2022166, 1, 1, 0, 200000),\n+(9300323, 2022167, 1, 1, 0, 200000),\n+(9300323, 2022168, 1, 1, 0, 200000),\n+(9300323, 2022169, 1, 1, 0, 200000),\n+(9300323, 2022170, 1, 1, 0, 200000),\n+(9300323, 2022171, 1, 1, 0, 200000),\n+(9300323, 2022172, 1, 1, 0, 200000),\n+(9300323, 2022173, 1, 1, 0, 200000),\n+(9300323, 2022174, 1, 1, 0, 200000),\n+(9300323, 2022175, 1, 1, 0, 200000),\n+(9300323, 2022176, 1, 1, 0, 200000),\n+(9300323, 2022177, 1, 1, 0, 200000),\n+(9300323, 2022178, 1, 1, 0, 200000),\n+(9300323, 4001129, 1, 1, 0, 12987),\n+(9300324, 2022157, 1, 1, 0, 200000),\n+(9300324, 2022158, 1, 1, 0, 200000),\n+(9300324, 2022159, 1, 1, 0, 200000),\n+(9300324, 2022160, 1, 1, 0, 200000),\n+(9300324, 2022161, 1, 1, 0, 200000),\n+(9300324, 2022162, 1, 1, 0, 200000),\n+(9300324, 2022163, 1, 1, 0, 200000),\n+(9300324, 2022164, 1, 1, 0, 200000),\n+(9300324, 2022165, 1, 1, 0, 200000),\n+(9300324, 2022166, 1, 1, 0, 200000),\n+(9300324, 2022167, 1, 1, 0, 200000),\n+(9300324, 2022168, 1, 1, 0, 200000),\n+(9300324, 2022169, 1, 1, 0, 200000),\n+(9300324, 2022170, 1, 1, 0, 200000),\n+(9300324, 2022171, 1, 1, 0, 200000),\n+(9300324, 2022172, 1, 1, 0, 200000),\n+(9300324, 2022173, 1, 1, 0, 200000),\n+(9300324, 2022174, 1, 1, 0, 200000),\n+(9300324, 2022175, 1, 1, 0, 200000),\n+(9300324, 2022176, 1, 1, 0, 200000),\n+(9300324, 2022177, 1, 1, 0, 200000),\n+(9300324, 2022178, 1, 1, 0, 200000),\n+(9300324, 4001129, 1, 1, 0, 12987);\n+\n   CREATE TABLE IF NOT EXISTS `drop_data` (\n     `id` bigint(20) NOT NULL AUTO_INCREMENT,\n     `dropperid` int(11) NOT NULL,"}, {"sha": "6fe61df5df619d289a58d0d007fd55317ec68e44", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 26, "deletions": 41, "changes": 67, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -68,6 +68,7 @@\n import server.CashShop;\n import server.MapleItemInformationProvider;\n import server.MapleItemInformationProvider.ScriptedItem;\n+import server.MapleMarriage;\n import server.MaplePortal;\n import server.MapleShop;\n import server.MapleStatEffect;\n@@ -130,7 +131,7 @@\n import constants.ExpTable;\n import constants.GameConstants;\n import constants.ItemConstants;\n-import constants.LinguaConstants;\n+import constants.LanguageConstants;\n import constants.ServerConstants;\n import constants.skills.Aran;\n import constants.skills.Beginner;\n@@ -166,6 +167,7 @@\n import server.maps.MapleMapItem;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import scripting.AbstractPlayerInteraction;\n \n public class MapleCharacter extends AbstractMapleCharacterObject {\n     private static final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n@@ -277,7 +279,7 @@\n     private ScheduledFuture<?> extraRecoveryTask = null;\n     private ScheduledFuture<?> chairRecoveryTask = null;\n     private ScheduledFuture<?> pendantOfSpirit = null; //1122017\n-    public ScheduledFuture<?> timer;\n+    private ScheduledFuture<?> cpqSchedule = null;\n     private Lock chrLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_CHR, true);\n     private Lock evtLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_EVT, true);\n     private Lock petLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PET, true);\n@@ -4383,6 +4385,16 @@ public EventInstanceManager getEventInstance() {\n             evtLock.unlock();\n         }\n     }\n+    \n+    public MapleMarriage getMarriageInstance() {\n+        EventInstanceManager eim = getEventInstance();\n+        \n+        if (eim != null || !(eim instanceof MapleMarriage)) {\n+            return (MapleMarriage) eim;\n+        } else {\n+            return null;\n+        }\n+    }\n \n     public void resetExcluded(int petId) {\n         chrLock.lock();\n@@ -9848,6 +9860,15 @@ public void setPartyQuest(PartyQuest pq) {\n         this.partyQuest = pq;\n     }\n \n+    public void setCpqTimer(ScheduledFuture timer) {\n+        this.cpqSchedule = timer;\n+    }\n+    \n+    public void clearCpqTimer() {\n+        if (cpqSchedule != null) { cpqSchedule.cancel(true); }\n+        cpqSchedule = null;\n+    }\n+    \n     public final void empty(final boolean remove) {\n         if (dragonBloodSchedule != null) { dragonBloodSchedule.cancel(true); }\n         dragonBloodSchedule = null;\n@@ -9886,8 +9907,7 @@ public final void empty(final boolean remove) {\n         if (pendantOfSpirit != null) { pendantOfSpirit.cancel(true); }\n         pendantOfSpirit = null;\n         \n-        if (timer != null) { timer.cancel(true); }\n-        timer = null;\n+        clearCpqTimer();\n         \n         evtLock.lock();\n         try {\n@@ -10130,9 +10150,7 @@ public void executeReborn() {\n     private MapleFitness fitness;\n     private MapleOla ola;\n     private long snowballattack;\n-    public static final List<String> itens = new ArrayList();\n-    public static final List<Item> item = new ArrayList();\n-\n+    \n     public byte getTeam() {\n         return team;\n     }\n@@ -10289,38 +10307,5 @@ public void setLingua(int num) {\n     public int getLingua() {\n         return getClient().getLingua();\n     }\n-\n-    public void setItens(String item) {\n-        if (!itens.contains(item)) {\n-            this.itens.add(item);\n-        }\n-    }\n-\n-    public static List<String> getItens() {\n-        return itens;\n-    }\n-\n-    public void setEquips(Item item) {\n-        this.item.add(item);\n-    }\n-\n-    public static List<Item> getItem() {\n-        return item;\n-    }\n-\n-    public Item getItemid(int numb) {\n-        return this.item.get(numb);\n-    }\n-\n-    public void removeItem(Item item) {\n-        if (this.item.contains(item)) {\n-            this.item.remove(item);\n-        }\n-    }\n-\n-    public void obterItens() {\n-        for (Item item : getItem()) {\n-            getClient().getAbstractPlayerInteraction().gainItem(item.getItemId(), item.getQuantity());\n-        }\n-    }\n+    \n }\n\\ No newline at end of file"}, {"sha": "e9daf175df48a91554207a2f72fecf51d5908516", "filename": "src/client/MapleDisease.java", "status": "modified", "additions": 16, "deletions": 17, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/MapleDisease.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/MapleDisease.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleDisease.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -21,7 +21,7 @@\n */\n package client;\n \n-import tools.Randomizer;\n+import constants.GameConstants;\n \n public enum MapleDisease {\n     NULL(0x0),\n@@ -39,28 +39,32 @@\n     \n     private long i;\n     private boolean first;\n-    private int disease;\n+    private int mobskill;\n     \n     private MapleDisease(long i) {\n-        this.i = i;\n-        this.first = false;\n+        this(i, false, 0);\n     }\n \n-    private MapleDisease(long i, int disease) {\n+    private MapleDisease(long i, int skill) {\n+        this(i, false, skill);\n+    }\n+    \n+    private MapleDisease(long i, boolean first, int skill) {\n         this.i = i;\n-        this.disease = disease;\n+        this.first = first;\n+        this.mobskill = skill;\n     }\n     \n     public long getValue() {\n         return i;\n     }\n \n     public boolean isFirst() {\n-            return first;\n+        return first;\n     }\n-\n+    \n     public int getDisease() {\n-        return disease;\n+        return mobskill;\n     }\n     \n     public static MapleDisease ordinal(int ord) {\n@@ -72,13 +76,8 @@ public static MapleDisease ordinal(int ord) {\n     }\n     \n     public static final MapleDisease getRandom() {\n-        while (true) {\n-            for (MapleDisease dis : MapleDisease.values()) {\n-                if (Randomizer.nextInt(MapleDisease.values().length) == 0) {\n-                    return dis;\n-                }\n-            }\n-        }\n+        MapleDisease[] diseases = GameConstants.CPQ_DISEASES;\n+        return diseases[(int) (Math.random() * diseases.length)];\n     }\n     \n     public static final MapleDisease getBySkill(final int skill) {\n@@ -90,4 +89,4 @@ public static final MapleDisease getBySkill(final int skill) {\n         return null;\n     }\n     \n-}\n+}\n\\ No newline at end of file"}, {"sha": "b41946469fb786443466fbe7c75d2932b5920826", "filename": "src/client/inventory/ItemFactory.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/inventory/ItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/inventory/ItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ItemFactory.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -45,7 +45,8 @@\n     CASH_CYGNUS(4, true),\n     CASH_ARAN(5, true),\n     MERCHANT(6, false),\n-    CASH_OVERALL(7, true);\n+    CASH_OVERALL(7, true),\n+    MARRIAGE_GIFTS(8, false);\n     private final int value;\n     private final boolean account;\n     private static final Lock locks[] = new Lock[200];  // thanks Masterrulax for pointing out a bottleneck issue here"}, {"sha": "fbc1fea6f7337d5d11e0c4bdfc6bf7eb0b968dbf", "filename": "src/client/inventory/MapleInventory.java", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/inventory/MapleInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/client/inventory/MapleInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventory.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -436,7 +436,16 @@ public short getNumFreeSlot() {\n     }\n     \n     public static boolean checkSpot(MapleCharacter chr, Item item) {    // thanks Vcoc for noticing pshops not checking item stacks when taking item back\n-        return checkSpotsAndOwnership(chr, Collections.singletonList(new Pair<>(item, item.getInventoryType())));\n+        return checkSpot(chr, Collections.singletonList(item));\n+    }\n+    \n+    public static boolean checkSpot(MapleCharacter chr, List<Item> items) {\n+        List<Pair<Item, MapleInventoryType>> listItems = new LinkedList<>();\n+        for (Item item : items) {\n+            listItems.add(new Pair<>(item, item.getInventoryType()));\n+        }\n+        \n+        return checkSpotsAndOwnership(chr, listItems);\n     }\n     \n     public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items) {"}, {"sha": "2c57b219ace085a92c7da2a40107baa34414a178", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,5 +1,6 @@\n package constants;\n \n+import client.MapleDisease;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.HashMap;\n@@ -33,6 +34,9 @@\n     private final static NumberFormat nfFormatter = new DecimalFormat(\"#,###,###,###\");\n     private final static NumberFormat nfParser = NumberFormat.getInstance(ServerConstants.USE_UNITPRICE_WITH_COMMA ? Locale.FRANCE : Locale.UK);\n     \n+    public static final MapleDisease[] CPQ_DISEASES = {MapleDisease.SLOW, MapleDisease.SEDUCE, MapleDisease.STUN, MapleDisease.POISON,\n+                                                       MapleDisease.SEAL, MapleDisease.DARKNESS, MapleDisease.WEAKEN, MapleDisease.CURSE};\n+    \n     public static int getPlayerBonusDropRate(int slot) {\n         return(DROP_RATE_GAIN[slot]);\n     }"}, {"sha": "4f8dabc6ab975dd3cf5d28d1c395eb3795b96121", "filename": "src/constants/LanguageConstants.java", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/LanguageConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/LanguageConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/LanguageConstants.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -0,0 +1,73 @@\n+package constants;\n+\n+import client.MapleCharacter;\n+\n+/**\n+ *\n+ * @author Drago - Dragohe4rt\n+ */\n+public class LanguageConstants {\n+\t// Portugues\n+    public static String CPQAzul;\n+    public static String CPQErro;\n+    public static String CPQEntrada;\n+    public static String CPQEscolha;\n+    public static String CPQVermelho;\n+    public static String CPQPlayerExit;\n+    public static String CPQEntradaLobby;\n+    public static String CPQInicioEscolha;\n+    public static String CPQTempoExtendido;\n+    public static String CPQLiderNaoEncontrado;\n+    public static String CPQInicioEscolhaEmEscolha;\n+    public static String CPQInicioEscolhaEnviada;\n+\n+    public static LanguageConstants Linguas(MapleCharacter chr) {\n+        if (chr.getLingua() == 0) {\n+            LanguageConstants.CPQAzul = \"Maple Azul\";\n+            LanguageConstants.CPQVermelho = \"Maple Vermelho\";\n+            LanguageConstants.CPQTempoExtendido = \"O tempo foi estendido.\";\n+            LanguageConstants.CPQPlayerExit = \" deixou o Carnaval de Monstros.\";\n+            LanguageConstants.CPQErro = \"Ocorreu um problema. Favor recriar a sala.\";\n+            LanguageConstants.CPQLiderNaoEncontrado = \"Nao foi possivel encontrar o Lider.\";\n+            LanguageConstants.CPQInicioEscolha = \"Inscreva-se no Festival de Monstros!\\\\r\\\\n\";            \n+            LanguageConstants.CPQInicioEscolhaEmEscolha = \"O grupo esta respondendo um desafio no momento.\";\n+            LanguageConstants.CPQInicioEscolhaEnviada = \"Um desafio foi enviado para o grupo na sala. Aguarde um momento.\";\n+            LanguageConstants.CPQEscolha = \"Nao foi possivel encontrar um grupo nesta sala.\\\\r\\\\nProvavelmente o grupo foi desfeito dentro da sala!\";\n+            LanguageConstants.CPQEntradaLobby = \"Agora voce ira receber desafios de outros grupos. Se voce nao aceitar um desafio em 3 minutos, voce sera levado para fora.\";\n+            LanguageConstants.CPQEntrada = \"Voce pode selecionar \\\"Invocar Monstros\\\", \\\"Habilidade\\\", ou \\\"Protetor\\\" como sua tatica durante o Carnaval dos Monstros. Use Tab a F1~F12 para acesso rapido!\";\n+\n+            \n+            \n+        } else if (chr.getLingua() == 1) {\n+            LanguageConstants.CPQAzul = \"Maple Azul\";\n+            LanguageConstants.CPQVermelho = \"Maple Rojo\";\n+            LanguageConstants.CPQTempoExtendido = \"El tiempo se ha ampliado.\";\n+            LanguageConstants.CPQPlayerExit = \" ha dejado el Carnaval de Monstruos.\";\n+            LanguageConstants.CPQLiderNaoEncontrado = \"No se pudo encontrar el Lider.\";\n+            LanguageConstants.CPQInicioEscolha = \"!Inscribete en el Festival de Monstruos!\\\\r\\\\n\";\n+            LanguageConstants.CPQErro = \"Se ha producido un problema. Por favor, volver a crear una sala.\";\n+            LanguageConstants.CPQInicioEscolhaEmEscolha = \"El grupo esta respondiendo un desafio en el momento.\";\n+            LanguageConstants.CPQInicioEscolhaEnviada = \"Un desafio fue enviado al grupo en la sala. Espera un momento.\";\n+            LanguageConstants.CPQEscolha = \"No se pudo encontrar un grupo en esta sala.\\\\r\\\\nProbablemente el grupo fue deshecho dentro de la sala!\";\n+            LanguageConstants.CPQEntradaLobby = \"Ahora usted recibira los retos de otros grupos. Si usted no acepta un desafio en 3 minutos, usted sera llevado hacia fuera.\";\n+            LanguageConstants.CPQEntrada = \"Usted puede seleccionar \\\"Invocar Monstruos \\\", \\\"Habilidad \\\", o \\\"Protector \\\" como su tactica durante el Carnaval de los Monstruos. Utilice Tab y F1 ~ F12 para acceso rapido!\";\n+\n+            \n+        } else if (chr.getLingua() == 2) {\n+            LanguageConstants.CPQAzul = \"Maple Blue\";\n+            LanguageConstants.CPQVermelho = \"Maple Red\";\n+            LanguageConstants.CPQPlayerExit = \" left the Carnival of Monsters.\";\n+            LanguageConstants.CPQTempoExtendido = \"The time has been extended.\";\n+            LanguageConstants.CPQLiderNaoEncontrado = \"Could not find the Leader.\";\n+            LanguageConstants.CPQErro = \"There was a problem. Please re-create a room.\";\n+            LanguageConstants.CPQInicioEscolha = \"Sign up for the Monster Festival!\\\\r\\\\n\";\n+            LanguageConstants.CPQInicioEscolhaEmEscolha = \"The group is currently facing a challenge.\";\n+            LanguageConstants.CPQInicioEscolhaEnviada = \"A challenge has been sent to the group in the room. Please wait a while.\";\n+            LanguageConstants.CPQEscolha = \"We could not find a group in this room.\\\\r\\\\nProbably the group was scrapped inside the room!\";\n+            LanguageConstants.CPQEntradaLobby = \"You will now receive challenges from other groups. If you do not accept a challenge within 3 minutes, you will be taken out.\";\n+            LanguageConstants.CPQEntrada = \"You can select \\\"Summon Monsters \\\", \\\"Ability \\\", or \\\"Protector \\\" as your tactic during the Monster Carnival. Use Tab and F1 ~ F12 for quick access!\";\n+            \n+        }\n+        return null;\n+    }\n+}"}, {"sha": "af1089d60eb598fffffb81983b4424d45f992ce0", "filename": "src/constants/LinguaConstants.java", "status": "removed", "additions": 0, "deletions": 69, "changes": 69, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1383efd6c36a63b493645eff1e9c4b00443216f2/src/constants/LinguaConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1383efd6c36a63b493645eff1e9c4b00443216f2/src/constants/LinguaConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/LinguaConstants.java?ref=1383efd6c36a63b493645eff1e9c4b00443216f2", "patch": "@@ -1,69 +0,0 @@\n-package constants;\n-\n-import client.MapleCharacter;\n-\n-/**\n- *\n- * @author Drago - Dragohe4rt\n- */\n-public class LinguaConstants {\n-\t// Portugues\n-    public static String CPQAzul;\n-    public static String CPQErro;\n-    public static String CPQEntrada;\n-    public static String CPQEscolha;\n-    public static String CPQVermelho;\n-    public static String CPQPlayerExit;\n-    public static String CPQEntradaLobby;\n-    public static String CPQInicioEscolha;\n-    public static String CPQTempoExtendido;\n-    public static String CPQLiderNaoEncontrado;\n-    public static String CPQInicioEscolhaEmEscolha;\n-\n-    public static LinguaConstants Linguas(MapleCharacter chr) {\n-        if (chr.getLingua() == 0) {\n-            LinguaConstants.CPQAzul = \"Maple Azul\";\n-            LinguaConstants.CPQVermelho = \"Maple Vermelho\";\n-            LinguaConstants.CPQTempoExtendido = \"O tempo foi estendido.\";\n-            LinguaConstants.CPQPlayerExit = \" deixou o Carnaval de Monstros.\";\n-            LinguaConstants.CPQErro = \"Ocorreu um problema. Favor recriar a sala.\";\n-            LinguaConstants.CPQLiderNaoEncontrado = \"N\ufffdo foi poss\ufffdvel encontrar o Lider.\";\n-            LinguaConstants.CPQInicioEscolha = \"Inscreva-se no Festival de Monstros!\\\\r\\\\n\";            \n-            LinguaConstants.CPQInicioEscolhaEmEscolha = \"O grupo esta respondendo um desafio no momento.\";\n-            LinguaConstants.CPQEscolha = \"N\ufffdo foi poss\ufffdvel encontrar um grupo nesta sala.\\\\r\\\\nProvavelmente o grupo foi desfeito dentro da sala!\";\n-            LinguaConstants.CPQEntradaLobby = \"[CPQ MapleStorySA] Agora voc\ufffd ir\ufffd receber desafios de outros grupos. Se voc\ufffd n\ufffdo aceitar um desafio em 3 minutos, voc\ufffd ser\ufffd levado para fora.\";\n-            LinguaConstants.CPQEntrada = \"Voc\ufffd pode selecionar \\\"Invocar Monstros\\\", \\\"Habilidade\\\", ou \\\"Protetor\\\" como sua t\ufffdtica durante o Carnaval dos Monstros. Use Tab a F1~F12 para acesso r\ufffdpido!\";\n-\n-            \n-            \n-        } else if (chr.getLingua() == 1) {\n-            LinguaConstants.CPQAzul = \"Maple Azul\";\n-            LinguaConstants.CPQVermelho = \"Maple Rojo\";\n-            LinguaConstants.CPQTempoExtendido = \"El tiempo se ha ampliado.\";\n-            LinguaConstants.CPQPlayerExit = \" ha dejado el Carnaval de Monstruos.\";\n-            LinguaConstants.CPQLiderNaoEncontrado = \"No se pudo encontrar el Lider.\";\n-            LinguaConstants.CPQInicioEscolha = \"\ufffdInscr\ufffdbete en el Festival de Monstruos!\\\\r\\\\n\";\n-            LinguaConstants.CPQErro = \"Se ha producido un problema. Por favor, volver a crear una sala.\";\n-            LinguaConstants.CPQInicioEscolhaEmEscolha = \"El grupo esta respondiendo un desaf\ufffdo en el momento.\";\n-            LinguaConstants.CPQEscolha = \"No se pudo encontrar un grupo en esta sala.\\\\r\\\\nProbablemente el grupo fue deshecho dentro de la sala!\";\n-            LinguaConstants.CPQEntradaLobby = \"[CPQ MapleStorySA] Ahora usted recibir\ufffd los retos de otros grupos. Si usted no acepta un desaf\ufffdo en 3 minutos, usted ser\ufffd llevado hacia fuera.\";\n-            LinguaConstants.CPQEntrada = \"Usted puede seleccionar \\\"Invocar Monstruos \\\", \\\"Habilidad \\\", o \\\"Protector \\\" como su t\ufffdctica durante el Carnaval de los Monstruos. Utilice Tab y F1 ~ F12 para acceso r\ufffdpido!\";\n-\n-            \n-        } else if (chr.getLingua() == 2) {\n-            LinguaConstants.CPQAzul = \"Maple Blue\";\n-            LinguaConstants.CPQVermelho = \"Maple Red\";\n-            LinguaConstants.CPQPlayerExit = \" left the Carnival of Monsters.\";\n-            LinguaConstants.CPQTempoExtendido = \"The time has been extended.\";\n-            LinguaConstants.CPQLiderNaoEncontrado = \"Could not find the Leader.\";\n-            LinguaConstants.CPQErro = \"There was a problem. Please re-create a room.\";\n-            LinguaConstants.CPQInicioEscolha = \"Sign up for the Monster Festival!\\\\r\\\\n\";\n-            LinguaConstants.CPQInicioEscolhaEmEscolha = \"The group is currently facing a challenge.\";\n-            LinguaConstants.CPQEscolha = \"We could not find a group in this room.\\\\r\\\\nProbably the group was scrapped inside the room!\";\n-            LinguaConstants.CPQEntradaLobby = \"[CPQ MapleStorySA] You will now receive challenges from other groups. If you do not accept a challenge within 3 minutes, you will be taken out.\";\n-            LinguaConstants.CPQEntrada = \"You can select \\\"Summon Monsters \\\", \\\"Ability \\\", or \\\"Protector \\\" as your tactic during the Monster Carnival. Use Tab and F1 ~ F12 for quick access!\";\n-            \n-        }\n-        return null;\n-    }\n-}"}, {"sha": "1268c7faa085d927688121f693ea2f4ee18e1531", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -34,7 +34,7 @@\n     public static final int BYPASS_PIC_EXPIRATION = 20;         //Enables PIC bypass, which will remain active for that account by that client machine for N minutes. Set 0 to disable.\n     public static final int BYPASS_PIN_EXPIRATION = 15;         //Enables PIN bypass, which will remain active for that account by that client machine for N minutes. Set 0 to disable.\n     \n-    public static final boolean AUTOMATIC_REGISTER = false;      //Automatically register players when they login with a nonexistent username.\n+    public static final boolean AUTOMATIC_REGISTER = true;      //Automatically register players when they login with a nonexistent username.\n     public static final boolean BCRYPT_MIGRATION = true;        //Performs a migration from old SHA-1 and SHA-512 password to bcrypt.\n     public static final boolean COLLECTIVE_CHARSLOT = false;    //Available character slots are contabilized globally rather than per world server.\n     public static final boolean DETERRED_MULTICLIENT = false;   //Enables multi-client and suspicious remote IP detection on the login system.\n@@ -59,7 +59,7 @@\n     public static final boolean USE_CUSTOM_KEYSET = true;           //Enables auto-setup of the HeavenMS's custom keybindings when creating characters.\n     public static final boolean USE_DEBUG = false;                  //Will enable some text prints on the client, oriented for debugging purposes.\n     public static final boolean USE_DEBUG_SHOW_INFO_EQPEXP = false; //Prints on the cmd all equip exp gain info.\n-    public static       boolean USE_DEBUG_SHOW_RCVD_PACKET = true; //Prints on the cmd all received packet ids.\n+    public static       boolean USE_DEBUG_SHOW_RCVD_PACKET = false; //Prints on the cmd all received packet ids.\n     public static       boolean USE_DEBUG_SHOW_RCVD_MVLIFE = false; //Prints on the cmd all received move life content.\n     public static       boolean USE_SUPPLY_RATE_COUPONS = true;     //Allows rate coupons to be sold through the Cash Shop.\n     \n@@ -277,6 +277,7 @@\n     public static final int WEDDING_RESERVATION_TIMEOUT = 10;   //Limit time in minutes for the couple to show up before cancelling the wedding reservation.\n     public static final int WEDDING_RESERVATION_INTERVAL = 60;  //Time between wedding starts in minutes.\n     public static final int WEDDING_BLESS_EXP = 30000;          //Exp gained per bless count.\n+    public static final int WEDDING_GIFT_LIMIT = 1;             //Max number of gifts per person to same wishlist on marriage instances.\n     public static final boolean WEDDING_BLESSER_SHOWFX = true;  //Pops bubble sprite effect on players blessing the couple. Setting this false shows the blessing effect on the couple instead.\n \n     //Buyback Configuration"}, {"sha": "16c78e6a807225c052f572ba80d0a9a660777341", "filename": "src/net/server/channel/handlers/MonsterCarnivalHandler.java", "status": "modified", "additions": 59, "deletions": 47, "changes": 106, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MonsterCarnivalHandler.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -33,6 +33,7 @@\n import server.life.MapleMonster;\n import server.partyquest.MapleCarnivalFactory;\n import server.partyquest.MapleCarnivalFactory.MCSkill;\n+import server.partyquest.MonsterCarnival;\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -46,87 +47,95 @@\n \n     @Override\n     public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        c.tryacquireClient();\n         try {\n-            int tab = slea.readByte();\n-            int num = slea.readByte();\n-            int neededCP = 0;\n-            if (tab == 0) { \n-                final List<Pair<Integer, Integer>> mobs = c.getPlayer().getMap().getMobsToSpawn();\n-                if (num >= mobs.size() || c.getPlayer().getCP() < mobs.get(num).right) {\n-                    c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n-                    c.getSession().write(MaplePacketCreator.enableActions());\n-                    return;\n-                }\n-\n-                final MapleMonster mob = MapleLifeFactory.getMonster(mobs.get(num).left);\n-                if (c.getPlayer().getMonsterCarnival() != null) {\n-                    Point spawnPos = c.getPlayer().getMap().getRandomSP(c.getPlayer().getTeam());\n-                    if (!c.getPlayer().getMonsterCarnival().canSummon() && c.getPlayer().getTeam() == 0 || !c.getPlayer().getMonsterCarnival().canSummons() && c.getPlayer().getTeam() == 1) {\n-                        c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+            try {\n+                int tab = slea.readByte();\n+                int num = slea.readByte();\n+                int neededCP = 0;\n+                if (tab == 0) { \n+                    final List<Pair<Integer, Integer>> mobs = c.getPlayer().getMap().getMobsToSpawn();\n+                    if (num >= mobs.size() || c.getPlayer().getCP() < mobs.get(num).right) {\n+                        c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n+                        c.announce(MaplePacketCreator.enableActions());\n                         return;\n                     }\n-                    mob.setPosition(spawnPos);\n-                    if (c.getPlayer().getTeam() == 0) {\n-                        c.getPlayer().getMonsterCarnival().summon();\n-                    } else {\n-                        c.getPlayer().getMonsterCarnival().summons();\n-                    }\n+                    \n+                    final MapleMonster mob = MapleLifeFactory.getMonster(mobs.get(num).left);\n+                    MonsterCarnival mcpq = c.getPlayer().getMonsterCarnival();\n+                    if (mcpq != null) {                        \n+                        if (!mcpq.canSummonR() && c.getPlayer().getTeam() == 0 || !mcpq.canSummonB() && c.getPlayer().getTeam() == 1) {\n+                            c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n+                        }\n+                        \n+                        if (c.getPlayer().getTeam() == 0) {\n+                            mcpq.summonR();\n+                        } else {\n+                            mcpq.summonB();\n+                        }\n+                        \n+                        Point spawnPos = c.getPlayer().getMap().getRandomSP(c.getPlayer().getTeam());\n+                        mob.setPosition(spawnPos);\n+                        \n                         c.getPlayer().getMap().addMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+                        c.getPlayer().getMap().addAllMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n+                        c.announce(MaplePacketCreator.enableActions());\n                     }\n+\n                     neededCP = mobs.get(num).right;\n                 } else if (tab == 1) { //debuffs\n                     final List<Integer> skillid = c.getPlayer().getMap().getSkillIds();\n                     if (num >= skillid.size()) {\n                         c.getPlayer().dropMessage(5, \"Ocorreu um erro.\");\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+                        c.announce(MaplePacketCreator.enableActions());\n                         return;\n                     }\n-                    final MCSkill skil = MapleCarnivalFactory.getInstance().getSkill(skillid.get(num)); //ugh wtf\n-                    if (skil == null || c.getPlayer().getCP() < skil.cpLoss) {\n+                    final MCSkill skill = MapleCarnivalFactory.getInstance().getSkill(skillid.get(num)); //ugh wtf\n+                    if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n                         c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+                        c.announce(MaplePacketCreator.enableActions());\n                         return;\n                     }\n-                    final MapleDisease dis = skil.getDisease();\n-                    MapleParty inimigos = c.getPlayer().getParty().getEnemy();\n-                    if (skil.targetsAll) {\n+                    final MapleDisease dis = skill.getDisease();\n+                    MapleParty enemies = c.getPlayer().getParty().getEnemy();\n+                    if (skill.targetsAll) {\n                         int chanceAcerto = 0;\n                         if (dis.getDisease() == 121 || dis.getDisease() == 122 || dis.getDisease() == 125 || dis.getDisease() == 126) {\n                             chanceAcerto = (int) (Math.random() * 100);\n                         }\n                         if (chanceAcerto <= 80) {\n-                            for (MaplePartyCharacter chrS : inimigos.getPartyMembers()) {\n+                            for (MaplePartyCharacter chrS : enemies.getPartyMembers()) {\n                                 if (dis == null) {\n                                     chrS.getPlayer().dispel();\n                                 } else {\n-                                    chrS.getPlayer().giveDebuff(dis, skil.getSkill());\n+                                    chrS.getPlayer().giveDebuff(dis, skill.getSkill());\n                                 }\n-                                if (!skil.targetsAll) {\n+                                if (!skill.targetsAll) {\n                                     break;\n                                 }\n                             }\n                         }\n                     } else {\n-                        int amount = inimigos.getMembers().size() - 1;\n+                        int amount = enemies.getMembers().size() - 1;\n                         int randd = (int) Math.floor(Math.random() * amount);\n-                        MapleCharacter chrApp = c.getChannelServer().getPlayerStorage().getCharacterById(inimigos.getMemberByPos(randd).getId());\n+                        MapleCharacter chrApp = c.getChannelServer().getPlayerStorage().getCharacterById(enemies.getMemberByPos(randd).getId());\n                         if (chrApp != null && chrApp.getMap().isCPQMap()) {\n                             if (dis == null) {\n                                 chrApp.dispel();\n                             } else {\n-                                chrApp.giveDebuff(dis, skil.getSkill());\n+                                chrApp.giveDebuff(dis, skill.getSkill());\n                             }\n                         }\n                     }\n-                    neededCP = skil.cpLoss;\n-                    c.getSession().write(MaplePacketCreator.enableActions());\n+                    neededCP = skill.cpLoss;\n+                    c.announce(MaplePacketCreator.enableActions());\n                 } else if (tab == 2) { //protectors\n-                    final MCSkill skil = MapleCarnivalFactory.getInstance().getGuardian(num);\n-                    if (skil == null || c.getPlayer().getCP() < skil.cpLoss) {\n+                    final MCSkill skill = MapleCarnivalFactory.getInstance().getGuardian(num);\n+                    if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n                         c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+                        c.announce(MaplePacketCreator.enableActions());\n                         return;\n                     }\n                     int success = c.getPlayer().getMap().spawnGuardian(c.getPlayer().getTeam(), num);\n@@ -138,17 +147,20 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                         } else if (success == 2) {\n                             c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n                         }\n-                        c.getSession().write(MaplePacketCreator.enableActions());\n+                        c.announce(MaplePacketCreator.enableActions());\n                         return;\n                     } else {\n-                        neededCP = skil.cpLoss;\n+                        neededCP = skill.cpLoss;\n                     }\n                 }\n                 c.getPlayer().gainCP(-neededCP);\n                 c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.playerSummoned(c.getPlayer().getName(), tab, num));\n             }catch (Exception e) {\n-            e.printStackTrace();\n-        }\n+                e.printStackTrace();\n+            }\n+        } finally {\n+            c.releaseClient();\n         }\n-\n     }\n+\n+}"}, {"sha": "7424877e31121e3d4f6ea1cb3438b7265aa7f824", "filename": "src/net/server/channel/handlers/RingActionHandler.java", "status": "modified", "additions": 48, "deletions": 61, "changes": 109, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/RingActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/RingActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RingActionHandler.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -21,32 +21,34 @@\n */\n package net.server.channel.handlers;\n \n-import client.MapleClient;\n-import client.MapleCharacter;\n-import client.inventory.MapleInventoryType;\n-import client.processor.DueyProcessor;\n import java.sql.Connection;\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n-import net.AbstractMaplePacketHandler;\n+\n+import client.MapleClient;\n+import client.MapleCharacter;\n+import client.MapleRing;\n+import client.inventory.Equip;\n+import client.inventory.Item;\n+import client.inventory.MapleInventoryType;\n import client.inventory.manipulator.MapleInventoryManipulator;\n+import client.processor.DueyProcessor;\n+import net.AbstractMaplePacketHandler;\n+import net.server.world.World;\n+import net.server.channel.Channel;\n+import server.MapleItemInformationProvider;\n+import scripting.event.EventInstanceManager;\n import tools.DatabaseConnection;\n-import tools.data.input.SeekableLittleEndianAccessor;\n import tools.Pair;\n import tools.MaplePacketCreator;\n+import tools.data.input.SeekableLittleEndianAccessor;\n import tools.packets.Wedding;\n-import net.server.world.World;\n-import net.server.channel.Channel;\n-import server.MapleItemInformationProvider;\n-import client.MapleRing;\n-import client.inventory.Equip;\n-import client.inventory.Item;\n \n /**\n  * @author Jvlaple\n  * @author Ronan - major overhaul on Ring handling mechanics\n- * @author Drago/Dragohe4rt on Wishlist\n+ * @author Drago/Dragohe4rt - on Wishlist\n  */\n public final class RingActionHandler extends AbstractMaplePacketHandler {\n     private static int getBoxId(int useItemId) {\n@@ -463,57 +465,42 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n                 \n             case 9: \n-                // By Drago/Dragohe4rt\n-                // Groom and Bride's Wishlist\n-                //short size = slea.readShort();\n-                int amount = slea.readShort();\n-                if (amount > 10) {\n-                    amount = 10;\n-                }\n-                for (int i = 0; i < amount; i++) {\n-                    c.getPlayer().setItens(slea.readMapleAsciiString());\n-                }\n-                \n-                //System.out.println(\"G&B WISHLIST: \" + itemnames);\n-                \n-                /*\n-                if (c.getPlayer().getMarriageItemId() > -1) {\n-                    switch(c.getPlayer().getMarriageItemId()) {\n-                        case 10: // Premium Cathedral\n-                            c.getAbstractPlayerInteraction().gainItem(4031375, (short)1);\n-                            c.getAbstractPlayerInteraction().gainItem(4031395, (short)15);\n-                            break;\n-                        case 11: // Normal Cathedral\n-                            c.getAbstractPlayerInteraction().gainItem(4031480, (short)1);\n-                            c.getAbstractPlayerInteraction().gainItem(4031395, (short)15);\n-                            break;\n-                        case 20: // Premium Chapel\n-                            c.getAbstractPlayerInteraction().gainItem(4031376, (short)1);\n-                            c.getAbstractPlayerInteraction().gainItem(4031377, (short)15);\n-                            break;\n-                        case 21: // Normal Chapel\n-                            c.getAbstractPlayerInteraction().gainItem(4031481, (short)1);\n-                            c.getAbstractPlayerInteraction().gainItem(4031377, (short)15);\n-                            break;\n-                        default: {\n-                            System.out.println(\"Invalid Wedding Type for player \" + c.getPlayer().getName() + \"!\");\n-                            break;\n+                try {\n+                    // By Drago/Dragohe4rt\n+                    // Groom and Bride's Wishlist\n+\n+                    MapleCharacter player = c.getPlayer();\n+\n+                    EventInstanceManager eim = player.getEventInstance();\n+                    if (eim != null) {\n+                        boolean isMarrying = (player.getId() == eim.getIntProperty(\"groomId\") || player.getId() == eim.getIntProperty(\"brideId\"));\n+\n+                        if (isMarrying) {\n+                            int amount = slea.readShort();\n+                            if (amount > 10) {\n+                                amount = 10;\n+                            }\n+\n+                            String wishlistItems = \"\";\n+                            for (int i = 0; i < amount; i++) {\n+                                String s = slea.readMapleAsciiString();\n+                                wishlistItems += (s + \"\\r\\n\");\n+                            }\n+\n+                            String wlKey;\n+                            if (player.getId() == eim.getIntProperty(\"groomId\")) {\n+                                wlKey = \"groomWishlist\";\n+                            } else {\n+                                wlKey = \"brideWishlist\";\n+                            }\n+\n+                            if (eim.getProperty(wlKey).contentEquals(\"\")) {\n+                                eim.setProperty(wlKey, wishlistItems);\n+                            }\n                         }\n                     }\n-                    \n-                    //c.getPlayer().setMarriageItemId(-1); ?????\n-                }\n-                \n-                if (c.getPlayer().getWishlist() == null) {\n-                    c.getPlayer().registerWishlist(itemnames);\n-                }\n+                } catch (NumberFormatException nfe) {}\n                 \n-                if (c.getPlayer().getWedding() != null) {\n-                    if (c.getPlayer().getGender() == 0 ? c.getPlayer().getWedding().isExistantGroom(c.getPlayer().getId()) : c.getPlayer().getWedding().isExistantBride(c.getPlayer().getId())) {\n-                        c.getPlayer().getWedding().registerWishlist(c.getPlayer().getGender() == 1, itemnames);\n-                    }\n-                }\n-                */\n                 break;\n                 \n             default:"}, {"sha": "f7eb05bc9b5219a62447bee7e70572d96b0abc67", "filename": "src/net/server/channel/handlers/WeddingHandler.java", "status": "modified", "additions": 123, "deletions": 39, "changes": 162, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/WeddingHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/channel/handlers/WeddingHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/WeddingHandler.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -6,19 +6,23 @@\n \n package net.server.channel.handlers;\n \n-import client.inventory.Item;\n-import client.inventory.MapleInventoryType;\n+\n import client.MapleCharacter;\n import client.MapleClient;\n-import client.inventory.Equip;\n+import client.inventory.Item;\n+import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryType;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n+import client.inventory.manipulator.MapleKarmaManipulator;\n import constants.ItemConstants;\n+import constants.ServerConstants;\n import net.AbstractMaplePacketHandler;\n-import client.inventory.manipulator.MapleInventoryManipulator;\n-import net.server.channel.Channel;\n-import scripting.event.EventInstanceManager;\n+import server.MapleMarriage;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import tools.packets.Wedding;\n+import java.util.Collections;\n+import java.util.List;\n \n /**\n  *\n@@ -28,43 +32,123 @@\n     \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        MapleCharacter chr = c.getPlayer();\n-        final byte mode = slea.readByte();\n-        Channel cs = c.getChannelServer();\n         \n-        if (mode == 6) { //additem\n-            short slot = slea.readShort();\n-            int itemid = slea.readInt();\n-            short quantity = slea.readShort();\n-            EventInstanceManager eim = c.getPlayer().getEventInstance();\n-            if (eim != null) {\n-                String name = eim.getProperty(\"brideId\");\n-                MapleCharacter chrs = cs.getPlayerStorage().getCharacterById(Integer.parseInt(name));\n-                //MapleCharacter chrs = cs.getPlayerStorage().getCharacterById(3);\n-                MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n-                Item item = chr.getInventory(type).getItem((byte) slot);\n-                if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n-                    if(!(item instanceof Equip)) {\n-                        item = new Item(itemid, slot, quantity);\n+        c.tryacquireClient();\n+        try {\n+            MapleCharacter chr = c.getPlayer();\n+            final byte mode = slea.readByte();\n+            \n+            if (mode == 6) { //additem\n+                short slot = slea.readShort();\n+                int itemid = slea.readInt();\n+                short quantity = slea.readShort();\n+\n+                MapleMarriage marriage = c.getPlayer().getMarriageInstance();\n+                if (marriage != null) {\n+                    try {\n+                        boolean groomWishlist = marriage.giftItemToSpouse(chr.getId());\n+                        String groomWishlistProp = \"giftedItem\" + (groomWishlist ? \"G\" : \"B\") + chr.getId();\n+                        \n+                        int giftCount = marriage.getIntProperty(groomWishlistProp);\n+                        if (giftCount < ServerConstants.WEDDING_GIFT_LIMIT) {\n+                            int cid = marriage.getIntProperty(groomWishlist ? \"groomId\" : \"brideId\");\n+                            if (chr.getId() != cid) {   // cannot gift yourself\n+                                MapleCharacter spouse = marriage.getPlayerById(cid);\n+                                if (spouse != null) {\n+                                    MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+                                    MapleInventory chrInv = chr.getInventory(type);\n+\n+                                    chrInv.lockInventory();\n+                                    try {\n+                                        Item item = chrInv.getItem((byte) slot);\n+                                        if (item != null) {\n+                                            if (!item.isUntradeable()) {\n+                                                if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n+                                                    Item newItem = item.copy();\n+\n+                                                    marriage.addGiftItem(groomWishlist, newItem);\n+                                                    MapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false, false);\n+\n+                                                    if (ServerConstants.USE_ENFORCE_MERCHANT_SAVE) chr.saveCharToDB(false); \n+                                                    marriage.saveGiftItemsToDb(c, groomWishlist, cid);\n+\n+                                                    MapleKarmaManipulator.toggleKarmaFlagToUntradeable(newItem);\n+                                                    marriage.setIntProperty(groomWishlistProp, giftCount + 1);\n+\n+                                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xB, marriage.getWishlistItems(groomWishlist), Collections.singletonList(newItem)));\n+                                                }\n+                                            } else {\n+                                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n+                                            }\n+                                        }\n+                                    } finally {\n+                                        chrInv.unlockInventory();\n+                                    }\n+                                } else {\n+                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n+                                }\n+                            } else {\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n+                            }\n+                        } else {\n+                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xC, marriage.getWishlistItems(groomWishlist), null));\n+                        }\n+                    } catch (NumberFormatException nfe) {}\n+                } else {\n+                    c.announce(MaplePacketCreator.enableActions());\n+                }\n+            } else if (mode == 7) { // take items\n+                slea.readByte();    // invType\n+                int itemPos = slea.readByte();\n+                \n+                MapleMarriage marriage = chr.getMarriageInstance();\n+                if (marriage != null) {\n+                    Boolean groomWishlist = marriage.isMarriageGroom(chr);\n+                    if (groomWishlist != null) {\n+                        Item item = marriage.getGiftItem(c, groomWishlist, itemPos);\n+                        if (item != null) {\n+                            if (MapleInventory.checkSpot(chr, item)) {\n+                                marriage.removeGiftItem(groomWishlist, item);\n+                                marriage.saveGiftItemsToDb(c, groomWishlist, chr.getId());\n+                                \n+                                MapleInventoryManipulator.addFromDrop(c, item, true);\n+\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                            } else {\n+                                c.getPlayer().dropMessage(1, \"Free a slot on your inventory before collecting this item.\");\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                            }\n+                        } else {\n+                            c.getPlayer().dropMessage(1, \"You have already collected this item.\");\n+                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                        }\n+                    }\n+                } else {\n+                    List<Item> items = c.getAbstractPlayerInteraction().getUnclaimedMarriageGifts();\n+                    try {\n+                        Item item = items.get(itemPos);\n+                        if (MapleInventory.checkSpot(chr, item)) {\n+                            items.remove(itemPos);\n+                            MapleMarriage.saveGiftItemsToDb(c, items, chr.getId());\n+\n+                            MapleInventoryManipulator.addFromDrop(c, item, true);\n+                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, Collections.singletonList(\"\"), items));\n+                        } else {\n+                            c.getPlayer().dropMessage(1, \"Free a slot on your inventory before collecting this item.\");\n+                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, Collections.singletonList(\"\"), items));\n+                        }\n+                    } catch (Exception e) {\n+                        c.getPlayer().dropMessage(1, \"You have already collected this item.\");\n+                        c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, Collections.singletonList(\"\"), items));\n                     }\n-                    chrs.setEquips(item);\n-                    MapleInventoryManipulator.removeById(chr.getClient(), type, itemid, quantity, false, false);\n-                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xB, chrs.getItens(), chrs.getItem()));\n                 }\n+            } else if (mode == 8) { // out of Wedding Registry\n+                c.announce(MaplePacketCreator.enableActions());\n+            } else {\n+                System.out.println(mode);\n             }\n-        } else if (mode == 7) { // noiva abre e pega itens\n-            byte inventId = slea.readByte();\n-            int itemPos = slea.readByte();\n-            MapleInventoryType inv = MapleInventoryType.getByType(inventId);\n-            Item item = chr.getItemid(itemPos);\n-            c.getAbstractPlayerInteraction().gainItem(item.getItemId(), item.getQuantity());\n-            chr.removeItem(item);\n-            c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, chr.getItens(), chr.getItem()));\n-        } else if (mode == 8) { // sair update?\n-            \n-            c.announce(MaplePacketCreator.enableActions());\n-        } else {\n-            System.out.println(mode);\n+        } finally {\n+            c.releaseClient();\n         }\n     }\n }\n\\ No newline at end of file"}, {"sha": "4fd23306cfd7cd5ad7c4a99a508cb028a56533d5", "filename": "src/net/server/world/MaplePartyCharacter.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/world/MaplePartyCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/net/server/world/MaplePartyCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MaplePartyCharacter.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -182,7 +182,7 @@ public String getJobNameById(int job) {\n             case 222:\n                 return \"Arquimago (Gelo, Raio)\";\n             case 230:\n-                return \"Cl\ufffdrigo\";\n+                return \"Clerigo\";\n             case 231:\n                 return \"Sacerdote\";\n             case 232:\n@@ -191,7 +191,7 @@ public String getJobNameById(int job) {\n             case 300:\n                 return \"Arqueiro\";\n             case 310:\n-                return \"Ca\ufffdador\";\n+                return \"Cacador\";\n             case 311:\n                 return \"Rastreador\";\n             case 312:\n@@ -231,7 +231,7 @@ public String getJobNameById(int job) {\n             case 521:\n                 return \"Bucaneiro\";\n             case 522:\n-                return \"Captain\";\n+                return \"Capitao\";\n \n             default:\n                 return \"Unknown Job\";"}, {"sha": "b108af4180161382a39502cf43ffed6ec90430fa", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -55,7 +55,6 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.MapleQuestStatus;\n-import client.MapleStat;\n import client.SkillFactory;\n import client.inventory.Equip;\n import client.inventory.Item;\n@@ -68,6 +67,7 @@\n import constants.GameConstants;\n import constants.ItemConstants;\n import constants.ServerConstants;\n+import server.MapleMarriage;\n import server.life.MapleNPC;\n import tools.Pair;\n \n@@ -1048,6 +1048,10 @@ public long getJailTimeLeft() {\n                 return list;\n         }\n         \n+        public List<Item> getUnclaimedMarriageGifts() {\n+            return MapleMarriage.loadGiftItemsFromDb(this.getClient(), this.getPlayer().getId());\n+        }\n+        \n         public boolean startDungeonInstance(int dungeonid) {\n                 return c.getChannelServer().addMiniDungeon(dungeonid);\n         }\n@@ -1101,7 +1105,7 @@ public void npcTalk(int npcid, String message) {\n                 c.announce(MaplePacketCreator.getNPCTalk(npcid, (byte) 0, message, \"00 00\", (byte) 0));\n         }\n \n-    public long getCurrentTime() {\n-\t    return System.currentTimeMillis();\n-    }    \n+        public long getCurrentTime() {\n+                return Server.getInstance().getCurrentTime();\n+        }    \n }\n\\ No newline at end of file"}, {"sha": "859c8c82a2ed7e1a562f6f575fc754378a3d348d", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -55,10 +55,16 @@\n import client.MapleCharacter;\n import client.SkillFactory;\n import client.Skill;\n+import client.inventory.Item;\n+import client.inventory.ItemFactory;\n+import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryType;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n import constants.ItemConstants;\n import constants.ServerConstants;\n import java.awt.Point;\n import java.sql.Connection;\n+import java.util.Arrays;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n@@ -73,6 +79,7 @@\n import server.life.MapleLifeFactory;\n import server.life.MapleNPC;\n import tools.MaplePacketCreator;\n+import tools.Randomizer;\n \n /**\n  *\n@@ -89,6 +96,7 @@\n \tprivate MapleMapFactory mapFactory;\n \tprivate String name;\n \tprivate Properties props = new Properties();\n+        private Map<String, Object> objectProps = new HashMap<>();\n \tprivate long timeStarted = 0;\n \tprivate long eventTime = 0;\n \tprivate MapleExpedition expedition = null;\n@@ -628,6 +636,7 @@ public synchronized void dispose(boolean shutdown) {    // should not trigger an\n                 killCount.clear();\n                 mapIds.clear();\n                 props.clear();\n+                objectProps.clear();\n                 \n                 disposeExpedition();\n                 \n@@ -741,6 +750,15 @@ public Object setProperty(String key, String value, boolean prev) {\n                         pL.unlock();\n                 }\n \t}\n+        \n+        public void setObjectProperty(String key, Object obj) {\n+                pL.lock();\n+                try {\n+                        objectProps.put(key, obj);\n+                } finally {\n+                        pL.unlock();\n+                }\n+        }\n \n \tpublic String getProperty(String key) {\n                 pL.lock();\n@@ -759,6 +777,15 @@ public int getIntProperty(String key) {\n                         pL.unlock();\n                 }\n         }\n+        \n+        public Object getObjectProperty(String key) {\n+                pL.lock();\n+                try {\n+                        return objectProps.get(key);\n+                } finally {\n+                        pL.unlock();\n+                }\n+        }\n \t\n \tpublic void leftParty(final MapleCharacter chr) {\n                 try {"}, {"sha": "ba91944e1f9266bd58d40d7d7e95e91ae950d347", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -42,6 +42,7 @@\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n import scripting.event.worker.EventScriptScheduler;\n+import server.MapleMarriage;\n import server.expeditions.MapleExpedition;\n import server.maps.MapleMap;\n import server.life.MapleMonster;\n@@ -279,6 +280,19 @@ public EventInstanceManager newInstance(String name) throws EventInstanceInProgr\n         }\n         return ret;\n     }\n+    \n+    public MapleMarriage newMarriage(String name) throws EventInstanceInProgressException {\n+        MapleMarriage ret = new MapleMarriage(this, name);\n+        \n+        synchronized (instances) {\n+            if (instances.containsKey(name)) {\n+                throw new EventInstanceInProgressException(name, this.getName());\n+            }\n+            \n+            instances.put(name, ret);\n+        }\n+        return ret;\n+    }\n \n     public void disposeInstance(final String name) {\n         ess.registerEntry(new Runnable() {"}, {"sha": "76a6741a3a6c589247349c320897a9488b2a0a90", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 98, "deletions": 68, "changes": 166, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -58,22 +58,23 @@\n import client.inventory.ItemFactory;\n import client.inventory.MaplePet;\n import constants.ItemConstants;\n-import constants.LinguaConstants;\n+import constants.LanguageConstants;\n+import net.server.PlayerStorage;\n import net.server.channel.Channel;\n-import scripting.event.EventInstanceManager;\n import server.MapleSkillbookInformationProvider;\n import server.MapleSkillbookInformationProvider.SkillBookEntry;\n import server.TimerManager;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n import server.partyquest.MonsterCarnival;\n-import tools.FilePrinter;\n import tools.packets.Wedding;\n \n import java.awt.Point;\n import java.util.Arrays;\n+import java.util.Collections;\n import java.util.LinkedList;\n import java.util.List;\n+import server.MapleMarriage;\n \n /**\n  *\n@@ -619,8 +620,7 @@ public String getSkillBookInfo(int itemid) {\n         public int calcAvgLvl(int map) {\n             int num = 0;\n             int avg = 0;\n-            for (MapleMapObject mmo\n-                    : c.getChannelServer().getMapFactory().getMap(map).getAllPlayer()) {\n+            for (MapleMapObject mmo : c.getChannelServer().getMapFactory().getMap(map).getAllPlayer()) {\n                 avg += ((MapleCharacter) mmo).getLevel();\n                 num++;\n             }\n@@ -629,7 +629,7 @@ public int calcAvgLvl(int map) {\n         }\n \n         public void sendCPQMapLists() {\n-            String msg = LinguaConstants.Linguas(getPlayer()).CPQInicioEscolha;\n+            String msg = LanguageConstants.Linguas(getPlayer()).CPQInicioEscolha;\n             for (int i = 0; i < 6; i++) {\n                 if (fieldTaken(i)) {\n                     if (fieldLobbied(i)) {\n@@ -641,7 +641,7 @@ public void sendCPQMapLists() {\n                         continue;\n                     }\n                 } else {\n-                    if (i == 0 || i == 1 || i == 2 || i == 3) {\n+                    if (i >= 0 && i <= 3) {\n                         msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (2x2) #l\\\\r\\\\n\";\n                     } else {\n                         msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (3x3) #l\\\\r\\\\n\";\n@@ -673,48 +673,49 @@ public boolean fieldLobbied(int field) {\n \n         public void cpqLobby(int field) {\n             try {\n-                final MapleMap map, mapsaida;\n+                final MapleMap map, mapExit;\n                 Channel cs = c.getChannelServer();\n+                PlayerStorage ps = cs.getPlayerStorage();\n+                \n                 map = cs.getMapFactory().getMap(980000100 + 100 * field);\n-                mapsaida = cs.getMapFactory().getMap(980000000);\n+                mapExit = cs.getMapFactory().getMap(980000000);\n                 for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n                     final MapleCharacter mc;\n-                    mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    mc = ps.getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.changeMap(map, map.getPortal(0));\n-                        mc.getClient().getSession().write(MaplePacketCreator.serverNotice(6, LinguaConstants.Linguas(mc).CPQEntradaLobby));\n+                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Linguas(mc).CPQEntradaLobby));\n                         TimerManager tMan = TimerManager.getInstance();\n                         tMan.schedule(new Runnable() {\n                             @Override\n                             public void run() {\n                                 mapClock(3 * 60);\n                             }\n                         }, 1500);\n+                        \n+                        mc.setCpqTimer(TimerManager.getInstance().schedule(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                mc.changeMap(mapExit, mapExit.getPortal(0));\n+                            }\n+                        }, 3 * 60 * 1000));\n                     }\n-                    mc.timer = TimerManager.getInstance().schedule(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            mc.changeMap(mapsaida, mapsaida.getPortal(0));\n-                        }\n-                    }, 3 * 60 * 1000);\n                 }\n             } catch (Exception ex) {\n                 ex.printStackTrace();\n             }\n         }\n \n         public MapleCharacter getChrById(int id) {\n-            Channel cs = c.getChannelServer();\n-            return cs.getPlayerStorage().getCharacterById(id);\n+            return c.getChannelServer().getPlayerStorage().getCharacterById(id);\n         }\n \n         public void cancelarSaida() {\n-            Channel cs = c.getChannelServer();\n+            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n             for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n-                MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n-                if (mc.timer != null) {\n-                    mc.timer.cancel(true);\n-                    mc.timer = null;\n+                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                if (mc != null) {\n+                    mc.clearCpqTimer();\n                 }\n             }\n         }\n@@ -726,8 +727,9 @@ public void startCPQ(final MapleCharacter challenger, final int field) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"Nao existe oponente!\");\n                     }\n+                    PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                        MapleCharacter mc = c.getChannelServer().getPlayerStorage().getCharacterByName(mpc.getName());\n+                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                         if (mc != null) {\n                             mc.changeMap(getPlayer().getMap(), getPlayer().getMap().getPortal(0));\n                             TimerManager tMan = TimerManager.getInstance();\n@@ -740,7 +742,7 @@ public void run() {\n                         }\n                     }\n                     for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                        MapleCharacter mc = c.getChannelServer().getPlayerStorage().getCharacterByName(mpc.getName());\n+                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                         if (mc != null) {\n                             TimerManager tMan = TimerManager.getInstance();\n                             tMan.schedule(new Runnable() {\n@@ -757,17 +759,17 @@ public void run() {\n                 tMan.schedule(new Runnable() {\n                     @Override\n                     public void run() {\n-                        Channel cs = c.getChannelServer();\n+                        PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                         for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                             mc.setMonsterCarnival(null);\n                         }\n                         for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                             mc.setMonsterCarnival(null);\n                         }\n                         \n-                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, true);\n+                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, true, (field / 100) % 10);\n                     }\n                 }, 11000);\n             } catch (Exception e) {\n@@ -782,8 +784,9 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"N\u00e3o existe oponente!\");\n                     }\n+                    PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                        MapleCharacter mc = c.getChannelServer().getPlayerStorage().getCharacterByName(mpc.getName());\n+                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                         if (mc != null) {\n                             mc.changeMap(getPlayer().getMap(), getPlayer().getMap().getPortal(0));\n                             mapClock(10);\n@@ -795,17 +798,18 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                 tMan.schedule(new Runnable() {\n                     @Override\n                     public void run() {\n-                        Channel cs = c.getChannelServer();\n+                        PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                        \n                         for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                             mc.setMonsterCarnival(null);\n                         }\n                         for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                             mc.setMonsterCarnival(null);\n                         }\n                         \n-                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, false);\n+                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, false, (field / 1000) % 10);\n                     }\n                 }, 10000);\n             } catch (Exception e) {\n@@ -814,7 +818,7 @@ public void run() {\n         }\n \n         public void sendCPQMapLists2() {\n-            String msg = LinguaConstants.Linguas(getPlayer()).CPQInicioEscolha;\n+            String msg = LanguageConstants.Linguas(getPlayer()).CPQInicioEscolha;\n             for (int i = 0; i < 3; i++) {\n                 if (fieldTaken2(i)) {\n                     if (fieldLobbied2(i)) {\n@@ -856,30 +860,33 @@ public boolean fieldLobbied2(int field) {\n \n         public void cpqLobby2(int field) {\n             try {\n-                final MapleMap map, mapsaida;\n+                final MapleMap map, mapExit;\n                 Channel cs = c.getChannelServer();\n-                mapsaida = cs.getMapFactory().getMap(980030000);\n+                PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                \n+                mapExit = cs.getMapFactory().getMap(980030000);\n                 map = cs.getMapFactory().getMap(980031000 + 1000 * field);\n                 for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n                     final MapleCharacter mc;\n-                    mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    mc = ps.getCharacterByName(mpc.getName());\n                     if (mc != null) {\n                         mc.changeMap(map, map.getPortal(0));\n-                        mc.getClient().getSession().write(MaplePacketCreator.serverNotice(6, LinguaConstants.Linguas(mc).CPQEntradaLobby));\n+                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Linguas(mc).CPQEntradaLobby));\n                         TimerManager tMan = TimerManager.getInstance();\n                         tMan.schedule(new Runnable() {\n                             @Override\n                             public void run() {\n                                 mapClock(3 * 60);\n                             }\n                         }, 1500);\n+                        \n+                        mc.setCpqTimer(TimerManager.getInstance().schedule(new Runnable() {\n+                            @Override\n+                            public void run() {\n+                                mc.changeMap(mapExit, mapExit.getPortal(0));\n+                            }\n+                        }, 3 * 60 * 1000));\n                     }\n-                    mc.timer = TimerManager.getInstance().schedule(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            mc.changeMap(mapsaida, mapsaida.getPortal(0));\n-                        }\n-                    }, 3 * 60 * 1000);\n                 }\n             } catch (Exception ex) {\n                 ex.printStackTrace();\n@@ -892,7 +899,7 @@ public void challengeParty2(int field) {\n             for (MapleMapObject mmo : map.getAllPlayer()) {\n                 MapleCharacter mc = (MapleCharacter) mmo;\n                 if (mc.getParty() == null) {\n-                    sendOk(LinguaConstants.Linguas(mc).CPQEscolha);\n+                    sendOk(LanguageConstants.Linguas(mc).CPQEscolha);\n                     return;\n                 }\n                 if (mc.getParty().getLeader().getId() == mc.getId()) {\n@@ -908,15 +915,14 @@ public void challengeParty2(int field) {\n                     }\n                     NPCScriptManager.getInstance().start(\"cpqchallenge2\", leader.getClient(), npc, members);\n                 } else {\n-                    sendOk(LinguaConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n+                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n                 }\n             } else {\n-                sendOk(LinguaConstants.Linguas(leader).CPQLiderNaoEncontrado);\n+                sendOk(LanguageConstants.Linguas(leader).CPQLiderNaoEncontrado);\n             }\n         }\n \n         public void mapClock(int time) {\n-            //getPlayer().getMap().broadcastMessage(MaplePacketCreator.serverNotice(type, message));\n             getPlayer().getMap().broadcastMessage(MaplePacketCreator.getClock(time));\n         }\n \n@@ -930,7 +936,7 @@ public void challengeParty(int field) {\n             for (MapleMapObject mmo : map.getAllPlayer()) {\n                 MapleCharacter mc = (MapleCharacter) mmo;\n                 if (mc.getParty() == null) {\n-                    sendOk(LinguaConstants.Linguas(mc).CPQEscolha);\n+                    sendOk(LanguageConstants.Linguas(mc).CPQEscolha);\n                     return;\n                 }\n                 if (mc.getParty().getLeader().getId() == mc.getId()) {\n@@ -941,15 +947,17 @@ public void challengeParty(int field) {\n             if (leader != null) {\n                 if (!leader.isChallenged()) {\n                     List<MaplePartyCharacter> members = new LinkedList<>();\n-                    for (MaplePartyCharacter fucker : c.getPlayer().getParty().getMembers()) {\n-                        members.add(fucker);\n+                    for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n+                        members.add(mpc);\n                     }\n+                    \n                     NPCScriptManager.getInstance().start(\"cpqchallenge\", leader.getClient(), npc, members);\n+                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEnviada);\n                 } else {\n-                    sendOk(LinguaConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n+                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n                 }\n             } else {\n-                sendOk(LinguaConstants.Linguas(leader).CPQLiderNaoEncontrado);\n+                sendOk(LanguageConstants.Linguas(leader).CPQLiderNaoEncontrado);\n             }\n         }\n \n@@ -961,24 +969,46 @@ public MapleCharacter getCharByName(String namee) {\n             }\n         }\n \n-        public void enviarLista() {\n-            EventInstanceManager eim = getEventInstance();\n-            if(eim != null) {\n-                String name = eim.getProperty(\"brideId\");\n-                MapleCharacter chr = getChrById(Integer.parseInt(name));\n-                //MapleCharacter chr = getChrById(3);\n+        public void sendMarriageWishlist(boolean groom) {\n+            MapleCharacter player = this.getPlayer();\n+            MapleMarriage marriage = player.getMarriageInstance();\n+            if(marriage != null) {\n+                int cid = marriage.getIntProperty(groom ? \"groomId\" : \"brideId\");\n+                MapleCharacter chr = marriage.getPlayerById(cid);\n                 if (chr != null) {\n-                    if (chr.getId() == getPlayer().getId()) {\n-                        getPlayer().announce(Wedding.OnWeddingGiftResult((byte) 0xA, chr.getItens(), chr.getItem()));\n+                    if (chr.getId() == player.getId()) {\n+                        player.announce(Wedding.OnWeddingGiftResult((byte) 0xA, marriage.getWishlistItems(groom), marriage.getGiftItems(player.getClient(), groom)));\n                     } else {\n-                        getPlayer().announce(Wedding.OnWeddingGiftResult((byte) 0x09, chr.getItens(), chr.getItem()));\n+                        marriage.setIntProperty(\"wishlistSelection\", groom ? 0 : 1);\n+                        player.announce(Wedding.OnWeddingGiftResult((byte) 0x09, marriage.getWishlistItems(groom), marriage.getGiftItems(player.getClient(), groom)));\n                     }\n                 }\n             }\n         }\n-\n-        public void criarLista() {\n-            getClient().getSession().write(Wedding.sendWishList());\n-        }\n         \n+        public void sendMarriageGifts(List<Item> gifts) {\n+            this.getPlayer().announce(Wedding.OnWeddingGiftResult((byte) 0xA, Collections.singletonList(\"\"), gifts));\n+        }\n+\n+        public boolean createMarriageWishlist() {\n+            MapleMarriage marriage = this.getPlayer().getMarriageInstance();\n+            if (marriage != null) {\n+                Boolean groom = marriage.isMarriageGroom(this.getPlayer());\n+                if (groom != null) {\n+                    String wlKey;\n+                    if (groom) {\n+                        wlKey = \"groomWishlist\";\n+                    } else {\n+                        wlKey = \"brideWishlist\";\n+                    }\n+                    \n+                    if (marriage.getProperty(wlKey).contentEquals(\"\")) {\n+                        getClient().announce(Wedding.sendWishList());\n+                        return true;\n+                    }\n+                }\n+            }\n+            \n+            return false;\n+        }\n }\n\\ No newline at end of file"}, {"sha": "69c785309164d24ad6567018543d0ceb10fb4d78", "filename": "src/server/MapleMarriage.java", "status": "added", "additions": 183, "deletions": 0, "changes": 183, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/MapleMarriage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/MapleMarriage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleMarriage.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -0,0 +1,183 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server;\n+\n+import client.MapleClient;\n+import client.MapleCharacter;\n+import client.inventory.Item;\n+import client.inventory.ItemFactory;\n+import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryType;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n+import scripting.event.EventInstanceManager;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.LinkedList;\n+import java.util.List;\n+import scripting.event.EventManager;\n+import tools.DatabaseConnection;\n+import tools.Pair;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleMarriage extends EventInstanceManager {\n+    \n+    public MapleMarriage(EventManager em, String name) {\n+        super(em, name);\n+    }\n+    \n+    public boolean giftItemToSpouse(int cid) {\n+        return this.getIntProperty(\"wishlistSelection\") == 0;\n+    }\n+\n+    public List<String> getWishlistItems(boolean groom) {\n+        String strItems = this.getProperty(groom ? \"groomWishlist\" : \"brideWishlist\");\n+        if (strItems != null) {\n+            return Arrays.asList(strItems.split(\"\\r\\n\"));\n+        }\n+\n+        return new LinkedList<>();\n+    }\n+\n+    public void initializeGiftItems() {\n+        List<Item> groomGifts = new ArrayList<>();\n+        this.setObjectProperty(\"groomGiftlist\", groomGifts);\n+\n+        List<Item> brideGifts = new ArrayList<>();\n+        this.setObjectProperty(\"brideGiftlist\", brideGifts);\n+    }\n+\n+    public List<Item> getGiftItems(MapleClient c, boolean groom) {\n+        c.tryacquireClient();\n+        try {\n+            List<Item> gifts = getGiftItemsList(groom);\n+            synchronized (gifts) {\n+                return new LinkedList<>(gifts);\n+            }\n+        } finally {\n+            c.releaseClient();\n+        }\n+    }\n+\n+    private List<Item> getGiftItemsList(boolean groom) {\n+        return (List<Item>) this.getObjectProperty(groom ? \"groomGiftlist\" : \"brideGiftlist\");\n+    }\n+\n+    public Item getGiftItem(MapleClient c, boolean groom, int idx) {\n+        try {\n+            return getGiftItems(c, groom).get(idx);\n+        } catch (IndexOutOfBoundsException e) {\n+            return null;\n+        }\n+    }\n+\n+    public void addGiftItem(boolean groom, Item item) {\n+        List<Item> gifts = getGiftItemsList(groom);\n+        synchronized (gifts) {\n+            gifts.add(item);\n+        }\n+    }\n+\n+    public void removeGiftItem(boolean groom, Item item) {\n+        List<Item> gifts = getGiftItemsList(groom);\n+        synchronized (gifts) {\n+            gifts.remove(item);\n+        }\n+    }\n+        \n+    public Boolean isMarriageGroom(MapleCharacter chr) {\n+        Boolean groom = null;\n+        try {\n+            int groomid = this.getIntProperty(\"groomId\"), brideid = this.getIntProperty(\"brideId\");\n+            if (chr.getId() == groomid) {\n+                groom = true;\n+            } else if (chr.getId() == brideid) {\n+                groom = false;\n+            }\n+        } catch (NumberFormatException nfe) {}\n+\n+        return groom;\n+    }\n+\n+    public static boolean claimGiftItems(MapleClient c, MapleCharacter chr) {\n+        List<Item> gifts = loadGiftItemsFromDb(c, chr.getId());\n+        if (MapleInventory.checkSpot(chr, gifts)) {\n+            try {\n+                Connection con = DatabaseConnection.getConnection();\n+                ItemFactory.MARRIAGE_GIFTS.saveItems(new LinkedList<Pair<Item, MapleInventoryType>>(), chr.getId(), con);\n+                con.close();\n+            } catch (SQLException sqle) {}\n+\n+            for (Item item : gifts) {\n+                MapleInventoryManipulator.addFromDrop(chr.getClient(), item, false);\n+            }\n+\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+        \n+    public static List<Item> loadGiftItemsFromDb(MapleClient c, int cid) {\n+        c.tryacquireClient();\n+        try {\n+            List<Item> items = new LinkedList<>();\n+            try {\n+                for (Pair<Item, MapleInventoryType> it : ItemFactory.MARRIAGE_GIFTS.loadItems(cid, false)) {\n+                    items.add(it.getLeft());\n+                }\n+            } catch (SQLException sqle) {\n+                sqle.printStackTrace();\n+            }\n+\n+            return items;\n+        } finally {\n+            c.releaseClient();\n+        }\n+    }\n+        \n+    public void saveGiftItemsToDb(MapleClient c, boolean groom, int cid) {\n+        MapleMarriage.saveGiftItemsToDb(c, getGiftItems(c, groom), cid);\n+    }\n+    \n+    public static void saveGiftItemsToDb(MapleClient c, List<Item> giftItems, int cid) {\n+        List<Pair<Item, MapleInventoryType>> items = new LinkedList<>();\n+        for (Item it : giftItems) {\n+            items.add(new Pair<>(it, it.getInventoryType()));\n+        }\n+\n+        c.tryacquireClient();\n+        try {\n+            try {\n+                Connection con = DatabaseConnection.getConnection();\n+                ItemFactory.MARRIAGE_GIFTS.saveItems(items, cid, con);\n+                con.close();\n+            } catch (SQLException sqle) {\n+                sqle.printStackTrace();\n+            }\n+        } finally {\n+            c.releaseClient();\n+        }\n+    }\n+}"}, {"sha": "3acf762f62ebf0c8757cf52c8367bd5f39214f46", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 10, "deletions": 19, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -940,26 +940,17 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         } else if (cp != 0 && applyto.getMonsterCarnival() != null) {\n             applyto.gainCP(cp);\n         } else if (nuffSkill != 0 && applyto.getParty() != null && applyto.getMap().isCPQMap()) { // by Drago-Dragohe4rt\n-            final MCSkill skil = MapleCarnivalFactory.getInstance().getSkill(nuffSkill);\n-            if (skil != null) {\n-                final MapleDisease dis = skil.getDisease();\n-                MapleParty inimigos = applyfrom.getParty().getEnemy();\n-                if (nuffSkill == 8) {\n-                    int amount = inimigos.getMembers().size() - 1;\n-                    int randd = (int) Math.floor(Math.random() * amount);\n-                    MapleCharacter chrApp = applyfrom.getClient().getChannelServer().getPlayerStorage().getCharacterById(inimigos.getMemberByPos(randd).getId());\n+            final MCSkill skill = MapleCarnivalFactory.getInstance().getSkill(nuffSkill);\n+            if (skill != null) {\n+                final MapleDisease dis = skill.getDisease();\n+                MapleParty opposition = applyfrom.getParty().getEnemy();\n+                for (MaplePartyCharacter enemyChrs : opposition.getPartyMembers()) {\n+                    MapleCharacter chrApp = enemyChrs.getPlayer();\n                     if (chrApp != null && chrApp.getMap().isCPQMap()) {\n-                        chrApp.dispel();\n-                    }\n-                } else {\n-                    for (MaplePartyCharacter chrsInimigos : inimigos.getPartyMembers()) {\n-                        MapleCharacter chrApp = chrsInimigos.getPlayer();\n-                        if (chrApp != null && chrApp.getMap().isCPQMap()) {\n-                            if (dis == null) {\n-                                chrApp.dispel();\n-                            } else if (skil.getSkill() != null) {\n-                                chrApp.giveDebuff(dis, skil.getSkill());\n-                            }\n+                        if (dis == null) {\n+                            chrApp.dispel();\n+                        } else {\n+                            chrApp.giveDebuff(dis, MCSkill.getMobSkill(dis.getDisease()));\n                         }\n                     }\n                 }"}, {"sha": "f4d44ea31934ada84c4db2f0dee35c026e6ee00c", "filename": "src/server/life/MapleMonsterInformationProvider.java", "status": "modified", "additions": 27, "deletions": 34, "changes": 61, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/life/MapleMonsterInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/life/MapleMonsterInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonsterInformationProvider.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -182,45 +182,38 @@ private void retrieveGlobal() {\n             return drops.get(monsterId);\n         }\n         final List<MonsterDropEntry> ret = new LinkedList<>();\n+        \n+        PreparedStatement ps = null;\n+        ResultSet rs = null;\n+        Connection con = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            ps = con.prepareStatement(\"SELECT itemid, chance, minimum_quantity, maximum_quantity, questid FROM drop_data WHERE dropperid = ?\");\n+            ps.setInt(1, monsterId);\n+            rs = ps.executeQuery();\n \n-        if (monsterId >= 9300127 && monsterId <= 9300136 || monsterId >= 9300315 && monsterId <= 9300324) {\n-            int dropArray[] = {2022157, 2022158, 2022159, 2022160, 2022161, 2022162, 2022163, 2022164, 2022165, 2022166, 2022167, 2022168, 2022169, 2022170, 2022171, 2022172, 2022173, 2022174, 2022175, 2022176, 2022177, 2022178, 4001129}; //These are the drops, -1 means meso :D\n-            for (int id : dropArray) {\n-                ret.add(new MonsterDropEntry(id, 2000, 1, 1, (short) 0));\n+            while (rs.next()) {\n+                ret.add(new MonsterDropEntry(rs.getInt(\"itemid\"), rs.getInt(\"chance\"), rs.getInt(\"minimum_quantity\"), rs.getInt(\"maximum_quantity\"), rs.getShort(\"questid\")));\n             }\n-        } else {\n-            PreparedStatement ps = null;\n-            ResultSet rs = null;\n-            Connection con = null;\n-            try {\n-                con = DatabaseConnection.getConnection();\n-                ps = con.prepareStatement(\"SELECT itemid, chance, minimum_quantity, maximum_quantity, questid FROM drop_data WHERE dropperid = ?\");\n-                ps.setInt(1, monsterId);\n-                rs = ps.executeQuery();\n \n-                while (rs.next()) {\n-                    ret.add(new MonsterDropEntry(rs.getInt(\"itemid\"), rs.getInt(\"chance\"), rs.getInt(\"minimum_quantity\"), rs.getInt(\"maximum_quantity\"), rs.getShort(\"questid\")));\n+            con.close();\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+            return ret;\n+        } finally {\n+            try {\n+                if (ps != null && !ps.isClosed()) {\n+                    ps.close();\n                 }\n-\n-                con.close();\n-            } catch (SQLException e) {\n-                e.printStackTrace();\n-                return ret;\n-            } finally {\n-                try {\n-                    if (ps != null && !ps.isClosed()) {\n-                        ps.close();\n-                    }\n-                    if (rs != null && !rs.isClosed()) {\n-                        rs.close();\n-                    }\n-                    if (con != null && !con.isClosed()) {\n-                        con.close();\n-                    }\n-                } catch (SQLException ignore) {\n-                    ignore.printStackTrace();\n-                    return ret;\n+                if (rs != null && !rs.isClosed()) {\n+                    rs.close();\n+                }\n+                if (con != null && !con.isClosed()) {\n+                    con.close();\n                 }\n+            } catch (SQLException ignore) {\n+                ignore.printStackTrace();\n+                return ret;\n             }\n         }\n         drops.put(monsterId, ret);"}, {"sha": "c1955e030fc9efae2e3ddb9e43d9e56e7c33af40", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 23, "deletions": 15, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -166,18 +166,20 @@ private void loadLifeRaw(MapleMap map, int id, String type, int cy, int f, int f\n         }\n     }\n \n-    private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid) {\n+    private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid, boolean cache) {\n         MapleMap map;\n \n-        mapsRLock.lock();\n-        try {\n-            map = maps.get(omapid);\n-        } finally {\n-            mapsRLock.unlock();\n-        }\n+        if (cache) {\n+            mapsRLock.lock();\n+            try {\n+                map = maps.get(omapid);\n+            } finally {\n+                mapsRLock.unlock();\n+            }\n \n-        if (map != null) {\n-            return map;\n+            if (map != null) {\n+                return map;\n+            }\n         }\n \n         String mapName = getMapName(mapid);\n@@ -389,11 +391,13 @@ private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid) {\n         map.setBackgroundTypes(backTypes);\n         map.generateMapDropRangeCache();\n \n-        mapsWLock.lock();\n-        try {\n-            maps.put(omapid, map);\n-        } finally {\n-            mapsWLock.unlock();\n+        if (cache) {\n+            mapsWLock.lock();\n+            try {\n+                maps.put(omapid, map);\n+            } finally {\n+                mapsWLock.unlock();\n+            }\n         }\n \n         return map;\n@@ -410,7 +414,11 @@ public MapleMap getMap(int mapid) {\n             mapsRLock.unlock();\n         }\n \n-        return (map != null) ? map : loadMapFromWz(mapid, omapid);\n+        return (map != null) ? map : loadMapFromWz(mapid, omapid, true);\n+    }\n+    \n+    public MapleMap getDisposableMap(int mapid) {\n+        return loadMapFromWz(mapid, mapid, false);\n     }\n \n     public boolean isMapLoaded(int mapId) {"}, {"sha": "81483bcd8182ecd15cf5d428db4aa5586f28a17a", "filename": "src/server/partyquest/MapleCarnivalFactory.java", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MapleCarnivalFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MapleCarnivalFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MapleCarnivalFactory.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -63,6 +63,10 @@ public MCSkill(int _cpLoss, int _skillid, int _level, boolean _targetsAll) {\n         }\n \n         public MobSkill getSkill() {\n+            return getMobSkill(skillid);\n+        }\n+        \n+        public static MobSkill getMobSkill(int skillid) {\n             return MobSkillFactory.getMobSkill(skillid, 1); //level?\n         }\n "}, {"sha": "e310a0aeb510cb46d3a6d74255714a1f6a381c7c", "filename": "src/server/partyquest/MonsterCarnival.java", "status": "modified", "additions": 56, "deletions": 34, "changes": 90, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MonsterCarnival.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MonsterCarnival.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnival.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -2,7 +2,8 @@\n \n import java.util.concurrent.ScheduledFuture;\n import client.MapleCharacter;\n-import constants.LinguaConstants;\n+import constants.LanguageConstants;\n+import constants.ServerConstants;\n import net.server.Server;\n import net.server.channel.Channel;\n import net.server.world.MapleParty;\n@@ -24,50 +25,51 @@\n \n     private MapleParty p1, p2;\n     private MapleMap map;\n-    private ScheduledFuture<?> timer, effectTimer;\n+    private ScheduledFuture<?> timer, effectTimer, respawnTask;\n     private long startTime = 0;\n-    private int summons = 8, summonss = 8;\n+    private int summonsR = 8, summonsB = 8, room = 0;\n     private MapleCharacter leader1, leader2, Grupo1, Grupo2;\n     private int redCP, blueCP, redTotalCP, blueTotalCP;\n     private boolean cpq1;\n \n-    public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1) {\n+    public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, int room) {\n         try {\n             this.cpq1 = cpq1;\n+            this.room = room;\n             this.p1 = p1;\n             this.p2 = p2;\n             Channel cs = Server.getInstance().getWorld(p2.getLeader().getWorld()).getChannel(p2.getLeader().getChannel());\n             p1.setEnemy(p2);\n             p2.setEnemy(p1);\n-            map = cs.getMapFactory().resetMap(mapid);\n+            map = cs.getMapFactory().getDisposableMap(mapid);\n             int redPortal = 0;\n             int bluePortal = 0;\n             if (map.isPurpleCPQMap()) {\n                 redPortal = 2;\n                 bluePortal = 1;\n             }\n             for (MaplePartyCharacter mpc : p1.getMembers()) {\n-                MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                 if (mc != null) {\n                     mc.setMonsterCarnival(this);\n                     mc.setTeam(0);\n                     mc.setFestivalPoints(0);\n-                    mc.changeMap(map, map.getPortal(redPortal));\n-                    mc.dropMessage(6, LinguaConstants.Linguas(mc).CPQEntrada);\n+                    mc.forceChangeMap(map, map.getPortal(redPortal));\n+                    mc.dropMessage(6, LanguageConstants.Linguas(mc).CPQEntrada);\n                     if (p1.getLeader().getId() == mc.getId()) {\n                         leader1 = mc;\n                     }\n                     Grupo1 = mc;\n                 }\n             }\n             for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                 if (mc != null) {\n                     mc.setMonsterCarnival(this);\n                     mc.setTeam(1);\n                     mc.setFestivalPoints(0);\n-                    mc.changeMap(map, map.getPortal(bluePortal));\n-                    mc.dropMessage(6, LinguaConstants.Linguas(mc).CPQEntrada);\n+                    mc.forceChangeMap(map, map.getPortal(bluePortal));\n+                    mc.dropMessage(6, LanguageConstants.Linguas(mc).CPQEntrada);\n                     if (p2.getLeader().getId() == mc.getId()) {\n                         leader2 = mc;\n                     }\n@@ -76,10 +78,10 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1) {\n             }\n             if (Grupo1 == null || Grupo2 == null) {\n                 for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                    mpc.getPlayer().dropMessage(5, LinguaConstants.Linguas(mpc.getPlayer()).CPQErro);\n+                    mpc.getPlayer().dropMessage(5, LanguageConstants.Linguas(mpc.getPlayer()).CPQErro);\n                 }\n                 for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                    mpc.getPlayer().dropMessage(5, LinguaConstants.Linguas(mpc.getPlayer()).CPQErro);\n+                    mpc.getPlayer().dropMessage(5, LanguageConstants.Linguas(mpc.getPlayer()).CPQErro);\n                 }\n                 return;\n             }\n@@ -98,6 +100,12 @@ public void run() {\n                     complete();\n                 }\n             }, 10 * 60 * 1000 - 10 * 1000);\n+            respawnTask = TimerManager.getInstance().register(new Runnable() {\n+                @Override\n+                public void run() {\n+                    respawn();\n+                }\n+            }, ServerConstants.RESPAWN_INTERVAL);\n             TimerManager.getInstance().schedule(new Runnable() {\n                 @Override\n                 public void run() {\n@@ -109,6 +117,10 @@ public void run() {\n         }\n     }\n \n+    private void respawn() {\n+        map.respawn();\n+    }\n+    \n     public void playerDisconnected(int charid) {\n         int team = -1;\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n@@ -128,13 +140,13 @@ public void playerDisconnected(int charid) {\n             String teamS = \"\";\n             switch (team) {\n                 case 0:\n-                    teamS = LinguaConstants.Linguas(chrMap).CPQVermelho;\n+                    teamS = LanguageConstants.Linguas(chrMap).CPQVermelho;\n                     break;\n                 case 1:\n-                    teamS = LinguaConstants.Linguas(chrMap).CPQAzul;\n+                    teamS = LanguageConstants.Linguas(chrMap).CPQAzul;\n                     break;\n             }\n-            chrMap.dropMessage(5, teamS + LinguaConstants.Linguas(chrMap).CPQPlayerExit);\n+            chrMap.dropMessage(5, teamS + LanguageConstants.Linguas(chrMap).CPQPlayerExit);\n         }\n         earlyFinish();\n     }\n@@ -151,20 +163,20 @@ protected void dispose() {\n         dispose(false);\n     }\n \n-    public void summon() {\n-        this.summons--;\n+    public void summonR() {\n+        this.summonsR--;\n     }\n \n-    public boolean canSummon() {\n-        return this.summons > 0;\n+    public boolean canSummonR() {\n+        return this.summonsR > 0;\n     }\n \n-    public void summons() {\n-        this.summonss--;\n+    public void summonB() {\n+        this.summonsB--;\n     }\n \n-    public boolean canSummons() {\n-        return this.summonss > 0;\n+    public boolean canSummonB() {\n+        return this.summonsB > 0;\n     }\n \n     protected void dispose(boolean warpout) {\n@@ -176,7 +188,7 @@ protected void dispose(boolean warpout) {\n             out = cs.getMapFactory().getMap(980000000);\n         }\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+            MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n             if (mc != null) {\n                 mc.resetCP();\n                 mc.setTeam(-1);\n@@ -187,7 +199,7 @@ protected void dispose(boolean warpout) {\n             }\n         }\n         for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-            MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+            MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n             if (mc != null) {\n                 mc.resetCP();\n                 mc.setTeam(-1);\n@@ -205,10 +217,16 @@ protected void dispose(boolean warpout) {\n             this.effectTimer.cancel(true);\n             this.effectTimer = null;\n         }\n+        if (this.respawnTask != null) {\n+            this.respawnTask.cancel(true);\n+            this.respawnTask = null;\n+        }\n         redTotalCP = 0;\n         blueTotalCP = 0;\n         leader1.getParty().setEnemy(null);\n         leader2.getParty().setEnemy(null);\n+        map.dispose();\n+        map = null;\n \n     }\n \n@@ -225,7 +243,7 @@ public void finish(int winningTeam) {\n             Channel cs = Server.getInstance().getWorld(p1.getLeader().getWorld()).getChannel(p1.getLeader().getChannel());\n             if (winningTeam == 0) {\n                 for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.redTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -239,7 +257,7 @@ public void finish(int winningTeam) {\n                     }\n                 }\n                 for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.blueTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -254,7 +272,7 @@ public void finish(int winningTeam) {\n                 }\n             } else if (winningTeam == 1) {\n                 for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.blueTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -268,7 +286,7 @@ public void finish(int winningTeam) {\n                     }\n                 }\n                 for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.redTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -312,7 +330,7 @@ public int getTimeLeftSeconds() {\n \n     public void extendTime() {\n         for (MapleCharacter chrMap : map.getAllPlayers()) {\n-            chrMap.dropMessage(5, LinguaConstants.Linguas(chrMap).CPQTempoExtendido);\n+            chrMap.dropMessage(5, LanguageConstants.Linguas(chrMap).CPQTempoExtendido);\n         }\n         startTime = System.currentTimeMillis() + 3 * 1000;\n         map.addClock(3 * 60);\n@@ -340,14 +358,14 @@ public void complete() {\n         int chnl = leader1.getClient().getChannel();\n         int chnl1 = leader2.getClient().getChannel();\n         if (chnl != chnl1) {\n-            throw new RuntimeException(\"Os l\ufffdderes est\ufffdo em canais diferentes.\");\n+            throw new RuntimeException(\"Os lideres estao em canais diferentes.\");\n         }\n \n         Channel cs = Server.getInstance().getWorld(p1.getLeader().getWorld()).getChannel(p1.getLeader().getChannel());\n         map.killAllMonsters();\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n             MapleCharacter mc;\n-            mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+            mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n             if (mc != null) {\n                 if (redWin) {\n                     mc.getClient().announce(MaplePacketCreator.showEffect(\"quest/carnival/win\"));\n@@ -362,7 +380,7 @@ public void complete() {\n         }\n         for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n             MapleCharacter mc;\n-            mc = cs.getPlayerStorage().getCharacterByName(mpc.getName());\n+            mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n             if (mc != null) {\n                 if (!redWin) {\n                     mc.getClient().announce(MaplePacketCreator.showEffect(\"quest/carnival/win\"));\n@@ -486,4 +504,8 @@ public void setCP(int CP, int team) {\n             this.blueCP = CP;\n         }\n     }\n+    \n+    public int getRoom() {\n+        return this.room;\n+    }\n }"}, {"sha": "ab57498e2572f7327850159415e14ce5c7829af6", "filename": "src/server/partyquest/MonsterCarnivalParty.java", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MonsterCarnivalParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/server/partyquest/MonsterCarnivalParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnivalParty.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -15,7 +15,7 @@\n     private MapleCharacter leader;\n     private byte team;\n     private short availableCP = 0, totalCP = 0;\n-    private int summons = 7;\n+    private int summons = 8;\n     private boolean winner = false;\n \n     public MonsterCarnivalParty(final MapleCharacter owner, final List<MapleCharacter> members1, final byte team1) {\n@@ -24,7 +24,7 @@ public MonsterCarnivalParty(final MapleCharacter owner, final List<MapleCharacte\n         team = team1;\n \n         for (final MapleCharacter chr : members) {\n-            chr.setCarnivalParty(this);\n+            chr.setMonsterCarnivalParty(this);\n             chr.setTeam(team);\n         }\n     }\n@@ -63,8 +63,8 @@ public int getTeam() {\n     public void warpOut(final int map) {\n         for (MapleCharacter chr : members) {\n             chr.changeMap(map, 0);\n-            chr.setCarnivalParty(null);\n-            chr.setCarnival(null);\n+            chr.setMonsterCarnivalParty(null);\n+            chr.setMonsterCarnival(null);\n         }\n         members.clear();\n     }\n@@ -77,9 +77,9 @@ public void warp(final MapleMap map, final int portalid) {\n \n     public void warpOut() {\n         if (winner == true)\n-            warpOut(980000003 + (leader.getCarnival().getRoom() * 100));\n+            warpOut(980000003 + (leader.getMonsterCarnival().getRoom() * 100));\n         else\n-            warpOut(980000004 + (leader.getCarnival().getRoom() * 100));\n+            warpOut(980000004 + (leader.getMonsterCarnival().getRoom() * 100));\n     }\n \n     public boolean allInMap(MapleMap map) {\n@@ -95,8 +95,8 @@ public boolean allInMap(MapleMap map) {\n     public void removeMember(MapleCharacter chr) {\n         members.remove(chr);\n         chr.changeMap(980000010);\n-        chr.setCarnivalParty(null);\n-        chr.setCarnival(null);\n+        chr.setMonsterCarnivalParty(null);\n+        chr.setMonsterCarnival(null);\n     }\n \n     public boolean isWinner() {"}, {"sha": "6be1f9ca81457d49067e05be9b9da62e84f4a7da", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -4213,7 +4213,7 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n                 mplew.write(reactor.getState());\n                 mplew.writePos(pos);\n                 mplew.writeShort(0);\n-                mplew.write(reactor.getFacingDirection()); // stance, thanks to Drago/Dragohe4rt\n+                mplew.write(0);\n                 return mplew.getPacket();\n         }\n "}, {"sha": "91779e4d57434927717580da9404f47d7010fcaa", "filename": "src/tools/data/output/GenericLittleEndianWriter.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/data/output/GenericLittleEndianWriter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/data/output/GenericLittleEndianWriter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/data/output/GenericLittleEndianWriter.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -33,7 +33,7 @@\n  * @since Revision 323\n  */\n public class GenericLittleEndianWriter implements LittleEndianWriter {\n-    private static Charset ASCII = Charset.forName(MapleLanguageType.LANGUAGE_PT_BR.getAscii());\n+    private static Charset ASCII = Charset.forName(MapleLanguageType.LANGUAGE_US.getAscii());\n     private ByteOutputStream bos;\n \n     /**"}, {"sha": "437892b2d1edd933c032652c02cd0c54862e8d77", "filename": "src/tools/packets/Wedding.java", "status": "modified", "additions": 6, "deletions": 34, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/packets/Wedding.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/src/tools/packets/Wedding.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/packets/Wedding.java?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -7,7 +7,6 @@\n package tools.packets;\n \n import client.inventory.Item;\n-import client.inventory.MapleInventoryType;\n import client.MapleCharacter;\n import java.util.ArrayList;\n import java.util.List;\n@@ -383,59 +382,32 @@ public int getItem() {\n      *    @return mplew\n      */\n     public static byte[] OnWeddingGiftResult(byte mode, List<String> itemnames, List<Item> items) {\n-        // if (itemnames == null || itemnames.size() < 1) { // for now lol\n-        //     itemnames = new ArrayList<>();\n-        //     itemnames.add(\"mesos\");\n-        //     itemnames.add(\"rare items\");\n-        //     itemnames.add(\"more mesos\");\n-        // }\n         MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n         mplew.writeShort(WEDDING_GIFT_RESULT);\n         mplew.write(mode);\n         switch (mode) {\n+            case 0xC: // 12 : You cannot give more than one present for each wishlist \n+            case 0xE: // 14 : Failed to send the gift.\n+                break;\n+            \n             case 0x09: { // Load Wedding Registry\n                 mplew.write(itemnames.size());\n                 for (String names : itemnames) {\n                     mplew.writeMapleAsciiString(names);\n                 }\n-                mplew.write(items.size());\n-                for (Item item : items) {\n-                    addItemInfo(mplew, item, true);\n-                }\n                 break;\n             }\n             case 0xA: // Load Bride's Wishlist \n             case 0xF: // 10, 15, 16 = CWishListRecvDlg::OnPacket\n             case 0xB: { // Add Item to Wedding Registry \n-                // 11 : You have sent a gift | 12 : You cannot give more than one present for each wishlist | 13 : Failed to send the gift. | 14 : Failed to send the gift.\n+                // 11 : You have sent a gift | | 13 : Failed to send the gift. | \n                 if (mode == 0xB) {\n                     mplew.write(itemnames.size());\n                     for (String names : itemnames) {\n                         mplew.writeMapleAsciiString(names);\n                     }\n                 }\n-                if (items.size() >= 1) {\n-                    switch (items.get((items.size() - 1)).getInventoryType()) {\n-                        case EQUIP:\n-                            mplew.writeLong(4);\n-                            break;\n-                        case USE:\n-                            mplew.writeLong(8);\n-                            break;\n-                        case SETUP:\n-                            mplew.writeLong(16);\n-                            break;\n-                        case ETC:\n-                            mplew.writeLong(32);\n-                            break;\n-                        default: // impossible flag, cash item can't be sent\n-                            if (items.get((items.size() - 1)).getInventoryType() != MapleInventoryType.CASH) {\n-                                mplew.writeLong(0);\n-                            }\n-                    }\n-                } else {\n-                    mplew.writeLong(0);\n-                }\n+                mplew.writeLong(32);\n                 mplew.write(items.size());\n                 for (Item item : items) {\n                     addItemInfo(mplew, item, true);"}, {"sha": "18f2ec8976da458dcfc93a210a61bd15b039f3cf", "filename": "wz/Mob.wz/9300134.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/wz/Mob.wz/9300134.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/wz/Mob.wz/9300134.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300134.img.xml?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -18,7 +18,7 @@\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"1\"/>\n     <int name=\"getCP\" value=\"3\"/>\n-    <string name=\"link\" value=\"4230110\"/>\n+    <string name=\"link\" value=\"3230103\"/>\n     <int name=\"firstAttack\" value=\"1\"/>\n     <string name=\"elemAttr\" value=\"L2\"/>\n     <int name=\"mobType\" value=\"8\"/>"}]}]},
