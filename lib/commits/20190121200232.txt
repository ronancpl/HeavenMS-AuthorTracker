{"fetchDate": "2019-12-19", "content": [{"sha": "224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MjI0ZjVjNjc3YjUwZDg1ZDc5YTNlY2I0ZDAwMzJjMTJlOWFhNjI2Mw==", "commit": {"author": {"name": "MedicOP", "email": "MedicOP@users.noreply.github.com", "date": "2019-01-21T20:02:32Z"}, "committer": {"name": "Ronan Lana", "email": "rcpl2010@gmail.com", "date": "2019-01-21T20:02:32Z"}, "message": "Sort rankings by time of last EXP gain (#352)\n\n* Sort rankings by time of last EXP gain\r\n\r\n* Fix prepared values order", "tree": {"sha": "123c16f85bf6862a79ae3dcaa664638576601fe2", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/123c16f85bf6862a79ae3dcaa664638576601fe2"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "html_url": "https://github.com/ronancpl/HeavenMS/commit/224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/comments", "author": {"login": "MedicOP", "id": 18251099, "node_id": "MDQ6VXNlcjE4MjUxMDk5", "avatar_url": "https://avatars3.githubusercontent.com/u/18251099?v=4", "gravatar_id": "", "url": "https://api.github.com/users/MedicOP", "html_url": "https://github.com/MedicOP", "followers_url": "https://api.github.com/users/MedicOP/followers", "following_url": "https://api.github.com/users/MedicOP/following{/other_user}", "gists_url": "https://api.github.com/users/MedicOP/gists{/gist_id}", "starred_url": "https://api.github.com/users/MedicOP/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/MedicOP/subscriptions", "organizations_url": "https://api.github.com/users/MedicOP/orgs", "repos_url": "https://api.github.com/users/MedicOP/repos", "events_url": "https://api.github.com/users/MedicOP/events{/privacy}", "received_events_url": "https://api.github.com/users/MedicOP/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a0ea6fc779053a1a0f9fc79b7ffe2315763a6b7", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/3a0ea6fc779053a1a0f9fc79b7ffe2315763a6b7", "html_url": "https://github.com/ronancpl/HeavenMS/commit/3a0ea6fc779053a1a0f9fc79b7ffe2315763a6b7"}], "stats": {"total": 18, "additions": 13, "deletions": 5}, "files": [{"sha": "fc3c325ec582de1010091158d85e937595e56a05", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "patch": "@@ -180,6 +180,7 @@ CREATE TABLE IF NOT EXISTS `characters` (\n   `PQPoints` int(11) NOT NULL DEFAULT '0',\n   `dataString` varchar(64) NOT NULL DEFAULT '',\n   `lastLogoutTime` timestamp NOT NULL DEFAULT '2015-01-01 05:00:00',\n+  `lastExpGainTime` timestamp NOT NULL DEFAULT '2015-01-01 05:00:00',\n   `pendantExp` tinyint(1) NOT NULL DEFAULT '0',\n   `jailexpire` bigint(20) NOT NULL DEFAULT '0',\n   PRIMARY KEY (`id`),"}, {"sha": "2775a4f1dad98e2ee9307c4a16df4fdc57365d29", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "patch": "@@ -314,6 +314,7 @@\n     private int banishMap = -1;\n     private int banishSp = -1;\n     private long banishTime = 0;\n+    private long lastExpGainTime;\n     \n     private MapleCharacter() {\n         super.setListener(new AbstractCharacterListener() {\n@@ -2917,7 +2918,11 @@ private synchronized void gainExpInternal(long gain, int equip, int party, boole\n                 }\n             }\n             \n-            if(leftover > 0) gainExpInternal(leftover, equip, party, false, inChat, white);\n+            if(leftover > 0) {\n+                gainExpInternal(leftover, equip, party, false, inChat, white);\n+            } else {\n+                lastExpGainTime = System.currentTimeMillis();\n+            }\n         }\n     }\n \n@@ -6411,6 +6416,7 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             ret.mgc = new MapleGuildCharacter(ret);\n             int buddyCapacity = rs.getInt(\"buddyCapacity\");\n             ret.buddylist = new BuddyList(buddyCapacity);\n+            ret.lastExpGainTime = rs.getTimestamp(\"lastExpGainTime\").getTime();\n             \n             ret.getInventory(MapleInventoryType.EQUIP).setSlotLimit(rs.getByte(\"equipslots\"));\n             ret.getInventory(MapleInventoryType.USE).setSlotLimit(rs.getByte(\"useslots\"));\n@@ -7643,7 +7649,7 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n             con.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);\n             con.setAutoCommit(false);\n             PreparedStatement ps;\n-            ps = con.prepareStatement(\"UPDATE characters SET level = ?, fame = ?, str = ?, dex = ?, luk = ?, `int` = ?, exp = ?, gachaexp = ?, hp = ?, mp = ?, maxhp = ?, maxmp = ?, sp = ?, ap = ?, gm = ?, skincolor = ?, gender = ?, job = ?, hair = ?, face = ?, map = ?, meso = ?, hpMpUsed = ?, spawnpoint = ?, party = ?, buddyCapacity = ?, messengerid = ?, messengerposition = ?, mountlevel = ?, mountexp = ?, mounttiredness= ?, equipslots = ?, useslots = ?, setupslots = ?, etcslots = ?,  monsterbookcover = ?, vanquisherStage = ?, dojoPoints = ?, lastDojoStage = ?, finishedDojoTutorial = ?, vanquisherKills = ?, matchcardwins = ?, matchcardlosses = ?, matchcardties = ?, omokwins = ?, omoklosses = ?, omokties = ?, dataString = ?, fquest = ?, jailexpire = ?, partnerId = ?, marriageItemId = ? WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n+            ps = con.prepareStatement(\"UPDATE characters SET level = ?, fame = ?, str = ?, dex = ?, luk = ?, `int` = ?, exp = ?, gachaexp = ?, hp = ?, mp = ?, maxhp = ?, maxmp = ?, sp = ?, ap = ?, gm = ?, skincolor = ?, gender = ?, job = ?, hair = ?, face = ?, map = ?, meso = ?, hpMpUsed = ?, spawnpoint = ?, party = ?, buddyCapacity = ?, messengerid = ?, messengerposition = ?, mountlevel = ?, mountexp = ?, mounttiredness= ?, equipslots = ?, useslots = ?, setupslots = ?, etcslots = ?,  monsterbookcover = ?, vanquisherStage = ?, dojoPoints = ?, lastDojoStage = ?, finishedDojoTutorial = ?, vanquisherKills = ?, matchcardwins = ?, matchcardlosses = ?, matchcardties = ?, omokwins = ?, omoklosses = ?, omokties = ?, dataString = ?, fquest = ?, jailexpire = ?, partnerId = ?, marriageItemId = ?, lastExpGainTime = ? WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n             if (gmLevel < 1 && level > 199) {\n                 ps.setInt(1, isCygnus() ? 120 : 200);\n             } else {\n@@ -7756,7 +7762,8 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n             ps.setLong(50, jailExpiration);\n             ps.setInt(51, partnerId);\n             ps.setInt(52, marriageItemid);\n-            ps.setInt(53, id);\n+            ps.setTimestamp(53, new Timestamp(lastExpGainTime));\n+            ps.setInt(54, id);\n \n             int updateRows = ps.executeUpdate();\n             ps.close();"}, {"sha": "cc2c71591e3f1118e5b5b3edcc13d7932dfc05a9", "filename": "src/net/server/Server.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "patch": "@@ -784,7 +784,7 @@ private void initWorldPlayerRanking() {\n                 worldQuery = (\" AND `characters`.`world` >= 0 AND `characters`.`world` <= \" + Math.abs(worldid));\n             }\n             \n-            ps = con.prepareStatement(\"SELECT `characters`.`name`, `characters`.`level`, `characters`.`world` FROM `characters` LEFT JOIN accounts ON accounts.id = characters.accountid WHERE `characters`.`gm` < 2 AND `accounts`.`banned` = '0'\" + worldQuery + \" ORDER BY \" + (!ServerConstants.USE_WHOLE_SERVER_RANKING ? \"world, \" : \"\") + \"level DESC, exp DESC LIMIT 50\");\n+            ps = con.prepareStatement(\"SELECT `characters`.`name`, `characters`.`level`, `characters`.`world` FROM `characters` LEFT JOIN accounts ON accounts.id = characters.accountid WHERE `characters`.`gm` < 2 AND `accounts`.`banned` = '0'\" + worldQuery + \" ORDER BY \" + (!ServerConstants.USE_WHOLE_SERVER_RANKING ? \"world, \" : \"\") + \"level DESC, exp DESC, lastExpGainTime ASC LIMIT 50\");\n             rs = ps.executeQuery();\n             \n             if (!ServerConstants.USE_WHOLE_SERVER_RANKING) {"}, {"sha": "32cc51afd783c6202ec02c3d17527f4295bd35dc", "filename": "src/net/server/worker/RankingLoginWorker.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/net/server/worker/RankingLoginWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/224f5c677b50d85d79a3ecb4d0032c12e9aa6263/src/net/server/worker/RankingLoginWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/RankingLoginWorker.java?ref=224f5c677b50d85d79a3ecb4d0032c12e9aa6263", "patch": "@@ -50,7 +50,7 @@ private void updateRanking(int job, int world) throws SQLException {\n         if (job != -1) {\n             sqlCharSelect += \"AND c.job DIV 100 = ? \";\n         }\n-        sqlCharSelect += \"ORDER BY c.level DESC , c.exp DESC , c.fame DESC , c.meso DESC\";\n+        sqlCharSelect += \"ORDER BY c.level DESC , c.exp DESC , c.lastExpGainTime ASC, c.fame DESC , c.meso DESC\";\n         \n         PreparedStatement charSelect = con.prepareStatement(sqlCharSelect);\n         charSelect.setInt(1, world);"}]}]},
