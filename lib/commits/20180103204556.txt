{"fetchDate": "2019-12-19", "content": [{"sha": "1190513d0c0ba17f826782b68df502627cb7af15", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MTE5MDUxM2QwYzBiYTE3ZjgyNjc4MmI2OGRmNTAyNjI3Y2I3YWYxNQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-01-03T20:45:56Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-01-03T20:45:56Z"}, "message": "Improved item & drop-point checking + Dojo fixes + Duey revamp\n\nFixed some issues with items being dropped sometimes out-of-reach and in a weird way.\nImproved item checking function, now looking up one-of-a-kind items properly.\nFixed some issues with dojo skills and possible exploits in dojo progression.\nImproved Duey, now displaying better info to players.", "tree": {"sha": "886dcff30a4427ad248603be1abd0edef5d35d1c", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/886dcff30a4427ad248603be1abd0edef5d35d1c"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/1190513d0c0ba17f826782b68df502627cb7af15", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/1190513d0c0ba17f826782b68df502627cb7af15", "html_url": "https://github.com/ronancpl/HeavenMS/commit/1190513d0c0ba17f826782b68df502627cb7af15", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/1190513d0c0ba17f826782b68df502627cb7af15/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "012f965f6ae9464038bfc577248efc3ecf78d81f", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/012f965f6ae9464038bfc577248efc3ecf78d81f", "html_url": "https://github.com/ronancpl/HeavenMS/commit/012f965f6ae9464038bfc577248efc3ecf78d81f"}], "stats": {"total": 1204, "additions": 781, "deletions": 423}, "files": [{"sha": "03f01ad357652b7ffef181b3fae61eb756bd9816", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -728,4 +728,27 @@ MapleQuestItemFetcher agora mostra quests j\n 17 - 19 Dezembro 2017,\n Implementado New Years card.\n Adicionado informa\ufffd\ufffdo, destinado ao dono da loja, de compra de itens dos Player Shops e dos Hired Merchants.\n-Resolvido um problema com overflow em Player Shops.\n\\ No newline at end of file\n+Resolvido um problema com overflow em Player Shops.\n+\n+20 - 22 Dezembro 2017,\n+Resolvido problema com itens ainda saindo das bordas de alguns mapas em certos casos.\n+Corrigido Enhanced Crafting com a Agent E rodando probabilidade do Chaos Scroll ao fazer o item.\n+Resolvido um problema com certos mapas n\ufffdo possuindo minimapa fazendo drops cairem sempre na posi\ufffd\ufffdo x = 0.\n+Corrigido pets reduzindo fullness enquanto no Cash Shop ou no MTS.\n+Corrigido bug em skills de PQ/Dojo para players que tem skill level = 0. Espera-se que todos possam \"ativ\ufffd-las\".\n+Modificado mapa de fora do dojo agora resetando dojo energy, evitando assim poss\ufffdvel exploit com skills do dojo.\n+Corrigido exploit em dojos permitindo que jogadores acessem mapas de est\ufffdgios avan\ufffdados se n\ufffdo progrediram juntos nos est\ufffdgios anteriores.\n+Pontos agora est\ufffdo sendo corretamente atribu\ufffddos aos jogadores que est\ufffdo sendo automaticamente levados para o pr\ufffdximo rest point (quando um jogador passa pelo \ufffdltimo portal de cada etapa).\n+Corrigido jogador comprando itens one-of-a-kind dos Hired Merchants quando n\ufffdo se pode obt\ufffd-los.\n+\n+23 - 24 Dezembro 2017,\n+Corrigido checagem de itens no invent\ufffdrio n\ufffdo verificando apropriadamente itens one-of-a-kind.\n+Adicionado e corrigido v\ufffdrios aspectos do Duey. Descoberto opcodes e respostas de a\ufffd\ufffdes de jogadores.\n+Corrigido autopot agora contabilizando bonus de HP e MP dos equipamentos nos stats a serem checados.\n+Adicionado Ereve na lista de plataformas de Orbis.\n+\n+27 Dezembro 2017,\n+Corrigido AP reset modificando stats de forma err\ufffdnea.\n+\n+03 Janeiro 2018,\n+Corrigido item megafone permitindo o display de equipamentos n\ufffdo-comercializ\ufffdveis, mesmo marcados como Untradeable.\n\\ No newline at end of file"}, {"sha": "9c5bdc793c4ae99182b89ea316b3215c8e5d9bdb", "filename": "handbook/Map.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/handbook/Map.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/handbook/Map.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/handbook/Map.txt?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -1492,7 +1492,7 @@ ossyria\n 270010300 - Time Lane - Memory Lane3\n 270010310 - Time Lane - Resting Spot of Memory3\n 270010400 - Time Lane - Memory Lane4\n-270010410 - Memory Keeper - Resting Spot of Memory4\n+270010410 - Time Lane - Resting Spot of Memory4\n 270010500 - Time Lane - Memory Lane5\n 270020000 - Time Lane - Frozen Past\n 270020100 - Time Lane - Road of Regrets1"}, {"sha": "38574f5d9386dc85fe74a66f9f7468e2724c88c4", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -2,6 +2,14 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"2\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group/>\n+        <group>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/constants/skills/Legend.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/server/MapleInventoryManipulator.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/net/server/channel/handlers/MessengerHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/net/server/channel/handlers/UseCashItemHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/client/SkillFactory.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/client/MapleCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/server/MapleItemInformationProvider.java</file>\n+        </group>\n     </open-files>\n </project-private>"}, {"sha": "20a5f32f01f41929021a413a55ee5e7862e5ae79", "filename": "scripts/map/onUserEnter/dojang_Msg.js", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/map/onUserEnter/dojang_Msg.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/map/onUserEnter/dojang_Msg.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/dojang_Msg.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -31,6 +31,8 @@ function start(ms) {\n         if(ms.getPlayer().getMap().findClosestPlayerSpawnpoint(ms.getPlayer().getPosition()).getId() == 0) {\n             ms.getPlayer().startMapEffect(messages[(Math.random() * messages.length) | 0], 5120024);\n         }\n+        \n+        ms.resetDojoEnergy();\n     } else {\n         ms.getPlayer().resetEnteredScript(); //in case the person dcs in here we set it at dojang_tuto portal\n         ms.getPlayer().startMapEffect(\"Ha! Let's see what you got! I won't let you leave unless you defeat me first!\", 5120024);"}, {"sha": "394c27fb86ec24dbbf7d50249992bae5abca1774", "filename": "scripts/npc/1061016.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/1061016.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/1061016.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061016.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -22,7 +22,7 @@ function action(mode, type, selection) {\n \t} else if (status == 2) {\n \t\tif (!cm.canHold(itemids[selection], 1)) {\n \t\t\tcm.sendOk(\"Please make room\");\n-\t\t} else if (cm.getItemQuantity(4001261) < 1) {\n+\t\t} else if (!cm.haveItemWithId(4001261)) {\n \t\t\tcm.sendOk(\"You don't have enough leathers.\");\n \t\t} else {\n \t\t\tcm.gainItem(4001261, -1);"}, {"sha": "45f13cf2fe83c63208d0c3907fa4fce82cabef7f", "filename": "scripts/npc/1202009.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/1202009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/1202009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1202009.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -6,7 +6,7 @@ function start() {\n }\n \n function action(mode, type, selection) {\n-    if(cm.getPlayer().getItemQuantity(1902016, true) > 0) {\n+    if(cm.haveItemWithId(1902016, true)) {\n         cm.warp(140010210, 0);\n     } else {\n         cm.sendOk(\"What is it? If you you're here to waste my time, get lost!\");"}, {"sha": "e2ea9c0ebcfece98ab481ab486260925edf02bbb", "filename": "scripts/npc/2012006.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2012006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2012006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2012006.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -1,8 +1,8 @@\n var status = -1;\n var sel;\n \n-var destinations = new Array(\"Ellinia\", \"Ludibrium\", \"Leafre\", \"Mu Lung\", \"Ariant\");\n-var boatType = new Array(\"the ship\", \"the ship\", \"Hak\", \"Hak\", \"Genie\");\n+var destinations = new Array(\"Ellinia\", \"Ludibrium\", \"Leafre\", \"Mu Lung\", \"Ariant\", \"Ereve\");\n+var boatType = new Array(\"the ship\", \"the train\", \"the bird\", \"Hak\", \"Genie\", \"the ship\");\n \n function start() {\n \tvar message = \"Orbis Station has lots of platforms available to choose from. You need to choose the one that'll take you to the destination of your choice. Which platform will you take?\\r\\n\";\n@@ -20,8 +20,8 @@ function action(mode, type, selection) {\n     status++;\n     if (status == 0){\n         sel = selection;\n-        cm.sendNext(\"Ok #h #, I will send you to the platform for #m\" + (200000110 + (sel * 10)) + \"#\");\n-\t}else if (status == 1) {\n+        cm.sendNext(\"Ok #h #, I will send you to the platform for #b#m\" + (200000110 + (sel * 10)) + \"##k.\");\n+    }else if (status == 1) {\n         cm.warp(200000110 + (sel * 10), \"west00\");\n         cm.dispose();\n     }"}, {"sha": "3033722b8a50496b7c8bbeef57234c3733f5b4e7", "filename": "scripts/npc/2091005.js", "status": "modified", "additions": 50, "deletions": 46, "changes": 96, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -1,8 +1,6 @@\n /*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n+    This file is part of the HeavenMS (MapleSolaxiaV2) MapleStory Server\n+    Copyleft (L) 2017 RonanLana\n \n     This program is free software: you can redistribute it and/or modify\n     it under the terms of the GNU Affero General Public License as\n@@ -30,6 +28,7 @@ importPackage(Packages.server.maps);\n var disabled = false;\n var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);\n var belt_level = Array(25, 35, 45, 60, 75);\n+var belt_on_inventory;\n \n /* var belt_points = Array(200, 1800, 4000, 9200, 17000); */\n var belt_points = Array(10, 90, 200, 460, 850); /* Watered down version */\n@@ -45,6 +44,11 @@ function start() {\n         return;\n     }\n     \n+    belt_on_inventory = new Array();\n+    for (var i = 0; i < belts.length; i++) {\n+        belt_on_inventory.push(cm.haveItemWithId(belts[i], true));\n+    }\n+                            \n     action(1, 0, 0);\n }\n \n@@ -112,42 +116,24 @@ function action(mode, type, selection) {\n                                 }\n                             }\n                         } else if (cm.getPlayer().getDojoStage() > 0) {\n-                            if (status == 1) {\n-                                dojoWarp = cm.getPlayer().getDojoStage();\n-                                cm.getPlayer().setDojoStage(0);\n-                                cm.sendYesNo(\"The last time you took the challenge by yourself, you went up to level \" + dojoWarp + \". I can take you there right now. Do you want to go there?\");\n-                            } else {\n-                                var avDojo = cm.getClient().getChannelServer().getAvailableDojo(false);\n-\n-                                if(avDojo < 0) {\n-                                    if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n-                                    else cm.sendOk(\"Either your party is already using the Dojo or your party's allotted time on the Dojo has not expired yet. Wait for them to finish to enter.\");\n-                                    cm.getPlayer().setDojoStage(dojoWarp);\n-                                }\n-                                else {\n-                                    var warpDojoMap = ((mode == 1) ? 925020000 + (dojoWarp + 1) * 100 + avDojo : 925020100 + avDojo);\n-                                    cm.getClient().getChannelServer().resetDojoMap(warpDojoMap);\n-                                    cm.getClient().getChannelServer().resetDojo(warpDojoMap);\n-                                    \n-                                    cm.resetDojoEnergy();\n-                                    cm.warp(warpDojoMap, 0);\n-                                }\n-\n-                                cm.dispose();\n-                            }\n+                            dojoWarp = cm.getPlayer().getDojoStage();\n+                            cm.getPlayer().setDojoStage(0);\n+                            cm.sendYesNo(\"The last time you took the challenge by yourself, you went up to level #b\" + dojoWarp + \"#k. I can take you there right now. Do you want to go there? (Select #rNo#k to erase this record.)\");\n                         } else {\n                             var avDojo = cm.getClient().getChannelServer().getAvailableDojo(false);\n \n                             if(avDojo < 0) {\n                                 if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n                                 else cm.sendOk(\"Either your party is already using the Dojo or your party's allotted time on the Dojo has not expired yet. Wait for them to finish to enter.\");\n-                            }\n-                            else {\n-                                cm.getClient().getChannelServer().resetDojoMap(925020100 + avDojo);\n-                                cm.getClient().getChannelServer().resetDojo(925020100 + avDojo);\n+                                \n+                                cm.getPlayer().setDojoStage(dojoWarp);\n+                            } else {\n+                                var warpDojoMap = 925020000 + (dojoWarp + 1) * 100 + avDojo;\n+                                cm.getClient().getChannelServer().resetDojoMap(warpDojoMap);\n+                                cm.getClient().getChannelServer().resetDojo(warpDojoMap);\n                                 \n                                 cm.resetDojoEnergy();\n-                                cm.warp(925020100 + avDojo, 0);\n+                                cm.warp(warpDojoMap, 0);\n                             }\n \n                             cm.dispose();\n@@ -181,8 +167,7 @@ function action(mode, type, selection) {\n                             if(avDojo < 0) {\n                                 if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n                                 else cm.sendOk(\"Either your party is already using the Dojo or your party's allotted time on the Dojo has not expired yet. Wait for them to finish to enter.\");\n-                            }\n-                            else {\n+                            } else {\n                                 cm.getClient().getChannelServer().resetDojoMap(925030100 + avDojo);\n                                 cm.getClient().getChannelServer().resetDojo(925030100 + avDojo);\n                                 \n@@ -207,7 +192,7 @@ function action(mode, type, selection) {\n                         if (status == 1) {\n                             var selStr = \"You have #b\" + cm.getPlayer().getDojoPoints() + \"#k training points. Master prefers those with great talent. If you obtain more points than the average, you can receive a belt depending on your score.\\r\\n\";\n                             for (var i = 0; i < belts.length; i++) {\n-                                if (cm.getPlayer().getItemQuantity(belts[i], true) > 0) {\n+                                if (belt_on_inventory[i]) {\n                                     selStr += \"\\r\\n#L\" + i + \"##i\" + belts[i] + \"# #t\" + belts[i] + \"# (Already on inventory)\";\n                                 } else\n                                     selStr += \"\\r\\n#L\" + i + \"##i\" + belts[i] + \"# #t\" + belts[i] + \"#\";\n@@ -217,16 +202,24 @@ function action(mode, type, selection) {\n                             var belt = belts[selection];\n                             var level = belt_level[selection];\n                             var points = belt_points[selection];\n-                            if (cm.getPlayer().getDojoPoints() >= points) {\n-                                if (cm.getPlayer().getLevel() > level) {\n+                            \n+                            var oldbelt = (selection > 0) ? belts[selection - 1] : -1;\n+                            var haveOldbelt = (oldbelt == -1 || cm.haveItemWithId(oldbelt, false));\n+                            \n+                            if (selection > 0 && !belt_on_inventory[selection - 1]) {\n+                                sendBeltRequirements(belt, oldbelt, haveOldbelt, level, points);\n+                            } else if (cm.getPlayer().getDojoPoints() >= points) {\n+                                if (selection > 0 && !haveOldbelt) {\n+                                    sendBeltRequirements(belt, oldbelt, haveOldbelt, level, points);\n+                                } else if (cm.getPlayer().getLevel() > level) {\n+                                    if(selection > 0) cm.gainItem(oldbelt, -1);\n                                     cm.gainItem(belt, 1);\n                                     cm.getPlayer().setDojoPoints(cm.getPlayer().getDojoPoints() - points);\n                                     cm.sendNext(\"There is the #i\" + belt + \"# #b#t\" + belt + \"##k. You have proven your valor to ascend on the Dojo ranks. Well done!\");\n-                                }\n-                                else\n-                                    cm.sendNext(\"In order to receive #i\" + belt + \"# #b#t\" + belt + \"##k, you have to be at least over level #b\" + level + \"#k and you need to have earned at least #b\" + points + \" training points#k.\\r\\n\\r\\nIf you want to obtain this belt, you need #r\" + (points - cm.getPlayer().getDojoPoints()) + \"#k more training points.\");\n+                                } else\n+                                    sendBeltRequirements(belt, oldbelt, haveOldbelt, level, points);\n                             } else\n-                                cm.sendNext(\"In order to receive #i\" + belt + \"# #b#t\" + belt + \"##k, you have to be at least over level #b\" + level + \"#k and you need to have earned at least #b\" + points + \" training points#k.\\r\\n\\r\\nIf you want to obtain this belt, you need #r\" + (points - cm.getPlayer().getDojoPoints()) + \"#k more training points.\");\n+                                sendBeltRequirements(belt, oldbelt, haveOldbelt, level, points);\n \n                             cm.dispose();\n                             return;\n@@ -267,8 +260,7 @@ function action(mode, type, selection) {\n \n                             cm.dispose();\n                             return;\n-                        }\n-                        else {\n+                        } else {\n                             cm.dispose();\n                             return;\n                         }\n@@ -312,8 +304,7 @@ function action(mode, type, selection) {\n                     if(avDojo < 0) {\n                         if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n                         else cm.sendOk(\"Your party already registered for the dojo. Wait for the end of the registration time to enter again.\");\n-                    }\n-                    else {\n+                    } else {\n                         var baseStg = hasParty ? 925030000 : 925020000;\n                         var nextStg = Math.floor((cm.getPlayer().getMap().getId() + 100) / 100) % 100;\n \n@@ -323,6 +314,9 @@ function action(mode, type, selection) {\n                             cm.getClient().getChannelServer().resetDojo(dojoWarpMap, nextStg - 1);\n                         }\n                         \n+                        //non-leader party members can progress whilst having the record saved if they don't command to enter the next stage\n+                        cm.getPlayer().setDojoStage(0);\n+                        \n                         if(!hasParty || !cm.isLeader()) cm.warp(dojoWarpMap, 0);\n                         else cm.warpParty(dojoWarpMap, 0);\n                     }\n@@ -348,7 +342,7 @@ function action(mode, type, selection) {\n                         } else if (cm.getPlayer().getDojoStage() == Math.floor(cm.getMapId() / 100) % 100) {\n                             cm.sendOk(\"Looks like you came all the way up here without recording your score. Sorry, but you can't record now.\");\n                         } else {\n-                            cm.sendNext(\"I recorded your score. If you tell me the next time you go up, you'll be able to start where you left off.\");\n+                            cm.sendNext(\"I recorded your score. If you tell me the next time you go up, you'll be able to start where you left off. Note that you will have your #rrecord erased#k if you choose to #bcontinue challenging the Dojo#k, so choose carefully.\");\n                             cm.getPlayer().setDojoStage(Math.floor(cm.getMapId() / 100) % 100);\n                         }\n                         cm.dispose();\n@@ -372,6 +366,16 @@ function action(mode, type, selection) {\n     }\n }\n \n+function sendBeltRequirements(belt, oldbelt, haveOldbelt, level, points) {\n+    var beltReqStr = (oldbelt != -1) ? \" you must have the #i\" + oldbelt + \"# belt in your inventory,\" : \"\";\n+    \n+    var pointsLeftStr = (points - cm.getPlayer().getDojoPoints() > 0) ? \" you need #r\" + (points - cm.getPlayer().getDojoPoints()) + \"#k more training points\" : \"\";\n+    var beltLeftStr = (!haveOldbelt) ? \" you must have the needed belt unequipped and available in your EQP inventory\" : \"\";\n+    var conjStr = (pointsLeftStr.length > 0 && beltLeftStr.length > 0) ? \" and\" : \"\";\n+        \n+    cm.sendNext(\"In order to receive #i\" + belt + \"# #b#t\" + belt + \"##k,\" + beltReqStr + \" you have to be at least over level #b\" + level + \"#k and you need to have earned at least #b\" + points + \" training points#k.\\r\\n\\r\\nIf you want to obtain this belt,\" + beltLeftStr + conjStr + pointsLeftStr + \".\");\n+}\n+\n function isRestingSpot(id) {\n     return (Math.floor(id / 100) % 100) % 6 == 0 && id != 925020001;\n }"}, {"sha": "cf50676a38b24d73d7d4cc83598dbe19e1975ec1", "filename": "scripts/npc/2091005_old.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2091005_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2091005_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005_old.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -154,7 +154,7 @@ function action(mode, type, selection) {\n                 if (status == 0) {\n                     var selStr = \"You have #b\" + cm.getPlayer().getDojoPoints() + \"#k training points. Master prefers those with great talent. If you obtain more points than the average, you can receive a belt depending on your score.\\r\\n\";\n                     for (var i = 0; i < belts.length; i++) {\n-                        if (cm.getPlayer().getItemQuantity(belts[i], true) > 0) {\n+                        if (cm.haveItemWithId(belts[i], true)) {\n                             selStr += \"\\r\\n     #i\" + belts[i] + \"# #t\" + belts[i] + \"#(Obtain)\";\n                         } else\n                             selStr += \"\\r\\n#L\" + i + \"##i\" + belts[i] + \"# #t\" + belts[i] + \"#l\";"}, {"sha": "b1e5b9c5e9f17a2119bffeeb8f138f664102be16", "filename": "scripts/npc/2141000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2141000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/2141000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2141000.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -4,7 +4,7 @@\n  */\n \n function start() {\n-    cm.askAcceptDecline(\"If only I had the Mirror of Goodness then I can re-summon the Black Wizard! \\r\\nWait! something's not right! Why is the Black Wizard not summoned? Wait, what's this force? I feel something... totally different from the Black Wizard Ahhhhh!!!!! \\r\\n\\r\\n #b(Places a hand on the shoulder of Kryston.)\");\n+    cm.sendAcceptDecline(\"If only I had the Mirror of Goodness then I can re-summon the Black Wizard! \\r\\nWait! something's not right! Why is the Black Wizard not summoned? Wait, what's this force? I feel something... totally different from the Black Wizard Ahhhhh!!!!! \\r\\n\\r\\n #b(Places a hand on the shoulder of Kryston.)\");\n }\n \n function action(mode, type, selection) {"}, {"sha": "fac3b5f4071379410405f783aa5f32e3ef1d0f1f", "filename": "scripts/npc/9201106.js", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/9201106.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/npc/9201106.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201106.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -0,0 +1,46 @@\n+/*\n+    This file is part of the HeavenMS (MapleSolaxiaV2) MapleStory Server\n+    Copyleft (L) 2017 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status;\n+ \n+function start() {\n+        status = -1;\n+        action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if(status == 0) {\n+                        cm.sendOk(\"I came from far-away places looking for people powerful enough to join my expedition against the evil that lays waste on this land. Are you, by any chance, one of those people?\");\n+                        cm.dispose();\n+                }\n+        }\n+}"}, {"sha": "c7e72bd3bd9660dcfa4b3d3e49c08d7b022bac44", "filename": "scripts/portal/dojang_next.js", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/dojang_next.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/dojang_next.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/dojang_next.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -32,15 +32,31 @@ function enter(pi) {\n     if(gate != null) {\n         if (gate.getState() == 1 || pi.getMap().countMonsters() == 0) {\n             if (Math.floor(pi.getPlayer().getMapId() / 100) % 100 < 38) {\n-                pi.getPlayer().message(\"You received \" + pi.getPlayer().addDojoPointsByMap() + \" training points. Your total training points score is now \" + pi.getPlayer().getDojoPoints() + \".\");\n-\n                 if(((Math.floor((pi.getPlayer().getMap().getId() + 100) / 100)) % 100) % 6 == 0) {\n                     if(Math.floor(pi.getPlayer().getMapId() / 10000) == 92503) {\n-                        pi.warpParty(pi.getPlayer().getMap().getId() + 100, 925030100, 925033804);\n+                        var restMapId = pi.getPlayer().getMap().getId() + 100;\n+                        var mapId = pi.getPlayer().getMap().getId();\n+                        \n+                        for(var i = 0; i < 5; i++) {\n+                            var chrlist = pi.getMap(mapId - 100 * i).getAllPlayers();\n+                                \n+                            var pIter = chrlist.iterator();\n+                            while (pIter.hasNext()) {\n+                                var chr = pIter.next();\n+                                \n+                                for(var j = i; j >= 0; j--) {\n+                                    chr.message(\"You received \" + chr.addDojoPointsByMap(mapId - 100 * j) + \" training points. Your total training points score is now \" + chr.getDojoPoints() + \".\");\n+                                }\n+                                \n+                                chr.changeMap(restMapId, 0);\n+                            }\n+                        }\n                     } else {\n+                        pi.getPlayer().message(\"You received \" + pi.getPlayer().addDojoPointsByMap(pi.getMapId()) + \" training points. Your total training points score is now \" + pi.getPlayer().getDojoPoints() + \".\");\n                         pi.warp(pi.getPlayer().getMap().getId() + 100, 0);\n                     }\n                 } else {\n+                    pi.getPlayer().message(\"You received \" + pi.getPlayer().addDojoPointsByMap(pi.getMapId()) + \" training points. Your total training points score is now \" + pi.getPlayer().getDojoPoints() + \".\");\n                     pi.warp(pi.getPlayer().getMap().getId() + 100, 0);\n                 }\n             } else {"}, {"sha": "b39319a95677dfd7672fd7ab0e92dde91ede940e", "filename": "scripts/portal/enterSecondDH.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/enterSecondDH.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/enterSecondDH.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterSecondDH.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -26,6 +26,12 @@\n function enter(pi) {\n     var maps = [108000600, 108000601, 108000602];\n     if(pi.isQuestStarted(20201) || pi.isQuestStarted(20202) || pi.isQuestStarted(20203) || pi.isQuestStarted(20204) || pi.isQuestStarted(20205)) {\n+        pi.removeAll(4032096);\n+        pi.removeAll(4032097);\n+        pi.removeAll(4032098);\n+        pi.removeAll(4032099);\n+        pi.removeAll(4032100);\n+        \n         var rand = Math.floor(Math.random() * maps.length);\n         pi.warp(maps[rand], 0);\n         return true;"}, {"sha": "aab05d9aceb4ea17870cceda8fd284fd0ef98730", "filename": "scripts/portal/tutorquest.js", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/tutorquest.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/portal/tutorquest.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/tutorquest.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -2,15 +2,32 @@ function enter(pi) {\n \tif(pi.getPlayer().getMapId() == 130030001){\n \t\tif(pi.isQuestStarted(20010)){\n \t\t\tpi.warp(130030002, 0);\n+                        return true;\n \t\t} else {\n \t\t\tpi.message(\"Please click on the NPC first to receive a quest.\");\n \t\t}\n \t} else if(pi.getPlayer().getMapId() == 130030002){\n-\t\tpi.warp(130030003, 0);\n+                if(pi.isQuestCompleted(20011)){\n+\t\t\tpi.warp(130030003, 0);\n+                        return true;\n+\t\t} else {\n+\t\t\tpi.message(\"Please complete the required quest before proceeding.\");\n+\t\t}\n \t} else if(pi.getPlayer().getMapId() == 130030003){\n-\t\tpi.warp(130030004, 0);\n+\t\tif(pi.isQuestCompleted(20012)){\n+\t\t\tpi.warp(130030004, 0);\n+                        return true;\n+\t\t} else {\n+\t\t\tpi.message(\"Please complete the required quest before proceeding.\");\n+\t\t}\n \t} else if(pi.getPlayer().getMapId() == 130030004){\n-\t\tpi.warp(130030005, 0);\n+\t\tif(pi.isQuestCompleted(20013)){\n+\t\t\tpi.warp(130030005, 0);\n+                        return true;\n+\t\t} else {\n+\t\t\tpi.message(\"Please complete the required quest before proceeding.\");\n+\t\t}\n \t}\n-\treturn true;\n+        \n+        return false;\n }\n\\ No newline at end of file"}, {"sha": "cc8c4a9a4289670d7b9da3022c9b070d72b165fa", "filename": "scripts/quest/20700.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/20700.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/20700.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20700.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -24,7 +24,7 @@ function start(mode, type, selection) {\n     if (status == 0) {\n         qm.sendNext(\"You have finally become a Knight-in-Training. I'd like to give you a mission right away, but you still look miles away from even being able to handle a task on your own. Are you sure you can even go to Victoria Island like this?\");\n     } else if (status == 1) {\n-        qm.askAcceptDecline(\"It's up to you to head over to Victoria Island, but a Knight-in-Training that can't take care of one's self in battles is likely to cause harm to the Empress's impeccable reputation. As the Head Tactician of this island, I can't let that happen, period. I want you to keep training until the right time comes.\");\n+        qm.sendAcceptDecline(\"It's up to you to head over to Victoria Island, but a Knight-in-Training that can't take care of one's self in battles is likely to cause harm to the Empress's impeccable reputation. As the Head Tactician of this island, I can't let that happen, period. I want you to keep training until the right time comes.\");\n     } else if (status == 2) {\n         qm.forceCompleteQuest();\n         qm.sendNext(\"#p1102000#, the Training Instructor, will help you train into a serviceable knight. Once you reach Level 13, I'll assign you a mission or two. So until then, keep training.\");"}, {"sha": "e32b0f569ad30e400012e41f35309b8177d4344e", "filename": "scripts/quest/21618.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/21618.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/21618.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21618.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -64,7 +64,7 @@ function end(mode, type, selection) {\n             status--;\n         \n         if (status == 0) {\n-            if(qm.getPlayer().getItemQuantity(1902017, false) == 0) {\n+            if(!qm.haveItemWithId(1902017, false)) {\n                 qm.sendNext(\"You will have to unequip the wolf first before going for the evolution.\");\n                 qm.dispose();\n                 return;"}, {"sha": "046e056dfb407ff62ebfa3f8d8ab0ebf281eab61", "filename": "scripts/quest/3382.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/3382.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/scripts/quest/3382.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3382.js?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -28,7 +28,7 @@\n */\n \n function end(mode, type, selection) {\n-        if(qm.haveItem(4001159, 25) && qm.haveItem(4001160, 25) && qm.getPlayer().getItemQuantity(1122010, true) == 0) {\n+        if(qm.haveItem(4001159, 25) && qm.haveItem(4001160, 25) && !qm.haveItemWithId(1122010, true)) {\n             if(qm.canHold(1122010)) {\n                 qm.gainItem(4001159, -25);\n                 qm.gainItem(4001160, -25);"}, {"sha": "e6c2663de0e9f62808091ddff88461869c2b0b88", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -497,10 +497,10 @@ public MapleRing getRingById(int id) {\n         return null;\n     }\n \n-    public int addDojoPointsByMap() {\n+    public int addDojoPointsByMap(int mapid) {\n         int pts = 0;\n         if (dojoPoints < 17000) {\n-            pts = 1 + ((getMap().getId() - 1) / 100 % 100) / 6;\n+            pts = 1 + ((mapid - 1) / 100 % 100) / 6;\n             if (!getDojoParty()) {\n                 pts++;\n             }\n@@ -1589,7 +1589,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n     }\n \n     public int countItem(int itemid) {\n-        return inventory[ii.getInventoryType(itemid).ordinal()].countById(itemid);\n+        return inventory[ItemConstants.getInventoryType(itemid).ordinal()].countById(itemid);\n     }\n     \n     public boolean canHold(int itemid) {\n@@ -1604,7 +1604,7 @@ public boolean canHold(int itemid, int quantity) {\n                 return true;\n         }\n \n-        return getInventory(ii.getInventoryType(itemid)).getNextFreeSlot() > -1;\n+        return getInventory(ItemConstants.getInventoryType(itemid)).getNextFreeSlot() > -1;\n     }\n \n     public void decreaseBattleshipHp(int decrease) {\n@@ -3800,16 +3800,21 @@ public int getItemEffect() {\n         return itemEffect;\n     }\n \n+    public boolean haveItemWithId(int itemid, boolean checkEquipped) {\n+        return (inventory[ItemConstants.getInventoryType(itemid).ordinal()].findById(itemid) != null) ||\n+        (checkEquipped && inventory[MapleInventoryType.EQUIPPED.ordinal()].findById(itemid) != null);\n+    }\n+    \n     public int getItemQuantity(int itemid, boolean checkEquipped) {\n-        int possesed = inventory[ii.getInventoryType(itemid).ordinal()].countById(itemid);\n+        int possesed = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countById(itemid);\n         if (checkEquipped) {\n             possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countById(itemid);\n         }\n         return possesed;\n     }\n     \n     public int getCleanItemQuantity(int itemid, boolean checkEquipped) {\n-        int possesed = inventory[ii.getInventoryType(itemid).ordinal()].countNotOwnedById(itemid);\n+        int possesed = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countNotOwnedById(itemid);\n         if (checkEquipped) {\n             possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countNotOwnedById(itemid);\n         }\n@@ -4697,7 +4702,7 @@ public boolean haveCleanItem(int itemid) {\n     }\n     \n     public boolean hasEmptySlot(int itemId) {\n-        return getInventory(ii.getInventoryType(itemId)).getNextFreeSlot() > -1;\n+        return getInventory(ItemConstants.getInventoryType(itemId)).getNextFreeSlot() > -1;\n     }\n     \n     public boolean hasEmptySlot(byte invType) {\n@@ -5767,7 +5772,7 @@ private void playerDead() {\n         }\n         if (possesed > 0) {\n             message(\"You have used a safety charm, so your EXP points have not been decreased.\");\n-            MapleInventoryManipulator.removeById(client, ii.getInventoryType(charmID[i]), charmID[i], 1, true, false);\n+            MapleInventoryManipulator.removeById(client, ItemConstants.getInventoryType(charmID[i]), charmID[i], 1, true, false);\n         } else if (mapid > 925020000 && mapid < 925030000) {\n             this.dojoStage = 0;\n         } else if (mapid > 980000100 && mapid < 980000700) {"}, {"sha": "1db2b3d55c3780a0d003c9203b68273d3961361f", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -345,7 +345,7 @@ private static void hardsetItemStats(Equip equip, short stat) {\n         public static boolean executeHeavenMsCommandLv0(Channel cserv, Server srv, MapleClient c, String[] sub) { //Player\n                 MapleCharacter player = c.getPlayer();\n             \n-                switch(sub[0]) {\n+                switch(sub[0]) {    \n                 case \"help\":\n \t\tcase \"commands\":\n                 case \"playercommands\":\n@@ -1158,7 +1158,7 @@ else if (type.equals(\"cash\")) {\n                                 MapleInventoryManipulator.addById(c, itemId, quantity, player.getName(), -1, flag, -1);\n \t\t\t} else {\n \t\t\t\tItem toDrop;\n-\t\t\t\tif (MapleItemInformationProvider.getInstance().getInventoryType(itemId) == MapleInventoryType.EQUIP) {\n+\t\t\t\tif (ItemConstants.getInventoryType(itemId) == MapleInventoryType.EQUIP) {\n \t\t\t\t\ttoDrop = MapleItemInformationProvider.getInstance().getEquipById(itemId);\n \t\t\t\t} else {\n \t\t\t\t\ttoDrop = new Item(itemId, (short) 0, quantity);\n@@ -1813,6 +1813,10 @@ public static boolean executeHeavenMsCommandLv3(Channel cserv, Server srv, Maple\n \t\t\t}\n                     break;\n                 \n+                case \"energy\":\n+                        System.out.println(c.getPlayer().getDojoEnergy());\n+                        break;\n+                    \n                 case \"maxenergy\":\n                         c.getPlayer().setDojoEnergy(10000);\n                         c.announce(MaplePacketCreator.getEnergy(\"energy\", 10000));\n@@ -2162,7 +2166,7 @@ public static boolean executeHeavenMsCommandLv4(Channel cserv, Server srv, Maple\n                         short multiply = Short.parseShort(sub[2]);\n \n                         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-                        MapleInventoryType type = ii.getInventoryType(itemid);\n+                        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n                         if (type.equals(MapleInventoryType.EQUIP)) {\n                                 Item it = ii.getEquipById(itemid);\n                                 it.setOwner(player.getName());"}, {"sha": "7a995eb78bce2608fd4a1018d2729f39f62add4a", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -120,10 +120,10 @@ public byte getFlag() {\n     }\n \n     @Override\n-    public byte getType() {\n+    public byte getItemType() {\n         return 1;\n     }\n-\n+    \n     public byte getUpgradeSlots() {\n         return upgradeSlots;\n     }"}, {"sha": "9372e5deaa7c2108fda8b77b2a6ff3a631f17f79", "filename": "src/client/inventory/Item.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/Item.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/Item.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Item.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -21,6 +21,7 @@\n  */\n package client.inventory;\n \n+import constants.ItemConstants;\n import java.util.Collections;\n import java.util.LinkedList;\n import java.util.List;\n@@ -93,7 +94,11 @@ public short getQuantity() {\n         return quantity;\n     }\n \n-    public byte getType() {\n+    public MapleInventoryType getInventoryType() {\n+        return ItemConstants.getInventoryType(id);\n+    }\n+    \n+    public byte getItemType() { // 1: equip, 3: pet, 2: other\n         if (getPetId() > -1) {\n             return 3;\n         }"}, {"sha": "18d3efedf10610470f4322ef9fbd97bb29bdfa43", "filename": "src/client/inventory/ItemFactory.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/ItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/ItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ItemFactory.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -133,7 +133,7 @@ public synchronized void saveItems(List<Pair<Item, MapleInventoryType>> items, L\n                     items.add(new Pair<>(item, mit));\n                 }\n             }\n-\n+            \n             rs.close();\n             ps.close();\n             con.close();"}, {"sha": "569a7926a37673fb997cd5d619c2165a92d6eeee", "filename": "src/client/inventory/MapleInventory.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/MapleInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/MapleInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventory.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -367,7 +367,7 @@ public short getNumFreeSlot() {\n     }\n     \n     public static boolean checkSpot(MapleCharacter chr, Item item) {\n-    \tif (chr.getInventory(MapleInventoryType.getByType(item.getType())).isFull()) return false;\n+    \tif (chr.getInventory(item.getInventoryType()).isFull()) return false;\n     \treturn true;\n     }\n     \n@@ -437,7 +437,7 @@ public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item,\n     }\n     \n     public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed) {\n-        // assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0.\n+        //assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0 and item list to be checked is a legal one.\n         \n         Map<Long, Short> rcvItems = new LinkedHashMap<>();\n         Map<Long, Byte> rcvTypes = new LinkedHashMap<>();\n@@ -493,7 +493,7 @@ public Item findByCashId(int cashId) {\n         boolean isRing = false;\n         Equip equip = null;\n \tfor (Item item : list()) {\n-            if (item.getType() == MapleInventoryType.EQUIP.getType()) {\n+            if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                 equip = (Equip) item;\n                 isRing = equip.getRingId() > -1;\n             }"}, {"sha": "8aa4e4ba99a30cc197d0bde0f9402defa11bcfc9", "filename": "src/client/inventory/ModifyInventory.java", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/ModifyInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/client/inventory/ModifyInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ModifyInventory.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -1,7 +1,5 @@\n package client.inventory;\n \n-import constants.ItemConstants;\n-\n /**\n  *\n  * @author kevin\n@@ -28,7 +26,7 @@ public final int getMode() {\n     }\n \n     public final int getInventoryType() {\n-        return ItemConstants.getInventoryType(item.getItemId()).getType();\n+        return item.getInventoryType().type;\n     }\n \n     public final short getPosition() {"}, {"sha": "2f4269c4c75938bbb8ead2d7610ce37cc3a69987", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -152,7 +152,7 @@ public static boolean isInJobTree(int skillId, int jobId) {\n     }\n     \n     public static boolean isPqSkill(final int skill) {\n-    \treturn skill >= 20001013 && skill <= 20000018 || skill  % 10000000 == 1020 || skill == 10000013 || skill  % 10000000 >= 1009 && skill % 10000000 <= 1011;  \n+    \treturn (skill >= 20000014 && skill <= 20000018) || skill == 10000013 || skill == 20001013 || (skill % 10000000 >= 1009 && skill % 10000000 <= 1011) || skill % 10000000 == 1020;\n     }\n     \n     public static boolean bannedBindSkills(final int skill) {\n@@ -185,14 +185,14 @@ public static boolean isBossRush(int mapid) {\n     }\n     \n     public static boolean isDojo(int mapid) {\n-        return mapid >= 925020100 && mapid <= 925023814;\n+        return mapid >= 925020000 && mapid < 925040000;\n     }\n     \n     public static boolean isPyramid(int mapid) {\n     \treturn mapid >= 926010010 & mapid <= 930010000;\n     }\n     \n-    public static boolean isPQSkillMap(int mapid) {\n+    public static boolean isPqSkillMap(int mapid) {\n     \treturn isDojo(mapid) || isPyramid(mapid);\n     }\n     "}, {"sha": "7eca70edab90a7124c064dd1136f4db61ff2cf46", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -22,13 +22,17 @@\n package constants;\n \n import client.inventory.MapleInventoryType;\n+import java.util.HashMap;\n+import java.util.Map;\n \n /**\n  *\n  * @author Jay Estrella\n  * @author Ronan\n  */\n public final class ItemConstants {\n+    protected static Map<Integer, MapleInventoryType> inventoryTypeCache = new HashMap<>();\n+    \n     public final static int LOCK = 0x01;\n     public final static int SPIKES = 0x02;\n     public final static int COLD = 0x04;\n@@ -141,11 +145,19 @@ public static boolean isPartyAllcure(int itemId) {\n     }\n \n     public static MapleInventoryType getInventoryType(final int itemId) {\n+        if (inventoryTypeCache.containsKey(itemId)) {\n+            return inventoryTypeCache.get(itemId);\n+        }\n+        \n+        MapleInventoryType ret = MapleInventoryType.UNDEFINED;\n+        \n \tfinal byte type = (byte) (itemId / 1000000);\n-\tif (type < 1 || type > 5) {\n-\t    return MapleInventoryType.UNDEFINED;\n+\tif (type >= 1 && type <= 5) {\n+\t    ret = MapleInventoryType.getByType(type);\n \t}\n-\treturn MapleInventoryType.getByType(type);\n+        \n+        inventoryTypeCache.put(itemId, ret);\n+        return ret;\n     }\n     \n     public static boolean isMakerReagent(int itemId) {"}, {"sha": "384232cf40b626f926939ab7f2956570c415624b", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -59,6 +59,7 @@\n     public static final boolean USE_AUTOSAVE = true;                //Enables server autosaving feature (saves characters to DB each 1 hour).\n     public static final boolean USE_SERVER_AUTOASSIGNER = true;     //Server-builtin autoassigner, uses algorithm based on distributing AP accordingly with required secondary stat on equipments.\n     public static final boolean USE_REFRESH_RANK_MOVE = true;\n+    public static final boolean USE_ENFORCE_HPMP_SWAP = false;      //Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     public static final boolean USE_ENFORCE_MOB_LEVEL_RANGE = true; //Players N levels below the killed mob will gain no experience from defeating it.\n     public static final boolean USE_ENFORCE_JOB_LEVEL_RANGE = false;//Caps the player level on the minimum required to advance their current jobs.\n     public static final boolean USE_ENFORCE_OWL_SUGGESTIONS = false;//Forces the Owl of Minerva to always display the defined item array on GameConstants.OWL_DATA instead of those featured by the players.\n@@ -131,7 +132,8 @@\n     public static final byte CHAIR_EXTRA_HEAL_HP = 70;          //Each chair extra heal proc increasing HP.\n     public static final byte CHAIR_EXTRA_HEAL_MP = 42;          //Each chair extra heal proc increasing MP.\n     \n-    //Pet Auto-Pot Recovery Rates\n+    //Pet Auto-Pot Configuration\n+    public static final boolean USE_EQUIPS_ON_AUTOPOT = true;   //Player MaxHP and MaxMP check values on autopot handler will be updated by the HP/MP bonuses on equipped items.\n     public static final double PET_AUTOHP_RATIO = 0.99;         //Will automatically consume potions until given ratio of the MaxHP/MaxMP is reached.\n     public static final double PET_AUTOMP_RATIO = 0.99;\n     "}, {"sha": "9dc5457d8714fd48741e9f2978750530043fc476", "filename": "src/dropspider/DropEntry.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/dropspider/DropEntry.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/dropspider/DropEntry.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/dropspider/DropEntry.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -5,7 +5,7 @@\n package dropspider;\n \n import client.inventory.MapleInventoryType;\n-import server.MapleItemInformationProvider;\n+import constants.ItemConstants;\n \n /**\n  *\n@@ -29,7 +29,7 @@ public DropEntry(int item_id, int monster_id, int version) {\n     }\n \n     private int calculateChance(int item_id) {\n-        MapleInventoryType mit = MapleItemInformationProvider.getInstance().getInventoryType(item_id);\n+        MapleInventoryType mit = ItemConstants.getInventoryType(item_id);\n         boolean boss = DataTool.isBoss(monster_id);\n         int number = (item_id / 1000) % 1000;\n         switch (mit) {"}, {"sha": "8b4f02aaeb9d8e43a2fd4a179b47333b709b0107", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 18, "deletions": 17, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -121,14 +121,10 @@ public MapleStatEffect getAttackEffect(MapleCharacter chr, Skill theSkill) {\n             if (mySkill == null) {\n                 mySkill = SkillFactory.getSkill(GameConstants.getHiddenSkill(skill));\n             }\n+            \n             int skillLevel = chr.getSkillLevel(mySkill);\n-            if (mySkill.getId() % 10000000 == 1020) {\n-                if (chr.getPartyQuest() instanceof Pyramid) {\n-                    if (((Pyramid) chr.getPartyQuest()).useSkill()) {\n-                        skillLevel = 1;\n-                    }\n-                }\n-            }\n+            if(skillLevel == 0 && GameConstants.isPqSkillMap(chr.getMapId()) && GameConstants.isPqSkill(mySkill.getId())) skillLevel = 1;\n+            \n             if (skillLevel == 0) {\n                 return null;\n             }\n@@ -515,9 +511,12 @@ protected AttackInfo parseDamage(LittleEndianAccessor lea, MapleCharacter chr, b\n         ret.skill = lea.readInt();\n         ret.ranged = ranged;\n         ret.magic = magic;\n+        \n         if (ret.skill > 0) {\n             ret.skilllevel = chr.getSkillLevel(ret.skill);\n+            if(ret.skilllevel == 0 && GameConstants.isPqSkillMap(chr.getMapId()) && GameConstants.isPqSkill(ret.skill)) ret.skilllevel = 1;\n         }\n+        \n         if (ret.skill == Evan.ICE_BREATH || ret.skill == Evan.FIRE_BREATH || ret.skill == FPArchMage.BIG_BANG || ret.skill == ILArchMage.BIG_BANG || ret.skill == Bishop.BIG_BANG || ret.skill == Gunslinger.GRENADE || ret.skill == Brawler.CORKSCREW_BLOW || ret.skill == ThunderBreaker.CORKSCREW_BLOW || ret.skill == NightWalker.POISON_BOMB) {\n             ret.charge = lea.readInt();\n         } else {\n@@ -685,19 +684,21 @@ else if(orbs >= 5)\n \n         boolean canCrit = false;\n         if(chr.getJob().isA((MapleJob.BOWMAN)) || chr.getJob().isA(MapleJob.THIEF) || chr.getJob().isA(MapleJob.NIGHTWALKER1) || chr.getJob().isA(MapleJob.WINDARCHER1) || chr.getJob() == MapleJob.ARAN3 || chr.getJob() == MapleJob.ARAN4 || chr.getJob() == MapleJob.MARAUDER || chr.getJob() == MapleJob.BUCCANEER) {\n-\t\t\tcanCrit = true;\n-        } \n-\t\tif(chr.getBuffEffect(MapleBuffStat.SHARP_EYES) != null) {\n-\t\t\t// Any class that has sharp eyes can crit. Also, since it stacks with normal crit go ahead\n-\t\t\t// and calc it in.\n             canCrit = true;\n-\t\t\tcalcDmgMax *= 1.4;\n         }\n         \n-\t\tboolean shadowPartner = false;\n-\t\tif(chr.getBuffEffect(MapleBuffStat.SHADOWPARTNER) != null)\n-\t\t\tshadowPartner = true;\n-\t\t\n+        if(chr.getBuffEffect(MapleBuffStat.SHARP_EYES) != null) {\n+            // Any class that has sharp eyes can crit. Also, since it stacks with normal crit go ahead\n+            // and calc it in.\n+\n+            canCrit = true;\n+            calcDmgMax *= 1.4;\n+        }\n+        \n+        boolean shadowPartner = false;\n+        if(chr.getBuffEffect(MapleBuffStat.SHADOWPARTNER) != null) {\n+            shadowPartner = true;\n+        }\t\n \t\t\n         if(ret.skill != 0) {\n             int fixed = ret.getAttackEffect(chr, SkillFactory.getSkill(ret.skill)).getFixDamage();"}, {"sha": "3983388fffb59869dbda2d9e22baa7d60f0f7986", "filename": "src/net/server/channel/handlers/BBSOperationHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/BBSOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/BBSOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/BBSOperationHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -56,7 +56,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 String text = correctLength(slea.readMapleAsciiString(), 600);\n                 int icon = slea.readInt();\n                 if (icon >= 0x64 && icon <= 0x6a) {\n-                    if (c.getPlayer().getItemQuantity(5290000 + icon - 0x64, false) > 0) {\n+                    if (c.getPlayer().haveItemWithId(5290000 + icon - 0x64, false)) {\n                         return;\n                     }\n                 } else if (icon < 0 || icon > 3) {"}, {"sha": "a038ee7d05c04c9fd2ca070e1719030605e463d0", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -37,7 +37,6 @@\n import server.CashShop.CashItem;\n import server.CashShop.CashItemFactory;\n import server.MapleInventoryManipulator;\n-import server.MapleItemInformationProvider;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -197,7 +196,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n             }\n-            if (chr.getInventory(MapleItemInformationProvider.getInstance().getInventoryType(item.getItemId())).addItem(item) != -1) {\n+            if (chr.getInventory(item.getInventoryType()).addItem(item) != -1) {\n                 cs.removeFromInventory(item);\n                 c.announce(MaplePacketCreator.takeFromCashInventory(item));\n                 "}, {"sha": "0a5d40e73320b8836e2cf48714e3d58a3fefcac0", "filename": "src/net/server/channel/handlers/ChangeMapHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/ChangeMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/ChangeMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeMapHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -80,7 +80,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t\t\t}\n \t\t\t\t\tif (executeStandardPath) {\n \t\t\t\t\t\tMapleMap to = chr.getMap();\n-\t\t\t\t\t\tif (wheel && chr.getItemQuantity(5510000, false) > 0) {\n+\t\t\t\t\t\tif (wheel && chr.haveItemWithId(5510000, false)) {\n \t\t\t\t\t\t\tMapleInventoryManipulator.removeById(c, MapleInventoryType.CASH, 5510000, 1, true, false);\n \t\t\t\t\t\t\tchr.announce(MaplePacketCreator.showWheelsLeft(chr.getItemQuantity(5510000, false)));\n \t\t\t\t\t\t} else {"}, {"sha": "09a6f4647b2ccb4e5f823f927307ca94471fabee", "filename": "src/net/server/channel/handlers/DistributeAPHandler.java", "status": "modified", "additions": 87, "deletions": 45, "changes": 132, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DistributeAPHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DistributeAPHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DistributeAPHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -81,10 +81,10 @@ public static boolean addStat(MapleClient c, int apTo, boolean usedAPReset) {\n                 c.getPlayer().addStat(4, 1);\n                 break;\n             case 2048: // HP\n-                addHP(c.getPlayer(), addHP(c));\n+                addHP(c.getPlayer(), addHP(c, usedAPReset));\n                 break;\n             case 8192: // MP\n-                addMP(c.getPlayer(), addMP(c));\n+                addMP(c.getPlayer(), addMP(c, usedAPReset));\n                 break;\n             default:\n                 c.announce(MaplePacketCreator.updatePlayerStats(MaplePacketCreator.EMPTY_STATUPDATE, true, c.getPlayer()));\n@@ -93,30 +93,32 @@ public static boolean addStat(MapleClient c, int apTo, boolean usedAPReset) {\n         return true;\n     }\n \n-    private static int addHP(MapleClient c) {\n+    private static int addHP(MapleClient c, boolean usedAPReset) {\n         MapleCharacter player = c.getPlayer();\n         MapleJob job = player.getJob();\n         int MaxHP = player.getMaxHp();\n         if (player.getHpMpApUsed() > 9999 || MaxHP >= 30000) {\n             return MaxHP;\n         }\n         \n-        return MaxHP + calcHpChange(player, job, false);\n+        return MaxHP + calcHpChange(player, job, usedAPReset);\n     }\n     \n     public static int calcHpChange(MapleCharacter player, MapleJob job, boolean usedAPReset) {\n         int MaxHP = 0;\n         \n         if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1)) {\n-            Skill increaseHP = SkillFactory.getSkill(job.isA(MapleJob.DAWNWARRIOR1) ? DawnWarrior.MAX_HP_INCREASE : Warrior.IMPROVED_MAXHP);\n-            int sLvl = player.getSkillLevel(increaseHP);\n-\n-            if(sLvl > 0)\n-                MaxHP += increaseHP.getEffect(sLvl).getY();\n+            if(!usedAPReset) {\n+                Skill increaseHP = SkillFactory.getSkill(job.isA(MapleJob.DAWNWARRIOR1) ? DawnWarrior.MAX_HP_INCREASE : Warrior.IMPROVED_MAXHP);\n+                int sLvl = player.getSkillLevel(increaseHP);\n \n+                if(sLvl > 0)\n+                    MaxHP += increaseHP.getEffect(sLvl).getY();\n+            }\n+            \n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 18;\n+                    MaxHP += 20;\n                 } else {\n                     MaxHP += Randomizer.rand(18, 22);\n                 }\n@@ -126,7 +128,7 @@ public static int calcHpChange(MapleCharacter player, MapleJob job, boolean used\n         } else if(job.isA(MapleJob.ARAN1)) {\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 26;\n+                    MaxHP += 20;\n                 } else {\n                     MaxHP += Randomizer.rand(26, 30);\n                 }\n@@ -136,7 +138,7 @@ public static int calcHpChange(MapleCharacter player, MapleJob job, boolean used\n         } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 5;\n+                    MaxHP += 6;\n                 } else {\n                     MaxHP += Randomizer.rand(5, 9);\n                 }\n@@ -146,7 +148,7 @@ public static int calcHpChange(MapleCharacter player, MapleJob job, boolean used\n         } else if (job.isA(MapleJob.THIEF) || job.isA(MapleJob.NIGHTWALKER1)) {\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 14;\n+                    MaxHP += 16;\n                 } else {\n                     MaxHP += Randomizer.rand(14, 18);\n                 }\n@@ -156,23 +158,25 @@ public static int calcHpChange(MapleCharacter player, MapleJob job, boolean used\n         } else if(job.isA(MapleJob.BOWMAN) || job.isA(MapleJob.WINDARCHER1)) {\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 14;\n+                    MaxHP += 16;\n                 } else {\n                     MaxHP += Randomizer.rand(14, 18);\n                 }\n             } else {\n                 MaxHP += 16;\n             }\n         } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n-            Skill increaseHP = SkillFactory.getSkill(Brawler.IMPROVE_MAX_HP);\n-            int sLvl = player.getSkillLevel(increaseHP);\n-\n-            if(sLvl > 0)\n-                MaxHP += increaseHP.getEffect(sLvl).getY();\n+            if(!usedAPReset) {\n+                Skill increaseHP = SkillFactory.getSkill(Brawler.IMPROVE_MAX_HP);\n+                int sLvl = player.getSkillLevel(increaseHP);\n \n+                if(sLvl > 0)\n+                    MaxHP += increaseHP.getEffect(sLvl).getY();\n+            }\n+            \n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if (usedAPReset) {\n-                    MaxHP += 16;\n+                    MaxHP += 18;\n                 } else {\n                     MaxHP += Randomizer.rand(16, 20);\n                 }\n@@ -188,18 +192,19 @@ public static int calcHpChange(MapleCharacter player, MapleJob job, boolean used\n                 MaxHP += 10;\n             }\n         }\n+        \n         return MaxHP;\n     }\n \n-    private static int addMP(MapleClient c) {\n+    private static int addMP(MapleClient c, boolean usedAPReset) {\n         MapleCharacter player = c.getPlayer();\n         int MaxMP = player.getMaxMp();\n         MapleJob job = player.getJob();\n         if (player.getHpMpApUsed() > 9999 || player.getMaxMp() >= 30000) {\n             return MaxMP;\n         }\n         \n-        return MaxMP + calcMpChange(player, job, false);\n+        return MaxMP + calcMpChange(player, job, usedAPReset);\n     }\n     \n     public static int calcMpChange(MapleCharacter player, MapleJob job, boolean usedAPReset) {\n@@ -209,26 +214,26 @@ public static int calcMpChange(MapleCharacter player, MapleJob job, boolean used\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(2, 4) + (player.getInt() / 10));\n-                }\n-                else {\n-                    MaxMP += (2 + (player.getInt() / 10));\n+                } else {\n+                    MaxMP += 2;\n                 }\n             } else {\n                 MaxMP += 3;\n             }\n         } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n-            Skill increaseMP = SkillFactory.getSkill(job.isA(MapleJob.BLAZEWIZARD1) ? BlazeWizard.INCREASING_MAX_MP : Magician.IMPROVED_MAX_MP_INCREASE);\n-            int sLvl = player.getSkillLevel(increaseMP);\n-\n-            if(sLvl > 0)\n-                MaxMP += increaseMP.getEffect(sLvl).getY();\n+            if(!usedAPReset) {\n+                Skill increaseMP = SkillFactory.getSkill(job.isA(MapleJob.BLAZEWIZARD1) ? BlazeWizard.INCREASING_MAX_MP : Magician.IMPROVED_MAX_MP_INCREASE);\n+                int sLvl = player.getSkillLevel(increaseMP);\n \n+                if(sLvl > 0)\n+                    MaxMP += increaseMP.getEffect(sLvl).getY();\n+            }\n+            \n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(12, 16) + (player.getInt() / 20));\n-                }\n-                else {\n-                    MaxMP += (12 + (player.getInt() / 20));\n+                } else {\n+                    MaxMP += 18;\n                 }\n             } else {\n                 MaxMP += 18;\n@@ -237,9 +242,8 @@ public static int calcMpChange(MapleCharacter player, MapleJob job, boolean used\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(6, 8) + (player.getInt() / 10));\n-                }\n-                else {\n-                    MaxMP += (6 + (player.getInt() / 10));\n+                } else {\n+                    MaxMP += 10;\n                 }\n             } else {\n                 MaxMP += 10;\n@@ -248,9 +252,8 @@ public static int calcMpChange(MapleCharacter player, MapleJob job, boolean used\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(6, 8) + (player.getInt() / 10));\n-                }\n-                else {\n-                    MaxMP += (6 + (player.getInt() / 10));\n+                } else {\n+                    MaxMP += 10;\n                 }\n             } else {\n                 MaxMP += 10;\n@@ -259,9 +262,8 @@ public static int calcMpChange(MapleCharacter player, MapleJob job, boolean used\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(7, 9) + (player.getInt() / 10));\n-                }\n-                else {\n-                    MaxMP += (7 + (player.getInt() / 10));\n+                } else {\n+                    MaxMP += 14;\n                 }\n             } else {\n                 MaxMP += 14;\n@@ -270,14 +272,14 @@ public static int calcMpChange(MapleCharacter player, MapleJob job, boolean used\n             if(ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n                 if(!usedAPReset) {\n                     MaxMP += (Randomizer.rand(4, 6) + (player.getInt() / 10));\n-                }\n-                else {\n-                    MaxMP += (4 + (player.getInt() / 10));\n+                } else {\n+                    MaxMP += 6;\n                 }\n             } else {\n                 MaxMP += 6;\n             }\n         }\n+        \n         return MaxMP;\n     }\n \n@@ -294,4 +296,44 @@ private static void addMP(MapleCharacter player, int MaxMP) {\n         player.setMaxMp(MaxMP);\n         player.updateSingleStat(MapleStat.MAXMP, MaxMP);\n     }\n+    \n+    public static int takeHp(MapleCharacter player, MapleJob job) {\n+        int MaxHP = 0;\n+        \n+        if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1) || job.isA(MapleJob.ARAN1)) {\n+            MaxHP += 54;\n+        } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n+            MaxHP += 10;\n+        } else if (job.isA(MapleJob.THIEF) || job.isA(MapleJob.NIGHTWALKER1)) {\n+            MaxHP += 20;\n+        } else if(job.isA(MapleJob.BOWMAN) || job.isA(MapleJob.WINDARCHER1)) {\n+            MaxHP += 20;\n+        } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n+            MaxHP += 42;\n+        } else {\n+            MaxHP += 12;\n+        }\n+        \n+        return MaxHP;\n+    }\n+    \n+    public static int takeMp(MapleCharacter player, MapleJob job) {\n+        int MaxMP = 0;\n+        \n+        if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1) || job.isA(MapleJob.ARAN1)) {\n+            MaxMP += 4;\n+        } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n+            MaxMP += 31;\n+        } else if (job.isA(MapleJob.BOWMAN) || job.isA(MapleJob.WINDARCHER1)) {\n+            MaxMP += 12;\n+        } else if(job.isA(MapleJob.THIEF) || job.isA(MapleJob.NIGHTWALKER1)) {\n+            MaxMP += 12;\n+        } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n+            MaxMP += 16;\n+        } else {\n+            MaxMP += 8;\n+        }\n+        \n+        return MaxMP;\n+    }\n }"}, {"sha": "c4bc963cb7daf50443989e34ffd18ceb401dfac4", "filename": "src/net/server/channel/handlers/DistributeSPHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DistributeSPHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DistributeSPHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DistributeSPHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -47,7 +47,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         MapleCharacter player = c.getPlayer();\n         int remainingSp = player.getRemainingSpBySkill(GameConstants.getSkillBook(skillid/10000));\n         boolean isBeginnerSkill = false;\n-        if ((!GameConstants.isPQSkillMap(player.getMapId()) && GameConstants.isPqSkill(skillid)) || (!player.isGM() && GameConstants.isGMSkills(skillid)) || (!GameConstants.isInJobTree(skillid, player.getJob().getId()) && !player.isGM())) {\n+        if ((!GameConstants.isPqSkillMap(player.getMapId()) && GameConstants.isPqSkill(skillid)) || (!player.isGM() && GameConstants.isGMSkills(skillid)) || (!GameConstants.isInJobTree(skillid, player.getJob().getId()) && !player.isGM())) {\n             AutobanFactory.PACKET_EDIT.alert(player, \"tried to packet edit in distributing sp.\");\n             FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to use skill \" + skillid + \" without it being in their job.\\r\\n\");\n             c.disconnect(true, false);"}, {"sha": "c089c5f5cbe79b0a34a722fb43933c0c8791ced8", "filename": "src/net/server/channel/handlers/DueyHandler.java", "status": "modified", "additions": 92, "deletions": 28, "changes": 120, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DueyHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/DueyHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DueyHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -42,6 +42,7 @@\n import net.server.channel.Channel;\n import server.DueyPackages;\n import server.MapleInventoryManipulator;\n+import server.MapleItemInformationProvider;\n import tools.DatabaseConnection;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n@@ -54,12 +55,22 @@\n         TOSERVER_REMOVE_PACKAGE(0x05),\n         TOSERVER_CLOSE_DUEY(0x07),\n         TOCLIENT_OPEN_DUEY(0x08),\n-        TOCLIENT_NOT_ENOUGH_MESOS(0x0A),\n-        TOCLIENT_NAME_DOES_NOT_EXIST(0x0C),\n-        TOCLIENT_SAMEACC_ERROR(0x0D),\n-        TOCLIENT_SUCCESSFULLY_SENT(0x12),\n-        TOCLIENT_SUCCESSFUL_MSG(0x17),\n-        TOCLIENT_PACKAGE_MSG(0x1B); // Ending byte; 4 if received. 3 if delete.\n+        TOCLIENT_SEND_ENABLE_ACTIONS(0x09),\n+        TOCLIENT_SEND_NOT_ENOUGH_MESOS(0x0A),\n+        TOCLIENT_SEND_INCORRECT_REQUEST(0x0B),\n+        TOCLIENT_SEND_NAME_DOES_NOT_EXIST(0x0C),\n+        TOCLIENT_SEND_SAMEACC_ERROR(0x0D),\n+        TOCLIENT_SEND_RECEIVER_STORAGE_FULL(0x0E),\n+        TOCLIENT_SEND_RECEIVER_UNABLE_TO_RECV(0x0F),\n+        TOCLIENT_SEND_RECEIVER_STORAGE_WITH_UNIQUE(0x10),\n+        TOCLIENT_SEND_MESO_LIMIT(0x11),\n+        TOCLIENT_SEND_SUCCESSFULLY_SENT(0x12),\n+        TOCLIENT_RECV_UNKNOWN_ERROR(0x13),\n+        TOCLIENT_RECV_ENABLE_ACTIONS(0x14),\n+        TOCLIENT_RECV_NO_FREE_SLOTS(0x15),\n+        TOCLIENT_RECV_RECEIVER_WITH_UNIQUE(0x16),\n+        TOCLIENT_RECV_SUCCESSFUL_MSG(0x17),\n+        TOCLIENT_RECV_PACKAGE_MSG(0x1B);\n         final byte code;\n \n         private Actions(int code) {\n@@ -75,9 +86,6 @@ private static int getAccIdFromCNAME(String name, boolean accountid) {\n         try {\n             PreparedStatement ps;\n             String text = \"SELECT id,accountid FROM characters WHERE name = ?\";\n-            if (accountid) {\n-                text = \"SELECT id,accountid FROM characters WHERE name = ?\";\n-            }\n             Connection con = DatabaseConnection.getConnection();\n             ps = con.prepareStatement(text);\n             ps.setString(1, name);\n@@ -115,9 +123,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             int mesos = slea.readInt();\n             String recipient = slea.readMapleAsciiString();\n             \n-            System.out.println(mesos + \" \" + fee + \" \" + getFee(mesos) + \"/\" + amount + \" \" + Integer.MAX_VALUE);\n-\n-            if (mesos < 0 || (long) mesos > Integer.MAX_VALUE || ((long) mesos + fee + getFee(mesos)) > Integer.MAX_VALUE || (amount < 1 && mesos == 0)) {\n+            if (mesos < 0 || ((long) mesos + fee + getFee(mesos)) > Integer.MAX_VALUE || (amount < 1 && mesos == 0)) {\n             \tAutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit with duey.\");\n             \tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to use duey with mesos \" + mesos + \" and amount \" + amount + \"\\r\\n\");           \t\n             \tc.disconnect(true, false);\n@@ -129,23 +135,20 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 int accid = getAccIdFromCNAME(recipient, true);\n                 if (accid != -1) {\n                     if (accid != c.getAccID()) {\n-                        c.getPlayer().gainMeso(-finalcost, false);\n-                        c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SUCCESSFULLY_SENT.getCode()));\n                         send = true;\n                     } else {\n-                        c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SAMEACC_ERROR.getCode()));\n+                        c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_SAMEACC_ERROR.getCode()));\n                     }\n                 } else {\n-                    c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_NAME_DOES_NOT_EXIST.getCode()));\n+                    c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_NAME_DOES_NOT_EXIST.getCode()));\n                 }\n             } else {\n-                c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_NOT_ENOUGH_MESOS.getCode()));\n+                c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_NOT_ENOUGH_MESOS.getCode()));\n             }\n-            boolean recipientOn = false;\n+            \n             MapleClient rClient = null;\n                 int channel = c.getWorldServer().find(recipient);\n                 if (channel > -1) {\n-                    recipientOn = true;\n                     Channel rcserv = c.getWorldServer().getChannel(channel);\n                     rClient = rcserv.getPlayerStorage().getCharacterByName(recipient).getClient();\n                 }\n@@ -154,21 +157,31 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     MapleInventoryType inv = MapleInventoryType.getByType(inventId);\n                     Item item = c.getPlayer().getInventory(inv).getItem(itemPos);\n                     if (item != null && c.getPlayer().getItemQuantity(item.getItemId(), false) >= amount) {\n+                        c.getPlayer().gainMeso(-finalcost, false);\n+                        c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));\n+                        \n                         if (ItemConstants.isRechargable(item.getItemId())) {\n                             MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, item.getQuantity(), true);\n                         } else {\n                             MapleInventoryManipulator.removeFromSlot(c, inv, itemPos, amount, true, false);\n                         }\n+                        \n                         addItemToDB(item, amount, mesos, c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n                     } else {\n-                        if (item != null) c.getPlayer().dropMessage(1, \"You must assign up to \" + c.getPlayer().getItemQuantity(item.getItemId(), false) + \" of that item to send.\");\n+                        if (item != null) {\n+                            c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_INCORRECT_REQUEST.getCode()));\n+                        }\n                         return;\n                     }\n                 } else {\n+                    c.getPlayer().gainMeso(-finalcost, false);\n+                    c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));    \n+                    \n                     addMesoToDB(mesos, c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n                 }\n-                if (recipientOn && rClient != null) {\n-                    rClient.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_PACKAGE_MSG.getCode()));\n+                \n+                if (rClient != null && rClient.isLoggedIn() && !rClient.getPlayer().isAwayFromWorld()) {\n+                    showDueyNotification(rClient, rClient.getPlayer());\n                 }\n             }\n         } else if (operation == Actions.TOSERVER_REMOVE_PACKAGE.getCode()) {\n@@ -199,15 +212,20 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 dp = dueypack;\n                 if(dp == null) {\n-                    System.out.println(\"Error: Null Duey package!\");\n-                    c.announce(MaplePacketCreator.enableActions());\n+                    c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_UNKNOWN_ERROR.getCode()));\n+                    FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to receive package from duey with id \" + packageid + \"\\r\\n\");\n                     return;\n                 }\n                 \n                 if (dp.getItem() != null) {\n                     if (!MapleInventoryManipulator.checkSpace(c, dp.getItem().getItemId(), dp.getItem().getQuantity(), dp.getItem().getOwner())) {\n-                        c.getPlayer().dropMessage(1, \"Your inventory is full\");\n-                        c.announce(MaplePacketCreator.enableActions());\n+                        int itemid = dp.getItem().getItemId();\n+                        if(MapleItemInformationProvider.getInstance().isPickupRestricted(itemid) && c.getPlayer().getInventory(ItemConstants.getInventoryType(itemid)).findById(itemid) != null) {\n+                            c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_RECEIVER_WITH_UNIQUE.getCode()));\n+                        } else {\n+                            c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_NO_FREE_SLOTS.getCode()));\n+                        }\n+                                                \n                         return;\n                     } else {\n                         MapleInventoryManipulator.addFromDrop(c, dp.getItem(), false);\n@@ -252,13 +270,13 @@ private void addItemToDB(Item item, int quantity, int mesos, String sName, int r\n                     ps.setInt(6, 3);\n                     ps.executeUpdate();\n                 } else {\n-                    ps.setInt(6, item.getType());\n+                    ps.setInt(6, item.getItemType());\n                     \n                     ps.executeUpdate();\n                     try (ResultSet rs = ps.getGeneratedKeys()) {\n                         rs.next();\n                         PreparedStatement ps2;\n-                        if (item.getType() == 1) { // equips\n+                        if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                             ps2 = con.prepareStatement(\"INSERT INTO dueyitems (PackageId, itemid, quantity, upgradeslots, level, str, dex, `int`, luk, hp, mp, watk, matk, wdef, mdef, acc, avoid, hands, speed, jump, owner) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             Equip eq = (Equip) item;\n                             ps2.setInt(2, eq.getItemId());\n@@ -411,4 +429,50 @@ private static DueyPackages getItemByPID(ResultSet rs) {\n             return null;\n         }\n     }\n+    \n+    private static void showDueyNotification(MapleClient c, MapleCharacter player) {\n+        Connection con = null;\n+        PreparedStatement ps = null;\n+        PreparedStatement pss = null;\n+        ResultSet rs = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            ps = con.prepareStatement(\"SELECT Mesos FROM dueypackages WHERE RecieverId = ? and Checked = 1\");\n+            ps.setInt(1, player.getId());\n+            rs = ps.executeQuery();\n+            if (rs.next()) {\n+                try {\n+                    Connection con2 = DatabaseConnection.getConnection();\n+                    pss = con2.prepareStatement(\"UPDATE dueypackages SET Checked = 0 where RecieverId = ?\");\n+                    pss.setInt(1, player.getId());\n+                    pss.executeUpdate();\n+                    pss.close();\n+                    con2.close();\n+                } catch (SQLException e) {\n+                    e.printStackTrace();\n+                }\n+\n+                c.announce(MaplePacketCreator.sendDueyNotification(false));\n+            }\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+        } finally {\n+            try {\n+                if (rs != null) {\n+                    rs.close();\n+                }\n+                if (pss != null) {\n+                    pss.close();\n+                }\n+                if (ps != null) {\n+                    ps.close();\n+                }\n+                if (con != null) {\n+                    con.close();\n+                }\n+            } catch (SQLException ex) {\n+                ex.printStackTrace();\n+            }\n+        }\n+    }\n }"}, {"sha": "03e170ca65a8dd57fb601e5eb713a7bdeb7d54d6", "filename": "src/net/server/channel/handlers/FaceExpressionHandler.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/FaceExpressionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/FaceExpressionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/FaceExpressionHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -22,17 +22,18 @@\n package net.server.channel.handlers;\n \n import client.MapleClient;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n-import server.MapleItemInformationProvider;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class FaceExpressionHandler extends AbstractMaplePacketHandler {\n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int emote = slea.readInt();\n         if (emote > 7) {\n             int emoteid = 5159992 + emote;\n-            if (c.getPlayer().getInventory(MapleItemInformationProvider.getInstance().getInventoryType(emoteid)).findById(emoteid) == null) {\n+            if (c.getPlayer().getInventory(ItemConstants.getInventoryType(emoteid)).findById(emoteid) == null) {\n                 return;\n             }\n         }"}, {"sha": "d2d4a7bf380faafda40734be0af4689ab2474b46", "filename": "src/net/server/channel/handlers/MTSHandler.java", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MTSHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -44,6 +44,7 @@\n import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n \n public final class MTSHandler extends AbstractMaplePacketHandler {\n \n@@ -98,7 +99,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if (quantity < 0 || price < 110 || c.getPlayer().getItemQuantity(itemid, false) < quantity) {\n                     return;\n                 }\n-                MapleInventoryType type = MapleItemInformationProvider.getInstance().getInventoryType(itemid);\n+                MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n                 Item i = c.getPlayer().getInventory(type).getItem(slot).copy();\n                 if (i != null && c.getPlayer().getMeso() >= 5000) {\n                     Connection con = null;\n@@ -155,7 +156,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         } else {\n                             date += day + \"\";\n                         }\n-                        if (i.getType() == 2) {\n+                        if (!i.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                             Item item = (Item) i;\n                             ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, seller, price, owner, sellername, sell_ends) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             ps.setInt(1, 1);\n@@ -294,7 +295,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         if (rs.getInt(\"type\") != 1) {\n                             Item ii = new Item(rs.getInt(\"itemid\"), (short) 0, (short) rs.getInt(\"quantity\"));\n                             ii.setOwner(rs.getString(\"owner\"));\n-                            ii.setPosition(c.getPlayer().getInventory(MapleItemInformationProvider.getInstance().getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n+                            ii.setPosition(c.getPlayer().getInventory(ItemConstants.getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n                             i = ii.copy();\n                         } else {\n                             Equip equip = new Equip(rs.getInt(\"itemid\"), (byte) rs.getInt(\"position\"), -1);\n@@ -319,7 +320,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n                             equip.setVicious((byte) rs.getInt(\"vicious\"));\n                             equip.setFlag((byte) rs.getInt(\"flag\"));\n-                            equip.setPosition(c.getPlayer().getInventory(MapleItemInformationProvider.getInstance().getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n+                            equip.setPosition(c.getPlayer().getInventory(ItemConstants.getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n                             i = equip.copy();\n                         }\n                         try (PreparedStatement pse = con.prepareStatement(\"DELETE FROM mts_items WHERE id = ? AND seller = ? AND transfer = 1\")) {"}, {"sha": "b608ebd58f8ba95597aed2e1937a0328df5ab099", "filename": "src/net/server/channel/handlers/MakerSkillHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MakerSkillHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MakerSkillHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MakerSkillHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -384,7 +384,7 @@ private static short getCreateStatus(MapleClient c, MakerItemCreateEntry recipe)\n     private static boolean hasItems(MapleClient c, MakerItemCreateEntry recipe) {\n         for (Pair<Integer, Integer> p : recipe.getReqItems()) {\n             int itemId = p.getLeft();\n-            if (c.getPlayer().getInventory(ii.getInventoryType(itemId)).countById(itemId) < p.getRight()) {\n+            if (c.getPlayer().getInventory(ItemConstants.getInventoryType(itemId)).countById(itemId) < p.getRight()) {\n                 return false;\n             }\n         }"}, {"sha": "878303ccdc4f82389f62a32ba2dd600e022bb272", "filename": "src/net/server/channel/handlers/MesoDropHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MesoDropHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/MesoDropHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MesoDropHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -31,7 +31,8 @@\n  *\n  * @author Matze\n  */\n-public final class MesoDropHandler extends AbstractMaplePacketHandler {//FIX\n+public final class MesoDropHandler extends AbstractMaplePacketHandler {\n+        @Override\n         public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 MapleCharacter player = c.getPlayer();\n                 if (!player.isAlive()) {"}, {"sha": "d59fe28163b75d7faf36a4ae2d86eb434d692c10", "filename": "src/net/server/channel/handlers/NPCShopHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/NPCShopHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/NPCShopHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NPCShopHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -23,8 +23,8 @@\n \n import client.MapleClient;\n import client.autoban.AutobanFactory;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n-import server.MapleItemInformationProvider;\n import tools.FilePrinter;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -50,7 +50,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             short slot = slea.readShort();\n             int itemId = slea.readInt();\n             short quantity = slea.readShort();\n-            c.getPlayer().getShop().sell(c, MapleItemInformationProvider.getInstance().getInventoryType(itemId), slot, quantity);\n+            c.getPlayer().getShop().sell(c, ItemConstants.getInventoryType(itemId), slot, quantity);\n         } else if (bmode == 2) { // recharge ;)\n             byte slot = (byte) slea.readShort();\n             c.getPlayer().getShop().recharge(c, slot);"}, {"sha": "7e51aee93c35b968331e9cfcf7c620e6aca6ddbf", "filename": "src/net/server/channel/handlers/NewYearCardHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/NewYearCardHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/NewYearCardHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NewYearCardHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -31,7 +31,6 @@\n import java.sql.SQLException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n-import server.MapleItemInformationProvider;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -147,7 +146,7 @@ private static int getReceiverId(String receiver, int world) {\n     private static int getValidNewYearCardStatus(int itemid, MapleCharacter player, short slot) {\n         if(!ItemConstants.isNewYearCardUse(itemid)) return 0x14;\n         \n-        Item it = player.getInventory(MapleItemInformationProvider.getInstance().getInventoryType(itemid)).getItem(slot);        \n+        Item it = player.getInventory(ItemConstants.getInventoryType(itemid)).getItem(slot);        \n         return (it != null && it.getItemId() == itemid) ? 0 : 0x12;\n     } \n }"}, {"sha": "48021c582f05b16575285bc4e88eb34749e4342e", "filename": "src/net/server/channel/handlers/PetAutoPotHandler.java", "status": "modified", "additions": 32, "deletions": 8, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/PetAutoPotHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/PetAutoPotHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetAutoPotHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -1,8 +1,6 @@\n /*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n+    This file is part of the HeavenMS (MapleSolaxiaV2) MapleStory Server\n+    Copyleft (L) 2017 RonanLana\n \n     This program is free software: you can redistribute it and/or modify\n     it under the terms of the GNU Affero General Public License as\n@@ -22,6 +20,8 @@\n package net.server.channel.handlers;\n \n import client.MapleClient;\n+import client.MapleCharacter;\n+import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n import net.AbstractMaplePacketHandler;\n@@ -32,19 +32,39 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import constants.ServerConstants;\n \n+/**\n+ *\n+ * @author Ronan\n+ */\n public final class PetAutoPotHandler extends AbstractMaplePacketHandler {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         if (!c.getPlayer().isAlive()) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         }\n+        \n+        MapleCharacter chr = c.getPlayer();\n+        short maxHp = 0, maxMp = 0;\n+        \n+        if(ServerConstants.USE_EQUIPS_ON_AUTOPOT) {\n+            for(Item i : c.getPlayer().getInventory(MapleInventoryType.EQUIPPED).list()) {\n+                Equip e = (Equip) i;\n+\n+                maxHp += e.getHp();\n+                maxMp += e.getMp();\n+            }\n+        }\n+                \n+        maxHp = (short) Math.min(chr.getMaxHp() + maxHp, 30000);\n+        maxMp = (short) Math.min(chr.getMaxMp() + maxMp, 30000);\n+        \n         slea.readByte();\n         slea.readLong();\n         slea.readInt();\n         short slot = slea.readShort();\n         int itemId = slea.readInt();\n-        Item toUse = c.getPlayer().getInventory(MapleInventoryType.USE).getItem(slot);\n+        Item toUse = chr.getInventory(MapleInventoryType.USE).getItem(slot);\n         \n         if(toUse != null) {\n             MapleStatEffect stat = MapleItemInformationProvider.getInstance().getItemEffect(toUse.getItemId());\n@@ -56,11 +76,15 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     c.announce(MaplePacketCreator.enableActions());\n                     return;\n                 }\n+                \n                 MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, slot, (short) 1, false);\n-                //stat = MapleItemInformationProvider.getInstance().getItemEffect(toUse.getItemId());\n-                stat.applyTo(c.getPlayer());\n+                stat.applyTo(chr);\n \n-            } while(((stat.getHp() > 0 && c.getPlayer().getHp() < ServerConstants.PET_AUTOHP_RATIO * c.getPlayer().getMaxHp()) || (stat.getMp() > 0 && c.getPlayer().getMp() < ServerConstants.PET_AUTOMP_RATIO * c.getPlayer().getMaxMp())) && toUse.getQuantity() > 0);\n+                //System.out.println();\n+                //System.out.println(\"hp: \" + stat.getHp() + \" player hp \" + c.getPlayer().getHp() + \" maxhp \" + maxHp);\n+                //System.out.println(\"mp: \" + stat.getMp() + \" player mp \" + c.getPlayer().getMp() + \" maxmp \" + maxMp);\n+                //System.out.println(\"redo? \" + (((stat.getHp() > 0 && c.getPlayer().getHp() < ServerConstants.PET_AUTOHP_RATIO * maxHp) || (stat.getMp() > 0 && c.getPlayer().getMp() < ServerConstants.PET_AUTOMP_RATIO * maxMp)) && toUse.getQuantity() > 0));\n+            } while(((stat.getHp() > 0 && chr.getHp() < ServerConstants.PET_AUTOHP_RATIO * maxHp) || (stat.getMp() > 0 && chr.getMp() < ServerConstants.PET_AUTOMP_RATIO * maxMp)) && toUse.getQuantity() > 0);\n         }\n     }\n }"}, {"sha": "b2f6238a53b1644ef74eab26925e9c164cb220fb", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 50, "deletions": 43, "changes": 93, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -114,48 +114,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             List<Pair<Long, PlayerBuffValueHolder>> timedBuffs = getLocalStartTimes(buffs);\n             player.silentGiveBuffs(timedBuffs);\n         }\n-        Connection con = null;\n-        PreparedStatement ps = null;\n-        PreparedStatement pss = null;\n-        ResultSet rs = null;\n-        try {\n-            con = DatabaseConnection.getConnection();\n-            ps = con.prepareStatement(\"SELECT Mesos FROM dueypackages WHERE RecieverId = ? and Checked = 1\");\n-            ps.setInt(1, player.getId());\n-            rs = ps.executeQuery();\n-            if (rs.next()) {\n-                try {\n-                    Connection con2 = DatabaseConnection.getConnection();\n-                    pss = con2.prepareStatement(\"UPDATE dueypackages SET Checked = 0 where RecieverId = ?\");\n-                    pss.setInt(1, player.getId());\n-                    pss.executeUpdate();\n-                    pss.close();\n-                    con2.close();\n-                } catch (SQLException e) {\n-                    e.printStackTrace();\n-                }\n-                c.announce(MaplePacketCreator.sendDueyMSG((byte) 0x1B));\n-            }\n-        } catch (SQLException e) {\n-            e.printStackTrace();\n-        } finally {\n-            try {\n-                if (rs != null) {\n-                    rs.close();\n-                }\n-                if (pss != null) {\n-                    pss.close();\n-                }\n-                if (ps != null) {\n-                    ps.close();\n-                }\n-                if (con != null) {\n-                    con.close();\n-                }\n-            } catch (SQLException ex) {\n-                ex.printStackTrace();\n-            }\n-        }\n+        \n         c.announce(MaplePacketCreator.getCharInfo(player));\n         if (!player.isHidden()) {\n             player.toggleHide(true);\n@@ -286,6 +245,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             \n         }\n         \n+        showDueyNotification(c, player);\n+        \n         if (player.getMap().getHPDec() > 0) player.resetHpDecreaseTask();\n         \n         player.resetPlayerRates();\n@@ -296,7 +257,53 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         player.receivePartyMemberHP();\n     }\n     \n-    private List<Pair<Long, PlayerBuffValueHolder>> getLocalStartTimes(List<PlayerBuffValueHolder> lpbvl) {\n+    private static void showDueyNotification(MapleClient c, MapleCharacter player) {\n+        Connection con = null;\n+        PreparedStatement ps = null;\n+        PreparedStatement pss = null;\n+        ResultSet rs = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            ps = con.prepareStatement(\"SELECT Mesos FROM dueypackages WHERE RecieverId = ? and Checked = 1\");\n+            ps.setInt(1, player.getId());\n+            rs = ps.executeQuery();\n+            if (rs.next()) {\n+                try {\n+                    Connection con2 = DatabaseConnection.getConnection();\n+                    pss = con2.prepareStatement(\"UPDATE dueypackages SET Checked = 0 where RecieverId = ?\");\n+                    pss.setInt(1, player.getId());\n+                    pss.executeUpdate();\n+                    pss.close();\n+                    con2.close();\n+                } catch (SQLException e) {\n+                    e.printStackTrace();\n+                }\n+\n+                c.announce(MaplePacketCreator.sendDueyNotification(false));\n+            }\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+        } finally {\n+            try {\n+                if (rs != null) {\n+                    rs.close();\n+                }\n+                if (pss != null) {\n+                    pss.close();\n+                }\n+                if (ps != null) {\n+                    ps.close();\n+                }\n+                if (con != null) {\n+                    con.close();\n+                }\n+            } catch (SQLException ex) {\n+                ex.printStackTrace();\n+            }\n+        }\n+    }\n+    \n+    private static List<Pair<Long, PlayerBuffValueHolder>> getLocalStartTimes(List<PlayerBuffValueHolder> lpbvl) {\n         List<Pair<Long, PlayerBuffValueHolder>> timedBuffs = new ArrayList<>();\n         long curtime = System.currentTimeMillis();\n         "}, {"sha": "c7b93828570df4cccebe45ab15147edca395ce44", "filename": "src/net/server/channel/handlers/RemoteGachaponHandler.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/RemoteGachaponHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/RemoteGachaponHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RemoteGachaponHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -23,16 +23,17 @@\n \n import client.MapleClient;\n import client.autoban.AutobanFactory;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n import scripting.npc.NPCScriptManager;\n-import server.MapleItemInformationProvider;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n /**\n  *\n  * @author Generic\n  */\n public final class RemoteGachaponHandler extends AbstractMaplePacketHandler {\n+        @Override\n \tpublic final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n \t\tint ticket = slea.readInt();\n \t\tint gacha = slea.readInt();\n@@ -44,7 +45,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tAutobanFactory.GENERAL.alert(c.getPlayer(), \" Tried to use RemoteGachaponHandler with mode: \" + gacha);\n \t\t\tc.disconnect(false, false);\n \t\t\treturn;\n-\t\t} else if (c.getPlayer().getInventory(MapleItemInformationProvider.getInstance().getInventoryType(ticket)).countById(ticket) < 1) {\n+\t\t} else if (c.getPlayer().getInventory(ItemConstants.getInventoryType(ticket)).countById(ticket) < 1) {\n \t\t\tAutobanFactory.GENERAL.alert(c.getPlayer(), \" Tried to use RemoteGachaponHandler without a ticket.\");\n \t\t\tc.disconnect(false, false);\n \t\t\treturn;"}, {"sha": "5882997569a84ee58d2f570957b8378706e6a057", "filename": "src/net/server/channel/handlers/ScriptedItemHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/ScriptedItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/ScriptedItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ScriptedItemHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -23,6 +23,7 @@\n \n import client.MapleClient;\n import client.inventory.Item;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n import scripting.item.ItemScriptManager;\n import server.MapleItemInformationProvider;\n@@ -44,7 +45,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         scriptedItem info = ii.getScriptedItemInfo(itemId);\n         if (info == null) return;\n         ItemScriptManager ism = ItemScriptManager.getInstance();\n-        Item item = c.getPlayer().getInventory(ii.getInventoryType(itemId)).getItem(itemSlot);\n+        Item item = c.getPlayer().getInventory(ItemConstants.getInventoryType(itemId)).getItem(itemSlot);\n         if (item == null || item.getItemId() != itemId || item.getQuantity() < 1 || !ism.scriptExists(info.getScript())) {\n             return;\n         }"}, {"sha": "593d1872ef82e63e2d9c42f56642c0272d66e1f5", "filename": "src/net/server/channel/handlers/StorageHandler.java", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/StorageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/StorageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/StorageHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -45,7 +45,6 @@\n \t@Override\n \tpublic final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n \t\tMapleCharacter chr = c.getPlayer();\n-\t\tMapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n \t\tbyte mode = slea.readByte();\n \t\tfinal MapleStorage storage = chr.getStorage();\n \n@@ -66,7 +65,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tslot = storage.getSlot(MapleInventoryType.getByType(type), slot);\n \t\t\tItem item = storage.getItem(slot);\n \t\t\tif (item != null) {\n-\t\t\t\tif (MapleItemInformationProvider.getInstance().isPickupRestricted(item.getItemId()) && chr.getItemQuantity(item.getItemId(), true) > 0) {\n+\t\t\t\tif (MapleItemInformationProvider.getInstance().isPickupRestricted(item.getItemId()) && chr.haveItemWithId(item.getItemId(), true)) {\n \t\t\t\t\tc.announce(MaplePacketCreator.getStorageError((byte) 0x0C));    \n \t\t\t\t\treturn;\n \t\t\t\t}\n@@ -86,7 +85,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t\t\t\titem.setFlag((byte) (item.getFlag() ^ ItemConstants.KARMA)); //items with scissors of karma used on them are reset once traded\n \t\t\t\t\t}\n \t\t\t\t\tMapleInventoryManipulator.addFromDrop(c, item, false);\n-\t\t\t\t\tstorage.sendTakenOut(c, ii.getInventoryType(item.getItemId()));\n+\t\t\t\t\tstorage.sendTakenOut(c, item.getInventoryType());\n \t\t\t\t} else {\n \t\t\t\t\tc.announce(MaplePacketCreator.getStorageError((byte) 0x0A));\n \t\t\t\t}\n@@ -95,7 +94,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tshort slot = slea.readShort();\n \t\t\tint itemId = slea.readInt();\n \t\t\tshort quantity = slea.readShort();\n-\t\t\tMapleInventoryType slotType = ii.getInventoryType(itemId);\n+\t\t\tMapleInventoryType slotType = ItemConstants.getInventoryType(itemId);\n \t\t\tMapleInventory Inv = chr.getInventory(slotType);\n \t\t\tif (slot < 1 || slot > Inv.getSlotLimit()) { //player inv starts at one\n \t\t\t\tAutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit with storage.\");\n@@ -115,7 +114,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tif (chr.getMeso() < meso) {\n \t\t\t\tc.announce(MaplePacketCreator.getStorageError((byte) 0x0B));\n \t\t\t} else {\n-\t\t\t\tMapleInventoryType type = ii.getInventoryType(itemId);\n+\t\t\t\tMapleInventoryType type = ItemConstants.getInventoryType(itemId);\n \t\t\t\tItem item = chr.getInventory(type).getItem(slot).copy();\n \t\t\t\tif (item.getItemId() == itemId && (item.getQuantity() >= quantity || ItemConstants.isRechargable(itemId))) {\n \t\t\t\t\tif (ItemConstants.isRechargable(itemId)) {\n@@ -125,7 +124,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t\t\tMapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false);\n \t\t\t\t\titem.setQuantity(quantity);\n \t\t\t\t\tstorage.store(item);\n-\t\t\t\t\tstorage.sendStored(c, ii.getInventoryType(itemId));\n+\t\t\t\t\tstorage.sendStored(c, ItemConstants.getInventoryType(itemId));\n \t\t\t\t\tString itemName = MapleItemInformationProvider.getInstance().getName(item.getItemId());\n \t\t\t\t\tFilePrinter.print(FilePrinter.STORAGE + c.getAccountName() + \".txt\", c.getPlayer().getName() + \" stored \" + item.getQuantity() + \" \" + itemName + \" (\" + item.getItemId() + \")\\r\\n\");\t\n \t\t\t\t}"}, {"sha": "bb1fb1581198607e8a8b5fc4e50cc4a27eb9356a", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -31,6 +31,7 @@\n import client.status.MonsterStatus;\n import client.status.MonsterStatusEffect;\n import constants.GameConstants;\n+import constants.ItemConstants;\n import constants.ServerConstants;\n import constants.skills.Aran;\n import constants.skills.Corsair;\n@@ -42,7 +43,6 @@\n \n import net.AbstractMaplePacketHandler;\n import server.MapleInventoryManipulator;\n-import server.MapleItemInformationProvider;\n import server.MapleStatEffect;\n import server.life.MapleLifeFactory.loseItem;\n import server.life.MapleMonster;\n@@ -104,7 +104,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 byte d = 1;\n                                 Point pos = new Point(0, player.getPosition().y);\n                                 for (loseItem loseItem : loseItems) {\n-                                    type = MapleItemInformationProvider.getInstance().getInventoryType(loseItem.getId());\n+                                    type = ItemConstants.getInventoryType(loseItem.getId());\n                                     for (byte b = 0; b < loseItem.getX(); b++) {//LOL?\n                                         if (Randomizer.nextInt(101) >= loseItem.getChance()) {\n                                             if (player.haveItem(loseItem.getId())) {"}, {"sha": "e342a841f2e05ba129e2d5c49b1ee4ad9aac75f7", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 32, "deletions": 14, "changes": 46, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -137,13 +137,20 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         player.addStat(4, -1);\n                         break;\n                     case 2048: // HP\n-                    \tif (APTo != 8192) {\n-                            c.getPlayer().message(\"You can only swap HP ability points to MP.\");\n+                        if(ServerConstants.USE_ENFORCE_HPMP_SWAP) {\n+                            if (APTo != 8192) {\n+                                c.getPlayer().message(\"You can only swap HP ability points to MP.\");\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            }\n+                        }\n+                        if (player.getHpMpApUsed() < 1) {\n+                            c.getPlayer().message(\"You don't have enough HPMP stat points to spend on AP Reset.\");\n                             c.announce(MaplePacketCreator.enableActions());\n                             return;\n                     \t}\n                         \n-                        int hp = player.getHp();\n+                        int hp = player.getMaxHp();\n                         int level_ = player.getLevel();\n                         \n                         boolean canWash_ = true;\n@@ -157,7 +164,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             return;\n                         }\n                         \n-                        int hplose = -DistributeAPHandler.calcHpChange(player, player.getJob(), true);\n+                        player.setHpMpApUsed(player.getHpMpApUsed() - 1);\n+                        int hplose = -DistributeAPHandler.takeHp(player, player.getJob());\n                         int nextHp = Math.max(1, player.getHp() + hplose), nextMaxHp = Math.max(50, player.getMaxHp() + hplose);\n \n                         player.setHp(nextHp);\n@@ -167,12 +175,20 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         \n                         break;\n                     case 8192: // MP\n-                    \tif (APTo != 2048) {\n-                            c.getPlayer().message(\"You can only swap MP ability points to HP.\");\n+                        if(ServerConstants.USE_ENFORCE_HPMP_SWAP) {\n+                            if (APTo != 2048) {\n+                                c.getPlayer().message(\"You can only swap MP ability points to HP.\");\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            }\n+                        }\n+                        if (player.getHpMpApUsed() < 1) {\n+                            c.getPlayer().message(\"You don't have enough HPMP stat points to spend on AP Reset.\");\n                             c.announce(MaplePacketCreator.enableActions());\n                             return;\n                     \t}\n-                        int mp = player.getMp();\n+                        \n+                        int mp = player.getMaxMp();\n                         int level = player.getLevel();\n                         MapleJob job = player.getJob();\n                         \n@@ -193,13 +209,15 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             return;\n                         }\n                         \n-                        int mplose = -DistributeAPHandler.calcMpChange(player, job, true);\n+                        player.setHpMpApUsed(player.getHpMpApUsed() - 1);\n+                        int mplose = -DistributeAPHandler.takeMp(player, job);\n                         int nextMp = Math.max(0, player.getMp() + mplose), nextMaxMp = Math.max(5, player.getMaxMp() + mplose);\n \n-                        player.setHp(nextMp);\n-                        player.setMaxHp(nextMaxMp);\n-                        statupdate.add(new Pair<>(MapleStat.HP, nextMp));\n-                        statupdate.add(new Pair<>(MapleStat.MAXHP, nextMaxMp));\n+                        player.setMp(nextMp);\n+                        player.setMaxMp(nextMaxMp);\n+                        statupdate.add(new Pair<>(MapleStat.MP, nextMp));\n+                        statupdate.add(new Pair<>(MapleStat.MAXMP, nextMaxMp));\n+                        \n                         break;\n                     default:\n                         c.announce(MaplePacketCreator.updatePlayerStats(MaplePacketCreator.EMPTY_STATUPDATE, true, c.getPlayer()));\n@@ -328,7 +346,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         if (item == null) //hack\n                         {\n                             return;\n-                        } else if (ii.isDropRestricted(item.getItemId())) { //Lol?\n+                        } else if (((item.getFlag() & ItemConstants.UNTRADEABLE) == ItemConstants.UNTRADEABLE) || ii.isDropRestricted(item.getItemId())) {\n                             player.dropMessage(1, \"You cannot trade this item.\");\n                             c.announce(MaplePacketCreator.enableActions());\n                             return;\n@@ -352,7 +370,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             remove(c, itemId);\n         } else if (itemType == 508) { //graduation banner\n-            slea.readMapleAsciiString(); // message, sepearated by 0A for lines\n+            slea.readMapleAsciiString(); // message, separated by 0A for lines\n             c.announce(MaplePacketCreator.enableActions());\n         } else if (itemType == 509) {\n             String sendTo = slea.readMapleAsciiString();"}, {"sha": "29659705920517c59f4d43fe096a2bd875d58552", "filename": "src/net/server/channel/handlers/UseCatchItemHandler.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/UseCatchItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/UseCatchItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCatchItemHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -25,9 +25,9 @@\n import client.MapleClient;\n import client.inventory.MapleInventoryType;\n import client.autoban.AutobanManager;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n import server.MapleInventoryManipulator;\n-import server.MapleItemInformationProvider;\n import server.life.MapleMonster;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -37,6 +37,7 @@\n  * @author kevintjuh93\n  */\n public final class UseCatchItemHandler extends AbstractMaplePacketHandler {\n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         AutobanManager abm = chr.getAutobanManager();\n@@ -46,7 +47,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int monsterid = slea.readInt();\n \n         MapleMonster mob = chr.getMap().getMonsterByOid(monsterid);\n-        if (chr.getInventory(MapleItemInformationProvider.getInstance().getInventoryType(itemId)).countById(itemId) <= 0) {\n+        if (chr.getInventory(ItemConstants.getInventoryType(itemId)).countById(itemId) <= 0) {\n            return;\n         }\n         if (mob == null) {"}, {"sha": "8ea4397480c33441e308517dd01d38b86bfabe03", "filename": "src/net/server/channel/handlers/WeddingHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/WeddingHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/channel/handlers/WeddingHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/WeddingHandler.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -8,8 +8,8 @@\n import client.MapleClient;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n-import server.MapleItemInformationProvider;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -29,7 +29,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 short slot = slea.readShort();\n                 int itemid = slea.readInt();\n                 short quantity = slea.readShort();\n-                MapleInventoryType type = MapleItemInformationProvider.getInstance().getInventoryType(itemid);\n+                MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n                 Item item = chr.getInventory(type).getItem(slot);\n                 if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n                     c.announce(MaplePacketCreator.addItemToWeddingRegistry(chr, item));"}, {"sha": "f02e6bef1da8dbfbe7e98d3eff8b079fd79fca9a", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -822,7 +822,7 @@ public void runPetSchedule() {\n         \n         for(Map.Entry<Integer, Byte> dp: deployedPets.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey() / 4);\n-            if(chr == null || !chr.isLoggedin()) continue;\n+            if(chr == null || !chr.isLoggedin() || chr.isAwayFromWorld()) continue;\n             \n             Byte dpVal = (byte)(dp.getValue() + 1);\n             if(dpVal == ServerConstants.PET_EXHAUST_COUNT) {\n@@ -880,7 +880,7 @@ public void runMountSchedule() {\n         \n         for(Map.Entry<Integer, Byte> dp: deployedMounts.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey());\n-            if(chr == null || !chr.isLoggedin()) continue;\n+            if(chr == null || !chr.isLoggedin() || chr.isAwayFromWorld()) continue;\n             \n             Byte dpVal = (byte)(dp.getValue() + 1);\n             if(dpVal == ServerConstants.MOUNT_EXHAUST_COUNT) {"}, {"sha": "cda2088ec98a0e41c5aa7c7c8776ee26a18591d2", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 19, "deletions": 12, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -46,7 +46,6 @@\n import server.maps.MapleMap;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n-import server.maps.MapleMiniDungeon;\n import server.partyquest.PartyQuest;\n import server.partyquest.Pyramid;\n import server.quest.MapleQuest;\n@@ -202,6 +201,14 @@ public int getItemQuantity(int itemid) {\n                 return getPlayer().getItemQuantity(itemid, false);\n         }\n \n+        public boolean haveItemWithId(int itemid) {\n+                return haveItemWithId(itemid, false);\n+        }\n+        \n+        public boolean haveItemWithId(int itemid, boolean checkEquipped) {\n+                return getPlayer().haveItemWithId(itemid, checkEquipped);\n+        }\n+        \n \tpublic boolean canHold(int itemid) {\n                 return canHold(itemid, 1);\n         }\n@@ -227,7 +234,7 @@ private boolean canHoldAll(List<Integer> itemids, List<Integer> quantity, boolea\n             List<Pair<Item, MapleInventoryType>> addedItems = new LinkedList<>();\n             for(int i = 0; i < size; i++) {\n                 Item it = new Item(itemids.get(i), (short) 0, quantity.get(i).shortValue());\n-                addedItems.add(new Pair<>(it, MapleItemInformationProvider.getInstance().getInventoryType(itemids.get(i))));\n+                addedItems.add(new Pair<>(it, ItemConstants.getInventoryType(itemids.get(i))));\n             }\n             \n             return MapleInventory.checkSpots(c.getPlayer(), addedItems);\n@@ -447,7 +454,7 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n                     \n \t\t\tMapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n \n-\t\t\tif (ii.getInventoryType(id).equals(MapleInventoryType.EQUIP)) {\n+\t\t\tif (ItemConstants.getInventoryType(id).equals(MapleInventoryType.EQUIP)) {\n \t\t\t\titem = ii.getEquipById(id);\n                                 \n                                 if(item != null) {\n@@ -459,7 +466,7 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n                                         if(!(c.getPlayer().isGM() && ServerConstants.USE_PERFECT_GM_SCROLL)) {\n                                             eqp.setUpgradeSlots((byte)(eqp.getUpgradeSlots() + 1));\n                                         }\n-                                        item = MapleItemInformationProvider.getInstance().scrollEquipWithId(item, 2049100, true, 0, c.getPlayer().isGM());\n+                                        item = MapleItemInformationProvider.getInstance().scrollEquipWithId(item, 2049100, true, 2049100, c.getPlayer().isGM());\n                                     }\n                                 }\n \t\t\t} else {\n@@ -472,10 +479,10 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n                         item.setPetId(petId);\n \n \t\t\tif (!MapleInventoryManipulator.checkSpace(c, id, quantity, \"\")) {\n-\t\t\t\tc.getPlayer().dropMessage(1, \"Your inventory is full. Please remove an item from your \" + ii.getInventoryType(id).name() + \" inventory.\");\n+\t\t\t\tc.getPlayer().dropMessage(1, \"Your inventory is full. Please remove an item from your \" + ItemConstants.getInventoryType(id).name() + \" inventory.\");\n \t\t\t\treturn null;\n \t\t\t}\n-\t\t\tif (ii.getInventoryType(id).equals(MapleInventoryType.EQUIP) && !ItemConstants.isRechargable(item.getItemId())) {\n+\t\t\tif (ItemConstants.getInventoryType(id) == MapleInventoryType.EQUIP) {\n \t\t\t\tif (randomStats) {\n \t\t\t\t\titem = ii.randomizeStats((Equip) item);\n \t\t\t\t\tMapleInventoryManipulator.addFromDrop(c, ii.randomizeStats((Equip) item), false, petId);\n@@ -486,7 +493,7 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n \t\t\t\tMapleInventoryManipulator.addFromDrop(c, item, false, petId);\n \t\t\t}\n \t\t} else {\n-\t\t\tMapleInventoryManipulator.removeById(c, MapleItemInformationProvider.getInstance().getInventoryType(id), id, -quantity, true, false);\n+\t\t\tMapleInventoryManipulator.removeById(c, ItemConstants.getInventoryType(id), id, -quantity, true, false);\n \t\t}\n \t\tif (showMessage) {\n \t\t\tc.announce(MaplePacketCreator.getShowItemGain(id, quantity, true));\n@@ -604,7 +611,7 @@ public void givePartyItems(int id, short quantity, List<MapleCharacter> party) {\n \t\t\tif (quantity >= 0) {\n \t\t\t\tMapleInventoryManipulator.addById(cl, id, quantity);\n \t\t\t} else {\n-\t\t\t\tMapleInventoryManipulator.removeById(cl, MapleItemInformationProvider.getInstance().getInventoryType(id), id, -quantity, true, false);\n+\t\t\t\tMapleInventoryManipulator.removeById(cl, ItemConstants.getInventoryType(id), id, -quantity, true, false);\n \t\t\t}\n \t\t\tcl.announce(MaplePacketCreator.getShowItemGain(id, quantity, true));\n \t\t}\n@@ -683,11 +690,11 @@ public void givePartyExp(String PQ, boolean instance) {\n \n \tpublic void removeFromParty(int id, List<MapleCharacter> party) {\n \t\tfor (MapleCharacter chr : party) {\n-\t\t\tMapleInventoryType type = MapleItemInformationProvider.getInstance().getInventoryType(id);\n+\t\t\tMapleInventoryType type = ItemConstants.getInventoryType(id);\n \t\t\tMapleInventory iv = chr.getInventory(type);\n \t\t\tint possesed = iv.countById(id);\n \t\t\tif (possesed > 0) {\n-\t\t\t\tMapleInventoryManipulator.removeById(c, MapleItemInformationProvider.getInstance().getInventoryType(id), id, possesed, true, false);\n+\t\t\t\tMapleInventoryManipulator.removeById(c, ItemConstants.getInventoryType(id), id, possesed, true, false);\n \t\t\t\tchr.announce(MaplePacketCreator.getShowItemGain(id, (short) -possesed, true));\n \t\t\t}\n \t\t}\n@@ -698,10 +705,10 @@ public void removeAll(int id) {\n \t}\n \n \tpublic void removeAll(int id, MapleClient cl) {\n-\t\tMapleInventoryType invType = MapleItemInformationProvider.getInstance().getInventoryType(id);\n+\t\tMapleInventoryType invType = ItemConstants.getInventoryType(id);\n \t\tint possessed = cl.getPlayer().getInventory(invType).countById(id);\n \t\tif (possessed > 0) {\n-\t\t\tMapleInventoryManipulator.removeById(cl, MapleItemInformationProvider.getInstance().getInventoryType(id), id, possessed, true, false);\n+\t\t\tMapleInventoryManipulator.removeById(cl, ItemConstants.getInventoryType(id), id, possessed, true, false);\n \t\t\tcl.announce(MaplePacketCreator.getShowItemGain(id, (short) -possessed, true));\n \t\t}\n \t\t"}, {"sha": "dd69af9f9e7f3688f94e385f86e8162263b1e2e8", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -55,6 +55,7 @@\n import client.inventory.Item;\n import client.inventory.ItemFactory;\n import client.inventory.MaplePet;\n+import constants.ItemConstants;\n \n /**\n  *\n@@ -301,7 +302,7 @@ public void setSkin(int color) {\n \t}\n \n \tpublic int itemQuantity(int itemid) {\n-\t\treturn getPlayer().getInventory(MapleItemInformationProvider.getInstance().getInventoryType(itemid)).countById(itemid);\n+\t\treturn getPlayer().getInventory(ItemConstants.getInventoryType(itemid)).countById(itemid);\n \t}\n \n \tpublic void displayGuildRanks() {"}, {"sha": "992dd4c6c40092a537de48c34b7a2b1faf5c940d", "filename": "src/scripting/reactor/ReactorActionManager.java", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/reactor/ReactorActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/scripting/reactor/ReactorActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorActionManager.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -26,6 +26,7 @@\n import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n import java.awt.Point;\n import java.util.Iterator;\n import java.util.LinkedList;\n@@ -130,6 +131,8 @@ public void dropItems(boolean delayed, int posX, int posY, boolean meso, int mes\n         dropPos.x -= (12 * numItems);\n         \n         if(!delayed) {\n+            MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+            \n             for (ReactorDropEntry d : items) {\n                 if (d.itemId == 0) {\n                     int range = maxMeso - minMeso;\n@@ -138,8 +141,8 @@ public void dropItems(boolean delayed, int posX, int posY, boolean meso, int mes\n                     reactor.getMap().spawnMesoDrop(mesoDrop, reactor.getMap().calcDropPos(dropPos, reactor.getPosition()), reactor, client.getPlayer(), false, (byte) 2);\n                 } else {\n                     Item drop;\n-                    MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-                    if (ii.getInventoryType(d.itemId) != MapleInventoryType.EQUIP) {\n+                    \n+                    if (ItemConstants.getInventoryType(d.itemId) != MapleInventoryType.EQUIP) {\n                         drop = new Item(d.itemId, (short) 0, (short) 1);\n                     } else {\n                         drop = ii.randomizeStats((Equip) ii.getEquipById(d.itemId));\n@@ -171,10 +174,11 @@ public void run() {\n                         r.getMap().spawnMesoDrop(mesoDrop, r.getMap().calcDropPos(dropPos, r.getPosition()), r, chr, false, (byte) 2);\n                     } else {\n                         Item drop;\n-                        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-                        if (ii.getInventoryType(d.itemId) != MapleInventoryType.EQUIP) {\n+                        \n+                        if (ItemConstants.getInventoryType(d.itemId) != MapleInventoryType.EQUIP) {\n                             drop = new Item(d.itemId, (short) 0, (short) 1);\n                         } else {\n+                            MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n                             drop = ii.randomizeStats((Equip) ii.getEquipById(d.itemId));\n                         }\n "}, {"sha": "b4067a877cfcdf830f015ffa73d7c6d560080444", "filename": "src/server/CashShop.java", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -89,16 +89,15 @@ public boolean isOnSale() {\n         }\n \n         public Item toItem() {\n-            MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n             Item item;\n \n             int petid = -1;\n \n             if (ItemConstants.isPet(itemId))\n                 petid = MaplePet.createPet(itemId);\n \n-            if (ii.getInventoryType(itemId).equals(MapleInventoryType.EQUIP)) {\n-                item = ii.getEquipById(itemId);\n+            if (ItemConstants.getInventoryType(itemId).equals(MapleInventoryType.EQUIP)) {\n+                item = MapleItemInformationProvider.getInstance().getEquipById(itemId);\n             } else {\n                 item = new Item(itemId, (byte) 0, count, petid);\n             }\n@@ -353,7 +352,7 @@ public Item findByCashId(int cashId) {\n         boolean isRing = false;\n         Equip equip = null;\n         for (Item item : getInventory()) {\n-            if (item.getType() == 1) {\n+            if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                 equip = (Equip) item;\n                 isRing = equip.getRingId() > -1;\n             }\n@@ -440,7 +439,7 @@ public void gift(int recipient, String from, String message, int sn, int ringid)\n                 Item item = cItem.toItem();\n                 Equip equip = null;\n                 item.setGiftFrom(rs.getString(\"from\"));\n-                if (item.getType() == MapleInventoryType.EQUIP.getType()) {\n+                if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                     equip = (Equip) item;\n                     equip.setRingId(rs.getInt(\"ringid\"));\n                     gifts.add(new Pair<Item, String>(equip, rs.getString(\"message\")));\n@@ -491,7 +490,7 @@ public void save(Connection con) throws SQLException {\n \n         List<Item> inv = getInventory();\n         for (Item item : inv) {\n-            itemsWithType.add(new Pair<>(item, MapleItemInformationProvider.getInstance().getInventoryType(item.getItemId())));\n+            itemsWithType.add(new Pair<>(item, item.getInventoryType()));\n         }\n \n         factory.saveItems(itemsWithType, accountId, con);"}, {"sha": "a38e9684a72ae931bc9d9b80a5021047b9277d9d", "filename": "src/server/MapleInventoryManipulator.java", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleInventoryManipulator.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -22,6 +22,7 @@\n package server;\n \n import client.MapleBuffStat;\n+import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Equip;\n import client.inventory.Item;\n@@ -65,7 +66,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n \n     public static boolean addById(MapleClient c, int itemId, short quantity, String owner, int petid, byte flag, long expiration) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        MapleInventoryType type = ii.getInventoryType(itemId);\n+        MapleInventoryType type = ItemConstants.getInventoryType(itemId);\n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemId);\n             List<Item> existing = c.getPlayer().getInventory(type).listById(itemId);\n@@ -155,8 +156,8 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show) {\n \n     public static boolean addFromDrop(MapleClient c, Item item, boolean show, int petId) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        MapleInventoryType type = ii.getInventoryType(item.getItemId());\n-        if (ii.isPickupRestricted(item.getItemId()) && c.getPlayer().getItemQuantity(item.getItemId(), true) > 0) {\n+        MapleInventoryType type = item.getInventoryType();\n+        if (ii.isPickupRestricted(item.getItemId()) && c.getPlayer().haveItemWithId(item.getItemId(), true)) {\n             c.announce(MaplePacketCreator.getInventoryFull());\n             c.announce(MaplePacketCreator.showItemUnavailable());\n             return false;\n@@ -230,9 +231,18 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n         return true;\n     }\n     \n+    private static boolean haveItemWithId(MapleInventory inv, int itemid) {\n+        return inv.findById(itemid) != null;\n+    }\n+    \n     public static boolean checkSpace(MapleClient c, int itemid, int quantity, String owner) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        MapleInventoryType type = ii.getInventoryType(itemid);\n+        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+        \n+        if(ii.isPickupRestricted(itemid) && haveItemWithId(c.getPlayer().getInventory(type), itemid)) {\n+            return false;\n+        }\n+        \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemid);\n             List<Item> existing = c.getPlayer().getInventory(type).listById(itemid);\n@@ -273,7 +283,12 @@ public static int checkSpaceProgressively(MapleClient c, int itemid, int quantit\n         int returnValue;\n         \n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        MapleInventoryType type = ii.getInventoryType(itemid);\n+        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+        \n+        if(ii.isPickupRestricted(itemid) && haveItemWithId(c.getPlayer().getInventory(type), itemid)) {\n+            return 0;\n+        }\n+        \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemid);\n             if (!ItemConstants.isRechargable(itemid)) {"}, {"sha": "1169337ea27972bc4150d72b41e2b359cba45ee5", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -138,12 +138,7 @@ public static MapleItemInformationProvider getInstance() {\n         return instance;\n     }\n \n-    public MapleInventoryType getInventoryType(int itemId) {\n-        final byte type = (byte) (itemId / 1000000);\n-        if (type < 1 || type > 5) {\n-            return MapleInventoryType.UNDEFINED;\n-        }\n-        return MapleInventoryType.getByType(type);\n+//    public MapleInventoryType getInventoryType(int itemId) {\n //        if (inventoryTypeCache.containsKey(itemId)) {\n //            return inventoryTypeCache.get(itemId);\n //        }\n@@ -176,7 +171,7 @@ public MapleInventoryType getInventoryType(int itemId) {\n //        ret = MapleInventoryType.UNDEFINED;\n //        inventoryTypeCache.put(itemId, ret);\n //        return ret;\n-    }\n+//    }\n \n     public List<Pair<Integer, String>> getAllItems() {\n         if (!itemNameCache.isEmpty()) {\n@@ -879,6 +874,8 @@ public Item scrollEquipWithId(Item equip, int scrollId, boolean usingWhiteScroll\n                     prop = 30.0;\n                 } else if (vegaItemId == 5610001) {\n                     prop = 90.0;\n+                } else if (vegaItemId == 2049100) {\n+                    prop = 100.0;\n                 }\n                 \n                 if(assertGM || rollSuccessChance(prop)) {"}, {"sha": "74dd8e98c1159dffd295de6c5ec81001af256626", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -743,7 +743,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                     applyto.getClient().announce(MaplePacketCreator.enableActions());\n                     return false;\n                 }\n-                MapleInventoryManipulator.removeById(applyto.getClient(), MapleItemInformationProvider.getInstance().getInventoryType(itemCon), itemCon, itemConNo, false, true);\n+                MapleInventoryManipulator.removeById(applyto.getClient(), ItemConstants.getInventoryType(itemCon), itemCon, itemConNo, false, true);\n             }\n         }\n         List<Pair<MapleStat, Integer>> hpmpupdate = new ArrayList<>(2);"}, {"sha": "ce9a19c04c5adfcd93e180baa744d5dd91baa691", "filename": "src/server/MapleStorage.java", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStorage.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -138,7 +138,7 @@ public void saveToDB(Connection con) {\n \n             List<Item> list = getItems();\n             for (Item item : list) {\n-                itemsWithType.add(new Pair<>(item, MapleItemInformationProvider.getInstance().getInventoryType(item.getItemId())));\n+                itemsWithType.add(new Pair<>(item, item.getInventoryType()));\n             }\n \n             ItemFactory.STORAGE.saveItems(itemsWithType, id, con);\n@@ -163,7 +163,7 @@ public Item takeOut(byte slot) {\n         try {\n             ret = items.remove(slot);\n             \n-            MapleInventoryType type = MapleItemInformationProvider.getInstance().getInventoryType(ret.getItemId());\n+            MapleInventoryType type = ret.getInventoryType();\n             typeItems.put(type, new ArrayList<>(filterItems(type)));\n         } finally {\n             lock.unlock();\n@@ -177,7 +177,7 @@ public void store(Item item) {\n         try {\n             items.add(item);\n             \n-            MapleInventoryType type = MapleItemInformationProvider.getInstance().getInventoryType(item.getItemId());\n+            MapleInventoryType type = item.getInventoryType();\n             typeItems.put(type, new ArrayList<>(filterItems(type)));\n         } finally {\n             lock.unlock();\n@@ -196,10 +196,9 @@ public void store(Item item) {\n     private List<Item> filterItems(MapleInventoryType type) {\n         List<Item> storageItems = getItems();\n         List<Item> ret = new LinkedList<>();\n-        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         \n         for (Item item : storageItems) {\n-            if (ii.getInventoryType(item.getItemId()) == type) {\n+            if (item.getInventoryType() == type) {\n                 ret.add(item);\n             }\n         }\n@@ -232,16 +231,14 @@ public void sendStorage(MapleClient c, int npcId) {\n         }\n         */\n         \n-        final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        \n         lock.lock();\n         try {\n             Collections.sort(items, new Comparator<Item>() {\n                 @Override\n                 public int compare(Item o1, Item o2) {\n-                    if (ii.getInventoryType(o1.getItemId()).getType() < ii.getInventoryType(o2.getItemId()).getType()) {\n+                    if (o1.getInventoryType().getType() < o2.getInventoryType().getType()) {\n                         return -1;\n-                    } else if (ii.getInventoryType(o1.getItemId()) == ii.getInventoryType(o2.getItemId())) {\n+                    } else if (o1.getInventoryType() == o2.getInventoryType()) {\n                         return 0;\n                     }\n                     return 1;"}, {"sha": "8ea12b4ede622afa18f4e769f9d5c48b5ba5341b", "filename": "src/server/MapleTrade.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleTrade.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/MapleTrade.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleTrade.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -194,7 +194,7 @@ public int getExchangeMesos(){\n     private boolean fitsInInventory() {\n         List<Pair<Item, MapleInventoryType>> tradeItems = new LinkedList<>();\n         for (Item item : exchangeItems) {\n-            tradeItems.add(new Pair(item, MapleItemInformationProvider.getInstance().getInventoryType(item.getItemId())));\n+            tradeItems.add(new Pair(item, item.getInventoryType()));\n         }\n         \n         return MapleInventory.checkSpotsAndOwnership(chr, tradeItems);"}, {"sha": "b792014a746ae1b0c2b3fce72c243a83a9f94472", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 23, "deletions": 52, "changes": 75, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -25,6 +25,7 @@\n import client.MapleClient;\n import client.inventory.Item;\n import client.inventory.ItemFactory;\n+import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import com.mysql.jdbc.Statement;\n import constants.ItemConstants;\n@@ -163,6 +164,10 @@ public void removeAllVisitors() {\n         }\n     }\n \n+    private static boolean canBuy(MapleClient c, Item newItem) {\n+        return MapleInventoryManipulator.checkSpace(c, newItem.getItemId(), newItem.getQuantity(), newItem.getOwner()) && MapleInventoryManipulator.addFromDrop(c, newItem, false);\n+    }\n+    \n     public void buy(MapleClient c, int item, short quantity) {\n         synchronized (items) {\n             MaplePlayerShopItem pItem = items.get(item);\n@@ -175,7 +180,7 @@ public void buy(MapleClient c, int item, short quantity) {\n             if (quantity < 1 || pItem.getBundles() < 1 || !pItem.isExist() || pItem.getBundles() < quantity) {\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n-            } else if (newItem.getType() == 1 && newItem.getQuantity() > 1) {\n+            } else if (newItem.getInventoryType().equals(MapleInventoryType.EQUIP) && newItem.getQuantity() > 1) {\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n             } else if (!pItem.isExist()) {\n@@ -185,8 +190,7 @@ public void buy(MapleClient c, int item, short quantity) {\n             \n             int price = (int) Math.min((long)pItem.getPrice() * quantity, Integer.MAX_VALUE);\n             if (c.getPlayer().getMeso() >= price) {\n-                if (MapleInventoryManipulator.checkSpace(c, newItem.getItemId(), newItem.getQuantity(), newItem.getOwner())) {\n-                    MapleInventoryManipulator.addFromDrop(c, newItem, false);\n+                if (canBuy(c, newItem)) {\n                     c.getPlayer().gainMeso(-price, false);\n                     announceItemSold(newItem, price);   // idea thanks to vcoc\n                     \n@@ -216,7 +220,7 @@ public void buy(MapleClient c, int item, short quantity) {\n                         }\n                     }\n                 } else {\n-                    c.getPlayer().dropMessage(1, \"Your inventory is full. Please clear a slot before buying this item.\");\n+                    c.getPlayer().dropMessage(1, \"Your inventory is full. Please clean a slot before buying this item.\");\n                 }\n             } else {\n                 c.getPlayer().dropMessage(1, \"You do not have enough mesos.\");\n@@ -231,11 +235,10 @@ public void buy(MapleClient c, int item, short quantity) {\n     \n     private void announceItemSold(Item item, int mesos) {\n         String qtyStr = (item.getQuantity() > 1) ? \" (qty. \" + item.getQuantity() + \")\" : \"\";\n-        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         \n         MapleCharacter player = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterById(ownerId);\n         if(player != null && player.isLoggedin() && !player.isAwayFromWorld()) {\n-            player.dropMessage(6, \"[HIRED MERCHANT] Item '\" + ii.getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n+            player.dropMessage(6, \"[HIRED MERCHANT] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n         }\n     }\n \n@@ -296,10 +299,12 @@ public void closeShop(MapleClient c, boolean timeout) {\n                 List<MaplePlayerShopItem> copyItems = getItems();\n                 if (check(c.getPlayer(), copyItems) && !timeout) {\n                     for (MaplePlayerShopItem mpsi : copyItems) {\n-                        if (mpsi.isExist() && (mpsi.getItem().getType() == MapleInventoryType.EQUIP.getType())) {\n-                            MapleInventoryManipulator.addFromDrop(c, mpsi.getItem(), false);\n-                        } else if (mpsi.isExist()) {\n-                            MapleInventoryManipulator.addById(c, mpsi.getItem().getItemId(), (short) (mpsi.getBundles() * mpsi.getItem().getQuantity()), null, -1, mpsi.getItem().getFlag(), mpsi.getItem().getExpiration());\n+                        if(mpsi.isExist()) {\n+                            if (mpsi.getItem().getInventoryType().equals(MapleInventoryType.EQUIP)) {\n+                                MapleInventoryManipulator.addFromDrop(c, mpsi.getItem(), false);\n+                            } else {\n+                                MapleInventoryManipulator.addById(c, mpsi.getItem().getItemId(), (short) (mpsi.getBundles() * mpsi.getItem().getQuantity()), null, -1, mpsi.getItem().getFlag(), mpsi.getItem().getExpiration());\n+                            }\n                         }\n                     }\n                     \n@@ -465,7 +470,7 @@ public void saveItems(boolean shutdown) throws SQLException {\n                 newItem.setQuantity((short) (pItems.getItem().getQuantity()));\n             }\n             if (newBundle > 0) {\n-                itemsWithType.add(new Pair<>(newItem, MapleInventoryType.getByType(newItem.getType())));\n+                itemsWithType.add(new Pair<>(newItem, newItem.getInventoryType()));\n                 bundles.add(newBundle);\n             }\n         }\n@@ -476,49 +481,15 @@ public void saveItems(boolean shutdown) throws SQLException {\n     }\n \n     private static boolean check(MapleCharacter chr, List<MaplePlayerShopItem> items) {\n-        byte eq = 0, use = 0, setup = 0, etc = 0, cash = 0;\n-        List<MapleInventoryType> li = new LinkedList<>();\n+        List<Pair<Item, MapleInventoryType>> li = new ArrayList<>();\n         for (MaplePlayerShopItem item : items) {\n-            final MapleInventoryType invtype = MapleItemInformationProvider.getInstance().getInventoryType(item.getItem().getItemId());\n-            if (!li.contains(invtype)) {\n-                li.add(invtype);\n-            }\n-            if (invtype == MapleInventoryType.EQUIP) {\n-                eq++;\n-            } else if (invtype == MapleInventoryType.USE) {\n-                use++;\n-            } else if (invtype == MapleInventoryType.SETUP) {\n-                setup++;\n-            } else if (invtype == MapleInventoryType.ETC) {\n-                etc++;\n-            } else if (invtype == MapleInventoryType.CASH) {\n-                cash++;\n-            }\n-        }\n-        for (MapleInventoryType mit : li) {\n-            if (mit == MapleInventoryType.EQUIP) {\n-                if (chr.getInventory(MapleInventoryType.EQUIP).getNumFreeSlot() <= eq) {\n-                    return false;\n-                }\n-            } else if (mit == MapleInventoryType.USE) {\n-                if (chr.getInventory(MapleInventoryType.USE).getNumFreeSlot() <= use) {\n-                    return false;\n-                }\n-            } else if (mit == MapleInventoryType.SETUP) {\n-                if (chr.getInventory(MapleInventoryType.SETUP).getNumFreeSlot() <= setup) {\n-                    return false;\n-                }\n-            } else if (mit == MapleInventoryType.ETC) {\n-                if (chr.getInventory(MapleInventoryType.ETC).getNumFreeSlot() <= etc) {\n-                    return false;\n-                }\n-            } else if (mit == MapleInventoryType.CASH) {\n-                if (chr.getInventory(MapleInventoryType.CASH).getNumFreeSlot() <= cash) {\n-                    return false;\n-                }\n-            }\n+            Item it = item.getItem().copy();\n+            it.setQuantity((short)(it.getQuantity() * item.getBundles()));\n+            \n+            li.add(new Pair<>(it, it.getInventoryType()));\n         }\n-        return true;\n+        \n+        return MapleInventory.checkSpotsAndOwnership(chr, li);\n     }\n     \n     public int getChannel() {"}, {"sha": "587c175476bb0abf36d5095650f310ca0098989a", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 65, "deletions": 22, "changes": 87, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -560,27 +560,28 @@ public static String getRoundedCoordinate(double angle) {\n         return new Pair(getRoundedCoordinate(angle), Integer.valueOf((int)distn));\n     }\n \n-    private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob) {\n-        if (mob.dropsDisabled() || !dropsOn) {\n-            return;\n+    private static void sortDropEntries(List<MonsterDropEntry> from, List<MonsterDropEntry> item, List<MonsterDropEntry> quest) {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        \n+        for(MonsterDropEntry mde : from) {\n+            if(mde.itemId == 0 || !ii.isQuestItem(mde.itemId)) {\n+                item.add(mde);\n+            } else {\n+                quest.add(mde);\n+            }\n         }\n-        final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        final byte droptype = (byte) (mob.getStats().isExplosiveReward() ? 3 : mob.getStats().isFfaLoot() ? 2 : chr.getParty() != null ? 1 : 0);\n-        final int mobpos = mob.getPosition().x;\n-        int chRate = chr.getDropRate();\n-        Item idrop;\n-        byte d = 1;\n-        Point pos = new Point(0, mob.getPosition().y);\n-\n-        MonsterStatusEffect stati = mob.getStati(MonsterStatus.SHOWDOWN);\n-        if (stati != null) {\n-            chRate *= (stati.getStati().get(MonsterStatus.SHOWDOWN).doubleValue() / 100.0 + 1.0);\n+    }\n+    \n+    private byte dropItemsFromMonsterOnMap(List<MonsterDropEntry> dropEntry, Point pos, byte d, int chRate, byte droptype, int mobpos, MapleCharacter chr, MapleMonster mob) {\n+        if(dropEntry.isEmpty()) {\n+            return d;\n         }\n-\n-        final MapleMonsterInformationProvider mi = MapleMonsterInformationProvider.getInstance();\n-        final List<MonsterDropEntry> dropEntry = new ArrayList<>(mi.retrieveDrop(mob.getId()));\n-\n+        \n         Collections.shuffle(dropEntry);\n+        \n+        Item idrop;\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        \n         for (final MonsterDropEntry de : dropEntry) {\n             if (Randomizer.nextInt(999999) < de.chance * chRate) {\n                 if (droptype == 3) {\n@@ -611,8 +612,16 @@ private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob) {\n                 d++;\n             }\n         }\n-        final List<MonsterGlobalDropEntry> globalEntry = mi.getGlobalDrop();\n-        // Global Drops\n+        \n+        return d;\n+    }\n+    \n+    private byte dropGlobalItemsFromMonsterOnMap(List<MonsterGlobalDropEntry> globalEntry, Point pos, byte d, byte droptype, int mobpos, MapleCharacter chr, MapleMonster mob) {\n+        Collections.shuffle(globalEntry);\n+        \n+        Item idrop;\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        \n         for (final MonsterGlobalDropEntry de : globalEntry) {\n             if (Randomizer.nextInt(999999) < de.chance) {\n                 if (droptype == 3) {\n@@ -631,6 +640,40 @@ private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob) {\n                 }\n             }\n         }\n+        \n+        return d;\n+    }\n+    \n+    private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob) {\n+        if (mob.dropsDisabled() || !dropsOn) {\n+            return;\n+        }\n+        final byte droptype = (byte) (mob.getStats().isExplosiveReward() ? 3 : mob.getStats().isFfaLoot() ? 2 : chr.getParty() != null ? 1 : 0);\n+        final int mobpos = mob.getPosition().x;\n+        int chRate = chr.getDropRate();\n+        byte d = 1;\n+        Point pos = new Point(0, mob.getPosition().y);\n+\n+        MonsterStatusEffect stati = mob.getStati(MonsterStatus.SHOWDOWN);\n+        if (stati != null) {\n+            chRate *= (stati.getStati().get(MonsterStatus.SHOWDOWN).doubleValue() / 100.0 + 1.0);\n+        }\n+\n+        final MapleMonsterInformationProvider mi = MapleMonsterInformationProvider.getInstance();\n+        \n+        final List<MonsterDropEntry>  dropEntry = new ArrayList<>();\n+        final List<MonsterDropEntry> questEntry = new ArrayList<>();\n+        sortDropEntries(mi.retrieveDrop(mob.getId()), dropEntry, questEntry);\n+        \n+        // Normal Drops\n+        d = dropItemsFromMonsterOnMap(dropEntry, pos, d, chRate, droptype, mobpos, chr, mob);\n+        \n+        // Global Drops\n+        final List<MonsterGlobalDropEntry> globalEntry = mi.getGlobalDrop();\n+        d = dropGlobalItemsFromMonsterOnMap(globalEntry, pos, d, droptype, mobpos, chr, mob);\n+        \n+        // Quest Drops\n+        dropItemsFromMonsterOnMap(questEntry, pos, d, chRate, droptype, mobpos, chr, mob);\n     }\n     \n     public void dropFromReactor(final MapleCharacter chr, final MapleReactor reactor, Item drop, Point dropPos, short questid) {\n@@ -1852,7 +1895,7 @@ public final void spawnItemDropList(List<Integer> list, int minCopies, int maxCo\n                 final Item drop;\n                 int randomedId = list.get(i);\n \n-                if (ii.getInventoryType(randomedId) != MapleInventoryType.EQUIP) {\n+                if (ItemConstants.getInventoryType(randomedId) != MapleInventoryType.EQUIP) {\n                     drop = new Item(randomedId, (short) 0, (short) (rnd.nextInt(copies) + minCopies));\n                 } else {\n                     drop = ii.randomizeStats((Equip) ii.getEquipById(randomedId));\n@@ -2567,7 +2610,7 @@ public MapleFootholdTree getFootholds() {\n     }\n     \n     public void setMapPointBoundings(int px, int py, int h, int w) {\n-        mapArea.setBounds(px + 7, py, w - 14, h);\n+        mapArea.setBounds(px + 45, py, w - 90, h);\n     }\n     \n     public void setMapLineBoundings(int vrTop, int vrBottom, int vrLeft, int vrRight) {"}, {"sha": "45a9b0f17a6ad748a8a161e2bf228958bb2244ec", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -144,6 +144,9 @@ private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid) {\n                 bounds[3] = MapleDataTool.getInt(minimapData.getChildByPath(\"width\"));\n \n                 map.setMapPointBoundings(bounds[0], bounds[1], bounds[2], bounds[3]);\n+            } else {\n+                int dist = (1 << 18);\n+                map.setMapPointBoundings(-dist / 2, -dist / 2, dist, dist);\n             }\n         } else {\n             bounds[2] = MapleDataTool.getInt(infoData.getChildByPath(\"VRLeft\"));"}, {"sha": "e1310b41c528fa0825f273dbd79b9c5140d2ffb8", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -24,6 +24,7 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Item;\n+import client.inventory.MapleInventoryType;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.LinkedList;\n@@ -187,6 +188,10 @@ public void removeItem(int item) {\n         }\n     }\n \n+    private static boolean canBuy(MapleClient c, Item newItem) {\n+        return MapleInventoryManipulator.checkSpace(c, newItem.getItemId(), newItem.getQuantity(), newItem.getOwner()) && MapleInventoryManipulator.addFromDrop(c, newItem, false);\n+    }\n+    \n     /**\n      * no warnings for now o.o\n      * @param c\n@@ -201,14 +206,14 @@ public void buy(MapleClient c, int item, short quantity) {\n                 newItem.setQuantity(newItem.getQuantity());\n                 if (quantity < 1 || pItem.getBundles() < 1 || newItem.getQuantity() > pItem.getBundles() || !pItem.isExist()) {\n                     return;\n-                } else if (newItem.getType() == 1 && newItem.getQuantity() > 1) {\n+                } else if (newItem.getInventoryType().equals(MapleInventoryType.EQUIP) && newItem.getQuantity() > 1) {\n                     return;\n                 }\n                 synchronized (c.getPlayer()) {\n                     int price = (int) Math.min((long)pItem.getPrice() * quantity, Integer.MAX_VALUE);\n                     \n                     if (c.getPlayer().getMeso() >= price) {\n-                        if (MapleInventoryManipulator.addFromDrop(c, newItem, false)) {\n+                        if (canBuy(c, newItem)) {\n                             c.getPlayer().gainMeso(-price, false);\n                             \n                             announceItemSold(newItem, price);   // idea thanks to vcoc\n@@ -235,9 +240,8 @@ public void buy(MapleClient c, int item, short quantity) {\n     \n     private void announceItemSold(Item item, int mesos) {\n         String qtyStr = (item.getQuantity() > 1) ? \" (qty. \" + item.getQuantity() + \")\" : \"\";\n-        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         \n-        owner.dropMessage(6, \"[PLAYER SHOP] Item '\" + ii.getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n+        owner.dropMessage(6, \"[PLAYER SHOP] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n     }\n \n     public void broadcastToVisitors(final byte[] packet) {"}, {"sha": "b33ed728c0678c14c30a7547237db53cc376665f", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -26,6 +26,7 @@\n import client.inventory.Item;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.Comparator;\n@@ -34,7 +35,6 @@\n import provider.MapleData;\n import provider.MapleDataTool;\n import server.MapleInventoryManipulator;\n-import server.MapleItemInformationProvider;\n import server.quest.MapleQuest;\n import server.quest.MapleQuestActionType;\n import tools.MaplePacketCreator;\n@@ -92,7 +92,6 @@ public void run(MapleCharacter chr, Integer extSelection) {\n                 List<Pair<Integer, Integer>> takeItem = new LinkedList<>();\n                 List<Pair<Integer, Integer>> giveItem = new LinkedList<>();\n             \n-\t\tMapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n                 int props = 0, rndProps = 0, accProps = 0;\n \t\tfor(ItemData item : items) {\n \t\t\tif(item.getProp() != null && item.getProp() != -1 && canGetItem(item, chr)) {\n@@ -133,7 +132,7 @@ public void run(MapleCharacter chr, Integer extSelection) {\n                 // must take all needed items before giving others\n                 \n                 for(Pair<Integer, Integer> iEntry: takeItem) {\n-                        MapleInventoryType type = ii.getInventoryType(iEntry.getLeft());\n+                        MapleInventoryType type = ItemConstants.getInventoryType(iEntry.getLeft());\n                         int quantity = iEntry.getRight() * -1; // Invert\n                         if(type.equals(MapleInventoryType.EQUIP)) {\n                                 if(chr.getInventory(type).countById(iEntry.getLeft()) < quantity) {\n@@ -157,8 +156,6 @@ public void run(MapleCharacter chr, Integer extSelection) {\n \t\n \t@Override\n \tpublic boolean check(MapleCharacter chr, Integer extSelection) {\n-\t\tMapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-                \n \t\tList<Pair<Item, MapleInventoryType>> gainList = new LinkedList<>();\n                 List<Pair<Item, MapleInventoryType>> selectList = new LinkedList<>();\n                 List<Pair<Item, MapleInventoryType>> randomList = new LinkedList<>();\n@@ -171,7 +168,7 @@ public boolean check(MapleCharacter chr, Integer extSelection) {\n \t\t\t\tcontinue;\n \t\t\t}\n                         \n-\t\t\tMapleInventoryType type = ii.getInventoryType(item.getId());\n+\t\t\tMapleInventoryType type = ItemConstants.getInventoryType(item.getId());\n \t\t\tif(item.getProp() != null) {\n                                 Item toItem = new Item(item.getId(), (short) 0, (short) item.getCount());\n                             "}, {"sha": "3e65be404e23c1511d47af1190d22a36b4df4488", "filename": "src/server/quest/requirements/ItemRequirement.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/server/quest/requirements/ItemRequirement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/server/quest/requirements/ItemRequirement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/requirements/ItemRequirement.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -32,6 +32,7 @@\n import client.MapleCharacter;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n \n /**\n  *\n@@ -64,7 +65,7 @@ public boolean check(MapleCharacter chr, Integer npcid) {\n \t\t\tint countNeeded = items.get(itemId);\n \t\t\tint count = 0;\n \t\t\t\n-\t\t\tMapleInventoryType iType = ii.getInventoryType(itemId);\n+\t\t\tMapleInventoryType iType = ItemConstants.getInventoryType(itemId);\n \t\t\t\n \t\t\tif (iType.equals(MapleInventoryType.UNDEFINED)) {\n \t\t\t\treturn false;"}, {"sha": "d38f429d293eedd4ffeb051fabc25b4e52ed9308", "filename": "src/tools/DatabaseConnection.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/tools/DatabaseConnection.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/tools/DatabaseConnection.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/DatabaseConnection.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -22,7 +22,9 @@ public static Connection getConnection() throws SQLException {\n         if(ds != null) {\n             try {\n                 return ds.getConnection();\n-            } catch (SQLException sqle) {}\n+            } catch (SQLException sqle) {\n+                sqle.printStackTrace();\n+            }\n         }\n         \n         int denies = 0;"}, {"sha": "5570e27b7be9568b971110ae9d7430c81208e348", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -361,7 +361,8 @@ private static void addItemInfo(final MaplePacketLittleEndianWriter mplew, Item\n                 boolean isRing = false;\n                 Equip equip = null;\n                 short pos = item.getPosition();\n-                if (item.getType() == 1) {\n+                byte itemType = item.getItemType();\n+                if (itemType == 1) {\n                         equip = (Equip) item;\n                         isRing = equip.getRingId() > -1;\n                 }\n@@ -375,7 +376,7 @@ private static void addItemInfo(final MaplePacketLittleEndianWriter mplew, Item\n                                 mplew.write(pos);\n                         }\n                 }\n-                mplew.write(item.getType());\n+                mplew.write(itemType);\n                 mplew.writeInt(item.getItemId());\n                 mplew.writeBool(isCash);\n                 if (isCash) {\n@@ -5081,7 +5082,7 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n         }\n         \n         public static byte[] owlOfMinerva(MapleClient c, int itemid, List<Pair<MaplePlayerShopItem, AbstractMapleMapObject>> hmsAvailable) {\n-                byte itemType = MapleItemInformationProvider.getInstance().getInventoryType(itemid).getType();\n+                byte itemType = ItemConstants.getInventoryType(itemid).getType();\n                 \n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.SHOP_SCANNER_RESULT.getValue()); // header.\n@@ -6425,6 +6426,15 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 return mplew.getPacket();\n         }\n \n+        public static byte[] sendDueyNotification(boolean quickDelivery) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.PARCEL.getValue());\n+                mplew.write(0x1B);\n+                mplew.writeBool(quickDelivery);  // 0 : package received, 1 : quick delivery package\n+                \n+                return mplew.getPacket();\n+        }\n+        \n         public static byte[] sendDueyMSG(byte operation) {\n                 return sendDuey(operation, null);\n         }\n@@ -6865,7 +6875,7 @@ public static void addCashItemInformation(final MaplePacketLittleEndianWriter mp\n                 boolean isGift = giftMessage != null;\n                 boolean isRing = false;\n                 Equip equip = null;\n-                if (item.getType() == 1) {\n+                if (item.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                         equip = (Equip) item;\n                         isRing = equip.getRingId() > -1;\n                 }"}, {"sha": "48eb88df41a55b30864e10d862ad10cb5eccf192", "filename": "wz/String.wz/Map.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/1190513d0c0ba17f826782b68df502627cb7af15/wz/String.wz/Map.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/1190513d0c0ba17f826782b68df502627cb7af15/wz/String.wz/Map.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Map.img.xml?ref=1190513d0c0ba17f826782b68df502627cb7af15", "patch": "@@ -5997,7 +5997,7 @@\n       <string name=\"mapName\" value=\"Memory Lane4\"/>\n     </imgdir>\n     <imgdir name=\"270010410\">\n-      <string name=\"streetName\" value=\"Memory Keeper\"/>\n+      <string name=\"streetName\" value=\"Time Lane\"/>\n       <string name=\"mapName\" value=\"Resting Spot of Memory4\"/>\n     </imgdir>\n     <imgdir name=\"270010500\">"}]}]},
