{"fetchDate": "2019-12-19", "content": [{"sha": "efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZWZjODg4NGUxOWU5ZmI3MTJkMGY1YTJkOWI1ZjdlZDNkOGY5MTY0ZA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-01-31T02:49:15Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-01-31T02:49:15Z"}, "message": "Mob aggro overhaul + STR-DEX autoassign patch + Guild & Pl. Store fix\n\nReviewed Monster Magnet skill effect on mobs, now properly showing up to other players.\nReworked concurrency protection on login handler, now properly synchronizing requests for the same accountId.\nReviewed an expedition issue with attempting to send packets on loggedoff players. Expeditions no longer holds a character object list of its own, rather finding players through their id on the world storage.\nAdded stat requirement definition as first message on 1st job NPCs.\nFixed an issue with area triggered NPC conversations not getting properly disposed.\nReviewed \"launch.bat\", internally referencing Java7 engine. Assuming it has been installed in the default directory on the system, it's no longer necessary to set precedence on PATH for it.\nFixed need for \"reapproval from the 3rd job instructors\" to attempt Zakum once more.\nReviewed goto command. Non-GM's no longer has access to area maps, only towns.\nImplemented a new server flag for enforcing base rates (server rate: 1x) on players level 10 or lower.\nFixed player guild tooltips not being properly marshalled to others on the map, at the event of several guild actions.\nReviewed event system allowing creation of same-name events, potentially leading to null EIM problems.\nRefactored some locks on MapleCharacter, potentially solving a deadlock case within expiring/forfeiting quest methods.\nImplemented a major overhaul on mob aggro system, now updating player aggro in real-time based on their latest DPS. Properly refactored and encapsulated aggro mechanics.\nFixed NPE on disposing events with alive mobs.\nAdded server-side birthday check handling when opening player shops or merchants having cash items in store.\nFixed player shop tooltip not finishing properly when shop owner closes store with visitors still in there.\nFixed forceChangeMap method not warping players to the designated event map (rather sending them to the starting event map).\nReviewed \"summon\" command, now using forceChangeMap, also changing channels if needed.\nReworked HeavenMS autoassigner: STR-based classes now ups a bit more DEX than before, since its a vital attribute for accuracy on their actions.\nAdded meso ceil check on player transactions. Trades now gets suspended if the max amount is reached.\nImplemented server-side item limit check on player shops and merchants.\nFixed an exploit with merchants, on where players would be able to save the selling item on DB before taking from inventory.", "tree": {"sha": "e3b4390b889ee504b3531ffc5c9897356aa289bb", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/e3b4390b889ee504b3531ffc5c9897356aa289bb"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "html_url": "https://github.com/ronancpl/HeavenMS/commit/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "98be29b088a1c6252a76c072738c49e4204719a7", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/98be29b088a1c6252a76c072738c49e4204719a7", "html_url": "https://github.com/ronancpl/HeavenMS/commit/98be29b088a1c6252a76c072738c49e4204719a7"}], "stats": {"total": 24874, "additions": 12824, "deletions": 12050}, "files": [{"sha": "df258ac2300ef6f94218bfc0ab84f94ab2c4a6d1", "filename": "README.md", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -6,7 +6,7 @@ Besides myself for maintaining this repository, credits are to be given to Wizet\n \n Regarding distributability and usage of the code presented here: like it was before, this MapleStory server is open-source. By that, it is meant that anyone is **free to install, use, modify and redistribute the contents**, as long as there is **no kind of commercial trading involved** and the **credits to the original creators are maintained** within the codes.\n \n-This is a NetBeans 8.0.2 Project, that MUST be built and run under JDK/JRE 7 (1.7.0_79+) in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n+This is a NetBeans 8.0.2 Project, that MUST be built and run on Java 7 (JDK/JRE 1.7.0_79+) in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n \n In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of server source, in order to perceive it at it's full potential. My opinion, though!\n \n@@ -19,6 +19,8 @@ Server files: https://github.com/ronancpl/HeavenMS\n \n Client files & general tools: https://drive.google.com/drive/folders/0BzDsHSr-0V4MYVJ0TWIxd05hYUk\n \n+Java7 SDK: https://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html\n+\n **Important note about localhosts**: these executables are red-flagged by antivirus tools as __potentially malicious softwares__, this happens due to the reverse engineering methods that were applied onto these software artifacts. Those depicted here have been put to use for years already and posed no harm so far, so they are soundly assumed to be safe.\n \n   Latest localhost: https://hostr.co/m2bVtnizCtmD\n@@ -81,6 +83,7 @@ It's never enough to tell this, thanks to everyone that have been contributing s\n \n Our Discord channel is still available on: https://discord.gg/Q7wKxHX\n \n+<hr id=\"donate\" />\n ### Donation\n \n If you REALLY liked what you have seen on the project, please feel free to donate a little something as a helping hand for my contributions towards Maple development. Also remember to **support Nexon**!"}, {"sha": "792b6905644606c2982d4b3648f494a0586c7c90", "filename": "cores/HikariCP-java7-2.4.12.jar", "status": "removed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/98be29b088a1c6252a76c072738c49e4204719a7/cores/HikariCP-java7-2.4.12.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/98be29b088a1c6252a76c072738c49e4204719a7/cores/HikariCP-java7-2.4.12.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/cores/HikariCP-java7-2.4.12.jar?ref=98be29b088a1c6252a76c072738c49e4204719a7"}, {"sha": "6506cbac92c9bef6ee99bd529454addf3685a188", "filename": "cores/HikariCP-java7-2.4.13.jar", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/cores/HikariCP-java7-2.4.13.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/cores/HikariCP-java7-2.4.13.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/cores/HikariCP-java7-2.4.13.jar?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d"}, {"sha": "4c03fa6bb21496873cc90e5442f89905c95e7316", "filename": "cores/slf4j-api-1.6.6.jar", "status": "removed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/98be29b088a1c6252a76c072738c49e4204719a7/cores/slf4j-api-1.6.6.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/98be29b088a1c6252a76c072738c49e4204719a7/cores/slf4j-api-1.6.6.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/cores/slf4j-api-1.6.6.jar?ref=98be29b088a1c6252a76c072738c49e4204719a7"}, {"sha": "2a5c33ec55491e5b4be53525d8d7242e53e020c0", "filename": "cores/slf4j-api-1.7.21.jar", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/cores/slf4j-api-1.7.21.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/cores/slf4j-api-1.7.21.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/cores/slf4j-api-1.7.21.jar?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d"}, {"sha": "25788d0a90a2cccf786e3f0798a31bb0bed87263", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 47, "deletions": 1, "changes": 48, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -1573,4 +1573,50 @@ Protegido concorrentemente sistema de comandos, assim evitando processamento em\n \n 16 Janeiro 2019,\n Revisado login handler, trazendo m\u00e9todos de desconex\u00e3o para antes de checar LoginState, e n\u00e3o permitindo reatribui\u00e7\u00e3o de objeto-cliente para jogador j\u00e1 logado em canal.\n-Revisado disconnect no login handler, agora devidamente finalizando sess\u00f5es rec\u00e9m-criadas que falham em conectar jogador ao mundo.\n\\ No newline at end of file\n+Revisado disconnect no login handler, agora devidamente finalizando sess\u00f5es rec\u00e9m-criadas que falham em conectar jogador ao mundo.\n+Revisado skill Monster Magnet, agora devidamente mostrando efeitos de skill.\n+Mais uma tentativa de prote\u00e7\u00e3o contra acesso concorrente no login handler, buscando evitar m\u00faltiplas requisi\u00e7\u00f5es concorrente por um accountId durante processo e m\u00faltiplas requisi\u00e7\u00f5es de mesmo objeto de cliente.\n+Revisado objeto das expedi\u00e7\u00f5es, n\u00e3o mais permitindo armazenar objetos de jogadores (que j\u00e1 podem ter sido desativados).\n+Corrigido expedi\u00e7\u00f5es enviando pacotes para jogadores que est\u00e3o fora de jogo.\n+Normalizado mensagens de 1o job de NPCs explorers, com afirma\u00e7\u00e3o de m\u00ednimo de stats antes de checar requerimentos.\n+\n+18 Janeiro 2019,\n+Corrigido dispose de intera\u00e7\u00e3o com NPCs n\u00e3o devolvendo controle de certas a\u00e7\u00f5es ao jogador, mais not\u00e1vel quando a intera\u00e7\u00e3o ocorreu automaticamente (jogador caminhou pra \u00e1rea de atua\u00e7\u00e3o).\n+Removido pigs de Maple Island, j\u00e1 que o quiz de 3rd job sugere n\u00e3o h\u00e1 os mesmos l\u00e1. Cynical Orange Mushrooms passam a ocupar posi\u00e7\u00f5es dos mesmos.\n+Editado \"launch.bat\" para somente usar Java7, assim permitindo usu\u00e1rios a n\u00e3o terem que especificar prefer\u00eancia de uso de Java7 nas vari\u00e1veis de ambiente PATH.\n+\n+20 Janeiro 2019,\n+Corrigido necessidade de repetir aprova\u00e7\u00e3o dos mestres para realizar expedi\u00e7\u00f5es de Zakum.\n+Revisado comando goto. Jogadores tem acesso somente a mapas de cidade, GMs tem acesso a areas tamb\u00e9m.\n+Implementado EXP rate espec\u00edfico para novatos de n\u00edvel menor que 11.\n+Revisado petid sendo setado fora de \u00e1rea de atua\u00e7\u00e3o (at\u00e9 ent\u00e3o n\u00e3o compete setar isso ap\u00f3s criado objeto de Item).\n+\n+21 - 24 Janeiro 2019,\n+Corrigido sistema de guilds n\u00e3o atualizando corretamente tooltips de informa\u00e7\u00e3o de guild de jogadores no mapa, para ampla quantidade de eventos com guilds (adicionar player na guild, trocar emblema, remover player, etc).\n+Corrigido sistema de eventos permitindo entrada duplicada de eventos com mesmo nome nos registros do gerenciador de eventos, potencialmente levando a nulos em EIMs.\n+Corrigido skill Hyper Body cancelando efeito do buff anterior ao reutilizar a skill, levando valores suficientemente grandes de HP corrente do jogador ao MaxHP base (MaxHP antes de utilizar a skill).\n+Refatorado uso de evtLock para m\u00e9todos que gerenciam expira\u00e7\u00e3o de quests, poss\u00edvelmente resolvendo caso de deadlock no m\u00e9todo de desist\u00eancia de quests expir\u00e1veis.\n+Revisado MoveLifeHandler, n\u00e3o mais propagando pacotes de movimenta\u00e7\u00e3o de mobs vindas de jogadores que n\u00e3o s\u00e3o controladores.\n+Refatorado completamente o sistema de aggro de mobs. Agora, m\u00e9todos que atuam na atualiza\u00e7\u00e3o de aggros de mobs usam fun\u00e7\u00f5es comuns.\n+\n+25 - 26 Janeiro 2019,\n+Corrigido problema de acesso a ponteiro nulo ao realizar dispose no sistema de mapas das inst\u00e2ncias de eventos. Refer\u00eancia ao gerenciador de eventos j\u00e1 era nulo ao atingir tal m\u00e9todo.\n+Implementado retorno de estado de aggro para \"sem aggro\" se n\u00e3o houveram atividades de aggro num mob por algum tempo.\n+Implementado checagem de anivers\u00e1rio ao adicionar itens de cash \u00e0s lojas de player.\n+Corrigido Hired Merchants n\u00e3o fechando devidamente ao abrir loja com itens de cash.\n+Corrigido tooltip de Hired Merchant n\u00e3o atualizando para \"indispon\u00edvel\" quando a loja est\u00e1 em manuten\u00e7\u00e3o.\n+Corrigido tooltip de Player Shops n\u00e3o fechando corretamente se ainda havia visitantes na loja.\n+Mais alguns ajustes no novo sistema de aggros. Nesta implementa\u00e7\u00e3o aparentemente somente controladores processam ataques do tipo \"areaWarning\" de mobs.\n+Corrigido fun\u00e7\u00e3o forceChangeMap n\u00e3o levando devidamente jogadores para o mapa dado como par\u00e2metro, quando tal mapa \u00e9 de inst\u00e2ncia de evento.\n+Revisado comando de summon de jogadores, agora utilizando fun\u00e7\u00e3o padr\u00e3o forceChangeMap, que lida com registro de jogadores em inst\u00e2ncias e coloca jogador no mapa alvo.\n+Adicionado, no comando de summon de jogadores, habilidade de colocar jogadores em outros canais dentro do mapa de evento.\n+\n+27 - 29 Janeiro 2019,\n+Corrigido custom AP autoassigner n\u00e3o utilizando devidamente os caps definidos no escopo do handler.\n+Revisado custom AP autoassigner. Classes que usam DEX como atributo secund\u00e1rio para STR foram rebalanceados, de forma que o aumento no uso do atributo secund\u00e1rio permita melhores condi\u00e7\u00f5es de ataque no jogo.\n+Adicionado checagem de mesos em transa\u00e7\u00f5es entre jogadores, lojas de jogador, ao receber itens de Duey e Fredrick.\n+Adicionado checagem em quantidade de itens nas lojas e mercantes de jogadores, assim evitando bugs quando h\u00e1 mais itens a serem vendidos do que o esperado.\n+Corrigido um exploit com mercantes, envolvendo chamada \u00e0 DB antes de retirar item (que est\u00e1 sendo inserido na loja) do invent\u00e1rio do jogador.\n+\n+30 Janeiro 2019,\n+Corrigido chamadas irregulares a \"qm/cm\" em scripts.\n\\ No newline at end of file"}, {"sha": "076a28d634f220793f27753296dcfdf21557a318", "filename": "launch.bat", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/launch.bat", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/launch.bat", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/launch.bat?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -1,5 +1,6 @@\n @echo off\n @title HeavenMS\n+set PATH=C:\\Program Files\\Java\\jdk1.7.0_79\\bin;%PATH%\n set CLASSPATH=.;dist\\*\n java -Xmx2048m -Dwzpath=wz\\ net.server.Server\n pause\n\\ No newline at end of file"}, {"sha": "3c19c318ab3a7e25c7506ca4195e3e0348b6e2f1", "filename": "nbproject/project.properties", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/nbproject/project.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/nbproject/project.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/project.properties?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -28,21 +28,21 @@ dist.jar=${dist.dir}/HeavenMS.jar\n dist.javadoc.dir=${dist.dir}/javadoc\n endorsed.classpath=\n excludes=\n-file.reference.HikariCP-java7-2.4.12.jar=cores/HikariCP-java7-2.4.12.jar\n+file.reference.HikariCP-java7-2.4.13.jar=cores/HikariCP-java7-2.4.13.jar\n file.reference.MapleSolaxia-src=src\n file.reference.mina-core-2.0.7.jar=cores/mina-core-2.0.7.jar\n file.reference.mysql-connector-java-bin.jar=cores/mysql-connector-java-bin.jar\n-file.reference.slf4j-api-1.6.6.jar=cores/slf4j-api-1.6.6.jar\n+file.reference.slf4j-api-1.7.21.jar=cores/slf4j-api-1.7.21.jar\n file.reference.slf4j-jdk14-1.7.5.jar=cores/slf4j-jdk14-1.7.5.jar\n includes=**\n jar.archive.disabled=${jnlp.enabled}\n jar.compress=true\n jar.index=${jnlp.enabled}\n javac.classpath=\\\n-    ${file.reference.HikariCP-java7-2.4.12.jar}:\\\n     ${file.reference.mina-core-2.0.7.jar}:\\\n+    ${file.reference.slf4j-api-1.7.21.jar}:\\\n+    ${file.reference.HikariCP-java7-2.4.13.jar}:\\\n     ${file.reference.mysql-connector-java-bin.jar}:\\\n-    ${file.reference.slf4j-api-1.6.6.jar}:\\\n     ${file.reference.slf4j-jdk14-1.7.5.jar}\n # Space-separated list of extra javac options\n javac.compilerargs="}, {"sha": "abebcb671a05895929910fbf893960486d94c64b", "filename": "scripts/npc/1012100.js", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1012100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1012100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1012100.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -46,12 +46,7 @@ function start() {\n     } else {\n         if (cm.getJobId() == 0) {\n             actionx[\"1stJob\"] = true;\n-            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType))\n-                cm.sendNext(\"So you decided to become a #rBowman#k?\");\n-            else {\n-                cm.sendOk(\"Train a bit more until you reach #blevel 10, \" + cm.getFirstJobStatRequirement(jobType) + \"#k and I can show you the way of the #rBowman#k.\");\n-                cm.dispose();\n-            }\n+            cm.sendNext(\"So you decided to become a #rbowman#k? There are some standards to meet, y'know... #bYour level should be at least 10, with at least \" + cm.getFirstJobStatRequirement(jobType) + \"#k. Let's see.\");   // thanks Vcoc for noticing a need to state and check requirements on first job adv starting message\n         } else if (cm.getLevel() >= 30 && cm.getJobId() == 300) {\n             actionx[\"2ndJob\"] = true;\n             if (cm.haveItem(4031012))\n@@ -79,8 +74,13 @@ function start() {\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode == 0 && type != 1)\n+    if (mode == -1 && selection == -1) {\n+        cm.dispose();\n+        return;\n+    } else if (mode == 0 && type != 1) {\n         status -= 2;\n+    }\n+    \n     if (status == -1){\n         start();\n         return;\n@@ -116,10 +116,15 @@ function action(mode, type, selection) {\n     }\n     \n     if (actionx[\"1stJob\"]){\n-        if (status == 0)\n-            cm.sendNextPrev(\"It is an important and final choice. You will not be able to turn back.\");\n-        else if (status == 1){\n-            if (cm.canHold(1452051) && cm.canHold(2060000)){\n+        if (status == 0) {\n+            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType)) {\n+                cm.sendNextPrev(\"It is an important and final choice. You will not be able to turn back.\");\n+            } else {\n+                cm.sendOk(\"Train a bit more until you reach the base requirements and I can show you the way of the #rBowman#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1){\n+            if (cm.canHold(1452051) && cm.canHold(2070000)){\n                 if (cm.getJobId() == 0){\n                     cm.changeJobById(300);\n                     cm.gainItem(1452051, 1);"}, {"sha": "ba4813df37d1c3c20c0b4301d87762a496948884", "filename": "scripts/npc/1013001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1013001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1013001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1013001.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -8,7 +8,7 @@ function action(mode, type, selection) {\n \tif (mode == 0 && type == 0) {\n \t\tstatus--;\n \t} else if (mode == -1) {\n-\t\tqm.dispose();\n+\t\tcm.dispose();\n \t\treturn;\n \t} else {\n \t\tstatus++;"}, {"sha": "4d4aaeae598212f527e77bd8e5fa4a4700401c6b", "filename": "scripts/npc/1022000.js", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1022000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1022000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1022000.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -47,12 +47,7 @@ function start() {\n     } else {\n         if (cm.getJobId() == 0) {\n             actionx[\"1stJob\"] = true;\n-            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType))\n-                cm.sendNext(\"Do you want to become a Warrior? You need to meet some criteria in order to do so.#b You should be at least in level 10, with at least 35 in STR#k. Let's see...\");\n-            else {\n-                cm.sendOk(\"Train a bit more until you reach #blevel 10, \" + cm.getFirstJobStatRequirement(jobType) + \"#k and I can show you the way of the #rWarrior#k.\");\n-                cm.dispose();\n-            }\n+            cm.sendNext(\"Do you want to become a #rwarrior#k? You need to meet some criteria in order to do so.#b You should be at least in level 10, and at least \" + cm.getFirstJobStatRequirement(jobType) + \"#k. Let's see...\");   // thanks Vcoc for noticing a need to state and check requirements on first job adv starting message\n         } else if (cm.getLevel() >= 30 && cm.getJobId() == 100) {\n             actionx[\"2ndJob\"] = true;\n             if (cm.haveItem(4031012))\n@@ -80,8 +75,13 @@ function start() {\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode == 0 && type != 1)\n+    if (mode == -1 && selection == -1) {\n+        cm.dispose();\n+        return;\n+    } else if (mode == 0 && type != 1) {\n         status -= 2;\n+    }\n+    \n     if (status == -1){\n         start();\n         return;\n@@ -117,9 +117,14 @@ function action(mode, type, selection) {\n     }\n     \n     if (actionx[\"1stJob\"]){\n-        if (status == 0)\n-            cm.sendNextPrev(\"It is an important and final choice. You will not be able to turn back.\");\n-        else if (status == 1){\n+        if (status == 0) {\n+            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType)) {\n+                cm.sendNextPrev(\"It is an important and final choice. You will not be able to turn back.\");\n+            } else {\n+                cm.sendOk(\"Train a bit more until you reach the base requirements and I can show you the way of the #rWarrior#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1){\n             if (cm.canHold(1302077)){\n                 if (cm.getJobId() == 0){\n                     cm.changeJobById(100);"}, {"sha": "98bb35d84a20448347f6cccab5e545ca48cb196b", "filename": "scripts/npc/1032001.js", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1032001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1032001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1032001.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -47,12 +47,7 @@ function start() {\n     } else {\n         if (cm.getJobId() == 0) {\n             actionx[\"1stJob\"] = true;\n-            if (cm.getLevel() >= 8 && cm.canGetFirstJob(jobType))\n-                cm.sendNext(\"Want to be a magician? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 8#k, with getting INT as your top priority. Let's see.\");\n-            else {\n-                cm.sendOk(\"Train a bit more until you reach #blevel 8, \" + cm.getFirstJobStatRequirement(jobType) + \"#k and I can show you the way of the #rMagician#k.\");\n-                cm.dispose();\n-            }\n+            cm.sendNext(\"Want to be a #rmagician#k? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 8#k, with getting \" + cm.getFirstJobStatRequirement(jobType) + \" as your top priority. Let's see.\");   // thanks Vcoc for noticing a need to state and check requirements on first job adv starting message\n         } else if (cm.getLevel() >= 30 && cm.getJobId() == 200) {\n             actionx[\"2ndJob\"] = true;\n             if (cm.haveItem(4031012))\n@@ -80,8 +75,13 @@ function start() {\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode == 0 && type == 0)\n+    if (mode == -1 && selection == -1) {\n+        cm.dispose();\n+        return;\n+    } else if (mode == 0 && type == 0) {\n         status -= 2;\n+    }\n+    \n     if (status == -1){\n         start();\n         return;\n@@ -117,9 +117,14 @@ function action(mode, type, selection) {\n     }\n     \n     if (actionx[\"1stJob\"]){\n-        if (status == 0)\n-            cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little sinister mind, and... yeah... so, what do you think? Wanna be the Magician?\");\n-        else if (status == 1){\n+        if (status == 0) {\n+            if (cm.getLevel() >= 8 && cm.canGetFirstJob(jobType)) {\n+                cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little sinister mind, and... yeah... so, what do you think? Wanna be the Magician?\");\n+            } else {\n+                cm.sendOk(\"Train a bit more until you reach the base requirements and I can show you the way of the #rMagician#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1){\n             if (cm.canHold(1372043)){\n                 if (cm.getJobId() == 0){\n                     cm.changeJobById(200);"}, {"sha": "a9ae74c16108eddd326b0c15f9109a72bd22f07b", "filename": "scripts/npc/1052001.js", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1052001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1052001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052001.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -46,12 +46,7 @@ function start() {\n     } else {\n         if (cm.getJobId() == 0) {\n             actionx[\"1stJob\"] = true;\n-            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType))\n-                cm.sendNext(\"Want to be a thief? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 10, with your DEX over 25#k. Let's see.\");\n-            else {\n-                cm.sendOk(\"Train a bit more until you reach #blevel 10, \" + cm.getFirstJobStatRequirement(jobType) + \"#k and I can show you the way of the #rThief#k.\");\n-                cm.dispose();\n-            }\n+            cm.sendNext(\"Want to be a #rthief#k? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 10, with at least your \" + cm.getFirstJobStatRequirement(jobType) + \"#k. Let's see.\");   // thanks Vcoc for noticing a need to state and check requirements on first job adv starting message\n         } else if (cm.getLevel() >= 30 && cm.getJobId() == 400) {\n             actionx[\"2ndJob\"] = true;\n             if (cm.haveItem(4031012))\n@@ -81,8 +76,13 @@ function start() {\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode == 0 && type != 1)\n+    if (mode == -1 && selection == -1) {\n+        cm.dispose();\n+        return;\n+    } else if (mode == 0 && type != 1) {\n         status -= 2;\n+    }    \n+    \n     if (status == -1){\n         start();\n         return;\n@@ -118,14 +118,20 @@ function action(mode, type, selection) {\n     }\n     \n     if (actionx[\"1stJob\"]){\n-        if (status == 0)\n-            cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little sinister mind, and... yeah... so, what do you think? Wanna be the Rogue?\");\n-        else if (status == 1){\n-            if (cm.canHold(2070000) && cm.canHold(1472061)){\n+        if (status == 0) {\n+            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType))\n+                cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little sinister mind, and... yeah... so, what do you think? Wanna be the Rogue?\");\n+            else {\n+                cm.sendOk(\"Train a bit more until you reach the base requirements and I can show you the way of the #rThief#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1){\n+            if (cm.canHold(2070000) && cm.canHoldAll([1472061, 1332063])){\n                 if (cm.getJobId() == 0){\n                     cm.changeJobById(400);\n-                    cm.gainItem(2070000, 500);\n+                    cm.gainItem(2070015, 500);\n                     cm.gainItem(1472061, 1);\n+                    cm.gainItem(1332063, 1);\n                     cm.resetStats();\n                 }\n                 cm.sendNext(\"Alright, from here out, you are a part of us! You'll be living the life of a wanderer at ..., but just be patient as soon, you'll be living the high life. Alright, it ain't much, but I'll give you some of my abilities... HAAAHHH!!!\");"}, {"sha": "b7c51c48917e8e6f646a1cef477f7e27a9efeb27", "filename": "scripts/npc/1061014.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1061014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1061014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061014.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,6 +29,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.BALROG_NORMAL;\n@@ -68,7 +69,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -120,7 +121,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -129,13 +131,13 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -170,7 +172,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "60b573219d123f88f80aab196447b9fbaff36655", "filename": "scripts/npc/1090000.js", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1090000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/1090000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1090000.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -77,12 +77,7 @@ function start() {\n     } else {\n         if (cm.getJobId() == 0) {\n             actionx[\"1stJob\"] = true;\n-            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType))\n-                cm.sendNext(\"Want to be a pirate? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 10#k. Let's see.\");\n-            else {\n-                cm.sendOk(\"Train a bit more until you reach #blevel 10, \" + cm.getFirstJobStatRequirement(jobType) + \"#k and I can show you the way of the #rPirate#k.\");\n-                cm.dispose();\n-            }\n+            cm.sendNext(\"Want to be a #rpirate#k? There are some standards to meet. because we can't just accept EVERYONE in... #bYour level should be at least 10, with \" + cm.getFirstJobStatRequirement(jobType) + \" minimum#k. Let's see.\");   // thanks Vcoc for noticing a need to state and check requirements on first job adv starting message\n         } else if (cm.getLevel() >= 30 && cm.getJobId() == 500) {\n             actionx[\"2ndJob\"] = true;\n             if (cm.isQuestCompleted(2191) || cm.isQuestCompleted(2192))\n@@ -107,8 +102,13 @@ function start() {\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode == 0 && type != 1)\n+    if (mode == -1 && selection == -1) {\n+        cm.dispose();\n+        return;\n+    } else if (mode == 0 && type != 1) {\n         status -= 2;\n+    }\n+    \n     if (status == -1){\n         start();\n         return;\n@@ -161,10 +161,15 @@ function action(mode, type, selection) {\n     }\n     \n     if (actionx[\"1stJob\"]){\n-        if (status == 0)\n-            cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little slang, and... yeah... so, what do you think? Wanna be the Pirate?\");\n-        else if (status == 1){\n-            if (cm.canHold(2070000) && cm.canHold(1472061)){\n+        if (status == 0) {\n+            if (cm.getLevel() >= 10 && cm.canGetFirstJob(jobType)) {\n+                cm.sendYesNo(\"Oh...! You look like someone that can definitely be a part of us... all you need is a little slang, and... yeah... so, what do you think? Wanna be the Pirate?\");\n+            } else {\n+                cm.sendOk(\"Train a bit more until you reach the base requirements and I can show you the way of the #rPirate#k.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1){\n+            if (cm.canHold(2070000) && cm.canHoldAll([1482000, 1492000])){\n                 if (cm.getJobId() == 0){\n                     cm.changeJobById(500);\n                     cm.gainItem(1492000, 1);"}, {"sha": "bfe4b52f82db5a59e394bbb3c5e0956cf3582bc3", "filename": "scripts/npc/2020008.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020008.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -141,7 +141,7 @@ function action(mode, type, selection){\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n             \tcm.sendNext(\"Ok, go.\");\n-                if(!cm.isQuestStarted(100200)) cm.startQuest(100200);\n+                if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n                 cm.sendNext(\"You're weak.\");"}, {"sha": "a44bdcf9573033ba8a7bd42e152e1d2fe77af5bb", "filename": "scripts/npc/2020009.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020009.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -113,7 +113,7 @@ function action(mode, type, selection){\n             } else {\n                 if (cm.getPlayer().getLevel() >= 50){\n             \t    cm.sendNext(\"Ok, go.\");\n-                    if(!cm.isQuestStarted(100200)) cm.startQuest(100200);\n+                    if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                     if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n                 }else\n                     cm.sendNext(\"You're weak.\");"}, {"sha": "6c51b76405b63a294047cd6cd5415733e2fe1ffd", "filename": "scripts/npc/2020010.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020010.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -114,7 +114,7 @@ function action(mode, type, selection){\n             } else {\n             \tif (cm.getPlayer().getLevel() >= 50){\n             \t\tcm.sendNext(\"Ok, go.\");\n-                \tif(!cm.isQuestStarted(100200)) cm.startQuest(100200);\n+                \tif(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                         if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             \t}else\n                 \tcm.sendNext(\"You're weak.\");"}, {"sha": "850b295c62afb9cf39e1c33f2f947494c18c3425", "filename": "scripts/npc/2020011.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020011.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020011.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020011.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -113,7 +113,7 @@ function action(mode, type, selection){\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n             \tcm.sendNext(\"Ok, go.\");\n-                if(!cm.isQuestStarted(100200)) cm.startQuest(100200);\n+                if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n                 cm.sendNext(\"You're weak.\");"}, {"sha": "1521740211fdeb36c0669317161efaf781d11cfb", "filename": "scripts/npc/2020013.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2020013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020013.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -112,7 +112,7 @@ function action(mode, type, selection){\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n             \tcm.sendNext(\"Ok, go.\");\n-                if(!cm.isQuestStarted(100200)) cm.startQuest(100200);\n+                if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n                 cm.sendNext(\"You're weak.\");"}, {"sha": "f05dfb3945ead09ac5d2d6c78e31d07010b827b4", "filename": "scripts/npc/2030006.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030006.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -32,14 +32,14 @@ var questionTree = [\n         //Questions Related to ITEMS\n         [\"Which of following monsters got CORRECT item corresponding to the monster?\", [\"Royal cactus - Needle\", \"Wild Boar - Boar fang\", \"Lazy Buffy - Buffy hat\", \"Chipmunk - Nut\", \"Stirge - Stirge's wing\"], 4],\n         [\"Which of following monsters got WRONG item corresponding to the monster?\", [\"Greatest Oldies - Greatest oldies\", \"Nependeath - Nependeath's leaf\", \"Ghost stump - Seedling\", \"Sparker - Seal tooth\", \"Miner Zombie - Zombie's lost tooth\"], 1],\n-        [\"In GM Event, how many FRUIT CAKE you can get as reward?\", [\"20\", \"200\", \"5\", \"25\", \"100\"], 2],\n+        //[\"In GM Event, how many FRUIT CAKE you can get as reward?\", [\"20\", \"200\", \"5\", \"25\", \"100\"], 2],\n         [\"Which of following potions got CORRECT info.?\", [\"Warrior Elixir - Attack +5 for 3 minutes\", \"Pure Water - Recover 700 MP\", \"Cake - Recover 150 HP & MP\", \"Salad - Recover 300 MP\", \"Pizza - Recover 400 HP\"], 4],\n         [\"Which of following potions got WRONG info.?\", [\"Mana Elixir - Recover 300 MP\", \"Tonic - Cures state of weakness\", \"Apple - Recover 30 HP\", \"Sunrise Dew - Recover 3000 MP\", \"Ramen - Recover 1000 HP\"], 3],\n \n         //Questions Related to MONSTERS\n         [\"Green Mushroom, Tree Stump, Bubbling, Axe Stump, Octopus, which is highest level of all?\", [\"Tree Stump\", \"Bubbling\", \"Axe Stump\", \"Octopus\", \"Green Mushroom\"], 2],\n         [\"Which monster will be seen during the ship trip to Orbis/Ellinia?\", [\"Werewolf\", \"Slime\", \"Crimson Balrog\", \"Zakum\", \"Star Pixie\"], 2],\n-        [\"Maple Island doesn't have which following monsters?\", [\"Green Mushroom\", \"Blue Snail\", \"Orange Mushroom\", \"Red Snail\", \"Pig\"], 0],\n+        [\"Maple Island doesn't have which following monsters?\", [\"Shroom\", \"Blue Snail\", \"Slime\", \"Red Snail\", \"Pig\"], 4],    // to get conformant with website answers, thanks to Vcoc\n         [\"Which monster is not at Victoria Island and Sleepywood?\", [\"Evil Eye\", \"Sentinel\", \"Jr. Balrog\", \"Ghost Stump\", \"Snail\"], 1],\n         [\"El Nath doesn't have which following monsters?\", [\"Dark Yeti\", \"Dark Ligator\", \"Yeti & Pepe\", \"Bain\", \"Coolie Zombie\"], 1],\n         [\"Which of following monsters can fly?\", [\"Malady\", \"Ligator\", \"Cold Eye\", \"Meerkat\", \"Alishar\"], 0],"}, {"sha": "c836e0234dd45da5bbe17ef412dbd6e10d9b182e", "filename": "scripts/npc/2030008.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030008.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -58,7 +58,7 @@ function action(mode, type, selection) {\n             return;\n         }\n         \n-        if(!cm.isQuestStarted(100200)) {\n+        if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) {   // thanks Vcoc for finding out a need of reapproval from the masters for Zakum expeditions\n             cm.sendOk(\"Beware, for the power of olde has not been forgotten... \");\n             cm.dispose();\n             return;"}, {"sha": "ef61b1d339739361af41084eee2e8c1834d40cfe", "filename": "scripts/npc/2030013.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2030013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030013.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,6 +29,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.ZAKUM;\n@@ -69,7 +70,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -121,7 +122,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -130,14 +132,14 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n                 \n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -172,7 +174,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "17520857e51abe660a46643b090dcf362c42a666", "filename": "scripts/npc/2083004.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2083004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2083004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2083004.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,6 +29,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.HORNTAIL;\n@@ -67,7 +68,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -113,7 +114,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -122,14 +124,14 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n                 \n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -164,7 +166,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "9772b05adcb91c80800176494b550c6392d55bde", "filename": "scripts/npc/2141001.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2141001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/2141001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2141001.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -31,6 +31,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.PINKBEAN;\n@@ -70,7 +71,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -116,7 +117,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -125,14 +127,14 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n                 \n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -167,7 +169,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "4f3b233776febd661f115f6df84b176f90974928", "filename": "scripts/npc/9120201.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9120201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9120201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120201.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -28,6 +28,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.SHOWA;\n@@ -68,7 +69,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -120,7 +121,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -129,14 +131,14 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n                 \n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -171,7 +173,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "9fd36866af984393ca5f88ceaa402b59e2b3d1da", "filename": "scripts/npc/9201014.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9201014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9201014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201014.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -61,7 +61,7 @@ function action(mode, type, selection) {\n     } else if (status == 1) {\n         if (selection == 0) {\n             if (cm.haveItem(4031424)) {\n-                if (cm.isMarried()) {\n+                if (cm.getPlayer().isMarried()) {   // thanks MedicOP for solving an issue here\n                     if(cm.getInventory(2).getNextFreeSlot() >= 0) {\n                         var rand = Math.floor(Math.random() * bgPrizes.length);\n                         cm.gainItem(bgPrizes[rand][0], bgPrizes[rand][1]);"}, {"sha": "4cd1baca909e9487ee8ff37c146d0166a4aa877f", "filename": "scripts/npc/9201113.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9201113.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9201113.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201113.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,6 +29,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var cwkpq = MapleExpeditionType.CWKPQ;\n@@ -64,7 +65,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -104,7 +105,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -113,13 +115,13 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = cwkpq.getMinSize();\n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -154,7 +156,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "4d7288d24e35fd6b9a95d4c33f050d2215c2f722", "filename": "scripts/npc/9270047.js", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9270047.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9270047.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9270047.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,6 +29,7 @@ importPackage(Packages.scripting.event);\n \n var status = 0;\n var expedition;\n+var expedMembers;\n var player;\n var em;\n var exped = MapleExpeditionType.SCARGA;\n@@ -69,7 +70,7 @@ function action(mode, type, selection) {\n                 status = 2;\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n-                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin the expedition.\");\n+                    cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n                     cm.dispose();\n                 } else { //If you aren't in it, you're going to get added\n                     cm.sendOk(expedition.addMember(cm.getPlayer()));\n@@ -121,7 +122,8 @@ function action(mode, type, selection) {\n                     cm.dispose();\n                     return;\n                 }\n-                var size = expedition.getMembers().size();\n+                expedMembers = expedition.getMemberList();\n+                var size = expedMembers.size();\n                 if (size == 1) {\n                     cm.sendOk(\"You are the only member of the expedition.\");\n                     cm.dispose();\n@@ -130,13 +132,13 @@ function action(mode, type, selection) {\n                 var text = \"The following members make up your expedition (Click on them to expel them):\\r\\n\";\n                 text += \"\\r\\n\\t\\t1.\" + expedition.getLeader().getName();\n                 for (var i = 1; i < size; i++) {\n-                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedition.getMembers().get(i).getName() + \"#l\\n\";\n+                    text += \"\\r\\n#b#L\" + (i + 1) + \"#\" + (i + 1) + \". \" + expedMembers.get(i).getValue() + \"#l\\n\";\n                 }\n                 cm.sendSimple(text);\n                 status = 6;\n             } else if (selection == 2) {\n                 var min = exped.getMinSize();\n-                var size = expedition.getMembers().size();\n+                var size = expedition.getMemberList().size();\n                 if (size < min) {\n                     cm.sendOk(\"You need at least \" + min + \" players registered in your expedition.\");\n                     cm.dispose();\n@@ -171,7 +173,7 @@ function action(mode, type, selection) {\n             return;\n         } else if (status == 6) {\n             if (selection > 0) {\n-                var banned = expedition.getMembers().get(selection - 1);\n+                var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n                 cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n                 cm.dispose();"}, {"sha": "e3c07313a76085f2d2e1fddd82e99da8479a8be5", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -77,6 +77,7 @@ function writeFeatureTab_PlayerSocialNetwork() {\n         addFeature(\"P. members' HPBar accounts HP gain on equips.\");\n         addFeature(\"Thoroughly reviewed P. Shops and H. Merchants.\");\n         addFeature(\"Transactions on Merchs instantly announced to owner.\");\n+        addFeature(\"Proper meso space check on player transactions.\");\n         addFeature(\"Game minirooms with functional pw system.\");\n         addFeature(\"Proper item pickup cooldown on non-owned items.\");\n         addFeature(\"Improved ranking system, with daily movement.\");\n@@ -121,6 +122,7 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Added meso drop data for many missing mobs.\");\n         addFeature(\"Monsterbook displays updated drop data info.\");\n         addFeature(\"Every skill/mastery book is now obtainable.\");\n+        addFeature(\"Enhanced aggro system: real-time DPS aggro detection.\");\n         addFeature(\"Mobs now can drop more than one of the same equip.\");\n         addFeature(\"Mobs only drop items collectable by the player/party.\");\n         addFeature(\"Mobs shouldn't fall from foothold too often now.\");\n@@ -146,6 +148,7 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Added world maps for M. Castle, W. Tour & Ellin areas.\");\n         addFeature(\"Added W. Tour & Masteria continents in the world map.\");\n         addFeature(\"Reviewed several issues with W. Map tooltips & links.\");\n+        addFeature(\"Continent separated global drops.\");\n         addFeature(\"Giant Cake boss drops s. bags and Maple items.\");\n }\n "}, {"sha": "7f0f674aab29f8e6e38292a5770796086f5fa9a8", "filename": "scripts/portal/Zakum05.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/portal/Zakum05.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/portal/Zakum05.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Zakum05.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -24,7 +24,7 @@\n */\n  \n function enter(pi) {\n-    if (!pi.isQuestStarted(100200)) {\n+    if (!(pi.isQuestStarted(100200) || pi.isQuestCompleted(100200))) {\n         pi.getPlayer().dropMessage(5,\"You need approval from the masters to battle. You may not attempt the boss right now.\");\n         return false;\n     }"}, {"sha": "9af9d25a2f16fb49dbf95c754c4fe9aa65be5312", "filename": "scripts/quest/20101.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20101.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -27,6 +27,12 @@ function end(mode, type, selection) {\n             return;\n         }\n         \n+        if (!(qm.canHoldAll([1302077, 1142066]))) {\n+            qm.sendOk(\"Make some room in your inventory and talk back to me.\");\n+            qm.dispose();\n+            return;\n+        }\n+        \n     \tqm.sendNext(\"I have just molded your body to make it perfect for a Dawn Warrior. If you wish to become more powerful, use Stat Window (S) to raise the appropriate stats. If you aren't sure what to raise, just click on #bAuto#k.\");\n \tif (qm.getPlayer().getJob().getId() != 1100) {\n \t    qm.gainItem(1302077, 1);"}, {"sha": "cbdf5aee823d01fe0c3a1813c46718bf65373913", "filename": "scripts/quest/20102.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20102.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20102.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20102.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -27,6 +27,12 @@ function end(mode, type, selection) {\n             return;\n         }\n         \n+        if (!(qm.canHoldAll([1372043, 1142066]))) {\n+            qm.sendOk(\"Make some room in your inventory and talk back to me.\");\n+            qm.dispose();\n+            return;\n+        }\n+        \n     \tqm.sendNext(\"I have just molded your body to make it perfect for a Blaze Wizard. If you wish to become more powerful, use Stat Window (S) to raise the appropriate stats. If you aren't sure what to raise, just click on #bAuto#k.\");\n \tif (qm.getPlayer().getJob().getId() != 1200) {\n \t    qm.gainItem(1372043, 1);"}, {"sha": "9d603bf4299f35240bf9bb43c28c0ce8ab975de5", "filename": "scripts/quest/20103.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20103.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20103.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20103.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -27,6 +27,12 @@ function end(mode, type, selection) {\n             return;\n         }\n         \n+        if (!(qm.canHoldAll([1452051, 1142066]) && qm.canHold(2070000))) {\n+            qm.sendOk(\"Make some room in your inventory and talk back to me.\");\n+            qm.dispose();\n+            return;\n+        }\n+        \n     \tqm.sendNext(\"I have just molded your body to make it perfect for a Wind Archer. If you wish to become more powerful, use Stat Window (S) to raise the appropriate stats. If you aren't sure what to raise, just click on #bAuto#k.\");\n \tif (qm.getPlayer().getJob().getId() != 1300) {\n \t    qm.gainItem(2060000, 2000);"}, {"sha": "232a97ad5db2691f50e2735c49fd2b13ebdf7b29", "filename": "scripts/quest/20104.js", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20104.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20104.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20104.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -27,11 +27,16 @@ function end(mode, type, selection) {\n             return;\n         }\n         \n+        if (!(qm.canHoldAll([1472061, 1142066]) && qm.canHold(2070000))) {\n+            qm.sendOk(\"Make some room in your inventory and talk back to me.\");\n+            qm.dispose();\n+            return;\n+        }\n+        \n     \tqm.sendNext(\"I have just molded your body to make it perfect for a Night Walker. If you wish to become more powerful, use Stat Window (S) to raise the appropriate stats. If you aren't sure what to raise, just click on #bAuto#k.\");\n \tif (qm.getPlayer().getJob().getId() != 1400) {\n \t    qm.gainItem(1472061, 1);\n-\t    qm.gainItem(2070015, 800);\n-\t    qm.gainItem(2070015, 800);\n+\t    qm.gainItem(2070000, 800);\n \t    qm.gainItem(1142066, 1);\n \t    qm.changeJob(MapleJob.NIGHTWALKER1);\n \t    qm.getPlayer().resetStats();"}, {"sha": "6580c083c424d6ebae17cb91ebbb97e0f1728242", "filename": "scripts/quest/20105.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20105.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/20105.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/20105.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -27,6 +27,12 @@ function end(mode, type, selection) {\n             return;\n         }\n         \n+        if (!(qm.canHoldAll([1482014, 1142066]))) {\n+            qm.sendOk(\"Make some room in your inventory and talk back to me.\");\n+            qm.dispose();\n+            return;\n+        }\n+        \n     \tqm.sendNext(\"I have just molded your body to make it perfect for a Thunder Breaker. If you wish to become more powerful, use Stat Window (S) to raise the appropriate stats. If you aren't sure what to raise, just click on #bAuto#k.\");\n \tif (qm.getPlayer().getJob().getId() != 1500) {\n \t    qm.gainItem(1482014, 1);"}, {"sha": "e59c0bb9a6975e609dab3637ad4b06613b1b66e9", "filename": "scripts/quest/21101.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21101.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -39,7 +39,7 @@ function start(mode, type, selection) {\n     } else if (status == 1) {\n         if (qm.getPlayer().getJob().getId() == 2000) {\n             if(!qm.canHold(1142129)) {\n-                    cm.sendOk(\"Wow, your #bequip#k inventory is full. You need to make at least 1 empty slot to complete this quest.\");\n+                    qm.sendOk(\"Wow, your #bequip#k inventory is full. You need to make at least 1 empty slot to complete this quest.\");\n                     qm.dispose();\n                     return;\n             }"}, {"sha": "4d8f0f8d06d7aefcd30431623e0a47cc800d0c9c", "filename": "scripts/quest/21201.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21201.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -59,7 +59,7 @@ function end(mode, type, selection) {\n         else if (status == 8) {\n             if(!qm.isQuestCompleted(21201)) {\n                 if(!qm.canHold(1142130)) {\n-                    cm.sendOk(\"Wow, your #bequip#k inventory is full. I need you to make at least 1 empty slot to complete this quest.\");\n+                    qm.sendOk(\"Wow, your #bequip#k inventory is full. I need you to make at least 1 empty slot to complete this quest.\");   // thanks MedicOP for finding an issue here\n                     qm.dispose();\n                     return;\n                 }"}, {"sha": "35556f9587de79cfc7ce7117ac8f94ac73def5ff", "filename": "scripts/quest/21302.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21302.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/scripts/quest/21302.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21302.js?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -39,7 +39,7 @@ function end(mode, type, selection) {\n     } else if (status == 2) {\n         if(!qm.isQuestCompleted(21302)) {\n             if(!qm.canHold(1142131)) {\n-                cm.sendOk(\"Wow, your #bequip#k inventory is full. I need you to make at least 1 empty slot to complete this quest.\");\n+                qm.sendOk(\"Wow, your #bequip#k inventory is full. I need you to make at least 1 empty slot to complete this quest.\");\n                 qm.dispose();\n                 return;\n             }"}, {"sha": "aae28570c93d5f5c0f1cc046264fa7fda3e739a7", "filename": "sql/db_database.sql", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -12776,8 +12776,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n \n CREATE TABLE IF NOT EXISTS `drop_data_global` (\n   `id` bigint(20) NOT NULL AUTO_INCREMENT,\n-  `continent` int(11) NOT NULL,\n-  `dropType` tinyint(1) NOT NULL DEFAULT '0',\n+  `continent` tinyint(1) NOT NULL DEFAULT '-1',\n   `itemid` int(11) NOT NULL DEFAULT '0',\n   `minimum_quantity` int(11) NOT NULL DEFAULT '1',\n   `maximum_quantity` int(11) NOT NULL DEFAULT '1',\n@@ -12788,12 +12787,12 @@ CREATE TABLE IF NOT EXISTS `drop_data_global` (\n   KEY `mobid` (`continent`) USING BTREE\n ) ENGINE=InnoDB  DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC AUTO_INCREMENT=5 ;\n \n-INSERT INTO `drop_data_global` (`id`, `continent`, `dropType`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`, `comments`) VALUES\n-(1, 0, 0, 4031865, 1, 1, 0, 35000, 'NX Card 100 PTS'),\n-(2, 0, 0, 4031866, 1, 1, 0, 20000, 'NX Card 250 PTS'),\n-(3, 0, 0, 4001126, 1, 2, 0, 8000, 'Maple Leaves'),\n-(4, 0, 0, 2049100, 1, 1, 0, 1200, 'Chaos Scroll 60%'),\n-(5, 0, 0, 4001006, 1, 1, 0, 10000, 'Flaming Feather');\n+INSERT INTO `drop_data_global` (`id`, `continent`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`, `comments`) VALUES\n+(1, -1, 4031865, 1, 1, 0, 35000, 'NX Card 100 PTS'),\n+(2, -1, 4031866, 1, 1, 0, 20000, 'NX Card 250 PTS'),\n+(3, -1, 4001126, 1, 2, 0, 8000, 'Maple Leaves'),\n+(4, -1, 2049100, 1, 1, 0, 1200, 'Chaos Scroll 60%'),\n+(5, -1, 4001006, 1, 1, 0, 10000, 'Flaming Feather');\n \n CREATE TABLE IF NOT EXISTS `dueyitems` (\n   `id` int(10) unsigned NOT NULL AUTO_INCREMENT,"}, {"sha": "23e0864ebeed7b2505335dcd471917a2753e7d0c", "filename": "sql/db_drops.sql", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -6719,8 +6719,8 @@ USE `heavenms`;\n (4220000, 4010002, 1, 1, 0, 7000), \n (4220001, 4010002, 1, 1, 0, 7000),\n (9303014, 4010002, 1, 1, 0, 7000), \n-(4220000, 1442018, 1, 1, 0, 40000), \n-(4220001, 1442018, 1, 1, 0, 40000), \n+(4220000, 1442018, 1, 1, 0, 25000), \n+(4220001, 1442018, 1, 1, 0, 25000), \n (9303014, 1442018, 1, 1, 0, 700), \n (4220000, 1302010, 1, 1, 0, 40000), \n (4220001, 1302010, 1, 1, 0, 40000), "}, {"sha": "1c077d6024b88dee7d3f1446b8678d329d41bf0f", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 86, "deletions": 60, "changes": 146, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -273,7 +273,7 @@\n     private ScheduledFuture<?> pendantOfSpirit = null; //1122017\n     private Lock chrLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_CHR, true);\n     private Lock evtLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_EVT, true);\n-    private Lock petLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PET, true); // for meso & quest tasks as well\n+    private Lock petLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PET, true);\n     private Lock prtLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_PRT);\n     private Lock cpnLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.CHARACTER_CPN);\n     private Map<Integer, Set<Integer>> excluded = new LinkedHashMap<>();\n@@ -852,17 +852,7 @@ public void Hide(boolean hide, boolean login) {\n                 }\n                 List<Pair<MapleBuffStat, Integer>> ldsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n                 getMap().broadcastGMMessage(this, MaplePacketCreator.giveForeignBuff(id, ldsstat), false);\n-                for (MapleMonster mon : this.getControlledMonsters()) {\n-                    mon.lockMonster();\n-                    try {\n-                        mon.setController(null);\n-                        mon.setControllerHasAggro(false);\n-                        mon.setControllerKnowsAboutAggro(false);\n-                        mon.getMap().updateMonsterController(mon);\n-                    } finally {\n-                        mon.unlockMonster();\n-                    }\n-                }\n+                this.releaseControlledMonsters();\n             }\n             announce(MaplePacketCreator.enableActions());\n         }\n@@ -1356,7 +1346,8 @@ public void forceChangeMap(final MapleMap target, final MaplePortal pto) {\n                 }\n             }\n             \n-            mapEim.registerPlayer(this);\n+            // thanks Thora for finding an issue with players not being actually warped into the target event map (rather sent to the event starting map)\n+            mapEim.registerPlayer(this, false);\n         }\n         \n         MapleMap to = target; // warps directly to the target intead of the target's map id, this allows GMs to patrol players inside instances.\n@@ -1708,29 +1699,48 @@ public void checkMessenger() {\n         }\n     }\n \n-    public void checkMonsterAggro(MapleMonster monster) {\n-        monster.lockMonster();\n-        try {\n-            if (!monster.isControllerHasAggro()) {\n-                if (monster.getController() == this) {\n-                    monster.setControllerHasAggro(true);\n-                } else {\n-                    monster.switchController(this, true);\n-                }\n+    public void controlMonster(MapleMonster monster) {\n+        if (cpnLock.tryLock()) {\n+            try {\n+                controlled.add(monster);\n+            } finally {\n+                cpnLock.unlock();\n             }\n+        }\n+    }\n+    \n+    public void stopControllingMonster(MapleMonster monster) {\n+        if (cpnLock.tryLock()) {\n+            try {\n+                controlled.remove(monster);\n+            } finally {\n+                cpnLock.unlock();\n+            }\n+        }\n+    }\n+    \n+    public int getNumControlledMonsters() {\n+        cpnLock.lock();\n+        try {\n+            return controlled.size();\n         } finally {\n-            monster.unlockMonster();\n+            cpnLock.unlock();\n         }\n     }\n-\n-    public void controlMonster(MapleMonster monster, boolean aggro) {\n-        monster.lockMonster();\n+    \n+    public void releaseControlledMonsters() {\n+        Collection<MapleMonster> controlledMonsters;\n+        \n+        cpnLock.lock();\n         try {\n-            monster.setController(this);\n-            controlled.add(monster);\n-            client.announce(MaplePacketCreator.controlMonster(monster, false, aggro));\n+            controlledMonsters = new ArrayList<>(controlled);\n+            controlled.clear();\n         } finally {\n-            monster.unlockMonster();\n+            cpnLock.unlock();\n+        }\n+        \n+        for (MapleMonster monster : controlledMonsters) {\n+            monster.aggroRedirectController();\n         }\n     }\n     \n@@ -2967,6 +2977,11 @@ public boolean gainFame(int delta, MapleCharacter fromPlayer, int mode) {\n         }\n     }\n     \n+    public boolean canHoldMeso(int gain) {  // thanks lucasziron found pointing out a need to check space availability for mesos on player transactions\n+        long nextMeso = (long) meso.get() + gain;\n+        return nextMeso <= Integer.MAX_VALUE;\n+    }\n+    \n     public void gainMeso(int gain) {\n         gainMeso(gain, true, false, true);\n     }\n@@ -4124,11 +4139,7 @@ public MapleClient getClient() {\n             return Collections.unmodifiableList(ret);\n         }\n     }\n-\n-    public Collection<MapleMonster> getControlledMonsters() {\n-        return Collections.unmodifiableCollection(controlled);\n-    }\n-\n+    \n     public List<MapleRing> getCrushRings() {\n         Collections.sort(crushRings);\n         return crushRings;\n@@ -4343,7 +4354,15 @@ public int getGachaExp() {\n         return gachaexp.get();\n     }\n \n+    public boolean hasNoviceExpRate() {\n+        return ServerConstants.USE_ENFORCE_NOVICE_EXPRATE && isBeginnerJob() && level < 11;\n+    }\n+    \n     public int getExpRate() {\n+        if (hasNoviceExpRate()) {   // base exp rate 1x for early levels idea thanks to Vcoc\n+            return 1;\n+        }\n+        \n         return expRate;\n     }\n     \n@@ -4383,7 +4402,17 @@ public int getCouponMesoRate() {\n     public int getRawMesoRate() {\n         return mesoRate / (mesoCoupon * getWorldServer().getMesoRate());\n     }\n-\n+    \n+    public int getQuestExpRate() {\n+        World w = getWorldServer();\n+        return w.getExpRate() * w.getQuestRate();\n+    }\n+    \n+    public int getQuestMesoRate() {\n+        World w = getWorldServer();\n+        return w.getMesoRate() * w.getQuestRate();\n+    }\n+    \n     public int getFace() {\n         return face;\n     }\n@@ -4829,10 +4858,6 @@ public int getNoPets() {\n         }\n     }\n \n-    public int getNumControlledMonsters() {\n-        return controlled.size();\n-    }\n-\n     public MapleParty getParty() {\n         prtLock.lock();\n         try {\n@@ -5635,9 +5660,9 @@ public boolean isPartyLeader() {\n     public boolean isGuildLeader() {    // true on guild master or jr. master\n         return guildid > 0 && guildRank < 3;\n     }\n-\n+    \n     public void leaveMap() {\n-        controlled.clear();\n+        releaseControlledMonsters();\n         visibleMapObjects.clear();\n         setChair(0);\n         if (hpDecreaseTask != null) {\n@@ -7772,17 +7797,22 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n                 throw new RuntimeException(\"Character not in database (\" + id + \")\");\n             }\n             \n+            List<MaplePet> petList = new LinkedList<>();\n             petLock.lock();\n             try {\n                 for (int i = 0; i < 3; i++) {\n                     if (pets[i] != null) {\n-                        pets[i].saveToDb();\n+                        petList.add(pets[i]);\n                     }\n                 }\n             } finally {\n                 petLock.unlock();\n             }\n             \n+            for (MaplePet pet : petList) {\n+                pet.saveToDb();\n+            }\n+            \n             for(Entry<Integer, Set<Integer>> es: getExcluded().entrySet()) {    // this set is already protected\n                 try (PreparedStatement ps2 = con.prepareStatement(\"DELETE FROM petignores WHERE petid=?\")) {\n                     ps2.setInt(1, es.getKey());\n@@ -8912,11 +8942,7 @@ public void run() {\n             }\n         }, duration);\n     }\n-\n-    public void stopControllingMonster(MapleMonster monster) {\n-        controlled.remove(monster);\n-    }\n-\n+    \n     public void unequipAllPets() {\n         for (int i = 0; i < 3; i++) {\n             MaplePet pet = getPet(i);\n@@ -9046,32 +9072,32 @@ private void expireQuest(MapleQuest quest) {\n     }\n     \n     public void cancelQuestExpirationTask() {\n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             if (questExpireTask != null) {\n                 questExpireTask.cancel(false);\n                 questExpireTask = null;\n             }\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n     }\n     \n     public void forfeitExpirableQuests() {\n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             for(MapleQuest quest : questExpirations.keySet()) {\n                 quest.forfeit(this);\n             }\n             \n             questExpirations.clear();\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n     }\n     \n     public void questExpirationTask() {\n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             if(!questExpirations.isEmpty()) {\n                 if(questExpireTask == null) {\n@@ -9084,12 +9110,12 @@ public void run() {\n                 }\n             }\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n     }\n     \n     private void runQuestExpireTask() {\n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             long timeNow = Server.getInstance().getCurrentTime();\n             List<MapleQuest> expireList = new LinkedList<>();\n@@ -9110,12 +9136,12 @@ private void runQuestExpireTask() {\n                 }\n             }\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n     }\n     \n     private void registerQuestExpire(MapleQuest quest, long time) {\n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             if(questExpireTask == null) {\n                 questExpireTask = TimerManager.getInstance().register(new Runnable() {\n@@ -9128,7 +9154,7 @@ public void run() {\n             \n             questExpirations.put(quest, Server.getInstance().getCurrentTime() + time);\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n     }\n     \n@@ -9671,7 +9697,7 @@ public final void empty(final boolean remove) {\n         if (pendantOfSpirit != null) { pendantOfSpirit.cancel(true); }\n         pendantOfSpirit = null;\n         \n-        petLock.lock();\n+        evtLock.lock();\n         try {\n             if (questExpireTask != null) {\n                 questExpireTask.cancel(false);\n@@ -9681,7 +9707,7 @@ public final void empty(final boolean remove) {\n                 questExpirations = null;\n             }\n         } finally {\n-            petLock.unlock();\n+            evtLock.unlock();\n         }\n         \n         if (maplemount != null) {"}, {"sha": "4e5acbe13517d8eaad9afed0b627b901d75cab23", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -175,22 +175,22 @@ public void sendCharList(int server) {\n \t\treturn chars;\n \t}\n \n-\tpublic List<String> loadCharacterNames(int serverId) {\n+\tpublic List<String> loadCharacterNames(int worldId) {\n \t\tList<String> chars = new ArrayList<>(15);\n-\t\tfor (CharNameAndId cni : loadCharactersInternal(serverId)) {\n+\t\tfor (CharNameAndId cni : loadCharactersInternal(worldId)) {\n \t\t\tchars.add(cni.name);\n \t\t}\n \t\treturn chars;\n \t}\n \n-\tprivate List<CharNameAndId> loadCharactersInternal(int serverId) {\n+\tprivate List<CharNameAndId> loadCharactersInternal(int worldId) {\n \t\tPreparedStatement ps;\n \t\tList<CharNameAndId> chars = new ArrayList<>(15);\n \t\ttry {\n                         Connection con = DatabaseConnection.getConnection();\n \t\t\tps = con.prepareStatement(\"SELECT id, name FROM characters WHERE accountid = ? AND world = ?\");\n \t\t\tps.setInt(1, this.getAccID());\n-\t\t\tps.setInt(2, serverId);\n+\t\t\tps.setInt(2, worldId);\n \t\t\ttry (ResultSet rs = ps.executeQuery()) {\n \t\t\t\twhile (rs.next()) {\n \t\t\t\t\tchars.add(new CharNameAndId(rs.getString(\"name\"), rs.getInt(\"id\")));\n@@ -882,7 +882,7 @@ private void removePlayer(World wserv, boolean serverTransition) {\n \t}\n \n         public final void disconnect(final boolean shutdown, final boolean cashshop) {\n-                if (isDisconnecting()) {\n+                if (canDisconnect()) {\n                         ThreadManager.getInstance().newTask(new Runnable() {\n                                 @Override\n                                 public void run() {\n@@ -893,12 +893,12 @@ public void run() {\n         }\n         \n         public final void forceDisconnect() {\n-                if (isDisconnecting()) {\n+                if (canDisconnect()) {\n                         disconnectInternal(true, false);\n                 }\n         }\n         \n-        private synchronized boolean isDisconnecting() {\n+        private synchronized boolean canDisconnect() {\n                 if (disconnecting) {\n \t\t\treturn false;\n \t\t}"}, {"sha": "378923e63276d9332162c03de8ea025e4a470643", "filename": "src/client/command/commands/gm0/RatesCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm0/RatesCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm0/RatesCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/RatesCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -39,7 +39,7 @@ public void execute(MapleClient c, String[] params) {\n         \n         // travel rates not applicable since it's intrinsically a server/environment rate rather than a character rate\n         String showMsg_ = \"#eCHARACTER RATES#n\" + \"\\r\\n\\r\\n\";\n-        showMsg_ += \"EXP Rate: #e#b\" + player.getExpRate() + \"x#k#n\" + \"\\r\\n\";\n+        showMsg_ += \"EXP Rate: #e#b\" + player.getExpRate() + \"x#k#n\" + (player.hasNoviceExpRate() ? \" - novice rate\" : \"\") + \"\\r\\n\";\n         showMsg_ += \"MESO Rate: #e#b\" + player.getMesoRate() + \"x#k#n\" + \"\\r\\n\";\n         showMsg_ += \"DROP Rate: #e#b\" + player.getDropRate() + \"x#k#n\" + \"\\r\\n\";\n         showMsg_ += \"BOSS DROP Rate: #e#b\" + player.getBossDropRate() + \"x#k#n\" + \"\\r\\n\";"}, {"sha": "0db9088efdfd256e9f468a043612394cd4537073", "filename": "src/client/command/commands/gm0/ShowRatesCommand.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm0/ShowRatesCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm0/ShowRatesCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/ShowRatesCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -40,7 +40,7 @@ public void execute(MapleClient c, String[] params) {\n         showMsg += \"World EXP Rate: #k\" + c.getWorldServer().getExpRate() + \"x#k\" + \"\\r\\n\";\n         showMsg += \"Player EXP Rate: #k\" + player.getRawExpRate() + \"x#k\" + \"\\r\\n\";\n         if(player.getCouponExpRate() != 1) showMsg += \"Coupon EXP Rate: #k\" + player.getCouponExpRate() + \"x#k\" + \"\\r\\n\";\n-        showMsg += \"EXP Rate: #e#b\" + player.getExpRate() + \"x#k#n\" + \"\\r\\n\";\n+        showMsg += \"EXP Rate: #e#b\" + player.getExpRate() + \"x#k#n\" + (player.hasNoviceExpRate() ? \" - novice rate\" : \"\") + \"\\r\\n\";\n \n         showMsg += \"\\r\\n\" + \"#eMESO RATE#n\" + \"\\r\\n\";\n         showMsg += \"World MESO Rate: #k\" + c.getWorldServer().getMesoRate() + \"x#k\" + \"\\r\\n\";\n@@ -66,7 +66,7 @@ public void execute(MapleClient c, String[] params) {\n         }\n         \n         showMsg += \"\\r\\n\";\n-        showMsg += \"World TRAVEL Rate: #e#b\" + c.getWorldServer().getTravelRate() + \"x#k#n\" + \"\\r\\nServer\\r\\nPlayer\";\n+        showMsg += \"World TRAVEL Rate: #e#b\" + c.getWorldServer().getTravelRate() + \"x#k#n\" + \"\\r\\n\";\n \n         player.showHint(showMsg, 300);\n     }"}, {"sha": "3e1a816449dc5067cffb9a944d16be6c1d9f5f89", "filename": "src/client/command/commands/gm1/GotoCommand.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm1/GotoCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm1/GotoCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm1/GotoCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -41,8 +41,6 @@\n \n     @Override\n     public void execute(MapleClient c, String[] params) {\n-        final HashMap<String, Integer> gotomaps = GameConstants.GOTO_MAPS;\n-\n         MapleCharacter player = c.getPlayer();\n         if (params.length < 1){\n             player.yellowMessage(\"Syntax: @goto <map name>\");\n@@ -54,6 +52,13 @@ public void execute(MapleClient c, String[] params) {\n             return;\n         }\n \n+        HashMap<String, Integer> gotomaps;\n+        if (player.isGM()) {\n+            gotomaps = new HashMap<>(GameConstants.GOTO_AREAS);     // distinct map registry for GM/users suggested thanks to Vcoc\n+        } else {\n+            gotomaps = new HashMap<>(GameConstants.GOTO_TOWNS);\n+        }\n+        \n         if (gotomaps.containsKey(params[0])) {\n             MapleMap target = c.getChannelServer().getMapFactory().getMap(gotomaps.get(params[0]));\n             "}, {"sha": "1e413b392ee63be5c78f92004c803cd8eea595ed", "filename": "src/client/command/commands/gm2/SummonCommand.java", "status": "modified", "additions": 15, "deletions": 21, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/SummonCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/SummonCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/SummonCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -26,6 +26,7 @@\n import client.command.Command;\n import client.MapleClient;\n import client.MapleCharacter;\n+import server.maps.MapleMap;\n import net.server.Server;\n import net.server.channel.Channel;\n \n@@ -54,33 +55,26 @@ public void execute(MapleClient c, String[] params) {\n             }\n         }\n         if (victim != null) {\n-            boolean changingEvent = true;\n-\n-            if (victim.getEventInstance() != null) {\n-                if (player.getEventInstance() != null && victim.getEventInstance().getLeaderId() == player.getEventInstance().getLeaderId()) {\n-                    changingEvent = false;\n-                } else {\n-                    victim.getEventInstance().unregisterPlayer(victim);\n-                }\n+            if (!victim.isLoggedinWorld()) {\n+                player.dropMessage(6, \"Player currently not logged in or unreachable.\");\n+                return;\n             }\n             \n-            //Attempt to join the warpers instance.\n-            if (player.getEventInstance() != null && changingEvent) {\n-                if (player.getClient().getChannel() == victim.getClient().getChannel()) {\n-                    player.getEventInstance().registerPlayer(victim);\n-                    victim.saveLocationOnWarp();\n-                    victim.changeMap(player.getEventInstance().getMapInstance(player.getMapId()), player.getMap().findClosestPortal(player.getPosition()));\n-                } else {\n-                    player.dropMessage(\"Target isn't on your channel, not able to warp into event instance.\");\n-                }\n-            } else {//If victim isn't in an event instance or is in the same event instance as the one the caller is, just warp them.\n-                victim.saveLocationOnWarp();\n-                victim.changeMap(player.getMapId(), player.getMap().findClosestPortal(player.getPosition()));\n-            }\n             if (player.getClient().getChannel() != victim.getClient().getChannel()) {//And then change channel if needed.\n                 victim.dropMessage(\"Changing channel, please wait a moment.\");\n                 victim.getClient().changeChannel(player.getClient().getChannel());\n             }\n+            \n+            try {\n+                for (int i = 0; i < 7; i++) {   // poll for a while until the player reconnects\n+                    if (victim.isLoggedinWorld()) break;\n+                    Thread.sleep(1777);\n+                }\n+            } catch (InterruptedException e) {}\n+            \n+            MapleMap map = player.getMap();\n+            victim.saveLocationOnWarp();\n+            victim.forceChangeMap(map, map.findClosestPortal(player.getPosition()));\n         } else {\n             player.dropMessage(6, \"Unknown player.\");\n         }"}, {"sha": "1ec42d97b8379df7201d4a896382bcaad994e816", "filename": "src/client/command/commands/gm2/WarpAreaCommand.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/WarpAreaCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/WarpAreaCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/WarpAreaCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -29,7 +29,6 @@\n import server.maps.MapleMap;\n \n import java.awt.*;\n-import java.util.ArrayList;\n import java.util.Collection;\n \n public class WarpAreaCommand extends Command {\n@@ -54,7 +53,7 @@ public void execute(MapleClient c, String[] params) {\n \n             Point pos = player.getPosition();\n \n-            Collection<MapleCharacter> characters = new ArrayList<>(player.getMap().getCharacters());\n+            Collection<MapleCharacter> characters = player.getMap().getAllPlayers();\n             \n             for (MapleCharacter victim : characters) {\n                 if (victim.getPosition().distanceSq(pos) <= 50000) {"}, {"sha": "d4d1760ae99f2bd097ad37f8ea586865694b9f8b", "filename": "src/client/command/commands/gm2/WarpMapCommand.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/WarpMapCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm2/WarpMapCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/WarpMapCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -28,7 +28,6 @@\n import client.command.Command;\n import server.maps.MapleMap;\n \n-import java.util.ArrayList;\n import java.util.Collection;\n \n public class WarpMapCommand extends Command {\n@@ -51,7 +50,7 @@ public void execute(MapleClient c, String[] params) {\n                 return;\n             }\n \n-            Collection<MapleCharacter> characters = new ArrayList<>(player.getMap().getCharacters());\n+            Collection<MapleCharacter> characters = player.getMap().getAllPlayers();\n             \n             for (MapleCharacter victim : characters) {\n                 victim.saveLocationOnWarp();"}, {"sha": "f01e12f38e50c01c595f7c4020c638aad3e75df5", "filename": "src/client/command/commands/gm3/ExpedsCommand.java", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/ExpedsCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/ExpedsCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/ExpedsCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -30,6 +30,8 @@\n import net.server.channel.Channel;\n import server.expeditions.MapleExpedition;\n \n+import java.util.Map.Entry;\n+\n public class ExpedsCommand extends Command {\n     {\n         setDescription(\"\");\n@@ -53,11 +55,11 @@ public void execute(MapleClient c, String[] params) {\n                 player.yellowMessage(\">> Size: \" + exped.getMembers().size());\n                 player.yellowMessage(\">> Leader: \" + exped.getLeader().getName());\n                 int memId = 2;\n-                for (MapleCharacter member : exped.getMembers()) {\n-                    if (exped.isLeader(member)) {\n+                for (Entry<Integer, String> e : exped.getMembers().entrySet()) {\n+                    if (exped.isLeader(e.getKey())) {\n                         continue;\n                     }\n-                    player.yellowMessage(\">>> Member \" + memId + \": \" + member.getName());\n+                    player.yellowMessage(\">>> Member \" + memId + \": \" + e.getValue());\n                     memId++;\n                 }\n             }"}, {"sha": "589eab85d6cffaf9f1d8865bf2c3c0443a2b0a98", "filename": "src/client/command/commands/gm3/ReloadMapCommand.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/ReloadMapCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/ReloadMapCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/ReloadMapCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -28,7 +28,6 @@\n import client.MapleCharacter;\n import server.maps.MapleMap;\n \n-import java.util.ArrayList;\n import java.util.Collection;\n \n public class ReloadMapCommand extends Command {\n@@ -42,7 +41,7 @@ public void execute(MapleClient c, String[] params) {\n         MapleMap newMap = c.getChannelServer().getMapFactory().resetMap(player.getMapId());\n         int callerid = c.getPlayer().getId();\n \n-        Collection<MapleCharacter> characters = new ArrayList<>(player.getMap().getCharacters());\n+        Collection<MapleCharacter> characters = player.getMap().getAllPlayers();\n         \n         for (MapleCharacter chr : characters) {\n             chr.saveLocationOnWarp();"}, {"sha": "afa0945df178c6a5684cb314a914b08ef9903eaf", "filename": "src/client/command/commands/gm3/WarpSnowBallCommand.java", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/WarpSnowBallCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm3/WarpSnowBallCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/WarpSnowBallCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -23,12 +23,11 @@\n */\n package client.command.commands.gm3;\n \n-        import client.command.Command;\n-        import client.MapleClient;\n-        import client.MapleCharacter;\n+import client.command.Command;\n+import client.MapleClient;\n+import client.MapleCharacter;\n \n-        import java.util.ArrayList;\n-        import java.util.List;\n+import java.util.List;\n \n public class WarpSnowBallCommand extends Command {\n     {\n@@ -38,7 +37,7 @@\n     @Override\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n-        List<MapleCharacter> chars = new ArrayList<>(player.getMap().getCharacters());\n+        List<MapleCharacter> chars = player.getMap().getAllPlayers();\n         for (MapleCharacter chr : chars) {\n             chr.saveLocationOnWarp();\n             chr.changeMap(109060000, chr.getTeam());"}, {"sha": "7346f522cbb336a383a3cc7ec7552d3afe3be7ec", "filename": "src/client/command/commands/gm5/DebugCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm5/DebugCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/command/commands/gm5/DebugCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm5/DebugCommand.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -72,7 +72,7 @@ public void execute(MapleClient c, String[] params) {\n                 for (MapleMapObject monstermo : monsters) {\n                     MapleMonster monster = (MapleMonster) monstermo;\n                     MapleCharacter controller = monster.getController();\n-                    player.message(\"Monster ID: \" + monster.getId() + \" Aggro target: \" + ((controller != null) ? controller.getName() : \"<none>\"));\n+                    player.message(\"Monster ID: \" + monster.getId() + \" Aggro target: \" + ((controller != null) ? controller.getName() + \" Has aggro: \" + monster.isControllerHasAggro() + \" Knowns aggro: \" + monster.isControllerKnowsAboutAggro() : \"<none>\"));\n                 }\n                 break;\n "}, {"sha": "74ca97932e179b1322429e3bde55f688dd1f6882", "filename": "src/client/inventory/Item.java", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/inventory/Item.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/inventory/Item.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Item.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -56,8 +56,13 @@ public Item(int id, short position, short quantity, int petid) {\n         this.id = id;\n         this.position = position;\n         this.quantity = quantity;\n+        if (petid > -1) {   // issue with null \"pet\" having petid > -1 found thanks to MedicOP\n+            this.pet = MaplePet.loadFromDb(id, position, petid);\n+            if (this.pet == null) {\n+                petid = -1;\n+            }\n+        }\n         this.petid = petid;\n-        if (petid > -1) this.pet = MaplePet.loadFromDb(id, position, petid);\n         this.flag = 0;\n         this.log = new LinkedList<>();\n     }\n@@ -121,10 +126,6 @@ public void setOwner(String owner) {\n     public int getPetId() {\n         return petid;\n     }\n-\n-    public void setPetId(int id) {\n-        this.petid = id;\n-    }\n  \n     @Override\n     public int compareTo(Item other) {"}, {"sha": "fd9e2d8aa674caa3ece83914f18f1a4fa017a275", "filename": "src/client/processor/AssignAPProcessor.java", "status": "modified", "additions": 64, "deletions": 50, "changes": 114, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/AssignAPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/AssignAPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/AssignAPProcessor.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -134,10 +134,10 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                         luk = scStat;\n                         str = 0; dex = 0;\n \n-                        if(luk + chr.getLuk() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && luk + chr.getLuk() > CAP) {\n                             temp = luk + chr.getLuk() - CAP;\n-                            luk -= temp;\n-                            int_ += temp;\n+                            scStat -= temp;\n+                            prStat += temp;\n                         }\n \n                         primary = MapleStat.INT;\n@@ -160,10 +160,10 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                         str = scStat;\n                         int_ = 0; luk = 0;\n \n-                        if(str + chr.getStr() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && str + chr.getStr() > CAP) {\n                             temp = str + chr.getStr() - CAP;\n-                            str -= temp;\n-                            dex += temp;\n+                            scStat -= temp;\n+                            prStat += temp;\n                         }\n \n                         primary = MapleStat.DEX;\n@@ -186,10 +186,10 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                         str = scStat;\n                         int_ = 0; luk = 0;\n \n-                        if(str + chr.getStr() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && str + chr.getStr() > CAP) {\n                             temp = str + chr.getStr() - CAP;\n-                            str -= temp;\n-                            dex += temp;\n+                            scStat -= temp;\n+                            prStat += temp;\n                         }\n \n                         primary = MapleStat.DEX;\n@@ -240,15 +240,15 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                         str = trStat;\n                         int_ = 0;\n \n-                        if(dex + chr.getDex() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && dex + chr.getDex() > CAP) {\n                             temp = dex + chr.getDex() - CAP;\n-                            dex -= temp;\n-                            luk += temp;\n+                            scStat -= temp;\n+                            prStat += temp;\n                         }\n-                        if(str + chr.getStr() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && str + chr.getStr() > CAP) {\n                             temp = str + chr.getStr() - CAP;\n-                            str -= temp;\n-                            luk += temp;\n+                            trStat -= temp;\n+                            prStat += temp;\n                         }\n \n                         primary = MapleStat.LUK;\n@@ -258,50 +258,64 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                         break;\n \n                     case BRAWLER:\n-                        CAP = 120;\n-\n-                        scStat = chr.getLevel() - (chr.getDex() + dex - eqpDex);\n-                        if(scStat < 0) scStat = 0;\n-                        scStat = Math.min(scStat, tempAp);\n-\n-                        if(tempAp > scStat) tempAp -= scStat;\n-                        else tempAp = 0;\n-\n-                        prStat = tempAp;\n-                        str = prStat;\n-                        dex = scStat;\n-                        int_ = 0; luk = 0;\n-\n-                        if(dex + chr.getDex() > CAP) {\n-                            temp = dex + chr.getDex() - CAP;\n-                            dex -= temp;\n-                            str += temp;\n-                        }\n-\n-                        primary = MapleStat.STR;\n-                        secondary = MapleStat.DEX;\n-\n-                        break;\n-\n                     default:    //warrior, beginner, ...\n-                        CAP = 80;\n-\n-                        scStat = ((2 * chr.getLevel()) / 3) - (chr.getDex() + dex - eqpDex);\n-                        if(scStat < 0) scStat = 0;\n-                        scStat = Math.min(scStat, tempAp);\n+                        CAP = 300;\n+                        \n+                        boolean highDex = false;    // thanks lucasziron & Vcoc for finding out DEX autoassigning poorly for STR-based characters\n+                        if (chr.getLevel() < 40) {\n+                            if (chr.getDex() >= (2 * chr.getLevel()) + 2) {\n+                                highDex = true;\n+                            }\n+                        } else {\n+                            if (chr.getDex() >= chr.getLevel() + 42) {\n+                                highDex = true;\n+                            }\n+                        }\n+                        \n+                        // other classes will start favoring more DEX only if a level-based threshold is reached.\n+                        if(!highDex) {\n+                            scStat = 0;\n+                            if(chr.getDex() < 80) {\n+                                scStat = (2 * chr.getLevel()) - (chr.getDex() + dex - eqpDex);\n+                                if(scStat < 0) scStat = 0;\n+\n+                                scStat = Math.min(80 - chr.getDex(), scStat);\n+                                scStat = Math.min(tempAp, scStat);\n+                                tempAp -= scStat;\n+                            }\n \n-                        if(tempAp > scStat) tempAp -= scStat;\n-                        else tempAp = 0;\n+                            temp = (chr.getLevel() + 40) - Math.max(80, scStat + chr.getDex() + dex - eqpDex);\n+                            if(temp < 0) temp = 0;\n+                            temp = Math.min(tempAp, temp);\n+                            scStat += temp;\n+                            tempAp -= temp;\n+                        } else {\n+                            scStat = 0;\n+                            if(chr.getDex() < 96) {\n+                                scStat = (int)(2.4 * chr.getLevel()) - (chr.getDex() + dex - eqpDex);\n+                                if(scStat < 0) scStat = 0;\n+\n+                                scStat = Math.min(96 - chr.getDex(), scStat);\n+                                scStat = Math.min(tempAp, scStat);\n+                                tempAp -= scStat;\n+                            }\n \n+                            temp = 96 + (int)(1.2 * (chr.getLevel() - 40)) - Math.max(96, scStat + chr.getDex() + dex - eqpDex);\n+                            if(temp < 0) temp = 0;\n+                            temp = Math.min(tempAp, temp);\n+                            scStat += temp;\n+                            tempAp -= temp;\n+                        }\n+                        \n                         prStat = tempAp;\n                         str = prStat;\n                         dex = scStat;\n                         int_ = 0; luk = 0;\n \n-                        if(dex + chr.getDex() > CAP) {\n+                        if(ServerConstants.USE_AUTOASSIGN_SECONDARY_CAP && dex + chr.getDex() > CAP) {\n                             temp = dex + chr.getDex() - CAP;\n-                            dex -= temp;\n-                            str += temp;\n+                            scStat -= temp;\n+                            prStat += temp;\n                         }\n \n                         primary = MapleStat.STR;"}, {"sha": "d4a8cc6674ec493c99102eacbc132ee1ce55994e", "filename": "src/client/processor/DueyProcessor.java", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/DueyProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/DueyProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/DueyProcessor.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -469,6 +469,11 @@ public static void dueyClaimPackage(MapleClient c, int packageid) {\n                     }\n \n                     if (dp.getItem() != null) {\n+                        if (!c.getPlayer().canHoldMeso(dp.getMesos())) {\n+                            c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_UNKNOWN_ERROR.getCode()));\n+                            return;\n+                        }\n+                        \n                         if (!MapleInventoryManipulator.checkSpace(c, dp.getItem().getItemId(), dp.getItem().getQuantity(), dp.getItem().getOwner())) {\n                             int itemid = dp.getItem().getItemId();\n                             if(MapleItemInformationProvider.getInstance().isPickupRestricted(itemid) && c.getPlayer().getInventory(ItemConstants.getInventoryType(itemid)).findById(itemid) != null) {\n@@ -483,17 +488,7 @@ public static void dueyClaimPackage(MapleClient c, int packageid) {\n                         }\n                     }\n \n-                    long gainmesos;\n-                    long totalmesos = (long) dp.getMesos() + c.getPlayer().getMeso();\n-\n-                    if (totalmesos < 0 || dp.getMesos() < 0) {\n-                        gainmesos = 0;\n-                    } else {\n-                        totalmesos = Math.min(totalmesos, Integer.MAX_VALUE);\n-                        gainmesos = totalmesos - c.getPlayer().getMeso();\n-                    }\n-\n-                    c.getPlayer().gainMeso((int)gainmesos, false);\n+                    c.getPlayer().gainMeso(dp.getMesos(), false);\n \n                     removeItemFromDB(packageid);\n                     c.announce(MaplePacketCreator.removeItemFromDuey(false, packageid));"}, {"sha": "49311315a09849ab1f3498da22b306feb55971c3", "filename": "src/client/processor/FredrickProcessor.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/FredrickProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/client/processor/FredrickProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/FredrickProcessor.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -47,7 +47,7 @@\n  */\n public class FredrickProcessor {\n     private static boolean canRetrieveFromFredrick(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items) {\n-        if (chr.getMeso() + chr.getMerchantMeso() < 0) {\n+        if (!chr.canHoldMeso(chr.getMerchantMeso())) {\n             return false;\n         }\n         return MapleInventory.checkSpotsAndOwnership(chr, items);"}, {"sha": "d8cfc98e9f466d4d4ea5f39bc2a259b3f34e98c6", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 21, "deletions": 15, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -45,9 +45,8 @@ public static int getPlayerBonusExpRate(int slot) {\n         return(EXP_RATE_GAIN[slot]);\n     }\n     \n-    // used by the \"goto\" command\n-    public static final HashMap<String, Integer> GOTO_MAPS = new HashMap<String, Integer>() {{\n-        put(\"gmmap\", 180000000);\n+    // used by the \"goto\" command for players\n+    public static final HashMap<String, Integer> GOTO_TOWNS = new HashMap<String, Integer>() {{\n         put(\"southperry\", 60000);\n         put(\"amherst\", 1000000);\n         put(\"henesys\", 100000000);\n@@ -72,6 +71,25 @@ public static int getPlayerBonusExpRate(int slot) {\n         put(\"korean\", 222000000);\n         put(\"ellin\", 300000000);\n         put(\"nlc\", 600000000);\n+        put(\"showa\", 801000000);\n+        put(\"shrine\", 800000000);\n+        put(\"ariant\", 260000000);\n+        put(\"magatia\", 261000000);\n+        put(\"singapore\", 540000000);\n+        put(\"quay\", 541000000);\n+        put(\"kampung\", 551000000);\n+        put(\"amoria\", 680000000);\n+        put(\"temple\", 270000100);\n+        put(\"square\", 103040000);\n+        put(\"neo\", 240070000);\n+        put(\"mushking\", 106020000);\n+    }};\n+    \n+    // used by the \"goto\" command for only-GMs\n+    public static final HashMap<String, Integer> GOTO_AREAS = new HashMap<String, Integer>() {{\n+        putAll(GOTO_TOWNS);\n+        \n+        put(\"gmmap\", 180000000);\n         put(\"excavation\", 990000000);\n         put(\"mushmom\", 100000005);\n         put(\"griffey\", 240020101);\n@@ -80,25 +98,13 @@ public static int getPlayerBonusExpRate(int slot) {\n         put(\"balrog\", 105090900);\n         put(\"zakum\", 211042300);\n         put(\"papu\", 220080001);\n-        put(\"showa\", 801000000);\n         put(\"guild\", 200000301);\n-        put(\"shrine\", 800000000);\n         put(\"skelegon\", 240040511);\n         put(\"hpq\", 100000200);\n         put(\"pianus\", 230040420);\n         put(\"horntail\", 240050400);\n         put(\"pinkbean\", 270050000);\n-        put(\"ariant\", 260000000);\n-        put(\"magatia\", 261000000);\n-        put(\"singapore\", 540000000);\n-        put(\"quay\", 541000000);\n-        put(\"kampung\", 551000000);\n         put(\"keep\", 610020006);\n-        put(\"amoria\", 680000000);\n-        put(\"temple\", 270000100);\n-        put(\"square\", 103040000);\n-        put(\"neo\", 240070000);\n-        put(\"mushking\", 106020000);\n         put(\"dojo\", 925020001);\n         put(\"bosspq\", 970030000);\n         put(\"fm\", 910000000);"}, {"sha": "90217e1d8ab065cb3ed1f17162227fba78fc033c", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -76,13 +76,15 @@\n     public static final boolean USE_ITEM_SORT_BY_NAME = false;      //Item sorting based on name rather than id.\n     public static final boolean USE_PARTY_SEARCH = false;\n     public static final boolean USE_PARTY_FOR_STARTERS = true;      //Players level 10 or below can create/invite other players on the given level range.\n-    public static final boolean USE_AUTOASSIGN_STARTERS_AP = false; //Beginners level 10 or below have their AP autoassigned (they can't choose to levelup a stat). Set true if the localhost doesn't support AP assigning for beginners level 10 or below.\n+    public static final boolean USE_AUTOASSIGN_STARTERS_AP = false; //Beginners level 10 or below have their AP autoassigned (they can't choose to levelup a stat). Set true ONLY if the localhost doesn't support AP assigning for beginners level 10 or below.\n+    public static final boolean USE_AUTOASSIGN_SECONDARY_CAP = true;//Prevents AP autoassign from spending on secondary stats after the player class' cap (defined on the autoassign handler) has been reached.\n     public static final boolean USE_AUTOBAN = false;                //Commands the server to detect infractors automatically.\n     public static final boolean USE_AUTOBAN_LOG = true;             //Log autoban related messages. Still logs even with USE_AUTOBAN disabled.\n     public static final boolean USE_AUTOSAVE = true;                //Enables server autosaving feature (saves characters to DB each 1 hour).\n     public static final boolean USE_SERVER_AUTOASSIGNER = true;     //HeavenMS-builtin autoassigner, uses algorithm based on distributing AP accordingly with required secondary stat on equipments.\n     public static final boolean USE_REFRESH_RANK_MOVE = true;\n     public static final boolean USE_ENFORCE_ADMIN_ACCOUNT = false;  //Forces accounts having GM characters to be treated as a \"GM account\" by the client (localhost). Some of the GM account perks is the ability to FLY, but unable to TRADE.\n+    public static final boolean USE_ENFORCE_NOVICE_EXPRATE = false; //Hardsets experience rate 1x for beginners level 10 or under. Ideal for roaming on novice areas without caring too much about losing some stats.\n     public static final boolean USE_ENFORCE_HPMP_SWAP = false;      //Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     public static final boolean USE_ENFORCE_MOB_LEVEL_RANGE = true; //Players N levels below the killed mob will gain no experience from defeating it.\n     public static final boolean USE_ENFORCE_JOB_LEVEL_RANGE = false;//Caps the player level on the minimum required to advance their current jobs.\n@@ -166,11 +168,13 @@\n     public static final int ITEM_EXPIRE_CHECK = 10 * 1000;      //Interval between item expiring tasks on maps, which checks and makes disappear expired items.\n     public static final int ITEM_LIMIT_ON_MAP = 200;            //Max number of items allowed on a map.\n     public static final int MAP_VISITED_SIZE = 5;               //Max length for last mapids visited by a player. This is used to recover and update drops on these maps accordingly with player actions.\n-    public static final int MAP_DAMAGE_OVERTIME_INTERVAL = 5000;//Interval in seconds between map environment damage (e.g. El Nath and Aqua Road surrondings).\n+    public static final int MAP_DAMAGE_OVERTIME_INTERVAL = 5000;//Interval in milliseconds between map environment damage (e.g. El Nath and Aqua Road surrondings).\n     \n     //Channel Mob Disease Monitor Configuration\n-    public static final int MOB_STATUS_MONITOR_PROC = 200;     //Frequency in milliseconds between each proc on the mob disease monitor schedule.\n-    public static final int MOB_STATUS_MONITOR_LIFE = 84;      //Idle proc count the mob disease monitor is allowed to be there before closing it due to inactivity.\n+    public static final int MOB_STATUS_MONITOR_PROC = 200;      //Frequency in milliseconds between each proc on the mob disease monitor schedule.\n+    public static final int MOB_STATUS_MONITOR_LIFE = 84;       //Idle proc count the mob disease monitor is allowed to be there before closing it due to inactivity.\n+    public static final int MOB_STATUS_AGGRO_PERSISTENCE = 2;   //Idle proc count on aggro update for a mob to keep following the current controller, given him/her is the leading damage dealer.\n+    public static final int MOB_STATUS_AGGRO_INTERVAL = 5000;   //Interval in milliseconds between aggro logistics update.\n     \n     //Some Gameplay Enhancing Configurations\n     //Scroll Configuration"}, {"sha": "7a48ee7c45215960856c944ee0e7b178a80dc68e", "filename": "src/net/opcodes/SendOpcode.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/opcodes/SendOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/opcodes/SendOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/opcodes/SendOpcode.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -228,6 +228,8 @@\n     GIVE_FOREIGN_BUFF(0xC7),\n     CANCEL_FOREIGN_BUFF(0xC8),\n     UPDATE_PARTYMEMBER_HP(0xC9),\n+    GUILD_NAME_CHANGED(0xCA),\n+    GUILD_MARK_CHANGED(0xCB),\n     THROW_GRENADE(0xCC),\n     CANCEL_CHAIR(0xCD),\n     SHOW_ITEM_GAIN_INCHAT(0xCE),\n@@ -257,8 +259,8 @@\n     DAMAGE_MONSTER(0xF6),\n     ARIANT_THING(0xF9),\n     SHOW_MONSTER_HP(0xFA),\n-    SHOW_DRAGGED(0xFB),//CATCH\n-    CATCH_MONSTER(0xFC),\n+    CATCH_MONSTER(0xFB),\n+    CATCH_MONSTER_WITH_ITEM(0xFC),\n     SHOW_MAGNET(0xFD),\n     SPAWN_NPC(0x101),\n     REMOVE_NPC(0x102),"}, {"sha": "6a6263302940ef3d3d141b49141f6768b3b5585e", "filename": "src/net/server/audit/ThreadTracker.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/audit/ThreadTracker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/audit/ThreadTracker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/ThreadTracker.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -35,7 +35,6 @@\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantLock;\n \n-import constants.ServerConstants;\n import net.server.audit.locks.MonitoredLockType;\n import server.TimerManager;\n import tools.FilePrinter;"}, {"sha": "a477e4ab7433af6345d4b14d12ef1029630e0d26", "filename": "src/net/server/audit/locks/MonitoredLockType.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/audit/locks/MonitoredLockType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/audit/locks/MonitoredLockType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredLockType.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -84,6 +84,7 @@\n     VISITOR_PSHOP,\n     STORAGE,\n     MOB,\n+    MOB_AGGRO,\n     MOB_ANI,\n     MOB_EXT,\n     MOB_STATI,\n@@ -96,6 +97,8 @@\n     MAP_ITEM,\n     MAP_LOOT,\n     MAP_BOUNDS,\n+    MAP_AGGRO,\n+    MAP_AGGRO_IDLE,\n     MINIDUNGEON,\n     REACTOR,\n     REACTOR_HIT;"}, {"sha": "3299f3d5bab5f6be6888290409f658f1e7fb6518", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -274,7 +274,7 @@ else if(attack.skill == Shadower.BOOMERANG_STEP)\n                         totDamageToOneMonster += eachd;\n                     }\n                     totDamage += totDamageToOneMonster;\n-                    player.checkMonsterAggro(monster);\n+                    monster.aggroMonsterDamage(player, totDamageToOneMonster);\n                     if (player.getBuffedValue(MapleBuffStat.PICKPOCKET) != null && (attack.skill == 0 || attack.skill == Rogue.DOUBLE_STAB || attack.skill == Bandit.SAVAGE_BLOW || attack.skill == ChiefBandit.ASSAULTER || attack.skill == ChiefBandit.BAND_OF_THIEVES || attack.skill == Shadower.ASSASSINATE || attack.skill == Shadower.TAUNT || attack.skill == Shadower.BOOMERANG_STEP)) {\n                         Skill pickpocket = SkillFactory.getSkill(ChiefBandit.PICKPOCKET);\n                         int picklv = (player.isGM()) ? pickpocket.getMaxLevel() : player.getSkillLevel(pickpocket);"}, {"sha": "47f2852c60fe7013b7f59958421cf0ddc2122c74", "filename": "src/net/server/channel/handlers/AbstractMovementPacketHandler.java", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AbstractMovementPacketHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AbstractMovementPacketHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractMovementPacketHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -51,11 +51,11 @@\n                     short ypos = lea.readShort();\n                     short xwobble = lea.readShort();\n                     short ywobble = lea.readShort();\n-                    short unk = lea.readShort();\n+                    short fh = lea.readShort();\n                     byte newstate = lea.readByte();\n                     short duration = lea.readShort();\n                     AbsoluteLifeMovement alm = new AbsoluteLifeMovement(command, new Point(xpos, ypos), duration, newstate);\n-                    alm.setUnk(unk);\n+                    alm.setFh(fh);\n                     alm.setPixelsPerSecond(new Point(xwobble, ywobble));\n                     res.add(alm);\n                     break;\n@@ -105,11 +105,11 @@\n                 /*case 11: { // Chair\n                     short xpos = lea.readShort();\n                     short ypos = lea.readShort();\n-                    short unk = lea.readShort();\n+                    short fh = lea.readShort();\n                     byte newstate = lea.readByte();\n                     short duration = lea.readShort();\n                     ChairMovement cm = new ChairMovement(command, new Point(xpos, ypos), duration, newstate);\n-                    cm.setUnk(unk);\n+                    cm.setFh(fh);\n                     res.add(cm);\n                     break;\n                 }*/\n@@ -118,14 +118,14 @@\n                     short ypos = lea.readShort();\n                     short xwobble = lea.readShort();\n                     short ywobble = lea.readShort();\n-                    short unk = lea.readShort();\n                     short fh = lea.readShort();\n+                    short ofh = lea.readShort();\n                     byte newstate = lea.readByte();\n                     short duration = lea.readShort();\n                     JumpDownMovement jdm = new JumpDownMovement(command, new Point(xpos, ypos), duration, newstate);\n-                    jdm.setUnk(unk);\n+                    jdm.setFh(fh);\n                     jdm.setPixelsPerSecond(new Point(xwobble, ywobble));\n-                    jdm.setFH(fh);\n+                    jdm.setOriginFh(ofh);\n                     res.add(jdm);\n                     break;\n                 }"}, {"sha": "448f2adb5e495ac00bb7cce50d4c64de3c84ccbf", "filename": "src/net/server/channel/handlers/AutoAggroHandler.java", "status": "modified", "additions": 4, "deletions": 21, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AutoAggroHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/AutoAggroHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AutoAggroHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -32,32 +32,15 @@\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        if (c.getPlayer().isHidden()) return; // Don't auto aggro GM's in hide...\n+        MapleCharacter player = c.getPlayer();\n+        if (player.isHidden()) return; // Don't auto aggro GM's in hide...\n         \n-        MapleMap map = c.getPlayer().getMap();\n+        MapleMap map = player.getMap();\n         int oid = slea.readInt();\n         \n         MapleMonster monster = map.getMonsterByOid(oid);\n         if (monster != null) {\n-            MapleCharacter currentController = monster.getController();\n-            monster.lockMonster();\n-            try {\n-                if (currentController != null) {\n-                    if (!monster.isControllerHasAggro()) {\n-                        if (map.getCharacterById(currentController.getId()) == null) {\n-                            monster.switchController(c.getPlayer(), true);\n-                        } else {\n-                            monster.switchController(currentController, true);\n-                        }\n-                    } else if (map.getCharacterById(currentController.getId()) == null) {\n-                        monster.switchController(c.getPlayer(), true);\n-                    }\n-                } else {\n-                    monster.switchController(c.getPlayer(), true);\n-                }\n-            } finally {\n-                monster.unlockMonster();\n-            }\n+            monster.aggroAutoAggroUpdate(player);\n         }\n     }\n }"}, {"sha": "92483e8c5139619c42b0774739184ddd891c8429", "filename": "src/net/server/channel/handlers/GuildOperationHandler.java", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/GuildOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/GuildOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GuildOperationHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -47,10 +47,6 @@ private boolean isGuildNameAcceptable(String name) {\n         return true;\n     }\n \n-    private void restancePlayer(MapleCharacter mc) {\n-        mc.broadcastStance();\n-    }\n-\n     private class Invited {\n         public String name;\n         public int gid;\n@@ -131,7 +127,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 c.announce(MaplePacketCreator.showGuildInfo(mc));\n                 \n                 c.getPlayer().dropMessage(1, \"You have successfully created a Guild.\");\n-                restancePlayer(mc);\n+                mc.getGuild().broadcastNameChanged();\n+                mc.getGuild().broadcastEmblemChanged();\n                 break;\n             case 0x05:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {\n@@ -191,7 +188,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if(allianceId > 0) Server.getInstance().getAlliance(allianceId).updateAlliancePackets(mc);\n                 \n                 mc.saveGuildStatus(); // update database\n-                restancePlayer(mc);\n+                mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildNameChanged(mc.getId(), mc.getGuild().getName())); // thanks Vcoc for pointing out an issue with updating guild tooltip to players in the map\n+                mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildMarkChanged(mc.getId(), mc.getGuild()));\n                 break;\n             case 0x07:\n                 cid = slea.readInt();\n@@ -212,7 +210,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 mc.getMGC().setGuildId(0);\n                 mc.getMGC().setGuildRank(5);\n                 mc.saveGuildStatus();\n-                restancePlayer(mc);\n+                mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildNameChanged(mc.getId(), \"\"));\n                 break;\n             case 0x08:\n                 allianceId = mc.getGuild().getAllianceId();\n@@ -272,7 +270,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 \n                 mc.gainMeso(-ServerConstants.CHANGE_EMBLEM_COST, true, false, true);\n-                restancePlayer(mc);\n+                mc.getGuild().broadcastNameChanged();\n+                mc.getGuild().broadcastEmblemChanged();\n                 break;\n             case 0x10:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {"}, {"sha": "93c2c3035d9a4ce382df1a861a54ae159c50521e", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 3, "deletions": 25, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -77,8 +77,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \n \t\tboolean isAttack = inRangeInclusive(rawActivity, 24, 41);\n \t\tboolean isSkill = inRangeInclusive(rawActivity, 42, 59);\n-\t\t\n-                boolean currentController = (monster.getController() == player);\n                 \n \t\tMobSkill toUse = null;\n                 int useSkillId = 0, useSkillLevel = 0;\n@@ -112,10 +110,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         \n                         int atkStatus = monster.canUseAttack(castPos, isSkill);\n                         if (atkStatus < 1) {\n-                                if (!currentController) {\n-                                        return;\n-                                }\n-                                \n                                 rawActivity = -1;\n                                 pOption = 0;\n                         }\n@@ -147,24 +141,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tPoint startPos = new Point(start_x, start_y - 2);\n \t\tList<LifeMovementFragment> res = parseMovement(slea);\n \t\t\n-                boolean aggro;\n-                monster.lockMonster();\n-                try {\n-                        if (!currentController) {\n-                                if (monster.isAttackedBy(player)) {\n-                                        monster.switchController(player, true);\n-                                } else {\n-                                        return;\n-                                }\n-                        }\n-\n-                        aggro = monster.isControllerHasAggro();\n-                        if (aggro) {\n-                                monster.setControllerKnowsAboutAggro(true);\n-                        }\n-                } finally {\n-                        monster.unlockMonster();\n-                }\n+                Boolean aggro = monster.aggroMoveLifeUpdate(player);\n+                if (aggro == null) return;\n                 \n                 if (nextUse != null) {\n                         c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro, nextSkillId, nextSkillLevel));\n@@ -174,7 +152,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \n \t\tif (res != null) {\n                         if (ServerConstants.USE_DEBUG_SHOW_RCVD_MVLIFE) {\n-                                System.out.println((isSkill ? \"SKILL \" : (isAttack ? \"ATTCK \" : \" \")) + \"castPos: \" + castPos + \" rawAct: \" + rawActivity + \" opt: \" + pOption + \" skillID: \" + useSkillId + \" skillLV: \" + useSkillLevel + \" \" + \"allowSkill: \" + nextMovementCouldBeSkill);\n+                                System.out.println((isSkill ? \"SKILL \" : (isAttack ? \"ATTCK \" : \" \")) + \"castPos: \" + castPos + \" rawAct: \" + rawActivity + \" opt: \" + pOption + \" skillID: \" + useSkillId + \" skillLV: \" + useSkillLevel + \" \" + \"allowSkill: \" + nextMovementCouldBeSkill + \" mobMp: \" + mobMp);\n                         }\n                         \n                         map.broadcastMessage(player, MaplePacketCreator.moveMonster(objectid, nextMovementCouldBeSkill, rawActivity, useSkillId, useSkillLevel, pOption, startPos, res), monster.getPosition());"}, {"sha": "8e06663feacdf2154e84247765f73265514ae362", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 52, "deletions": 21, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -35,6 +35,7 @@\n import server.MapleItemInformationProvider;\n import server.MapleTrade;\n import constants.GameConstants;\n+import java.sql.SQLException;\n import server.maps.FieldLimit;\n import server.maps.MapleHiredMerchant;\n import server.maps.MapleMapObject;\n@@ -61,8 +62,8 @@\n         CHAT(6),\n         CHAT_THING(8),\n         EXIT(0xA),\n-        OPEN(0xB),\n-        TRADE_BIRTHDAY(0x0E),\n+        OPEN_STORE(0xB),\n+        OPEN_CASH(0xE),\n         SET_ITEMS(0xF),\n         SET_MESO(0x10),\n         CONFIRM(0x11),\n@@ -74,7 +75,7 @@\n         REMOVE_ITEM(0x1B),\n         BAN_PLAYER(0x1C),\n         MERCHANT_THING(0x1D),\n-        OPEN_STORE(0x1E),\n+        OPEN_THING(0x1E),\n         PUT_ITEM(0x21),\n         MERCHANT_BUY(0x22),\n         TAKE_ITEM_BACK(0x26),\n@@ -136,7 +137,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         try {\n             byte mode = slea.readByte();\n             final MapleCharacter chr = c.getPlayer();\n-\n+            \n             if (mode == Action.CREATE.getCode()) {\n                 if(!chr.isAlive()) {    // thanks GabrielSin for pointing this\n                     chr.getClient().announce(MaplePacketCreator.getMiniRoomError(4));\n@@ -333,14 +334,25 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     chr.closeMiniGame();\n                     chr.closeHiredMerchant(true);\n                 }\n-            } else if (mode == Action.OPEN.getCode()) {\n+            } else if (mode == Action.OPEN_STORE.getCode() || mode == Action.OPEN_CASH.getCode()) {\n                 if (isTradeOpen(chr)) return;\n+                \n+                if (mode == Action.OPEN_STORE.getCode()) {\n+                    slea.readByte();    //01\n+                } else {\n+                    slea.readShort();\n+                    int birthday = slea.readInt();\n+                    if (!CashOperationHandler.checkBirthday(c, birthday)) { // birthday check here found thanks to lucasziron\n+                        c.announce(MaplePacketCreator.serverNotice(1, \"Please check again the birthday date.\"));\n+                        return;\n+                    }\n+                    \n+                    c.announce(MaplePacketCreator.hiredMerchantOwnerMaintenanceLeave());\n+                }\n \n                 MaplePlayerShop shop = chr.getPlayerShop();\n                 MapleHiredMerchant merchant = chr.getHiredMerchant();\n                 if (shop != null && shop.isOwner(chr)) {\n-                    slea.readByte();//01\n-\n                     if(ServerConstants.USE_ERASE_PERMIT_ON_OPENSHOP) {\n                         try {\n                             MapleInventoryManipulator.removeById(c, MapleInventoryType.CASH, shop.getItemId(), 1, true, false);\n@@ -355,7 +367,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     chr.getMap().addMapObject(merchant);\n                     chr.setHiredMerchant(null);\n                     chr.getMap().broadcastMessage(MaplePacketCreator.spawnHiredMerchantBox(merchant));\n-                    slea.readByte();\n                 }\n             } else if (mode == Action.READY.getCode()) {\n                 MapleMiniGame game = chr.getMiniGame();\n@@ -528,7 +539,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     c.announce(MaplePacketCreator.serverNotice(1, \"Cash items are not allowed to be sold on the Player Store.\"));\n                     return;\n                 }\n-\n+                \n                 if (ServerConstants.USE_ENFORCE_UNMERCHABLE_PET && ItemConstants.isPet(ivItem.getItemId())) {\n                     c.announce(MaplePacketCreator.serverNotice(1, \"Pets are not allowed to be sold on the Player Store.\"));\n                     return;\n@@ -543,26 +554,44 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 MaplePlayerShop shop = chr.getPlayerShop();\n                 MapleHiredMerchant merchant = chr.getHiredMerchant();\n                 if (shop != null && shop.isOwner(chr)) {\n-                    if (shop.isOpen()) {\n+                    if (shop.isOpen() || !shop.addItem(shopItem)) { // thanks Vcoc for pointing an exploit with unlimited shop slots\n                         c.announce(MaplePacketCreator.serverNotice(1, \"You can't sell it anymore.\"));\n                         return;\n                     }\n-\n-                    shop.addItem(shopItem);\n+                    \n+                    if (ItemConstants.isRechargeable(ivItem.getItemId())) {\n+                        MapleInventoryManipulator.removeFromSlot(c, ivType, slot, ivItem.getQuantity(), true);\n+                    } else {\n+                        MapleInventoryManipulator.removeFromSlot(c, ivType, slot, (short) (bundles * perBundle), true);\n+                    }\n+                    \n                     c.announce(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n                 } else if (merchant != null && merchant.isOwner(chr)) {\n-                    if (merchant.isOpen()) {\n+                    if (ivType.equals(MapleInventoryType.CASH) && merchant.isPublished()) {\n+                        c.announce(MaplePacketCreator.serverNotice(1, \"Cash items are only allowed to be sold when first opening the store.\"));\n+                        return;\n+                    }\n+                    \n+                    if (merchant.isOpen() || !merchant.addItem(shopItem)) { // thanks Vcoc for pointing an exploit with unlimited shop slots\n                         c.announce(MaplePacketCreator.serverNotice(1, \"You can't sell it anymore.\"));\n                         return;\n                     }\n-\n-                    merchant.addItem(shopItem);\n+                    \n+                    if (ItemConstants.isRechargeable(ivItem.getItemId())) {\n+                        MapleInventoryManipulator.removeFromSlot(c, ivType, slot, ivItem.getQuantity(), true);\n+                    } else {\n+                        MapleInventoryManipulator.removeFromSlot(c, ivType, slot, (short) (bundles * perBundle), true);\n+                    }\n+                    \n                     c.announce(MaplePacketCreator.updateHiredMerchant(merchant, chr));\n-                }\n-                if (ItemConstants.isRechargeable(ivItem.getItemId())) {\n-                    MapleInventoryManipulator.removeFromSlot(c, ivType, slot, ivItem.getQuantity(), true);\n+                    \n+                    try {\n+                        merchant.saveItems(false);   // thanks Masterrulax for realizing yet another dupe with merchants/Fredrick\n+                    } catch (SQLException ex) {\n+                        ex.printStackTrace();\n+                    }\n                 } else {\n-                    MapleInventoryManipulator.removeFromSlot(c, ivType, slot, (short) (bundles * perBundle), true);\n+                    c.announce(MaplePacketCreator.serverNotice(1, \"You can't sell without owning a shop.\"));\n                 }\n             } else if (mode == Action.REMOVE_ITEM.getCode()) {\n                 if (isTradeOpen(chr)) return;\n@@ -616,8 +645,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 MaplePlayerShop shop = chr.getPlayerShop();\n                 MapleHiredMerchant merchant = chr.getHiredMerchant();\n                 if (shop != null && shop.isVisitor(chr)) {\n-                    shop.buy(c, itemid, quantity);\n-                    shop.broadcast(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n+                    if (shop.buy(c, itemid, quantity)) {\n+                        shop.broadcast(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n+                    }\n                 } else if (merchant != null && !merchant.isOwner(chr)) {\n                     merchant.buy(c, itemid, quantity);\n                     merchant.broadcastToVisitorsThreadsafe(MaplePacketCreator.updateHiredMerchant(merchant, chr));\n@@ -661,6 +691,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     if (merchant.isOwner(chr)) {\n                         merchant.clearMessages();\n                         merchant.setOpen(true);\n+                        merchant.getMap().broadcastMessage(MaplePacketCreator.updateHiredMerchantBox(merchant));\n                     }\n                 }\n "}, {"sha": "cb56de4fe2e8b49be84037a24b4717a2b1849b12", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 311, "deletions": 275, "changes": 586, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -62,7 +62,9 @@\n import java.net.InetSocketAddress;\n import java.util.Collections;\n import java.util.Comparator;\n+import java.util.HashSet;\n import java.util.Map;\n+import java.util.Set;\n import net.server.coordinator.MapleEventRecallCoordinator;\n import net.server.coordinator.MapleSessionCoordinator;\n import org.apache.mina.core.session.IoSession;\n@@ -72,6 +74,25 @@\n \n public final class PlayerLoggedinHandler extends AbstractMaplePacketHandler {\n \n+    private static Set<Integer> attemptingLoginAccounts = new HashSet<>();\n+    \n+    private boolean tryAcquireAccount(int accId) {\n+        synchronized (attemptingLoginAccounts) {\n+            if (attemptingLoginAccounts.contains(accId)) {\n+                return false;\n+            }\n+            \n+            attemptingLoginAccounts.add(accId);\n+            return true;\n+        }\n+    }\n+    \n+    private void releaseAccount(int accId) {\n+        synchronized (attemptingLoginAccounts) {\n+            attemptingLoginAccounts.remove(accId);\n+        }\n+    }\n+    \n     @Override\n     public final boolean validateState(MapleClient c) {\n         return !c.isLoggedIn();\n@@ -82,298 +103,313 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         final int cid = slea.readInt();\n         final Server server = Server.getInstance();\n         \n-        World wserv = server.getWorld(c.getWorld());\n-        if(wserv == null) {\n-            c.disconnect(true, false);\n-            return;\n-        }\n-        \n-        Channel cserv = wserv.getChannel(c.getChannel());\n-        if(cserv == null) {\n-            c.setChannel(1);\n-            cserv = wserv.getChannel(c.getChannel());\n-            \n-            if(cserv == null) {\n-                c.disconnect(true, false);\n-                return;\n-            }\n-        }\n-        \n-        MapleCharacter player = wserv.getPlayerStorage().getCharacterById(cid);\n-        boolean newcomer = false;\n-        \n-        IoSession session = c.getSession();\n-        String remoteHwid;\n-        if (player == null) {\n-            if (!server.validateCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), cid)) {\n-                c.disconnect(true, false);\n-                return;\n-            }\n-            \n-            remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n-            if (remoteHwid == null) {\n-                c.disconnect(true, false);\n-                return;\n-            }\n-            \n+        if (c.tryacquireClient()) { // thanks MedicOP for assisting on concurrency protection here\n             try {\n-                player = MapleCharacter.loadCharFromDB(cid, c, true);\n-                newcomer = true;\n-            } catch (SQLException e) {\n-                e.printStackTrace();\n-            }\n-        } else {\n-            remoteHwid = player.getClient().getHWID();\n-        }\n-        \n-        if (player == null) { //If you are still getting null here then please just uninstall the game >.>, we dont need you fucking with the logs\n-            c.disconnect(true, false);\n-            return;\n-        }\n-        \n-        c.setPlayer(player);\n-        c.setAccID(player.getAccountID());\n-        \n-        boolean allowLogin = true;\n+                World wserv = server.getWorld(c.getWorld());\n+                if(wserv == null) {\n+                    c.disconnect(true, false);\n+                    return;\n+                }\n \n-        /*  is this check really necessary?\n-        if (state == MapleClient.LOGIN_SERVER_TRANSITION || state == MapleClient.LOGIN_NOTLOGGEDIN) {\n-            List<String> charNames = c.loadCharacterNames(c.getWorld());\n-            if(!newcomer) {\n-                charNames.remove(player.getName());\n-            }\n-            \n-            for (String charName : charNames) {\n-                if(wserv.getPlayerStorage().getCharacterByName(charName) != null) {\n-                    allowLogin = false;\n-                    break;\n+                Channel cserv = wserv.getChannel(c.getChannel());\n+                if(cserv == null) {\n+                    c.setChannel(1);\n+                    cserv = wserv.getChannel(c.getChannel());\n+\n+                    if(cserv == null) {\n+                        c.disconnect(true, false);\n+                        return;\n+                    }\n                 }\n-            }\n-        }\n-        */\n \n-        c.lockClient(); // Sync this to prevent wrong login state for double channel changes\n-        try {\n-            int state = c.getLoginState();\n-            if (state != MapleClient.LOGIN_SERVER_TRANSITION || !allowLogin) {\n-                c.setPlayer(null);\n-                c.setAccID(0);\n-                \n-                if (state == MapleClient.LOGIN_LOGGEDIN) {\n+                MapleCharacter player = wserv.getPlayerStorage().getCharacterById(cid);\n+                boolean newcomer = false;\n+\n+                IoSession session = c.getSession();\n+                String remoteHwid;\n+                if (player == null) {\n+                    if (!server.validateCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), cid)) {\n+                        c.disconnect(true, false);\n+                        return;\n+                    }\n+\n+                    remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n+                    if (remoteHwid == null) {\n+                        c.disconnect(true, false);\n+                        return;\n+                    }\n+\n+                    try {\n+                        player = MapleCharacter.loadCharFromDB(cid, c, true);\n+                        newcomer = true;\n+                    } catch (SQLException e) {\n+                        e.printStackTrace();\n+                    }\n+                } else {\n+                    remoteHwid = player.getClient().getHWID();\n+                }\n+\n+                if (player == null) { //If you are still getting null here then please just uninstall the game >.>, we dont need you fucking with the logs\n                     c.disconnect(true, false);\n+                    return;\n+                }\n+\n+                c.setPlayer(player);\n+                c.setAccID(player.getAccountID());\n+\n+                boolean allowLogin = true;\n+\n+                /*  is this check really necessary?\n+                if (state == MapleClient.LOGIN_SERVER_TRANSITION || state == MapleClient.LOGIN_NOTLOGGEDIN) {\n+                    List<String> charNames = c.loadCharacterNames(c.getWorld());\n+                    if(!newcomer) {\n+                        charNames.remove(player.getName());\n+                    }\n+\n+                    for (String charName : charNames) {\n+                        if(wserv.getPlayerStorage().getCharacterByName(charName) != null) {\n+                            allowLogin = false;\n+                            break;\n+                        }\n+                    }\n+                }\n+                */\n+                \n+                int accId = c.getAccID();\n+                if (tryAcquireAccount(accId)) { // Sync this to prevent wrong login state for double loggedin handling\n+                    try {\n+                        int state = c.getLoginState();\n+                        if (state != MapleClient.LOGIN_SERVER_TRANSITION || !allowLogin) {\n+                            c.setPlayer(null);\n+                            c.setAccID(0);\n+\n+                            if (state == MapleClient.LOGIN_LOGGEDIN) {\n+                                c.disconnect(true, false);\n+                            } else {\n+                                c.announce(MaplePacketCreator.getAfterLoginError(7));\n+                            }\n+\n+                            return;\n+                        }\n+                        c.updateLoginState(MapleClient.LOGIN_LOGGEDIN);\n+                    } finally {\n+                        releaseAccount(accId);\n+                    }\n                 } else {\n-                    c.announce(MaplePacketCreator.getAfterLoginError(7));\n+                    c.setPlayer(null);\n+                    c.setAccID(0);\n+                    c.announce(MaplePacketCreator.getAfterLoginError(10));\n+                    return;\n                 }\n                 \n-                return;\n-            }\n-            c.updateLoginState(MapleClient.LOGIN_LOGGEDIN);\n-        } finally {\n-            c.unlockClient();\n-        }\n-        \n-        if (!newcomer) {\n-            c.setCharacterSlots((byte) player.getClient().getCharacterSlots());\n-            player.newClient(c);\n-        }\n-        \n-        int hwidLen = remoteHwid.length();\n-        session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n-        session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n-        c.setHWID(remoteHwid);\n-        \n-        cserv.addPlayer(player);\n-        wserv.addPlayer(player);\n-        player.setEnteredChannelWorld();\n-        \n-        List<PlayerBuffValueHolder> buffs = server.getPlayerBuffStorage().getBuffsFromStorage(cid);\n-        if (buffs != null) {\n-            List<Pair<Long, PlayerBuffValueHolder>> timedBuffs = getLocalStartTimes(buffs);\n-            player.silentGiveBuffs(timedBuffs);\n-        }\n-        \n-        Map<MapleDisease, Pair<Long, MobSkill>> diseases = server.getPlayerBuffStorage().getDiseasesFromStorage(cid);\n-        if (diseases != null) {\n-            player.silentApplyDiseases(diseases);\n-        }\n-        \n-        c.announce(MaplePacketCreator.getCharInfo(player));\n-        if (!player.isHidden()) {\n-            if(player.isGM() && ServerConstants.USE_AUTOHIDE_GM) {\n-                player.toggleHide(true);\n-            }\n-        }\n-        player.sendKeymap();\n-        player.sendMacros();\n-        \n-        // pot bindings being passed through other characters on the account detected thanks to Croosade dev team\n-        MapleKeyBinding autohpPot = player.getKeymap().get(91);\n-        player.announce(MaplePacketCreator.sendAutoHpPot(autohpPot != null ? autohpPot.getAction() : 0));\n-        \n-        MapleKeyBinding autompPot = player.getKeymap().get(92);\n-        player.announce(MaplePacketCreator.sendAutoMpPot(autompPot != null ? autompPot.getAction() : 0));\n-        \n-        player.getMap().addPlayer(player);\n-        player.visitMap(player.getMap());\n-        \n-        BuddyList bl = player.getBuddylist();\n-        int buddyIds[] = bl.getBuddyIds();\n-        wserv.loggedOn(player.getName(), player.getId(), c.getChannel(), buddyIds);\n-        for (CharacterIdChannelPair onlineBuddy : wserv.multiBuddyFind(player.getId(), buddyIds)) {\n-            BuddylistEntry ble = bl.get(onlineBuddy.getCharacterId());\n-            ble.setChannel(onlineBuddy.getChannel());\n-            bl.put(ble);\n-        }\n-        c.announce(MaplePacketCreator.updateBuddylist(bl.getBuddies()));\n-        \n-        c.announce(MaplePacketCreator.loadFamily(player));\n-        if (player.getFamilyId() > 0) {\n-            MapleFamily f = wserv.getFamily(player.getFamilyId());\n-            if (f == null) {\n-                f = new MapleFamily(player.getId());\n-                wserv.addFamily(player.getFamilyId(), f);\n-            }\n-            player.setFamily(f);\n-            c.announce(MaplePacketCreator.getFamilyInfo(f.getMember(player.getId())));\n-        }\n-        if (player.getGuildId() > 0) {\n-            MapleGuild playerGuild = server.getGuild(player.getGuildId(), player.getWorld(), player);\n-            if (playerGuild == null) {\n-                player.deleteGuild(player.getGuildId());\n-                player.getMGC().setGuildId(0);\n-                player.getMGC().setGuildRank(5);\n-            } else {\n-                playerGuild.getMGC(player.getId()).setCharacter(player);\n-                player.setMGC(playerGuild.getMGC(player.getId()));\n-                server.setGuildMemberOnline(player, true, c.getChannel());\n-                c.announce(MaplePacketCreator.showGuildInfo(player));\n-                int allianceId = player.getGuild().getAllianceId();\n-                if (allianceId > 0) {\n-                    MapleAlliance newAlliance = server.getAlliance(allianceId);\n-                    if (newAlliance == null) {\n-                        newAlliance = MapleAlliance.loadAlliance(allianceId);\n-                        if (newAlliance != null) {\n-                            server.addAlliance(allianceId, newAlliance);\n-                        } else {\n-                            player.getGuild().setAllianceId(0);\n+                if (!newcomer) {\n+                    c.setCharacterSlots((byte) player.getClient().getCharacterSlots());\n+                    player.newClient(c);\n+                }\n+\n+                int hwidLen = remoteHwid.length();\n+                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n+                c.setHWID(remoteHwid);\n+\n+                cserv.addPlayer(player);\n+                wserv.addPlayer(player);\n+                player.setEnteredChannelWorld();\n+\n+                List<PlayerBuffValueHolder> buffs = server.getPlayerBuffStorage().getBuffsFromStorage(cid);\n+                if (buffs != null) {\n+                    List<Pair<Long, PlayerBuffValueHolder>> timedBuffs = getLocalStartTimes(buffs);\n+                    player.silentGiveBuffs(timedBuffs);\n+                }\n+\n+                Map<MapleDisease, Pair<Long, MobSkill>> diseases = server.getPlayerBuffStorage().getDiseasesFromStorage(cid);\n+                if (diseases != null) {\n+                    player.silentApplyDiseases(diseases);\n+                }\n+\n+                c.announce(MaplePacketCreator.getCharInfo(player));\n+                if (!player.isHidden()) {\n+                    if(player.isGM() && ServerConstants.USE_AUTOHIDE_GM) {\n+                        player.toggleHide(true);\n+                    }\n+                }\n+                player.sendKeymap();\n+                player.sendMacros();\n+\n+                // pot bindings being passed through other characters on the account detected thanks to Croosade dev team\n+                MapleKeyBinding autohpPot = player.getKeymap().get(91);\n+                player.announce(MaplePacketCreator.sendAutoHpPot(autohpPot != null ? autohpPot.getAction() : 0));\n+\n+                MapleKeyBinding autompPot = player.getKeymap().get(92);\n+                player.announce(MaplePacketCreator.sendAutoMpPot(autompPot != null ? autompPot.getAction() : 0));\n+\n+                player.getMap().addPlayer(player);\n+                player.visitMap(player.getMap());\n+\n+                BuddyList bl = player.getBuddylist();\n+                int buddyIds[] = bl.getBuddyIds();\n+                wserv.loggedOn(player.getName(), player.getId(), c.getChannel(), buddyIds);\n+                for (CharacterIdChannelPair onlineBuddy : wserv.multiBuddyFind(player.getId(), buddyIds)) {\n+                    BuddylistEntry ble = bl.get(onlineBuddy.getCharacterId());\n+                    ble.setChannel(onlineBuddy.getChannel());\n+                    bl.put(ble);\n+                }\n+                c.announce(MaplePacketCreator.updateBuddylist(bl.getBuddies()));\n+\n+                c.announce(MaplePacketCreator.loadFamily(player));\n+                if (player.getFamilyId() > 0) {\n+                    MapleFamily f = wserv.getFamily(player.getFamilyId());\n+                    if (f == null) {\n+                        f = new MapleFamily(player.getId());\n+                        wserv.addFamily(player.getFamilyId(), f);\n+                    }\n+                    player.setFamily(f);\n+                    c.announce(MaplePacketCreator.getFamilyInfo(f.getMember(player.getId())));\n+                }\n+                if (player.getGuildId() > 0) {\n+                    MapleGuild playerGuild = server.getGuild(player.getGuildId(), player.getWorld(), player);\n+                    if (playerGuild == null) {\n+                        player.deleteGuild(player.getGuildId());\n+                        player.getMGC().setGuildId(0);\n+                        player.getMGC().setGuildRank(5);\n+                    } else {\n+                        playerGuild.getMGC(player.getId()).setCharacter(player);\n+                        player.setMGC(playerGuild.getMGC(player.getId()));\n+                        server.setGuildMemberOnline(player, true, c.getChannel());\n+                        c.announce(MaplePacketCreator.showGuildInfo(player));\n+                        int allianceId = player.getGuild().getAllianceId();\n+                        if (allianceId > 0) {\n+                            MapleAlliance newAlliance = server.getAlliance(allianceId);\n+                            if (newAlliance == null) {\n+                                newAlliance = MapleAlliance.loadAlliance(allianceId);\n+                                if (newAlliance != null) {\n+                                    server.addAlliance(allianceId, newAlliance);\n+                                } else {\n+                                    player.getGuild().setAllianceId(0);\n+                                }\n+                            }\n+                            if (newAlliance != null) {\n+                                c.announce(MaplePacketCreator.updateAllianceInfo(newAlliance, c));\n+                                c.announce(MaplePacketCreator.allianceNotice(newAlliance.getId(), newAlliance.getNotice()));\n+\n+                                if (newcomer) {\n+                                    server.allianceMessage(allianceId, MaplePacketCreator.allianceMemberOnline(player, true), player.getId(), -1);\n+                                }\n+                            }\n                         }\n                     }\n-                    if (newAlliance != null) {\n-                        c.announce(MaplePacketCreator.updateAllianceInfo(newAlliance, c));\n-                        c.announce(MaplePacketCreator.allianceNotice(newAlliance.getId(), newAlliance.getNotice()));\n-                        \n-                        if (newcomer) {\n-                            server.allianceMessage(allianceId, MaplePacketCreator.allianceMemberOnline(player, true), player.getId(), -1);\n+                }\n+\n+                player.showNote();\n+                if (player.getParty() != null) {\n+                    MaplePartyCharacter pchar = player.getMPC();\n+\n+                    //Use this in case of enabling party HPbar HUD when logging in, however \"you created a party\" will appear on chat.\n+                    //c.announce(MaplePacketCreator.partyCreated(pchar));\n+\n+                    pchar.setChannel(c.getChannel());\n+                    pchar.setMapId(player.getMapId());\n+                    pchar.setOnline(true);\n+                    wserv.updateParty(player.getParty().getId(), PartyOperation.LOG_ONOFF, pchar);\n+                    player.updatePartyMemberHP();\n+                }\n+\n+                MapleInventory eqpInv = player.getInventory(MapleInventoryType.EQUIPPED);\n+                eqpInv.lockInventory();\n+                try {\n+                    for(Item it : eqpInv.list()) {\n+                        player.equippedItem((Equip) it);\n+                    }\n+                } finally {\n+                    eqpInv.unlockInventory();\n+                }\n+\n+                c.announce(MaplePacketCreator.updateBuddylist(player.getBuddylist().getBuddies()));\n+\n+                CharacterNameAndId pendingBuddyRequest = c.getPlayer().getBuddylist().pollPendingRequest();\n+                if (pendingBuddyRequest != null) {\n+                    c.announce(MaplePacketCreator.requestBuddylistAdd(pendingBuddyRequest.getId(), c.getPlayer().getId(), pendingBuddyRequest.getName()));\n+                }\n+\n+                c.announce(MaplePacketCreator.updateGender(player));\n+                player.checkMessenger();\n+                c.announce(MaplePacketCreator.enableReport());\n+                player.changeSkillLevel(SkillFactory.getSkill(10000000 * player.getJobType() + 12), (byte) (player.getLinkedLevel() / 10), 20, -1);\n+                player.checkBerserk(player.isHidden());\n+\n+                if (newcomer) {\n+                    for(MaplePet pet : player.getPets()) {\n+                        if(pet != null)\n+                            wserv.registerPetHunger(player, player.getPetIndex(pet));\n+                    }\n+\n+                    player.reloadQuestExpirations();\n+\n+                    /*\n+                    if (!c.hasVotedAlready()){\n+                        player.announce(MaplePacketCreator.earnTitleMessage(\"You can vote now! Vote and earn a vote point!\"));\n+                    }\n+                    */\n+                    if (player.isGM()){\n+                        Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.earnTitleMessage((player.gmLevel() < 6 ? \"GM \" : \"Admin \") + player.getName() + \" has logged in\"));\n+                    }\n+\n+                    if(diseases != null) {\n+                        for(Entry<MapleDisease, Pair<Long, MobSkill>> e : diseases.entrySet()) {\n+                            final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(e.getKey(), Integer.valueOf(e.getValue().getRight().getX())));\n+                            c.announce(MaplePacketCreator.giveDebuff(debuff, e.getValue().getRight()));\n                         }\n+\n+                        player.announceDiseases();\n+                    }\n+                } else {\n+                    if(player.isRidingBattleship()) {\n+                        player.announceBattleshipHp();\n                     }\n                 }\n-            }\n-        }\n \n-        player.showNote();\n-        if (player.getParty() != null) {\n-            MaplePartyCharacter pchar = player.getMPC();\n-            \n-            //Use this in case of enabling party HPbar HUD when logging in, however \"you created a party\" will appear on chat.\n-            //c.announce(MaplePacketCreator.partyCreated(pchar));\n-            \n-            pchar.setChannel(c.getChannel());\n-            pchar.setMapId(player.getMapId());\n-            pchar.setOnline(true);\n-            wserv.updateParty(player.getParty().getId(), PartyOperation.LOG_ONOFF, pchar);\n-            player.updatePartyMemberHP();\n-        }\n-        \n-        MapleInventory eqpInv = player.getInventory(MapleInventoryType.EQUIPPED);\n-        eqpInv.lockInventory();\n-        try {\n-            for(Item it : eqpInv.list()) {\n-                player.equippedItem((Equip) it);\n-            }\n-        } finally {\n-            eqpInv.unlockInventory();\n-        }\n-        \n-        c.announce(MaplePacketCreator.updateBuddylist(player.getBuddylist().getBuddies()));\n-        \n-        CharacterNameAndId pendingBuddyRequest = c.getPlayer().getBuddylist().pollPendingRequest();\n-        if (pendingBuddyRequest != null) {\n-            c.announce(MaplePacketCreator.requestBuddylistAdd(pendingBuddyRequest.getId(), c.getPlayer().getId(), pendingBuddyRequest.getName()));\n-        }\n-        \n-        c.announce(MaplePacketCreator.updateGender(player));\n-        player.checkMessenger();\n-        c.announce(MaplePacketCreator.enableReport());\n-        player.changeSkillLevel(SkillFactory.getSkill(10000000 * player.getJobType() + 12), (byte) (player.getLinkedLevel() / 10), 20, -1);\n-        player.checkBerserk(player.isHidden());\n-        \n-        if (newcomer) {\n-            for(MaplePet pet : player.getPets()) {\n-                if(pet != null)\n-                    wserv.registerPetHunger(player, player.getPetIndex(pet));\n-            }\n-            \n-            player.reloadQuestExpirations();\n-            \n-            /*\n-            if (!c.hasVotedAlready()){\n-            \tplayer.announce(MaplePacketCreator.earnTitleMessage(\"You can vote now! Vote and earn a vote point!\"));\n-            }\n-            */\n-            if (player.isGM()){\n-            \tServer.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.earnTitleMessage((player.gmLevel() < 6 ? \"GM \" : \"Admin \") + player.getName() + \" has logged in\"));\n-            }\n-            \n-            if(diseases != null) {\n-                for(Entry<MapleDisease, Pair<Long, MobSkill>> e : diseases.entrySet()) {\n-                    final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(e.getKey(), Integer.valueOf(e.getValue().getRight().getX())));\n-                    c.announce(MaplePacketCreator.giveDebuff(debuff, e.getValue().getRight()));\n+                player.buffExpireTask();\n+                player.diseaseExpireTask();\n+                player.skillCooldownTask();\n+                player.expirationTask();\n+                player.questExpirationTask();\n+                if (GameConstants.hasSPTable(player.getJob()) && player.getJob().getId() != 2001) {\n+                    player.createDragon();\n                 }\n-                \n-                player.announceDiseases();\n+\n+                player.commitExcludedItems();\n+                showDueyNotification(c, player);\n+\n+                if (player.getMap().getHPDec() > 0) player.resetHpDecreaseTask();\n+\n+                player.resetPlayerRates();\n+                if(ServerConstants.USE_ADD_RATES_BY_LEVEL == true) player.setPlayerRates();\n+                player.setWorldRates();\n+                player.updateCouponRates();\n+\n+                player.receivePartyMemberHP();\n+\n+                if(player.getPartnerId() > 0) {\n+                    int partnerId = player.getPartnerId();\n+                    final MapleCharacter partner = wserv.getPlayerStorage().getCharacterById(partnerId);\n+\n+                    if(partner != null && !partner.isAwayFromWorld()) {\n+                        player.announce(Wedding.OnNotifyWeddingPartnerTransfer(partnerId, partner.getMapId()));\n+                        partner.announce(Wedding.OnNotifyWeddingPartnerTransfer(player.getId(), player.getMapId()));\n+                    }\n+                }\n+\n+                if (newcomer) {\n+                    EventInstanceManager eim = MapleEventRecallCoordinator.getInstance().recallEventInstance(cid);\n+                    if (eim != null) {\n+                        eim.registerPlayer(player);\n+                    }\n+                }\n+            } finally {\n+                c.releaseClient();\n             }\n         } else {\n-            if(player.isRidingBattleship()) {\n-                player.announceBattleshipHp();\n-            }\n-        }\n-        \n-        player.buffExpireTask();\n-        player.diseaseExpireTask();\n-        player.skillCooldownTask();\n-        player.expirationTask();\n-        player.questExpirationTask();\n-        if (GameConstants.hasSPTable(player.getJob()) && player.getJob().getId() != 2001) {\n-            player.createDragon();\n-        }\n-        \n-        player.commitExcludedItems();\n-        showDueyNotification(c, player);\n-        \n-        if (player.getMap().getHPDec() > 0) player.resetHpDecreaseTask();\n-        \n-        player.resetPlayerRates();\n-        if(ServerConstants.USE_ADD_RATES_BY_LEVEL == true) player.setPlayerRates();\n-        player.setWorldRates();\n-        player.updateCouponRates();\n-        \n-        player.receivePartyMemberHP();\n-        \n-        if(player.getPartnerId() > 0) {\n-            int partnerId = player.getPartnerId();\n-            final MapleCharacter partner = wserv.getPlayerStorage().getCharacterById(partnerId);\n-            \n-            if(partner != null && !partner.isAwayFromWorld()) {\n-                player.announce(Wedding.OnNotifyWeddingPartnerTransfer(partnerId, partner.getMapId()));\n-                partner.announce(Wedding.OnNotifyWeddingPartnerTransfer(player.getId(), player.getMapId()));\n-            }\n-        }\n-        \n-        if (newcomer) {\n-            EventInstanceManager eim = MapleEventRecallCoordinator.getInstance().recallEventInstance(cid);\n-            if (eim != null) {\n-                eim.registerPlayer(player);\n-            }\n+            c.announce(MaplePacketCreator.getAfterLoginError(10));\n         }\n     }\n     "}, {"sha": "b40b5ab87482ac264ac72e438ace597b35fa0cfa", "filename": "src/net/server/channel/handlers/SpecialMoveHandler.java", "status": "modified", "additions": 10, "deletions": 14, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/SpecialMoveHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/SpecialMoveHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SpecialMoveHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -91,26 +91,22 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         if (skillid == Hero.MONSTER_MAGNET || skillid == Paladin.MONSTER_MAGNET || skillid == DarkKnight.MONSTER_MAGNET) { // Monster Magnet\n             int num = slea.readInt();\n-            int mobId;\n-            byte success;\n             for (int i = 0; i < num; i++) {\n-                mobId = slea.readInt();\n-                success = slea.readByte();\n-                chr.getMap().broadcastMessage(chr, MaplePacketCreator.showMagnet(mobId, success), false);\n-                MapleMonster monster = chr.getMap().getMonsterByOid(mobId);\n+                int mobOid = slea.readInt();\n+                byte success = slea.readByte();\n+                chr.getMap().broadcastMessage(chr, MaplePacketCreator.catchMonster(mobOid, success), false);\n+                MapleMonster monster = chr.getMap().getMonsterByOid(mobOid);\n                 if (monster != null) {\n                     if (!monster.isBoss()) {\n-                        monster.lockMonster();\n-                        try {\n-                            monster.switchController(chr, monster.isControllerHasAggro());\n-                        } finally {\n-                            monster.unlockMonster();\n-                        }\n+                        monster.aggroClearDamages();\n+                        monster.aggroMonsterDamage(chr, 1);\n+                        \n+                        monster.aggroSwitchController(chr, true);\n                     }\n                 }\n             }\n-            byte direction = slea.readByte();\n-            chr.getMap().broadcastMessage(chr, MaplePacketCreator.showBuffeffect(chr.getId(), skillid, chr.getSkillLevel(skillid), direction), false);\n+            byte direction = slea.readByte();   // thanks MedicOP for pointing some 3rd-party related issues with Magnet\n+            chr.getMap().broadcastMessage(chr, MaplePacketCreator.showBuffeffect(chr.getId(), skillid, chr.getSkillLevel(skillid), 1, direction), false);\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         } else if (skillid == Brawler.MP_RECOVERY) {// MP Recovery"}, {"sha": "9a67b895a243df587cbd27977122a21ade51caa6", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -191,7 +191,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 damage -= bouncedamage;\n                 map.damageMonster(chr, attacker, bouncedamage);\n                 map.broadcastMessage(chr, MaplePacketCreator.damageMonster(oid, bouncedamage), false, true);\n-                chr.checkMonsterAggro(attacker);\n+                attacker.aggroMonsterDamage(chr, bouncedamage);\n             }\n             if (attacker != null && damagefrom == -1 && chr.getBuffedValue(MapleBuffStat.BODY_PRESSURE) != null) {\n                 Skill skill = SkillFactory.getSkill(Aran.BODY_PRESSURE);"}, {"sha": "c2f2224afd6f13b7d352c6b936cfd22282f7b773", "filename": "src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "status": "added", "additions": 371, "deletions": 0, "changes": 371, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleMonsterAggroCoordinator.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -0,0 +1,371 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import constants.ServerConstants;\n+import client.MapleCharacter;\n+import java.util.concurrent.ScheduledFuture;\n+import net.server.Server;\n+import net.server.audit.LockCollector;\n+import server.life.MapleMonster;\n+import server.maps.MapleMap;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.TimerManager;\n+import tools.Pair;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleMonsterAggroCoordinator {\n+    \n+    private MonitoredReentrantLock lock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MAP_AGGRO);\n+    private MonitoredReentrantLock idleLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MAP_AGGRO_IDLE, true);\n+    private long lastStopTime = Server.getInstance().getCurrentTime();\n+    \n+    private ScheduledFuture<?> aggroMonitor = null;\n+    \n+    private Map<MapleMonster, Map<Integer, PlayerAggroEntry>> mobAggroEntries = new HashMap<>();\n+    private Map<MapleMonster, List<PlayerAggroEntry>> mobSortedAggros = new HashMap<>();\n+    \n+    private class PlayerAggroEntry {\n+        protected int cid;\n+        protected int averageDamage = 0;\n+        protected int currentDamageInstances = 0;\n+        protected long accumulatedDamage = 0;\n+        \n+        protected int expireStreak = 0;\n+        protected int updateStreak = 0;\n+        protected int toNextUpdate = 0;\n+        protected int entryRank = -1;\n+        \n+        protected PlayerAggroEntry(int cid) {\n+            this.cid = cid;\n+        }\n+    }\n+    \n+    public void stopAggroCoordinator() {\n+        idleLock.lock();\n+        try {\n+            if (aggroMonitor == null) return;\n+            \n+            aggroMonitor.cancel(false);\n+            aggroMonitor = null;\n+        } finally {\n+            idleLock.unlock();\n+        }\n+        \n+        lastStopTime = Server.getInstance().getCurrentTime();\n+    }\n+    \n+    public void startAggroCoordinator() {\n+        idleLock.lock();\n+        try {\n+            if (aggroMonitor != null) return;\n+            \n+            aggroMonitor = TimerManager.getInstance().register(new Runnable() {\n+                @Override\n+                public void run() {\n+                    runAggroUpdate(1);\n+                    runSortLeadingCharactersAggro();\n+                }\n+            }, ServerConstants.MOB_STATUS_AGGRO_INTERVAL, ServerConstants.MOB_STATUS_AGGRO_INTERVAL);\n+        } finally {\n+            idleLock.unlock();\n+        }\n+        \n+        int timeDelta = (int) Math.ceil((Server.getInstance().getCurrentTime() - lastStopTime) / ServerConstants.MOB_STATUS_AGGRO_INTERVAL);\n+        if (timeDelta > 0) {\n+            runAggroUpdate(timeDelta);\n+        }\n+    }\n+    \n+    private static void updateEntryExpiration(PlayerAggroEntry pae) {\n+        pae.toNextUpdate = (int) Math.ceil((120000L / ServerConstants.MOB_STATUS_AGGRO_INTERVAL) / Math.pow(2, pae.expireStreak + pae.currentDamageInstances));\n+    }\n+    \n+    private static void insertEntryDamage(PlayerAggroEntry pae, int damage) {\n+        synchronized (pae) {\n+            long totalDamage = pae.averageDamage;\n+            totalDamage *= pae.currentDamageInstances;\n+            totalDamage += damage;\n+\n+            pae.expireStreak = 0;\n+            pae.updateStreak = 0;\n+            updateEntryExpiration(pae);\n+\n+            pae.currentDamageInstances += 1;\n+            pae.averageDamage = (int)(totalDamage / pae.currentDamageInstances);\n+            pae.accumulatedDamage = totalDamage;\n+        }\n+    }\n+    \n+    private static boolean expiredAfterUpdateEntryDamage(PlayerAggroEntry pae, int deltaTime) {\n+        synchronized (pae) {\n+            pae.updateStreak += 1;\n+            pae.toNextUpdate -= deltaTime;\n+            \n+            if (pae.toNextUpdate <= 0) {    // reached dmg instance expire time\n+                pae.expireStreak += 1;\n+                updateEntryExpiration(pae);\n+\n+                pae.currentDamageInstances -= 1;\n+                if (pae.currentDamageInstances < 1) {   // expired aggro for this player\n+                    return true;\n+                }\n+                pae.accumulatedDamage = pae.averageDamage * pae.currentDamageInstances;\n+            }\n+            \n+            return false;\n+        }\n+    }\n+    \n+    public void addAggroDamage(MapleMonster mob, int cid, int damage) { // assumption: should not trigger after dispose()\n+        if (!mob.isAlive()) return;\n+        \n+        List<PlayerAggroEntry> sortedAggro = mobSortedAggros.get(mob);\n+        Map<Integer, PlayerAggroEntry> mobAggro = mobAggroEntries.get(mob);\n+        if (mobAggro == null) {\n+            if (lock.tryLock()) {   // can run unreliably, as fast as possible... try lock that is!\n+                try {\n+                    mobAggro = mobAggroEntries.get(mob);\n+                    if (mobAggro == null) {\n+                        mobAggro = new HashMap<>();\n+                        mobAggroEntries.put(mob, mobAggro);\n+                        \n+                        sortedAggro = new LinkedList<>();\n+                        mobSortedAggros.put(mob, sortedAggro);\n+                    } else {\n+                        sortedAggro = mobSortedAggros.get(mob);\n+                    }\n+                } finally {\n+                    lock.unlock();\n+                }\n+            } else {\n+                return;\n+            }\n+        }\n+        \n+        PlayerAggroEntry aggroEntry = mobAggro.get(cid);\n+        if (aggroEntry == null) {\n+            aggroEntry = new PlayerAggroEntry(cid);\n+            \n+            synchronized (mobAggro) {\n+                synchronized (sortedAggro) {\n+                    PlayerAggroEntry mappedEntry = mobAggro.get(cid);\n+                    \n+                    if (mappedEntry == null) {\n+                        mobAggro.put(aggroEntry.cid, aggroEntry);\n+                        sortedAggro.add(aggroEntry);\n+                    } else {\n+                        aggroEntry = mappedEntry;\n+                    }\n+                }\n+            }\n+        } else if (damage < 1) {\n+            return;\n+        }\n+        \n+        insertEntryDamage(aggroEntry, damage);\n+    }\n+    \n+    private void runAggroUpdate(int deltaTime) {\n+        List<Pair<MapleMonster, Map<Integer, PlayerAggroEntry>>> aggroMobs = new LinkedList<>();\n+        lock.lock();\n+        try {\n+            for (Entry<MapleMonster, Map<Integer, PlayerAggroEntry>> e : mobAggroEntries.entrySet()) {\n+                aggroMobs.add(new Pair<>(e.getKey(), e.getValue()));\n+            }\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n+        for (Pair<MapleMonster, Map<Integer, PlayerAggroEntry>> am : aggroMobs) {\n+            Map<Integer, PlayerAggroEntry> mobAggro = am.getRight();\n+            List<PlayerAggroEntry> sortedAggro = mobSortedAggros.get(am.getLeft());\n+                    \n+            if (sortedAggro != null) {\n+                List<Integer> toRemove = new LinkedList<>();\n+                List<Integer> toRemoveIdx = new ArrayList<>(mobAggro.size());\n+                List<Integer> toRemoveByFetch = new LinkedList<>();\n+\n+                synchronized (mobAggro) {\n+                    synchronized (sortedAggro) {\n+                        for (PlayerAggroEntry pae : mobAggro.values()) {\n+                            if (expiredAfterUpdateEntryDamage(pae, deltaTime)) {\n+                                toRemove.add(pae.cid);\n+                                if (pae.entryRank > -1) toRemoveIdx.add(pae.entryRank);\n+                                else toRemoveByFetch.add(pae.cid);\n+                            }\n+                        }\n+\n+                        if (!toRemove.isEmpty()) {\n+                            for (Integer cid : toRemove) {\n+                                mobAggro.remove(cid);\n+                            }\n+                            \n+                            if (mobAggro.isEmpty()) {   // all aggro on this mob expired\n+                                am.getLeft().aggroResetAggro();\n+                            }\n+                        }\n+\n+                        if (!toRemoveIdx.isEmpty()) {\n+                            Collections.sort(toRemoveIdx, new Comparator<Integer>() {   // last to first indexes\n+                                @Override\n+                                public int compare(Integer p1, Integer p2) {\n+                                    return p1 < p2 ? 1 : p1.equals(p2) ? 0 : -1;\n+                                }\n+                            });\n+\n+                            for (int idx : toRemoveIdx) {\n+                                sortedAggro.remove(idx);\n+                            }\n+                        }\n+                        \n+                        if (!toRemoveByFetch.isEmpty()) {\n+                            for (Integer cid : toRemoveByFetch) {\n+                                for (int i = 0; i < sortedAggro.size(); i++) {\n+                                    if (cid.equals(sortedAggro.get(i).cid)) {\n+                                        sortedAggro.remove(i);\n+                                        break;\n+                                    }\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void insertionSortAggroList(List<PlayerAggroEntry> paeList) {\n+        for (int i = 1; i < paeList.size(); i++) {\n+            PlayerAggroEntry pae = paeList.get(i);\n+            long curAccDmg = pae.accumulatedDamage;\n+\n+            int j = i - 1;\n+            while (j >= 0 && curAccDmg > paeList.get(j).accumulatedDamage) {\n+                j -= 1;\n+            }\n+\n+            j += 1;\n+            if (j != i) {\n+                paeList.remove(i);\n+                paeList.add(j, pae);\n+            }\n+        }\n+\n+        int i = 0;\n+        for (PlayerAggroEntry pae : paeList) {\n+            pae.entryRank = i;\n+            i += 1;\n+        }\n+    }\n+    \n+    public boolean isLeadingCharacterAggro(MapleMonster mob, MapleCharacter player) {\n+        // by assuming the quasi-sorted nature of \"mobAggroList\", this method\n+        // returns whether the player given as parameter can be elected as next aggro leader\n+        \n+        List<PlayerAggroEntry> mobAggroList = mobSortedAggros.get(mob);\n+        if (mobAggroList != null) {\n+            synchronized (mobAggroList) {\n+                mobAggroList = new ArrayList<>(mobAggroList.subList(0, Math.min(mobAggroList.size(), 5)));\n+            }\n+            \n+            MapleMap map = mob.getMap();\n+            for (PlayerAggroEntry pae : mobAggroList) {\n+                MapleCharacter chr = map.getCharacterById(pae.cid);\n+                if (chr != null) {\n+                    if (player.getId() == pae.cid) {\n+                        return true;\n+                    } else if (pae.updateStreak < ServerConstants.MOB_STATUS_AGGRO_PERSISTENCE && chr.isAlive()) {  // verifies currently leading players activity\n+                        return false;\n+                    }\n+                }\n+            }\n+        }\n+        \n+        return false;\n+    }\n+    \n+    public void runSortLeadingCharactersAggro() {\n+        List<List<PlayerAggroEntry>> aggroList;\n+        lock.lock();\n+        try {\n+            aggroList = new ArrayList<>(mobSortedAggros.values());\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n+        for (List<PlayerAggroEntry> mobAggroList : aggroList) {\n+            synchronized (mobAggroList) {\n+                insertionSortAggroList(mobAggroList);\n+            }\n+        }\n+    }\n+    \n+    public void removeAggroEntries(MapleMonster mob) {\n+        lock.lock();\n+        try {\n+            mobAggroEntries.remove(mob);\n+            mobSortedAggros.remove(mob);\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+    \n+    public void dispose() {\n+        stopAggroCoordinator();\n+        \n+        lock.lock();\n+        try {\n+            mobAggroEntries.clear();\n+            mobSortedAggros.clear();\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n+        LockCollector.getInstance().registerDisposeAction(new Runnable() {\n+            @Override\n+            public void run() {\n+                emptyLocks();\n+            }\n+        });\n+    }\n+    \n+    private void emptyLocks() {\n+        lock = lock.dispose();\n+    }\n+}"}, {"sha": "2969cb7ce4043e0f887c6c827f1fcd576734392a", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 29, "deletions": 4, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -39,6 +39,7 @@\n import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n+import net.server.PlayerStorage;\n import net.server.Server;\n import net.server.channel.Channel;\n import tools.DatabaseConnection;\n@@ -109,11 +110,11 @@ public MapleGuild(int guildid, int world) {\n             con.close();\n         } catch (SQLException se) {\n             se.printStackTrace();\n-            System.out.println(\"Unable to read guild information from sql\" + se);\n+            System.out.println(\"Unable to read guild information from sql: \" + se);\n         }\n     }\n \n-    public void buildNotifications() {\n+    private void buildNotifications() {\n         if (!bDirty) {\n             return;\n         }\n@@ -260,10 +261,10 @@ public String getName() {\n         return name;\n     }\n \n-    public java.util.Collection<MapleGuildCharacter> getMembers() {\n+    public List<MapleGuildCharacter> getMembers() {\n         membersLock.lock();\n         try {\n-            return java.util.Collections.unmodifiableCollection(members);\n+            return new ArrayList<>(members);\n         } finally {\n             membersLock.unlock();\n         }\n@@ -277,6 +278,30 @@ public int getSignature() {\n         return signature;\n     }\n \n+    public void broadcastNameChanged() {\n+        PlayerStorage ps = Server.getInstance().getWorld(world).getPlayerStorage();\n+        \n+        for (MapleGuildCharacter mgc : getMembers()) {\n+            MapleCharacter chr = ps.getCharacterById(mgc.getId());\n+            if (chr == null || !chr.isLoggedinWorld()) continue;\n+\n+            byte[] packet = MaplePacketCreator.guildNameChanged(chr.getId(), this.getName());\n+            chr.getMap().broadcastMessage(chr, packet);\n+        }\n+    }\n+    \n+    public void broadcastEmblemChanged() {\n+        PlayerStorage ps = Server.getInstance().getWorld(world).getPlayerStorage();\n+        \n+        for (MapleGuildCharacter mgc : getMembers()) {\n+            MapleCharacter chr = ps.getCharacterById(mgc.getId());\n+            if (chr == null || !chr.isLoggedinWorld()) continue;\n+            \n+            byte[] packet = MaplePacketCreator.guildMarkChanged(chr.getId(), this);\n+            chr.getMap().broadcastMessage(chr, packet);\n+        }\n+    }\n+    \n     public void broadcast(final byte[] packet) {\n         broadcast(packet, -1, BCOp.NONE);\n     }"}, {"sha": "df5a70799f454b3ff510aaffb93325bc1bbb45d3", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -612,7 +612,15 @@ public void setGuildAndRank(int cid, int guildid, int rank) {\n             mc.saveGuildStatus();\n         }\n         if (bDifferentGuild) {\n-            mc.broadcastStance();\n+            if (mc.isLoggedinWorld()) {\n+                MapleGuild guild = Server.getInstance().getGuild(guildid);\n+                if (guild != null) {\n+                    mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildNameChanged(cid, guild.getName()));\n+                    mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildMarkChanged(cid, guild));\n+                } else {\n+                    mc.getMap().broadcastMessage(mc, MaplePacketCreator.guildNameChanged(cid, \"\"));\n+                }\n+            }\n         }\n     }\n "}, {"sha": "10984129e19ec04a33c31f938df1ec04bd61271b", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -237,6 +237,15 @@ public boolean canHold(int itemid, int quantity) {\n                 return intList;\n         }\n         \n+        public boolean canHoldAll(List<Double> itemids) {\n+                List<Double> quantity = new LinkedList<>();\n+                for (int i = 0; i < itemids.size(); i++) {\n+                        quantity.add(1.0);\n+                }\n+            \n+                return canHoldAll(itemids, quantity);\n+        }\n+        \n         public boolean canHoldAll(List<Double> itemids, List<Double> quantity) {\n                 return canHoldAll(convertToIntegerArray(itemids), convertToIntegerArray(quantity), true);\n         }\n@@ -554,8 +563,6 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n \n \t\t\tif(expires >= 0)\n \t\t\t\titem.setExpiration(System.currentTimeMillis() + expires);\n-                        \n-                        item.setPetId(petId);\n \n \t\t\tif (!MapleInventoryManipulator.checkSpace(c, id, quantity, \"\")) {\n \t\t\t\tc.getPlayer().dropMessage(1, \"Your inventory is full. Please remove an item from your \" + ItemConstants.getInventoryType(id).name() + \" inventory.\");"}, {"sha": "10ffc8070c442d8c6d7248121fe7c857a20a7d7a", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -229,7 +229,11 @@ public void giveEventPlayersMeso(int gain, int mapId) {\n                 \n \t}\n \n-\tpublic synchronized void registerPlayer(final MapleCharacter chr) {\n+        public synchronized void registerPlayer(final MapleCharacter chr) {\n+                registerPlayer(chr, true);\n+        }\n+        \n+\tpublic synchronized void registerPlayer(final MapleCharacter chr, boolean runEntryScript) {\n \t\tif (chr == null || !chr.isLoggedinWorld() || disposed) {\n \t\t\treturn;\n \t\t}\n@@ -246,10 +250,12 @@ public synchronized void registerPlayer(final MapleCharacter chr) {\n                         wL.unlock();\n                 }\n                 \n-                try {\n-                        em.getIv().invokeFunction(\"playerEntry\", EventInstanceManager.this, chr);\n-                } catch (ScriptException | NoSuchMethodException ex) {\n-                        ex.printStackTrace();\n+                if (runEntryScript) {\n+                        try {\n+                                em.getIv().invokeFunction(\"playerEntry\", EventInstanceManager.this, chr);\n+                        } catch (ScriptException | NoSuchMethodException ex) {\n+                                ex.printStackTrace();\n+                        }\n                 }\n \t}  \n         \n@@ -372,7 +378,7 @@ public void registerExpedition(MapleExpedition exped) {\n         private void registerExpeditionTeam(MapleExpedition exped, int recruitMap) {\n \t\texpedition = exped;\n                 \n-                for (MapleCharacter chr: exped.getMembers()) {\n+                for (MapleCharacter chr: exped.getActiveMembers()) {\n                         if (chr.getMapId() == recruitMap) {\n                                 registerPlayer(chr);\n                         }\n@@ -628,18 +634,18 @@ public synchronized void dispose(boolean shutdown) {    // should not trigger an\n                 sL.lock();\n                 try {\n                         if(!eventCleared) em.disposeInstance(name);\n-                        em = null;\n                 } finally {\n                         sL.unlock();\n                 }\n                 \n                 TimerManager.getInstance().schedule(new Runnable() {\n                         @Override\n                         public void run() {\n-                                mapFactory.dispose();   // reactors issue on dispose event maps found thanks to MedicOP\n+                                mapFactory.dispose();   // issues from instantly disposing some event objects found thanks to MedicOP\n                                 wL.lock();\n                                 try {\n                                         mapFactory = null;\n+                                        em = null;\n                                 } finally {\n                                         wL.unlock();\n                                 }\n@@ -675,7 +681,6 @@ public void schedule(final String methodName, long delay) {\n                                         @Override\n                                         public void run() {\n                                                 try {\n-                                                        if(em == null) return;\n                                                         em.getIv().invokeFunction(methodName, EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         ex.printStackTrace();"}, {"sha": "b91ce46206c6b8a875d79da6ea59fb293507c61a", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 43, "deletions": 19, "changes": 62, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -22,7 +22,6 @@\n package scripting.event;\n \n import java.util.Collection;\n-import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n@@ -116,13 +115,16 @@ public void cancel() {  // make sure to only call this when there are NO PLAYERS\n             ex.printStackTrace();\n         }\n         \n+        Collection<EventInstanceManager> eimList;\n         synchronized(instances) {\n-            for(EventInstanceManager eim : instances.values()) {\n-                eim.dispose(true);\n-            }\n+            eimList = getInstances();\n             instances.clear();\n         }\n         \n+        for(EventInstanceManager eim : eimList) {\n+            eim.dispose(true);\n+        }\n+        \n         List<EventInstanceManager> readyEims;\n         queueLock.lock();\n         try {\n@@ -253,7 +255,9 @@ public EventInstanceManager getInstance(String name) {\n     }\n \n     public Collection<EventInstanceManager> getInstances() {\n-        return Collections.unmodifiableCollection(instances.values());\n+        synchronized (instances) {\n+            return new LinkedList<>(instances.values());\n+        }\n     }\n \n     public EventInstanceManager newInstance(String name) {\n@@ -265,7 +269,13 @@ public EventInstanceManager newInstance(String name) {\n             ret.setName(name);\n         }\n         \n-        instances.put(name, ret);\n+        synchronized (instances) {\n+            if (instances.containsKey(name)) {\n+                return null;\n+            }\n+            \n+            instances.put(name, ret);\n+        }\n         return ret;\n     }\n \n@@ -274,7 +284,10 @@ public void disposeInstance(final String name) {\n             @Override\n             public void run() {\n                 freeLobbyInstance(name);\n-                instances.remove(name);\n+                \n+                synchronized (instances) {\n+                    instances.remove(name);\n+                }\n             }\n         }, ServerConstants.EVENT_LOBBY_DELAY * 1000);\n     }\n@@ -379,14 +392,17 @@ public boolean startInstance(int lobbyId, MapleExpedition exped, MapleCharacter\n                             if(!startLobbyInstance(lobbyId)) return false;\n                         }\n                         \n-                        EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", leader.getClient().getChannel()));\n-                        if(eim == null) {\n+                        EventInstanceManager eim;\n+                        try {\n+                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", leader.getClient().getChannel()));\n+                            instanceLocks.put(eim.getName(), lobbyId);\n+                        } catch (NullPointerException npe) {\n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n                             return false;\n                         }\n-                        instanceLocks.put(eim.getName(), lobbyId);\n+                        \n                         eim.setLeader(leader);\n \n                         exped.start();\n@@ -442,14 +458,16 @@ public boolean startInstance(int lobbyId, MapleCharacter chr, MapleCharacter lea\n                             }\n                         }\n                         \n-                        EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId()));\n-                        if(eim == null) {\n+                        EventInstanceManager eim;\n+                        try {\n+                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId()));\n+                            instanceLocks.put(eim.getName(), lobbyId);\n+                        } catch (NullPointerException npe) {\n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n                             return false;\n                         }\n-                        instanceLocks.put(eim.getName(), lobbyId);\n                         eim.setLeader(leader);\n \n                         if(chr != null) eim.registerPlayer(chr);\n@@ -500,14 +518,17 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, MapleC\n                             if(!startLobbyInstance(lobbyId)) return false;\n                         }\n                         \n-                        EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n-                        if(eim == null) {\n+                        EventInstanceManager eim;\n+                        try {\n+                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n+                            instanceLocks.put(eim.getName(), lobbyId);\n+                        } catch (NullPointerException npe) {\n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n                             return false;\n                         }\n-                        instanceLocks.put(eim.getName(), lobbyId);\n+                        \n                         eim.setLeader(leader);\n \n                         eim.registerParty(party, map);\n@@ -559,14 +580,17 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n                             if(!startLobbyInstance(lobbyId)) return false;\n                         }\n                         \n-                        EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId()));\n-                        if(eim == null) {\n+                        EventInstanceManager eim;\n+                        try {\n+                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId()));\n+                            instanceLocks.put(eim.getName(), lobbyId);\n+                        } catch (NullPointerException npe) {\n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n                             return false;\n                         }\n-                        instanceLocks.put(eim.getName(), lobbyId);\n+                        \n                         eim.setLeader(leader);\n \n                         eim.registerParty(party, map);"}, {"sha": "0a8746270c31c50aaf3e30fa1b6e05461797f8d8", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -100,6 +100,7 @@ public String getScriptName() {\n \n \tpublic void dispose() {\n \t\tNPCScriptManager.getInstance().dispose(this);\n+                getClient().announce(MaplePacketCreator.enableActions());\n \t}\n \n \tpublic void sendNext(String text) {"}, {"sha": "f2110b31db053e310e600d5a6eb9d7e7853d38d9", "filename": "src/server/MapleTrade.java", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/MapleTrade.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/MapleTrade.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleTrade.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -202,6 +202,10 @@ public int getExchangeMesos(){\n     \treturn exchangeMeso;\n     }\n     \n+    private boolean fitsMeso() {\n+        return chr.canHoldMeso(exchangeMeso - getFee(exchangeMeso));\n+    }\n+    \n     private boolean fitsInInventory() {\n         List<Pair<Item, MapleInventoryType>> tradeItems = new LinkedList<>();\n         for (Item item : exchangeItems) {\n@@ -218,6 +222,18 @@ public static void completeTrade(MapleCharacter c) {\n         if (partner.isLocked()) {\n             local.complete1();\n             partner.complete1();\n+            if (!local.fitsMeso()) {\n+                cancelTrade(c);\n+                c.message(\"There is not enough meso inventory space to complete the trade.\");\n+                partner.getChr().message(\"Partner does not have enough meso inventory space to complete the trade.\");\n+                return;\n+            }\n+            else if (!partner.fitsMeso()) {\n+                cancelTrade(c);\n+                c.message(\"Partner does not have enough meso inventory space to complete the trade.\");\n+                partner.getChr().message(\"There is not enough meso inventory space to complete the trade.\");\n+                return;\n+            }\n             if (!local.fitsInInventory()) {\n                 cancelTrade(c);\n                 c.message(\"There is not enough inventory space to complete the trade.\");"}, {"sha": "341d6f649a053b204f83f4186ab419be01771911", "filename": "src/server/expeditions/MapleExpedition.java", "status": "modified", "additions": 78, "deletions": 36, "changes": 114, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/expeditions/MapleExpedition.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/expeditions/MapleExpedition.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/expeditions/MapleExpedition.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -23,11 +23,17 @@\n package server.expeditions;\n \n import java.text.SimpleDateFormat;\n-import java.util.ArrayList;\n import java.util.Date;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.CopyOnWriteArrayList;\n import java.util.concurrent.ScheduledFuture;\n \n+import net.server.PlayerStorage;\n import net.server.Server;\n import server.TimerManager;\n import server.life.MapleMonster;\n@@ -78,18 +84,18 @@\n \tprivate MapleExpeditionType type;\n \tprivate boolean registering;\n \tprivate MapleMap startMap;\n-\tprivate ArrayList<String> bossLogs;\n+\tprivate List<String> bossLogs;\n \tprivate ScheduledFuture<?> schedule;\n-\tprivate List<MapleCharacter> members = new ArrayList<>();\n-\tprivate List<Integer> banned = new ArrayList<>();\n+\tprivate Map<Integer, String> members = new ConcurrentHashMap<>();\n+\tprivate List<Integer> banned = new CopyOnWriteArrayList<>();\n \tprivate long startTime;\n \n \tpublic MapleExpedition(MapleCharacter player, MapleExpeditionType met) {\n \t\tleader = player;\n-\t\tmembers.add(leader);\n+\t\tmembers.put(player.getId(), player.getName());\n                 startMap = player.getMap();\n \t\ttype = met;\n-\t\tbossLogs = new ArrayList<String>();\n+\t\tbossLogs = new CopyOnWriteArrayList<>();\n \t\tbeginRegistration();\n \t}\n \n@@ -109,7 +115,7 @@ private void scheduleRegistrationEnd() {\n \t\t\t@Override\n \t\t\tpublic void run() {\n \t\t\t\tif (registering){\n-\t\t\t\t\tleader.getClient().getChannelServer().getExpeditions().remove(exped);\n+                                        startMap.getChannelServer().getExpeditions().remove(exped);\n \t\t\t\t\tstartMap.broadcastMessage(MaplePacketCreator.serverNotice(6, \"[Expedition] The time limit has been reached. Expedition has been disbanded.\"));\n                                         \n                                         dispose(false);\n@@ -134,7 +140,7 @@ public void start(){\n \t\tbroadcastExped(MaplePacketCreator.removeClock());\n \t\tbroadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] The expedition has started! Good luck, brave heroes!\"));\n \t\tstartTime = System.currentTimeMillis();\n-\t\tServer.getInstance().broadcastGMMessage(leader.getWorld(), MaplePacketCreator.serverNotice(6, \"[Expedition] \" + type.toString() + \" Expedition started with leader: \" + leader.getName()));\n+\t\tServer.getInstance().broadcastGMMessage(startMap.getWorld(), MaplePacketCreator.serverNotice(6, \"[Expedition] \" + type.toString() + \" Expedition started with leader: \" + leader.getName()));\n \t}\n \n \tpublic String addMember(MapleCharacter player) {\n@@ -147,22 +153,21 @@ public String addMember(MapleCharacter player) {\n \t\tif (members.size() >= type.getMaxSize()){ //Would be a miracle if anybody ever saw this\n \t\t\treturn \"Sorry, this expedition is full!\";\n \t\t}\n-\t\tif (members.add(player)){\n-                        player.announce(MaplePacketCreator.getClock((int)(startTime - System.currentTimeMillis()) / 1000));\n-\t\t\tbroadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has joined the expedition!\"));\n-\t\t\treturn \"You have registered for the expedition successfully!\";\n-\t\t} \n-\t\treturn \"Sorry, something went really wrong. Report this on the forum with a screenshot!\";\n+                \n+                members.put(player.getId(), player.getName());\n+                player.announce(MaplePacketCreator.getClock((int)(startTime - System.currentTimeMillis()) / 1000));\n+                broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has joined the expedition!\"));\n+                return \"You have registered for the expedition successfully!\";\n \t}\n \n-\tprivate void broadcastExped(byte [] data){\n-\t\tfor (MapleCharacter member : members){\n-\t\t\tmember.getClient().announce(data);\n+\tprivate void broadcastExped(byte[] packet){\n+\t\tfor (MapleCharacter chr : getActiveMembers()){\n+                        chr.announce(packet);\n \t\t}\n \t}\n \n \tpublic boolean removeMember(MapleCharacter chr) {\n-\t\tif(members.remove(chr)) {\n+\t\tif(members.remove(chr.getId()) != null) {\n                     chr.announce(MaplePacketCreator.removeClock());\n                     broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getName() + \" has left the expedition.\"));\n                     chr.dropMessage(6, \"[Expedition] You have left this expedition.\");\n@@ -175,9 +180,42 @@ public boolean removeMember(MapleCharacter chr) {\n \tpublic MapleExpeditionType getType() {\n \t\treturn type;\n \t}\n-\n-\tpublic List<MapleCharacter> getMembers() {\n-\t\treturn members;\n+        \n+        public List<MapleCharacter> getActiveMembers() {    // thanks MedicOP for figuring out an issue with broadcasting packets to offline members\n+                PlayerStorage ps = startMap.getWorldServer().getPlayerStorage();\n+                \n+                List<MapleCharacter> activeMembers = new LinkedList<>();\n+\t\tfor (Integer chrid : getMembers().keySet()){\n+                        MapleCharacter chr = ps.getCharacterById(chrid);\n+                        if (chr != null && chr.isLoggedinWorld()) {\n+                                activeMembers.add(chr);\n+                        }\n+\t\t}\n+                \n+                return activeMembers;\n+        }\n+        \n+        public Map<Integer, String> getMembers() {\n+                return new HashMap<>(members);\n+\t}\n+        \n+        public List<Entry<Integer, String>> getMemberList() {\n+                List<Entry<Integer, String>> memberList = new LinkedList<>();\n+                Entry<Integer, String> leaderEntry = null;\n+                \n+                for (Entry<Integer, String> e : getMembers().entrySet()) {\n+                        if (!isLeader(e.getKey())) {\n+                                memberList.add(e);\n+                        } else {\n+                                leaderEntry = e;\n+                        }\n+                }\n+                \n+                if (leaderEntry != null) {\n+                        memberList.add(0, leaderEntry);\n+                }\n+            \n+                return memberList;\n \t}\n \n \tpublic MapleCharacter getLeader(){\n@@ -189,16 +227,15 @@ public MapleMap getRecruitingMap() {\n         }\n \n \tpublic boolean contains(MapleCharacter player) {\n-\t\tfor (MapleCharacter member : members){\n-\t\t\tif (member.getId() == player.getId()){\n-\t\t\t\treturn true;\n-\t\t\t}\n-\t\t}\n-\t\treturn false;\n+                return members.containsKey(player.getId());\n \t}\n \n \tpublic boolean isLeader(MapleCharacter player) {\n-\t\treturn leader.equals(player);\n+\t\treturn isLeader(player.getId());\n+\t}\n+        \n+        public boolean isLeader(int playerid) {\n+\t\treturn leader.getId() == playerid;\n \t}\n \n \tpublic boolean isRegistering(){\n@@ -209,23 +246,28 @@ public boolean isInProgress(){\n \t\treturn !registering;\n \t}\n \n-\tpublic void ban(MapleCharacter player) {\n-\t\tif (!banned.contains(player.getId())) {\n-\t\t\tbanned.add(player.getId());\n-\t\t\tmembers.remove(player);\n+\tpublic void ban(Entry<Integer, String> chr) {\n+                int cid = chr.getKey();\n+                \n+\t\tif (!banned.contains(cid)) {\n+\t\t\tbanned.add(cid);\n+\t\t\tmembers.remove(cid);\n                         \n-                        broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + player.getName() + \" has been banned from the expedition.\"));\n+                        broadcastExped(MaplePacketCreator.serverNotice(6, \"[Expedition] \" + chr.getValue() + \" has been banned from the expedition.\"));\n                         \n-                        player.announce(MaplePacketCreator.removeClock());\n-                        player.dropMessage(6, \"[Expedition] You have been banned from this expedition.\");\n+                        MapleCharacter player = startMap.getWorldServer().getPlayerStorage().getCharacterById(cid);\n+                        if (player != null && player.isLoggedinWorld()) {\n+                                player.announce(MaplePacketCreator.removeClock());\n+                                player.dropMessage(6, \"[Expedition] You have been banned from this expedition.\");\n+                        }\n \t\t}\n \t}\n \n \tpublic long getStartTime(){\n \t\treturn startTime;\n \t}\n \t\n-\tpublic ArrayList<String> getBossLogs(){\n+\tpublic List<String> getBossLogs(){\n \t\treturn bossLogs;\n \t}\n \t"}, {"sha": "92d0b141efc34c94b2bc8de544073318f5acea2a", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 261, "deletions": 135, "changes": 396, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -55,7 +55,6 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicLong;\n import net.server.audit.locks.MonitoredReentrantLock;\n-import net.server.Server;\n import net.server.channel.Channel;\n import net.server.world.World;\n import net.server.world.MapleParty;\n@@ -72,6 +71,7 @@\n import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import net.server.coordinator.MapleMonsterAggroCoordinator;\n \n public class MapleMonster extends AbstractLoadedMapleLife {\n     private ChangeableStats ostats = null;  //unused, v83 WZs offers no support for changeable stats.\n@@ -100,6 +100,7 @@\n     private MonitoredReentrantLock monsterLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB, true);\n     private MonitoredReentrantLock statiLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB_STATI);\n     private MonitoredReentrantLock animationLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB_ANI);\n+    private MonitoredReentrantLock aggroUpdateLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB_AGGRO);\n \n     public MapleMonster(int id, MapleMonsterStats stats) {\n         super(id);\n@@ -578,31 +579,10 @@ private void giveExpToCharacter(MapleCharacter attacker, float exp, boolean isKi\n         }\n     }\n \n-    private Pair<MapleCharacter, Boolean> removeController() {\n-        this.lockMonster();\n-        try {\n-            MapleCharacter chrController = getController();\n-            boolean hadAggro = isControllerHasAggro();\n-            \n-            if (chrController != null) { // this can/should only happen when a hidden gm attacks the monster\n-                chrController.announce(MaplePacketCreator.stopControllingMonster(this.getObjectId()));\n-                chrController.stopControllingMonster(this);\n-            }\n-            \n-            setController(null);\n-            setControllerHasAggro(false);\n-            setControllerKnowsAboutAggro(false);\n-            \n-            return new Pair<>(chrController, hadAggro);\n-        } finally {\n-            this.unlockMonster();\n-        }\n-    }\n-    \n     public MapleCharacter killBy(final MapleCharacter killer) {\n         distributeExperience(killer != null ? killer.getId() : 0);\n         \n-        final Pair<MapleCharacter, Boolean> lastController = removeController();\n+        final Pair<MapleCharacter, Boolean> lastController = aggroRemoveController();\n         final List<Integer> toSpawn = this.getRevives();\n         if (toSpawn != null) {\n             final MapleMap reviveMap = map;\n@@ -675,7 +655,7 @@ public void run() {\n                                     reviveMap.killMonster(reviveMap.getMonsterById(i), killer, true);\n                                 }\n                             } else if (controller != null) {\n-                                mob.switchController(controller, aggro);\n+                                mob.aggroSwitchController(controller, aggro);\n                             }\n                             \n                             if(eim != null) {\n@@ -725,10 +705,12 @@ public void dispatchMonsterKilled(boolean hasKiller) {\n     }\n     \n     private synchronized void processMonsterKilled(boolean hasKiller) {\n-        if(!hasKiller) {\n+        if(!hasKiller) {    // players won't gain EXP from a mob that has no killer, but a quest count they should\n             dispatchUpdateQuestMobCount();\n         }\n         \n+        this.aggroClearDamages();\n+        \n         MonsterListener[] listenersList;\n         statiLock.lock();\n         try {\n@@ -794,46 +776,7 @@ public int getHighestDamagerId() {\n     public boolean isAlive() {\n         return this.hp.get() > 0;\n     }\n-\n-    public MapleCharacter getController() {\n-        monsterLock.lock();\n-        try {\n-            return controller.get();\n-        } finally {\n-            monsterLock.unlock();\n-        }\n-    }\n-\n-    public void setController(MapleCharacter controller) {\n-        monsterLock.lock();\n-        try {\n-            this.controller = new WeakReference<>(controller);\n-        } finally {\n-            monsterLock.unlock();\n-        }\n-    }\n-\n-    public void switchController(MapleCharacter newController, boolean immediateAggro) {\n-        this.lockMonster();\n-        try {\n-            MapleCharacter controllers = getController();\n-            if (controllers == newController) {\n-                return;\n-            }\n-            \n-            removeController();\n-            \n-            newController.controlMonster(this, immediateAggro);\n-            setController(newController);\n-            if (immediateAggro) {\n-                setControllerHasAggro(true);\n-            }\n-            setControllerKnowsAboutAggro(false);\n-        } finally {\n-            this.unlockMonster();\n-        }\n-    }\n-\n+    \n     public void addListener(MonsterListener listener) {\n         statiLock.lock();\n         try {\n@@ -843,46 +786,28 @@ public void addListener(MonsterListener listener) {\n         }\n     }\n \n+    public MapleCharacter getController() {\n+        return controller.get();\n+    }\n+\n+    private void setController(MapleCharacter controller) {\n+        this.controller = new WeakReference<>(controller);\n+    }\n+    \n     public boolean isControllerHasAggro() {\n-        monsterLock.lock();\n-        try {\n-            return fake ? false : controllerHasAggro;\n-        } finally {\n-            monsterLock.unlock();\n-        }\n+        return fake ? false : controllerHasAggro;\n     }\n \n-    public void setControllerHasAggro(boolean controllerHasAggro) {\n-        monsterLock.lock();\n-        try {\n-            if (fake) {\n-                return;\n-            }\n-            this.controllerHasAggro = controllerHasAggro;\n-        } finally {\n-            monsterLock.unlock();\n-        }\n+    private void setControllerHasAggro(boolean controllerHasAggro) {\n+        if (!fake) this.controllerHasAggro = controllerHasAggro;\n     }\n \n     public boolean isControllerKnowsAboutAggro() {\n-        monsterLock.lock();\n-        try {\n-            return fake ? false : controllerKnowsAboutAggro;\n-        } finally {\n-            monsterLock.unlock();\n-        }\n+        return fake ? false : controllerKnowsAboutAggro;\n     }\n \n-    public void setControllerKnowsAboutAggro(boolean controllerKnowsAboutAggro) {\n-        monsterLock.lock();\n-        try {\n-            if (fake) {\n-                return;\n-            }\n-            this.controllerKnowsAboutAggro = controllerKnowsAboutAggro;\n-        } finally {\n-            monsterLock.unlock();\n-        }\n+    private void setControllerKnowsAboutAggro(boolean controllerKnowsAboutAggro) {\n+        if (!fake) this.controllerKnowsAboutAggro = controllerKnowsAboutAggro;\n     }\n \n     public byte[] makeBossHPBarPacket() {\n@@ -956,15 +881,29 @@ private ElementalEffectiveness getMonsterEffectiveness(Element e) {\n         }\n     }\n \n-    private int broadcastStatusEffect(final MonsterStatusEffect status) {\n-        int animationTime = status.getSkill().getAnimationTime();\n-        byte[] packet = MaplePacketCreator.applyMonsterStatus(getObjectId(), status, null);\n+    private MapleCharacter getActiveController() {\n+        MapleCharacter chr = getController();\n+        \n+        if (chr != null && chr.isLoggedinWorld() && chr.getMap() == this.getMap()) {\n+            return chr;\n+        } else {\n+            return null;\n+        }\n+    }\n+    \n+    private void broadcastMonsterStatusMessage(byte[] packet) {\n         map.broadcastMessage(packet, getPosition());\n         \n-        MapleCharacter chrController = getController();\n-        if (chrController != null && !chrController.isMapObjectVisible(this)) {\n-            chrController.getClient().announce(packet);\n+        MapleCharacter chrController = getActiveController();\n+        if (chrController != null && !chrController.isMapObjectVisible(MapleMonster.this)) {\n+            chrController.announce(packet);\n         }\n+    }\n+    \n+    private int broadcastStatusEffect(final MonsterStatusEffect status) {\n+        int animationTime = status.getSkill().getAnimationTime();\n+        byte[] packet = MaplePacketCreator.applyMonsterStatus(getObjectId(), status, null);\n+        broadcastMonsterStatusMessage(packet);\n         \n         return animationTime;\n     }\n@@ -1041,12 +980,7 @@ public boolean applyStatus(MapleCharacter from, final MonsterStatusEffect status\n             public void run() {\n                 if (isAlive()) {\n                     byte[] packet = MaplePacketCreator.cancelMonsterStatus(getObjectId(), status.getStati());\n-                    map.broadcastMessage(packet, getPosition());\n-                    \n-                    MapleCharacter controller = getController();\n-                    if (controller != null && !controller.isMapObjectVisible(MapleMonster.this)) {\n-                        controller.getClient().announce(packet);\n-                    }\n+                    broadcastMonsterStatusMessage(packet);\n                 }\n                 \n                 statiLock.lock();\n@@ -1148,12 +1082,7 @@ public void applyMonsterBuff(final Map<MonsterStatus, Integer> stats, final int\n             public void run() {\n                 if (isAlive()) {\n                     byte[] packet = MaplePacketCreator.cancelMonsterStatus(getObjectId(), stats);\n-                    map.broadcastMessage(packet, getPosition());\n-                    \n-                    MapleCharacter controller = getController();\n-                    if (controller != null && !controller.isMapObjectVisible(MapleMonster.this)) {\n-                        controller.getClient().announce(packet);\n-                    }\n+                    broadcastMonsterStatusMessage(packet);\n                     \n                     statiLock.lock();\n                     try {\n@@ -1168,7 +1097,7 @@ public void run() {\n         };\n         final MonsterStatusEffect effect = new MonsterStatusEffect(stats, null, skill, true);\n         byte[] packet = MaplePacketCreator.applyMonsterStatus(getObjectId(), effect, reflection);\n-        map.broadcastMessage(packet, getPosition());\n+        broadcastMonsterStatusMessage(packet);\n         \n         statiLock.lock();\n         try {\n@@ -1180,11 +1109,6 @@ public void run() {\n             statiLock.unlock();\n         }\n         \n-        MapleCharacter controller = getController();\n-        if (controller != null && !controller.isMapObjectVisible(this)) {\n-            controller.getClient().announce(packet);\n-        }\n-        \n         map.getChannelServer().registerMobStatus(map.getId(), effect, cancelTask, duration);\n     }\n     \n@@ -1193,30 +1117,28 @@ public void refreshMobPosition() {\n     }\n     \n     public void resetMobPosition(Point newPoint) {\n-        removeController();\n+        aggroRemoveController();\n+        \n         setPosition(newPoint);\n         map.broadcastMessage(MaplePacketCreator.moveMonster(this.getObjectId(), false, -1, 0, 0, 0, this.getPosition(), this.getIdleMovement()));\n         map.moveMonster(this, this.getPosition());\n-        map.updateMonsterController(this);\n+        \n+        aggroUpdateController();\n     }\n \n     private void debuffMobStat(MonsterStatus stat) {\n+        MonsterStatusEffect oldEffect;\n         statiLock.lock();\n         try {\n-            if (isBuffed(stat)) {\n-                final MonsterStatusEffect oldEffect = stati.get(stat);\n-                byte[] packet = MaplePacketCreator.cancelMonsterStatus(getObjectId(), oldEffect.getStati());\n-                map.broadcastMessage(packet, getPosition());\n-\n-                MapleCharacter chrController = getController();\n-                if (chrController != null && !chrController.isMapObjectVisible(MapleMonster.this)) {\n-                    chrController.getClient().announce(packet);\n-                }\n-                stati.remove(stat);\n-            }\n+            oldEffect = stati.remove(stat);\n         } finally {\n             statiLock.unlock();\n         }\n+        \n+        if (oldEffect != null) {\n+            byte[] packet = MaplePacketCreator.cancelMonsterStatus(getObjectId(), oldEffect.getStati());\n+            broadcastMonsterStatusMessage(packet);\n+        }\n     }\n     \n     public void debuffMob(int skillid) {\n@@ -1280,7 +1202,11 @@ public boolean isFake() {\n     public MapleMap getMap() {\n         return map;\n     }\n-\n+    \n+    public MapleMonsterAggroCoordinator getMapAggroCoordinator() {\n+        return map.getAggroCoordinator();\n+    }\n+    \n     public List<Pair<Integer, Integer>> getSkills() {\n         return stats.getSkills();\n     }\n@@ -1679,6 +1605,206 @@ public final void changeDifficulty(final int difficulty, boolean pqMob) {\n         changeLevelByDifficulty(difficulty, pqMob);\n     }\n     \n+    private MapleCharacter getNextControllerCandidate() {\n+        int mincontrolled = Integer.MAX_VALUE;\n+        MapleCharacter newController = null;\n+        \n+        int mincontrolleddead = Integer.MAX_VALUE;\n+        MapleCharacter newControllerDead = null;\n+        \n+        for (MapleCharacter chr : getMap().getAllPlayers()) {\n+            if (!chr.isHidden()) {\n+                int ctrlMonsSize = chr.getNumControlledMonsters();\n+\n+                if (chr.isAlive()) {\n+                    if (ctrlMonsSize < mincontrolled) {\n+                        mincontrolled = ctrlMonsSize;\n+                        newController = chr;\n+                    }\n+                } else {\n+                    if (ctrlMonsSize < mincontrolleddead) {\n+                        mincontrolleddead = ctrlMonsSize;\n+                        newControllerDead = chr;\n+                    }\n+                }\n+            }\n+        }\n+        \n+        return newController != null ? newController : newControllerDead;\n+    }\n+    \n+    /**\n+     * Removes controllability status from the current controller of this mob.\n+     * \n+     */\n+    private Pair<MapleCharacter, Boolean> aggroRemoveController() {\n+        MapleCharacter chrController;\n+        boolean hadAggro;\n+        \n+        aggroUpdateLock.lock();\n+        try {\n+            chrController = getActiveController();\n+            hadAggro = isControllerHasAggro();\n+            \n+            this.setController(null);\n+            this.setControllerHasAggro(false);\n+            this.setControllerKnowsAboutAggro(false);\n+        } finally {\n+            aggroUpdateLock.unlock();\n+        }\n+        \n+        if (chrController != null) { // this can/should only happen when a hidden gm attacks the monster\n+            chrController.announce(MaplePacketCreator.stopControllingMonster(this.getObjectId()));\n+            chrController.stopControllingMonster(this);\n+        }\n+        \n+        return new Pair<>(chrController, hadAggro);\n+    }\n+    \n+    /**\n+     * Pass over the mob controllability and updates aggro status on the new\n+     * player controller.\n+     * \n+     */\n+    public void aggroSwitchController(MapleCharacter newController, boolean immediateAggro) {\n+        if (aggroUpdateLock.tryLock()) {\n+            try {\n+                MapleCharacter prevController = getController();\n+                if (prevController == newController) {\n+                    return;\n+                }\n+                \n+                aggroRemoveController();\n+                if (!(newController != null && newController.isLoggedinWorld() && newController.getMap() == this.getMap())) {\n+                    return;\n+                }\n+                \n+                this.setController(newController);\n+                this.setControllerHasAggro(immediateAggro);\n+                this.setControllerKnowsAboutAggro(false);\n+            } finally {\n+                aggroUpdateLock.unlock();\n+            }\n+            \n+            newController.announce(MaplePacketCreator.controlMonster(this, false, immediateAggro));\n+            newController.controlMonster(this);\n+        }\n+    }\n+    \n+    /**\n+     * Automagically finds a new controller for the given monster from the chars\n+     * on the map it is from...\n+     * \n+     */\n+    public void aggroUpdateController() {\n+        MapleCharacter chrController = this.getActiveController();\n+        if (chrController != null && chrController.isAlive()) {\n+            return;\n+        }\n+        \n+        MapleCharacter newController = getNextControllerCandidate();\n+        if (newController == null) {    // was a new controller found? (if not no one is on the map)\n+            return;\n+        }\n+        \n+        this.aggroSwitchController(newController, false);\n+    }\n+    \n+    /**\n+     * Ensures controllability removal of the current player controller, and\n+     * fetches for any player on the map to start controlling in place.\n+     * \n+     */\n+    public void aggroRedirectController() {\n+        this.aggroRemoveController();   // don't care if new controller not found, at least remove current controller\n+        this.aggroUpdateController();\n+    }\n+    \n+    /**\n+     * Returns the current aggro status on the specified player, or null if the\n+     * specified player is currently not this mob's controller.\n+     * \n+     */\n+    public Boolean aggroMoveLifeUpdate(MapleCharacter player) {\n+        MapleCharacter chrController = getController();\n+        if (chrController != null && player.getId() == chrController.getId()) {\n+            boolean aggro = this.isControllerHasAggro();\n+            if (aggro) {\n+                this.setControllerKnowsAboutAggro(true);\n+            }\n+            \n+            return aggro;\n+        } else {\n+            return null;\n+        }\n+    }\n+    \n+    /**\n+     * Refreshes auto aggro for the player passed as parameter, does nothing if\n+     * there is already an active controller for this mob.\n+     * \n+     */\n+    public void aggroAutoAggroUpdate(MapleCharacter player) {\n+        MapleCharacter chrController = this.getActiveController();\n+        \n+        if (chrController == null) {\n+            this.aggroSwitchController(player, true);\n+        } else if (chrController.getId() == player.getId()) {\n+            this.setControllerHasAggro(true);\n+        }\n+    }\n+    \n+    /**\n+     * Applied damage input for this mob, enough damage taken implies\n+     * an aggro target update for the attacker shortly.\n+     * \n+     */\n+    public void aggroMonsterDamage(MapleCharacter attacker, int damage) {\n+        MapleMonsterAggroCoordinator mmac = this.getMapAggroCoordinator();\n+        mmac.addAggroDamage(this, attacker.getId(), damage);\n+        \n+        MapleCharacter chrController = this.getController();    // aggro based on DPS rather than first-come-first-served, now live after suggestions thanks to MedicOP, Thora, Vcoc\n+        if (chrController != attacker) {\n+            if (this.getMapAggroCoordinator().isLeadingCharacterAggro(this, attacker)) {\n+                this.aggroSwitchController(attacker, true);\n+            }\n+            \n+            /*\n+            For some reason, some mobs loses aggro on controllers if other players also attacks them.\n+            Maybe it was intended by Nexon to interchange controllers at every attack...\n+            \n+            else if (chrController != null) {\n+                chrController.announce(MaplePacketCreator.stopControllingMonster(this.getObjectId()));\n+                chrController.announce(MaplePacketCreator.controlMonster(this, false, true));\n+            }\n+            */\n+        } else {\n+            this.setControllerHasAggro(true);\n+        }\n+    }\n+    \n+    /**\n+     * Clears all applied damage input for this mob, doesn't refresh target aggro.\n+     * \n+     */\n+    public void aggroClearDamages() {\n+        this.getMapAggroCoordinator().removeAggroEntries(this);\n+    }\n+\n+    /**\n+     * Clears this mob aggro on the current controller.\n+     * \n+     */\n+    public void aggroResetAggro() {\n+        aggroUpdateLock.lock();\n+        try {\n+            this.setControllerHasAggro(false);\n+            this.setControllerKnowsAboutAggro(false);\n+        } finally {\n+            aggroUpdateLock.unlock();\n+        }\n+    }\n+    \n     public final void disposeLocks() {\n         LockCollector.getInstance().registerDisposeAction(new Runnable() {\n             @Override"}, {"sha": "2a44456481eb22790e94fae68405d81f8f716b1c", "filename": "src/server/life/MapleMonsterInformationProvider.java", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MapleMonsterInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MapleMonsterInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonsterInformationProvider.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -52,8 +52,9 @@ public static MapleMonsterInformationProvider getInstance() {\n \t\treturn instance;\n \t}\n         \n-        private final Map<Integer, List<MonsterDropEntry>> drops = new HashMap<>();        \n+        private final Map<Integer, List<MonsterDropEntry>> drops = new HashMap<>();\n \tprivate final List<MonsterGlobalDropEntry> globaldrops = new ArrayList<>();\n+        private final Map<Integer, List<MonsterGlobalDropEntry>> continentdrops = new HashMap<>();\n         \n         private final Map<Integer, List<Integer>> dropsChancePool = new HashMap<>();    // thanks to ronan\n         private final Set<Integer> hasNoMultiEquipDrops = new HashSet<>();\n@@ -70,9 +71,24 @@ public static MapleMonsterInformationProvider getInstance() {\n \tprotected MapleMonsterInformationProvider() {\n \t\tretrieveGlobal();\n \t}\n-\n-\tpublic final List<MonsterGlobalDropEntry> getGlobalDrop() {\n-\t\treturn globaldrops;\n+        \n+        public final List<MonsterGlobalDropEntry> getRelevantGlobalDrops(int mapid) {\n+                int continentid = mapid / 100000000;\n+            \n+                List<MonsterGlobalDropEntry> contiItems = continentdrops.get(continentid);\n+                if (contiItems == null) {   // continent separated global drops found thanks to marcuswoon\n+                    contiItems = new ArrayList<>();\n+                    \n+                    for (MonsterGlobalDropEntry e : globaldrops) {\n+                        if (e.continentid < 0 || e.continentid == continentid) {\n+                            contiItems.add(e);\n+                        }\n+                    }\n+                    \n+                    continentdrops.put(continentid, contiItems);\n+                }\n+                \n+\t\treturn contiItems;\n \t}\n \n \tprivate void retrieveGlobal() {\n@@ -90,8 +106,7 @@ private void retrieveGlobal() {\n \t\t\t\t\t\tnew MonsterGlobalDropEntry(\n \t\t\t\t\t\t\t\trs.getInt(\"itemid\"),\n \t\t\t\t\t\t\t\trs.getInt(\"chance\"),\n-\t\t\t\t\t\t\t\trs.getInt(\"continent\"),\n-\t\t\t\t\t\t\t\trs.getByte(\"dropType\"),\n+\t\t\t\t\t\t\t\trs.getByte(\"continent\"),\n \t\t\t\t\t\t\t\trs.getInt(\"minimum_quantity\"),\n \t\t\t\t\t\t\t\trs.getInt(\"maximum_quantity\"),\n \t\t\t\t\t\t\t\trs.getShort(\"questid\")));"}, {"sha": "136f219736d002da38d225159a33eaa55e8a64c0", "filename": "src/server/life/MonsterGlobalDropEntry.java", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MonsterGlobalDropEntry.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/life/MonsterGlobalDropEntry.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MonsterGlobalDropEntry.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -25,15 +25,14 @@\n  * @author LightPepsi\n  */\n public class MonsterGlobalDropEntry {\n-    public MonsterGlobalDropEntry(int itemId, int chance, int continent, byte dropType, int Minimum, int Maximum, short questid) {\n+    public MonsterGlobalDropEntry(int itemId, int chance, int continent, int Minimum, int Maximum, short questid) {\n     this.itemId = itemId;\n     this.chance = chance;\n-    this.dropType = dropType;\n     this.questid = questid;\n+    this.continentid = continent;\n     this.Minimum = Minimum;\n     this.Maximum = Maximum;\n     }\n-    public byte dropType;\n-    public int itemId, chance, Minimum, Maximum;\n+    public int itemId, chance, Minimum, Maximum, continentid;\n     public short questid;\n }"}, {"sha": "e97a7ebe2735c9ddbb83c9c3194bc4c3b5ed8e99", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 18, "deletions": 11, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -64,6 +64,7 @@\n     private List<Pair<String, Byte>> messages = new LinkedList<>();\n     private List<SoldItem> sold = new LinkedList<>();\n     private AtomicBoolean open = new AtomicBoolean();\n+    private boolean published = false;\n     private MapleMap map;\n     private Lock visitorLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.VISITOR_MERCH, true);\n \n@@ -100,10 +101,14 @@ private void broadcastToVisitors(final byte[] packet) {\n         visitorLock.lock();\n         try {\n             byte count = 0;\n-            for (MapleCharacter visitor : visitors) {\n-                if (visitor != null) {\n-                    count++;\n+            if (this.isOpen()) {\n+                for (MapleCharacter visitor : visitors) {\n+                    if (visitor != null) {\n+                        count++;\n+                    }\n                 }\n+            } else {\n+                count = (byte) (visitors.length + 1);\n             }\n             \n             return new byte[]{count, (byte) (visitors.length + 1)};\n@@ -471,15 +476,12 @@ public boolean hasItem(int itemid) {\n         return false;\n     }\n \n-    public void addItem(MaplePlayerShopItem item) {\n+    public boolean addItem(MaplePlayerShopItem item) {\n         synchronized (items) {\n+            if (items.size() >= 16) return false;\n+            \n             items.add(item);\n-        }\n-        \n-        try {\n-            this.saveItems(false);\n-        } catch (SQLException ex) {\n-            ex.printStackTrace();\n+            return true;\n         }\n     }\n \n@@ -521,13 +523,18 @@ private int getFreeSlot() {\n     public void setDescription(String description) {\n         this.description = description;\n     }\n-\n+    \n+    public boolean isPublished() {\n+        return published;\n+    }\n+    \n     public boolean isOpen() {\n         return open.get();\n     }\n \n     public void setOpen(boolean set) {\n         open.getAndSet(set);\n+        published = true;\n     }\n \n     public int getItemId() {"}, {"sha": "b9f719831611f6d1d16748e427459e20798def87", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 28, "deletions": 106, "changes": 134, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -62,6 +62,7 @@\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n import java.lang.ref.WeakReference;\n import net.server.Server;\n+import net.server.coordinator.MapleMonsterAggroCoordinator;\n import net.server.channel.Channel;\n import net.server.world.World;\n import scripting.map.MapScriptManager;\n@@ -140,6 +141,7 @@\n     private int fieldType;\n     private int fieldLimit = 0;\n     private int mobCapacity = -1;\n+    private MapleMonsterAggroCoordinator aggroMonitor = null;   // aggroMonitor activity in sync with itemMonitor\n     private ScheduledFuture<?> mapMonitor = null;\n     private ScheduledFuture<?> itemMonitor = null;\n     private ScheduledFuture<?> expireItemsTask = null;\n@@ -185,6 +187,8 @@ public MapleMap(int mapid, int world, int channel, int returnMapId, float monste\n         final ReentrantReadWriteLock objectLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.MAP_OBJS, true);\n         objectRLock = objectLock.readLock();\n         objectWLock = objectLock.writeLock();\n+        \n+        aggroMonitor = new MapleMonsterAggroCoordinator();\n     }\n     \n     public void setEventInstance(EventInstanceManager eim) {\n@@ -709,7 +713,7 @@ private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob, f\n         if(useBaseRate) chRate = 1;\n \n         final MapleMonsterInformationProvider mi = MapleMonsterInformationProvider.getInstance();\n-        final List<MonsterGlobalDropEntry> globalEntry = mi.getGlobalDrop();\n+        final List<MonsterGlobalDropEntry> globalEntry = mi.getRelevantGlobalDrops(this.getId());\n         \n         final List<MonsterDropEntry>  dropEntry = new ArrayList<>();\n         final List<MonsterDropEntry> visibleQuestEntry = new ArrayList<>();\n@@ -777,6 +781,7 @@ public void run() {\n                             if(itemMonitorTimeout == 0) {\n                                 if(itemMonitor != null) {\n                                     stopItemMonitor();\n+                                    aggroMonitor.stopAggroCoordinator();\n                                 }\n                                 \n                                 return;\n@@ -1144,12 +1149,10 @@ public int countPlayers() {\n     }\n     \n     public List<MapleCharacter> getAllPlayers() {\n-        List<MapleCharacter> character = new LinkedList<>();\n+        List<MapleCharacter> character;\n         chrRLock.lock();\n         try {\n-            for (MapleCharacter a : characters) {\n-                character.add(a);\n-            }\n+            character = new ArrayList<>(characters);\n         } finally {\n             chrRLock.unlock();\n         }\n@@ -1316,7 +1319,7 @@ public void killMonster(final MapleMonster monster, final MapleCharacter chr, fi\n                             if (mons != null) {\n                                 if (mons.getId() == 8800000) {\n                                     makeMonsterReal(mons);\n-                                    updateMonsterController(mons);\n+                                    mons.aggroUpdateController();\n                                     break;\n                                 }\n                             }\n@@ -1552,88 +1555,6 @@ public final void shuffleReactors(List<Object> list) {\n         }\n     }\n     \n-    private MapleCharacter getNextControllerCandidate() {\n-        int mincontrolled = Integer.MAX_VALUE;\n-        MapleCharacter newController = null;\n-        \n-        int mincontrolleddead = Integer.MAX_VALUE;\n-        MapleCharacter newControllerDead = null;\n-        \n-        chrRLock.lock();\n-        try {\n-            for (MapleCharacter chr : characters) {\n-                if (!chr.isHidden()) {\n-                    int ctrlMonsSize = chr.getControlledMonsters().size();\n-                    \n-                    if (chr.isAlive()) {\n-                        if (ctrlMonsSize < mincontrolled) {\n-                            mincontrolled = ctrlMonsSize;\n-                            newController = chr;\n-                        }\n-                    } else {\n-                        if (ctrlMonsSize < mincontrolleddead) {\n-                            mincontrolleddead = ctrlMonsSize;\n-                            newControllerDead = chr;\n-                        }\n-                    }\n-                }\n-            }\n-        } finally {\n-            chrRLock.unlock();\n-        }\n-        \n-        return newController != null ? newController : newControllerDead;\n-    }\n-    \n-    /**\n-     * Automagically finds a new controller for the given monster from the chars\n-     * on the map...\n-     *\n-     * @param monster\n-     */\n-    public void updateMonsterController(MapleMonster monster) {\n-        monster.lockMonster();\n-        try {\n-            if (!monster.isAlive()) {\n-                return;\n-            }\n-            \n-            MapleCharacter newController;\n-            MapleCharacter chrController = monster.getController();\n-            if (chrController != null) {\n-                if (chrController.getMap() != this) {\n-                    chrController.stopControllingMonster(monster);\n-                    newController = getNextControllerCandidate();\n-                } else {\n-                    if (chrController.isAlive()) {\n-                        return;\n-                    }\n-                    \n-                    newController = getNextControllerCandidate();\n-                    if (newController == null || !newController.isAlive()) {\n-                        return;\n-                    }\n-                    \n-                    chrController.stopControllingMonster(monster);\n-                }\n-            } else {\n-                newController = getNextControllerCandidate();\n-            }\n-            \n-            if (newController != null) { // was a new controller found? (if not no one is on the map)\n-                if (monster.isFirstAttack()) {\n-                    newController.controlMonster(monster, true);\n-                    monster.setControllerHasAggro(true);\n-                    monster.setControllerKnowsAboutAggro(true);\n-                } else {\n-                    newController.controlMonster(monster, false);\n-                }\n-            }\n-        } finally {\n-            monster.unlockMonster();\n-        }\n-    }\n-\n     private Map<Integer, MapleMapObject> getCopyMapObjects() {\n         objectRLock.lock();\n         try {\n@@ -1862,7 +1783,7 @@ public void sendPackets(MapleClient c) {\n             }\n         });\n         \n-        updateMonsterController(monster);\n+        monster.aggroUpdateController();\n         \n         if (monster.hasBossHPBar()) {\n             broadcastBossHpMessage(monster, monster.hashCode(), monster.makeBossHPBarPacket(), monster.getPosition());\n@@ -1948,7 +1869,7 @@ public void sendPackets(MapleClient c) {\n             }\n         }, null);\n         \n-        updateMonsterController(monster);\n+        monster.aggroUpdateController();\n         \n         if (monster.hasBossHPBar()) {\n             broadcastBossHpMessage(monster, monster.hashCode(), monster.makeBossHPBarPacket(), monster.getPosition());\n@@ -1993,7 +1914,8 @@ public void sendPackets(MapleClient c) {\n                 c.announce(MaplePacketCreator.spawnMonster(monster, true, effect));\n             }\n         });\n-        updateMonsterController(monster);\n+        \n+        monster.aggroUpdateController();\n         \n         if (monster.hasBossHPBar()) {\n             broadcastBossHpMessage(monster, monster.hashCode(), monster.makeBossHPBarPacket(), monster.getPosition());\n@@ -2019,7 +1941,8 @@ public void sendPackets(MapleClient c) {\n     public void makeMonsterReal(final MapleMonster monster) {\n         monster.setFake(false);\n         broadcastMessage(MaplePacketCreator.makeMonsterReal(monster));\n-        updateMonsterController(monster);\n+        \n+        monster.aggroUpdateController();\n     }\n \n     public void spawnReactor(final MapleReactor reactor) {\n@@ -2403,7 +2326,10 @@ public void addPlayer(final MapleCharacter chr) {\n         chr.setMapId(mapid);\n         \n         if (chrSize == 1) {\n-            if(!hasItemMonitor()) startItemMonitor();\n+            if(!hasItemMonitor()) {\n+                startItemMonitor();\n+                aggroMonitor.startAggroCoordinator();\n+            }\n             \n             if (onFirstUserEnter.length() != 0 && !chr.hasEntered(onFirstUserEnter, mapid) && MapScriptManager.getInstance().scriptExists(onFirstUserEnter, true)) {\n                 chr.enteredScript(onFirstUserEnter, mapid);\n@@ -2688,19 +2614,8 @@ public void removePlayer(MapleCharacter chr) {\n             broadcastGMMessage(MaplePacketCreator.removePlayerFromMap(chr.getId()));\n         }\n \n-        for (MapleMonster monster : chr.getControlledMonsters()) {\n-            monster.lockMonster();\n-            try {\n-                monster.setController(null);\n-                monster.setControllerHasAggro(false);\n-                monster.setControllerKnowsAboutAggro(false);\n-                updateMonsterController(monster);\n-            } finally {\n-                monster.unlockMonster();\n-            }\n-        }\n-        \n         chr.leaveMap();\n+        \n         for (MapleSummon summon : new ArrayList<>(chr.getSummonsValues())) {\n             if (summon.isStationary()) {\n                 chr.cancelEffectFromBuffStat(MapleBuffStat.PUPPET);\n@@ -2926,7 +2841,7 @@ private void sendObjectPlacement(MapleClient mapleClient) {\n             if (isNonRangedType(o.getType())) {\n                 o.sendSpawnData(mapleClient);\n             } else if (o.getType() == MapleMapObjectType.MONSTER) {\n-                updateMonsterController((MapleMonster) o);\n+                ((MapleMonster) o).aggroUpdateController();\n             } else if (o.getType() == MapleMapObjectType.SUMMON) {\n                 MapleSummon summon = (MapleSummon) o;\n                 if (summon.getOwner() == chr) {\n@@ -3038,6 +2953,10 @@ public void setMapLineBoundings(int vrTop, int vrBottom, int vrLeft, int vrRight\n         mapArea.setBounds(vrLeft, vrTop, vrRight - vrLeft, vrBottom - vrTop);\n     }\n     \n+    public MapleMonsterAggroCoordinator getAggroCoordinator() {\n+        return aggroMonitor;\n+    }\n+    \n     /**\n      * it's threadsafe, gtfo :D\n      *\n@@ -4091,6 +4010,9 @@ public void dispose() {\n         \n         chrWLock.lock();\n         try {\n+            aggroMonitor.dispose();\n+            aggroMonitor = null;\n+            \n             if(itemMonitor != null) {\n                 itemMonitor.cancel(false);\n                 itemMonitor = null;"}, {"sha": "965f413651cc83e55b7beb90aec958ca2ddc7308", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 30, "deletions": 9, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -103,11 +103,15 @@ public boolean hasFreeSlot() {\n         visitorLock.lock();\n         try {\n             byte count = 0;\n-            for (MapleCharacter visitor : visitors) {\n-                if (visitor != null) {\n-                    count++;\n+            //if (this.isOpen()) {\n+                for (MapleCharacter visitor : visitors) {\n+                    if (visitor != null) {\n+                        count++;\n+                    }\n                 }\n-            }\n+            //} else {  shouldn't happen since there isn't a \"closed\" state for player shops.\n+            //    count = (byte) (visitors.length + 1);\n+            //}\n             \n             return new byte[]{count, (byte) visitors.length};\n         } finally {\n@@ -198,9 +202,12 @@ public boolean isVisitor(MapleCharacter visitor) {\n         }\n     }\n \n-    public void addItem(MaplePlayerShopItem item) {\n+    public boolean addItem(MaplePlayerShopItem item) {\n         synchronized (items) {\n+            if (items.size() >= 16) return false;\n+            \n             items.add(item);\n+            return true;\n         }\n     }\n \n@@ -241,7 +248,7 @@ public void takeItemBack(int slot, MapleCharacter chr) {\n      * @param item\n      * @param quantity\n      */\n-    public void buy(MapleClient c, int item, short quantity) {\n+    public boolean buy(MapleClient c, int item, short quantity) {\n         synchronized (items) {\n             if (isVisitor(c.getPlayer())) {\n                 MaplePlayerShopItem pItem = items.get(item);\n@@ -250,10 +257,10 @@ public void buy(MapleClient c, int item, short quantity) {\n                 newItem.setQuantity((short) ((pItem.getItem().getQuantity() * quantity)));\n                 if (quantity < 1 || !pItem.isExist() || pItem.getBundles() < quantity) {\n                     c.announce(MaplePacketCreator.enableActions());\n-                    return;\n+                    return false;\n                 } else if (newItem.getInventoryType().equals(MapleInventoryType.EQUIP) && newItem.getQuantity() > 1) {\n                     c.announce(MaplePacketCreator.enableActions());\n-                    return;\n+                    return false;\n                 }\n                 \n                 MapleKarmaManipulator.toggleKarmaFlagToUntradeable(newItem);\n@@ -264,6 +271,12 @@ public void buy(MapleClient c, int item, short quantity) {\n                     \n                     if (c.getPlayer().getMeso() >= price) {\n                         if (canBuy(c, newItem)) {\n+                            if (!owner.canHoldMeso(price)) {\n+                                owner.dropMessage(1, \"Transaction failed since the shop owner can't hold any more mesos.\");\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return false;\n+                            }\n+                            \n                             c.getPlayer().gainMeso(-price, false);\n                             owner.gainMeso(price, true);\n                             \n@@ -286,13 +299,21 @@ public void buy(MapleClient c, int item, short quantity) {\n                             }\n                         } else {\n                             c.getPlayer().dropMessage(1, \"Your inventory is full. Please clean a slot before buying this item.\");\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return false;\n                         }\n                     } else {\n                         c.getPlayer().dropMessage(1, \"You don't have enough mesos to purchase this item.\");\n+                        c.announce(MaplePacketCreator.enableActions());\n+                        return false;\n                     }\n+                    \n+                    return true;\n                 } finally {\n                     visitorLock.unlock();\n                 }\n+            } else {\n+                return false;\n             }\n         }\n     }\n@@ -418,9 +439,9 @@ private void clearChatLog() {\n     }\n     \n     public void closeShop() {\n-        owner.getMap().broadcastMessage(MaplePacketCreator.removePlayerShopBox(this));\n         clearChatLog();\n         removeVisitors();\n+        owner.getMap().broadcastMessage(MaplePacketCreator.removePlayerShopBox(this));\n     }\n \n     public void sendShop(MapleClient c) {"}, {"sha": "ba4273e8b88d90e699e689bf232e311405549bfb", "filename": "src/server/movement/AbsoluteLifeMovement.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/AbsoluteLifeMovement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/AbsoluteLifeMovement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/movement/AbsoluteLifeMovement.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -26,7 +26,7 @@\n \n public class AbsoluteLifeMovement extends AbstractLifeMovement {\n     private Point pixelsPerSecond;\n-    private int unk;\n+    private int fh;\n \n     public AbsoluteLifeMovement(int type, Point position, int duration, int newstate) {\n         super(type, position, duration, newstate);\n@@ -40,12 +40,12 @@ public void setPixelsPerSecond(Point wobble) {\n         this.pixelsPerSecond = wobble;\n     }\n \n-    public int getUnk() {\n-        return unk;\n+    public int getFh() {    // unk -> fh, thanks Spoon for pointing this out\n+        return fh;\n     }\n \n-    public void setUnk(int unk) {\n-        this.unk = unk;\n+    public void setFh(int fh) {\n+        this.fh = fh;\n     }\n \n     @Override\n@@ -55,7 +55,7 @@ public void serialize(LittleEndianWriter lew) {\n         lew.writeShort(getPosition().y);\n         lew.writeShort(pixelsPerSecond.x);\n         lew.writeShort(pixelsPerSecond.y);\n-        lew.writeShort(unk);\n+        lew.writeShort(fh);\n         lew.write(getNewstate());\n         lew.writeShort(getDuration());\n     }"}, {"sha": "3e8eb1b053a87cb3f89957d7b0ddd71d54fbfa09", "filename": "src/server/movement/ChairMovement.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/ChairMovement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/ChairMovement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/movement/ChairMovement.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -25,26 +25,26 @@\n import tools.data.output.LittleEndianWriter;\n \n public class ChairMovement extends AbstractLifeMovement {\n-    private int unk;\n+    private int fh;\n \n     public ChairMovement(int type, Point position, int duration, int newstate) {\n         super(type, position, duration, newstate);\n     }\n \n-    public int getUnk() {\n-        return unk;\n+    public int getFh() {\n+        return fh;\n     }\n \n-    public void setUnk(int unk) {\n-        this.unk = unk;\n+    public void setFh(int fh) {\n+        this.fh = fh;\n     }\n \n     @Override\n     public void serialize(LittleEndianWriter lew) {\n         lew.write(getType());\n         lew.writeShort(getPosition().x);\n         lew.writeShort(getPosition().y);\n-        lew.writeShort(unk);\n+        lew.writeShort(fh);\n         lew.write(getNewstate());\n         lew.writeShort(getDuration());\n     }"}, {"sha": "b60f6c19d4d4a0c3cc853ae0def5dbba1f90582d", "filename": "src/server/movement/JumpDownMovement.java", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/JumpDownMovement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/movement/JumpDownMovement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/movement/JumpDownMovement.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -26,8 +26,8 @@\n \n public class JumpDownMovement extends AbstractLifeMovement {\n     private Point pixelsPerSecond;\n-    private int unk;\n     private int fh;\n+    private int originFh;\n \n     public JumpDownMovement(int type, Point position, int duration, int newstate) {\n         super(type, position, duration, newstate);\n@@ -41,20 +41,20 @@ public void setPixelsPerSecond(Point wobble) {\n         this.pixelsPerSecond = wobble;\n     }\n \n-    public int getUnk() {\n-        return unk;\n+    public int getFh() {\n+        return fh;\n     }\n \n-    public void setUnk(int unk) {\n-        this.unk = unk;\n+    public void setFh(int fh) {\n+        this.fh = fh;\n     }\n \n-    public int getFH() {\n-        return fh;\n+    public int getOriginFh() {\n+        return originFh;\n     }\n \n-    public void setFH(int fh) {\n-        this.fh = fh;\n+    public void setOriginFh(int fh) {    // fh actually originFh, thanks Spoon for pointing this out\n+        this.originFh = fh;\n     }\n \n     @Override\n@@ -64,8 +64,8 @@ public void serialize(LittleEndianWriter lew) {\n         lew.writeShort(getPosition().y);\n         lew.writeShort(pixelsPerSecond.x);\n         lew.writeShort(pixelsPerSecond.y);\n-        lew.writeShort(unk);\n         lew.writeShort(fh);\n+        lew.writeShort(originFh);\n         lew.write(getNewstate());\n         lew.writeShort(getDuration());\n     }"}, {"sha": "2ad65b3928ac228ffc6d43bb970fd5e2f655b1ac", "filename": "src/server/quest/actions/ExpAction.java", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/quest/actions/ExpAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/quest/actions/ExpAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ExpAction.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -23,7 +23,6 @@\n \n import client.MapleCharacter;\n import constants.ServerConstants;\n-import net.server.world.World;\n import provider.MapleData;\n import provider.MapleDataTool;\n import server.quest.MapleQuest;\n@@ -53,15 +52,10 @@ public void run(MapleCharacter chr, Integer extSelection) {\n \t}\n         \n         public static void runAction(MapleCharacter chr, int gain) {\n-                if (chr.isBeginnerJob() && chr.getLevel() < 10) {\n-\t\t\tchr.gainExp(gain, true, true);\n-\t\t} else {\n-                        if(!ServerConstants.USE_QUEST_RATE) {\n-                                chr.gainExp(gain * chr.getExpRate(), true, true);\n-                        } else {\n-                                World w = chr.getClient().getWorldServer();\n-                                chr.gainExp(gain * w.getExpRate() * w.getQuestRate(), true, true);\n-                        }\n-\t\t}\n+                if (!ServerConstants.USE_QUEST_RATE) {\n+                        chr.gainExp(gain * chr.getExpRate(), true, true);\n+                } else {\n+                        chr.gainExp(gain * chr.getQuestExpRate(), true, true);\n+                }\n         }\n } "}, {"sha": "8f84d6d29969656201f9c3330b551548a56dd531", "filename": "src/server/quest/actions/MesoAction.java", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/quest/actions/MesoAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/server/quest/actions/MesoAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/MesoAction.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -23,7 +23,6 @@\n \n import client.MapleCharacter;\n import constants.ServerConstants;\n-import net.server.world.World;\n import provider.MapleData;\n import provider.MapleDataTool;\n import server.quest.MapleQuest;\n@@ -54,14 +53,13 @@ public void run(MapleCharacter chr, Integer extSelection) {\n \t}\n         \n         public static void runAction(MapleCharacter chr, int gain) {\n-                if(gain < 0) {\n+                if (gain < 0) {\n                         chr.gainMeso(gain, true, false, true);\n                 } else {\n-                        if(!ServerConstants.USE_QUEST_RATE) {\n+                        if (!ServerConstants.USE_QUEST_RATE) {\n                                 chr.gainMeso(gain * chr.getMesoRate(), true, false, true);\n                         } else {\n-                                World w = chr.getClient().getWorldServer();\n-                                chr.gainMeso(gain * w.getMesoRate() * w.getQuestRate(), true, false, true);\n+                                chr.gainMeso(gain * chr.getQuestMesoRate(), true, false, true);\n                         }\n                 }\n         }"}, {"sha": "7d37d78a8cce695765408601f85af5e75ce37828", "filename": "src/tools/LogHelper.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/tools/LogHelper.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/tools/LogHelper.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/LogHelper.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -40,8 +40,8 @@ public static void logExpedition(MapleExpedition expedition) {\n \t\tString log = expedition.getType().toString() + \" EXPEDITION\\r\\n\";\n \t\tlog += getTimeString(expedition.getStartTime()) + \"\\r\\n\";\n \n-\t\tfor (MapleCharacter member : expedition.getMembers()){\n-\t\t\tlog += \">>\" + member.getName() + \"\\r\\n\";\n+\t\tfor (String memberName : expedition.getMembers().values()){\n+\t\t\tlog += \">>\" + memberName + \"\\r\\n\";\n \t\t}\n \t\tlog += \"BOSS KILLS\\r\\n\";\n \t\tfor (String message: expedition.getBossLogs()){"}, {"sha": "b999ae5567e43065efe775ed8942dd75e31e3b82", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 60, "deletions": 16, "changes": 76, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -1841,6 +1841,30 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 return mplew.getPacket();\n         }\n         \n+        /**\n+         * Guild Name & Mark update packet, thanks to Arnah (Vertisy)\n+         * \n+\t * @param guildName The Guild name, blank for nothing.\n+\t */\n+\tpublic static byte[] guildNameChanged(int chrid, String guildName){\n+\t\tMaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+\t\tmplew.writeShort(SendOpcode.GUILD_NAME_CHANGED.getValue());\n+\t\tmplew.writeInt(chrid);\n+\t\tmplew.writeMapleAsciiString(guildName);\n+\t\treturn mplew.getPacket();\n+\t}\n+        \n+\tpublic static byte[] guildMarkChanged(int chrid, MapleGuild guild){\n+\t\tMaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+\t\tmplew.writeShort(SendOpcode.GUILD_MARK_CHANGED.getValue());\n+\t\tmplew.writeInt(chrid);\n+\t\tmplew.writeShort(guild.getLogoBG());\n+\t\tmplew.write(guild.getLogoBGColor());\n+\t\tmplew.writeShort(guild.getLogo());\n+\t\tmplew.write(guild.getLogoColor());\n+\t\treturn mplew.getPacket();\n+\t}\n+        \n         /**\n          * Gets a packet spawning a player as a mapobject to other clients.\n          *\n@@ -3384,7 +3408,7 @@ private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew\n         public static byte[] showBuffeffect(int cid, int skillid, int effectid) {\n                 return showBuffeffect(cid, skillid, effectid, (byte) 3);\n         }\n-\n+        \n         public static byte[] showBuffeffect(int cid, int skillid, int effectid, byte direction) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.SHOW_FOREIGN_EFFECT.getValue());\n@@ -3396,6 +3420,19 @@ private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew\n                 mplew.writeLong(0);\n                 return mplew.getPacket();\n         }\n+        \n+        public static byte[] showBuffeffect(int cid, int skillid, int skilllv, int effectid, byte direction) {   // updated packet structure found thanks to Rien dev team\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.SHOW_FOREIGN_EFFECT.getValue());\n+                mplew.writeInt(cid);\n+                mplew.write(effectid);\n+                mplew.writeInt(skillid);\n+                mplew.write(0);\n+                mplew.write(skilllv);\n+                mplew.write(direction);\n+        \n+                return mplew.getPacket();\n+        }\n \n         public static byte[] showOwnBuffEffect(int skillid, int effectid) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n@@ -4597,13 +4634,21 @@ public static void addThread(final MaplePacketLittleEndianWriter mplew, ResultSe\n                 mplew.writeInt(skillId);\n                 return mplew.getPacket();\n         }\n-\n-        public static byte[] showMagnet(int mobid, byte success) { // Monster Magnet\n+        \n+        public static byte[] catchMonster(int mobOid, byte success) {   // updated packet structure found thanks to Rien dev team\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.CATCH_MONSTER.getValue());\n+                mplew.writeInt(mobOid);\n+                mplew.write(success);\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] catchMonster(int mobOid, int itemid, byte success) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n-                mplew.writeShort(SendOpcode.SHOW_MAGNET.getValue());\n-                mplew.writeInt(mobid);\n+                mplew.writeShort(SendOpcode.CATCH_MONSTER_WITH_ITEM.getValue());\n+                mplew.writeInt(mobOid);\n+                mplew.writeInt(itemid);\n                 mplew.write(success);\n-                mplew.skip(10); //Mmmk\n                 return mplew.getPacket();\n         }\n \n@@ -4932,15 +4977,6 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] catchMonster(int monsobid, int itemid, byte success) {\n-                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n-                mplew.writeShort(SendOpcode.CATCH_MONSTER.getValue());\n-                mplew.writeInt(monsobid);\n-                mplew.writeInt(itemid);\n-                mplew.write(success);\n-                return mplew.getPacket();\n-        }\n-\n         public static byte[] catchMessage(int message) { // not done, I guess\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.BRIDLE_MOB_CATCH_FAIL.getValue());\n@@ -5599,14 +5635,22 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 }\n                 return mplew.getPacket();\n         }\n-\n+        \n         public static byte[] hiredMerchantOwnerLeave() {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.PLAYER_INTERACTION.getValue());\n                 mplew.write(PlayerInteractionHandler.Action.REAL_CLOSE_MERCHANT.getCode());\n                 mplew.write(0);\n                 return mplew.getPacket();\n         }\n+        \n+        public static byte[] hiredMerchantOwnerMaintenanceLeave() {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.PLAYER_INTERACTION.getValue());\n+                mplew.write(PlayerInteractionHandler.Action.REAL_CLOSE_MERCHANT.getCode());\n+                mplew.write(5);\n+                return mplew.getPacket();\n+        }\n \n         public static byte[] hiredMerchantMaintenanceMessage() {\n                 MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(5);"}, {"sha": "5fecba78fff092de75c1037c1fa7e63cd1a89a4a", "filename": "tools/MapleEventMethodFiller/src/mapleeventmethodfiller/MapleEventMethodFiller.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/tools/MapleEventMethodFiller/src/mapleeventmethodfiller/MapleEventMethodFiller.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/tools/MapleEventMethodFiller/src/mapleeventmethodfiller/MapleEventMethodFiller.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleEventMethodFiller/src/mapleeventmethodfiller/MapleEventMethodFiller.java?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -41,7 +41,7 @@\n   and fill empty functions for every function name not yet present in the\n   script.\n   \n-  Estimated parse time: \n+  Estimated parse time: 10 seconds\n  */\n public class MapleEventMethodFiller {\n "}, {"sha": "faac7466cbd386ecfaa75fdda6f88d7398b5d5ee", "filename": "wz/Map.wz/Map/Map0/001000006.img.xml", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map0/001000006.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map0/001000006.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map0/001000006.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -99,7 +99,7 @@\n   <imgdir name=\"life\">\n     <imgdir name=\"15\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"787\"/>\n       <int name=\"y\" value=\"-1483\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -112,7 +112,7 @@\n     </imgdir>\n     <imgdir name=\"16\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-866\"/>\n       <int name=\"y\" value=\"-883\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -125,7 +125,7 @@\n     </imgdir>\n     <imgdir name=\"19\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"325\"/>\n       <int name=\"y\" value=\"-876\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -171,7 +171,7 @@\n     </imgdir>\n     <imgdir name=\"17\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-395\"/>\n       <int name=\"y\" value=\"-841\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -184,7 +184,7 @@\n     </imgdir>\n     <imgdir name=\"18\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"695\"/>\n       <int name=\"y\" value=\"-1033\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -210,7 +210,7 @@\n     </imgdir>\n     <imgdir name=\"20\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-644\"/>\n       <int name=\"y\" value=\"-897\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -223,7 +223,7 @@\n     </imgdir>\n     <imgdir name=\"13\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-83\"/>\n       <int name=\"y\" value=\"-802\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -236,7 +236,7 @@\n     </imgdir>\n     <imgdir name=\"12\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-705\"/>\n       <int name=\"y\" value=\"-1431\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -249,7 +249,7 @@\n     </imgdir>\n     <imgdir name=\"11\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-841\"/>\n       <int name=\"y\" value=\"-1429\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -262,7 +262,7 @@\n     </imgdir>\n     <imgdir name=\"10\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-525\"/>\n       <int name=\"y\" value=\"-1192\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -275,7 +275,7 @@\n     </imgdir>\n     <imgdir name=\"9\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-317\"/>\n       <int name=\"y\" value=\"-1192\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -288,7 +288,7 @@\n     </imgdir>\n     <imgdir name=\"8\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"803\"/>\n       <int name=\"y\" value=\"-1025\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -301,7 +301,7 @@\n     </imgdir>\n     <imgdir name=\"7\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"559\"/>\n       <int name=\"y\" value=\"-1030\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -384,7 +384,7 @@\n     </imgdir>\n     <imgdir name=\"14\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"-430\"/>\n       <int name=\"y\" value=\"-1202\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -397,7 +397,7 @@\n     </imgdir>\n     <imgdir name=\"24\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"1210102\"/>\n       <int name=\"x\" value=\"75\"/>\n       <int name=\"y\" value=\"-787\"/>\n       <int name=\"mobTime\" value=\"0\"/>"}, {"sha": "dbe653609db9a6d06c7a663bae832767592ec802", "filename": "wz/Map.wz/Map/Map0/001010400.img.xml", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map0/001010400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map0/001010400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map0/001010400.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -103,7 +103,7 @@\n   <imgdir name=\"life\">\n     <imgdir name=\"0\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-374\"/>\n       <int name=\"y\" value=\"-760\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -116,7 +116,7 @@\n     </imgdir>\n     <imgdir name=\"1\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-172\"/>\n       <int name=\"y\" value=\"-764\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -129,7 +129,7 @@\n     </imgdir>\n     <imgdir name=\"2\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"25\"/>\n       <int name=\"y\" value=\"-759\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -142,7 +142,7 @@\n     </imgdir>\n     <imgdir name=\"3\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"211\"/>\n       <int name=\"y\" value=\"-768\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -155,7 +155,7 @@\n     </imgdir>\n     <imgdir name=\"4\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"377\"/>\n       <int name=\"y\" value=\"-756\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -168,7 +168,7 @@\n     </imgdir>\n     <imgdir name=\"5\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"322\"/>\n       <int name=\"y\" value=\"-1111\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -181,7 +181,7 @@\n     </imgdir>\n     <imgdir name=\"6\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"458\"/>\n       <int name=\"y\" value=\"-1119\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -194,7 +194,7 @@\n     </imgdir>\n     <imgdir name=\"7\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"98\"/>\n       <int name=\"y\" value=\"-1064\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -207,7 +207,7 @@\n     </imgdir>\n     <imgdir name=\"8\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-41\"/>\n       <int name=\"y\" value=\"-1062\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -220,7 +220,7 @@\n     </imgdir>\n     <imgdir name=\"9\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-132\"/>\n       <int name=\"y\" value=\"-1241\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -233,7 +233,7 @@\n     </imgdir>\n     <imgdir name=\"10\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-280\"/>\n       <int name=\"y\" value=\"-1242\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n@@ -246,7 +246,7 @@\n     </imgdir>\n     <imgdir name=\"11\">\n       <string name=\"type\" value=\"m\"/>\n-      <string name=\"id\" value=\"1210100\"/>\n+      <string name=\"id\" value=\"9300274\"/>\n       <int name=\"x\" value=\"-332\"/>\n       <int name=\"y\" value=\"-995\"/>\n       <int name=\"mobTime\" value=\"0\"/>"}, {"sha": "4b7d0881e08ce792e5e00d323dbad7a48b0812a4", "filename": "wz/Map.wz/Map/Map1/105090310.img.xml", "status": "modified", "additions": 10882, "deletions": 10925, "changes": 21807, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map1/105090310.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Map.wz/Map/Map1/105090310.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map1/105090310.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d"}, {"sha": "6d03217b48ff00ab86b01dd35eeac5a3f6304787", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -8339,7 +8339,7 @@\n       <int name=\"npc\" value=\"12100\"/>\n       <imgdir name=\"mob\">\n         <imgdir name=\"0\">\n-          <int name=\"id\" value=\"1210100\"/>\n+          <int name=\"id\" value=\"9300274\"/>\n           <int name=\"count\" value=\"2\"/>\n         </imgdir>\n       </imgdir>"}, {"sha": "a66bf5124e2ec6ff28a11f962e9caa1bf8f96e00", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -2541,8 +2541,8 @@\n     <string name=\"name\" value=\"Mai&apos;s Last Training\"/>\n     <string name=\"parent\" value=\"Mai&apos;s Training!\"/>\n     <int name=\"order\" value=\"4\"/>\n-    <string name=\"1\" value=\"I defeated the Slimes and brought back the Squishy Liquid to Mai. She seemed to be impressed, and instructed me this time to hunt a really powerful monster. She then told me to hunt #r2 Pigs#k.\\n\\nPig #r#a10441##k\"/>\n-    <string name=\"2\" value=\"I was able to defeat 2 Pigs and reported the result to Mai.\"/>\n+    <string name=\"1\" value=\"I defeated the Slimes and brought back the Squishy Liquid to Mai. She seemed to be impressed, and instructed me this time to hunt a really powerful monster. She then told me to hunt #r2 Cynical Orange Mushrooms#k.\\n\\nCynical Orange Mushroom #r#a10441##k\"/>\n+    <string name=\"2\" value=\"I was able to defeat 2 Cynical Orange Mushrooms and reported the result to Mai.\"/>\n     <int name=\"area\" value=\"20\"/>\n   </imgdir>\n   <imgdir name=\"10440\">"}, {"sha": "63c54d3fb563e8bba1f0f8b67f0408cc056a4683", "filename": "wz/Quest.wz/Say.img.xml", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/Say.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Quest.wz/Say.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Say.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -4503,21 +4503,22 @@\n     <imgdir name=\"0\">\n       <string name=\"0\" value=\"Oh wow! You really brought me Squishy Liquid from the Slime. You&apos;re doing much better than I expected. I think... you&apos;re now ready to take on a really challenging monster.\"/>\n       <imgdir name=\"yes\">\n-        <string name=\"0\" value=\"This time, you&apos;ll need to take on #r2 Pigs#k. They are very fast and powerful, but thankfully they aren&apos;t the Ribbon Pigs you&apos;ll find at Victoria Island. They are just regular Pigs, so if you focus on the combat, you should be able to handle those two.\"/>\n+        <string name=\"0\" value=\"Alright, this time, you&apos;ll need to take on #r2 Cynical Orange Mushrooms#k. They are pretty tough and powerful, but thankfully they aren&apos;t the Blue Mushrooms you&apos;ll find at Victoria Island. They are basically regular Orange Mushrooms, so if you focus on the combat, you should be able to handle those two.\"/>\n       </imgdir>\n       <imgdir name=\"no\">\n         <string name=\"0\" value=\"Hmmm... did I really scare you? Don&apos;t worry. If you are persistent, you&apos;ll be able to handle those two. I won&apos;t make you hunt monsters that you can&apos;t handle, you know.\"/>\n       </imgdir>\n+      <string name=\"1\" value=\"So, reports of late shows up a growth on masses of distempered Orange Mushrooms around. Some explorers seems to not get their job done after they started engaging combat. That has been making some Orange Mushrooms rather... uhh, cynical... towards us humans... \"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"0\" value=\"So you did defeat 2 Pigs. That&apos;s incredible! Seriously, you&apos;re doing much better than I ever thought possible! You may be just a beginner, but I have a feeling that you&apos;ll one day become a legendary hero in Maple World.\"/>\n+      <string name=\"0\" value=\"So you did defeat 2 Cynical Orange Mushrooms. That&apos;s incredible! Seriously, you&apos;re doing much better than I ever thought possible! You may be just a beginner, but I have a feeling that you&apos;ll one day become a legendary hero in Maple World.\"/>\n       <imgdir name=\"yes\">\n         <string name=\"0\" value=\"The training is now complete. You may still have some weaknesses here and there, but you&apos;ll be able to overcome that in no time. Keep training!\"/>\n         <string name=\"1\" value=\"Oh, and I have one last #btest#k for you. Think of it as a final exam. If you aren&apos;t satisfied with your current skill level and want to push further, then meet #bBari#k, who will have a test in store for you.\"/>\n       </imgdir>\n       <imgdir name=\"stop\">\n         <imgdir name=\"mob\">\n-          <string name=\"0\" value=\"I don&apos;t think you&apos;ve slayed #r2 Pigs#k yet. Please take care of both, then let me know of the results.\"/>\n+          <string name=\"0\" value=\"I don&apos;t think you&apos;ve slayed #r2 Cynical Orange Mushrooms#k yet. Please take care of both, then let me know of the results.\"/>\n         </imgdir>\n       </imgdir>\n     </imgdir>"}, {"sha": "49011b15d94abf251d34ce7c47e88ea19dcbc305", "filename": "wz/Skill.wz/MobSkill.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Skill.wz/MobSkill.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d/wz/Skill.wz/MobSkill.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/MobSkill.img.xml?ref=efc8884e19e9fb712d0f5a2d9b5f7ed3d8f9164d", "patch": "@@ -14477,7 +14477,7 @@\n         <int name=\"hp\" value=\"100\"/>\n         <int name=\"limit\" value=\"1200\"/>\n         <int name=\"summonEffect\" value=\"12\"/>\n-        <int name=\"interval\" value=\"150000\"/>\n+        <int name=\"interval\" value=\"150\"/>\n         <int name=\"0\" value=\"6400007\"/>\n         <int name=\"1\" value=\"6400007\"/>\n         <int name=\"2\" value=\"6400007\"/>"}]}]},
