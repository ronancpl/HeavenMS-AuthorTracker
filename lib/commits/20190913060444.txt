{"fetchDate": "2019-12-19", "content": [{"sha": "e169971384fa59e5bb2eb4cf279852b674269d4a", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZTE2OTk3MTM4NGZhNTllNWJiMmViNGNmMjc5ODUyYjY3NDI2OWQ0YQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-09-13T06:04:44Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-09-13T06:04:44Z"}, "message": "Knights' Seal & I. MaxHP + Adherent mob status + Script point-warps\n\nFixed Seal skill not working for Blaze Wizard.\nAdded a check against Seal skill on bosses.\nReviewed improper usage of \"random spawn point arrival\" at several warps on scripts.\nRefactored CPQ modules fetching players from the channel storage, this should be unneeded after a recent update on the player object from MPC.\nAdded door objects as a visible map object for the player server-side view component.\nFixed a few scenarios where mobs would unexpectedly show up impervious to mob status.\nFixed scenario where a player wouldn't receive disease informations from other players after changing maps.\nFixed some magic-type skills (such as Magic Claw or Freeze) not displaying damage value for other players when the player is within melee-range from the mob.\nAdded check for whether a given quest is scripted before trying to find the script.\nFixed registering items onto MTS leading to loss of a few of its properties (expiration, item level, etc).\nFixed \"Improved MaxHP\" skill gains not working for Thunderbreakers.\nRefactored pet autopot to also apply on HP/MP consumption by items/skills.\nAdded portal sound effect on Mystic Doors.", "tree": {"sha": "add8d9afda87677610c51100f1f25cac76688c10", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/add8d9afda87677610c51100f1f25cac76688c10"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/e169971384fa59e5bb2eb4cf279852b674269d4a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/e169971384fa59e5bb2eb4cf279852b674269d4a", "html_url": "https://github.com/ronancpl/HeavenMS/commit/e169971384fa59e5bb2eb4cf279852b674269d4a", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/e169971384fa59e5bb2eb4cf279852b674269d4a/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "259c2e5ba19c915a9aff59a23aaf3fdace810d29", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/259c2e5ba19c915a9aff59a23aaf3fdace810d29", "html_url": "https://github.com/ronancpl/HeavenMS/commit/259c2e5ba19c915a9aff59a23aaf3fdace810d29"}], "stats": {"total": 1321, "additions": 782, "deletions": 539}, "files": [{"sha": "56f339dda6e45cc0c21e8579a0d20365300ecf9c", "filename": "docs/issues.txt", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -12,9 +12,8 @@ Known issues:\n - Dragon Roar doesn't show the stun effect to players.\n - Cygnus job 'Final Attack' skills not functional.\n - Steal skill doesn't deduct the loot from the drop pool from a mob.\n-- Using Shark Wave with Transformation on female thunderbreakers will cause consecutive attacks to proc immediately.\n - Snipe will show much higher damage value than actually applicable to the attacker.\n-- Some monster status such as freeze and weapon/magic reflect doesn't behave properly in certain scenarios. Freeze seems to not work on mobs with low OID or are starters from server boot time.\n+- Some monster status such as weapon/magic reflect doesn't behave properly in certain scenarios.\n - On low-end connections, things such as command summoning a player that is currently logging in (already visible to other players) may cause the player to freeze, consequently freezing the account as well since the server-side disconnection doesn't happen.\n - Reportedly, there are cases where mob positions fail to sync between player's client-view.\n - Visual equip EXP watch value will present stuttering for early levels requirement (EXP needed less than 100), and requirement at level 200 will not progress at all due to the level cap in client.\n@@ -32,14 +31,13 @@ Missing features list:\n \n ---------------------------\n ** Others **\n-- Family system\n - MTS\n ---------------------------\n \n \n ---------------------------\n ** Quest **\n-- Family & Medal quests.\n+- Medal quests.\n ---------------------------\n \n \n@@ -50,7 +48,7 @@ Missing features list:\n \n ---------------------------\n ** Packet issues & advanced PQs **\n-- Mystic Doors (won't deploy players properly is some situations, only destination map matches).\n+- Mystic Doors (won't deploy players properly in some situations, only destination map matches).\n - Nett's Pyramid Party Quest\n ---------------------------\n "}, {"sha": "a0a39b884bd31f095649192a83a1359260a6b0d0", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 25, "deletions": 1, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -2111,4 +2111,28 @@ Corrigido informa\u00e7\u00f5es de mount n\u00e3o sendo atualizado para o jogador assim que\n Revisado sistema criado para manuten\u00e7\u00e3o de pacotes enviados atrav\u00e9s do IoSession, tal sistema agora atuando como uma \"pool\" ao inv\u00e9s de uma \"factory\".\n \n 29 Agosto 2019,\n-Revisado uso de loop em espera ocupada no sistema de manuten\u00e7\u00e3o de pacotes enviados. Em geral, threads que solicitam an\u00fancio de pacotes n\u00e3o necessitam evitar esperar at\u00e9 que cada pacote seja enviado.\n\\ No newline at end of file\n+Revisado uso de loop em espera ocupada no sistema de manuten\u00e7\u00e3o de pacotes enviados. Em geral, threads que solicitam an\u00fancio de pacotes n\u00e3o necessitam evitar esperar at\u00e9 que cada pacote seja enviado.\n+\n+30 Agosto 2019,\n+Corrigido skill Seal n\u00e3o atuando devidamente para Blaze Wizard.\n+Corrigido skill Seal atuando em bosses.\n+Refatorado fun\u00e7\u00f5es ainda utilizando invoc\u00e1vel desabstraindo o mesmo, assim evitando m\u00faltiplos casts de tipo ao decorrer da busca pelo motor de scripts.\n+\n+02 - 03 Setembro 2019,\n+Revisado pontos de spawn usados em warps em v\u00e1rios scripts do servidor.\n+Refatorado m\u00e9todos da CPQ buscando jogadores pelo storage de canais. N\u00e3o deveria mais haver necessidade j\u00e1 que a partir de uma atualiza\u00e7\u00e3o recente membros offline cont\u00e9m objeto de jogador nulo, e ao reentrar o MPC j\u00e1 assume o novo objeto de jogador.\n+\n+05 - 06 Setembro 2019,\n+Adicionado doors em mapas de cidade como objetos vis\u00edveis em campo.\n+Corrigido aplica\u00e7\u00e3o de status de mobs, onde em v\u00e1rias ocasi\u00f5es os mobs poderiam parecer inafet\u00e1veis aos mesmos.\n+\n+07 Setembro 2019,\n+Corrigido jogador n\u00e3o recebendo informa\u00e7\u00f5es de debuffs em outros jogadores ao trocar de mapas.\n+\n+10 - 12 Setembro 2019,\n+Corrigido algumas skills de tipo \"m\u00e1gico\", que n\u00e3o usam cargas, n\u00e3o mostrando dano para outros jogadores quando golpe ocorre suficientemente perto.\n+Adicionado checagem por evid\u00eancia de disponibilidade de scripts em quests.\n+Corrigido inscri\u00e7\u00e3o de itens no MTS levando a certos atributos de itens sendo perdidos no processo.\n+Adicionado ganho de MaxHP extra da skill para Thunderbreakers, em ambos casos de aumento de n\u00edvel e de MaxHP usando AP.\n+Refatorado a\u00e7\u00e3o de autopots, permitindo o mesmo a agir imediatamente ap\u00f3s detec\u00e7\u00e3o de perda suficiente de HP/MP ao usar itens ou skills.\n+Adicionado efeito sonoro de portal ao atravessar Mystic Door.\n\\ No newline at end of file"}, {"sha": "499d793ec3e781bcbee83ca4550192d67ad62b7e", "filename": "scripts/event/BalrogBattle.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/BalrogBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/BalrogBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BalrogBattle.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -245,6 +245,7 @@ function monsterKilled(mob, eim) {\n                         eim.clearPQ();\n \n                         eim.dispatchUpdateQuestMobCount(bossMobId, entryMap);\n+                        eim.dispatchUpdateQuestMobCount(9101003, entryMap); // thanks Atoot for noticing quest not getting updated after boss kill\n                         mob.getMap().broadcastBalrogVictory(eim.getLeader().getName());\n                 } else {\n                         if(count == 1) {"}, {"sha": "360e41454334c1dc2c999d7482be6e45fe03666e", "filename": "scripts/event/GuardianNex.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/GuardianNex.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/GuardianNex.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/GuardianNex.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -24,7 +24,7 @@ function respawn(eim){}\n \n function playerEntry(eim, player){\n \tvar cave = eim.getMapInstance(eventMap + 10 * eim.getIntProperty(\"nex\"));\n-\tplayer.changeMap(cave);\n+\tplayer.changeMap(cave, 1);\n }\n \n function scheduledTimeout(eim){"}, {"sha": "0fd8898cb67004e295e3bf9ce5d1b7fb2c9e40cd", "filename": "scripts/event/Puppeteer.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/Puppeteer.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/Puppeteer.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Puppeteer.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -24,7 +24,7 @@ function respawn(eim){}\n \n function playerEntry(eim, player){\n \tvar cave = eim.getMapInstance(eventMap);\n-\tplayer.changeMap(cave);\n+\tplayer.changeMap(cave, 1);\n }\n \n function scheduledTimeout(eim){"}, {"sha": "9bd07265822ad3fc985b395974e8f26a8fc26205", "filename": "scripts/event/RockSpirit.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/RockSpirit.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/RockSpirit.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/RockSpirit.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -63,7 +63,7 @@ function respawn(eim) {\n \n function playerEntry(eim, player) {\n     var amplifierMap = eim.getMapInstance(entryMap.getId());\n-    player.changeMap(amplifierMap);\n+    player.changeMap(amplifierMap, 1);\n     eim.schedule(\"timeOut\", timer);\n }\n "}, {"sha": "60085fb57d8cc9301ce360dbd5166c7adb8b95f8", "filename": "scripts/event/RockSpiritVIP.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/RockSpiritVIP.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/event/RockSpiritVIP.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/RockSpiritVIP.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -63,7 +63,7 @@ function respawn(eim) {\n \n function playerEntry(eim, player) {\n \tvar amplifierMap = eim.getMapInstance(entryMap.getId());\n-\tplayer.changeMap(amplifierMap);\n+\tplayer.changeMap(amplifierMap, 1);\n         eim.schedule(\"timeOut\", timer);\n }\n "}, {"sha": "27a0f1a4d68e87085c32d326699e84f784240596", "filename": "scripts/npc/1052007.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052007.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -66,7 +66,7 @@ function action(mode, type, selection) {\n     \t\tticketSelection = selection;\n             if (ticketSelection > -1) {\n                 cm.gainItem(4031035 + ticketSelection, -1);\n-                cm.warp(103000897 + (ticketSelection * 3));\n+                cm.warp(103000897 + (ticketSelection * 3), \"st00\");  // thanks IxianMace for noticing a few scripts having misplaced warp SP's\n                 hasTicket = false;\n                 cm.dispose();\n                 return;"}, {"sha": "095fd671cfe5d5c723ba117be14b020c00d2376b", "filename": "scripts/npc/1052008.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052008.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -28,6 +28,6 @@ function start() {\n         cm.gainItem(4031039,1);\n     else\n         cm.gainItem(4020000 + ((Math.random()*5)|0), 1);\n-    cm.warp(103000100);\n+    cm.warp(103000100, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "f1de2aab883ee6893303b28346f84e47dab84c81", "filename": "scripts/npc/1052009.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052009.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -28,6 +28,6 @@ function start() {\n         cm.gainItem(4031040,1);\n     else\n         cm.gainItem(prizes[parseInt(Math.random() * prizes.length)],1);\n-    cm.warp(103000100);\n+    cm.warp(103000100, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "7f75e4c2ada48f6b05afa96171e8a0b4dca0105d", "filename": "scripts/npc/1052010.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052010.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -28,6 +28,6 @@ function start() {\n         cm.gainItem(4031041,1);\n     else\n         cm.gainItem(prizes[parseInt(Math.random() * prizes.length)],1);\n-    cm.warp(103000100);\n+    cm.warp(103000100, 0);\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "bb683cac661688acc441e5b5dfa212ed9f81bf2c", "filename": "scripts/npc/1052012.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052012.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1052012.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052012.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -53,7 +53,7 @@ function action(mode, type, selection) {\n                                 cm.sendOk(\"Oh, you don't have the money, right? Sorry, I can't let you in.\");\n                         } else {\n                                 cm.gainMeso(-5000);\n-                                cm.warp(193000000);\n+                                cm.warp(193000000, \"out00\");\n                         }\n                     \n                         cm.dispose();"}, {"sha": "a603b7044bcee675e5a2f707d69bd33806d462be", "filename": "scripts/npc/1061018.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1061018.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1061018.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061018.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -28,7 +28,7 @@ function action(mode, type, selection) {\n                         }\n                 } else if(status == 1){\n                         if(cm.getEventInstance().isEventCleared()) {\n-                                cm.warp(cm.getMapId() == 105100300 ? 105100301 : 105100401);\n+                                cm.warp(cm.getMapId() == 105100300 ? 105100301 : 105100401, 0);\n                         } else {\n                                 cm.warp(105100100);\n                         }"}, {"sha": "3f2ed5c98eae77204e06fcddafa90524f6ab447e", "filename": "scripts/npc/1072002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1072002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1072002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1072002.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -69,7 +69,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4031010, -1);\n                     cm.sendOk(\"You will have to collect me #b30 #t4031013##k. Good luck.\")\n                 } else if (status == 4) {\n-                    cm.warp(108000100);\n+                    cm.warp(108000100, 0);\n                     cm.dispose();\n                 }\n                 else {"}, {"sha": "a15d3b3a3df82da668da04316b94980ba725fa43", "filename": "scripts/npc/1090000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1090000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/1090000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1090000.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -222,7 +222,7 @@ function action(mode, type, selection) {\n \t\t\t\t\tcm.sendOk(\"All the training maps are currently in use. Please try again later.\");\n \t\t\t\t\tcm.dispose();\n \t\t\t\t} else {\n-\t\t\t\t\tcm.warp(map);\n+\t\t\t\t\tcm.warp(map, 0);\n \t\t\t\t\tcm.dispose();\n \t\t\t\t\treturn;\n                 }"}, {"sha": "699dd060bbb209812d005672762eeb31dcb69f20", "filename": "scripts/npc/2013001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2013001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2013001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2013001.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -278,7 +278,7 @@ function action(mode, type, selection) {\n                 if(cm.getMap().countMonsters() > 0) {\n                     cm.sendNext(\"This is the hidden room of the tower. After eliminating all monsters on this room, talk to me to gain access to the treasure room, leaving the center tower access behind.\");\n                 } else {\n-                    cm.warp(920011100);\n+                    cm.warp(920011100, \"st00\");\n                 }\n                 break;\n         }"}, {"sha": "fc7dd3e4840d17111f917d2dd7b43e340df02599", "filename": "scripts/npc/2030000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2030000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2030000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030000.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -33,7 +33,7 @@ var status = 0;\n \n function start() {\n     if(cm.haveItem(4031450, 1)) {\n-        cm.warp(921100100);\n+        cm.warp(921100100, 1);\n         cm.dispose();\n         return;\n     }"}, {"sha": "01f546487ba4b88caab6d490944aaf11d92f1800", "filename": "scripts/npc/2040045.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2040045.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2040045.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040045.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -54,7 +54,7 @@ function action(mode, type, selection) {\n                         cm.sendYesNo(\"Would you like to leave the bonus stage?\");\n                 }\n                 else {\n-                        cm.warp(922011100);\n+                        cm.warp(922011100, \"st00\");\n                         cm.dispose();\n                 }\n         }"}, {"sha": "019a54527643a62da369a6976b9e66fb279eeb6e", "filename": "scripts/npc/2081010.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2081010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2081010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2081010.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -44,7 +44,7 @@ function action(mode, type, selection){\n     }\n     \n     else if(status == 1) {\n-\tcm.warp(exitMap);\n+\tcm.warp(exitMap, \"st00\");\n         cm.dispose();\n     }\n }"}, {"sha": "c7cbd07632560cf502594fff6c6fc8f34da76e5d", "filename": "scripts/npc/2083002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2083002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2083002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2083002.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function action(mode, type, selection) {\n         cm.dispose();\n     else {\n         if(cm.getMapId() > 240050400) cm.warp(240050600);\n-        else cm.warp(240040700);\n+        else cm.warp(240040700, \"out00\");\n         \n         cm.dispose();\n     }"}, {"sha": "57ad24c0ced444afbf6f8118a483a196c3857038", "filename": "scripts/npc/2091005.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -330,7 +330,7 @@ function action(mode, type, selection) {\n                         cm.sendYesNo(\"So, you're giving up? You're really going to leave?\");\n                     } else {\n                         if (mode == 1) {\n-                            cm.warp(925020002);\n+                            cm.warp(925020002, \"st00\");\n                         }\n                         cm.dispose();\n                         return;"}, {"sha": "028204db39b952fffd4be5d8ba5a7df0f49ae7ac", "filename": "scripts/npc/2091005_old.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2091005_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2091005_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005_old.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -225,7 +225,7 @@ function action(mode, type, selection) {\n                 cm.sendAcceptDecline(\"So, you're giving up? You're really going to leave?\");\n             } else {\n                 if (mode == 1) {\n-                    cm.warp(925020002);\n+                    cm.warp(925020002, \"st00\");\n                 }\n                 cm.dispose();\n             }"}, {"sha": "3ae1c9dba490f70bb37673f8658af505a2b2d281", "filename": "scripts/npc/2111000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2111000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2111000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2111000.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -30,7 +30,7 @@\n */\n function start() {\n     if(cm.isQuestStarted(3310) && !cm.haveItem(4031709, 1)) {\n-        cm.warp(926120100);\n+        cm.warp(926120100, \"out00\");\n     } else {\n         cm.sendNext(\"Alchemy....and Alchemist.....both of them are important. But more importantly, it is the Magatia that tolerate everything. The honor of Magatia should be protected by me.\");\n     }"}, {"sha": "aa22675e67158a106a84ed1e29c38f16e57a7ce6", "filename": "scripts/npc/2111003.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2111003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2111003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2111003.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -33,7 +33,7 @@\n \n function start() {\n     if(cm.isQuestStarted(3335) && !cm.haveItem(4031695, 1)) {\n-        cm.warp(926120300);\n+        cm.warp(926120300, \"out00\");\n         cm.dispose();\n     } else {\n         cm.sendOk(\"Emotion that I feel is real? Or just illusion coming from mechanical error?\");"}, {"sha": "10a4fda4d8f7c8b3523ddf3a6e11719bc6684a9a", "filename": "scripts/npc/2112003.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2112003.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -50,7 +50,7 @@ function action(mode, type, selection) {\n                         if(status == 0) {\n                                 cm.sendYesNo(\"We must keep fighting to save Romeo, please keep your pace. If you are not feeling so well to continue, your companions and I will understand... So, are you going to retreat?\");\n                         } else if(status == 1) {\n-                                cm.warp(926110700);\n+                                cm.warp(926110700, 0);\n                                 cm.dispose();\n                         }\n                 } else {"}, {"sha": "44da2246da0aeab84fe75e8ac8ec0751be71616e", "filename": "scripts/npc/2112004.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2112004.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -50,7 +50,7 @@ function action(mode, type, selection) {\n                         if(status == 0) {\n                                 cm.sendYesNo(\"We must keep fighting to save Juliet, please keep your pace. If you are not feeling so well to continue, your companions and I will understand... So, are you going to retreat?\");\n                         } else if(status == 1) {\n-                                cm.warp(926100700);\n+                                cm.warp(926100700, 0);\n                                 cm.dispose();\n                         }\n                 } else {"}, {"sha": "14de113793b4c04e7fb53ff6548d9fca306c6b9a", "filename": "scripts/npc/2112005.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2112005.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -93,7 +93,7 @@ function action(mode, type, selection) {\n                                         cm.sendYesNo(\"We must keep fighting to save Romeo, please keep your pace. If you are not feeling so well to continue, your companions and I will understand... So, are you going to retreat?\");\n                                 }\n                         } else {\n-                                cm.warp(926110700);\n+                                cm.warp(926110700, 0);\n                                 cm.dispose();\n                         }\n                 } else {\n@@ -111,15 +111,15 @@ function action(mode, type, selection) {\n                                 if(cm.canHold(4001160)) {\n                                         cm.gainItem(4001160, 1);\n                                         \n-                                        if(eim.getIntProperty(\"normalClear\") == 1) cm.warp(926110600);\n-                                        else cm.warp(926110500);\n+                                        if(eim.getIntProperty(\"normalClear\") == 1) cm.warp(926110600, 0);\n+                                        else cm.warp(926110500, 0);\n                                 } else {\n                                         cm.sendOk(\"Make sure you have a space on your ETC inventory.\");\n                                 }\n                                 \n                                 cm.dispose();\n                         } else {\n-                                cm.warp(926110600);\n+                                cm.warp(926110600, 0);\n                                 cm.dispose();\n                         }\n                 }"}, {"sha": "2a1ad0c22259b551fca0e924af4428a1c8fcc821", "filename": "scripts/npc/2112006.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2112006.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -93,7 +93,7 @@ function action(mode, type, selection) {\n                                         cm.sendYesNo(\"We must keep fighting to save Juliet, please keep your pace. If you are not feeling so well to continue, your companions and I will understand... So, are you going to retreat?\");\n                                 }\n                         } else {\n-                                cm.warp(926100700);\n+                                cm.warp(926100700, 0);\n                                 cm.dispose();\n                         }\n                 } else {\n@@ -111,15 +111,15 @@ function action(mode, type, selection) {\n                                 if(cm.canHold(4001159)) {\n                                         cm.gainItem(4001159, 1);\n                                         \n-                                        if(eim.getIntProperty(\"normalClear\") == 1) cm.warp(926100600);\n-                                        else cm.warp(926100500);\n+                                        if(eim.getIntProperty(\"normalClear\") == 1) cm.warp(926100600, 0);\n+                                        else cm.warp(926100500, 0);\n                                 } else {\n                                         cm.sendOk(\"Make sure you have a space on your ETC inventory.\");\n                                 }\n                                 \n                                 cm.dispose();\n                         } else {\n-                                cm.warp(926100600);\n+                                cm.warp(926100600, 0);\n                                 cm.dispose();\n                         }\n                 }"}, {"sha": "e6f2cc19e9a8cc6b80c340e01a7f2e1b476ca7fa", "filename": "scripts/npc/2112011.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112011.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2112011.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2112011.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -51,7 +51,7 @@ function action(mode, type, selection) {\n                 } else {\n                         if(!cm.isQuestCompleted(7770)) cm.completeQuest(7770);\n                         \n-                        cm.warp(926110600);\n+                        cm.warp(926110600, 0);\n                         cm.dispose();\n                 }\n         }"}, {"sha": "d28855533425df5dda2731d783843bd30d25144b", "filename": "scripts/npc/2133001.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2133001.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -92,10 +92,10 @@ function action(mode, type, selection) {\n                                 cm.gainItem(4001169, -20);\n                                 cm.getEventInstance().warpEventTeam(930000500);\n                             } else {\n-                                cm.warp(930000800);\n+                                cm.warp(930000800, 0);\n                             }\n                         } else {\n-                            cm.warp(930000800);\n+                            cm.warp(930000800, 0);\n                         }\n                         \n                         cm.dispose();"}, {"sha": "59c3d759cc96c6980371287f918286dab9cebfb0", "filename": "scripts/npc/2133002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2133002.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -19,7 +19,7 @@ function action(mode, type, selection) {\n \tcm.removeAll(4001163);\n \tcm.removeAll(4001169);\n \tcm.removeAll(2270004);\n-\tcm.warp(930000800);\n+\tcm.warp(930000800, 0);\n \tcm.dispose();\n     }\n }\n\\ No newline at end of file"}, {"sha": "ef0d283fe3513c371cb2221f2da7833319c68a3f", "filename": "scripts/npc/2133004.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/2133004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2133004.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -25,7 +25,7 @@ function action(mode, type, selection) {\n                     }                        \n                 } else if(status == 1) {\n                         if (!cm.haveItem(4001163)) {\n-                                cm.warp(930000800);\n+                                cm.warp(930000800, 0);\n                         } else {\n                                 cm.getEventInstance().warpEventTeam(930000600);\n                         }"}, {"sha": "c0501bf004f7d1e27482f4e9faec03f7b10df0cc", "filename": "scripts/npc/9000001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9000001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9000001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000001.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -59,7 +59,7 @@ function action(mode, type, selection) {\n \t\t\t\t\t\tcm.divideTeams();\n         \n \t\t\t\t\tcm.getEvent().minusLimit();\n-\t\t\t\t\tcm.warp(cm.getEvent().getMapId());\n+\t\t\t\t\tcm.warp(cm.getEvent().getMapId(), 0);\n \t\t\t\t\tcm.dispose();\n \t\t\t\t} else {\n \t\t\t\t\tcm.sendNext(\"Either the event has not been started, you already have the #bScroll of Secrets#k, or you have already participated in this event within the last 24 hours. Please try again later!\");"}, {"sha": "b2dd15c3694428f12cc5622719ecc1475d811136", "filename": "scripts/npc/9000021.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9000021.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9000021.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000021.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -55,7 +55,7 @@ function action(mode, type, selection) {\n             cm.sendOk(\"Very well. Remember, there you can assemble a team or take on the fightings on your own, it's up to you. Good luck!\");\n         } else if(status == 4) {\n             cm.getPlayer().saveLocation(\"BOSSPQ\");\n-            cm.warp(970030000);\n+            cm.warp(970030000, \"out00\");\n             cm.dispose();\n         }\n     }"}, {"sha": "f4718a16d46644ee38b3fe1b087f351bd2bcfd52", "filename": "scripts/npc/9010022.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9010022.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9010022.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -71,10 +71,10 @@ function action(mode, type, selection) {\n                     cm.warp(980030000, 3); \n                     break; \n                 case 5: \n-                    cm.warp(926010000); \n+                    cm.warp(926010000, 4); \n                     break; \n                 case 6: \n-                    cm.warp(910320000); \n+                    cm.warp(910320000, 2);\n                     break; \n             } \n             cm.dispose(); "}, {"sha": "8a9e49bdbf7917014c5c3285ab3302bfcba8a40e", "filename": "scripts/npc/9010022_old.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9010022_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9010022_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9010022_old.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -66,10 +66,10 @@ function action(mode, type, selection) {\n                     cm.warp(980030000, 3); \n                     break; \n                 case 5: \n-                    cm.warp(926010000); \n+                    cm.warp(926010000, 4); \n                     break; \n                 case 6: \n-                    cm.warp(910320000); \n+                    cm.warp(910320000, 2);\n                     break; \n             } \n             cm.dispose(); "}, {"sha": "aeb86ff6f59f763cab455b141e80f2fab93e3af2", "filename": "scripts/npc/9060000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9060000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9060000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9060000.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -45,7 +45,7 @@ function action(mode, type, selection){\n         if (completed) {\n             cm.getEventInstance().clearPQ();\n         } else {\n-            cm.warp(923010100);\n+            cm.warp(923010100, 0);\n         }\n         \n         cm.dispose();"}, {"sha": "fb08eed2737975aa1b5b7a52a124299ff4e5fcb0", "filename": "scripts/npc/9120003.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120003.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -49,7 +49,7 @@ function action(mode, type, selection) {\n         cm.sendOk(\"Please check and see if you have \" + price + \" mesos to enter this place.\");\n     else {\n         cm.gainMeso(-price);\n-        cm.warp(801000100 + 100 * cm.getPlayer().getGender());\n+        cm.warp(801000100 + 100 * cm.getPlayer().getGender(), \"out00\");\n     }\n     cm.dispose();\n }"}, {"sha": "f5846c1ac1474ad841a1b61707fa9da55a70469d", "filename": "scripts/npc/9120015.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120015.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120015.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120015.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -50,7 +50,7 @@ function action(mode, type, selection) {\n                 cm.dispose();\n             }\n         } else {\n-            cm.warp(801040000);\n+            cm.warp(801040000, \"in00\");\n             cm.dispose();\n         }\n     }"}, {"sha": "e517b0783782d30f58d10a6a0db8041f00774bb1", "filename": "scripts/npc/9120200.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120200.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9120200.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120200.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -30,9 +30,9 @@ function action(mode, type, selection) {\n         cm.dispose();\n     } else {\n         if (mode == 0) {\n-            cm.sendOk(\"If you want to return to #m801000000#, then talk to me\");\n+            cm.sendOk(\"If you want to return to #m801000000#, then talk to me.\");\n             cm.dispose();\n-        } if (mode == 1) {\n+        } else if (mode == 1) {\n             status++;\n         }\n         if (status == 1) {"}, {"sha": "186a9d1c419f4d119126f23619fd447090210f92", "filename": "scripts/npc/9270033.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9270033.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9270033.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9270033.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -60,7 +60,7 @@ function action(mode, type, selection) {\n                                 }\n                         }\n                     \n-                        cm.warp(541010110);\n+                        cm.warp(541010110, 0);\n                         cm.dispose();\n                 }\n         }"}, {"sha": "5654952e9f5ba50acdac5a53e24bcfe05773aa8b", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -62,6 +62,7 @@ function writeFeatureTab_Skills() {\n         addFeature(\"Chair Mastery - map chair boosts HP/MP rec.\");\n         addFeature(\"Mu Lung Dojo skills functional.\");\n         addFeature(\"Monster Magnet skill no longer crashes players.\");\n+        addFeature(\"HP/MP consumption from skills triggers pet autopot.\");\n }\n \n function writeFeatureTab_Quests() {\n@@ -278,7 +279,6 @@ function writeFeatureTab_Project() {\n         addFeature(\"Protected many flaws with login management system.\");\n         addFeature(\"Developed a robust anti-exploit login coordinator.\");\n         addFeature(\"Revised uniqueness aspect of logged in accounts.\");\n-        addFeature(\"Developed pooling system for IoSession sent packets.\");\n         addFeature(\"Usage of HikariCP to improve DB connection calls.\");\n         addFeature(\"Usage of Java Threadpool to improve runnable calls.\");\n         addFeature(\"Developed many survey tools for content profiling.\");"}, {"sha": "efc0ff1db8348dd2ac045053ec8055daa8e85293", "filename": "scripts/npc/ThiefPassword.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/ThiefPassword.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/npc/ThiefPassword.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/ThiefPassword.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -23,7 +23,7 @@ function action(mode, type, selection){\n \telse if(status == 1){\n \t\tif(cm.getText() == \"Open Sesame\"){\n \t\t\tif(cm.isQuestCompleted(3925))\n-\t\t\t\tcm.warp(260010402);\n+\t\t\t\tcm.warp(260010402, 1);\n \t\t\telse\n                                 cm.playerMessage(5, \"Although you said the right answer, the door will not budge.\");\n "}, {"sha": "283d3925f548aa6336c8490d272f490af0c2b70f", "filename": "scripts/portal/MC2revive.js", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MC2revive.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MC2revive.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MC2revive.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -1,8 +1,5 @@\n function enter(pi) {\n-    if ( pi.getPlayer().getTeam() == 0 ) {\n-\tpi.warp( pi.getMapId() - 100);\n-    } else {\n-\tpi.warp( pi.getMapId() - 100);\n-    }\n+    pi.playPortalSound();\n+    pi.warp( pi.getMapId() - 100);\n     return true;\n }\n\\ No newline at end of file"}, {"sha": "86339e773ad4f4920036ea7b458a1de494ae2578", "filename": "scripts/portal/MD_drakeroom.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_drakeroom.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_drakeroom.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_drakeroom.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "51018666a001ee107356061cd7fb81688718fe6d", "filename": "scripts/portal/MD_error.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_error.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_error.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_error.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -46,7 +46,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "539e980cc70877e683a856391e547838fa40bd93", "filename": "scripts/portal/MD_golem.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_golem.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_golem.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_golem.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -46,7 +46,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "4c429593f12c77ab0e9d6a38de6a20a34bbe2e7b", "filename": "scripts/portal/MD_high.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_high.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_high.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_high.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -46,7 +46,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "46f12dc1bff3c585e7aeb079735888e8b0e82438", "filename": "scripts/portal/MD_mushroom.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_mushroom.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_mushroom.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_mushroom.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -46,7 +46,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "31d1bbbdfbc94f5012f507fba661ec1b424f7c89", "filename": "scripts/portal/MD_pig.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_pig.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_pig.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_pig.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -34,7 +34,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -46,7 +46,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "7bdef62c069784125d593e908f2e8a3e5f54a9d3", "filename": "scripts/portal/MD_protect.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_protect.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_protect.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_protect.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "0d3737702aae672d02f4655bf111b71f43f7a8de", "filename": "scripts/portal/MD_rabbit.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_rabbit.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_rabbit.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_rabbit.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "21d2a3ff3d52a6a71d19f38a39c1da77a2ccbf09", "filename": "scripts/portal/MD_remember.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_remember.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_remember.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_remember.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "8f4050bd66a8c1dd193252770099d24744ac15da", "filename": "scripts/portal/MD_roundTable.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_roundTable.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_roundTable.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_roundTable.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "d459d074bd80d06d143e9c5effe4688e6ed4ce2c", "filename": "scripts/portal/MD_sand.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_sand.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_sand.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_sand.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "cc37b21a8c96fe9c5c654514b7de42b2038e97e5", "filename": "scripts/portal/MD_treasure.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_treasure.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/MD_treasure.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/MD_treasure.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -32,7 +32,7 @@ function enter(pi) {\n                 for (var i = 0; i < dungeons; i++) {\n                     if(pi.startDungeonInstance(dungeonid + i)) {\n                         pi.playPortalSound();\n-                        pi.warpParty(dungeonid + i);\n+                        pi.warpParty(dungeonid + i, \"out00\");\n                         return true;\n                     }\n                 }\n@@ -44,7 +44,7 @@ function enter(pi) {\n             for (var i = 0; i < dungeons; i++) {\n                 if(pi.startDungeonInstance(dungeonid + i)) {\n                     pi.playPortalSound();\n-                    pi.warp(dungeonid + i);\n+                    pi.warp(dungeonid + i, \"out00\");\n                     return true;\n                 }\n             }"}, {"sha": "c73dd2619653b96564e64b1ceeba2ecbb2b36758", "filename": "scripts/portal/NextMap.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/NextMap.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/NextMap.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/NextMap.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -1,5 +1,5 @@\n function enter(pi) {\n \tpi.playPortalSound();\n-\tpi.warp(pi.getMapId() + 100);\n+\tpi.warp(pi.getMapId() + 100, 0);\n \treturn true;\n }\n\\ No newline at end of file"}, {"sha": "08d5b5f1a9e4dc89c2a11498eeec34991c4b03a5", "filename": "scripts/portal/Pinkin.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/Pinkin.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/Pinkin.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Pinkin.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -19,7 +19,7 @@\n */\n \n /*\n-Vs Pink Bean - Ressurection stage portal\n+Vs Pink Bean - Resurrection stage portal\n @author Ronan\n */\n "}, {"sha": "deed0cea90e1a4c90f03953988866ab17f7befdb", "filename": "scripts/portal/Populatus00.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/Populatus00.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/Populatus00.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Populatus00.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -50,7 +50,7 @@ function enter(pi) {\n         }\n     } else {\n         pi.playPortalSound();\n-        pi.warp(922020300);\n+        pi.warp(922020300, 0);\n         return true;\n     }\n }\n\\ No newline at end of file"}, {"sha": "c32a40e070c73388a24b358e615b60d42315ea87", "filename": "scripts/portal/gaga_success.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/gaga_success.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/gaga_success.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/gaga_success.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -1,6 +1,6 @@\n //Author: kevintjuh93\n \n function enter(pi) {  \n-\tpi.playPortalSound(); pi.warp(922240100 + (pi.getPlayer().getMapId() - 922240000));\n+\tpi.playPortalSound(); pi.warp(922240100 + (pi.getPlayer().getMapId() - 922240000), 0);\n \treturn true;\n }  \n\\ No newline at end of file"}, {"sha": "aec7e9956af9ec18f7ddc5eafaa46f7a98399dbf", "filename": "scripts/portal/jnr6_out.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/jnr6_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/jnr6_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/jnr6_out.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -1,6 +1,6 @@\n function enter(pi) {\n     if (pi.getMap().getReactorByName(\"jnr6_out\").getState() == 1) {\n-\tpi.playPortalSound(); pi.warp(926110300);\n+\tpi.playPortalSound(); pi.warp(926110300, 0);\n         return true;\n     } else {\n \tpi.playerMessage(5, \"The portal is not opened yet.\");"}, {"sha": "ff5dba59d4cef9eea58650260a9a9eb9b925c836", "filename": "scripts/portal/skyrom.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/skyrom.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/skyrom.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/skyrom.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -21,7 +21,7 @@\n function enter(pi) {\n     if(pi.isQuestStarted(3935) && !pi.haveItem(4031574, 1)) {\n         if(pi.getWarpMap(926000010).countPlayers() == 0) {\n-            pi.playPortalSound(); pi.warp(926000010);\n+            pi.playPortalSound(); pi.warp(926000010, 0);\n             return true;\n         } else {\n             pi.message(\"Someone is already trying this map.\");"}, {"sha": "115efd4a7eedac6615d4df0c0d2f51d09421c4a4", "filename": "scripts/portal/stageBogo.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/stageBogo.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/portal/stageBogo.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/stageBogo.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -24,6 +24,6 @@\n     @Author Ronan\n */\n function enter(pi) {\n-    pi.playPortalSound(); pi.warp(670010800);\n+    pi.playPortalSound(); pi.warp(670010800, 0);\n     return true;\n }\n\\ No newline at end of file"}, {"sha": "846cbd3f525a61bcc066392b50e587d37a450897", "filename": "scripts/quest/2568.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/quest/2568.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/quest/2568.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2568.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -16,7 +16,7 @@ function start(mode, type, selection) {\n \t\t\t\n \t\t} else {\n \t\t\tqm.forceStartQuest();\n-\t\t\tqm.warp(912060200);\n+\t\t\tqm.warp(912060200, 0);\n \t\t}\n \t\tqm.dispose();\n \t}"}, {"sha": "04b12618208ab6a4563e4c6ff3bb867c1b0c75a9", "filename": "scripts/quest/3933.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/quest/3933.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/quest/3933.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3933.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -48,7 +48,7 @@ function start(mode, type, selection) {\n                 qm.sendOk(\"There is someone currently in this map, come back later.\");\n                 qm.dispose();\n             } else {\n-                qm.warp(926000000);\n+                qm.warp(926000000, \"st00\");\n                 qm.forceStartQuest();\n                 qm.dispose();\n             }"}, {"sha": "850a492c4d1578294b78efe9dafca49b08d7a51f", "filename": "scripts/reactor/2200001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/reactor/2200001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/scripts/reactor/2200001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/2200001.js?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -28,5 +28,5 @@\n \n function act(){\n     rm.playerMessage(5,\"You have found a secret factory!\");\n-    rm.warp(Math.random() < .5 ? 922000020 : 922000021);\n+    rm.warp(Math.random() < .5 ? 922000020 : 922000021, 0);\n }\n\\ No newline at end of file"}, {"sha": "19794a205db2a25e02615a21d614602c476f6b6a", "filename": "sql/db_database.sql", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -16325,6 +16325,9 @@ CREATE TABLE IF NOT EXISTS `mts_items` (\n   `position` int(11) DEFAULT '0',\n   `upgradeslots` int(11) DEFAULT '0',\n   `level` int(11) DEFAULT '0',\n+  `itemlevel` int(11) NOT NULL DEFAULT '1',\n+  `itemexp` int(11) unsigned NOT NULL DEFAULT '0',\n+  `ringid` int(11) NOT NULL DEFAULT '-1',\n   `str` int(11) DEFAULT '0',\n   `dex` int(11) DEFAULT '0',\n   `int` int(11) DEFAULT '0',\n@@ -16348,6 +16351,8 @@ CREATE TABLE IF NOT EXISTS `mts_items` (\n   `transfer` int(2) DEFAULT '0',\n   `vicious` int(2) unsigned NOT NULL DEFAULT '0',\n   `flag` int(2) unsigned NOT NULL DEFAULT '0',\n+  `expiration` bigint(20) NOT NULL DEFAULT '-1',\n+  `giftFrom` varchar(26) NOT NULL,\n   PRIMARY KEY (`id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n "}, {"sha": "fd09457f4a9f1a659a060614a632176349126244", "filename": "src/client/AbstractCharacterListener.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/AbstractCharacterListener.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/AbstractCharacterListener.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/AbstractCharacterListener.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -26,5 +26,6 @@\n public interface AbstractCharacterListener {\n     public void onHpChanged(int oldHp);\n     public void onHpmpPoolUpdate();\n+    public void onStatUpdate();\n     public void onAnnounceStatPoolUpdate();\n }"}, {"sha": "03c2c1a4922748c60d2ca4dd0522b05a4f385de4", "filename": "src/client/AbstractMapleCharacterObject.java", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/AbstractMapleCharacterObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/AbstractMapleCharacterObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/AbstractMapleCharacterObject.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -220,6 +220,10 @@ private void dispatchHpmpPoolUpdated() {\n         listener.onHpmpPoolUpdate();\n     }\n     \n+    private void dispatchStatUpdated() {\n+        listener.onStatUpdate();\n+    }\n+    \n     private void dispatchStatPoolUpdateAnnounced() {\n         listener.onAnnounceStatPoolUpdate();\n     }\n@@ -299,6 +303,7 @@ private void changeStatPool(Long hpMpPool, Long strDexIntLuk, Long newSp, int ne\n         try {\n             statUpdates.clear();\n             boolean poolUpdate = false;\n+            boolean statUpdate = false;\n \n             if (hpMpPool != null) {\n                 short newHp = (short) (hpMpPool >> 48);\n@@ -370,7 +375,7 @@ private void changeStatPool(Long hpMpPool, Long strDexIntLuk, Long newSp, int ne\n                     statUpdates.put(MapleStat.AVAILABLEAP, remainingAp);\n                 }\n \n-                poolUpdate = true;  // recalc stats\n+                statUpdate = true;\n             }\n             \n             if (newSp != null) {\n@@ -385,6 +390,10 @@ private void changeStatPool(Long hpMpPool, Long strDexIntLuk, Long newSp, int ne\n                 if (poolUpdate) {\n                     dispatchHpmpPoolUpdated();\n                 }\n+                \n+                if (statUpdate) {\n+                    dispatchStatUpdated();\n+                }\n \n                 if (!silent) {\n                     dispatchStatPoolUpdateAnnounced();"}, {"sha": "54d913fc2fb9d98916aae418a636fa0b76d5f10d", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 79, "deletions": 24, "changes": 103, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -91,6 +91,7 @@\n import server.maps.FieldLimit;\n import server.maps.MapleHiredMerchant;\n import server.maps.MapleDoor;\n+import server.maps.MapleDoorObject;\n import server.maps.MapleDragon;\n import server.maps.MapleMap;\n import server.maps.MapleMapEffect;\n@@ -136,6 +137,7 @@\n import client.inventory.manipulator.MapleInventoryManipulator;\n import client.newyear.NewYearCardRecord;\n import client.processor.FredrickProcessor;\n+import client.processor.PetAutopotProcessor;\n import constants.ExpTable;\n import constants.GameConstants;\n import constants.ItemConstants;\n@@ -145,6 +147,7 @@\n import constants.skills.Bishop;\n import constants.skills.BlazeWizard;\n import constants.skills.Bowmaster;\n+import constants.skills.Brawler;\n import constants.skills.Buccaneer;\n import constants.skills.Corsair;\n import constants.skills.Crusader;\n@@ -166,7 +169,7 @@\n import constants.skills.Ranger;\n import constants.skills.Shadower;\n import constants.skills.Sniper;\n-import constants.skills.Swordsman;\n+import constants.skills.Warrior;\n import constants.skills.ThunderBreaker;\n import org.apache.mina.util.ConcurrentHashSet;\n \n@@ -357,6 +360,11 @@ public void onHpmpPoolUpdate() {\n                 }\n             }\n             \n+            @Override\n+            public void onStatUpdate() {\n+                recalcLocalStats();\n+            }\n+            \n             @Override\n             public void onAnnounceStatPoolUpdate() {\n                 List<Pair<MapleStat, Integer>> statup = new ArrayList<>(8);\n@@ -1647,15 +1655,19 @@ private static void updatePartyTownDoors(MapleParty party, MapleCharacter target\n             \n             for(MapleDoor door : partyDoors.values()) {\n                 for(MapleCharacter pchar : partyMembers) {\n-                    door.getTownDoor().sendDestroyData(pchar.getClient(), true);\n+                    MapleDoorObject mdo = door.getTownDoor();\n+                    mdo.sendDestroyData(pchar.getClient(), true);\n+                    pchar.removeVisibleMapObject(mdo);\n                 }\n             }\n             \n             if(partyLeaver != null) {\n                 Collection<MapleDoor> leaverDoors = partyLeaver.getDoors();\n                 for(MapleDoor door : leaverDoors) {\n                     for(MapleCharacter pchar : partyMembers) {\n-                        door.getTownDoor().sendDestroyData(pchar.getClient(), true);\n+                        MapleDoorObject mdo = door.getTownDoor();\n+                        mdo.sendDestroyData(pchar.getClient(), true);\n+                        pchar.removeVisibleMapObject(mdo);\n                     }\n                 }\n             }\n@@ -1666,7 +1678,9 @@ private static void updatePartyTownDoors(MapleParty party, MapleCharacter target\n \n                 if(door != null) {\n                     for(MapleCharacter pchar : partyMembers) {\n-                        door.getTownDoor().sendSpawnData(pchar.getClient());\n+                        MapleDoorObject mdo = door.getTownDoor();\n+                        mdo.sendSpawnData(pchar.getClient());\n+                        pchar.addVisibleMapObject(mdo);\n                     }\n                 }\n             }\n@@ -1677,17 +1691,24 @@ private static void updatePartyTownDoors(MapleParty party, MapleCharacter target\n             \n             if(partyDoors != null) {\n                 for(MapleDoor door : partyDoors.values()) {\n-                    door.getTownDoor().sendDestroyData(partyLeaver.getClient(), true);\n+                    MapleDoorObject mdo = door.getTownDoor();\n+                    mdo.sendDestroyData(partyLeaver.getClient(), true);\n+                    partyLeaver.removeVisibleMapObject(mdo);\n                 }\n             }\n             \n             for(MapleDoor door : leaverDoors) {\n-                door.getTownDoor().sendDestroyData(partyLeaver.getClient(), true);\n+                MapleDoorObject mdo = door.getTownDoor();\n+                mdo.sendDestroyData(partyLeaver.getClient(), true);\n+                partyLeaver.removeVisibleMapObject(mdo);\n             }\n             \n             for(MapleDoor door : leaverDoors) {\n                 door.updateDoorPortal(partyLeaver);\n-                door.getTownDoor().sendSpawnData(partyLeaver.getClient());\n+                \n+                MapleDoorObject mdo = door.getTownDoor();\n+                mdo.sendSpawnData(partyLeaver.getClient());\n+                partyLeaver.addVisibleMapObject(mdo);\n             }\n         }\n     }\n@@ -2697,6 +2718,24 @@ public void announceDiseases() {\n         }\n     }\n     \n+    public void collectDiseases() {\n+        for (MapleCharacter chr : map.getAllPlayers()) {\n+            int cid = chr.getId();\n+            \n+            for (Entry<MapleDisease, Pair<Long, MobSkill>> di : chr.getAllDiseases().entrySet()) {\n+                MapleDisease disease = di.getKey();\n+                MobSkill skill = di.getValue().getRight();\n+                final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(disease, Integer.valueOf(skill.getX())));\n+\n+                if (disease != MapleDisease.SLOW) {\n+                    this.announce(MaplePacketCreator.giveForeignDebuff(cid, debuff, skill));\n+                } else {\n+                    this.announce(MaplePacketCreator.giveForeignSlowDebuff(cid, debuff, skill));\n+                }\n+            }\n+        }\n+    }\n+    \n     public void giveDebuff(final MapleDisease disease, MobSkill skill) {\n         if (!hasDisease(disease) && getDiseasesSize() < 2) {\n             if (!(disease == MapleDisease.SEDUCE || disease == MapleDisease.STUN)) {\n@@ -6063,12 +6102,8 @@ public boolean hasEntered(String script) {\n     }\n \n     public boolean hasEntered(String script, int mapId) {\n-        if (entered.containsKey(mapId)) {\n-            if (entered.get(mapId).equals(script)) {\n-                return true;\n-            }\n-        }\n-        return false;\n+        String e = entered.get(mapId);\n+        return script.equals(e);\n     }\n \n     public void hasGivenFame(MapleCharacter to) {\n@@ -6416,7 +6451,7 @@ public synchronized void levelUp(boolean takeexp) {\n             addhp += Randomizer.rand(12, 16);\n             addmp += Randomizer.rand(10, 12);\n         } else if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1)) {\n-            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(DawnWarrior.MAX_HP_INCREASE) : SkillFactory.getSkill(Swordsman.IMPROVED_MAX_HP_INCREASE);\n+            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(DawnWarrior.MAX_HP_INCREASE) : SkillFactory.getSkill(Warrior.IMPROVED_MAXHP);\n             if (job.isA(MapleJob.CRUSADER)) {\n                 improvingMaxMP = SkillFactory.getSkill(1210000);\n             } else if (job.isA(MapleJob.DAWNWARRIOR2)) {\n@@ -6437,7 +6472,7 @@ public synchronized void levelUp(boolean takeexp) {\n             addhp += 30000;\n             addmp += 30000;\n         } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n-            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(ThunderBreaker.IMPROVE_MAX_HP) : SkillFactory.getSkill(5100000);\n+            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(ThunderBreaker.IMPROVE_MAX_HP) : SkillFactory.getSkill(Brawler.IMPROVE_MAX_HP);\n             improvingMaxHPLevel = getSkillLevel(improvingMaxHP);\n             addhp += Randomizer.rand(22, 28);\n             addmp += Randomizer.rand(18, 23);\n@@ -6446,7 +6481,7 @@ public synchronized void levelUp(boolean takeexp) {\n             int aids = Randomizer.rand(4, 8);\n             addmp += aids + Math.floor(aids * 0.1);\n         }\n-        if (improvingMaxHPLevel > 0 && (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.PIRATE) || job.isA(MapleJob.DAWNWARRIOR1))) {\n+        if (improvingMaxHPLevel > 0 && (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.PIRATE) || job.isA(MapleJob.DAWNWARRIOR1) || job.isA(MapleJob.THUNDERBREAKER1))) {\n             addhp += improvingMaxHP.getEffect(improvingMaxHPLevel).getX();\n         }\n         if (improvingMaxMPLevel > 0 && (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.CRUSADER) || job.isA(MapleJob.BLAZEWIZARD1))) {\n@@ -7920,7 +7955,7 @@ private void updateLocalStats() {\n                 client.announce(MaplePacketCreator.updatePlayerStats(hpmpupdate, true, this));\n             }\n \n-            if (oldmaxhp != localmaxhp) {\n+            if (oldmaxhp != localmaxhp) {   // thanks Wh1SK3Y for pointing out a deadlock occuring related to party members HP\n                 updatePartyMemberHP();\n             }\n         } finally {\n@@ -8072,15 +8107,11 @@ public void resetBattleshipHp() {\n     }\n     \n     public void resetEnteredScript() {\n-        if (entered.containsKey(map.getId())) {\n-            entered.remove(map.getId());\n-        }\n+        entered.remove(map.getId());\n     }\n \n     public void resetEnteredScript(int mapId) {\n-        if (entered.containsKey(mapId)) {\n-            entered.remove(mapId);\n-        }\n+        entered.remove(mapId);\n     }\n \n     public void resetEnteredScript(String script) {\n@@ -9102,11 +9133,35 @@ public boolean applyHpMpChange(int hpCon, int hpchange, int mpchange) {\n             }\n \n             updateHpMp(nextHp, nextMp);\n-            return true;\n         } finally {\n             statWlock.unlock();\n             effLock.unlock();\n         }\n+        \n+        // autopot on HPMP deplete... thanks shavit for finding out D. Roar doesn't trigger autopot request\n+        if (hpchange < 0) {\n+            MapleKeyBinding autohpPot = this.getKeymap().get(91);\n+            if (autohpPot != null) {\n+                int autohpItemid = autohpPot.getAction();\n+                Item autohpItem = this.getInventory(MapleInventoryType.USE).findById(autohpItemid);\n+                if (autohpItem != null) {\n+                    PetAutopotProcessor.runAutopotAction(client, autohpItem.getPosition(), autohpItemid);\n+                }\n+            }\n+        }\n+        \n+        if (mpchange < 0) {\n+            MapleKeyBinding autompPot = this.getKeymap().get(92);\n+            if (autompPot != null) {\n+                int autompItemid = autompPot.getAction();\n+                Item autompItem = this.getInventory(MapleInventoryType.USE).findById(autompItemid);\n+                if (autompItem != null) {\n+                    PetAutopotProcessor.runAutopotAction(client, autompItem.getPosition(), autompItemid);\n+                }\n+            }\n+        }\n+        \n+        return true;\n     }\n     \n     public void setInventory(MapleInventoryType type, MapleInventory inv) {"}, {"sha": "efd017ffc6c4a23c3b8d562b04256454555d7de5", "filename": "src/client/MapleFamily.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/MapleFamily.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/MapleFamily.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleFamily.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -217,7 +217,11 @@ public static void loadAllFamilies() {\n                     int repsToSenior = rsEntries.getInt(\"reptosenior\");\n                     String precepts = rsEntries.getString(\"precepts\");\n                     //Timestamp lastResetTime = rsEntries.getTimestamp(\"lastresettime\"); //taken care of by FamilyDailyResetWorker\n-                    MapleFamily family = Server.getInstance().getWorld(world).getFamily(familyid);\n+                    World wserv = Server.getInstance().getWorld(world);\n+                    if (wserv == null) {\n+                        continue;\n+                    }\n+                    MapleFamily family = wserv.getFamily(familyid);\n                     if(family == null) {\n                         family = new MapleFamily(familyid, world);\n                         Server.getInstance().getWorld(world).addFamily(familyid, family);"}, {"sha": "7b542c0e2d8ab408ce89f12eec349cdd53927120", "filename": "src/client/SkillFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/SkillFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/SkillFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/SkillFactory.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -68,7 +68,7 @@\n import constants.skills.Sniper;\n import constants.skills.Spearman;\n import constants.skills.SuperGM;\n-import constants.skills.Swordsman;\n+import constants.skills.Warrior;\n import constants.skills.ThunderBreaker;\n import constants.skills.WhiteKnight;\n import constants.skills.WindArcher;\n@@ -189,7 +189,7 @@ private static Skill loadFromData(int id, MapleData data) {\n                 case Beginner.MONSTER_RIDER:\n                 case Beginner.ECHO_OF_HERO:\n                 case Beginner.MAP_CHAIR:\n-                case Swordsman.IRON_BODY:\n+                case Warrior.IRON_BODY:\n                 case Fighter.AXE_BOOSTER:\n                 case Fighter.POWER_GUARD:\n                 case Fighter.RAGE:"}, {"sha": "30fe248e215f19513ddc5a53e1feff056997777a", "filename": "src/client/processor/AssignAPProcessor.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/AssignAPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/AssignAPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/AssignAPProcessor.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -38,6 +38,7 @@\n import constants.skills.Brawler;\n import constants.skills.DawnWarrior;\n import constants.skills.Magician;\n+import constants.skills.ThunderBreaker;\n import constants.skills.Warrior;\n import java.util.ArrayList;\n import java.util.Collection;\n@@ -697,7 +698,7 @@ private static int calcHpChange(MapleCharacter player, boolean usedAPReset) {\n             }\n         } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n             if(!usedAPReset) {\n-                Skill increaseHP = SkillFactory.getSkill(Brawler.IMPROVE_MAX_HP);\n+                Skill increaseHP = SkillFactory.getSkill(job.isA(MapleJob.PIRATE) ? Brawler.IMPROVE_MAX_HP : ThunderBreaker.IMPROVE_MAX_HP);\n                 int sLvl = player.getSkillLevel(increaseHP);\n \n                 if(sLvl > 0)"}, {"sha": "9b2a14ce055822e4ee5dd65660c700dd65ced560", "filename": "src/client/processor/FredrickProcessor.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/FredrickProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/FredrickProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/FredrickProcessor.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -37,7 +37,6 @@\n import java.util.LinkedList;\n import java.util.List;\n import client.inventory.manipulator.MapleInventoryManipulator;\n-import constants.ServerConstants;\n import java.util.Collections;\n import net.server.Server;\n import net.server.world.World;"}, {"sha": "faaf04912ade69cd8bbac53621672f07ebc8a9f1", "filename": "src/client/processor/PetAutopotProcessor.java", "status": "added", "additions": 178, "deletions": 0, "changes": 178, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/PetAutopotProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/client/processor/PetAutopotProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/PetAutopotProcessor.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -0,0 +1,178 @@\n+/*\n+\tThis file is part of the OdinMS Maple Story Server\n+    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n+\t\t       Matthias Butz <matze@odinms.de>\n+\t\t       Jan Christian Meyer <vimes@odinms.de>\n+\n+    Copyleft (L) 2016 - 2019 RonanLana (HeavenMS)\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package client.processor;\n+\n+import client.MapleCharacter;\n+import client.MapleClient;\n+import client.inventory.Item;\n+import client.inventory.MapleInventory;\n+import client.inventory.MapleInventoryType;\n+import client.inventory.manipulator.MapleInventoryManipulator;\n+import constants.ServerConstants;\n+import java.util.List;\n+import server.MapleItemInformationProvider;\n+import server.MapleStatEffect;\n+import tools.MaplePacketCreator;\n+\n+/**\n+ *\n+ * @author Ronan - multi-pot consumption feature\n+ */\n+public class PetAutopotProcessor {\n+    \n+    private static class AutopotAction {\n+        \n+        private MapleClient c;\n+        private short slot;\n+        private int itemId;\n+        \n+        private Item toUse;\n+        private List<Item> toUseList;\n+\n+        private boolean hasHpGain, hasMpGain;\n+        private int maxHp, maxMp, curHp, curMp;\n+        private double incHp, incMp;\n+        \n+        private boolean cursorOnNextAvailablePot(MapleCharacter chr) {\n+            if(toUseList == null) {\n+                toUseList = chr.getInventory(MapleInventoryType.USE).linkedListById(itemId);\n+            }\n+\n+            toUse = null;\n+            while(!toUseList.isEmpty()) {\n+                Item it = toUseList.remove(0);\n+\n+                if(it.getQuantity() > 0) {\n+                    toUse = it;\n+                    slot = it.getPosition();\n+\n+                    return true;\n+                }\n+            }\n+\n+            return false;\n+        }\n+        \n+        public AutopotAction(MapleClient c, short slot, int itemId) {\n+            this.c = c;\n+            this.slot = slot;\n+            this.itemId = itemId;\n+        }\n+        \n+        public void run() {\n+            MapleClient c = this.c;\n+            MapleCharacter chr = c.getPlayer();\n+            if (!chr.isAlive()) {\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n+            \n+            int useCount = 0, qtyCount = 0;\n+            MapleStatEffect stat = null;\n+\n+            MapleInventory useInv = chr.getInventory(MapleInventoryType.USE);\n+            useInv.lockInventory();\n+            try {\n+                toUse = useInv.getItem(slot);\n+                if (toUse != null) {\n+                    if (toUse.getItemId() != itemId) {\n+                        c.announce(MaplePacketCreator.enableActions());\n+                        return;\n+                    }\n+\n+                    toUseList = null;\n+\n+                    // from now on, toUse becomes the \"cursor\" for the current pot being used\n+                    if (toUse.getQuantity() <= 0) {\n+                        if (!cursorOnNextAvailablePot(chr)) {\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n+                        }\n+                    }\n+\n+                    stat = MapleItemInformationProvider.getInstance().getItemEffect(toUse.getItemId());\n+                    hasHpGain = stat.getHp() > 0 || stat.getHpRate() > 0.0;\n+                    hasMpGain = stat.getMp() > 0 || stat.getMpRate() > 0.0;\n+\n+                    maxHp = chr.getCurrentMaxHp();\n+                    maxMp = chr.getCurrentMaxMp();\n+\n+                    curHp = chr.getHp();\n+                    curMp = chr.getMp();\n+\n+                    incHp = stat.getHp();\n+                    if(incHp <= 0 && hasHpGain) incHp = Math.ceil(maxHp * stat.getHpRate());\n+\n+                    incMp = stat.getMp();\n+                    if(incMp <= 0 && hasMpGain) incMp = Math.ceil(maxMp * stat.getMpRate());\n+\n+                    if (ServerConstants.USE_COMPULSORY_AUTOPOT) {\n+                        if (hasHpGain) {\n+                            qtyCount = (int) Math.ceil(((ServerConstants.PET_AUTOHP_RATIO * maxHp) - curHp) / incHp);\n+                        }\n+\n+                        if (hasMpGain) {\n+                            qtyCount = Math.max(qtyCount, (int) Math.ceil(((ServerConstants.PET_AUTOMP_RATIO * maxMp) - curMp) / incMp));\n+                        }\n+                    } else {\n+                        qtyCount = 1;   // non-compulsory autopot concept thanks to marcuswoon\n+                    }\n+\n+                    while (true) {\n+                        short qtyToUse = (short) Math.min(qtyCount, toUse.getQuantity());\n+                        MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, slot, qtyToUse, false);\n+\n+                        curHp += (incHp * qtyToUse);\n+                        curMp += (incMp * qtyToUse);\n+\n+                        useCount += qtyToUse;\n+                        qtyCount -= qtyToUse;\n+\n+                        if(toUse.getQuantity() == 0 && qtyCount > 0) {\n+                            // depleted out the current slot, fetch for more\n+\n+                            if(!cursorOnNextAvailablePot(chr)) {\n+                                break;    // no more pots available\n+                            }\n+                        } else {\n+                            break;    // gracefully finished it's job, quit the loop\n+                        }\n+                    }\n+                }\n+            } finally {\n+                useInv.unlockInventory();\n+            }\n+\n+            for (int i = 0; i < useCount; i++) {\n+                stat.applyTo(chr);\n+            }\n+\n+            chr.announce(MaplePacketCreator.enableActions());\n+        }\n+    }\n+    \n+    public static void runAutopotAction(MapleClient c, short slot, int itemid) {\n+        AutopotAction action = new AutopotAction(c, slot, itemid);\n+        action.run();\n+    }\n+    \n+}"}, {"sha": "4a29d301c78cc8d7447c8d98097e4470a18f2e46", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -135,7 +135,7 @@\n     public static final boolean USE_MAKER_FEE_HEURISTICS = true;    //Apply compiled values for stimulants and reagents into the Maker fee calculations (max error revolves around 50k mesos). Set false to use basic constant values instead (results are never higher than requested by the client-side).\n     \n     //Custom Configuration\n-    public static final boolean USE_ENABLE_CUSTOM_NPC_SCRIPT = true;//Enables usage of custom HeavenMS NPC scripts (Agent E, Coco, etc). Will not disable Abdula (it's actually useful for the gameplay), quests or NPC shops.\n+    public static final boolean USE_ENABLE_CUSTOM_NPC_SCRIPT = true;//Enables usage of custom HeavenMS NPC scripts (Agent E, Coco, etc). Will not disable Abdula (it's actually useful for the gameplay) or quests.\n     public static final boolean USE_STARTER_MERGE = false;          //Allows any players to use the Equipment Merge custom mechanic (as opposed to the high-level, Maker lv3 requisites).\n     \n     //Commands Configuration"}, {"sha": "7a78c8ff6952085d41f9679669705113814a21c9", "filename": "src/constants/skills/Aran.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/skills/Aran.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/skills/Aran.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/skills/Aran.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -47,7 +47,6 @@\n     public static final int HIDDEN_FULL_TRIPLE = 21110008;\n     public static final int SMART_KNOCKBACK = 21111001;\n     public static final int OVER_SWING = 21120002;\n-    public static final int HIGH_DEFENSE = 21120004;\n     public static final int COMBO_TEMPEST = 21120006;\n     public static final int COMBO_BARRIER = 21120007;\n     public static final int HIDDEN_OVER_DOUBLE = 21120009;"}, {"sha": "979a87696d7712bbcbf803584d416614c250d0f2", "filename": "src/constants/skills/Swordsman.java", "status": "removed", "additions": 0, "deletions": 31, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/constants/skills/Swordsman.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/259c2e5ba19c915a9aff59a23aaf3fdace810d29/src/constants/skills/Swordsman.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/skills/Swordsman.java?ref=259c2e5ba19c915a9aff59a23aaf3fdace810d29", "patch": "@@ -1,31 +0,0 @@\n-/*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-package constants.skills;\n-\n-/**\n- *\n- * @author BubblesDev\n- */\n-public class Swordsman {\n-    public static final int IMPROVED_MAX_HP_INCREASE = 1000001;\n-    public static final int IRON_BODY = 1000003;\n-}\n\\ No newline at end of file"}, {"sha": "7bb463fa70803ea8d318ae90d085db586fa8f8ba", "filename": "src/constants/skills/Warrior.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/skills/Warrior.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/constants/skills/Warrior.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/skills/Warrior.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -11,4 +11,5 @@\n public class Warrior {\n     public static final int  IMPROVED_HPREC = 1000000;\n     public static final int  IMPROVED_MAXHP = 1000001;\n+    public static final int  IRON_BODY = 1000003;\n }"}, {"sha": "a370db5cc8ee8547c4a01754568ec0d067e45dec", "filename": "src/net/server/Server.java", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -677,6 +677,7 @@ public void runAnnouncePlayerDiseasesSchedule() {\n             MapleCharacter player = c.getPlayer();\n             if(player != null && player.isLoggedinWorld()) {\n                 player.announceDiseases();\n+                player.collectDiseases();\n             }\n         }\n         \n@@ -1111,18 +1112,25 @@ public MapleGuild getGuild(int id, int world) {\n     \n     public MapleGuild getGuild(int id, int world, MapleCharacter mc) {\n         synchronized (guilds) {\n-            if (guilds.get(id) != null) {\n-                return guilds.get(id);\n+            MapleGuild g = guilds.get(id);\n+            if (g != null) {\n+                return g;\n             }\n-            MapleGuild g = new MapleGuild(id, world);\n+            \n+            g = new MapleGuild(id, world);\n             if (g.getId() == -1) {\n                 return null;\n             }\n             \n             if(mc != null) {\n-                mc.setMGC(g.getMGC(mc.getId()));\n-                if(g.getMGC(mc.getId()) == null) System.out.println(\"null for \" + mc.getName() + \" when loading guild \" + id);\n-                g.getMGC(mc.getId()).setCharacter(mc);\n+                MapleGuildCharacter mgc = g.getMGC(mc.getId());\n+                if (mgc != null) {\n+                    mc.setMGC(mgc);\n+                    mgc.setCharacter(mc);\n+                } else {\n+                    FilePrinter.printError(FilePrinter.GUILD_CHAR_ERROR, \"Could not find \" + mc.getName() + \" when loading guild \" + id + \".\");\n+                }\n+                \n                 g.setOnline(mc.getId(), true, mc.getClient().getChannel());\n             }\n             "}, {"sha": "2ca1a9bcec799056d6f3efae2e0f29f5e441ccef", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -653,16 +653,16 @@ protected AttackInfo parseDamage(LittleEndianAccessor lea, MapleCharacter chr, b\n         \n         // Find the base damage to base futher calculations on.\n         // Several skills have their own formula in this section.\n-        long calcDmgMax = 0;\t\n+        long calcDmgMax = 0;\n         \n-        if(magic && ret.skill != 0) {\n-            calcDmgMax = (chr.getTotalMagic() * chr.getTotalMagic() / 1000 + chr.getTotalMagic()) / 30 + chr.getTotalInt() / 200;\n+        if(magic && ret.skill != 0) {   // thanks onechord for noticing a few false positives stemming from maxdmg as 0\n+            calcDmgMax = (long) (Math.ceil((chr.getTotalMagic() * Math.ceil(chr.getTotalMagic() / 1000.0) + chr.getTotalMagic()) / 30.0) + Math.ceil(chr.getTotalInt() / 200.0));\n         } else if(ret.skill == 4001344 || ret.skill == NightWalker.LUCKY_SEVEN || ret.skill == NightLord.TRIPLE_THROW) {\n-            calcDmgMax = (chr.getTotalLuk() * 5) * chr.getTotalWatk() / 100;\n+            calcDmgMax = (long) ((chr.getTotalLuk() * 5) * Math.ceil(chr.getTotalWatk() / 100.0));\n         } else if(ret.skill == DragonKnight.DRAGON_ROAR) {\n-            calcDmgMax = (chr.getTotalStr() * 4 + chr.getTotalDex()) * chr.getTotalWatk() / 100;\n+            calcDmgMax = (long) ((chr.getTotalStr() * 4 + chr.getTotalDex()) * Math.ceil(chr.getTotalWatk() / 100.0));\n         } else if(ret.skill == NightLord.VENOMOUS_STAR || ret.skill == Shadower.VENOMOUS_STAB) {\n-            calcDmgMax = (int) (18.5 * (chr.getTotalStr() + chr.getTotalLuk()) + chr.getTotalDex() * 2) / 100 * chr.calculateMaxBaseDamage(chr.getTotalWatk());\n+            calcDmgMax = (long) (Math.ceil((18.5 * (chr.getTotalStr() + chr.getTotalLuk()) + chr.getTotalDex() * 2) / 100.0) * chr.calculateMaxBaseDamage(chr.getTotalWatk()));\n         } else {\n             calcDmgMax = chr.calculateMaxBaseDamage(chr.getTotalWatk());\n         }"}, {"sha": "f24956088e9ec0fa467c3a2e80de712fae37a61f", "filename": "src/net/server/channel/handlers/AllianceOperationHandler.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/AllianceOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/AllianceOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AllianceOperationHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -124,7 +124,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Server.getInstance().resetAllianceGuildPlayersRank(guildid);\n                 \n                 chr.getMGC().setAllianceRank(2);\n-                Server.getInstance().getGuild(chr.getGuildId()).getMGC(chr.getId()).setAllianceRank(2);\n+                MapleGuild g = Server.getInstance().getGuild(chr.getGuildId());\n+                if (g != null) {\n+                    g.getMGC(chr.getId()).setAllianceRank(2);\n+                }\n+                \n                 chr.saveGuildStatus();\n \n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.addGuildToAlliance(alliance, guildid, c), -1, -1);"}, {"sha": "cc5551c571278167c4a79330d3130ed3a7e2aa36", "filename": "src/net/server/channel/handlers/CloseRangeDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/CloseRangeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/CloseRangeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CloseRangeDamageHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -33,7 +33,6 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.MapleJob;\n-import client.MapleStat;\n import client.Skill;\n import client.SkillFactory;\n import constants.GameConstants;\n@@ -47,6 +46,7 @@\n import constants.skills.WindArcher;\n \n public final class CloseRangeDamageHandler extends AbstractDealDamageHandler {\n+    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();"}, {"sha": "ce78a5ca124d57c7655227a1a6a1aa719e601965", "filename": "src/net/server/channel/handlers/EnterMTSHandler.java", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/EnterMTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/EnterMTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterMTSHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -152,6 +152,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         equip.setWdef((short) rs.getInt(\"wdef\"));\n                         equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                         equip.setLevel((byte) rs.getInt(\"level\"));\n+                        equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                        equip.setItemExp(rs.getInt(\"itemexp\"));\n+                        equip.setRingId(rs.getInt(\"ringid\"));\n+                        equip.setExpiration(rs.getLong(\"expiration\"));\n+                        equip.setGiftFrom(rs.getString(\"giftFrom\"));\n+                        \n                         items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\") + 100 + (int) (rs.getInt(\"price\") * 0.1), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                     }\n                 }\n@@ -209,7 +215,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rs.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n+                            equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                            equip.setItemExp(rs.getInt(\"itemexp\"));\n+                            equip.setRingId(rs.getInt(\"ringid\"));\n                             equip.setFlag((short) rs.getInt(\"flag\"));\n+                            equip.setExpiration(rs.getLong(\"expiration\"));\n+                            equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                             items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                         }\n                     }\n@@ -256,7 +267,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rs.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n+                            equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                            equip.setItemExp(rs.getInt(\"itemexp\"));\n+                            equip.setRingId(rs.getInt(\"ringid\"));\n                             equip.setFlag((short) rs.getInt(\"flag\"));\n+                            equip.setExpiration(rs.getLong(\"expiration\"));\n+                            equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                             items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                         }\n                     }"}, {"sha": "3ccdc2f007db8b01e3333692df3e6d5c67c7e4b2", "filename": "src/net/server/channel/handlers/MTSHandler.java", "status": "modified", "additions": 69, "deletions": 32, "changes": 101, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MTSHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -160,48 +160,55 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         }\n                         if (!i.getInventoryType().equals(MapleInventoryType.EQUIP)) {\n                             Item item = (Item) i;\n-                            ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, seller, price, owner, sellername, sell_ends) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n+                            ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, expiration, giftFrom, seller, price, owner, sellername, sell_ends) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             ps.setInt(1, 1);\n                             ps.setInt(2, (int) invType.getType());\n                             ps.setInt(3, item.getItemId());\n                             ps.setInt(4, quantity);\n-                            ps.setInt(5, c.getPlayer().getId());\n-                            ps.setInt(6, price);\n-                            ps.setString(7, item.getOwner());\n-                            ps.setString(8, c.getPlayer().getName());\n-                            ps.setString(9, date);\n+                            ps.setLong(5, item.getExpiration());\n+                            ps.setString(6, item.getGiftFrom());\n+                            ps.setInt(7, c.getPlayer().getId());\n+                            ps.setInt(8, price);\n+                            ps.setString(9, item.getOwner());\n+                            ps.setString(10, c.getPlayer().getName());\n+                            ps.setString(11, date);\n                         } else {\n                             Equip equip = (Equip) i;\n-                            ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, seller, price, upgradeslots, level, str, dex, `int`, luk, hp, mp, watk, matk, wdef, mdef, acc, avoid, hands, speed, jump, locked, owner, sellername, sell_ends, vicious, flag) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n+                            ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, expiration, giftFrom, seller, price, upgradeslots, level, str, dex, `int`, luk, hp, mp, watk, matk, wdef, mdef, acc, avoid, hands, speed, jump, locked, owner, sellername, sell_ends, vicious, flag, itemexp, itemlevel, ringid) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             ps.setInt(1, 1);\n                             ps.setInt(2, (int) invType.getType());\n                             ps.setInt(3, equip.getItemId());\n                             ps.setInt(4, quantity);\n-                            ps.setInt(5, c.getPlayer().getId());\n-                            ps.setInt(6, price);\n-                            ps.setInt(7, equip.getUpgradeSlots());\n-                            ps.setInt(8, equip.getLevel());\n-                            ps.setInt(9, equip.getStr());\n-                            ps.setInt(10, equip.getDex());\n-                            ps.setInt(11, equip.getInt());\n-                            ps.setInt(12, equip.getLuk());\n-                            ps.setInt(13, equip.getHp());\n-                            ps.setInt(14, equip.getMp());\n-                            ps.setInt(15, equip.getWatk());\n-                            ps.setInt(16, equip.getMatk());\n-                            ps.setInt(17, equip.getWdef());\n-                            ps.setInt(18, equip.getMdef());\n-                            ps.setInt(19, equip.getAcc());\n-                            ps.setInt(20, equip.getAvoid());\n-                            ps.setInt(21, equip.getHands());\n-                            ps.setInt(22, equip.getSpeed());\n-                            ps.setInt(23, equip.getJump());\n-                            ps.setInt(24, 0);\n-                            ps.setString(25, equip.getOwner());\n-                            ps.setString(26, c.getPlayer().getName());\n-                            ps.setString(27, date);\n-                            ps.setInt(28, equip.getVicious());\n-                            ps.setInt(29, equip.getFlag());\n+                            ps.setLong(5, equip.getExpiration());\n+                            ps.setString(6, equip.getGiftFrom());\n+                            ps.setInt(7, c.getPlayer().getId());\n+                            ps.setInt(8, price);\n+                            ps.setInt(9, equip.getUpgradeSlots());\n+                            ps.setInt(10, equip.getLevel());\n+                            ps.setInt(11, equip.getStr());\n+                            ps.setInt(12, equip.getDex());\n+                            ps.setInt(13, equip.getInt());\n+                            ps.setInt(14, equip.getLuk());\n+                            ps.setInt(15, equip.getHp());\n+                            ps.setInt(16, equip.getMp());\n+                            ps.setInt(17, equip.getWatk());\n+                            ps.setInt(18, equip.getMatk());\n+                            ps.setInt(19, equip.getWdef());\n+                            ps.setInt(20, equip.getMdef());\n+                            ps.setInt(21, equip.getAcc());\n+                            ps.setInt(22, equip.getAvoid());\n+                            ps.setInt(23, equip.getHands());\n+                            ps.setInt(24, equip.getSpeed());\n+                            ps.setInt(25, equip.getJump());\n+                            ps.setInt(26, 0);\n+                            ps.setString(27, equip.getOwner());\n+                            ps.setString(28, c.getPlayer().getName());\n+                            ps.setString(29, date);\n+                            ps.setInt(30, equip.getVicious());\n+                            ps.setInt(31, equip.getFlag());\n+                            ps.setInt(32, equip.getItemExp());\n+                            ps.setByte(33, equip.getItemLevel());    // thanks Jefe for noticing missing itemlevel labels\n+                            ps.setInt(34, equip.getRingId());\n                         }\n                         ps.executeUpdate();\n                         ps.close();\n@@ -320,8 +327,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rs.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n+                            equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                            equip.setItemExp(rs.getInt(\"itemexp\"));\n+                            equip.setRingId(rs.getInt(\"ringid\"));\n                             equip.setVicious((byte) rs.getInt(\"vicious\"));\n                             equip.setFlag((short) rs.getInt(\"flag\"));\n+                            equip.setExpiration(rs.getLong(\"expiration\"));\n+                            equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                             equip.setPosition(c.getPlayer().getInventory(ItemConstants.getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n                             i = equip.copy();\n                         }\n@@ -569,6 +581,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n                     equip.setFlag((short) rs.getInt(\"flag\"));\n+                    equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                    equip.setItemExp(rs.getInt(\"itemexp\"));\n+                    equip.setRingId(rs.getInt(\"ringid\"));\n+                    equip.setExpiration(rs.getLong(\"expiration\"));\n+                    equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -623,7 +640,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rse.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rse.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rse.getInt(\"level\"));\n+                            equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                            equip.setItemExp(rs.getInt(\"itemexp\"));\n+                            equip.setRingId(rs.getInt(\"ringid\"));\n                             equip.setFlag((short) rs.getInt(\"flag\"));\n+                            equip.setExpiration(rs.getLong(\"expiration\"));\n+                            equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                             items.add(new MTSItemInfo((Item) equip, rse.getInt(\"price\"), rse.getInt(\"id\"), rse.getInt(\"seller\"), rse.getString(\"sellername\"), rse.getString(\"sell_ends\")));\n                         }\n                     }\n@@ -686,7 +708,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n+                    equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                    equip.setItemExp(rs.getInt(\"itemexp\"));\n+                    equip.setRingId(rs.getInt(\"ringid\"));\n                     equip.setFlag((short) rs.getInt(\"flag\"));\n+                    equip.setExpiration(rs.getLong(\"expiration\"));\n+                    equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -747,7 +774,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n+                    equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                    equip.setItemExp(rs.getInt(\"itemexp\"));\n+                    equip.setRingId(rs.getInt(\"ringid\"));\n                     equip.setFlag((short) rs.getInt(\"flag\"));\n+                    equip.setExpiration(rs.getLong(\"expiration\"));\n+                    equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -841,7 +873,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n+                    equip.setItemLevel(rs.getByte(\"itemlevel\"));\n+                    equip.setItemExp(rs.getInt(\"itemexp\"));\n+                    equip.setRingId(rs.getInt(\"ringid\"));\n                     equip.setFlag((short) rs.getInt(\"flag\"));\n+                    equip.setExpiration(rs.getLong(\"expiration\"));\n+                    equip.setGiftFrom(rs.getString(\"giftFrom\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }"}, {"sha": "52778e8b12d5025d16367b4825cd0138e49152b8", "filename": "src/net/server/channel/handlers/MagicDamageHandler.java", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MagicDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MagicDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MagicDamageHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -62,9 +62,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         c.announce(MaplePacketCreator.getEnergy(\"energy\", chr.getDojoEnergy()));\n                 }\n \n-                int charge = (attack.skill == Evan.FIRE_BREATH || attack.skill == Evan.ICE_BREATH || attack.skill == FPArchMage.BIG_BANG || attack.skill == ILArchMage.BIG_BANG || attack.skill == Bishop.BIG_BANG) ? attack.charge : -1;\n-                byte[] packet = MaplePacketCreator.magicAttack(chr, attack.skill, attack.skilllevel, attack.stance, attack.numAttackedAndDamage, attack.allDamage, charge, attack.speed, attack.direction, attack.display);\n-\t\t\n+                byte[] packet;\n+                if ((attack.skill == Evan.FIRE_BREATH || attack.skill == Evan.ICE_BREATH || attack.skill == FPArchMage.BIG_BANG || attack.skill == ILArchMage.BIG_BANG || attack.skill == Bishop.BIG_BANG)) {\n+                        packet = MaplePacketCreator.magicAttack(chr, attack.skill, attack.skilllevel, attack.stance, attack.numAttackedAndDamage, attack.allDamage, attack.charge, attack.speed, attack.direction, attack.display);\n+                } else {\n+                        packet = MaplePacketCreator.closeRangeAttack(chr, attack.skill, attack.skilllevel, attack.stance, attack.numAttackedAndDamage, attack.allDamage, attack.speed, attack.direction, attack.display);\n+                }\n+                \n \t\tchr.getMap().broadcastMessage(chr, packet, false, true);\n \t\tMapleStatEffect effect = attack.getAttackEffect(chr, null);\n \t\tSkill skill = SkillFactory.getSkill(attack.skill);"}, {"sha": "b1c52deaef3faae922f404ee0e876a3b1abf01a3", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -36,7 +36,6 @@\n import server.maps.MapleMap;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n-import server.movement.LifeMovementFragment;\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;"}, {"sha": "c27d06a8029736ea4c21c39d06eb8ae8dc1c03c0", "filename": "src/net/server/channel/handlers/PetAutoPotHandler.java", "status": "modified", "additions": 6, "deletions": 134, "changes": 140, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PetAutoPotHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PetAutoPotHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetAutoPotHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -4,167 +4,39 @@\n \t\t       Matthias Butz <matze@odinms.de>\n \t\t       Jan Christian Meyer <vimes@odinms.de>\n \n-    Copyleft (L) 2016 - 2018 RonanLana (HeavenMS)\n-\n     This program is free software: you can redistribute it and/or modify\n     it under the terms of the GNU Affero General Public License as\n     published by the Free Software Foundation version 3 as published by\n     the Free Software Foundation. You may not use, modify or distribute\n     this program under any other version of the GNU Affero General Public\n     License.\n+\n     This program is distributed in the hope that it will be useful,\n     but WITHOUT ANY WARRANTY; without even the implied warranty of\n     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n     GNU Affero General Public License for more details.\n+\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n package net.server.channel.handlers;\n \n import client.MapleClient;\n-import client.MapleCharacter;\n-import client.inventory.Item;\n-import client.inventory.MapleInventory;\n-import client.inventory.MapleInventoryType;\n+import client.processor.PetAutopotProcessor;\n import net.AbstractMaplePacketHandler;\n-import client.inventory.manipulator.MapleInventoryManipulator;\n-import server.MapleItemInformationProvider;\n-import server.MapleStatEffect;\n-import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n-import constants.ServerConstants;\n-import java.util.List;\n \n-/**\n- *\n- * @author Ronan - multi-pot consumption feature\n- */\n public final class PetAutoPotHandler extends AbstractMaplePacketHandler {\n-    short slot;\n-    int itemId;\n-    Item toUse;\n-    List<Item> toUseList;\n-    \n-    boolean hasHpGain, hasMpGain;\n-    int maxHp, maxMp, curHp, curMp;\n-    double incHp, incMp;\n     \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        if (!c.getPlayer().isAlive()) {\n-            c.announce(MaplePacketCreator.enableActions());\n-            return;\n-        }\n-        \n         slea.readByte();\n         slea.readLong();\n         slea.readInt();\n-        slot = slea.readShort();\n-        itemId = slea.readInt();\n-        \n-        MapleCharacter chr = c.getPlayer();\n-        MapleInventory useInv = chr.getInventory(MapleInventoryType.USE);\n-        \n-        int useCount = 0, qtyCount = 0;\n-        MapleStatEffect stat = null;\n-        \n-        useInv.lockInventory();\n-        try {\n-            toUse = useInv.getItem(slot);\n-            \n-            if (toUse != null) {\n-                if (toUse.getItemId() != itemId) {\n-                    c.announce(MaplePacketCreator.enableActions());\n-                    return;\n-                }\n-                \n-                toUseList = null;\n-                \n-                // from now on, toUse becomes the \"cursor\" for the current pot being used\n-                if (toUse.getQuantity() <= 0) {\n-                    if (!cursorOnNextAvailablePot(chr)) {\n-                        c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                }\n-                \n-                stat = MapleItemInformationProvider.getInstance().getItemEffect(toUse.getItemId());\n-                hasHpGain = stat.getHp() > 0 || stat.getHpRate() > 0.0;\n-                hasMpGain = stat.getMp() > 0 || stat.getMpRate() > 0.0;\n-                \n-                maxHp = chr.getCurrentMaxHp();\n-                maxMp = chr.getCurrentMaxMp();\n-                \n-                curHp = chr.getHp();\n-                curMp = chr.getMp();\n-                \n-                incHp = stat.getHp();\n-                if(incHp <= 0 && hasHpGain) incHp = Math.ceil(maxHp * stat.getHpRate());\n-                \n-                incMp = stat.getMp();\n-                if(incMp <= 0 && hasMpGain) incMp = Math.ceil(maxMp * stat.getMpRate());\n-                \n-                if (ServerConstants.USE_COMPULSORY_AUTOPOT) {\n-                    if (hasHpGain) {\n-                        qtyCount = (int) Math.ceil(((ServerConstants.PET_AUTOHP_RATIO * maxHp) - curHp) / incHp);\n-                    }\n-\n-                    if (hasMpGain) {\n-                        qtyCount = Math.max(qtyCount, (int) Math.ceil(((ServerConstants.PET_AUTOMP_RATIO * maxMp) - curMp) / incMp));\n-                    }\n-                } else {\n-                    qtyCount = 1;   // non-compulsory autopot concept thanks to marcuswoon\n-                }\n-\n-                while (true) {\n-                    short qtyToUse = (short) Math.min(qtyCount, toUse.getQuantity());\n-                    MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.USE, slot, qtyToUse, false);\n-                    \n-                    curHp += (incHp * qtyToUse);\n-                    curMp += (incMp * qtyToUse);\n-                    \n-                    useCount += qtyToUse;\n-                    qtyCount -= qtyToUse;\n-                    \n-                    if(toUse.getQuantity() == 0 && qtyCount > 0) {\n-                        // depleted out the current slot, fetch for more\n-\n-                        if(!cursorOnNextAvailablePot(chr)) {\n-                            break;    // no more pots available\n-                        }\n-                    } else {\n-                        break;    // gracefully finished it's job, quit the loop\n-                    }\n-                }\n-            }\n-        } finally {\n-            useInv.unlockInventory();\n-        }\n-        \n-        for (int i = 0; i < useCount; i++) {\n-            stat.applyTo(chr);\n-        }\n+        short slot = slea.readShort();\n+        int itemId = slea.readInt();\n         \n-        chr.announce(MaplePacketCreator.enableActions());\n+        PetAutopotProcessor.runAutopotAction(c, slot, itemId);\n     }\n     \n-    private boolean cursorOnNextAvailablePot(MapleCharacter chr) {\n-        if(toUseList == null) {\n-            toUseList = chr.getInventory(MapleInventoryType.USE).linkedListById(itemId);\n-        }\n-\n-        toUse = null;\n-        while(!toUseList.isEmpty()) {\n-            Item it = toUseList.remove(0);\n-\n-            if(it.getQuantity() > 0) {\n-                toUse = it;\n-                slot = it.getPosition();\n-\n-                return true;\n-            }\n-        }\n-        \n-        return false;\n-    } \n }"}, {"sha": "05cf6b391e1840915cfd46003fbf9cf3984d7ac8", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -268,11 +268,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         if(familyEntry != null) {\n                             familyEntry.setCharacter(player);\n                             player.setFamilyEntry(familyEntry);\n+                            \n+                            c.announce(MaplePacketCreator.getFamilyInfo(familyEntry));\n+                            familyEntry.announceToSenior(MaplePacketCreator.sendFamilyLoginNotice(player.getName(), true), true);\n                         } else {\n                             FilePrinter.printError(FilePrinter.FAMILY_ERROR, \"Player \" + player.getName() + \"'s family doesn't have an entry for them. (\" + f.getID() + \")\");\n                         }\n-                        c.announce(MaplePacketCreator.getFamilyInfo(familyEntry));\n-                        familyEntry.announceToSenior(MaplePacketCreator.sendFamilyLoginNotice(player.getName(), true), true);\n                     } else {\n                         FilePrinter.printError(FilePrinter.FAMILY_ERROR, \"Player \" + player.getName() + \" has an invalid family ID. (\" + player.getFamilyId() + \")\");\n                         c.announce(MaplePacketCreator.getFamilyInfo(null));\n@@ -379,8 +380,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(e.getKey(), Integer.valueOf(e.getValue().getRight().getX())));\n                             c.announce(MaplePacketCreator.giveDebuff(debuff, e.getValue().getRight()));\n                         }\n-\n-                        player.announceDiseases();\n                     }\n                 } else {\n                     if(player.isRidingBattleship()) {"}, {"sha": "13a02d3cc393f5a0be00a559000c076037712547", "filename": "src/net/server/channel/handlers/PlayerMapTransitionHandler.java", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PlayerMapTransitionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/PlayerMapTransitionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerMapTransitionHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -26,6 +26,8 @@\n import java.util.Collections;\n import java.util.List;\n import net.AbstractMaplePacketHandler;\n+import server.life.MapleMonster;\n+import server.maps.MapleMapObject;\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -48,5 +50,21 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             final List<Pair<MapleBuffStat, Integer>> stat = Collections.singletonList(new Pair<>(MapleBuffStat.HOMING_BEACON, 0));\n             chr.announce(MaplePacketCreator.giveBuff(1, beaconid, stat));\n         }\n+        \n+        for (MapleMapObject mo : chr.getMap().getMonsters()) {    // thanks BHB, IxianMace, Jefe for noticing several issues regarding mob statuses (such as freeze)\n+            MapleMonster m = (MapleMonster) mo;\n+            if (m.getSpawnEffect() == 0 || m.getHp() < m.getMaxHp()) {     // avoid effect-spawning mobs\n+                if (m.getController() == chr) {\n+                    c.announce(MaplePacketCreator.stopControllingMonster(m.getObjectId()));\n+                    m.sendDestroyData(c);\n+                    m.aggroRedirectController();\n+                } else {\n+                    m.sendDestroyData(c);\n+                }\n+\n+                m.aggroSwitchController(chr, false);\n+                m.sendSpawnData(c);\n+            }\n+        }\n     }\n }\n\\ No newline at end of file"}, {"sha": "7d8ca471b70f64f761fc05b9713fa7d80e09f5ce", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -244,7 +244,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Skill highDef = SkillFactory.getSkill(Aran.HIGH_DEFENSE);\n                 int hdLevel = chr.getSkillLevel(highDef);\n                 if (highDef != null && hdLevel > 0) {\n-                    damage *= (highDef.getEffect(hdLevel).getX() / 1000.0);\n+                    damage *= Math.ceil(highDef.getEffect(hdLevel).getX() / 1000.0);\n                 }\n             }\n             Integer mesoguard = chr.getBuffedValue(MapleBuffStat.MESOGUARD);"}, {"sha": "7a9cffa009b339ccd0ab45a666acdc3109609bb9", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -580,14 +580,6 @@ public void changeRank(MapleGuildCharacter mgc, int newRank) {\n         }\n         \n         membersLock.lock();\n-        members.sort(new Comparator<MapleGuildCharacter>() {\n-            @Override\n-            public int compare(MapleGuildCharacter t, MapleGuildCharacter o) {\n-                if(t.getGuildRank() <= 1 && o.getGuildRank() > 1) return -1;\n-                else if(t.getGuildRank() > 1 && o.getGuildRank() <= 1) return 1;\n-                else return 0;\n-            }\n-        });\n         try {\n             this.broadcast(MaplePacketCreator.changeRank(mgc));\n         } finally {\n@@ -597,7 +589,7 @@ public int compare(MapleGuildCharacter t, MapleGuildCharacter o) {\n     \n     public void setGuildNotice(String notice) {\n         this.notice = notice;\n-        writeToDB(false);\n+        this.writeToDB(false);\n         \n         membersLock.lock();\n         try {"}, {"sha": "d4d192e5911ccb54e9436ab6b2fe15d5dbdf390a", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -130,7 +130,7 @@ public MaplePartyCharacter getMemberById(int id) {\n     public Collection<MaplePartyCharacter> getMembers() {\n         lock.lock();\n         try {\n-            return Collections.unmodifiableList(members);\n+            return new LinkedList<>(members);\n         } finally {\n             lock.unlock();\n         }\n@@ -139,7 +139,7 @@ public MaplePartyCharacter getMemberById(int id) {\n     public List<MaplePartyCharacter> getPartyMembers() {\n         lock.lock();\n         try {\n-            return Collections.unmodifiableList(members);\n+            return new LinkedList<>(members);\n         } finally {\n             lock.unlock();\n         }"}, {"sha": "0b0ceeafde1326939768a35bf3220708c798d761", "filename": "src/scripting/AbstractScriptManager.java", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/AbstractScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/AbstractScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -65,9 +65,7 @@ protected NashornScriptEngine getScriptEngine(String path) {\n     }\n \n     protected NashornScriptEngine getScriptEngine(String path, MapleClient c) {\n-        String cachePath = \"scripts/\" + path;\n-        NashornScriptEngine engine = c.getScriptEngine(cachePath);\n-\n+        NashornScriptEngine engine = c.getScriptEngine(\"scripts/\" + path);\n         if (engine == null) {\n             engine = getScriptEngine(path);\n             c.setScriptEngine(path, engine);"}, {"sha": "4daeeade36ff70ef38e67d4cd5a0a7b51d8845d2", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -31,7 +31,6 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n-import javax.script.Invocable;\n import javax.script.ScriptException;\n \n import constants.ServerConstants;\n@@ -59,6 +58,7 @@\n import java.util.Set;\n import java.util.concurrent.Semaphore;\n import java.util.concurrent.TimeUnit;\n+import jdk.nashorn.api.scripting.NashornScriptEngine;\n import net.server.audit.LockCollector;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n@@ -72,7 +72,7 @@\n  * @author Ronan\n  */\n public class EventManager {\n-    private Invocable iv;\n+    private NashornScriptEngine iv;\n     private Channel cserv;\n     private World wserv;\n     private Server server;\n@@ -95,7 +95,7 @@\n     \n     private static final int maxLobbys = 8;     // an event manager holds up to this amount of concurrent lobbys\n     \n-    public EventManager(Channel cserv, Invocable iv, String name) {\n+    public EventManager(Channel cserv, NashornScriptEngine iv, String name) {\n         this.server = Server.getInstance();\n         this.iv = iv;\n         this.cserv = cserv;\n@@ -256,7 +256,7 @@ public Channel getChannelServer() {\n         return cserv;\n     }\n     \n-    public Invocable getIv() {\n+    public NashornScriptEngine getIv() {\n         return iv;\n     }\n "}, {"sha": "af13ce68915791d28a5c44f883e23dd4a42cf10b", "filename": "src/scripting/event/EventScriptManager.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/event/EventScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/event/EventScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -27,8 +27,8 @@\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n-import javax.script.Invocable;\n import javax.script.ScriptEngine;\n+import jdk.nashorn.api.scripting.NashornScriptEngine;\n \n import net.server.channel.Channel;\n import scripting.AbstractScriptManager;\n@@ -41,11 +41,11 @@\n \n     private class EventEntry {\n \n-        public EventEntry(Invocable iv, EventManager em) {\n+        public EventEntry(NashornScriptEngine iv, EventManager em) {\n             this.iv = iv;\n             this.em = em;\n         }\n-        public Invocable iv;\n+        public NashornScriptEngine iv;\n         public EventManager em;\n     }\n     private Map<String, EventEntry> events = new LinkedHashMap<>();\n@@ -54,7 +54,7 @@ public EventScriptManager(Channel cserv, String[] scripts) {\n         super();\n         for (String script : scripts) {\n             if (!script.equals(\"\")) {\n-                Invocable iv = getScriptEngine(\"event/\" + script + \".js\");\n+                NashornScriptEngine iv = getScriptEngine(\"event/\" + script + \".js\");\n                 events.put(script, new EventEntry(iv, new EventManager(cserv, iv, script)));\n             }\n         }\n@@ -71,7 +71,7 @@ public EventManager getEventManager(String event) {\n     public void init() {\n         for (EventEntry entry : events.values()) {\n             try {\n-                ((ScriptEngine) entry.iv).put(\"em\", entry.em);\n+                entry.iv.put(\"em\", entry.em);\n                 entry.iv.invokeFunction(\"init\", (Object) null);\n             } catch (Exception ex) {\n                 Logger.getLogger(EventScriptManager.class.getName()).log(Level.SEVERE, null, ex);\n@@ -88,7 +88,7 @@ private void reloadScripts() {\n         Channel cserv = events.values().iterator().next().em.getChannelServer();\n         for (Entry<String, EventEntry> entry : events.entrySet()) {\n             String script = entry.getKey();\n-            Invocable iv = getScriptEngine(\"event/\" + script + \".js\");\n+            NashornScriptEngine iv = getScriptEngine(\"event/\" + script + \".js\");\n             events.put(script, new EventEntry(iv, new EventManager(cserv, iv, script)));\n         }\n     }"}, {"sha": "976b37521e890b1b69ccd6c7fafe0627cb6543a3", "filename": "src/scripting/map/MapScriptManager.java", "status": "modified", "additions": 31, "deletions": 46, "changes": 77, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/map/MapScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/map/MapScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/map/MapScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -21,31 +21,27 @@\n  */\n package scripting.map;\n \n+import client.MapleCharacter;\n import client.MapleClient;\n-import constants.ServerConstants;\n-import java.io.File;\n-import java.io.FileReader;\n-import java.io.IOException;\n import java.lang.reflect.UndeclaredThrowableException;\n import java.util.HashMap;\n import java.util.Map;\n-import javax.script.Compilable;\n-import javax.script.Invocable;\n-import javax.script.ScriptEngine;\n import javax.script.ScriptEngineFactory;\n import javax.script.ScriptEngineManager;\n import javax.script.ScriptException;\n+import jdk.nashorn.api.scripting.NashornScriptEngine;\n+import scripting.AbstractScriptManager;\n import tools.FilePrinter;\n \n-public class MapScriptManager {\n+public class MapScriptManager extends AbstractScriptManager {\n \n     private static MapScriptManager instance = new MapScriptManager();\n     \n     public static MapScriptManager getInstance() {\n         return instance;\n     }\n     \n-    private Map<String, Invocable> scripts = new HashMap<>();\n+    private Map<String, NashornScriptEngine> scripts = new HashMap<>();\n     private ScriptEngineFactory sef;\n \n     private MapScriptManager() {\n@@ -57,53 +53,42 @@ public void reloadScripts() {\n         scripts.clear();\n     }\n \n-    public boolean scriptExists(String scriptName, boolean firstUser) {\n-        File scriptFile = new File(\"scripts/map/\" + (firstUser ? \"onFirstUserEnter/\" : \"onUserEnter/\") + scriptName + \".js\");\n-        return scriptFile.exists();\n-    }\n-\n-    public void runMapScript(MapleClient c, String scriptName, boolean firstUser) {\n-        if (scripts.containsKey(scriptName)) {\n+    public boolean runMapScript(MapleClient c, String mapScriptPath, boolean firstUser) {\n+        if (firstUser) {\n+            MapleCharacter chr = c.getPlayer();\n+            int mapid = chr.getMapId();\n+            if (chr.hasEntered(mapScriptPath, mapid)) {\n+                return false;\n+            } else {\n+                chr.enteredScript(mapScriptPath, mapid);\n+            }\n+        }\n+        \n+        NashornScriptEngine iv = scripts.get(mapScriptPath);\n+        if (iv != null) {\n             try {\n-                scripts.get(scriptName).invokeFunction(\"start\", new MapScriptMethods(c));\n+                iv.invokeFunction(\"start\", new MapScriptMethods(c));\n+                return true;\n             } catch (final ScriptException | NoSuchMethodException e) {\n                 e.printStackTrace();\n             }\n-            return;\n         }\n-        String type = firstUser ? \"onFirstUserEnter/\" : \"onUserEnter/\";\n-\n-        File scriptFile = new File(\"scripts/map/\" + type + scriptName + \".js\");\n-        if (!scriptExists(scriptName, firstUser)) {\n-            return;\n-        }\n-        FileReader fr = null;\n-        ScriptEngine se = sef.getScriptEngine();\n+        \n         try {\n-            fr = new FileReader(scriptFile);\n-            \n-            // java 8 support here thanks to Arufonsu\n-            if (ServerConstants.JAVA_8){\n-                    se.eval(\"load('nashorn:mozilla_compat.js');\" + System.lineSeparator());\n+            iv = getScriptEngine(\"map/\" + mapScriptPath + \".js\");\n+            if (iv == null) {\n+                return false;\n             }\n             \n-            ((Compilable) se).compile(fr).eval();\n-            \n-            final Invocable script = ((Invocable) se);\n-            scripts.put(scriptName, script);\n-            script.invokeFunction(\"start\", new MapScriptMethods(c));\n+            scripts.put(mapScriptPath, iv);\n+            iv.invokeFunction(\"start\", new MapScriptMethods(c));\n+            return true;\n         } catch (final UndeclaredThrowableException | ScriptException ute) {\n-            FilePrinter.printError(FilePrinter.MAP_SCRIPT + type + scriptName + \".txt\", ute);\n+            FilePrinter.printError(FilePrinter.MAP_SCRIPT + mapScriptPath + \".txt\", ute);\n         } catch (final Exception e) {\n-            FilePrinter.printError(FilePrinter.MAP_SCRIPT + type + scriptName + \".txt\", e);\n-        } finally {\n-            if (fr != null) {\n-                try {\n-                    fr.close();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n+            FilePrinter.printError(FilePrinter.MAP_SCRIPT + mapScriptPath + \".txt\", e);\n         }\n+        \n+        return false;\n     }\n }\n\\ No newline at end of file"}, {"sha": "3a99a829b3802e76a64ee2492d8e3f8a32dbfa40", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 14, "deletions": 19, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -679,12 +679,11 @@ public void cpqLobby(int field) {\n             try {\n                 final MapleMap map, mapExit;\n                 Channel cs = c.getChannelServer();\n-                PlayerStorage ps = cs.getPlayerStorage();\n                 \n                 map = cs.getMapFactory().getMap(980000100 + 100 * field);\n                 mapExit = cs.getMapFactory().getMap(980000000);\n                 for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n-                    final MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                    final MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.setChallenged(false);\n                         mc.changeMap(map, map.getPortal(0));\n@@ -715,9 +714,8 @@ public MapleCharacter getChrById(int id) {\n         }\n \n         public void cancelCPQLobby() {\n-            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n             for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n-                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                MapleCharacter mc = mpc.getPlayer();\n                 if (mc != null) {\n                     mc.clearCpqTimer();\n                 }\n@@ -741,11 +739,11 @@ public void startCPQ(final MapleCharacter challenger, final int field) {\n                 final MapleMap lobbyMap = getPlayer().getMap();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n-                        throw new RuntimeException(\"Nao existe oponente!\");\n+                        throw new RuntimeException(\"No opponent found!\");\n                     }\n-                    PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                    \n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                        MapleCharacter mc = mpc.getPlayer();\n                         if (mc != null) {\n                             mc.changeMap(lobbyMap, lobbyMap.getPortal(0));\n                             TimerManager tMan = TimerManager.getInstance();\n@@ -758,7 +756,7 @@ public void run() {\n                         }\n                     }\n                     for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                        MapleCharacter mc = mpc.getPlayer();\n                         if (mc != null) {\n                             TimerManager tMan = TimerManager.getInstance();\n                             tMan.schedule(new Runnable() {\n@@ -776,15 +774,14 @@ public void run() {\n                     @Override\n                     public void run() {\n                         try {\n-                            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                             for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                MapleCharacter mc = mpc.getPlayer();\n                                 if (mc != null) {\n                                     mc.setMonsterCarnival(null);\n                                 }\n                             }\n                             for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                MapleCharacter mc = mpc.getPlayer();\n                                 if (mc != null) {\n                                     mc.setMonsterCarnival(null);\n                                 }\n@@ -809,11 +806,11 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                 final MapleMap lobbyMap = getPlayer().getMap();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n-                        throw new RuntimeException(\"N\u00e3o existe oponente!\");\n+                        throw new RuntimeException(\"No opponent found!\");\n                     }\n-                    PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                    \n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                        MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                        MapleCharacter mc = mpc.getPlayer();\n                         if (mc != null) {\n                             mc.changeMap(lobbyMap, lobbyMap.getPortal(0));\n                             mapClock(10);\n@@ -826,15 +823,14 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                     @Override\n                     public void run() {\n                         try {\n-                            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                             for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                MapleCharacter mc = mpc.getPlayer();\n                                 if (mc != null) {\n                                     mc.setMonsterCarnival(null);\n                                 }\n                             }\n                             for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                MapleCharacter mc = mpc.getPlayer();\n                                 if (mc != null) {\n                                     mc.setMonsterCarnival(null);\n                                 }\n@@ -907,12 +903,11 @@ public void cpqLobby2(int field) {\n             try {\n                 final MapleMap map, mapExit;\n                 Channel cs = c.getChannelServer();\n-                PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n                 \n                 mapExit = cs.getMapFactory().getMap(980030000);\n                 map = cs.getMapFactory().getMap(980031000 + 1000 * field);\n                 for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n-                    final MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                    final MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.setChallenged(false);\n                         mc.changeMap(map, map.getPortal(0));"}, {"sha": "d310efa2a8e8518cf605bb1027c16e08d60c91fa", "filename": "src/scripting/npc/NPCScriptManager.java", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/npc/NPCScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/npc/NPCScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -29,8 +29,6 @@\n import java.util.List;\n import java.util.Map;\n \n-import javax.script.Invocable;\n-import javax.script.ScriptEngine;\n import javax.script.ScriptException;\n \n import jdk.nashorn.api.scripting.NashornScriptEngine;\n@@ -54,10 +52,10 @@ public static NPCScriptManager getInstance() {\n     }\n \n     private Map<MapleClient, NPCConversationManager> cms = new HashMap<>();\n-    private Map<MapleClient, Invocable> scripts = new HashMap<>();\n+    private Map<MapleClient, NashornScriptEngine> scripts = new HashMap<>();\n \n     public boolean isNpcScriptAvailable(MapleClient c, String fileName) {\n-        Invocable iv = null;\n+        NashornScriptEngine iv = null;\n         if (fileName != null) {\n             iv = getScriptEngine(\"npc/\" + fileName + \".js\", c);\n         }\n@@ -96,7 +94,7 @@ public void start(String filename, MapleClient c, int npc, List<MaplePartyCharac\n             NashornScriptEngine iv = getScriptEngine(\"npc/\" + filename + \".js\", c);\n \n             if (iv == null) {\n-                c.getPlayer().dropMessage(1, npc + \"\");\n+                c.getPlayer().dropMessage(1, \"NPC \" + npc + \" is uncoded.\");\n                 cm.dispose();\n                 return;\n             }\n@@ -173,7 +171,7 @@ private boolean start(MapleClient c, int npc, int oid, String fileName, MapleCha\n     }\n \n     public void action(MapleClient c, byte mode, byte type, int selection) {\n-        Invocable iv = scripts.get(c);\n+        NashornScriptEngine iv = scripts.get(c);\n         if (iv != null) {\n             try {\n                 c.setClickedNPC();"}, {"sha": "926f5fd52e09ec419eed033902afc294a40e97ff", "filename": "src/scripting/portal/PortalScriptManager.java", "status": "modified", "additions": 19, "deletions": 44, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/portal/PortalScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/portal/PortalScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/portal/PortalScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -22,79 +22,54 @@\n package scripting.portal;\n \n import client.MapleClient;\n-import constants.ServerConstants;\n-import java.io.File;\n-import java.io.FileReader;\n-import java.io.IOException;\n import java.lang.reflect.UndeclaredThrowableException;\n import java.util.HashMap;\n import java.util.Map;\n-import javax.script.Compilable;\n-import javax.script.Invocable;\n-import javax.script.ScriptEngine;\n import javax.script.ScriptEngineFactory;\n import javax.script.ScriptEngineManager;\n-import javax.script.ScriptException;\n+import jdk.nashorn.api.scripting.NashornScriptEngine;\n+import scripting.AbstractScriptManager;\n import server.maps.MaplePortal;\n import tools.FilePrinter;\n \n-public class PortalScriptManager {\n+public class PortalScriptManager extends AbstractScriptManager {\n \n     private static PortalScriptManager instance = new PortalScriptManager();\n     \n     public static PortalScriptManager getInstance() {\n         return instance;\n     }\n     \n-    private Map<String, PortalScript> scripts = new HashMap<>();\n+    private Map<String, NashornScriptEngine> scripts = new HashMap<>();\n     private ScriptEngineFactory sef;\n \n     private PortalScriptManager() {\n         ScriptEngineManager sem = new ScriptEngineManager();\n         sef = sem.getEngineByName(\"javascript\").getFactory();\n     }\n \n-    private PortalScript getPortalScript(String scriptName) {\n-        if (scripts.containsKey(scriptName)) {\n-            return scripts.get(scriptName);\n+    private NashornScriptEngine getPortalScript(String scriptName) {\n+        String scriptPath = \"portal/\" + scriptName + \".js\";\n+        NashornScriptEngine iv = scripts.get(scriptPath);\n+        if (iv != null) {\n+            return iv;\n         }\n-        File scriptFile = new File(\"scripts/portal/\" + scriptName + \".js\");\n-        if (!scriptFile.exists()) {\n-            scripts.put(scriptName, null);\n+        \n+        iv = getScriptEngine(scriptPath);\n+        if (iv == null) {\n             return null;\n         }\n-        FileReader fr = null;\n-        ScriptEngine portal = sef.getScriptEngine();\n-        try {\n-            fr = new FileReader(scriptFile);\n-            \n-            // java 8 support here thanks to Arufonsu\n-            if (ServerConstants.JAVA_8){\n-                    portal.eval(\"load('nashorn:mozilla_compat.js');\" + System.lineSeparator());\n-            }\n-            \n-            ((Compilable) portal).compile(fr).eval();\n-        } catch (ScriptException | IOException | UndeclaredThrowableException e) {\n-            FilePrinter.printError(FilePrinter.PORTAL + scriptName + \".txt\", e);\n-        } finally {\n-            if (fr != null) {\n-                try {\n-                    fr.close();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        }\n-        PortalScript script = ((Invocable) portal).getInterface(PortalScript.class);\n-        scripts.put(scriptName, script);\n-        return script;\n+        \n+        scripts.put(scriptPath, iv);\n+        return iv;\n     }\n \n     public boolean executePortalScript(MaplePortal portal, MapleClient c) {\n         try {\n-            PortalScript script = getPortalScript(portal.getScriptName());\n-            if (script != null) {\n-                return script.enter(new PortalPlayerInteraction(c, portal));\n+            NashornScriptEngine iv = getPortalScript(portal.getScriptName());\n+            if (iv != null) {\n+                boolean couldWarp = (boolean) iv.invokeFunction(\"enter\", new PortalPlayerInteraction(c, portal));\n+                return couldWarp;\n             }\n         } catch (UndeclaredThrowableException ute) {\n             FilePrinter.printError(FilePrinter.PORTAL + portal.getScriptName() + \".txt\", ute);"}, {"sha": "8d9628769e8f0a9ddb36a7dd5074251a1cc5e008", "filename": "src/scripting/quest/QuestScriptManager.java", "status": "modified", "additions": 34, "deletions": 23, "changes": 57, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/quest/QuestScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/quest/QuestScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/quest/QuestScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -25,8 +25,6 @@\n import java.util.HashMap;\n import java.util.Map;\n \n-import javax.script.Invocable;\n-\n import jdk.nashorn.api.scripting.NashornScriptEngine;\n import scripting.AbstractScriptManager;\n import server.quest.MapleQuest;\n@@ -48,7 +46,16 @@ public static QuestScriptManager getInstance() {\n \t}\n     \n \tprivate Map<MapleClient, QuestActionManager> qms = new HashMap<>();\n-\tprivate Map<MapleClient, Invocable> scripts = new HashMap<>();\n+\tprivate Map<MapleClient, NashornScriptEngine> scripts = new HashMap<>();\n+        \n+        private NashornScriptEngine getQuestScriptEngine(MapleClient c, short questid) {\n+                NashornScriptEngine iv = getScriptEngine(\"quest/\" + questid + \".js\", c);\n+                if (iv == null && GameConstants.isMedalQuest(questid)) {\n+                        iv = getScriptEngine(\"quest/medalQuest.js\", c);   // start generic medal quest\n+                }\n+\n+                return iv;\n+        }\n         \n \tpublic void start(MapleClient c, short questid, int npc) {\n                 MapleQuest quest = MapleQuest.getInstance(questid);\n@@ -63,18 +70,19 @@ public void start(MapleClient c, short questid, int npc) {\n                         }\n                         if(c.canClickNPC()) {\n                                 qms.put(c, qm);\n-                                NashornScriptEngine iv = getScriptEngine(\"quest/\" + questid + \".js\", c);\n-                                if (iv == null) {\n-                                        if(GameConstants.isMedalQuest(questid)) {   // start generic medal quest\n-                                                iv = getScriptEngine(\"quest/medalQuest.js\", c);\n-                                        } else {\n-                                                FilePrinter.printError(FilePrinter.QUEST_UNCODED, \"START Quest \" + questid + \" is uncoded.\");\n-                                        }\n+                                \n+                                if (!quest.hasScriptRequirement(false)) {   // lack of scripted quest checks found thanks to Mali, Resinate\n+                                        qm.dispose();\n+                                        return;\n                                 }\n-                                if (iv == null || QuestScriptManager.getInstance() == null) {\n+                                \n+                                NashornScriptEngine iv = getQuestScriptEngine(c, questid);\n+                                if (iv == null) {\n+                                        FilePrinter.printError(FilePrinter.QUEST_UNCODED, \"START Quest \" + questid + \" is uncoded.\");\n                                         qm.dispose();\n                                         return;\n                                 }\n+                                \n                                 iv.put(\"qm\", qm);\n                                 scripts.put(c, iv);\n                                 c.setClickedNPC();\n@@ -90,7 +98,7 @@ public void start(MapleClient c, short questid, int npc) {\n \t}\n \n \tpublic void start(MapleClient c, byte mode, byte type, int selection) {\n-\t\tInvocable iv = scripts.get(c);\n+\t\tNashornScriptEngine iv = scripts.get(c);\n \t\tif (iv != null) {\n \t\t\ttry {\n \t\t\t\tc.setClickedNPC();\n@@ -118,16 +126,19 @@ public void end(MapleClient c, short questid, int npc) {\n \t\t\t}\n \t\t\tif(c.canClickNPC()){\n \t\t\t\tqms.put(c, qm);\n-\t\t\t\tNashornScriptEngine iv = getScriptEngine(\"quest/\" + questid + \".js\", c);\n-\t\t\t\tif (iv == null) {\n-                                        if(GameConstants.isMedalQuest(questid)) {   // start generic medal quest\n-                                                iv = getScriptEngine(\"quest/medalQuest.js\", c);\n-                                        } else {\n-                                                FilePrinter.printError(FilePrinter.QUEST_UNCODED, \"END Quest \" + questid + \" is uncoded.\");\n-                                                qm.dispose();\n-                                                return;\n-                                        }\n-\t\t\t\t}\n+\t\t\t\t\n+                                if (!quest.hasScriptRequirement(true)) {\n+                                        qm.dispose();\n+                                        return;\n+                                }\n+                                \n+                                NashornScriptEngine iv = getQuestScriptEngine(c, questid);\n+                                if (iv == null) {\n+                                        FilePrinter.printError(FilePrinter.QUEST_UNCODED, \"END Quest \" + questid + \" is uncoded.\");\n+                                        qm.dispose();\n+                                        return;\n+                                }\n+\t\t\t\t\n \t\t\t\tiv.put(\"qm\", qm);\n \t\t\t\tscripts.put(c, iv);\n \t\t\t\tc.setClickedNPC();\n@@ -143,7 +154,7 @@ public void end(MapleClient c, short questid, int npc) {\n \t}\n \n \tpublic void end(MapleClient c, byte mode, byte type, int selection) {\n-\t\tInvocable iv = scripts.get(c);\n+\t\tNashornScriptEngine iv = scripts.get(c);\n \t\tif (iv != null) {\n \t\t\ttry {\n \t\t\t\tc.setClickedNPC();"}, {"sha": "084ceac83821ee5262209351a9d330e3e1a57fb8", "filename": "src/scripting/reactor/ReactorActionManager.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/reactor/ReactorActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/reactor/ReactorActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorActionManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -35,8 +35,8 @@\n import java.util.concurrent.ScheduledFuture;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n-import javax.script.Invocable;\n import javax.script.ScriptException;\n+import jdk.nashorn.api.scripting.NashornScriptEngine;\n import scripting.AbstractPlayerInteraction;\n import scripting.event.EventInstanceManager;\n import scripting.event.EventManager;\n@@ -58,10 +58,10 @@\n  */\n public class ReactorActionManager extends AbstractPlayerInteraction {\n     private MapleReactor reactor;\n-    private Invocable iv;\n+    private NashornScriptEngine iv;\n     private ScheduledFuture<?> sprayTask = null;\n \n-    public ReactorActionManager(MapleClient c, MapleReactor reactor, Invocable iv) {\n+    public ReactorActionManager(MapleClient c, MapleReactor reactor, NashornScriptEngine iv) {\n         super(c);\n         this.reactor = reactor;\n         this.iv = iv;"}, {"sha": "7fcb1acacc08679a41fa5347bb0d59a002749d04", "filename": "src/scripting/reactor/ReactorScriptManager.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/reactor/ReactorScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/scripting/reactor/ReactorScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorScriptManager.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -29,7 +29,6 @@\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n-import javax.script.Invocable;\n import javax.script.ScriptException;\n \n import jdk.nashorn.api.scripting.NashornScriptEngine;"}, {"sha": "d15904122e7b5d102309714d56bcc3ab35a75ce0", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -824,6 +824,7 @@ private static MapleStatEffect loadFromData(MapleData source, int sourceid, bool\n                     break;\n                 case ILMage.SEAL:\n                 case FPMage.SEAL:\n+                case BlazeWizard.SEAL:\n                     monsterStatus.put(MonsterStatus.SEAL, Integer.valueOf(1));\n                     break;\n                 case Hermit.SHADOW_WEB: // shadow web\n@@ -1200,6 +1201,8 @@ private void applyMonsterBuff(MapleCharacter applyfrom) {\n             MapleMonster monster = (MapleMonster) mo;\n             if (isDispel()) {\n                 monster.debuffMob(skill_.getId());\n+            } else if (isSeal() && monster.isBoss()) {  // thanks IxianMace for noticing seal working on bosses\n+                // do nothing\n             } else {\n                 if (makeChanceResult()) {\n                     monster.applyStatus(applyfrom, new MonsterStatusEffect(getMonsterStati(), skill_, null, false), isPoison(), getDuration());\n@@ -1705,6 +1708,10 @@ private boolean isShadowClaw() {\n     private boolean isCrash() {\n         return skill && (sourceid == DragonKnight.POWER_CRASH || sourceid == Crusader.ARMOR_CRASH || sourceid == WhiteKnight.MAGIC_CRASH);\n     }\n+    \n+    private boolean isSeal() {\n+        return skill && (sourceid == ILMage.SEAL || sourceid == FPMage.SEAL || sourceid == BlazeWizard.SEAL);\n+    }\n \n     private boolean isDispel() {\n         return skill && (sourceid == Priest.DISPEL || sourceid == SuperGM.HEAL_PLUS_DISPEL);"}, {"sha": "0a2e6e720697f576533caec0415f0c57fed1f035", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -101,6 +101,7 @@\n     private List<Integer> stolenItems = new ArrayList<>(5);\n     private int team;\n     private int parentMobOid = 0;\n+    private int spawnEffect = 0;\n     private final HashMap<Integer, AtomicLong> takenDamage = new HashMap<>();\n     private ScheduledFuture<?> monsterItemDrop = null;\n     private Runnable removeAfterAction = null;\n@@ -138,6 +139,14 @@ private void initWithStats(MapleMonsterStats baseStats) {\n         \n         maxHpPlusHeal.set(hp.get());\n     }\n+    \n+    public void setSpawnEffect(int effect) {\n+        spawnEffect = effect;\n+    }\n+    \n+    public int getSpawnEffect() {\n+        return spawnEffect;\n+    }\n \n     public void disableDrops() {\n         this.dropsDisabled = true;\n@@ -1060,6 +1069,7 @@ public void sendSpawnData(MapleClient client) {\n     @Override\n     public void sendDestroyData(MapleClient client) {\n         client.announce(MaplePacketCreator.killMonster(getObjectId(), false));\n+        client.announce(MaplePacketCreator.killMonster(getObjectId(), true));\n     }\n \n     @Override"}, {"sha": "6f270cca9d847114a12ac1a028f86596bfd646be", "filename": "src/server/maps/MapleDoor.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleDoor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleDoor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDoor.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -102,10 +102,12 @@ private void broadcastRemoveDoor(MapleCharacter owner) {\n \n         for (MapleCharacter chr : targetChars) {\n             areaDoor.sendDestroyData(chr.getClient());\n+            chr.removeVisibleMapObject(areaDoor);\n         }\n \n         for (MapleCharacter chr : townChars) {\n             townDoor.sendDestroyData(chr.getClient());\n+            chr.removeVisibleMapObject(townDoor);\n         }\n         \n         owner.removePartyDoor(false);\n@@ -115,6 +117,7 @@ private void broadcastRemoveDoor(MapleCharacter owner) {\n                 MapleDoor door = chr.getMainTownDoor();\n                 if (door != null) {\n                     townDoor.sendSpawnData(chr.getClient());\n+                    chr.addVisibleMapObject(townDoor);\n                 }\n             }\n         }"}, {"sha": "20995c960826d495671f6c10ceffd7e0f151cbf5", "filename": "src/server/maps/MapleDoorObject.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleDoorObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleDoorObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDoorObject.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -87,6 +87,8 @@ private Point getLinkedPortalPosition() {\n     public void warp(final MapleCharacter chr) {\n         MapleParty party = chr.getParty();\n         if (chr.getId() == ownerId || (party != null && party.getMemberById(ownerId) != null)) {\n+            chr.announce(MaplePacketCreator.playPortalSound());\n+            \n             if(!inTown() && party == null) {\n                 chr.changeMap(to, getLinkedPortalId());\n             } else {"}, {"sha": "f60d03c49934a1e1987ca13723155039929370cd", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 15, "deletions": 8, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -2063,6 +2063,8 @@ public void spawnMonsterWithEffect(final MapleMonster monster, final int effect,\n         \n         spos.y--;\n         monster.setPosition(spos);\n+        monster.setSpawnEffect(effect);\n+        \n         spawnAndAddRangedMapObject(monster, new DelayedPacketCreation() {\n             @Override\n             public void sendPackets(MapleClient c) {\n@@ -2116,7 +2118,11 @@ public void spawnDoor(final MapleDoorObject door) {\n         spawnAndAddRangedMapObject(door, new DelayedPacketCreation() {\n             @Override\n             public void sendPackets(MapleClient c) {\n-                door.sendSpawnData(c, false);\n+                MapleCharacter chr = c.getPlayer();\n+                if (chr != null) {\n+                    door.sendSpawnData(c, false);\n+                    chr.addVisibleMapObject(door);\n+                }\n             }\n         }, new SpawnCondition() {\n             @Override\n@@ -2465,22 +2471,23 @@ public void addPlayer(final MapleCharacter chr) {\n         chr.setMapId(mapid);\n         chr.updateActiveEffects();\n         \n+        MapScriptManager msm = MapScriptManager.getInstance();\n         if (chrSize == 1) {\n             if(!hasItemMonitor()) {\n                 startItemMonitor();\n                 aggroMonitor.startAggroCoordinator();\n             }\n             \n-            if (onFirstUserEnter.length() != 0 && !chr.hasEntered(onFirstUserEnter, mapid) && MapScriptManager.getInstance().scriptExists(onFirstUserEnter, true)) {\n-                chr.enteredScript(onFirstUserEnter, mapid);\n-                MapScriptManager.getInstance().runMapScript(chr.getClient(), onFirstUserEnter, true);\n+            if (onFirstUserEnter.length() != 0) {\n+                msm.runMapScript(chr.getClient(), \"onFirstUserEnter/\" + onFirstUserEnter, true);\n             }\n         }\n         if (onUserEnter.length() != 0) {\n             if (onUserEnter.equals(\"cygnusTest\") && (mapid < 913040000 || mapid > 913040006)) {\n                 chr.saveLocation(\"INTRO\");\n             }\n-            MapScriptManager.getInstance().runMapScript(chr.getClient(), onUserEnter, false);\n+            \n+            msm.runMapScript(chr.getClient(), \"onUserEnter/\" + onUserEnter, false);\n         }\n         if (FieldLimit.CANNOTUSEMOUNTS.check(fieldLimit) && chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {\n             chr.cancelEffectFromBuffStat(MapleBuffStat.MONSTER_RIDING);\n@@ -3020,8 +3027,8 @@ private static boolean isNonRangedType(MapleMapObjectType type) {\n         }\n     }\n \n-    private void sendObjectPlacement(MapleClient mapleClient) {\n-        MapleCharacter chr = mapleClient.getPlayer();\n+    private void sendObjectPlacement(MapleClient c) {\n+        MapleCharacter chr = c.getPlayer();\n         Collection<MapleMapObject> objects;\n         \n         objectRLock.lock();\n@@ -3033,7 +3040,7 @@ private void sendObjectPlacement(MapleClient mapleClient) {\n         \n         for (MapleMapObject o : objects) {\n             if (isNonRangedType(o.getType())) {\n-                o.sendSpawnData(mapleClient);\n+                o.sendSpawnData(c);\n             } else if (o.getType() == MapleMapObjectType.MONSTER) {\n                 ((MapleMonster) o).aggroUpdateController();\n             } else if (o.getType() == MapleMapObjectType.SUMMON) {"}, {"sha": "a96d0fc6e9f5bfeec3642f067b03450e4ee64bc0", "filename": "src/server/partyquest/MonsterCarnival.java", "status": "modified", "additions": 11, "deletions": 14, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/partyquest/MonsterCarnival.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/partyquest/MonsterCarnival.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnival.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -50,7 +50,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                 bluePortal = 1;\n             }\n             for (MaplePartyCharacter mpc : p1.getMembers()) {\n-                MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                MapleCharacter mc = mpc.getPlayer();\n                 if (mc != null) {\n                     mc.setMonsterCarnival(this);\n                     mc.setTeam(0);\n@@ -64,7 +64,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                 }\n             }\n             for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                MapleCharacter mc = mpc.getPlayer();\n                 if (mc != null) {\n                     mc.setMonsterCarnival(this);\n                     mc.setTeam(1);\n@@ -213,7 +213,7 @@ protected void dispose(boolean warpout) {\n             out = cs.getMapFactory().getMap(980000010);\n         }\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-            MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+            MapleCharacter mc = mpc.getPlayer();\n             if (mc != null) {\n                 mc.resetCP();\n                 mc.setTeam(-1);\n@@ -224,7 +224,7 @@ protected void dispose(boolean warpout) {\n             }\n         }\n         for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-            MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+            MapleCharacter mc = mpc.getPlayer();\n             if (mc != null) {\n                 mc.resetCP();\n                 mc.setTeam(-1);\n@@ -269,7 +269,7 @@ private void finish(int winningTeam) {\n             Channel cs = map.getChannelServer();\n             if (winningTeam == 0) {\n                 for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                    MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.redTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -283,7 +283,7 @@ private void finish(int winningTeam) {\n                     }\n                 }\n                 for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                    MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.blueTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -298,7 +298,7 @@ private void finish(int winningTeam) {\n                 }\n             } else if (winningTeam == 1) {\n                 for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                    MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.blueTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -312,7 +312,7 @@ private void finish(int winningTeam) {\n                     }\n                 }\n                 for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-                    MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+                    MapleCharacter mc = mpc.getPlayer();\n                     if (mc != null) {\n                         mc.gainFestivalPoints(this.redTotalCP);\n                         mc.setMonsterCarnival(null);\n@@ -393,12 +393,10 @@ public void complete() {\n         if (chnl != chnl1) {\n             throw new RuntimeException(\"Os lideres estao em canais diferentes.\");\n         }\n-\n-        Channel cs = map.getChannelServer();\n+        \n         map.killAllMonsters();\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n-            MapleCharacter mc;\n-            mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+            MapleCharacter mc = mpc.getPlayer();\n             if (mc != null) {\n                 if (redWin) {\n                     mc.getClient().announce(MaplePacketCreator.showEffect(\"quest/carnival/win\"));\n@@ -412,8 +410,7 @@ public void complete() {\n             }\n         }\n         for (MaplePartyCharacter mpc : leader2.getParty().getMembers()) {\n-            MapleCharacter mc;\n-            mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n+            MapleCharacter mc = mpc.getPlayer();\n             if (mc != null) {\n                 if (!redWin) {\n                     mc.getClient().announce(MaplePacketCreator.showEffect(\"quest/carnival/win\"));"}, {"sha": "88d081dab138f54402d2a4a214a9585922a91bdd", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -490,6 +490,8 @@ private MapleQuestRequirement getRequirement(MapleQuestRequirementType type, Map\n \t\t\t\tret = new BuffExceptRequirement(this, data);\n \t\t\t\tbreak;\n \t\t\tcase SCRIPT:\n+                                ret = new ScriptRequirement(this, data);\n+                                break;\n \t\t\tcase NORMAL_AUTO_START:\n \t\t\tcase START:\n \t\t\tcase END:\n@@ -561,7 +563,6 @@ public int getMedalRequirement() {\n         \n         public int getNpcRequirement(boolean complete) {\n                 Map<MapleQuestRequirementType, MapleQuestRequirement> reqs = !complete ? startReqs : completeReqs;\n-                \n                 MapleQuestRequirement mqr = reqs.get(MapleQuestRequirementType.NPC);\n                 if (mqr != null) {\n                         return ((NpcRequirement) mqr).get();\n@@ -570,6 +571,17 @@ public int getNpcRequirement(boolean complete) {\n                 }\n         }\n         \n+        public boolean hasScriptRequirement(boolean complete) {\n+                Map<MapleQuestRequirementType, MapleQuestRequirement> reqs = !complete ? startReqs : completeReqs;\n+                MapleQuestRequirement mqr = reqs.get(MapleQuestRequirementType.SCRIPT);\n+                \n+                if (mqr != null) {\n+                        return ((ScriptRequirement) mqr).get();\n+                } else {\n+                        return false;\n+                }\n+        }\n+        \n         public String getName() {\n                 return name;\n         }"}, {"sha": "52ec7e0d461aa41ef3383bdd6cf479cb0978e330", "filename": "src/server/quest/requirements/ScriptRequirement.java", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/quest/requirements/ScriptRequirement.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/server/quest/requirements/ScriptRequirement.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/requirements/ScriptRequirement.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -0,0 +1,53 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server.quest.requirements;\n+    \n+import client.MapleCharacter;\n+import provider.MapleData;\n+import provider.MapleDataTool;\n+import server.quest.MapleQuest;\n+import server.quest.MapleQuestRequirementType;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class ScriptRequirement extends MapleQuestRequirement {\n+        private boolean reqScript;\n+        \n+\tpublic ScriptRequirement(MapleQuest quest, MapleData data) {\n+\t\tsuper(MapleQuestRequirementType.BUFF);\n+\t\tprocessData(data);\n+\t}\n+\t\n+\t@Override\n+\tpublic void processData(MapleData data) {\n+                reqScript = !MapleDataTool.getString(data, \"\").isEmpty();\n+\t}\n+\t\n+\t@Override\n+\tpublic boolean check(MapleCharacter chr, Integer npcid) {\n+                return true;\n+\t}\n+        \n+        public boolean get() {\n+                return reqScript;\n+        }\n+}"}, {"sha": "d21987a62d7bf187db48ac95c9e6b67e90befa32", "filename": "src/tools/FilePrinter.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/src/tools/FilePrinter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/src/tools/FilePrinter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/FilePrinter.java?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -43,6 +43,7 @@\n             MOB_MOVEMENT = \"game/MobMovement.txt\",\n             MAP_SCRIPT = \"game/mapscript/\",\n             DIRECTION = \"game/directions/\",\n+            GUILD_CHAR_ERROR = \"guilds/GuildCharError.txt\",\n             SAVE_CHAR = \"players/SaveToDB.txt\",\n             INSERT_CHAR = \"players/InsertCharacter.txt\",\n             LOAD_CHAR = \"players/LoadCharFromDB.txt\","}, {"sha": "47010ff93e6e038eaa17c88849af26a3df3c9095", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -17944,7 +17944,7 @@\n         </imgdir>\n         <imgdir name=\"1\">\n           <int name=\"id\" value=\"4000017\"/>\n-          <int name=\"count\" value=\"15\"/>\n+          <int name=\"count\" value=\"20\"/>\n         </imgdir>\n         <imgdir name=\"2\">\n           <int name=\"id\" value=\"4031154\"/>"}, {"sha": "d89f6d0f96c681c9d86957d6dd56ddde3926a9ab", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -4232,7 +4232,7 @@ You can now begin the &quot;Manji&apos;s Request&quot; quest.\n     <int name=\"area\" value=\"30\"/>\n   </imgdir>\n   <imgdir name=\"2057\">\n-    <string name=\"name\" value=\"Shumi&apos;s Lost Bundle of Money\"/>\n+    <string name=\"name\" value=\"Shumi&apos;s Lost Sack of Money\"/>\n     <null name=\"parent\"/>\n     <string name=\"0\" value=\"Let&apos;s go look for Shumi in Kerning City.\"/>\n     <string name=\"1\" value=\"I ran into Shumi again at Kerning City. A while ago, she got a favor from JM From the Streetz to get an elixir for him, only to have the sack of money fall down and lose it all in the process. I guess I can find it at the deep part of the subway station, the #bconstruction site B3#k, again.\"/>"}, {"sha": "81e66477f2a605c1f1971a2abee34c066d0731ff", "filename": "wz/String.wz/Consume.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/String.wz/Consume.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e169971384fa59e5bb2eb4cf279852b674269d4a/wz/String.wz/Consume.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Consume.img.xml?ref=e169971384fa59e5bb2eb4cf279852b674269d4a", "patch": "@@ -8129,7 +8129,7 @@\n   </imgdir>\n   <imgdir name=\"2382092\">\n     <string name=\"name\" value=\"Renegade Spore Card\"/>\n-    <string name=\"desc\" value=\"A card featuring Renegade Spores\\n#cWhen hunting in the Mushroom Castle: \\nJump +1\"/>\n+    <string name=\"desc\" value=\"A card featuring Renegade Spores\\n#cWhen hunting in the Mushroom Castle: \\nAvoidability +1\"/>\n   </imgdir>\n   <imgdir name=\"2382093\">\n     <string name=\"name\" value=\"Poison Mushroom Card\"/>"}]}]},
