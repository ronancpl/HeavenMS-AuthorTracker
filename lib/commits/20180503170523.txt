{"fetchDate": "2019-12-19", "content": [{"sha": "727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NzI3ZGZiMmQ2MmYxMmE1YTJjZWFjOTBkNTJjMTgxNWFiMWI5ZGI2Mw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-05-03T17:05:23Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-05-03T17:05:23Z"}, "message": "Poison/slow update + Map-persistent diseases + Selling zero-qty rechs.\n\nRebalanced CafePQ rewards.\nRebalanced drop chance of some equipments and HT drops with high rates.\nFixed an weird issue where a \"Targa hat\" would appear as a debuff effect.\nAdded visual effect to be displayed to other players when the custom \"Chair Mastery\" skill is being used.\nSlow disease is now visible to other players.\nPoison damage now displays the correct damage amount to other players.\nDisease status are now visible for other players when changing maps.\nFixed recharging price being accounted incorrectly.\nFixed zero-quantity rechargeables not being able to sell at NPC shops.", "tree": {"sha": "15313dab13b7405bfbd413acbb0686fed2ce1462", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/15313dab13b7405bfbd413acbb0686fed2ce1462"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "html_url": "https://github.com/ronancpl/HeavenMS/commit/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d0f1cb3114375d7cc95d5b8bf07d44438efa967", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7d0f1cb3114375d7cc95d5b8bf07d44438efa967", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7d0f1cb3114375d7cc95d5b8bf07d44438efa967"}], "stats": {"total": 885, "additions": 586, "deletions": 299}, "files": [{"sha": "1397b4852f151c1b364c0191c5f0033e626d1139", "filename": "docs/feature_list.md", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -102,6 +102,8 @@ Server potentials:\n * Enhanced buff system: smartly checks for the best available buff effects to be active on the player.\n * Enhanced AP auto-assigner: exactly matches AP with the needed for the player's current level, surplus assigned to the primary attribute.\n * Channel capacity bar functional and world servers with max capacity checks.\n+* Disease status are now visible for other players, even when changing maps.\n+* Poison damage value are now visible for other players.\n * Mastery book announcer displays droppers of needed books of a player, by reading underlying DB.\n * Custom jail system (needs provided custom wz).\n * Delete Character (requires ENABLE_PIC activated).\n@@ -139,6 +141,7 @@ External tools:\n Project:\n \n * Organized project code.\n+* Highly updated drop data.\n * Highly configurable server (see all server flags at ServerConstants).\n * Fixed/added some missing packets for MoveEnvironment, summons and others.\n * Reviewed many Java object aspects that needed concurrency protection."}, {"sha": "01e7e3fda4a70a4772c10c411e600309922abef9", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -907,4 +907,16 @@ Corrigido item de MapleTV sendo retirado 2x ao usar.\n 29 Abril 2018,\n Implementado sistema de senhas para minirooms de match cards/omok.\n Adicionado/documentado mensagens de erro apropriados ao criar/visitar minirooms.\n-Implementado expel em minirooms de jogos.\n\\ No newline at end of file\n+Implementado expel em minirooms de jogos.\n+\n+01 - 02 Maio 2018,\n+Rebalanceado rewards da CafePQ.\n+Rebalanceado equip e horntail drops com chances muito elevadas.\n+Novo comando: maxhpmp.\n+Corrigido exploit menor com jogadores podendo comprar permiss\u00e3o de player shops e merchants antes do level 16.\n+Corrigido efeitos relacionados a Targa sendo mostrados fora de contexto com o disease CONFUSE.\n+Adicionado efeito visual relacionado ao map chair skill sendo usado por um jogador para outros jogadores no mapa.\n+Status de diseases agora s\u00e3o vis\u00edveis para outros jogadores, mesmo trocando de mapas.\n+Dano de poison agora \u00e9 vis\u00edvel para outros jogadores.\n+Corrigido pre\u00e7o contabilizado incorretamente para itens recarreg\u00e1veis.\n+Corrigido recarreg\u00e1veis com quantidade zero n\u00e3o sendo vendidos pelo NPC shop.\n\\ No newline at end of file"}, {"sha": "ae8bb3214296472a2014ef1123abc43330848b88", "filename": "docs/todo.txt", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/todo.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/docs/todo.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/todo.txt?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -54,7 +54,8 @@ Check autoban system\n \n \n ---------------------------\n-** GM/ADMIN **\n+** System **\n+- Update Java version\n ---------------------------\n \n ====================================\n\\ No newline at end of file"}, {"sha": "6f23649b19078c2260f7efe74a650e2170ce6b49", "filename": "scripts/npc/1052014.js", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/1052014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/1052014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052014.js?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -30,22 +30,22 @@\n var status;\n \n var itemSet_lv6 = [1442046, 1432018, 1102146, 1102145, 2022094, 2022544, 2022123, 2022310, 2040727, 2041058, 2040817, 4000030, 4003005, 4003000, 4011007, 4021009, 4011008, 3010098];\n-var itemQty_lv6 = [1, 1, 1, 1, 50, 20, 30, 30, 1, 1, 1, 50, 50, 50, 1, 1, 4, 1];\n+var itemQty_lv6 = [1, 1, 1, 1, 35, 15, 20, 20, 1, 1, 1, 30, 30, 30, 1, 1, 3, 1];\n \n var itemSet_lv5 = [1382015, 1382016, 1442044, 1382035, 2022310, 2022068, 2022069, 2022190, 2022047, 2040727, 2040924, 2040501, 4000030, 4003005, 4003000, 4011003, 4011006, 4021004, 3010099];\n-var itemQty_lv5 = [1, 1, 1, 1, 30, 70, 70, 50, 50, 1, 1, 1, 30, 30, 40, 3, 2, 3, 1];\n+var itemQty_lv5 = [1, 1, 1, 1, 20, 40, 40, 30, 30, 1, 1, 1, 20, 20, 25, 3, 2, 3, 1];\n \n var itemSet_lv4 = [1332029, 1472027, 1462032, 1492019, 2022045, 2022048, 2022094, 2022123, 2022058, 2041304, 2041019, 2040826, 2040758, 4000030, 4003005, 4003000, 4010007, 4011003, 4021003, 3010016, 3010017];\n-var itemQty_lv4 = [1, 1, 1, 1, 70, 60, 40, 30, 100, 1, 1, 1, 1, 15, 15, 30, 8, 1, 1, 1, 1];\n+var itemQty_lv4 = [1, 1, 1, 1, 45, 40, 25, 20, 60, 1, 1, 1, 1, 10, 10, 20, 5, 1, 1, 1, 1];\n \n var itemSet_lv3 = [1302058, 1372008, 1422030, 1422031, 1022082, 2022279, 2022120, 2001001, 2001002, 2022071, 2022189, 2040914, 2041001, 2041041, 2041308, 4031203, 4000030, 4003005, 4003000, 4010004, 4010006, 4020000, 4020006, 3010002, 3010003];\n-var itemQty_lv3 = [1, 1, 1, 1, 1, 100, 70, 70, 70, 40, 40, 1, 1, 1, 1, 15, 10, 15, 12, 5, 5, 5, 5, 1, 1];\n+var itemQty_lv3 = [1, 1, 1, 1, 1, 65, 40, 40, 40, 25, 25, 1, 1, 1, 1, 10, 7, 10, 8, 5, 5, 5, 5, 1, 1];\n \n var itemSet_lv2 = [1022073, 1012098, 1012101, 1012102, 1012103, 2022055, 2022056, 2022103, 2020029, 2020032, 2020031, 2022191, 2022016, 2043300, 2043110, 2043800, 2041001, 2040903, 4031203, 4000021, 4003005, 4003000, 4003001, 4010000, 4010001, 4010003, 4010004, 4020004, 3010004, 3010005];\n-var itemQty_lv2 = [1, 1, 1, 1, 1, 70, 70, 70, 70, 100, 100, 100, 100, 1, 1, 1, 1, 1, 7, 10, 12, 10, 3, 8, 8, 5, 5, 7, 1, 1];\n+var itemQty_lv2 = [1, 1, 1, 1, 1, 40, 40, 40, 40, 60, 60, 60, 60, 1, 1, 1, 1, 1, 4, 6, 7, 5, 2, 4, 4, 3, 3, 4, 1, 1];\n \n var itemSet_lv1 = [1302021, 1302024, 1302033, 1082150, 1002419, 2022053, 2022054, 2020032, 2022057, 2022096, 2022097, 2022192, 2020030, 2010005, 2022041, 2030000, 2040100, 2040004, 2040207, 2048004, 4031203, 4000021, 4003005, 4003000, 4003001, 4010000, 4010001, 4010002, 4010005, 4020004];\n-var itemQty_lv1 = [1, 1, 1, 1, 1, 30, 30, 30, 30, 30, 40, 40, 40, 80, 80, 20, 1, 1, 1, 1, 3, 5, 2, 2, 1, 3, 3, 3, 3, 3];\n+var itemQty_lv1 = [1, 1, 1, 1, 1, 20, 20, 20, 20, 20, 25, 25, 25, 50, 50, 12, 1, 1, 1, 1, 3, 4, 2, 2, 1, 2, 2, 2, 2, 2];\n \n var levels = [\"Tier 1\", \"Tier 2\", \"Tier 3\", \"Tier 4\", \"Tier 5\", \"Tier 6\"];\n "}, {"sha": "f1a0329b62245fc23a8bd3e5aeab61d722a85513", "filename": "scripts/npc/1052015.js", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/1052015.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/1052015.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052015.js?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -30,22 +30,22 @@\n var status;\n \n var itemSet_lv6 = [1442046, 1432018, 1102146, 1102145, 2022094, 2022544, 2022123, 2022310, 2040727, 2041058, 2040817, 4000030, 4003005, 4003000, 4011007, 4021009, 4011008, 3010098];\n-var itemQty_lv6 = [1, 1, 1, 1, 50, 20, 30, 30, 1, 1, 1, 50, 50, 50, 1, 1, 4, 1];\n+var itemQty_lv6 = [1, 1, 1, 1, 35, 15, 20, 20, 1, 1, 1, 30, 30, 30, 1, 1, 3, 1];\n \n var itemSet_lv5 = [1382015, 1382016, 1442044, 1382035, 2022310, 2022068, 2022069, 2022190, 2022047, 2040727, 2040924, 2040501, 4000030, 4003005, 4003000, 4011003, 4011006, 4021004, 3010099];\n-var itemQty_lv5 = [1, 1, 1, 1, 30, 70, 70, 50, 50, 1, 1, 1, 30, 30, 40, 3, 2, 3, 1];\n+var itemQty_lv5 = [1, 1, 1, 1, 20, 40, 40, 30, 30, 1, 1, 1, 20, 20, 25, 3, 2, 3, 1];\n \n var itemSet_lv4 = [1332029, 1472027, 1462032, 1492019, 2022045, 2022048, 2022094, 2022123, 2022058, 2041304, 2041019, 2040826, 2040758, 4000030, 4003005, 4003000, 4010007, 4011003, 4021003, 3010016, 3010017];\n-var itemQty_lv4 = [1, 1, 1, 1, 70, 60, 40, 30, 100, 1, 1, 1, 1, 15, 15, 30, 8, 1, 1, 1, 1];\n+var itemQty_lv4 = [1, 1, 1, 1, 45, 40, 25, 20, 60, 1, 1, 1, 1, 10, 10, 20, 5, 1, 1, 1, 1];\n \n var itemSet_lv3 = [1302058, 1372008, 1422030, 1422031, 1022082, 2022279, 2022120, 2001001, 2001002, 2022071, 2022189, 2040914, 2041001, 2041041, 2041308, 4031203, 4000030, 4003005, 4003000, 4010004, 4010006, 4020000, 4020006, 3010002, 3010003];\n-var itemQty_lv3 = [1, 1, 1, 1, 1, 100, 70, 70, 70, 40, 40, 1, 1, 1, 1, 15, 10, 15, 12, 5, 5, 5, 5, 1, 1];\n+var itemQty_lv3 = [1, 1, 1, 1, 1, 65, 40, 40, 40, 25, 25, 1, 1, 1, 1, 10, 7, 10, 8, 5, 5, 5, 5, 1, 1];\n \n var itemSet_lv2 = [1022073, 1012098, 1012101, 1012102, 1012103, 2022055, 2022056, 2022103, 2020029, 2020032, 2020031, 2022191, 2022016, 2043300, 2043110, 2043800, 2041001, 2040903, 4031203, 4000021, 4003005, 4003000, 4003001, 4010000, 4010001, 4010003, 4010004, 4020004, 3010004, 3010005];\n-var itemQty_lv2 = [1, 1, 1, 1, 1, 70, 70, 70, 70, 100, 100, 100, 100, 1, 1, 1, 1, 1, 7, 10, 12, 10, 3, 8, 8, 5, 5, 7, 1, 1];\n+var itemQty_lv2 = [1, 1, 1, 1, 1, 40, 40, 40, 40, 60, 60, 60, 60, 1, 1, 1, 1, 1, 4, 6, 7, 5, 2, 4, 4, 3, 3, 4, 1, 1];\n \n var itemSet_lv1 = [1302021, 1302024, 1302033, 1082150, 1002419, 2022053, 2022054, 2020032, 2022057, 2022096, 2022097, 2022192, 2020030, 2010005, 2022041, 2030000, 2040100, 2040004, 2040207, 2048004, 4031203, 4000021, 4003005, 4003000, 4003001, 4010000, 4010001, 4010002, 4010005, 4020004];\n-var itemQty_lv1 = [1, 1, 1, 1, 1, 30, 30, 30, 30, 30, 40, 40, 40, 80, 80, 20, 1, 1, 1, 1, 3, 5, 2, 2, 1, 3, 3, 3, 3, 3];\n+var itemQty_lv1 = [1, 1, 1, 1, 1, 20, 20, 20, 20, 20, 25, 25, 25, 50, 50, 12, 1, 1, 1, 1, 3, 4, 2, 2, 1, 2, 2, 2, 2, 2];\n \n var levels = [\"Tier 1\", \"Tier 2\", \"Tier 3\", \"Tier 4\", \"Tier 5\", \"Tier 6\"];\n "}, {"sha": "42b1a98a12f1d929b51984f3434656a22d51bad1", "filename": "scripts/npc/commands.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/commands.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/scripts/npc/commands.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/commands.js?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -114,6 +114,7 @@ function writeSolaxiaCommandsLv3() {    //GM\n         addCommand(\"reloadportals\", \"\");\n         addCommand(\"reloadmap\", \"\");\n         addCommand(\"hpmp\", \"\");\n+        addCommand(\"maxhpmp\", \"\");\n         addCommand(\"music\", \"\");\n         addCommand(\"monitor\", \"\");\n         addCommand(\"monitors\", \"\");"}, {"sha": "29635281383ad4414b7f3a4bcee754dd36c2879f", "filename": "sql/db_database.sql", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -11545,7 +11545,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (11327, 2100107, 1382009, 1, 1, 0, 700),\n (11328, 3210100, 1382009, 1, 1, 0, 700),\n (11329, 4230502, 1382009, 1, 1, 0, 700),\n-(11804, 9420530, 1482007, 1, 1, 0, 333333),\n+(11804, 9420530, 1482007, 1, 1, 0, 2000),\n (11803, 9420530, 1002166, 1, 1, 0, 2000),\n (11802, 9420530, 1002212, 1, 1, 0, 2000),\n (11801, 9420530, 1032012, 1, 1, 0, 1800),\n@@ -11780,7 +11780,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (11777, 9420534, 1002254, 1, 1, 0, 2000),\n (11776, 9420534, 1382015, 1, 1, 0, 1800),\n (11775, 9420534, 1452010, 1, 1, 0, 1500),\n-(11805, 9420530, 1492007, 1, 1, 0, 333333),\n+(11805, 9420530, 1492007, 1, 1, 0, 2000),\n (11806, 9420015, 4000420, 1, 1, 0, 300000),\n (11807, 9420015, 4000421, 1, 1, 0, 300000),\n (11808, 9420500, 4000369, 1, 1, 0, 300000),\n@@ -11900,7 +11900,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (11922, 9420504, 4030012, 1, 1, 0, 300),\n (11923, 9420504, 1072291, 1, 1, 0, 2000),\n (11924, 9420504, 1082186, 1, 1, 0, 2000),\n-(11925, 9420504, 1482003, 1, 1, 0, 333333),\n+(11925, 9420504, 1482003, 1, 1, 0, 1800),\n (11926, 9420504, 2331000, 1, 1, 0, 500),\n (11927, 9420505, 4000378, 1, 1, 0, 300000),\n (11928, 9420505, 400002, 1, 1, 0, 10000),\n@@ -12306,7 +12306,7 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (12328, 9420527, 1002625, 1, 1, 0, 2000),\n (12329, 9420527, 1052110, 1, 1, 0, 1800),\n (12330, 9420527, 1082192, 1, 1, 0, 2000),\n-(12331, 9420527, 1492000, 1, 1, 0, 333333),\n+(12331, 9420527, 1492000, 1, 1, 0, 1800),\n (12332, 9420527, 2330000, 1, 1, 0, 500),\n (12333, 9420528, 4000466, 1, 1, 0, 300000),\n (12334, 9420528, 2020006, 1, 1, 0, 333333),"}, {"sha": "fe1e71e264e85ebdf0b82a5bd4b2f18d7b756c01", "filename": "sql/db_drops.sql", "status": "modified", "additions": 85, "deletions": 9, "changes": 94, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -19202,6 +19202,82 @@ USE `heavenms`;\n (4300016,0,120,140,0,400000),\n (4300017,0,540,800,0,400000);\n \n+  # delete/normalize item drops from Horntail\n+  DELETE FROM temp_data WHERE dropperid=8810018;\n+  INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n+(8810018,0,40000,50000,0,400000),\n+(8810018,1122000,1,1,0,151200),\n+(8810018,1302056,1,1,0,151200),\n+(8810018,1302059,1,1,0,151200),\n+(8810018,1312030,1,1,0,151200),\n+(8810018,1312031,1,1,0,151200),\n+(8810018,1322045,1,1,0,151200),\n+(8810018,1322052,1,1,0,151200),\n+(8810018,1332049,1,1,0,108000),\n+(8810018,1332050,1,1,0,108000),\n+(8810018,1332051,1,1,0,108000),\n+(8810018,1332052,1,1,0,108000),\n+(8810018,1372010,1,1,0,151200),\n+(8810018,1372032,1,1,0,151200),\n+(8810018,1382035,1,1,0,151200),\n+(8810018,1382036,1,1,0,151200),\n+(8810018,1402035,1,1,0,151200),\n+(8810018,1402036,1,1,0,151200),\n+(8810018,1412021,1,1,0,151200),\n+(8810018,1412026,1,1,0,151200),\n+(8810018,1422027,1,1,0,151200),\n+(8810018,1422028,1,1,0,151200),\n+(8810018,1432030,1,1,0,108000),\n+(8810018,1432038,1,1,0,108000),\n+(8810018,1442044,1,1,0,151200),\n+(8810018,1442045,1,1,0,151200),\n+(8810018,1452019,1,1,0,108000),\n+(8810018,1452020,1,1,0,108000),\n+(8810018,1452021,1,1,0,108000),\n+(8810018,1452044,1,1,0,108000),\n+(8810018,1462015,1,1,0,108000),\n+(8810018,1462016,1,1,0,108000),\n+(8810018,1462017,1,1,0,108000),\n+(8810018,1462039,1,1,0,108000),\n+(8810018,1472051,1,1,0,108000),\n+(8810018,1472052,1,1,0,108000),\n+(8810018,1472053,1,1,0,108000),\n+(8810018,1482012,1,1,0,108000),\n+(8810018,1482013,1,1,0,108000),\n+(8810018,1492012,1,1,0,108000),\n+(8810018,1492013,1,1,0,108000),\n+(8810018,2000004,1,1,0,800000),\n+(8810018,2000005,1,1,0,800000),\n+(8810018,2000006,1,1,0,800000),\n+(8810018,2020013,1,1,0,800000),\n+(8810018,2020015,1,1,0,800000),\n+(8810018,2040317,1,1,0,64800),\n+(8810018,2040418,1,1,0,64800),\n+(8810018,2040421,1,1,0,64800),\n+(8810018,2040512,1,1,0,64800),\n+(8810018,2040515,1,1,0,64800),\n+(8810018,2040625,1,1,0,64800),\n+(8810018,2049000,1,1,0,32400),\n+(8810018,2049100,1,1,0,64800),\n+(8810018,2290017,1,1,0,108000),\n+(8810018,2290021,1,1,0,108000),\n+(8810018,2290023,1,1,0,108000),\n+(8810018,2290041,1,1,0,108000),\n+(8810018,2290047,1,1,0,108000),\n+(8810018,2290049,1,1,0,108000),\n+(8810018,2290065,1,1,0,108000),\n+(8810018,2290075,1,1,0,108000),\n+(8810018,2290085,1,1,0,108000),\n+(8810018,2290095,1,1,0,108000),\n+(8810018,2290096,1,1,0,80000),\n+(8810018,2290111,1,1,0,108000),\n+(8810018,2290116,1,1,0,108000),\n+(8810018,2290125,1,1,0,100000),\n+(8810018,2290133,1,1,0,45000),\n+(8810018,2290137,1,1,0,45000),\n+(8810018,2290139,1,1,0,45000),\n+(8810018,4001094,1,1,0,999999);\n+\n   #insert things that should be present by now, but aren't yet.\n \n   INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n@@ -19619,10 +19695,10 @@ USE `heavenms`;\n (9400640, 1082074, 1, 1, 0, 2000),\n (9400640, 1002285, 1, 1, 0, 1500),\n (9400640, 1002210, 1, 1, 0, 2000),\n-(9420544, 1003023, 1, 1, 0, 50000),\n-(9420544, 1003024, 1, 1, 0, 50000),\n-(9420549, 1003025, 1, 1, 0, 50000),\n-(9420549, 1003026, 1, 1, 0, 50000),\n+(9420544, 1003023, 3, 5, 0, 50000),\n+(9420544, 1003024, 3, 5, 0, 50000),\n+(9420549, 1003025, 3, 5, 0, 50000),\n+(9420549, 1003026, 3, 5, 0, 50000),\n (9300066, 4001087, 1, 1, 0, 999999),\n (9300067, 4001088, 1, 1, 0, 999999),\n (9300069, 4001089, 1, 1, 0, 999999),\n@@ -20475,11 +20551,11 @@ USE `heavenms`;\n   # zhelms, pink bean customs\n   DELETE FROM temp_data WHERE itemid=1002357;\n   INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n-(8800002, 1002357, 1, 1, 0, 300000),\n-(8800002, 1002390, 1, 1, 0, 80000),\n-(8800002, 1002430, 1, 1, 0, 40000),\n-(8820001, 1002971, 1, 1, 0, 80000),\n-(8820001, 1052202, 1, 1, 0, 80000);\n+(8800002, 1002357, 1, 2, 0, 300000),\n+(8800002, 1002390, 3, 5, 0, 80000),\n+(8800002, 1002430, 3, 5, 0, 40000),\n+(8820001, 1002971, 3, 5, 0, 80000),\n+(8820001, 1052202, 3, 5, 0, 80000);\n \n   # delete item drops from bosses in inactive form\n   DELETE FROM temp_data WHERE dropperid=4220001;"}, {"sha": "b3ecf2a2c4f60c3eda432d4aa664d8616d28db55", "filename": "src/client/BuddyList.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/BuddyList.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/BuddyList.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/BuddyList.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -134,7 +134,7 @@ public void broadcast(byte[] packet, PlayerStorage pstorage) {\n         for(int bid : getBuddyIds()) {\n             MapleCharacter chr = pstorage.getCharacterById(bid);\n             \n-            if(chr != null && chr.isLoggedin() && !chr.isAwayFromWorld()) {\n+            if(chr != null && chr.isLoggedinWorld()) {\n                 chr.announce(packet);\n             }\n         }"}, {"sha": "9ee3d46644ae53bd385744f5e2458a8806b7b29e", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 64, "deletions": 30, "changes": 94, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -257,7 +257,7 @@\n     private Map<Integer, MapleKeyBinding> keymap = new LinkedHashMap<>();\n     private Map<Integer, MapleSummon> summons = new LinkedHashMap<>();\n     private Map<Integer, MapleCoolDownValueHolder> coolDowns = new LinkedHashMap<>();\n-    private EnumMap<MapleDisease, MapleDiseaseValueHolder> diseases = new EnumMap<>(MapleDisease.class);\n+    private EnumMap<MapleDisease, Pair<MapleDiseaseValueHolder, MobSkill>> diseases = new EnumMap<>(MapleDisease.class);\n     private Map<Integer, MapleDoor> doors = new LinkedHashMap<>();\n     private Map<MapleQuest, Long> questExpirations = new LinkedHashMap<>();\n     private ScheduledFuture<?> dragonBloodSchedule;\n@@ -428,6 +428,10 @@ public static MapleCharacter getDefault(MapleClient c) {\n         return ret;\n     }\n     \n+    public boolean isLoggedinWorld() {\n+        return this.isLoggedin() && !this.isAwayFromWorld();\n+    }\n+    \n     public boolean isAwayFromWorld() {\n         return awayFromWorld.get();\n     }\n@@ -2042,16 +2046,17 @@ public final int getDiseasesSize() {\n         }\n     }\n \n-    public Map<MapleDisease, Long> getAllDiseases() {\n+    public Map<MapleDisease, Pair<Long, MobSkill>> getAllDiseases() {\n         chrLock.lock();\n         try {\n             long curtime = System.currentTimeMillis();\n-            Map<MapleDisease, Long> ret = new LinkedHashMap<>();\n+            Map<MapleDisease, Pair<Long, MobSkill>> ret = new LinkedHashMap<>();\n             \n             for(Entry<MapleDisease, Long> de : diseaseExpires.entrySet()) {\n-                MapleDiseaseValueHolder mdvh = diseases.get(de.getKey());\n+                Pair<MapleDiseaseValueHolder, MobSkill> dee = diseases.get(de.getKey());\n+                MapleDiseaseValueHolder mdvh = dee.getLeft();\n                 \n-                ret.put(de.getKey(), mdvh.length - (curtime - mdvh.startTime));\n+                ret.put(de.getKey(), new Pair<>(mdvh.length - (curtime - mdvh.startTime), dee.getRight()));\n             }\n             \n             return ret;\n@@ -2060,16 +2065,36 @@ public final int getDiseasesSize() {\n         }\n     }\n     \n-    public void silentApplyDiseases(Map<MapleDisease, Long> diseaseMap) {\n+    public void silentApplyDiseases(Map<MapleDisease, Pair<Long, MobSkill>> diseaseMap) {\n         chrLock.lock();\n         try {\n             long curTime = System.currentTimeMillis();\n             \n-            for(Entry<MapleDisease, Long> di : diseaseMap.entrySet()) {\n-                long expTime = curTime + di.getValue();\n+            for(Entry<MapleDisease, Pair<Long, MobSkill>> di : diseaseMap.entrySet()) {\n+                long expTime = curTime + di.getValue().getLeft();\n                 \n                 diseaseExpires.put(di.getKey(), expTime);\n-                diseases.put(di.getKey(), new MapleDiseaseValueHolder(curTime, expTime));\n+                diseases.put(di.getKey(), new Pair<>(new MapleDiseaseValueHolder(curTime, expTime), di.getValue().getRight()));\n+            }\n+        } finally {\n+            chrLock.unlock();\n+        }\n+    }\n+    \n+    public void announceDiseases(MapleClient c) {\n+        chrLock.lock();\n+        try {\n+            // Poison damage visibility and diseases status visibility, extended through map transitions thanks to Ronan\n+            \n+            if(!this.isLoggedinWorld()) return;\n+            \n+            for(Entry<MapleDisease, Pair<MapleDiseaseValueHolder, MobSkill>> di : diseases.entrySet()) {\n+                MapleDisease disease = di.getKey();\n+                MobSkill skill = di.getValue().getRight();\n+                final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(disease, Integer.valueOf(skill.getX())));\n+                \n+                if(disease != MapleDisease.SLOW) c.announce(MaplePacketCreator.giveForeignDebuff(id, debuff, skill));\n+                else c.announce(MaplePacketCreator.giveForeignSlowDebuff(id, debuff, skill));\n             }\n         } finally {\n             chrLock.unlock();\n@@ -2088,22 +2113,26 @@ public void giveDebuff(final MapleDisease disease, MobSkill skill) {\n             try {\n                 long curTime = System.currentTimeMillis();\n                 diseaseExpires.put(disease, curTime + skill.getDuration());\n-                diseases.put(disease, new MapleDiseaseValueHolder(curTime, skill.getDuration()));\n+                diseases.put(disease, new Pair<>(new MapleDiseaseValueHolder(curTime, skill.getDuration()), skill));\n             } finally {\n                 chrLock.unlock();\n             }\n             \n             final List<Pair<MapleDisease, Integer>> debuff = Collections.singletonList(new Pair<>(disease, Integer.valueOf(skill.getX())));\n             client.announce(MaplePacketCreator.giveDebuff(debuff, skill));\n-            map.broadcastMessage(this, MaplePacketCreator.giveForeignDebuff(id, debuff, skill), false);\n+            \n+            if(disease != MapleDisease.SLOW) map.broadcastMessage(this, MaplePacketCreator.giveForeignDebuff(id, debuff, skill), false);\n+            else map.broadcastMessage(this, MaplePacketCreator.giveForeignSlowDebuff(id, debuff, skill), false);\n         }\n     }\n \n     public void dispelDebuff(MapleDisease debuff) {\n         if (hasDisease(debuff)) {\n             long mask = debuff.getValue();\n             announce(MaplePacketCreator.cancelDebuff(mask));\n-            map.broadcastMessage(this, MaplePacketCreator.cancelForeignDebuff(id, mask), false);\n+            \n+            if(debuff != MapleDisease.SLOW) map.broadcastMessage(this, MaplePacketCreator.cancelForeignDebuff(id, mask), false);\n+            else map.broadcastMessage(this, MaplePacketCreator.cancelForeignSlowDebuff(id), false);\n \n             chrLock.lock();\n             try {\n@@ -3022,10 +3051,10 @@ public void cancelEffect(int itemId) {\n         cancelEffect(ii.getItemEffect(itemId), false, -1);\n     }\n \n-    public void cancelEffect(MapleStatEffect effect, boolean overwrite, long startTime) {\n+    public boolean cancelEffect(MapleStatEffect effect, boolean overwrite, long startTime) {\n         effLock.lock();\n         try {\n-            cancelEffect(effect, overwrite, startTime, true);\n+            return cancelEffect(effect, overwrite, startTime, true);\n         } finally {\n             effLock.unlock();\n         }\n@@ -3068,10 +3097,12 @@ private void updateEffects(Set<MapleBuffStat> removedStats) {\n         }\n     }\n     \n-    private void cancelEffect(MapleStatEffect effect, boolean overwrite, long startTime, boolean firstCancel) {\n+    private boolean cancelEffect(MapleStatEffect effect, boolean overwrite, long startTime, boolean firstCancel) {\n         Set<MapleBuffStat> removedStats = new LinkedHashSet<>();\n         dropBuffStats(cancelEffectInternal(effect, overwrite, startTime, removedStats));\n         updateEffects(removedStats);\n+        \n+        return !removedStats.isEmpty();\n     }\n     \n     private List<Pair<MapleBuffStat, MapleBuffStatValueHolder>> cancelEffectInternal(MapleStatEffect effect, boolean overwrite, long startTime, Set<MapleBuffStat> removedStats) {\n@@ -3480,26 +3511,31 @@ private static int getJobMapChair(MapleJob job) {\n         }\n     }\n     \n-    public void unregisterChairBuff() {\n-        if(!ServerConstants.USE_CHAIR_EXTRAHEAL) return;\n+    public boolean unregisterChairBuff() {\n+        if(!ServerConstants.USE_CHAIR_EXTRAHEAL) return false;\n         \n         int skillId = getJobMapChair(job);\n         int skillLv = getSkillLevel(skillId);\n         if(skillLv > 0) {\n             MapleStatEffect mapChairSkill = SkillFactory.getSkill(skillId).getEffect(skillLv);\n-            cancelEffect(mapChairSkill, false, -1);\n+            return cancelEffect(mapChairSkill, false, -1);\n         }\n+        \n+        return false;\n     }\n     \n-    public void registerChairBuff() {\n-        if(!ServerConstants.USE_CHAIR_EXTRAHEAL) return;\n+    public boolean registerChairBuff() {\n+        if(!ServerConstants.USE_CHAIR_EXTRAHEAL) return false;\n         \n         int skillId = getJobMapChair(job);\n         int skillLv = getSkillLevel(skillId);\n         if(skillLv > 0) {\n             MapleStatEffect mapChairSkill = SkillFactory.getSkill(skillId).getEffect(skillLv);\n             mapChairSkill.applyTo(this);\n+            return true;\n         }\n+        \n+        return false;\n     }\n     \n     public int getChair() {\n@@ -4216,7 +4252,8 @@ public int getPartyId() {\n         try {\n             if(party != null) {\n                 for(MaplePartyCharacter partyMembers: party.getMembers()) {\n-                    if(partyMembers.getPlayer().getMap().hashCode() == thisMapHash) list.add(partyMembers.getPlayer());\n+                    MapleCharacter chr = partyMembers.getPlayer();\n+                    if(chr.getMap().hashCode() == thisMapHash && chr.isLoggedinWorld()) list.add(chr);\n                 }\n             }\n         } finally {\n@@ -7240,16 +7277,9 @@ private int standaloneSell(MapleClient c, MapleItemInformationProvider ii, Maple\n         \n         if (quantity <= iQuant && iQuant > 0) {\n             MapleInventoryManipulator.removeFromSlot(c, type, (byte) slot, quantity, false);\n-            double price;\n             int itemid = item.getItemId();\n-            if (ItemConstants.isRechargable(itemid)) {\n-            \tprice = ii.getWholePrice(itemid) / (double) ii.getSlotMax(c, itemid);\n-            } else {\n-                price = ii.getPrice(itemid);\n-            }\n-            \n-            int recvMesos = (int) Math.max(Math.ceil(price * quantity), 0);\n-            if (price != -1 && recvMesos > 0) {\n+            int recvMesos = ii.getPrice(itemid, quantity);\n+            if (recvMesos > 0) {\n                 gainMeso(recvMesos, false);\n                 return(recvMesos);\n             }\n@@ -7722,6 +7752,10 @@ public void sendDestroyData(MapleClient client) {\n     public void sendSpawnData(MapleClient client) {\n         if (!this.isHidden() || client.getPlayer().gmLevel() > 1) {\n             client.announce(MaplePacketCreator.spawnPlayerMapObject(this));\n+            \n+            if(hasBuffFromSourceid(getJobMapChair(job))) {\n+                client.announce(MaplePacketCreator.giveForeignChairSkillEffect(id));\n+            }\n         }\n \n         if (this.isHidden()) {"}, {"sha": "ba5c7464b1f8269e155ced514409e37c7e38ec85", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -1256,7 +1256,7 @@ public synchronized void announceBossHpBar(MapleMonster mm, final int mobHash, f\n \t}\n         \n \tpublic synchronized void announce(final byte[] packet) {//MINA CORE IS A FUCKING BITCH AND I HATE IT <3\n-\t\tsession.write(packet);\n+                session.write(packet);\n \t}\n \n         public void announceHint(String msg, int length) {"}, {"sha": "6af1b4918dc5182e5d2beb4a52e703afb6a5a41e", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -1764,7 +1764,7 @@ public static boolean executeHeavenMsCommandLv3(Channel cserv, Server srv, Maple\n                         } else if(sub.length == 2) {\n                                 statUpdate = Integer.valueOf(sub[1]);\n                         } else {\n-\t\t\t\tplayer.yellowMessage(\"Syntax: !sethpmp [<playername>] <value>\");\n+\t\t\t\tplayer.yellowMessage(\"Syntax: !hpmp [<playername>] <value>\");\n                         }\n                     \n                         if(victim != null) {\n@@ -1779,6 +1779,41 @@ public static boolean executeHeavenMsCommandLv3(Channel cserv, Server srv, Maple\n                         }\n                     break;\n                    \n+                case \"maxhpmp\":\n+                        victim = player;\n+                        statUpdate = 1;\n+                        \n+                        if (sub.length >= 3) {\n+                                victim = c.getWorldServer().getPlayerStorage().getCharacterByName(sub[1]);\n+                                statUpdate = Integer.valueOf(sub[2]);\n+                        } else if(sub.length == 2) {\n+                                statUpdate = Integer.valueOf(sub[1]);\n+                        } else {\n+\t\t\t\tplayer.yellowMessage(\"Syntax: !maxhpmp [<playername>] <value>\");\n+                        }\n+                    \n+                        if(victim != null) {\n+                                if(victim.getHp() > statUpdate) {\n+                                        victim.setHp(statUpdate);\n+                                        victim.updateSingleStat(MapleStat.HP, statUpdate);\n+                                }\n+                                \n+                                if(victim.getMp() > statUpdate) {\n+                                        victim.setMp(statUpdate);\n+                                        victim.updateSingleStat(MapleStat.MP, statUpdate);\n+                                }\n+                            \n+                                victim.setMaxHp(statUpdate);\n+                                victim.setMaxMp(statUpdate);\n+                                victim.updateSingleStat(MapleStat.MAXHP, statUpdate);\n+                                victim.updateSingleStat(MapleStat.MAXMP, statUpdate);\n+                                \n+                                victim.checkBerserk(victim.isHidden());\n+                        } else {\n+                                player.message(\"Player '\" + sub[1] + \"' could not be found on this world.\");\n+                        }\n+                    break;\n+                   \n \t\tcase \"music\":\n \t\t\tif (sub.length < 2) {\n \t\t\t\tplayer.yellowMessage(\"Syntax: !music <song>\");"}, {"sha": "75d06c7cbe52d214cbecb66b04d5ec95368b2771", "filename": "src/client/newyear/NewYearCardRecord.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/newyear/NewYearCardRecord.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/client/newyear/NewYearCardRecord.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/newyear/NewYearCardRecord.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -272,7 +272,7 @@ public void run() {\n                 }\n                 \n                 MapleCharacter target = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterById(receiverId);\n-                if(target != null && target.isLoggedin() && !target.isAwayFromWorld()) {\n+                if(target != null && target.isLoggedinWorld()) {\n                     target.announce(MaplePacketCreator.onNewYearCardRes(target, NewYearCardRecord.this, 0xC, 0));\n                 }\n             }\n@@ -328,7 +328,7 @@ public static void removeAllNewYearCard(boolean send, MapleCharacter chr) {\n                     chr.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(chr, nyc, 0xE, 0));\n \n                     MapleCharacter other = chr.getClient().getWorldServer().getPlayerStorage().getCharacterById(nyc.getReceiverId());\n-                    if(other != null && other.isLoggedin() && !other.isAwayFromWorld()) {\n+                    if(other != null && other.isLoggedinWorld()) {\n                         other.removeNewYearRecord(nyc);\n                         other.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(other, nyc, 0xE, 0));\n \n@@ -346,7 +346,7 @@ public static void removeAllNewYearCard(boolean send, MapleCharacter chr) {\n                     chr.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(chr, nyc, 0xE, 0));\n \n                     MapleCharacter other = chr.getClient().getWorldServer().getPlayerStorage().getCharacterById(nyc.getSenderId());\n-                    if(other != null && other.isLoggedin() && !other.isAwayFromWorld()) {\n+                    if(other != null && other.isLoggedinWorld()) {\n                         other.removeNewYearRecord(nyc);\n                         other.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(other, nyc, 0xE, 0));\n "}, {"sha": "738d4c0e2f3dc38c6f7871e01fab9c41d7887aac", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -171,6 +171,11 @@ public static boolean isMakerReagent(int itemId) {\n     public static boolean isOverall(int itemId) {\n         return itemId / 10000 == 105;\n     }\n+    \n+    public static boolean isCashStore(int itemId) {\n+        int itemType = itemId / 10000;\n+        return itemType == 503 || itemType == 514;\n+    }\n \n     public static boolean isWeapon(int itemId) {\n         return itemId >= 1302000 && itemId < 1492024;"}, {"sha": "b37a2ff098efc1e680aafabe3da5711e3413b259", "filename": "src/net/server/PlayerBuffStorage.java", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/PlayerBuffStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/PlayerBuffStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/PlayerBuffStorage.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -26,6 +26,8 @@\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.locks.Lock;\n+import server.life.MobSkill;\n+import tools.Pair;\n import tools.locks.MonitoredLockType;\n import tools.locks.MonitoredReentrantLock;\n \n@@ -38,7 +40,7 @@\n     private int id = (int) (Math.random() * 100);\n     private final Lock lock = new MonitoredReentrantLock(MonitoredLockType.BUFF_STORAGE, true);    \n     private Map<Integer, List<PlayerBuffValueHolder>> buffs = new HashMap<>();\n-    private Map<Integer, Map<MapleDisease, Long>> diseases = new HashMap<>();\n+    private Map<Integer, Map<MapleDisease, Pair<Long, MobSkill>>> diseases = new HashMap<>();\n \n     public void addBuffsToStorage(int chrid, List<PlayerBuffValueHolder> toStore) {\n         lock.lock();\n@@ -58,7 +60,7 @@ public void addBuffsToStorage(int chrid, List<PlayerBuffValueHolder> toStore) {\n         }\n     }\n     \n-    public void addDiseasesToStorage(int chrid, Map<MapleDisease, Long> toStore) {\n+    public void addDiseasesToStorage(int chrid, Map<MapleDisease, Pair<Long, MobSkill>> toStore) {\n         lock.lock();\n         try {\n             diseases.put(chrid, toStore);\n@@ -67,7 +69,7 @@ public void addDiseasesToStorage(int chrid, Map<MapleDisease, Long> toStore) {\n         }\n     }\n \n-    public Map<MapleDisease, Long> getDiseasesFromStorage(int chrid) {\n+    public Map<MapleDisease, Pair<Long, MobSkill>> getDiseasesFromStorage(int chrid) {\n         lock.lock();\n         try {\n             return diseases.remove(chrid);"}, {"sha": "e26a265a9e3704e17108aa1b39e9faef54524318", "filename": "src/net/server/Server.java", "status": "modified", "additions": 38, "deletions": 1, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -21,6 +21,7 @@\n  */\n package net.server;\n \n+import net.server.worker.CharacterDiseaseWorker;\n import net.server.worker.CouponWorker;\n import net.server.worker.RankingWorker;\n import java.io.FileInputStream;\n@@ -94,9 +95,12 @@\n     private final Map<MapleClient, Long> inLoginState = new HashMap<>(100);\n     private final Lock srvLock = new MonitoredReentrantLock(MonitoredLockType.SERVER);\n     private final Lock lgnLock = new MonitoredReentrantLock(MonitoredLockType.SERVER);\n+    private final Lock disLock = new MonitoredReentrantLock(MonitoredLockType.SERVER);\n     private final PlayerBuffStorage buffStorage = new PlayerBuffStorage();\n     private final Map<Integer, MapleAlliance> alliances = new HashMap<>(100);\n     private final Map<Integer, NewYearCardRecord> newyears = new HashMap<>();\n+    private final List<MapleClient> processDiseaseAnnouncePlayers = new LinkedList<>();\n+    private final List<MapleClient> registeredDiseaseAnnouncePlayers = new LinkedList<>();\n     \n     private boolean online = false;\n     public static long uptime = System.currentTimeMillis();\n@@ -261,7 +265,39 @@ public void updateActiveCoupons() throws SQLException {\n             }\n         }\n     }\n-\n+    \n+    public void runAnnouncePlayerDiseasesSchedule() {\n+        disLock.lock();\n+        try {\n+            while(!processDiseaseAnnouncePlayers.isEmpty()) {\n+                MapleClient c = processDiseaseAnnouncePlayers.remove(0);\n+                MapleCharacter player = c.getPlayer();\n+                if(player != null && player.isLoggedinWorld()) {\n+                    for(MapleCharacter chr : player.getMap().getCharacters()) {\n+                        chr.announceDiseases(c);\n+                    }\n+                }\n+            }\n+            \n+            // this is to force the system to wait for at least one complete tick before releasing disease info for the registered clients\n+            while(!registeredDiseaseAnnouncePlayers.isEmpty()) {\n+                MapleClient c = registeredDiseaseAnnouncePlayers.remove(0);\n+                processDiseaseAnnouncePlayers.add(c);\n+            }\n+        } finally {\n+            disLock.unlock();\n+        }\n+    }\n+    \n+    public void registerAnnouncePlayerDiseases(MapleClient c) {\n+        disLock.lock();\n+        try {\n+            registeredDiseaseAnnouncePlayers.add(c);\n+        } finally {\n+            disLock.unlock();\n+        }\n+    }\n+    \n     public void init() {\n         Properties p = new Properties();\n         try {\n@@ -306,6 +342,7 @@ public void init() {\n         disconnectIdlesOnLoginTask();\n         \n         long timeLeft = getTimeLeftForNextHour();\n+        tMan.register(new CharacterDiseaseWorker(), 777, 777);\n         tMan.register(new CouponWorker(), ServerConstants.COUPON_INTERVAL, timeLeft);\n         tMan.register(new RankingWorker(), ServerConstants.RANKING_INTERVAL, timeLeft);\n         "}, {"sha": "f048f62ba6fdc64e7da0e25ec0b8e21c321260f1", "filename": "src/net/server/channel/handlers/CancelChairHandler.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/CancelChairHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/CancelChairHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CancelChairHandler.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -36,13 +36,17 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         if (id == -1) { // Cancel Chair\n             mc.setChair(0);\n-            mc.unregisterChairBuff();\n+            if(mc.unregisterChairBuff()) {\n+                c.getPlayer().getMap().broadcastMessage(c.getPlayer(), MaplePacketCreator.cancelForeignChairSkillEffect(mc.getId()), false);\n+            }\n             \n             c.announce(MaplePacketCreator.cancelChair(-1));\n             c.getPlayer().getMap().broadcastMessage(c.getPlayer(), MaplePacketCreator.showChair(c.getPlayer().getId(), 0), false);\n         } else { // Use In-Map Chair\n             mc.setChair(id);\n-            mc.registerChairBuff();\n+            if(mc.registerChairBuff()) {\n+                c.getPlayer().getMap().broadcastMessage(c.getPlayer(), MaplePacketCreator.giveForeignChairSkillEffect(mc.getId()), false);\n+            }\n             \n             c.announce(MaplePacketCreator.cancelChair(id));\n         }"}, {"sha": "983fa9ea81099c2c1be6d3ff656154a90057294c", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 21, "deletions": 14, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -28,6 +28,7 @@\n import client.inventory.Item;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n+import constants.ItemConstants;\n import java.sql.SQLException;\n import java.util.Calendar;\n import java.util.List;\n@@ -64,6 +65,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n             }\n+            \n+            if(ItemConstants.isCashStore(cItem.getItemId()) && chr.getLevel() < 16) {\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n+            \n             if (action == 0x03) { // Item\n                 Item item = cItem.toItem();\n                 cs.addToInventory(item);               \n@@ -176,20 +183,20 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n             }\n         } else if (action == 0x08) { // Increase Character Slots\n-                slea.skip(1); \n-                int cash = slea.readInt();\n-                CashItem cItem = CashItemFactory.getItem(slea.readInt());\n+            slea.skip(1); \n+            int cash = slea.readInt();\n+            CashItem cItem = CashItemFactory.getItem(slea.readInt());\n \n-                if (!canBuy(cItem, cs.getCash(cash))) {\n-                    c.announce(MaplePacketCreator.enableActions());\n-                    return;\n-                }\n+            if (!canBuy(cItem, cs.getCash(cash))) {\n+                c.announce(MaplePacketCreator.enableActions());\n+                return;\n+            }\n \n-                if (c.gainCharacterSlot()) {\n-                    c.announce(MaplePacketCreator.showBoughtCharacterSlot(c.getCharacterSlots()));\n-                    cs.gainCash(cash, -cItem.getPrice());\n-                    c.announce(MaplePacketCreator.showCash(chr));\n-                }\n+            if (c.gainCharacterSlot()) {\n+                c.announce(MaplePacketCreator.showBoughtCharacterSlot(c.getCharacterSlots()));\n+                cs.gainCash(cash, -cItem.getPrice());\n+                c.announce(MaplePacketCreator.showCash(chr));\n+            }\n         } else if (action == 0x0D) { // Take from Cash Inventory\n             Item item = cs.findByCashId(slea.readInt());\n             if (item == null) {\n@@ -281,8 +288,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             c.announce(MaplePacketCreator.showCash(c.getPlayer()));\n         } else if (action == 0x23) { //Friendship :3\n-\t\t\tslea.readInt(); //Birthday\n-          // if (checkBirthday(c, birthday)) {\n+            slea.readInt(); //Birthday\n+            // if (checkBirthday(c, birthday)) {\n                 int payment = slea.readByte();\n                 slea.skip(3); //0s\n                 int snID = slea.readInt();"}, {"sha": "347d684751ef72817738390935ee565d756f372a", "filename": "src/net/server/channel/handlers/NewYearCardHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/NewYearCardHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/NewYearCardHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NewYearCardHandler.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -106,7 +106,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         player.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(player, newyear, 0xD, 0));\n \n                         MapleCharacter sender = c.getWorldServer().getPlayerStorage().getCharacterById(newyear.getSenderId());\n-                        if(sender != null && sender.isLoggedin() && !sender.isAwayFromWorld()) {\n+                        if(sender != null && sender.isLoggedinWorld()) {\n                             sender.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(sender, newyear, 0xD, 0));\n                             sender.dropMessage(6, \"[NEW YEAR] Your addressee successfully received the New Year card.\");\n                         }"}, {"sha": "b3410e1502842c346639dfc31df6791515121e76", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -57,6 +57,7 @@\n import java.util.Collections;\n import java.util.Comparator;\n import java.util.Map;\n+import server.life.MobSkill;\n \n public final class PlayerLoggedinHandler extends AbstractMaplePacketHandler {\n \n@@ -129,7 +130,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             player.silentGiveBuffs(timedBuffs);\n         }\n         \n-        Map<MapleDisease, Long> diseases = server.getPlayerBuffStorage().getDiseasesFromStorage(cid);\n+        Map<MapleDisease, Pair<Long, MobSkill>> diseases = server.getPlayerBuffStorage().getDiseasesFromStorage(cid);\n         if (diseases != null) {\n             player.silentApplyDiseases(diseases);\n         }"}, {"sha": "8d94656a35e764c362f65e2cb2d95d68f2835f9a", "filename": "src/net/server/worker/CharacterDiseaseWorker.java", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/worker/CharacterDiseaseWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/worker/CharacterDiseaseWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/CharacterDiseaseWorker.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -0,0 +1,33 @@\n+/*\n+    This file is part of the HeavenMS (MapleSolaxiaV2) MapleStory Server\n+    Copyleft (L) 2017 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.worker;\n+\n+import net.server.Server;\n+\n+/**\n+ * @author Ronan\n+ * @info   Thread responsible for announcing other players diseases when one enters into a map\n+ */\n+public class CharacterDiseaseWorker implements Runnable {\n+    @Override\n+    public void run() {\n+        Server.getInstance().runAnnouncePlayerDiseasesSchedule();\n+    }\n+}"}, {"sha": "45ec3c6e541b7b8ea3f6ed9f2be246c76e3efc36", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -842,7 +842,7 @@ public void runPetSchedule() {\n         \n         for(Map.Entry<Integer, Byte> dp: deployedPets.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey() / 4);\n-            if(chr == null || !chr.isLoggedin() || chr.isAwayFromWorld()) continue;\n+            if(chr == null || !chr.isLoggedinWorld()) continue;\n             \n             Byte dpVal = (byte)(dp.getValue() + 1);\n             if(dpVal == ServerConstants.PET_EXHAUST_COUNT) {\n@@ -900,7 +900,7 @@ public void runMountSchedule() {\n         \n         for(Map.Entry<Integer, Byte> dp: deployedMounts.entrySet()) {\n             MapleCharacter chr = this.getPlayerStorage().getCharacterById(dp.getKey());\n-            if(chr == null || !chr.isLoggedin() || chr.isAwayFromWorld()) continue;\n+            if(chr == null || !chr.isLoggedinWorld()) continue;\n             \n             Byte dpVal = (byte)(dp.getValue() + 1);\n             if(dpVal == ServerConstants.MOUNT_EXHAUST_COUNT) {"}, {"sha": "1d28459d4b1ada7d713756aba00a55a6516142e5", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -921,7 +921,7 @@ public void dispatchUpdateQuestMobCount(int mobid, int mapid) {\n                 for (MapleCharacter evChr : eventMembers) {\n                     MapleCharacter chr = mapChars.get(evChr.getId());\n \n-                    if(chr != null && chr.isLoggedin() && !chr.isAwayFromWorld()) {\n+                    if(chr != null && chr.isLoggedinWorld()) {\n                         chr.updateQuestMobCount(mobid);\n                     }\n                 }"}, {"sha": "12486dc8058715b499434ac864e0db5302b04e7c", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 77, "deletions": 35, "changes": 112, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -91,8 +91,8 @@\n     protected Map<Integer, MapleStatEffect> itemEffects = new HashMap<>();\n     protected Map<Integer, Map<String, Integer>> equipStatsCache = new HashMap<>();\n     protected Map<Integer, Equip> equipCache = new HashMap<>();\n-    protected Map<Integer, Double> priceCache = new HashMap<>();\n     protected Map<Integer, Integer> wholePriceCache = new HashMap<>();\n+    protected Map<Integer, Double> unitPriceCache = new HashMap<>();\n     protected Map<Integer, Integer> projectileWatkCache = new HashMap<>();\n     protected Map<Integer, String> nameCache = new HashMap<>();\n     protected Map<Integer, String> descCache = new HashMap<>();\n@@ -421,54 +421,96 @@ public int getMeso(int itemId) {\n         return pEntry;\n     }\n \n-    public int getWholePrice(int itemId) {\n-        if (wholePriceCache.containsKey(itemId)) {\n-            return wholePriceCache.get(itemId);\n-        }\n+    private Pair<Integer, Double> getItemPriceData(int itemId) {\n         MapleData item = getItemData(itemId);\n         if (item == null) {\n-            return -1;\n+            wholePriceCache.put(itemId, -1);\n+            unitPriceCache.put(itemId, 0.0);\n+            return new Pair<>(-1, 0.0);\n         }\n-        int pEntry;\n+        \n+        int pEntry = -1;\n         MapleData pData = item.getChildByPath(\"info/price\");\n-        if (pData == null) {\n-            return -1;\n+        if (pData != null) {\n+            pEntry = MapleDataTool.getInt(pData);\n         }\n-        pEntry = MapleDataTool.getInt(pData);\n+        \n+        double fEntry = 0.0f;\n+        pData = item.getChildByPath(\"info/unitPrice\");\n+        if (pData != null) {\n+            try {\n+                fEntry = MapleDataTool.getDouble(pData);\n+            } catch (Exception e) {\n+                fEntry = (double) MapleDataTool.getInt(pData);\n+            }\n+        }\n+        \n         wholePriceCache.put(itemId, pEntry);\n-        return pEntry;\n+        unitPriceCache.put(itemId, fEntry);\n+        return new Pair<>(pEntry, fEntry);\n     }\n-\n-    public double getPrice(int itemId) {\n-        if (priceCache.containsKey(itemId)) {\n-            return priceCache.get(itemId);\n+    \n+    public int getWholePrice(int itemId) {\n+        if (wholePriceCache.containsKey(itemId)) {\n+            return wholePriceCache.get(itemId);\n         }\n-        MapleData item = getItemData(itemId);\n-        if (item == null) {\n+        \n+        return getItemPriceData(itemId).getLeft();\n+    }\n+    \n+    public double getUnitPrice(int itemId) {\n+        if (unitPriceCache.containsKey(itemId)) {\n+            return unitPriceCache.get(itemId);\n+        }\n+        \n+        return getItemPriceData(itemId).getRight();\n+    }\n+\n+    public int getPrice(int itemId, int quantity) {\n+        int retPrice = getWholePrice(itemId);\n+        if(retPrice == -1) {\n             return -1;\n         }\n-        double pEntry;\n-        MapleData pData = item.getChildByPath(\"info/unitPrice\");\n-        if (pData != null) {\n-            try {\n-                pEntry = MapleDataTool.getDouble(pData);\n-            } catch (Exception e) {\n-                pEntry = (double) MapleDataTool.getInt(pData);\n-            }\n+        \n+        if(!ItemConstants.isRechargable(itemId)) {\n+            retPrice *= quantity;\n         } else {\n-            pData = item.getChildByPath(\"info/price\");\n-            if (pData == null) {\n-                return -1;\n+            retPrice += Math.ceil(quantity * getUnitPrice(itemId));\n+        }\n+        \n+        return retPrice;\n+    }\n+    \n+    public static boolean canSell(Item item, short quantity) {\n+        if (item == null) { //Basic check\n+            return false;\n+        }\n+        \n+        short iQuant = item.getQuantity();\n+        if (iQuant == 0xFFFF) {\n+            iQuant = 1;\n+        } else if(iQuant < 0) {\n+            return false;\n+        }\n+        \n+        if (!ItemConstants.isRechargable(item.getItemId())) {\n+            if (iQuant == 0 || quantity > iQuant) {\n+                return false;\n             }\n-            try {\n-                pEntry = (double) MapleDataTool.getInt(pData);\n-            } catch(Exception e) {\n-                priceCache.put(itemId, 0.0);\n-                return 0;\n+        }\n+        \n+        return true;\n+    }\n+    \n+    public static short getSellingQuantity(Item item, short quantity) {\n+        if (ItemConstants.isRechargable(item.getItemId())) {\n+            quantity = item.getQuantity();\n+            if (quantity == 0xFFFF) {\n+                quantity = 1;\n             }\n         }\n-        priceCache.put(itemId, pEntry);\n-        return pEntry;\n+        \n+        return quantity;\n     }\n     \n     protected String getEquipmentSlot(int itemId) {"}, {"sha": "a6b9e32017edd8c09d8e90cb3824d06ce67c912b", "filename": "src/server/MapleShop.java", "status": "modified", "additions": 46, "deletions": 59, "changes": 105, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/MapleShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/MapleShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleShop.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -88,7 +88,7 @@ public void buy(MapleClient c, short slot, int itemId, short quantity) {\n             return;\n         }\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        if (item != null && item.getPrice() > 0) {\n+        if (item.getPrice() > 0) {\n             if (c.getPlayer().getMeso() >= (long) item.getPrice() * quantity) {\n                 if (MapleInventoryManipulator.checkSpace(c, itemId, quantity, \"\")) {\n                     if (!ItemConstants.isRechargable(itemId)) { //Pets can't be bought from shops\n@@ -107,77 +107,64 @@ public void buy(MapleClient c, short slot, int itemId, short quantity) {\n             } else\n                 c.announce(MaplePacketCreator.shopTransaction((byte) 2));\n \n-        } else if (item != null && item.getPitch() > 0) {\n-                if (c.getPlayer().getInventory(MapleInventoryType.ETC).countById(4310000) >= (long) item.getPitch() * quantity) {\n-                    if (MapleInventoryManipulator.checkSpace(c, itemId, quantity, \"\")) {\n-                        if (!ItemConstants.isRechargable(itemId)) {\n-                            MapleInventoryManipulator.addById(c, itemId, quantity);\n-                            MapleInventoryManipulator.removeById(c, MapleInventoryType.ETC, 4310000, item.getPitch() * quantity, false, false);\n-                        } else {\n-                            short slotMax = ii.getSlotMax(c, item.getItemId());\n-                            quantity = slotMax;\n-                            MapleInventoryManipulator.addById(c, itemId, quantity);\n-                            MapleInventoryManipulator.removeById(c, MapleInventoryType.ETC, 4310000, item.getPitch() * quantity, false, false);\n-                        }\n-                        c.announce(MaplePacketCreator.shopTransaction((byte) 0));\n-                    } else\n-                        c.announce(MaplePacketCreator.shopTransaction((byte) 3));\n-                }\n-\n-            } else if (c.getPlayer().getInventory(MapleInventoryType.CASH).countById(token) != 0) {\n-                int amount = c.getPlayer().getInventory(MapleInventoryType.CASH).countById(token);\n-                int value = amount * tokenvalue;\n-                int cost = item.getPrice() * quantity;\n-                if (c.getPlayer().getMeso() + value >= cost) {\n-                    int cardreduce = value - cost;\n-                    int diff = cardreduce + c.getPlayer().getMeso();\n-                    if (MapleInventoryManipulator.checkSpace(c, itemId, quantity, \"\")) {\n-                        if (ItemConstants.isPet(itemId)) {\n-                            int petid = MaplePet.createPet(itemId);\n-                            MapleInventoryManipulator.addById(c, itemId, quantity, null, petid, -1);\n-                        } else {\n-                            MapleInventoryManipulator.addById(c, itemId, quantity);\n-                        }\n-                        c.getPlayer().gainMeso(diff, false);\n+        } else if (item.getPitch() > 0) {\n+            if (c.getPlayer().getInventory(MapleInventoryType.ETC).countById(4310000) >= (long) item.getPitch() * quantity) {\n+                if (MapleInventoryManipulator.checkSpace(c, itemId, quantity, \"\")) {\n+                    if (!ItemConstants.isRechargable(itemId)) {\n+                        MapleInventoryManipulator.addById(c, itemId, quantity);\n+                        MapleInventoryManipulator.removeById(c, MapleInventoryType.ETC, 4310000, item.getPitch() * quantity, false, false);\n                     } else {\n-                        c.announce(MaplePacketCreator.shopTransaction((byte) 3));\n+                        short slotMax = ii.getSlotMax(c, item.getItemId());\n+                        quantity = slotMax;\n+                        MapleInventoryManipulator.addById(c, itemId, quantity);\n+                        MapleInventoryManipulator.removeById(c, MapleInventoryType.ETC, 4310000, item.getPitch() * quantity, false, false);\n                     }\n                     c.announce(MaplePacketCreator.shopTransaction((byte) 0));\n                 } else\n-                    c.announce(MaplePacketCreator.shopTransaction((byte) 2));\n+                    c.announce(MaplePacketCreator.shopTransaction((byte) 3));\n             }\n+\n+        } else if (c.getPlayer().getInventory(MapleInventoryType.CASH).countById(token) != 0) {\n+            int amount = c.getPlayer().getInventory(MapleInventoryType.CASH).countById(token);\n+            int value = amount * tokenvalue;\n+            int cost = item.getPrice() * quantity;\n+            if (c.getPlayer().getMeso() + value >= cost) {\n+                int cardreduce = value - cost;\n+                int diff = cardreduce + c.getPlayer().getMeso();\n+                if (MapleInventoryManipulator.checkSpace(c, itemId, quantity, \"\")) {\n+                    if (ItemConstants.isPet(itemId)) {\n+                        int petid = MaplePet.createPet(itemId);\n+                        MapleInventoryManipulator.addById(c, itemId, quantity, null, petid, -1);\n+                    } else {\n+                        MapleInventoryManipulator.addById(c, itemId, quantity);\n+                    }\n+                    c.getPlayer().gainMeso(diff, false);\n+                } else {\n+                    c.announce(MaplePacketCreator.shopTransaction((byte) 3));\n+                }\n+                c.announce(MaplePacketCreator.shopTransaction((byte) 0));\n+            } else {\n+                c.announce(MaplePacketCreator.shopTransaction((byte) 2));\n+            }\n+        }\n     }\n \n \n     public void sell(MapleClient c, MapleInventoryType type, short slot, short quantity) {\n         if (quantity == 0xFFFF || quantity == 0) {\n             quantity = 1;\n-        }\n-        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        Item item = c.getPlayer().getInventory(type).getItem((short) slot);\n-        if (item == null){ //Basic check\n-        \treturn;\n-        }\n-        if (ItemConstants.isRechargable(item.getItemId())) {\n-            quantity = item.getQuantity();\n-        }\n-        if (quantity < 0) {\n+        } else if (quantity < 0) {\n             return;\n         }\n-        short iQuant = item.getQuantity();\n-        if (iQuant == 0xFFFF) {\n-            iQuant = 1;\n-        }\n-        if (quantity <= iQuant && iQuant > 0) {\n+        \n+        Item item = c.getPlayer().getInventory(type).getItem((short) slot);\n+        if(MapleItemInformationProvider.canSell(item, quantity)) {\n+            quantity = MapleItemInformationProvider.getSellingQuantity(item, quantity);\n             MapleInventoryManipulator.removeFromSlot(c, type, (byte) slot, quantity, false);\n-            double price;\n-            if (ItemConstants.isRechargable(item.getItemId())) {\n-            \tprice = ii.getWholePrice(item.getItemId()) / (double) ii.getSlotMax(c, item.getItemId());\n-            } else {\n-                price = ii.getPrice(item.getItemId());\n-            }\n-            int recvMesos = (int) Math.max(Math.ceil(price * quantity), 0);\n-            if (price != -1 && recvMesos > 0) {\n+            \n+            MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+            int recvMesos = ii.getPrice(item.getItemId(), quantity);\n+            if (recvMesos > 0) {\n                 c.getPlayer().gainMeso(recvMesos, false);\n             }\n             c.announce(MaplePacketCreator.shopTransaction((byte) 0x8));\n@@ -195,7 +182,7 @@ public void recharge(MapleClient c, short slot) {\n             return;\n         }\n         if (item.getQuantity() < slotMax) {\n-            int price = (int) Math.round(ii.getPrice(item.getItemId()) * (slotMax - item.getQuantity()));\n+            int price = (int) Math.ceil(ii.getUnitPrice(item.getItemId()) * (slotMax - item.getQuantity()));\n             if (c.getPlayer().getMeso() >= price) {\n                 item.setQuantity(slotMax);\n                 c.getPlayer().forceUpdateItem(item);"}, {"sha": "0c34b588b06a9b137e3f6c82489da0c87100bd4d", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -552,7 +552,7 @@ private void dispatchUpdateQuestMobCount() {\n                 for (Integer chrid : attackerChrids) {\n                     MapleCharacter chr = mapChars.get(chrid);\n \n-                    if(chr != null && chr.isLoggedin() && !chr.isAwayFromWorld()) {\n+                    if(chr != null && chr.isLoggedinWorld()) {\n                         chr.updateQuestMobCount(mobid);\n                     }\n                 }"}, {"sha": "da43730786a8dfc06d3f2f9f2c24850132c81b00", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -238,7 +238,7 @@ private void announceItemSold(Item item, int mesos) {\n         String qtyStr = (item.getQuantity() > 1) ? \" (qty. \" + item.getQuantity() + \")\" : \"\";\n         \n         MapleCharacter player = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterById(ownerId);\n-        if(player != null && player.isLoggedin() && !player.isAwayFromWorld()) {\n+        if(player != null && player.isLoggedinWorld()) {\n             player.dropMessage(6, \"[HIRED MERCHANT] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n         }\n     }"}, {"sha": "2f578adf35693167f90cc65cc620f8bece47a983", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -2322,6 +2322,11 @@ public void run() {\n         }\n         \n         chr.receivePartyMemberHP();\n+        announcePlayerDiseases(chr.getClient());\n+    }\n+    \n+    private static void announcePlayerDiseases(final MapleClient c) {\n+        Server.getInstance().registerAnnouncePlayerDiseases(c);\n     }\n \n     public MaplePortal getRandomPlayerSpawnpoint() {"}, {"sha": "16b3bdebd14bb004fb7a6542f16fdca5e53082ac", "filename": "src/server/maps/MapleMiniDungeonInfo.java", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleMiniDungeonInfo.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/server/maps/MapleMiniDungeonInfo.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMiniDungeonInfo.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -1,5 +1,3 @@\n-package server.maps;\n-\n /*\n \tThis file is part of the OdinMS Maple Story Server\n     Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n@@ -21,7 +19,7 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n  */\n-\n+package server.maps;\n \n /**\n  *"}, {"sha": "af9ede9375b12430f3650888168d767d63225276", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 92, "deletions": 21, "changes": 113, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -2256,10 +2256,11 @@ private static void addAttackBody(LittleEndianWriter lew, MapleCharacter chr, in\n                 }\n         }\n \n+        // someone thought it was a good idea to handle floating point representation through packets ROFL\n         private static int doubleToShortBits(double d) {\n                 return (int) (Double.doubleToLongBits(d) >> 48);\n         }\n-\n+        \n         public static byte[] getNPCShop(MapleClient c, int sid, List<MapleShopItem> items) {\n                 MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n@@ -2278,7 +2279,7 @@ private static int doubleToShortBits(double d) {\n                         } else {\n                                 mplew.writeShort(0);\n                                 mplew.writeInt(0);\n-                                mplew.writeShort(doubleToShortBits(ii.getPrice(item.getItemId())));\n+                                mplew.writeShort(doubleToShortBits(ii.getUnitPrice(item.getItemId())));\n                                 mplew.writeShort(ii.getSlotMax(c, item.getItemId()));\n                         }\n                 }\n@@ -2440,26 +2441,31 @@ private static int doubleToShortBits(double d) {\n                 mplew.writeInt(cid);\n                 mplew.write(skill);\n                 mplew.writeInt(damage);\n-                mplew.writeInt(monsteridfrom);\n-                mplew.write(direction);\n-                if (pgmr) {\n-                        mplew.write(pgmr_1);\n-                        mplew.write(is_pg ? 1 : 0);\n-                        mplew.writeInt(oid);\n-                        mplew.write(6);\n-                        mplew.writeShort(pos_x);\n-                        mplew.writeShort(pos_y);\n-                        mplew.write(0);\n+                if(skill != -4) {\n+                        mplew.writeInt(monsteridfrom);\n+                        mplew.write(direction);\n+                        if (pgmr) {\n+                                mplew.write(pgmr_1);\n+                                mplew.write(is_pg ? 1 : 0);\n+                                mplew.writeInt(oid);\n+                                mplew.write(6);\n+                                mplew.writeShort(pos_x);\n+                                mplew.writeShort(pos_y);\n+                                mplew.write(0);\n+                        } else {\n+                                mplew.writeShort(0);\n+                        }\n+                        mplew.writeInt(damage);\n+                        if (fake > 0) {\n+                                mplew.writeInt(fake);\n+                        }\n                 } else {\n-                        mplew.writeShort(0);\n-                }\n-                mplew.writeInt(damage);\n-                if (fake > 0) {\n-                        mplew.writeInt(fake);\n+                        mplew.writeInt(damage);\n                 }\n+                \n                 return mplew.getPacket();\n         }\n-\n+        \n         public static byte[] charNameResponse(String charname, boolean nameUsed) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.CHAR_NAME_RESPONSE.getValue());\n@@ -2760,7 +2766,7 @@ private static void writeLongMaskD(final MaplePacketLittleEndianWriter mplew, Li\n                 mplew.writeLong(firstmask);\n                 mplew.writeLong(secondmask);\n         }\n-\n+        \n         public static byte[] giveDebuff(List<Pair<MapleDisease, Integer>> statups, MobSkill skill) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.GIVE_BUFF.getValue());\n@@ -2776,8 +2782,10 @@ private static void writeLongMaskD(final MaplePacketLittleEndianWriter mplew, Li\n                 mplew.write(1);\n                 return mplew.getPacket();\n         }\n-\n+        \n         public static byte[] giveForeignDebuff(int cid, List<Pair<MapleDisease, Integer>> statups, MobSkill skill) {\n+                // Poison damage visibility and missing diseases status visibility, extended through map transitions thanks to Ronan\n+                \n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.GIVE_FOREIGN_BUFF.getValue());\n                 mplew.writeInt(cid);\n@@ -2867,6 +2875,69 @@ private static void writeLongMaskFromList(final MaplePacketLittleEndianWriter mp\n                 return mplew.getPacket();\n         }\n \n+        private static void writeLongMaskSlowD(final MaplePacketLittleEndianWriter mplew) {\n+                mplew.writeInt(0);\n+                mplew.writeInt(2048);\n+                mplew.writeLong(0);\n+        }\n+        \n+        public static byte[] giveForeignSlowDebuff(int cid, List<Pair<MapleDisease, Integer>> statups, MobSkill skill) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.GIVE_FOREIGN_BUFF.getValue());\n+                mplew.writeInt(cid);\n+                writeLongMaskSlowD(mplew);\n+                for (Pair<MapleDisease, Integer> statup : statups) {\n+                        if(statup.getLeft() == MapleDisease.POISON) mplew.writeShort(statup.getRight().shortValue());\n+                        mplew.writeShort(skill.getSkillId());\n+                        mplew.writeShort(skill.getSkillLevel());\n+                }\n+                mplew.writeShort(0); // same as give_buff\n+                mplew.writeShort(900);//Delay\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] cancelForeignSlowDebuff(int cid) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.CANCEL_FOREIGN_BUFF.getValue());\n+                mplew.writeInt(cid);\n+                writeLongMaskSlowD(mplew);\n+                return mplew.getPacket();\n+        }\n+        \n+        private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew) {\n+                mplew.writeInt(0);\n+                mplew.writeInt(262144);\n+                mplew.writeLong(0);\n+        }\n+        \n+        public static byte[] giveForeignChairSkillEffect(int cid) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.GIVE_FOREIGN_BUFF.getValue());\n+                mplew.writeInt(cid);\n+                writeLongMaskChair(mplew);\n+                \n+                mplew.writeShort(0);\n+                mplew.writeShort(0);\n+                mplew.writeShort(100);\n+                mplew.writeShort(1);\n+                \n+                mplew.writeShort(0);\n+                mplew.writeShort(900);\n+                \n+                for(int i = 0; i < 7; i++) mplew.write(0);\n+                \n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] cancelForeignChairSkillEffect(int cid) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(19);\n+                mplew.writeShort(SendOpcode.CANCEL_FOREIGN_BUFF.getValue());\n+                mplew.writeInt(cid);\n+                writeLongMaskChair(mplew);\n+                \n+                return mplew.getPacket();\n+        }\n+        \n         public static byte[] getPlayerShopChat(MapleCharacter c, String chat, boolean owner) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.PLAYER_INTERACTION.getValue());\n@@ -6114,7 +6185,7 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 mplew.write(amount);\n                 return mplew.getPacket();\n         }\n-\n+        \n         public static byte[] showWheelsLeft(int left) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());"}, {"sha": "560bf50cf98246cc575909af6390fdf1f926ff89", "filename": "src/tools/data/output/GenericLittleEndianWriter.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/tools/data/output/GenericLittleEndianWriter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/src/tools/data/output/GenericLittleEndianWriter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/data/output/GenericLittleEndianWriter.java?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -98,7 +98,7 @@ public void writeShort(int i) {\n         bos.writeByte((byte) (i & 0xFF));\n         bos.writeByte((byte) ((i >>> 8) & 0xFF));\n     }\n-\n+    \n     /**\n      * Writes an integer to the stream.\n      *"}, {"sha": "891e84ca6684fa8d71abb2575bcf10b82fcbc966", "filename": "wz/Mob.wz/9420544.img.xml", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/wz/Mob.wz/9420544.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/wz/Mob.wz/9420544.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9420544.img.xml?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -44,6 +44,12 @@\n         <int name=\"level\" value=\"148\"/>\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n+      <imgdir name=\"3\">\n+        <int name=\"skill\" value=\"132\"/>\n+        <int name=\"action\" value=\"2\"/>\n+        <int name=\"level\" value=\"6\"/>\n+        <int name=\"effectAfter\" value=\"0\"/>\n+      </imgdir>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"stand\">\n@@ -1819,7 +1825,7 @@\n       <int name=\"attackAfter\" value=\"480\"/>\n       <int name=\"PADamage\" value=\"600\"/>\n       <int name=\"disease\" value=\"132\"/>\n-      <int name=\"level\" value=\"2\"/>\n+      <int name=\"level\" value=\"6\"/>\n     </imgdir>\n     <canvas name=\"0\" width=\"111\" height=\"144\">\n       <vector name=\"origin\" x=\"45\" y=\"144\"/>"}, {"sha": "23abbc715895db5ec42fef78ea015cc8804e849a", "filename": "wz/Skill.wz/MobSkill.img.xml", "status": "modified", "additions": 16, "deletions": 89, "changes": 105, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/wz/Skill.wz/MobSkill.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/727dfb2d62f12a5a2ceac90d52c1815ab1b9db63/wz/Skill.wz/MobSkill.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/MobSkill.img.xml?ref=727dfb2d62f12a5a2ceac90d52c1815ab1b9db63", "patch": "@@ -11149,56 +11149,27 @@\n         <int name=\"time\" value=\"12\"/>\n         <int name=\"prop\" value=\"100\"/>\n         <imgdir name=\"affected\">\n-          <int name=\"pos\" value=\"0\"/>\n-          <canvas name=\"0\" width=\"81\" height=\"64\">\n-            <vector name=\"origin\" x=\"42\" y=\"146\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"1\" width=\"100\" height=\"109\">\n-            <vector name=\"origin\" x=\"49\" y=\"96\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"2\" width=\"114\" height=\"100\">\n-            <vector name=\"origin\" x=\"57\" y=\"88\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"3\" width=\"129\" height=\"104\">\n-            <vector name=\"origin\" x=\"65\" y=\"88\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"4\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"5\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n+          <int name=\"pos\" value=\"1\"/>\n+          <int name=\"repeat\" value=\"1\"/>\n+          <canvas name=\"0\" width=\"29\" height=\"31\">\n+            <vector name=\"origin\" x=\"15\" y=\"36\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"11190\"/>\n           </canvas>\n-          <canvas name=\"6\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n+          <canvas name=\"1\" width=\"29\" height=\"37\">\n+            <vector name=\"origin\" x=\"15\" y=\"41\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n           </canvas>\n-          <canvas name=\"7\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n+          <canvas name=\"2\" width=\"29\" height=\"46\">\n+            <vector name=\"origin\" x=\"15\" y=\"45\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n           </canvas>\n-          <canvas name=\"8\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n+          <canvas name=\"3\" width=\"29\" height=\"38\">\n+            <vector name=\"origin\" x=\"15\" y=\"41\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n           </canvas>\n-          <canvas name=\"9\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n+          <canvas name=\"4\" width=\"29\" height=\"33\">\n+            <vector name=\"origin\" x=\"15\" y=\"38\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n           </canvas>\n         </imgdir>\n       </imgdir>\n@@ -11208,57 +11179,13 @@\n         <int name=\"time\" value=\"12\"/>\n         <int name=\"prop\" value=\"100\"/>\n         <imgdir name=\"affected\">\n-          <int name=\"pos\" value=\"0\"/>\n-          <canvas name=\"0\" width=\"81\" height=\"64\">\n-            <vector name=\"origin\" x=\"42\" y=\"146\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"1\" width=\"100\" height=\"109\">\n-            <vector name=\"origin\" x=\"49\" y=\"96\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"2\" width=\"114\" height=\"100\">\n-            <vector name=\"origin\" x=\"57\" y=\"88\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"3\" width=\"129\" height=\"104\">\n-            <vector name=\"origin\" x=\"65\" y=\"88\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"4\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"5\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"11190\"/>\n-          </canvas>\n-          <canvas name=\"6\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"7\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"8\" width=\"81\" height=\"54\">\n+          <canvas name=\"0\" width=\"81\" height=\"54\">\n             <vector name=\"origin\" x=\"42\" y=\"85\"/>\n             <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n-          </canvas>\n-          <canvas name=\"9\" width=\"81\" height=\"54\">\n-            <vector name=\"origin\" x=\"42\" y=\"85\"/>\n-            <int name=\"z\" value=\"0\"/>\n-            <int name=\"delay\" value=\"90\"/>\n+            <int name=\"delay\" value=\"77777\"/>\n           </canvas>\n+          <int name=\"repeat\" value=\"0\"/>\n+          <int name=\"pos\" value=\"0\"/>\n         </imgdir>\n       </imgdir>\n       <imgdir name=\"7\">"}]}]},
