{"fetchDate": "2019-12-19", "content": [{"sha": "83266508af2bce7ed466b1cac860b41b5cb32f0c", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ODMyNjY1MDhhZjJiY2U3ZWQ0NjZiMWNhYzg2MGI0MWI1Y2IzMmYwYw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-03-26T19:28:41Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-03-26T19:28:41Z"}, "message": "CPQ tidyup patch + Guild Creation matcher + Solution to Login Accid=0\n\nAdjusted AP gains, to get it to work following the AP Reset check method.\nFixed usage of inexistent itemids on CPQ and fishing.\nFixed one-of-a-kind items being lost in player trades due to missing inventory checks.\nImplemented matching system for the guild creation phase. All players intending to join the new guild must be on the Guild Headquartes and accept the creation of the guild.\nFixed changing jobs not properly updating info on the party tab.\nFixed double tooltip information on CPQ actions UI.\nFixed CPQ not disbanding after a player leaves the party/instance.\nFixed checks for \"in-progress\" CPQ instances.\nFixed changing maps on CPQ not leading players back to the starting battlefield.\nReviewed login system, now preventing non-local IP connecting on local server and local IP on non-local server.\nReviewed login system, now cherrypicking sessions in transition state when trying to disconnect them due to a failed login (avoiding possible mishaps due to duplicate sessions of a same account).\nAdjusted PiratePQ stage 2, now mobs respawn rather than making party leader request for new waves.\nAdjusted Prime Minister, its spawn is no longer related to starting the quest. It should also allow party fights.\nFixed \"forcevac\" command not properly applying, rather sending to inventory, \"consume-on-pickup\" items.\nFixed (probably) accId = 0 issue on login, that was occurring due to client accountid's being set to 0 a while before being checked once again on finishLogin().\nFixed an issue with extended time on CPQ not properly showing the end-match's visual effect.", "tree": {"sha": "4cae51a253efbacde4d82befc3278ad655b418f0", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/4cae51a253efbacde4d82befc3278ad655b418f0"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/83266508af2bce7ed466b1cac860b41b5cb32f0c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/83266508af2bce7ed466b1cac860b41b5cb32f0c", "html_url": "https://github.com/ronancpl/HeavenMS/commit/83266508af2bce7ed466b1cac860b41b5cb32f0c", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/83266508af2bce7ed466b1cac860b41b5cb32f0c/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "html_url": "https://github.com/ronancpl/HeavenMS/commit/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5"}], "stats": {"total": 4402, "additions": 2981, "deletions": 1421}, "files": [{"sha": "4e5d65232896bf37d183e3a96f0f50ff860a1788", "filename": "README.md", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -83,6 +83,8 @@ If you liked this project, please don't forget to __star__ the repo ;) .\n \n It's never enough to tell this, thanks to everyone that have been contributing something for the continuous improvement of the server! Be it through bug reports, donation, code snippets and/or pull requests.\n \n+Note for anyone up to contribute further pull requests: make awareness to use __english language__ in codes and messages, as usage of any other languages will render it open to faculty of whether this content will be ready to be accepted or *further changes are going to be requested* before it becomes apt to merge.\n+\n Our Discord channel is still available on: https://discord.gg/Q7wKxHX\n \n <hr id=\"donate\" />\n@@ -166,11 +168,11 @@ Now open NetBeans, and click \"Open a project...\" . Select then the \"HeavenMS\" fo\n \n Inside the project, you may encounter some code errors.\n \n-These errors pops-up because you have not set yet the \"cores\" of the project. From the project hierarchy, right-click the project and select \"Resolve Project Problems\".\n+Firstly, a **new Java7 platform** must be defined to run the server. Click \"Manage Platforms...\", then \"Add platform\", browse through \"C:\\Program Files\\Java\" for the JDK 1.7 folder. Then, name this new platform \"JDK 1.7\".\n \n-Locate the \"cores\" folder inside the root directory of this project and manually configure the missing files with the files that are there.\n+In case errors still show up, these errors probably occurs because you have yet to set the core JARs of the project. From the project hierarchy, right-click the project and select \"Resolve Project Problems\".\n \n-Also, a new Java7 platform must be defined to run the server. Click \"Manage Platforms...\", then \"Add platform\", browse through until you locate the Java7 folder in the file system, it should be at \"C:\\Program Files\\Java\". Then, name this new platform \"JDK 1.7\".\n+Locate the folder \"cores\" inside the root directory of this project and manually configure the missing files on NetBeans (mina-core, slf4j-api, ...).\n \n Finally, select \"Clean and Build project\" to build the JAR file for the MapleStory server. Once done, make sure both WampServer and Hamachi are on and functional, then execute \"launch.bat\" on the root of the project. If no errors were raised from this action, your MapleStory server is now online.\n \n@@ -190,7 +192,7 @@ The client's set-up is quite straightforward:\n \n #### Editing localhost IP target\n \n-If you are not using \"localhost\" as the target IP on the server's config file, you will need to HEX-EDIT \"localhost.exe\" to fetch your IP. Track down all IP locations by searching for \"Text String\" \"127.0.0.1\", and applying the changes wherever it fits.\n+If you are not using \"localhost\" as the target IP on the server's config file, you will need to HEX-EDIT \"localhost.exe\" to fetch your IP. Track down all IP locations by searching for \"Type: String\" \"127.0.0.1\", and applying the changes wherever it fits.\n \n To hex-edit, install the Neo Hex Editor from \"free-hex-editor-neo.exe\" and follow their instructions. Once done, open \"localhost.exe\" for editing and overwrite the IP values under the 3 addresses. Save the changes and exit the editor.\n "}, {"sha": "2cc23a47a89d7f73558c82f0a3a870fb616edc84", "filename": "docs/issues.txt", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -50,7 +50,6 @@ Missing features list:\n ** Packet issues & advanced PQs **\n - Mystic Doors (won't deploy players properly is some situations, only destination map matches).\n - Ariant Party Quest\n-- Monster Carnival 1/2 Party Quest\n - Nett's Pyramid Party Quest\n ---------------------------\n "}, {"sha": "27f2e8ae54ca8cc1ae590cb645346e7b5b0c2c5b", "filename": "docs/leftover.txt", "status": "added", "additions": 86, "deletions": 0, "changes": 86, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/leftover.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/leftover.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/leftover.txt?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,86 @@\n+// Missing contents in HeavenMS (as of commit 311), compiled here thanks to ---\n+\n+Uncoded features:\n+Name Change\n+World transfer\n+MTS (v53)\n+Family system (v67)\n+Family and Medal Quests(?)\n+\n+Uncoded Party Quests:\n+Gold Richie (v77)\n+Olivia PQ (v77)\n+Ariant PQ (v??)\n+Nett's Pyramid PQ (v??)\n+Sheep vs Wolf (v??)\n+Abandoned PQ (v??)\n+\n+Uncoded pre-v83 events:\n+Independence Day Event (v25)\n+April Fools Dress Up (v53)\n+Find Master M (v72)\n+Gaga the Talent Show Star Event (v76, a \"fishing\" event)\n+\n+I'm not positive what these are but I'm guessing they're \"give away\" events:\n+Spirit Week (v76)\n+A November to Remember (v79)\n+\n+Uncoded Repeating pre-v83 events:\n+Easter\n+Lunar New Year\n+Christmas\n+Anniversary\n+Halloween (v10-v77)\n+Valentines Day (v17-v81)\n+Mardi Gras (v82)\n+Gold Richie (v77)\n+Turkey Event\n+\n+Post-v83 codable:\n+Neo City update (v84)\n+Evan release events (v84) (arguably no point without Evan)\n+General Mau (v84)\n+Five Year Reunion Event (v85)\n+Weather Effects Event (v85)\n+OSSS Quests (v89) (arguably not worth doing since it won't be complete without Visitor PQ)\n+Ghost Ship (v90)\n+Ulu City (v90) (New World Map)\n+Aramia's Book Drive (v90)\n+Ancient Artifact Hunt (v98)\n+Gate to the Future (v99) (New World Map)\n+Kenta PQ (v101)\n+\n+Post-v83 uncodable:\n+Evan (v84)(some of Evan can be hacked in but it still won't fully function)\n+Dragon Rider PQ (v85)\n+Monster Portraits event (or can it?)\n+Golden Temple (v86) (Not sure if Ravana can be backported, if so then codable)\n+Chaos Zakum/Horntail (v88)\n+Dual Blade (v88)\n+Potential (v88)\n+Ice Gorge PQ (v90)\n+Visitor PQ (v90)\n+Resistance (v94/95)\n+Ultimate Explorer (v96)\n+Lion's King Castle (v96) (due to von Leon being uncodable)\n+Chryse (v96)\n+Dual Raid: Balloon Hunt (v97)\n+PVP (v99/100)\n+Ice Knight PQ (v99)\n+Monster Park (v101) (Not actually sure if this one is uncodable, seems somewhat basic)\n+Familiars (v102)\n+\n+Non-GMS but English:\n+La Tomatina Event (EMS) (Giant Tomato boss)\n+Oktoberfest (EMS)\n+Shanghai (MSEA) (New World Map)\n+Thailand (MSEA) (New World Map)\n+Neo Tokyo (MSEA) (New World Map) (different from Neo City)\n+\n+Non-GMS no English:\n+Coke Town (J/KMS)\n+Ninja Castle (now in GMS, unsure how it compares to the \"classic\" version)\n+Ximending (TMS) (New World Map)\n+Taipei 101 (TMS) (New World Map) (Kerning Square Mall, v83, is the non TMS variant)\n+Night Market (TMS) (Now in GMS, unsure how it compares to the \"classic\" version)\n+Shaolin Temple (C/JMS) (Now in GMS, unsure how it compares to the \"classic\" version)\n\\ No newline at end of file"}, {"sha": "aa13d1a7966a21303f51fccf970e2677b7b929c3", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1713,6 +1713,18 @@ Implementado mec\u00e2nica de pescaria no c\u00f3digo-fonte.\n Corrigido membros de party n\u00e3o recebendo bonus devidamente ap\u00f3s membros sairem do mapa/party em alguns casos.\n Revisado sistema de experi\u00eancia em party. Ganhos de bonus agora levam em conta valores-base que membros de party ganham ao derrotar um mob para definir o ganho geral da equipe. Contabiliza\u00e7\u00e3o de ganhos remodelado, buscando por um modo de distribui\u00e7\u00e3o mais coerente.\n \n+10 Mar\u00e7o 2019,\n+Ajustado ganho de APs ao mudar de classe, como esperado para o 2o avan\u00e7o em diante.\n+Corrigido itemids impr\u00f3prios presentes no sistema de fishing.\n+Corrigido itens one-of-a-kind sendo perdidos em transa\u00e7\u00f5es entre jogadores.\n+Ajustado resultado de falha de itens one-of-a-kind em transa\u00e7\u00f5es tamb\u00e9m aparecendo pro outro jogador (somente o jogador que gerou o problema tem esse popup mostrado).\n+Ajustado ganho de APs em Cygnus, agora n\u00e3o mais faltando AP's de acordo com a m\u00e9trica definida no AP Reset.\n+\n+11 Mar\u00e7o 2019,\n+Implementado sistema de matching na fase de cria\u00e7\u00e3o de guilds.\n+Corrigido mudan\u00e7a de classes n\u00e3o tendo update de informa\u00e7\u00e3o em party.\n+Implementado matching (na forma de tratado GMS-like) entre l\u00edder e jogadores sem party presentes no mapa durante a fase de cria\u00e7\u00e3o de guilds.\n+\n 12 - 13 Mar\u00e7o 2019,\n Iniciado opera\u00e7\u00e3o de introdu\u00e7\u00e3o da wishlist de casamento e MCPQ no fonte, a partir do pull request feito pelo Dragohe4rt.\n Implementado estrutura back-end para comportar e manter (em DB) o wishlist de casamento.\n@@ -1725,4 +1737,32 @@ Corrigido diversas diseases da CPQ n\u00e3o funcionando corretamente ao pegar do ch\n Modificado gera\u00e7\u00e3o de mapas da CPQ, agora sempre carregando um novo mapa da WZ ao inv\u00e9s de sempre buscar e resetar o mapa carregado na cache.\n \n 15 Mar\u00e7o 2019,\n-Adicionado SFX nos portais da CPQ.\n\\ No newline at end of file\n+Adicionado SFX nos portais da CPQ.\n+Ajustado limites na CPQ para atuar GMS-like, al\u00e9m de ajustado a server flag USE_ENABLE_SOLO_EXPEDITIONS para permitir entradas solo nos mapas deste evento.\n+Corrigido sistema de login n\u00e3o avaliando corretamente o campo HOST em \"configuration.ini\" quando o mesmo \u00e9 preenchido como \"localhost\" ao inv\u00e9s de um valor de IP loopback.\n+\n+16 - 18 Mar\u00e7o 2019,\n+Revisado descri\u00e7\u00f5es em certos livros de upgrade de skill de Aran.\n+Adicionado server flag para remover disponibilidade da CPQ. Feito devido \u00e0s mensagens nos scripts estarem atualmente em portugu\u00eas.\n+Corrigido update de packet duplo ao inicializar uma inst\u00e2ncia de CPQ, fazendo funcionais aparecerem em dobro.\n+Corrigido inst\u00e2ncia de CPQ n\u00e3o terminando ap\u00f3s retirada de um membro da party ou dispensa da mesma.\n+Corrigido inst\u00e2ncia de CPQ n\u00e3o levando jogadores ao mapa de batalha devidamente ap\u00f3s implementado sistema de gera\u00e7\u00e3o de mapas.\n+Corrigido verifica\u00e7\u00e3o por inst\u00e2ncias em andamento de CPQ n\u00e3o sendo realizado corretamente.\n+Refatorado busca por nomes de jobs na CPQ e gerenciador de NPC scripts (estava em mai\u00fasculo).\n+\n+20 Mar\u00e7o 2019,\n+Revisado sistema de login, agora evitando conex\u00f5es indiretas feitas ao servidor. Servidor local somente aceita conex\u00f5es locais, servidor remoto somente aceita conex\u00f5es remotas.\n+Revisado busca por cliente ao finalizar sess\u00e3o. Se n\u00e3o h\u00e1 clientes registrados sob uma determinada sess\u00e3o IP, o sistema vai tentar buscar a mesma dentro dos registros de transi\u00e7\u00e3o (removendo assim possibilidade de perder detec\u00e7\u00e3o de accounts na fase de transi\u00e7\u00e3o).\n+\n+22 Mar\u00e7o 2019,\n+Ajustado PiratePQ stage 2, agora fazendo respawn de mobs na \u00e1rea ao inv\u00e9s de requisitar l\u00edder para chamar uma nova onda.\n+Refatorado busca por IP remoto de uma sess\u00e3o, agora utilizando um registro na classe da sess\u00e3o para manter o IP usado pela conex\u00e3o.\n+Ajustado quest do Prime Minister, permitindo entrada de grupos de at\u00e9 3 jogadores. Tamb\u00e9m alterado modo como o chefe \u00e9 colocado em campo: algum dos jogadores precisa ter a quest a fazer para come\u00e7ar (na primeira fase).\n+Corrigido v\u00e1rios itemids inexistentes nos drops da MCPQ.\n+Corrigido comando \"forcevac\" guardando no invent\u00e1rio mas n\u00e3o usando (como deveria ser) os itens \"us\u00e1veis ao pegar\".\n+\n+26 Mar\u00e7o 2019,\n+Revisado novamente login, para o caso onde accId = 0 estava sendo atribu\u00eddo e ent\u00e3o conta estava sendo rechecada, assim gerando conflito ao tentar logar.\n+Adicionado update de estado de login no m\u00f3dulo de disconnect, para tamb\u00e9m atualizar estado da conta quando a mesma n\u00e3o se encontra j\u00e1 logada ou em transi\u00e7\u00e3o.\n+Corrigido NPC da CPQ2, sa\u00edda abrupta, n\u00e3o retornando jogadores devidamente para o sagu\u00e3o de espera.\n+Corrigido bug na CPQ em tempo estendido n\u00e3o mostrando devidamente o efeito visual de fim de partida.\n\\ No newline at end of file"}, {"sha": "6d47efaca2dc8a414d0b8635df2f291c1b039605", "filename": "handbook/Use.txt", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/handbook/Use.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/handbook/Use.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/handbook/Use.txt?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,4 +1,4 @@\n-2000000 - Red Potion - A potion made out of red herbs.\\nRecovers 50 HP.\n+\ufeff2000000 - Red Potion - A potion made out of red herbs.\\nRecovers 50 HP.\n 2000001 - Orange Potion - A concentrated potion made out of red herbs.\\nRecovers 150 HP.\n 2000002 - White Potion - A highly-concentrated potion made out of red herbs.\\nRecovers 300 HP.\n 2000003 - Blue Potion - A potion made out of blue herbs.\\nRecovers 100 MP.\n@@ -1191,11 +1191,11 @@\n 2280010 - [Skill Book] Triple Throw - You can learn #cTriple Throw# with this book.rnClass : Night LordrnCondition : #cTriple Throw# not acquired\n 2280011 - Ancient Ice Powder - This is a pack full of ancient ice powder. If you eat this,  you will feel chilled and can learn Ice Demon.\n 2280012 - [Skill Book] Rush - You can learn #cRush# with this book.rnJob : 4th Advancement WarriorrnCondition : #cRush# not acquired\n-2280013 - [Skill Book] Final Blow - Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Lv Aran\\nCondition: #cFinal Blow# not available\n-2280014 - [Skill Book] High Defense - Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Lv Aran\\nCondition: #cHigh Defense# not available\n-2280015 - [Skill Book] Combo Tempest - Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Tempest# not available\n+2280013 - [Skill Book] Final Blow - Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Advancement Aran\\nCondition: #cFinal Blow# not available\n+2280014 - [Skill Book] High Defense - Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Advancement Aran\\nCondition: #cHigh Defense# not available\n+2280015 - [Skill Book] Combo Tempest - Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Advancement Aran\\nCondition: #cCombo Tempest# not available\n+2280016 - [Skill Book] Combo Barrier - Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Advancement Aran\\nCondition: #cCombo Barrier# not available\n 2280017 - [Skill Book] Pig's Weakness - Skill Book from which you can learn about the #cPig's Weakness# skill.\\nCondition: #cPig's Weakness# not available\n-2280016 - [Skill Book] Combo Barrier - Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Barrier# not available\n 2280018 - [Skill Book] Stump's Weakness - Skill Book from which you can learn about the #cStump's Weakness# skill.\\nCondition: #cStump's Weakness# not available\n 2280019 - [Skill Book] Slime's Weakness - Skill Book from which you can learn about the #cSlime's Weakness# skill.\\nCondition: #cSlime's Weakness# not available\n 2290000 - [Mastery Book] Monster Magnet - This increases master level of the  #cMonster Magnet# skill up to 20 with 70% chance of success.rnJob : 4th Advancement WarriorrnCondition : Skill level above 5"}, {"sha": "b6a02eb5a9066780d24d334e902282df45f09b90", "filename": "launchtest.bat", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/launchtest.bat", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/launchtest.bat", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/launchtest.bat?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,4 +1,4 @@\n-REM 'launchtest.bat' Author: Tochi\n+REM // 'launchtest.bat' Author: Tochi\n @echo off\n set a=0\n title HeavenMS: Offline\n@@ -11,7 +11,7 @@ echo Commands:\n echo -------------------------------------------------------------\n echo start - Start HeavenMS server\n echo shutdown - Shut down HeavenMS server and close Launcher File\n-echo restart - Restart HeavenMS Launcher File\n+echo reset - Resets HeavenMS Launcher File\n echo clear - Clear this window\n echo -------------------------------------------------------------\n echo.\n@@ -20,7 +20,7 @@ echo.\n set /p s=\"Enter command: \"\n if \"%s%\"==\"start\" goto :start\n if \"%s%\"==\"shutdown\" goto :shutdown\n-if \"%s%\"==\"restart\" goto :restart\n+if \"%s%\"==\"reset\" goto :reset\n if \"%s%\"==\"clear\" goto :clear\n echo Wrong Command.\n echo.\n@@ -52,10 +52,10 @@ echo The Server Launcher will be close in a few seconds.\n ping localhost -w 100000 >nul\n taskkill /im cmd.exe\n \n-:restart\n+:reset\n color 4c\n-title HeavenMS: Restarting...\n-echo Please type 'start' in command box after bat file have been restarted.\n+title HeavenMS: Resetting...\n+echo Please type 'start' in command box after bat file have been resetted.\n ping localhost -w 100000 >nul\n-start launch.bat\n+start launchtest.bat\tREM // thanks Paxum for noting that 'launchtest.bat' is to be used here\n taskkill /im cmd.exe\n\\ No newline at end of file"}, {"sha": "c61f7b7a0d2f5915e0c1d1375aa08e590df8ca68", "filename": "scripts/event/MK_PrimeMinister.js", "status": "modified", "additions": 73, "deletions": 15, "changes": 88, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/MK_PrimeMinister.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/MK_PrimeMinister.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/MK_PrimeMinister.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,31 +1,79 @@\n-var minPlayers = 1;\n-var entryMap = 106021402;\n-var exitMap = 106021600;\n+importPackage(Packages.tools);\n+importPackage(Packages.server.life);\n \n-var minMapId = 106021601;\n-var maxMapId = 106021601;\n+var eventTime = 10 * 60 * 1000;     // 10 minutes\n+var entryMap = 106021600;\n+var exitMap = 106021402;\n+var recruitMap = 106021402;\n+\n+var minPlayers = 1, maxPlayers = 3;\n+var minLevel = 30, maxLevel = 255;\n+\n+var minMapId = 106021600;\n+var maxMapId = 106021600;\n+\n+var mobId = 3300008; //Prime Minister\n \n function init(){}\n \n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n function setup(difficulty, lobbyId){\n \tvar eim = em.newInstance(\"MK_PrimeMinister_\" +lobbyId);\n-\teim.getInstanceMap(106021601).resetFully();\n-\teim.getInstanceMap(106021601).allowSummonState(false);\n \trespawn(eim);\n+        \n \treturn eim;\n }\n \n function afterSetup(eim){}\n \n+function primeMinisterCheck(eim) {\n+        var map = eim.getMapInstance(entryMap);\n+        \n+        var pIter = map.getAllPlayers().iterator();\n+        while (pIter.hasNext()) {\n+                var player = pIter.next();\n+                if (player.getQuestStatus(2333) == 1 && player.getClient().getAbstractPlayerInteraction().getQuestProgress(2333, mobId) == 0) {\n+                        return true;\n+                }\n+        }\n+\n+        return false;\n+}\n+\n function respawn(eim){\n-\tvar map = eim.getMapInstance(entryMap);\n-\tmap.allowSummonState(true);\n-\tmap.instanceMapRespawn();\n-\teim.schedule(\"respawn\", 10000);\n+\tif (primeMinisterCheck(eim)) {\n+                eim.startEventTimer(eventTime);\n+\n+                var weddinghall = eim.getMapInstance(entryMap);\n+                weddinghall.getPortal(1).setPortalState(false);\n+                weddinghall.spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(mobId), new java.awt.Point(292, 143));\n+        } else {\n+                eim.schedule(\"respawn\", 10000);\n+        }\n }\n \n function playerEntry(eim, player){\n-\tvar weddinghall = eim.getMapInstance(106021601);\n+\tvar weddinghall = eim.getMapInstance(entryMap);\n \tplayer.changeMap(weddinghall, weddinghall.getPortal(1));\n }\n \n@@ -69,7 +117,7 @@ function playerUnregistered(eim, player){}\n \n function playerExit(eim, player){\n \teim.unregisterPlayer(player);\n-\tplayer.changeMap(entryMap, 2);\n+\tplayer.changeMap(exitMap, 2);\n }\n \n function changedMap(eim, chr, mapid) {\n@@ -86,9 +134,19 @@ function cancelSchedule(){}\n \n function dispose(){}\n \n-function clearPQ(eim){}\n+function clearPQ(eim){\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n \n-function monsterKilled(mob, eim){}\n+function monsterKilled(mob, eim){\n+        if (mob.getId() == mobId) {\n+                eim.getMapInstance(entryMap).getPortal(1).setPortalState(true);\n+\n+                eim.showClearEffect();\n+                eim.clearPQ();\n+        }\n+}\n \n function allMonstersDead(eim){}\n "}, {"sha": "7c31952e76968a75b16aabbc06ce74f1d03e462f", "filename": "scripts/event/MK_PrimeMinister2.js", "status": "modified", "additions": 58, "deletions": 20, "changes": 78, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/MK_PrimeMinister2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/MK_PrimeMinister2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/MK_PrimeMinister2.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,43 +1,71 @@\n importPackage(Packages.tools);\n importPackage(Packages.server.life);\n \n-var minPlayers = 1;\n-var eventTime = 10;     // 10 minutes\n-var entryMap = 106021402;\n-var exitMap = 106021600;\n+var eventTime = 10 * 60 * 1000;     // 10 minutes\n+var entryMap = 106021601;\n+var exitMap = 106021402;\n+var recruitMap = 106021402;\n+\n+var minPlayers = 1, maxPlayers = 3;\n+var minLevel = 30, maxLevel = 255;\n \n var minMapId = 106021601;\n var maxMapId = 106021601;\n \n+var mobId = 3300008; //Prime Minister\n+\n function init(){}\n \n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n function setup(difficulty, lobbyId){\n \tvar eim = em.newInstance(\"MK_PrimeMinister2_\" +lobbyId);\n-\teim.getInstanceMap(106021601).resetFully();\n-\teim.getInstanceMap(106021601).allowSummonState(false);\n \trespawn(eim);\n         \n \treturn eim;\n }\n \n function afterSetup(eim){}\n \n+function primeMinisterCheck(eim) {\n+        var map = eim.getMapInstance(entryMap);\n+        return !map.getAllPlayers().isEmpty();\n+}\n+\n function respawn(eim){\n-\tvar map = eim.getMapInstance(entryMap);\n-\tmap.allowSummonState(true);\n-\tmap.instanceMapRespawn();\n-\teim.schedule(\"respawn\", 10000);\n+\tif (primeMinisterCheck(eim)) {\n+                eim.startEventTimer(eventTime);\n+\n+                var weddinghall = eim.getMapInstance(entryMap);\n+                weddinghall.getPortal(1).setPortalState(false);\n+                weddinghall.spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(mobId), new java.awt.Point(292, 143));\n+        } else {\n+                eim.schedule(\"respawn\", 10000);\n+        }\n }\n \n function playerEntry(eim, player){\n-\tvar weddinghall = eim.getMapInstance(106021601);\n+\tvar weddinghall = eim.getMapInstance(entryMap);\n \tplayer.changeMap(weddinghall, weddinghall.getPortal(1));\n-        \n-        var pm = MapleLifeFactory.getMonster(3300008);\n-        weddinghall.spawnMonsterOnGroundBelow(pm, new Packages.java.awt.Point(472, 27));\n-        \n-        player.getClient().announce(MaplePacketCreator.getClock(eventTime * 60));\n-        eim.startEventTimer(eventTime * 60000);\n }\n \n function scheduledTimeout(eim){\n@@ -80,7 +108,7 @@ function playerUnregistered(eim, player){}\n \n function playerExit(eim, player){\n \teim.unregisterPlayer(player);\n-\tplayer.changeMap(entryMap, 2);\n+\tplayer.changeMap(exitMap, 2);\n }\n \n function changedMap(eim, chr, mapid) {\n@@ -97,9 +125,19 @@ function cancelSchedule(){}\n \n function dispose(){}\n \n-function clearPQ(eim){}\n+function clearPQ(eim){\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function monsterKilled(mob, eim){\n+        if (mob.getId() == mobId) {\n+                eim.getMapInstance(entryMap).getPortal(1).setPortalState(true);\n \n-function monsterKilled(mob, eim){}\n+                eim.showClearEffect();\n+                eim.clearPQ();\n+        }\n+}\n \n function allMonstersDead(eim){}\n "}, {"sha": "9d43d72678293cb3bc94bc529e6987ea334f7e3a", "filename": "scripts/event/PiratePQ.js", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/PiratePQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/event/PiratePQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PiratePQ.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -24,7 +24,7 @@\n */\n \n var isPq = true;\n-var isGrindMode = true;     // stages done after breaking all boxes on maps\n+var isGrindMode = false;     // stages done after breaking all boxes on maps\n \n var minPlayers = 3, maxPlayers = 6;\n var minLevel = 55, maxLevel = 100;\n@@ -185,7 +185,7 @@ function setup(level, lobbyid) {\n \teim.getInstanceMap(925100400).resetPQ(level);\n \teim.getInstanceMap(925100500).resetPQ(level);\n         \n-        respawnStg4(eim);\n+        respawnStages(eim);\n         \n         eim.startEventTimer(eventTime * 60000);\n         setEventRewards(eim);\n@@ -195,9 +195,14 @@ function setup(level, lobbyid) {\n \n function afterSetup(eim) {}\n \n-function respawnStg4(eim) {\n+function respawnStages(eim) {\n+        var stg = eim.getIntProperty(\"stage2\");\n+        if (stg < 3) {  // thanks Chloek3, seth1, BHB for suggesting map respawn rather than waves on stg2\n+            eim.getMapInstance(925100100).spawnAllMonsterIdFromMapSpawnList(9300114 + stg, eim.getIntProperty(\"level\"), true);\n+        }\n+        \n         eim.getMapInstance(925100400).instanceMapRespawn();\n-        eim.schedule(\"respawnStg4\", 10 * 1000);\n+        eim.schedule(\"respawnStages\", 10 * 1000);\n }\n \n function playerEntry(eim, player) {"}, {"sha": "e2c1aca7d6aa697152ab01d77edb5ae9461ce83b", "filename": "scripts/npc/1300013.js", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/1300013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/1300013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1300013.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -44,9 +44,18 @@ function action(mode, type, selection){\n                         }\n                     \n                         else if(selection == 1){\n-                                var pm = cm.getEventManager(\"MK_PrimeMinister2\");\n-                                pm.setProperty(\"player\", cm.getPlayer().getName());\n-                                pm.startInstance(cm.getPlayer());\n+                                var em = cm.getEventManager(\"MK_PrimeMinister2\");\n+                                \n+                                var party = cm.getPlayer().getParty();\n+                                if (party != null) {\n+                                    if (!em.startInstance(party, cm.getMap())) {\n+                                        cm.sendOk(\"Another party is already challenging the boss in this channel.\");\n+                                    }\n+                                } else {\n+                                    if (!em.startInstance(cm.getPlayer())) {\n+                                        cm.sendOk(\"Another party is already challenging the boss in this channel.\");\n+                                    }\n+                                }\n                                 \n                                 cm.dispose();\n                                 return;"}, {"sha": "e6bf0728c6a43cd1e0d7ea201012aaa42812fb24", "filename": "scripts/npc/2042000.js", "status": "modified", "additions": 94, "deletions": 56, "changes": 150, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,3 +1,11 @@\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Ronan (HeavenMS)\n+        3.0 - Third Version by Jayd - translated CPQ contents to English & added Pirate items\n+                                Special thanks to \u983c\u664f (ryantpayton) for also stepping in to translate CPQ scripts.\n+---------------------------------------------------------------------------------------------------\n+**/\n \n var status = 0;\n var rnk = -1;\n@@ -8,9 +16,9 @@ var n4 = 10; //40\n var n5 = 20; //50\n \n var cpqMap = 980000000;\n-var cpqMinLvl = 0;\n-var cpqMaxLvl = 255;\n-var cpqMinAmt = 0;\n+var cpqMinLvl = 30;\n+var cpqMaxLvl = 50;\n+var cpqMinAmt = 2;\n var cpqMaxAmt = 6;\n \n // Ronan's custom ore refiner NPC\n@@ -21,6 +29,19 @@ var feeMultiplier = 7.0;\n \n function start() {\n     status = -1;\n+    \n+    if (!Packages.constants.ServerConstants.USE_CPQ) {\n+        if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+            status = 0;\n+            action(1, 0, 4);\n+        } else {\n+            cm.sendOk(\"The Monster Carnival is currently unavailable.\");\n+            cm.dispose();\n+        }\n+        \n+        return;\n+    }\n+    \n     action(1, 0, 0);\n }\n \n@@ -39,7 +60,7 @@ function action(mode, type, selection) {\n         \n         if (cm.getPlayer().getMapId() == 980000010) {\n             if (status == 0) {\n-                cm.sendNext(\"Eu espero que voc\ufffd tenha divertido na Folia dos Monstros!\");\n+                cm.sendNext(\"I hope you had fun at the Monster Carnival!\");\n             } else if (status > 0) {\n                 cm.warp(980000000, 0);\n                 cm.dispose();\n@@ -50,20 +71,20 @@ function action(mode, type, selection) {\n                     var shiu = \"\";\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shiu += \"#rA#k\";\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle despite your excellent performance. Victory can be yours next time! \\r\\n\\r\\n#bYour result: \" + shiu);\n                         rnk = 10;\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shiu += \"#rB#k\";\n                         rnk = 20;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle, even with your ultimate performance. Just a little bit, and the victory could have been yours! \\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shiu += \"#rC#k\";\n                         rnk = 30;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle. Victory is for those who strive. I see your efforts, so victory is not far from your reach. Keep it up!\\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else {\n                         shiu += \"#rD#k\";\n                         rnk = 40;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either equalized or lost the battle, and your performance clearly reflects on it. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shiu);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -104,19 +125,19 @@ function action(mode, type, selection) {\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shi += \"#rA#k\";\n                         rnk = 1;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory!!! What a performance! The opposite group could not do anything! I hope the same good work next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shi += \"#rB#k\";\n                         rnk = 2;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory! That was awesome! You did a good job against the opposing group! Just a little longer, and you'll definitely get an A next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shi += \"#rC#k\";\n                         rnk = 3;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory. You did some things here and there, but that can not be considered a good victory. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else {\n                         shi += \"#rD#k\";\n                         rnk = 4;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory, though your performance did not quite reflect that. Be more active in your next participation in the Monster Carnival! \\r\\n\\r\\n#bYour result: \" + shi);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -154,10 +175,10 @@ function action(mode, type, selection) {\n             if (status == 0) {\n                 if (cm.getParty() == null) {\n                     status = 10;\n-                    cm.sendOk(\"#e\u00c9 necess\u00e1rio criar um grupo antes de come\u00e7ar o Festival de Monstros!#k\");\n+                    cm.sendOk(\"You need to create a party first before you can join the battle!\");\n                 } else if (!cm.isLeader()) {\n                     status = 10;\n-                    cm.sendOk(\"Se voc\u00ea quer come\u00e7ar o Festival, avise o #bl\u00edder do grupo#k para falar comigo.\");\n+                    cm.sendOk(\"If you want to start the battle, let the #bParty Leader#k talk to me.\");\n                 } else {\n                     var party = cm.getParty().getMembers();\n                     var inMap = cm.partyMembersInMap();\n@@ -175,15 +196,18 @@ function action(mode, type, selection) {\n \n                     if (party >= 1) {\n                         status = 10;\n-                        cm.sendOk(\"Voc\u00ea n\u00e3o tem n\u00famero suficiente de pessoas em seu grupo. Voc\u00ea precisa de um grupo com #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k membros e eles devem estar no mapa com voc\u00ea.\");\n+                        cm.sendOk(\"You do not have enough people in your party. You need a party with #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k members and they should be on the map with you.\");\n                     } else if (lvlOk != inMap) {\n                         status = 10;\n-                        cm.sendOk(\"Certifique se todos em seu grupo est\u00e3o dentre os n\u00edveis corretos (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                        cm.sendOk(\"Make sure everyone in your party is among the correct levels (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n                     } else if (isOutMap > 0) {\n                         status = 10;\n-                        cm.sendOk(\"Existe algu\u00e9m do grupo que n\u00e3o esta no mapa!\");\n+                        cm.sendOk(\"There are some of the party members that is not on the map!\");\n                     } else {\n-                        cm.sendCPQMapLists();\n+                        if (!cm.sendCPQMapLists()) {\n+                            cm.sendOk(\"All Monster Carnival fields are currently in use! Try again later.\");\n+                            cm.dispose();\n+                        }\n                     }\n                 }\n             } else if (status == 1) {\n@@ -192,15 +216,15 @@ function action(mode, type, selection) {\n                         cm.challengeParty(selection);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"A sala esta cheia.\");\n+                        cm.sendOk(\"The room is currently full.\");\n                         cm.dispose();\n                     }\n                 } else {\n                     var party = cm.getParty().getMembers();\n-                    if ((selection >= 0 && selection <= 3) && party.size() < 1) {\n-                        cm.sendOk(\"Voc\u00ea precisa de no m\u00ednimo 2 player para entrar na competi\u00e7\u00e3o.\");\n-                    } else if ((selection >= 4 && selection <= 5) && party.size() < 1) {\n-                        cm.sendOk(\"Voc\u00ea precisa de no m\u00ednimo 3 player para entrar na competi\u00e7\u00e3o.\");\n+                    if ((selection >= 0 && selection <= 3) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 2)) {\n+                        cm.sendOk(\"You need at least 2 players to participate in the battle!\");\n+                    } else if ((selection >= 4 && selection <= 5) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 3)) {\n+                        cm.sendOk(\"You need at least 3 players to participate in the battle!\");\n                     } else {\n                         cm.cpqLobby(selection);\n                     }\n@@ -211,7 +235,7 @@ function action(mode, type, selection) {\n             }\n         } else {\n             if (status == 0) {\n-                var talk = \"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L3# Ir para o campo da Folia de Monstros 2.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\";\n+                var talk = \"What would you like to do? If you have never participate in the Monster Carnival, you will need to know a few things before participating! \\r\\n#b#L0# Go to the Monster Carnival 1.#l \\r\\n#L3# Go to the Monster Carnival 2.#l \\r\\n#L1# Learn about the Monster Carnival.#l\\r\\n#L2# Trade #t4001129#.#l\";\n                 if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n                     talk += \"\\r\\n#L4# ... Can I just refine my ores?#l\";\n                 }\n@@ -224,19 +248,19 @@ function action(mode, type, selection) {\n                         cm.dispose();\n                         return;\n                     } else if (cm.getLevel() < 30) {\n-                        cm.sendOk(\"Voc\ufffd precisa ser no m\ufffdnimo n\ufffdvel 30 para participar da Folia de Monstros. Fale comigo quando for forte o bastante.\");\n+                        cm.sendOk(\"You must be at least level 30 to participate in the Monster Carnival. Talk to me when you're strong enough.\");\n                         cm.dispose();\n                         return;\n                     } else {\n-                        cm.sendOk(\"Sinto muito, mas apenas os jogadores de n\ufffdvel 30~50 podem participar da Folia de Monstros.\");\n+                        cm.sendOk(\"I'm sorry, but only players of level 30 ~ 50 can participate in the Monster Carnival.\");\n                         cm.dispose();\n                         return;\n                     }\n                 } else if (selection == 1) {\n                     status = 60;\n-                    cm.sendSimple(\"O que gostaria de fazer?\\r\\n#b#L0# O que \ufffd a Folia de Monstros?#l\\r\\n#L1# Vis\ufffdo geral sobre a Folia de Monstros#l\\r\\n#L2# Informa\ufffd\ufffdes detalhadas sobre a Folia de Monstros#l\\r\\n#L3# Nada, de verdade. Mudei de ideia.#l\");\n+                    cm.sendSimple(\"What would you like to do?\\r\\n#b#L0# What is Monster Carnival?#l\\r\\n#L1# Overview of the Monster Carnival.#l\\r\\n#L2# Detailed information about the Monster Carnival.#l\\r\\n#L3# Nothing really, I've changed my mind.#l\");\n                 } else if (selection == 2) {\n-                    cm.sendSimple(\"Lembre-se se voc\ufffd possui #t4001129#, voc\ufffd pode troc\ufffd-las por itens. Tenha certeza que voc\ufffd possui #t4001129# suficientes para o item que voc\ufffd deseja. Selecione o item que voc\ufffd gostaria de troc\ufffd-las! \\r\\n#b#L0# #t1122007#(\" + n1 + \" moedas)#l\\r\\n#L1# #t2041211#(\" + n2 + \" moedas)#l\\r\\n#L2# Armas para Guerreiros#l\\r\\n#L3# Armas para Bruxos#l\\r\\n#L4# Armas para Arqueiros#l\\r\\n#L5# Armas para Gatunos#l\");\n+                    cm.sendSimple(\"Remember, if you have #t4001129#, you can exchange for items. Select the item you would like to change them! \\r\\n#b#L0# #t1122007# (\" + n1 + \" coins)#l\\r\\n#L1# #t2041211# (\" + n2 + \" coins)#l\\r\\n#L2# Weapons for Warriors#l\\r\\n#L3# Weapons for Magician#l\\r\\n#L4# Weapons for Archers#l\\r\\n#L5# Weapons for Thief#l\\r\\n#L6# Weapons for Pirate#l\");\n                 } else if (selection == 3) {\n                     cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n                     cm.warp(980030000, 0);\n@@ -269,7 +293,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n1);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Equipamentos est\ufffd cheio.\");\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your EQUIP inventory is full.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 1) {\n@@ -278,25 +302,28 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n2);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Uso est\ufffd cheio.\");\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your USE inventory is full.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 2) {//S2 Warrior 26 S3 Magician 6 S4 Bowman 6 S5 Thief 8\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Please make sure you have # t4001129 # for the weapon you want. Select the weapon you would like to trade # t4001129 #. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page (1/2)#l\");\n                 } else if (select == 3) {\n                     status = 20;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1372001#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1382018#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1372012#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1382019#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1382001#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1372007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1372001# (\" + n3 + \" coins)#l\\r\\n#L1# #z1382018# (\" + n3 + \" coins)#l\\r\\n#L2# #z1372012# (\" + n4 + \" coins)#l\\r\\n#L3# #z1382019# (\" + n4 + \" coins)#l\\r\\n#L4# #z1382001# (\" + n5 + \" coins)#l\\r\\n#L5# #z1372007# (\" + n5 + \" coins)#l\");\n                 } else if (select == 4) {\n                     status = 30;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1452006#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1452007#(\" + n4 + \" moedas)#l\\r\\n#L2# #z1452008#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1462005#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1462006#(\" + n4 + \" moedas)#l\\r\\n#L5# #z1462007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1452006# (\" + n3 + \" coins)#l\\r\\n#L1# #z1452007# (\" + n4 + \" coins)#l\\r\\n#L2# #z1452008# (\" + n5 + \" coins)#l\\r\\n#L3# #z1462005# (\" + n3 + \" coins)#l\\r\\n#L4# #z1462006# (\" + n4 + \" coins)#l\\r\\n#L5# #z1462007# (\" + n5 + \" coins)#l\");\n                 } else if (select == 5) {\n                     status = 40;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar por. As armas que eu tenho s\ufffdo da maior qualidade. Seleciona a mais atraente para voc\ufffd! \\r\\n#b#L0# #z1472013#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1472017#(\" + n4 + \"moedas)#l\\r\\n#L2# #z1472021#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1332014#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1332031#(\" + n4 + \"moedas)#l\\r\\n#L5# #z1332011#(\" + n4 + \"moedas)#l\\r\\n#L6# #z1332016#(\" + n5 + \" moedas)#l\\r\\n#L7# #z1332003#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1472013# (\" + n3 + \" coins)#l\\r\\n#L1# #z1472017# (\" + n4 + \" coins)#l\\r\\n#L2# #z1472021# (\" + n5 + \" coins)#l\\r\\n#L3# #z1332014# (\" + n3 + \" coins)#l\\r\\n#L4# #z1332031# (\" + n4 + \" coins)#l\\r\\n#L5# #z1332011# (\" + n4 + \" coins)#l\\r\\n#L6# #z1332016# (\" + n5 + \" coins)#l\\r\\n#L7# #z1332003# (\" + n5 + \" coins)#l\");\n+                } else if (select == 6) {\n+                    status = 50; //pirate rewards\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1482005# (\" + n3 + \" coins)#l \\r\\n#b#L1# #z1482006# (\" + n4 + \" coins)#l \\r\\n#b#L2# #z1482007# (\" + n5 + \" coins)#l \\r\\n#b#L3# #z1492005# (\" + n3 + \" coins)#l \\r\\n#b#L4# #z1492006# (\" + n4 + \" coins)#l \\r\\n#b#L5# #z1492007# (\" + n5 + \" coins)#l\");\n                 }\n             } else if (status == 11) {\n                 if (selection == 12) {\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente \ufffdteis. D\ufffd uma olhada! \\r\\n#b#L0# #z1322015#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1422008#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1322016#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1422007#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1322017#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1422005#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1432003#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1442003#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1432005#(\" + n4 + \"moedas)#l\\r\\n#L9# #z1442009#(\" + n4 + \"moedas)#l\\r\\n#L10# #z1442005#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1432004#(\" + n5 + \" moedas)#l\\r\\n#L12# Voltar para a p\ufffdgina inicial(2/2)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely useful. Take a look! \\r\\n#b#L0# #z1322015# (\" + n3 + \" coins)#l\\r\\n#L1# #z1422008# (\" + n3 + \" coins)#l\\r\\n#L2# #z1322016# (\" + n4 + \" coins)#l\\r\\n#L3# #z1422007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1322017# (\" + n5 + \" coins)#l\\r\\n#L5# #z1422005# (\" + n5 + \" coins)#l\\r\\n#L6# #z1432003# (\" + n3 + \" coins)#l\\r\\n#L7# #z1442003# (\" + n3 + \" coins)#l\\r\\n#L8# #z1432005# (\" + n4 + \" coins)#l\\r\\n#L9# #z1442009# (\" + n4 + \" coins)#l\\r\\n#L10# #z1442005# (\" + n5 + \" coins)#l\\r\\n#L11# #z1432004# (\" + n5 + \" coins)#l\\r\\n#L12# Back to the first page (2/2)#l\");\n                 } else {\n                     var item = new Array(1302004, 1402006, 1302009, 1402007, 1302010, 1402003, 1312006, 1412004, 1312007, 1412005, 1312008, 1412003);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5);\n@@ -305,14 +332,14 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                         cm.dispose();\n                     }\n                 }\n             } else if (status == 12) {\n                 if (selection == 12) {\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Please make sure you have #b#t4001129##k for the weapon you want. Select the weapon you would like to trade #t4001129#. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page(1/2)#l\");\n                 } else {\n                     var item = new Array(1322015, 1422008, 1322016, 1422007, 1322017, 1422005, 1432003, 1442003, 1432005, 1442009, 1442005, 1432004);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5, n5);\n@@ -321,7 +348,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                         cm.dispose();\n                     }\n                 }\n@@ -333,7 +360,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 31) {\n@@ -344,7 +371,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 41) {\n@@ -355,54 +382,65 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 51) {\n+                var item = new Array(1482005, 1482006, 1482007, 1492005, 1492006, 1492007);\n+                var cost = new Array(n3, n4, n5, n3, n4, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 61) {\n                 select = selection;\n                 if (selection == 0) {\n-                    cm.sendNext(\"Haha! Eu sou Spiegelmann, o l\ufffdder dessa Folia. Eu comecei a primeira #bFolia de Monstros#k aqui, aguardando por viajantes como voc\ufffd para participar dessa extravaganza!\");\n+                    cm.sendNext(\"Haha! I am Spiegelmann, the leader of this Monster Carnival. I got the first #bMonster Carnival#k here, waiting for travelers like you to take part in this extravaganza!\");\n                 } else if (selection == 1) {\n-                    cm.sendNext(\"#bFolia de Monstros#k consiste em 2 grupos entrando no campo de batalha, e ca\ufffdando os monstros invocados pelo outro grupo. \ufffd uma #bmiss\ufffdo de combate que determina o vitorioso pela quantia de Pontos de Folia (CP) recebidos#k.\");\n+                    cm.sendNext(\"#bMonster Carnival#k consists of 2 groups entering the battlefield, and dropping the monsters invoked by the other party. #bA combat brigade that determines the victor by the amount of Carnival Points (CP) received#k.\");\n                 } else if (selection == 2) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, voc\ufffd ver\ufffd a janela da Folia de Monstros aparecer. Tudo que precisa fazer \ufffd #bselecionar o que voc\ufffde quer usar, e pressionar OK#k. Muito f\ufffdcil, n\ufffd?\");\n+                    cm.sendNext(\"When you enter the Carnival Field, you will see the Monster List window appear. All you need to do is #bselect what you want to use, and press OK#k. Very easy, right?\");\n                 } else {\n                     cm.dispose();\n                 }\n             } else if (status == 62) {\n                 if (select == 0) {\n-                    cm.sendNext(\"O que \ufffd a #bFolia de Monstros#k? Hahaha! Vamos dizer que \ufffd uma experi\ufffdncia que jamais esquecer\ufffd! \ufffd uma #bbatalha contra outros viajantes assim como voc\ufffd!#k\");\n+                    cm.sendNext(\"What is #bMonster Carnival#k? Hahaha! Let's say it's an experience you'll never forget! It's a battle against other travelers just like you!#k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, sua tarefa \ufffd #breceber CP ca\ufffdando os monstros do grupo oposto, e usar estes CP's para distrair o grupo oposto de ca\ufffdar monstros.#k.\");\n+                    cm.sendNext(\"When entering the Carnival Field, your task is to #breceive CP by killing the monsters from the opposite group, and using these CP's to distract the opposing group from hitting monsters#k.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"Assim que se acostumar com os comandos, tente usar #bas teclas TAB e F1 ~ F12#k. #bTAB alterna entre Invoca\ufffd\ufffdo de Monstros/Habilidades/Protetor,#k e, #bF1~ F12 possibilita-o de acessar uma das janelas diretamente#k.\");\n+                    cm.sendNext(\"Once you get used to the commands, try using #bTAB and F1 ~ F12#k. #bTAB toggles between Monster Invocation / Skills / Protector#k, and, #bF1 ~ F12 enables you to access one of the windows directly#k.\");\n                 }\n             } else if (status == 63) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Eu sei que \ufffd muito perigoso para voc\ufffds lutarem uns com os outros usando armas de verdade; e eu n\ufffdo sugeriria um ato t\ufffdo barb\ufffdrico. N\ufffdo meu amigo, o que eu ofere\ufffdo \ufffd competi\ufffd\ufffdo. A emo\ufffd\ufffdo da batalha e a emo\ufffd\ufffdo de competir contra pessoas t\ufffdo fortes e motivadas. Eu ofere\ufffdo a premissa de que seu grupo e o grupo oposto ambos #binvoquem os monstros, e derrote os monstros invocados pelo grupo advers\ufffdrio. Essa \ufffd a ess\ufffdncia da Folia de Monstros. Al\ufffdm disso, voc\ufffd pode usar Maple Coins ganhos durante a Folia de Monstros para obter novos itens e armas! #k\");\n+                    cm.sendNext(\"I know it's too dangerous for you to fight with each other using real weapons; and I would not suggest such a barbaric act. Not my friend, what I offer to the competition. The excitement of the battle and the excitement of competing against such strong and motivated people. I offer the premise that your group and the opposite group both #binvoquem the monsters, and defeat the monsters invoked by the opposing group. This is the essence of the Monster Carnival. In addition, you can use Maple Coins earned during the Monster Carnival to get new items and weapons! #k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Existem 3 maneiras de distrair o grupo advers\ufffdrio: #bInvodar um monstro, Habilidade, and Protetor#k. Vou dar-lhe um olhar mais aprofundado, se voc\ufffd quiser saber mais sobre 'Instru\ufffd\ufffdes detalhadas'.\");\n+                    cm.sendNext(\"There are 3 ways to distract the opposing group: #bSummoning a monster, Ability, and Protector#k. I will give you a more in-depth look if you want to know more about 'detailed instructions'!\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bInvocar um Monstro#k chama um monstro que ataca o grupo advers\ufffdrio, sob seu controle. Use CP para trazer um Monstro Invocado, e ele ir\ufffd aparecer na mesma \ufffdrea, atacando o grupo oposto.\");\n+                    cm.sendNext(\"#bSummoning#k a Monster calls a monster that attacks the opposing party, under its control. Use CP to bring an Summoned Monster, and it will appear in the same area, attacking the opposing group.\");\n                 }\n             } else if (status == 64) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Claro, n\ufffdo \ufffd t\ufffdo simples assim. Existem outras maneiras de prevenir o outro grupo de ca\ufffdar monstros, e cabe a voc\ufffd descobrir como faz\ufffd-lo. O que acha? Interessado em uma competi\ufffd\ufffdo amig\ufffdvel?\");\n+                    cm.sendNext(\"Of course, it's not that simple. There are other ways to prevent the other group from dropping monsters, and it's up to you to figure out how to do it. What do you think? Interested in a friendly competition?\");\n                     cm.dispose();\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Por favor lembre-se. Nunca \ufffd uma boa ideia guardar seus CP's. #bOs CP's que voc\ufffd usou ir\ufffdo ajudar a determinar o vencedor e o perdedor da Folia.\");\n+                    cm.sendNext(\"Please remember. It's never a good idea to keep your CP's. #bThe CPs you used will help determine the winner and loser of Monster Carnival.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bHabilidade#k \ufffd uma op\ufffd\ufffdo de usar habilidades tais como Escurid\ufffdo, Fraqueza, e outras para prevenir o grupo oposto de matar outros monstros. S\ufffdo necess\ufffdrios muitos CP's, mas vale muito a pena. O \ufffdnico problema \ufffd que eles n\ufffdo duram muito. Use essa t\ufffdtica com sabedoria!\");\n+                    cm.sendNext(\"#bAbility#k is an option to use abilities such as Darkness, Weakness, and others to prevent the opposing group from killing other monsters. Not many CPs are needed, but it's worth it. The only problem is they do not last very long. Use this tactic wisely!\");\n                 }\n             } else if (status == 65) {\n                 if (select == 1) {\n-                    cm.sendNext(\"Oh, e n\ufffdo se preocupe em tranformar-se em um fantasma. Na Folia de Monstros, #bvoc\ufffd n\ufffdo perder\ufffd EXP ap\ufffds a morte#k. \ufffd realmente uma exper\ufffdncia como nenhuma outra!\");\n+                    cm.sendNext(\"Oh, and do not worry about turning into a ghost. In the Monster Carnival, #byou will not lose EXP after death#k. So it's really an experience like no other!\");\n                     cm.dispose();\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bProtetor#k \ufffd basicamente um item invocado que aumenta dr\ufffdsticamente as habilidades dos monstros invocados pelo seu grupo. Protetor funciona enquanto n\ufffdo for demolido pelo grupo oposto, ent\ufffdo eu surigo que voc\ufffd invoque v\ufffdrios monstros primeiro, e ent\ufffdo traga o Protetor.\");\n+                    cm.sendNext(\"#bProtetor#k basically an invoked item that drastically increases the abilities of the monsters invoked by your group. Protector works until it is demolished by the opposing group, so I'm hoping you'll summon several monsters first, and then bring the Protector.\");\n                 }\n             } else if (status == 66) {\n-                cm.sendNext(\"Por \ufffdltimo, enquanto estiver na Folia de Monstros, #bvoc\ufffd n\ufffdo pode usar items/po\ufffd\ufffdes de recupera\ufffd\ufffdo que voc\ufffd leva por ai contigo.#k Entretanto, os monstros deixam esses items cair de vez em quando, e #bassim que peg\ufffd-los, o item ativar\ufffd imediatamente#k. \ufffd por isso que \ufffd importante saber quando pegar estes items.\");\n+                cm.sendNext(\"Lastly, while in the Monster Carnival, #byou can not use items / recovery potions that you carry around with you. #kMeanwhile, the monsters let these items fall for good. when, and when you #bget them, the item will immediately activate#k. That's why it's important to know when to get these items.\");\n                 cm.dispose();\n             } else if (status == 77) {\n                 var allDone;"}, {"sha": "e93563a233336aa2adefe471c9652b310b67b0b2", "filename": "scripts/npc/2042000_old.js", "status": "removed", "additions": 0, "deletions": 53, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042000_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5/scripts/npc/2042000_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000_old.js?ref=3bdf8cb2be5f0b232c586acb2b341d8d4eafeba5", "patch": "@@ -1,53 +0,0 @@\n-/*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-var status = 0;\n-\n-function start() {\n-    if (cm.getPlayer().getParty() != null)\n-        cm.sendCPQMapLists();\n-    else {\n-        cm.sendOk(\"You must be in a party!\");\n-        cm.dispose();\n-    }\n-}\n-\n-function action(mode, type, selection) {\n-    if (mode < 1)\n-        cm.dispose();\n-    else {\n-        status++;\n-        if (status == 1) {\n-            if (cm.fieldTaken(selection)) {\n-                if (cm.fieldLobbied(selection)) {\n-                    cm.challengeParty(selection);\n-                    cm.dispose();\n-                } else {\n-                    cm.sendOk(\"The room is taken.\");\n-                    cm.dispose();\n-                }\n-            } else {\n-                cm.cpqLobby(selection);\n-                cm.dispose();\n-            }\n-        }\n-    }\n-}\n\\ No newline at end of file"}, {"sha": "d055d281e2a809ca72e641533f7b6ab97540edc6", "filename": "scripts/npc/2042001.js", "status": "modified", "additions": 449, "deletions": 71, "changes": 520, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042001.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,90 +1,468 @@\n-/*\n-    This file is part of the HeavenMS MapleStory Server\n-    Copyleft (L) 2016 - 2018 RonanLana\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-/* Spiegelmann\n-        Refining NPC: \n-\t* Auto ore refiner\n-        * \n-        * @author RonanLana\n-*/\n-\n-var status;\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Ronan (HeavenMS)\n+        3.0 - Third Version by Jayd - translated CPQ contents to English & added Pirate items\n+---------------------------------------------------------------------------------------------------\n+**/\n+\n+var status = 0;\n+var rnk = -1;\n+var n1 = 50; //???\n+var n2 = 40; //??? ???\n+var n3 = 7; //35\n+var n4 = 10; //40\n+var n5 = 20; //50\n+\n+var cpqMap = 980000000;\n+var cpqMinLvl = 30;\n+var cpqMaxLvl = 50;\n+var cpqMinAmt = 2;\n+var cpqMaxAmt = 6;\n+\n+// Ronan's custom ore refiner NPC\n var refineRocks = true;     // enables moon rock, star rock\n var refineCrystals = true;  // enables common crystals\n var refineSpecials = true;  // enables lithium, special crystals\n var feeMultiplier = 7.0;\n- \n+\n function start() {\n-        status = -1;\n-        action(1, 0, 0);\n+    status = -1;\n+    \n+    if (!Packages.constants.ServerConstants.USE_CPQ) {\n+        if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+            status = 0;\n+            action(1, 0, 4);\n+        } else {\n+            cm.sendOk(\"The Monster Carnival is currently unavailable.\");\n+            cm.dispose();\n+        }\n+        \n+        return;\n+    }\n+    \n+    action(1, 0, 0);\n }\n \n function action(mode, type, selection) {\n-        if (mode == -1) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (status >= 0 && mode == 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        \n+        if (cm.getPlayer().getMapId() == 980000010) {\n+            if (status == 0) {\n+                cm.sendNext(\"I hope you had fun at the Monster Carnival!\");\n+            } else if (status > 0) {\n+                cm.warp(980000000, 0);\n                 cm.dispose();\n-        } else {\n-                if (mode == 0 && type > 0) {\n+            }\n+        } else if (cm.getChar().getMap().isCPQLoserMap()) {\n+            if (status == 0) {\n+                if (cm.getChar().getParty() != null) {\n+                    var shiu = \"\";\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n+                        shiu += \"#rA#k\";\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle despite your excellent performance. Victory can be yours next time! \\r\\n\\r\\n#bYour result: \" + shiu);\n+                        rnk = 10;\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                        shiu += \"#rB#k\";\n+                        rnk = 20;\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle, even with your ultimate performance. Just a little bit, and the victory could have been yours! \\r\\n\\r\\n#bYour result: \" + shiu);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n+                        shiu += \"#rC#k\";\n+                        rnk = 30;\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle. Victory is for those who strive. I see your efforts, so victory is not far from your reach. Keep it up!\\r\\n\\r\\n#bYour result: \" + shiu);\n+                    } else {\n+                        shiu += \"#rD#k\";\n+                        rnk = 40;\n+                        cm.sendOk(\"Unfortunately, you either equalized or lost the battle, and your performance clearly reflects on it. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shiu);\n+                    }\n+                } else {\n+                    cm.warp(980000000, 0);\n+                    cm.dispose();\n+                }\n+            } else if (status == 1) {\n+                switch (rnk) {\n+                    case 10:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(17500);\n                         cm.dispose();\n-                        return;\n+                        break;\n+                    case 20:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(1200);\n+                        cm.dispose();\n+                        break;\n+                    case 30:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(5000);\n+                        cm.dispose();\n+                        break;\n+                    case 40:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(2500);\n+                        cm.dispose();\n+                        break;\n+                    default:\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        break;\n                 }\n-                if (mode == 1)\n-                        status++;\n-                else\n-                        status--;\n-    \n-                if(status == 0) {\n-                        var selStr = \"The Monster Carnival is currently unavailable, but instead I offer a steadfast #bore refining#k service for you, taxing #r\" + ((feeMultiplier * 100) | 0) + \"%#k over the usual fee to synthetize them. What will you do?#b\";\n-                        \n-                        var options = new Array(\"Refine mineral ores\",\"Refine jewel ores\");\n-                        if(refineCrystals) {\n-                            options.push(\"Refine crystal ores\");\n-                        }\n-                        if(refineRocks) {\n-                            options.push(\"Refine plates/jewels\");\n-                        }\n-                        \n-                        for (var i = 0; i < options.length; i++){\n-                            selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n-                        }\n-                        \n-                        cm.sendSimple(selStr);\n-                } else if(status == 1) {\n-                        var allDone;\n-                        \n-                        if (selection == 0) {\n-                                allDone = refineItems(0); // minerals\n-                        } else if (selection == 1) {\n-                                allDone = refineItems(1); // jewels\n-                        } else if (selection == 2 && refineCrystals) {\n-                                allDone = refineItems(2); // crystals\n-                        } else if (selection == 2 && !refineCrystals || selection == 3) {\n-                                allDone = refineRockItems(); // moon/star rock\n+            }\n+        } else if (cm.getChar().getMap().isCPQWinnerMap()) {\n+            if (status == 0) {\n+                if (cm.getChar().getParty() != null) {\n+                    var shi = \"\";\n+                    if (cm.getPlayer().getFestivalPoints() >= 300) {\n+                        shi += \"#rA#k\";\n+                        rnk = 1;\n+                        cm.sendOk(\"Congratulations on your victory!!! What a performance! The opposite group could not do anything! I hope the same good work next time! \\r\\n\\r\\n#bYour result: \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n+                        shi += \"#rB#k\";\n+                        rnk = 2;\n+                        cm.sendOk(\"Congratulations on your victory! That was awesome! You did a good job against the opposing group! Just a little longer, and you'll definitely get an A next time! \\r\\n\\r\\n#bYour result: \" + shi);\n+                    } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n+                        shi += \"#rC#k\";\n+                        rnk = 3;\n+                        cm.sendOk(\"Congratulations on your victory. You did some things here and there, but that can not be considered a good victory. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shi);\n+                    } else {\n+                        shi += \"#rD#k\";\n+                        rnk = 4;\n+                        cm.sendOk(\"Congratulations on your victory, though your performance did not quite reflect that. Be more active in your next participation in the Monster Carnival! \\r\\n\\r\\n#bYour result: \" + shi);\n+                    }\n+                } else {\n+                    cm.warp(980000000, 0);\n+                    cm.dispose();\n+                }\n+            } else if (status == 1) {\n+                switch (rnk) {\n+                    case 1:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(50000);\n+                        cm.dispose();\n+                        break;\n+                    case 2:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(25500);\n+                        cm.dispose();\n+                        break;\n+                    case 3:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(21000);\n+                        cm.dispose();\n+                        break;\n+                    case 4:\n+                        cm.warp(980000000, 0);\n+                        cm.gainExp(19505);\n+                        cm.dispose();\n+                        break;\n+                    default:\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        break;\n+                }\n+            }\n+        } else if (cm.getMapId() == cpqMap) {   // only CPQ1\n+            if (status == 0) {\n+                if (cm.getParty() == null) {\n+                    status = 10;\n+                    cm.sendOk(\"You need to create a party first before you can join the battle!\");\n+                } else if (!cm.isLeader()) {\n+                    status = 10;\n+                    cm.sendOk(\"If you want to start the battle, let the #bParty Leader#k talk to me.\");\n+                } else {\n+                    var party = cm.getParty().getMembers();\n+                    var inMap = cm.partyMembersInMap();\n+                    var lvlOk = 0;\n+                    var isOutMap = 0;\n+                    for (var i = 0; i < party.size(); i++) {\n+                        if (party.get(i).getLevel() >= cpqMinLvl && party.get(i).getLevel() <= cpqMaxLvl) {\n+                            lvlOk++;\n+\n+                            if (party.get(i).getPlayer().getMapId() != cpqMap) {\n+                                isOutMap++;\n+                            }\n                         }\n-                        \n-                        if(allDone) {\n-                            cm.sendOk(\"Done. Thanks for showing up~.\");\n-                        } else {\n-                            cm.sendOk(\"Done. Be aware some of the items could not be synthetized because either you have a lack of space on your ETC inventory or there's not enough mesos to cover the fee.\");\n+                    }\n+\n+                    if (party >= 1) {\n+                        status = 10;\n+                        cm.sendOk(\"You do not have enough people in your party. You need a party with #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k members and they should be on the map with you.\");\n+                    } else if (lvlOk != inMap) {\n+                        status = 10;\n+                        cm.sendOk(\"Make sure everyone in your party is among the correct levels (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                    } else if (isOutMap > 0) {\n+                        status = 10;\n+                        cm.sendOk(\"There are some of the party members that is not on the map!\");\n+                    } else {\n+                        if (!cm.sendCPQMapLists()) {\n+                            cm.sendOk(\"All Monster Carnival fields are currently in use! Try again later.\");\n+                            cm.dispose();\n                         }\n+                    }\n+                }\n+            } else if (status == 1) {\n+                if (cm.fieldTaken(selection)) {\n+                    if (cm.fieldLobbied(selection)) {\n+                        cm.challengeParty(selection);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"The room is currently full.\");\n                         cm.dispose();\n+                    }\n+                } else {\n+                    var party = cm.getParty().getMembers();\n+                    if ((selection >= 0 && selection <= 3) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 2)) {\n+                        cm.sendOk(\"You need at least 2 players to participate in the battle!\");\n+                    } else if ((selection >= 4 && selection <= 5) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 3)) {\n+                        cm.sendOk(\"You need at least 3 players to participate in the battle!\");\n+                    } else {\n+                        cm.cpqLobby(selection);\n+                    }\n+                    cm.dispose();\n                 }\n+            } else if (status == 11) {\n+                cm.dispose();\n+            }\n+        } else {\n+            if (status == 0) {\n+                var talk = \"What would you like to do? If you have never participate in the Monster Carnival, you will need to know a few things before participating! \\r\\n#b#L0# Go to the Monster Carnival 1.#l \\r\\n#L3# Go to the Monster Carnival 2.#l \\r\\n#L1# Learn about the Monster Carnival.#l\\r\\n#L2# Trade #t4001129#.#l\";\n+                if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                    talk += \"\\r\\n#L4# ... Can I just refine my ores?#l\";\n+                }\n+                cm.sendSimple(talk);\n+            } else if (status == 1) {\n+                if (selection == 0) {\n+                    if ((cm.getLevel() > 29 && cm.getLevel() < 51) || cm.getPlayer().isGM()) {\n+                        cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n+                        cm.warp(980000000, 0);\n+                        cm.dispose();\n+                        return;\n+                    } else if (cm.getLevel() < 30) {\n+                        cm.sendOk(\"You must be at least level 30 to participate in the Monster Carnival. Talk to me when you're strong enough.\");\n+                        cm.dispose();\n+                        return;\n+                    } else {\n+                        cm.sendOk(\"I'm sorry, but only players of level 30 ~ 50 can participate in the Monster Carnival.\");\n+                        cm.dispose();\n+                        return;\n+                    }\n+                } else if (selection == 1) {\n+                    status = 60;\n+                    cm.sendSimple(\"What would you like to do?\\r\\n#b#L0# What is Monster Carnival?#l\\r\\n#L1# Overview of the Monster Carnival.#l\\r\\n#L2# Detailed information about the Monster Carnival.#l\\r\\n#L3# Nothing really, I've changed my mind.#l\");\n+                } else if (selection == 2) {\n+                    cm.sendSimple(\"Remember, if you have #t4001129#, you can exchange for items. Select the item you would like to change them! \\r\\n#b#L0# #t1122007# (\" + n1 + \" coins)#l\\r\\n#L1# #t2041211# (\" + n2 + \" coins)#l\\r\\n#L2# Weapons for Warriors#l\\r\\n#L3# Weapons for Magician#l\\r\\n#L4# Weapons for Archers#l\\r\\n#L5# Weapons for Thief#l\\r\\n#L6# Weapons for Pirate#l\");\n+                } else if (selection == 3) {\n+                    cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n+                    cm.warp(980030000, 0);\n+                    cm.dispose();\n+                    return;\n+                } else if (selection == 4) {\n+                    var selStr = \"Very well, instead I offer a steadfast #bore refining#k service for you, taxing #r\" + ((feeMultiplier * 100) | 0) + \"%#k over the usual fee to synthetize them. What will you do?#b\";\n+\n+                    var options = new Array(\"Refine mineral ores\",\"Refine jewel ores\");\n+                    if(refineCrystals) {\n+                        options.push(\"Refine crystal ores\");\n+                    }\n+                    if(refineRocks) {\n+                        options.push(\"Refine plates/jewels\");\n+                    }\n+\n+                    for (var i = 0; i < options.length; i++){\n+                        selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n+                    }\n+\n+                    cm.sendSimple(selStr);\n+                    \n+                    status = 76;\n+                }\n+            } else if (status == 2) {\n+                select = selection;\n+                if (select == 0) {\n+                    if (cm.haveItem(4001129, n1) && cm.canHold(4001129)) {\n+                        cm.gainItem(1122007, 1);\n+                        cm.gainItem(4001129, -n1);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your EQUIP inventory is full.\");\n+                        cm.dispose();\n+                    }\n+                } else if (select == 1) {\n+                    if (cm.haveItem(4001129, n2) && cm.canHold(2041211)) {\n+                        cm.gainItem(2041211, 1);\n+                        cm.gainItem(4001129, -n2);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your USE inventory is full.\");\n+                        cm.dispose();\n+                    }\n+                } else if (select == 2) {//S2 Warrior 26 S3 Magician 6 S4 Bowman 6 S5 Thief 8\n+                    status = 10;\n+                    cm.sendSimple(\"Please make sure you have # t4001129 # for the weapon you want. Select the weapon you would like to trade # t4001129 #. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page (1/2)#l\");\n+                } else if (select == 3) {\n+                    status = 20;\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1372001# (\" + n3 + \" coins)#l\\r\\n#L1# #z1382018# (\" + n3 + \" coins)#l\\r\\n#L2# #z1372012# (\" + n4 + \" coins)#l\\r\\n#L3# #z1382019# (\" + n4 + \" coins)#l\\r\\n#L4# #z1382001# (\" + n5 + \" coins)#l\\r\\n#L5# #z1372007# (\" + n5 + \" coins)#l\");\n+                } else if (select == 4) {\n+                    status = 30;\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1452006# (\" + n3 + \" coins)#l\\r\\n#L1# #z1452007# (\" + n4 + \" coins)#l\\r\\n#L2# #z1452008# (\" + n5 + \" coins)#l\\r\\n#L3# #z1462005# (\" + n3 + \" coins)#l\\r\\n#L4# #z1462006# (\" + n4 + \" coins)#l\\r\\n#L5# #z1462007# (\" + n5 + \" coins)#l\");\n+                } else if (select == 5) {\n+                    status = 40;\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1472013# (\" + n3 + \" coins)#l\\r\\n#L1# #z1472017# (\" + n4 + \" coins)#l\\r\\n#L2# #z1472021# (\" + n5 + \" coins)#l\\r\\n#L3# #z1332014# (\" + n3 + \" coins)#l\\r\\n#L4# #z1332031# (\" + n4 + \" coins)#l\\r\\n#L5# #z1332011# (\" + n4 + \" coins)#l\\r\\n#L6# #z1332016# (\" + n5 + \" coins)#l\\r\\n#L7# #z1332003# (\" + n5 + \" coins)#l\");\n+                } else if (select == 6) {\n+                    status = 50; //pirate rewards\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1482005# (\" + n3 + \" coins)#l \\r\\n#b#L1# #z1482006# (\" + n4 + \" coins)#l \\r\\n#b#L2# #z1482007# (\" + n5 + \" coins)#l \\r\\n#b#L3# #z1492005# (\" + n3 + \" coins)#l \\r\\n#b#L4# #z1492006# (\" + n4 + \" coins)#l \\r\\n#b#L5# #z1492007# (\" + n5 + \" coins)#l\");\n+                }\n+            } else if (status == 11) {\n+                if (selection == 12) {\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely useful. Take a look! \\r\\n#b#L0# #z1322015# (\" + n3 + \" coins)#l\\r\\n#L1# #z1422008# (\" + n3 + \" coins)#l\\r\\n#L2# #z1322016# (\" + n4 + \" coins)#l\\r\\n#L3# #z1422007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1322017# (\" + n5 + \" coins)#l\\r\\n#L5# #z1422005# (\" + n5 + \" coins)#l\\r\\n#L6# #z1432003# (\" + n3 + \" coins)#l\\r\\n#L7# #z1442003# (\" + n3 + \" coins)#l\\r\\n#L8# #z1432005# (\" + n4 + \" coins)#l\\r\\n#L9# #z1442009# (\" + n4 + \" coins)#l\\r\\n#L10# #z1442005# (\" + n5 + \" coins)#l\\r\\n#L11# #z1432004# (\" + n5 + \" coins)#l\\r\\n#L12# Back to the first page (2/2)#l\");\n+                } else {\n+                    var item = new Array(1302004, 1402006, 1302009, 1402007, 1302010, 1402003, 1312006, 1412004, 1312007, 1412005, 1312008, 1412003);\n+                    var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5);\n+                    if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                        cm.gainItem(item[selection], 1);\n+                        cm.gainItem(4001129, -cost[selection]);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                        cm.dispose();\n+                    }\n+                }\n+            } else if (status == 12) {\n+                if (selection == 12) {\n+                    status = 10;\n+                    cm.sendSimple(\"Please make sure you have #b#t4001129##k for the weapon you want. Select the weapon you would like to trade #t4001129#. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page(1/2)#l\");\n+                } else {\n+                    var item = new Array(1322015, 1422008, 1322016, 1422007, 1322017, 1422005, 1432003, 1442003, 1432005, 1442009, 1442005, 1432004);\n+                    var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5, n5);\n+                    if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                        cm.gainItem(item[selection], 1);\n+                        cm.gainItem(4001129, -cost[selection]);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                        cm.dispose();\n+                    }\n+                }\n+            } else if (status == 21) {\n+                var item = new Array(1372001, 1382018, 1372012, 1382019, 1382001, 1372007);\n+                var cost = new Array(n3, n3, n4, n4, n5, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 31) {\n+                var item = new Array(1452006, 1452007, 1452008, 1462005, 1462006, 1462007);\n+                var cost = new Array(n3, n4, n5, n3, n4, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 41) {\n+                var item = new Array(1472013, 1472017, 1472021, 1332014, 1332031, 1332011, 1332016, 1332003);\n+                var cost = new Array(n3, n4, n5, n3, n4, n4, n5, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 51) {\n+                var item = new Array(1482005, 1482006, 1482007, 1492005, 1492006, 1492007);\n+                var cost = new Array(n3, n4, n5, n3, n4, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 61) {\n+                select = selection;\n+                if (selection == 0) {\n+                    cm.sendNext(\"Haha! I am Spiegelmann, the leader of this Monster Carnival. I got the first #bMonster Carnival#k here, waiting for travelers like you to take part in this extravaganza!\");\n+                } else if (selection == 1) {\n+                    cm.sendNext(\"#bMonster Carnival#k consists of 2 groups entering the battlefield, and dropping the monsters invoked by the other party. #bA combat brigade that determines the victor by the amount of Carnival Points (CP) received#k.\");\n+                } else if (selection == 2) {\n+                    cm.sendNext(\"When you enter the Carnival Field, you will see the Monster List window appear. All you need to do is #bselect what you want to use, and press OK#k. Very easy, right?\");\n+                } else {\n+                    cm.dispose();\n+                }\n+            } else if (status == 62) {\n+                if (select == 0) {\n+                    cm.sendNext(\"What is #bMonster Carnival#k? Hahaha! Let's say it's an experience you'll never forget! It's a battle against other travelers just like you!#k\");\n+                } else if (select == 1) {\n+                    cm.sendNext(\"When entering the Carnival Field, your task is to #breceive CP by killing the monsters from the opposite group, and using these CP's to distract the opposing group from hitting monsters#k.\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"Once you get used to the commands, try using #bTAB and F1 ~ F12#k. #bTAB toggles between Monster Invocation / Skills / Protector#k, and, #bF1 ~ F12 enables you to access one of the windows directly#k.\");\n+                }\n+            } else if (status == 63) {\n+                if (select == 0) {\n+                    cm.sendNext(\"I know it's too dangerous for you to fight with each other using real weapons; and I would not suggest such a barbaric act. Not my friend, what I offer to the competition. The excitement of the battle and the excitement of competing against such strong and motivated people. I offer the premise that your group and the opposite group both #binvoquem the monsters, and defeat the monsters invoked by the opposing group. This is the essence of the Monster Carnival. In addition, you can use Maple Coins earned during the Monster Carnival to get new items and weapons! #k\");\n+                } else if (select == 1) {\n+                    cm.sendNext(\"There are 3 ways to distract the opposing group: #bSummoning a monster, Ability, and Protector#k. I will give you a more in-depth look if you want to know more about 'detailed instructions'!\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bSummoning#k a Monster calls a monster that attacks the opposing party, under its control. Use CP to bring an Summoned Monster, and it will appear in the same area, attacking the opposing group.\");\n+                }\n+            } else if (status == 64) {\n+                if (select == 0) {\n+                    cm.sendNext(\"Of course, it's not that simple. There are other ways to prevent the other group from dropping monsters, and it's up to you to figure out how to do it. What do you think? Interested in a friendly competition?\");\n+                    cm.dispose();\n+                } else if (select == 1) {\n+                    cm.sendNext(\"Please remember. It's never a good idea to keep your CP's. #bThe CPs you used will help determine the winner and loser of Monster Carnival.\");\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bAbility#k is an option to use abilities such as Darkness, Weakness, and others to prevent the opposing group from killing other monsters. Not many CPs are needed, but it's worth it. The only problem is they do not last very long. Use this tactic wisely!\");\n+                }\n+            } else if (status == 65) {\n+                if (select == 1) {\n+                    cm.sendNext(\"Oh, and do not worry about turning into a ghost. In the Monster Carnival, #byou will not lose EXP after death#k. So it's really an experience like no other!\");\n+                    cm.dispose();\n+                } else if (select == 2) {\n+                    cm.sendNext(\"#bProtetor#k basically an invoked item that drastically increases the abilities of the monsters invoked by your group. Protector works until it is demolished by the opposing group, so I'm hoping you'll summon several monsters first, and then bring the Protector.\");\n+                }\n+            } else if (status == 66) {\n+                cm.sendNext(\"Lastly, while in the Monster Carnival, #byou can not use items / recovery potions that you carry around with you. #kMeanwhile, the monsters let these items fall for good. when, and when you #bget them, the item will immediately activate#k. That's why it's important to know when to get these items.\");\n+                cm.dispose();\n+            } else if (status == 77) {\n+                var allDone;\n+\n+                if (selection == 0) {\n+                    allDone = refineItems(0); // minerals\n+                } else if (selection == 1) {\n+                    allDone = refineItems(1); // jewels\n+                } else if (selection == 2 && refineCrystals) {\n+                    allDone = refineItems(2); // crystals\n+                } else if (selection == 2 && !refineCrystals || selection == 3) {\n+                    allDone = refineRockItems(); // moon/star rock\n+                }\n+\n+                if(allDone) {\n+                    cm.sendOk(\"Done. Thanks for showing up~.\");\n+                } else {\n+                    cm.sendOk(\"Done. Be aware some of the items #rcould not be synthetized#k because either you have a lack of space on your ETC inventory or there's not enough mesos to cover the fee.\");\n+                }\n+                cm.dispose();\n+            }\n         }\n+    }\n }\n \n function getRefineFee(fee) {"}, {"sha": "dac501d13b6c1dd5d36ee3a7a638b0ef3f009b7d", "filename": "scripts/npc/2042002.js", "status": "modified", "additions": 144, "deletions": 42, "changes": 186, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042002.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,3 +1,10 @@\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Ronan (HeavenMS)\n+        3.0 - Third Version by Jayd - translated CPQ contents to English & added Pirate items\n+---------------------------------------------------------------------------------------------------\n+**/\n \n var status = 0;\n var rnk = -1;\n@@ -7,6 +14,12 @@ var n3 = 7; //35\n var n4 = 10; //40\n var n5 = 20; //50\n \n+var cpqMap = 980000000;\n+var cpqMinLvl = 30;\n+var cpqMaxLvl = 50;\n+var cpqMinAmt = 2;\n+var cpqMaxAmt = 6;\n+\n // Ronan's custom ore refiner NPC\n var refineRocks = true;     // enables moon rock, star rock\n var refineCrystals = true;  // enables common crystals\n@@ -15,6 +28,19 @@ var feeMultiplier = 7.0;\n \n function start() {\n     status = -1;\n+    \n+    if (!Packages.constants.ServerConstants.USE_CPQ) {\n+        if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+            status = 0;\n+            action(1, 0, 4);\n+        } else {\n+            cm.sendOk(\"The Monster Carnival is currently unavailable.\");\n+            cm.dispose();\n+        }\n+        \n+        return;\n+    }\n+    \n     action(1, 0, 0);\n }\n \n@@ -33,7 +59,7 @@ function action(mode, type, selection) {\n         \n         if (cm.getPlayer().getMapId() == 980000010) {\n             if (status == 0) {\n-                cm.sendNext(\"Eu espero que voc\ufffd tenha divertido na Folia dos Monstros!\");\n+                cm.sendNext(\"I hope you had fun at the Monster Carnival!\");\n             } else if (status > 0) {\n                 cm.warp(980000000, 0);\n                 cm.dispose();\n@@ -44,20 +70,20 @@ function action(mode, type, selection) {\n                     var shiu = \"\";\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shiu += \"#rA#k\";\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle despite your excellent performance. Victory can be yours next time! \\r\\n\\r\\n#bYour result: \" + shiu);\n                         rnk = 10;\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shiu += \"#rB#k\";\n                         rnk = 20;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle, even with your ultimate performance. Just a little bit, and the victory could have been yours! \\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shiu += \"#rC#k\";\n                         rnk = 30;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle. Victory is for those who strive. I see your efforts, so victory is not far from your reach. Keep it up!\\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else {\n                         shiu += \"#rD#k\";\n                         rnk = 40;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either equalized or lost the battle, and your performance clearly reflects on it. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shiu);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -98,19 +124,19 @@ function action(mode, type, selection) {\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shi += \"#rA#k\";\n                         rnk = 1;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory!!! What a performance! The opposite group could not do anything! I hope the same good work next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shi += \"#rB#k\";\n                         rnk = 2;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory! That was awesome! You did a good job against the opposing group! Just a little longer, and you'll definitely get an A next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shi += \"#rC#k\";\n                         rnk = 3;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory. You did some things here and there, but that can not be considered a good victory. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else {\n                         shi += \"#rD#k\";\n                         rnk = 4;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory, though your performance did not quite reflect that. Be more active in your next participation in the Monster Carnival! \\r\\n\\r\\n#bYour result: \" + shi);\n                     }\n                 } else {\n                     cm.warp(980000000, 0);\n@@ -144,9 +170,71 @@ function action(mode, type, selection) {\n                         break;\n                 }\n             }\n+        } else if (cm.getMapId() == cpqMap) {   // only CPQ1\n+            if (status == 0) {\n+                if (cm.getParty() == null) {\n+                    status = 10;\n+                    cm.sendOk(\"You need to create a party first before you can join the battle!\");\n+                } else if (!cm.isLeader()) {\n+                    status = 10;\n+                    cm.sendOk(\"If you want to start the battle, let the #bParty Leader#k talk to me.\");\n+                } else {\n+                    var party = cm.getParty().getMembers();\n+                    var inMap = cm.partyMembersInMap();\n+                    var lvlOk = 0;\n+                    var isOutMap = 0;\n+                    for (var i = 0; i < party.size(); i++) {\n+                        if (party.get(i).getLevel() >= cpqMinLvl && party.get(i).getLevel() <= cpqMaxLvl) {\n+                            lvlOk++;\n+\n+                            if (party.get(i).getPlayer().getMapId() != cpqMap) {\n+                                isOutMap++;\n+                            }\n+                        }\n+                    }\n+\n+                    if (party >= 1) {\n+                        status = 10;\n+                        cm.sendOk(\"You do not have enough people in your party. You need a party with #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k members and they should be on the map with you.\");\n+                    } else if (lvlOk != inMap) {\n+                        status = 10;\n+                        cm.sendOk(\"Make sure everyone in your party is among the correct levels (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                    } else if (isOutMap > 0) {\n+                        status = 10;\n+                        cm.sendOk(\"There are some of the party members that is not on the map!\");\n+                    } else {\n+                        if (!cm.sendCPQMapLists()) {\n+                            cm.sendOk(\"All Monster Carnival fields are currently in use! Try again later.\");\n+                            cm.dispose();\n+                        }\n+                    }\n+                }\n+            } else if (status == 1) {\n+                if (cm.fieldTaken(selection)) {\n+                    if (cm.fieldLobbied(selection)) {\n+                        cm.challengeParty(selection);\n+                        cm.dispose();\n+                    } else {\n+                        cm.sendOk(\"The room is currently full.\");\n+                        cm.dispose();\n+                    }\n+                } else {\n+                    var party = cm.getParty().getMembers();\n+                    if ((selection >= 0 && selection <= 3) && party.size() < 1) {\n+                        cm.sendOk(\"You need at least 2 players to participate in the battle!\");\n+                    } else if ((selection >= 4 && selection <= 5) && party.size() < 1) {\n+                        cm.sendOk(\"You need at least 3 players to participate in the battle!\");\n+                    } else {\n+                        cm.cpqLobby(selection);\n+                    }\n+                    cm.dispose();\n+                }\n+            } else if (status == 11) {\n+                cm.dispose();\n+            }\n         } else {\n             if (status == 0) {\n-                var talk = \"O que gostaria de fazer? Se voc\ufffd nunca participou da Folia de Monstros, voc\ufffd precisar\ufffd saber de algumas coisas antes de participar.\\r\\n#b#L0# Ir para o campo da Folia de Monstros 1.#l\\r\\n#L3# Ir para o campo da Folia de Monstros 2.#l\\r\\n#L1# Aprender sobre a Folia de Monstros.#l\\r\\n#L2# Trocar #t4001129#.#l\";\n+                var talk = \"What would you like to do? If you have never participate in the Monster Carnival, you will need to know a few things before participating! \\r\\n#b#L0# Go to the Monster Carnival 1.#l \\r\\n#L3# Go to the Monster Carnival 2.#l \\r\\n#L1# Learn about the Monster Carnival.#l\\r\\n#L2# Trade #t4001129#.#l\";\n                 if (Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n                     talk += \"\\r\\n#L4# ... Can I just refine my ores?#l\";\n                 }\n@@ -159,19 +247,19 @@ function action(mode, type, selection) {\n                         cm.dispose();\n                         return;\n                     } else if (cm.getLevel() < 30) {\n-                        cm.sendOk(\"Voc\ufffd precisa ser no m\ufffdnimo n\ufffdvel 30 para participar da Folia de Monstros. Fale comigo quando for forte o bastante.\");\n+                        cm.sendOk(\"You must be at least level 30 to participate in the Monster Carnival. Talk to me when you're strong enough.\");\n                         cm.dispose();\n                         return;\n                     } else {\n-                        cm.sendOk(\"Sinto muito, mas apenas os jogadores de n\ufffdvel 30~50 podem participar da Folia de Monstros.\");\n+                        cm.sendOk(\"I'm sorry, but only players of level 30 ~ 50 can participate in the Monster Carnival.\");\n                         cm.dispose();\n                         return;\n                     }\n                 } else if (selection == 1) {\n                     status = 60;\n-                    cm.sendSimple(\"O que gostaria de fazer?\\r\\n#b#L0# O que \ufffd a Folia de Monstros?#l\\r\\n#L1# Vis\ufffdo geral sobre a Folia de Monstros#l\\r\\n#L2# Informa\ufffd\ufffdes detalhadas sobre a Folia de Monstros#l\\r\\n#L3# Nada, de verdade. Mudei de ideia.#l\");\n+                    cm.sendSimple(\"What would you like to do?\\r\\n#b#L0# What is Monster Carnival?#l\\r\\n#L1# Overview of the Monster Carnival.#l\\r\\n#L2# Detailed information about the Monster Carnival.#l\\r\\n#L3# Nothing really, I've changed my mind.#l\");\n                 } else if (selection == 2) {\n-                    cm.sendSimple(\"Lembre-se se voc\ufffd possui #t4001129#, voc\ufffd pode troc\ufffd-las por itens. Tenha certeza que voc\ufffd possui #t4001129# suficientes para o item que voc\ufffd deseja. Selecione o item que voc\ufffd gostaria de troc\ufffd-las! \\r\\n#b#L0# #t1122007#(\" + n1 + \" moedas)#l\\r\\n#L1# #t2041211#(\" + n2 + \" moedas)#l\\r\\n#L2# Armas para Guerreiros#l\\r\\n#L3# Armas para Bruxos#l\\r\\n#L4# Armas para Arqueiros#l\\r\\n#L5# Armas para Gatunos#l\");\n+                    cm.sendSimple(\"Remember, if you have #t4001129#, you can exchange for items. Select the item you would like to change them! \\r\\n#b#L0# #t1122007# (\" + n1 + \" coins)#l\\r\\n#L1# #t2041211# (\" + n2 + \" coins)#l\\r\\n#L2# Weapons for Warriors#l\\r\\n#L3# Weapons for Magician#l\\r\\n#L4# Weapons for Archers#l\\r\\n#L5# Weapons for Thief#l\\r\\n#L6# Weapons for Pirate#l\");\n                 } else if (selection == 3) {\n                     cm.getChar().saveLocation(\"MONSTER_CARNIVAL\");\n                     cm.warp(980030000, 0);\n@@ -204,7 +292,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n1);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Equipamentos est\ufffd cheio.\");\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your EQUIP inventory is full.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 1) {\n@@ -213,25 +301,28 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -n2);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Verifique e veja se est\ufffdo faltando #b#t4001129##k ou se seu invent\ufffdrio de Uso est\ufffd cheio.\");\n+                        cm.sendOk(\"Check and see if you are missing #b#t4001129##k or if your USE inventory is full.\");\n                         cm.dispose();\n                     }\n                 } else if (select == 2) {//S2 Warrior 26 S3 Magician 6 S4 Bowman 6 S5 Thief 8\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Please make sure you have #t4001129# for the weapon you want. Select the weapon you would like to trade #t4001129#. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page(1/2)#l\");\n                 } else if (select == 3) {\n                     status = 20;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1372001#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1382018#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1372012#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1382019#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1382001#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1372007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1372001# (\" + n3 + \" coins)#l\\r\\n#L1# #z1382018# (\" + n3 + \" coins)#l\\r\\n#L2# #z1372012# (\" + n4 + \" coins)#l\\r\\n#L3# #z1382019# (\" + n4 + \" coins)#l\\r\\n#L4# #z1382001# (\" + n5 + \" coins)#l\\r\\n#L5# #z1372007# (\" + n5 + \" coins)#l\");\n                 } else if (select == 4) {\n                     status = 30;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente atraentes. Veja voc\ufffd mesmo! \\r\\n#b#L0# #z1452006#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1452007#(\" + n4 + \" moedas)#l\\r\\n#L2# #z1452008#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1462005#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1462006#(\" + n4 + \" moedas)#l\\r\\n#L5# #z1462007#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely attractive. See for yourself! \\r\\n#b#L0# #z1452006# (\" + n3 + \" coins)#l\\r\\n#L1# #z1452007# (\" + n4 + \" coins)#l\\r\\n#L2# #z1452008# (\" + n5 + \" coins)#l\\r\\n#L3# #z1462005# (\" + n3 + \" coins)#l\\r\\n#L4# #z1462006# (\" + n4 + \" coins)#l\\r\\n#L5# #z1462007# (\" + n5 + \" coins)#l\");\n                 } else if (select == 5) {\n                     status = 40;\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar por. As armas que eu tenho s\ufffdo da maior qualidade. Seleciona a mais atraente para voc\ufffd! \\r\\n#b#L0# #z1472013#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1472017#(\" + n4 + \"moedas)#l\\r\\n#L2# #z1472021#(\" + n5 + \" moedas)#l\\r\\n#L3# #z1332014#(\" + n3 + \" moedas)#l\\r\\n#L4# #z1332031#(\" + n4 + \"moedas)#l\\r\\n#L5# #z1332011#(\" + n4 + \"moedas)#l\\r\\n#L6# #z1332016#(\" + n5 + \" moedas)#l\\r\\n#L7# #z1332003#(\" + n5 + \" moedas)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1472013# (\" + n3 + \" coins)#l\\r\\n#L1# #z1472017# (\" + n4 + \" coins)#l\\r\\n#L2# #z1472021# (\" + n5 + \" coins)#l\\r\\n#L3# #z1332014# (\" + n3 + \" coins)#l\\r\\n#L4# #z1332031# (\" + n4 + \" coins)#l\\r\\n#L5# #z1332011# (\" + n4 + \" coins)#l\\r\\n#L6# #z1332016# (\" + n5 + \" coins)#l\\r\\n#L7# #z1332003# (\" + n5 + \" coins)#l\");\n+                } else if (select == 6) {\n+                    status = 50; //pirate rewards\n+                    cm.sendSimple(\"Select the weapon you would like to trade for. The weapons I have are of the highest quality. Select the one most appealing to you! \\r\\n#b#L0# #z1482005# (\" + n3 + \" coins)#l \\r\\n#b#L1# #z1482006# (\" + n4 + \" coins)#l \\r\\n#b#L2# #z1482007# (\" + n5 + \" coins)#l \\r\\n#b#L3# #z1492005# (\" + n3 + \" coins)#l \\r\\n#b#L4# #z1492006# (\" + n4 + \" coins)#l \\r\\n#b#L5# #z1492007# (\" + n5 + \" coins)#l\");\n                 }\n             } else if (status == 11) {\n                 if (selection == 12) {\n-                    cm.sendSimple(\"Selecione a arma que voc\ufffd gostaria de trocar. As armas que eu tenho aqui s\ufffdo extremamente \ufffdteis. D\ufffd uma olhada! \\r\\n#b#L0# #z1322015#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1422008#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1322016#(\" + n4 + \"moedas)#l\\r\\n#L3# #z1422007#(\" + n4 + \"moedas)#l\\r\\n#L4# #z1322017#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1422005#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1432003#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1442003#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1432005#(\" + n4 + \"moedas)#l\\r\\n#L9# #z1442009#(\" + n4 + \"moedas)#l\\r\\n#L10# #z1442005#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1432004#(\" + n5 + \" moedas)#l\\r\\n#L12# Voltar para a p\ufffdgina inicial(2/2)#l\");\n+                    cm.sendSimple(\"Select the weapon you would like to trade. The weapons I have here are extremely useful. Take a look! \\r\\n#b#L0# #z1322015# (\" + n3 + \" coins)#l\\r\\n#L1# #z1422008# (\" + n3 + \" coins)#l\\r\\n#L2# #z1322016# (\" + n4 + \" coins)#l\\r\\n#L3# #z1422007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1322017# (\" + n5 + \" coins)#l\\r\\n#L5# #z1422005# (\" + n5 + \" coins)#l\\r\\n#L6# #z1432003# (\" + n3 + \" coins)#l\\r\\n#L7# #z1442003# (\" + n3 + \" coins)#l\\r\\n#L8# #z1432005# (\" + n4 + \" coins)#l\\r\\n#L9# #z1442009# (\" + n4 + \" coins)#l\\r\\n#L10# #z1442005# (\" + n5 + \" coins)#l\\r\\n#L11# #z1432004# (\" + n5 + \" coins)#l\\r\\n#L12# Back to the first page (2/2)#l\");\n                 } else {\n                     var item = new Array(1302004, 1402006, 1302009, 1402007, 1302010, 1402003, 1312006, 1412004, 1312007, 1412005, 1312008, 1412003);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5);\n@@ -240,14 +331,14 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                         cm.dispose();\n                     }\n                 }\n             } else if (status == 12) {\n                 if (selection == 12) {\n                     status = 10;\n-                    cm.sendSimple(\"Por favor tenha certeza que voc\ufffd possui #t4001129# para a arma que voc\ufffd deseja. Selecione a arma que voc\ufffd gostaria de trocar #t4001129# por. As op\ufffd\ufffdes que tenho s\ufffdo realmente boas, e eu n\ufffdo sou eu que falo \ufffd o povo que diz! \\r\\n#b#L0# #z1302004#(\" + n3 + \" moedas)#l\\r\\n#L1# #z1402006#(\" + n3 + \" moedas)#l\\r\\n#L2# #z1302009#(\" + n4 + \" moedas)#l\\r\\n#L3# #z1402007#(\" + n4 + \" moedas)#l\\r\\n#L4# #z1302010#(\" + n5 + \" moedas)#l\\r\\n#L5# #z1402003#(\" + n5 + \" moedas)#l\\r\\n#L6# #z1312006#(\" + n3 + \" moedas)#l\\r\\n#L7# #z1412004#(\" + n3 + \" moedas)#l\\r\\n#L8# #z1312007#(\" + n4 + \" moedas)#l\\r\\n#L9# #z1412005#(\" + n4 + \" moedas)#l\\r\\n#L10# #z1312008#(\" + n5 + \" moedas)#l\\r\\n#L11# #z1412003#(\" + n5 + \" moedas)#l\\r\\n#L12# Ir para a pr\ufffdxima p\ufffdgina(1/2)#l\");\n+                    cm.sendSimple(\"Please make sure you have #b#t4001129##k for the weapon you want. Select the weapon you would like to trade #t4001129#. The choices I have are really good, and I'm not the one who speaks to the people who say it! \\r\\n#b#L0# #z1302004# (\" + n3 + \" coins)#l\\r\\n#L1# #z1402006# (\" + n3 + \" coins)#l\\r\\n#L2# #z1302009# (\" + n4 + \" coins)#l\\r\\n#L3# #z1402007# (\" + n4 + \" coins)#l\\r\\n#L4# #z1302010# (\" + n5 + \" coins)#l\\r\\n#L5# #z1402003# (\" + n5 + \" coins)#l\\r\\n#L6# #z1312006# (\" + n3 + \" coins)#l\\r\\n#L7# #z1412004# (\" + n3 + \" coins)#l\\r\\n#L8# #z1312007# (\" + n4 + \" coins)#l\\r\\n#L9# #z1412005# (\" + n4 + \" coins)#l\\r\\n#L10# #z1312008# (\" + n5 + \" coins)#l\\r\\n#L11# #z1412003# (\" + n5 + \" coins)#l\\r\\n#L12# Continue to the next page(1/2)#l\");\n                 } else {\n                     var item = new Array(1322015, 1422008, 1322016, 1422007, 1322017, 1422005, 1432003, 1442003, 1432005, 1442009, 1442005, 1432004);\n                     var cost = new Array(n3, n3, n4, n4, n5, n5, n3, n3, n4, n4, n5, n5);\n@@ -256,7 +347,7 @@ function action(mode, type, selection) {\n                         cm.gainItem(4001129, -cost[selection]);\n                         cm.dispose();\n                     } else {\n-                        cm.sendOk(\"Voc\ufffd ou n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                        cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                         cm.dispose();\n                     }\n                 }\n@@ -268,7 +359,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 31) {\n@@ -279,7 +370,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 41) {\n@@ -290,54 +381,65 @@ function action(mode, type, selection) {\n                     cm.gainItem(4001129, -cost[selection]);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"Ou voc\ufffd n\ufffdo possui #b#t4001129##k suficientes, ou seu invent\ufffdrio est\ufffd cheio. Verifique novamente.\");\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n+                    cm.dispose();\n+                }\n+            } else if (status == 51) {\n+                var item = new Array(1482005, 1482006, 1482007, 1492005, 1492006, 1492007);\n+                var cost = new Array(n3, n4, n5, n3, n4, n5);\n+                if (cm.haveItem(4001129, cost[selection]) && cm.canHold(item[selection])) {\n+                    cm.gainItem(item[selection], 1);\n+                    cm.gainItem(4001129, -cost[selection]);\n+                    cm.dispose();\n+                } else {\n+                    cm.sendOk(\"You do not have enough #b#t4001129##k, or your inventory is full. Please check again.\");\n                     cm.dispose();\n                 }\n             } else if (status == 61) {\n                 select = selection;\n                 if (selection == 0) {\n-                    cm.sendNext(\"Haha! Eu sou Spiegelmann, o l\ufffdder dessa Folia. Eu comecei a primeira #bFolia de Monstros#k aqui, aguardando por viajantes como voc\ufffd para participar dessa extravaganza!\");\n+                    cm.sendNext(\"Haha! I am Spiegelmann, the leader of this Monster Carnival. I got the first #bMonster Carnival#k here, waiting for travelers like you to take part in this extravaganza!\");\n                 } else if (selection == 1) {\n-                    cm.sendNext(\"#bFolia de Monstros#k consiste em 2 grupos entrando no campo de batalha, e ca\ufffdando os monstros invocados pelo outro grupo. \ufffd uma #bmiss\ufffdo de combate que determina o vitorioso pela quantia de Pontos de Folia (CP) recebidos#k.\");\n+                    cm.sendNext(\"#bMonster Carnival#k consists of 2 groups entering the battlefield, and dropping the monsters invoked by the other party. #bA combat brigade that determines the victor by the amount of Carnival Points (CP) received#k.\");\n                 } else if (selection == 2) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, voc\ufffd ver\ufffd a janela da Folia de Monstros aparecer. Tudo que precisa fazer \ufffd #bselecionar o que voc\ufffde quer usar, e pressionar OK#k. Muito f\ufffdcil, n\ufffd?\");\n+                    cm.sendNext(\"When you enter the Carnival Field, you will see the Monster List window appear. All you need to do is #bselect what you want to use, and press OK#k. Very easy, right?\");\n                 } else {\n                     cm.dispose();\n                 }\n             } else if (status == 62) {\n                 if (select == 0) {\n-                    cm.sendNext(\"O que \ufffd a #bFolia de Monstros#k? Hahaha! Vamos dizer que \ufffd uma experi\ufffdncia que jamais esquecer\ufffd! \ufffd uma #bbatalha contra outros viajantes assim como voc\ufffd!#k\");\n+                    cm.sendNext(\"What is #bMonster Carnival#k? Hahaha! Let's say it's an experience you'll never forget! It's a battle against other travelers just like you!#k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Quando entrar no Campo da Folia, sua tarefa \ufffd #breceber CP ca\ufffdando os monstros do grupo oposto, e usar estes CP's para distrair o grupo oposto de ca\ufffdar monstros.#k.\");\n+                    cm.sendNext(\"When entering the Carnival Field, your task is to #breceive CP by killing the monsters from the opposite group, and using these CP's to distract the opposing group from hitting monsters#k.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"Assim que se acostumar com os comandos, tente usar #bas teclas TAB e F1 ~ F12#k. #bTAB alterna entre Invoca\ufffd\ufffdo de Monstros/Habilidades/Protetor,#k e, #bF1~ F12 possibilita-o de acessar uma das janelas diretamente#k.\");\n+                    cm.sendNext(\"Once you get used to the commands, try using #bTAB and F1 ~ F12#k. #bTAB toggles between Monster Invocation / Skills / Protector#k, and, #bF1 ~ F12 enables you to access one of the windows directly#k.\");\n                 }\n             } else if (status == 63) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Eu sei que \ufffd muito perigoso para voc\ufffds lutarem uns com os outros usando armas de verdade; e eu n\ufffdo sugeriria um ato t\ufffdo barb\ufffdrico. N\ufffdo meu amigo, o que eu ofere\ufffdo \ufffd competi\ufffd\ufffdo. A emo\ufffd\ufffdo da batalha e a emo\ufffd\ufffdo de competir contra pessoas t\ufffdo fortes e motivadas. Eu ofere\ufffdo a premissa de que seu grupo e o grupo oposto ambos #binvoquem os monstros, e derrote os monstros invocados pelo grupo advers\ufffdrio. Essa \ufffd a ess\ufffdncia da Folia de Monstros. Al\ufffdm disso, voc\ufffd pode usar Maple Coins ganhos durante a Folia de Monstros para obter novos itens e armas! #k\");\n+                    cm.sendNext(\"I know it's too dangerous for you to fight with each other using real weapons; and I would not suggest such a barbaric act. Not my friend, what I offer to the competition. The excitement of the battle and the excitement of competing against such strong and motivated people. I offer the premise that your group and the opposite group both #binvoquem the monsters, and defeat the monsters invoked by the opposing group. This is the essence of the Monster Carnival. In addition, you can use Maple Coins earned during the Monster Carnival to get new items and weapons! #k\");\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Existem 3 maneiras de distrair o grupo advers\ufffdrio: #bInvodar um monstro, Habilidade, and Protetor#k. Vou dar-lhe um olhar mais aprofundado, se voc\ufffd quiser saber mais sobre 'Instru\ufffd\ufffdes detalhadas'.\");\n+                    cm.sendNext(\"There are 3 ways to distract the opposing group: #bSummoning a monster, Ability, and Protector#k. I will give you a more in-depth look if you want to know more about 'detailed instructions'!\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bInvocar um Monstro#k chama um monstro que ataca o grupo advers\ufffdrio, sob seu controle. Use CP para trazer um Monstro Invocado, e ele ir\ufffd aparecer na mesma \ufffdrea, atacando o grupo oposto.\");\n+                    cm.sendNext(\"#bSummoning#k a Monster calls a monster that attacks the opposing party, under its control. Use CP to bring an Summoned Monster, and it will appear in the same area, attacking the opposing group.\");\n                 }\n             } else if (status == 64) {\n                 if (select == 0) {\n-                    cm.sendNext(\"Claro, n\ufffdo \ufffd t\ufffdo simples assim. Existem outras maneiras de prevenir o outro grupo de ca\ufffdar monstros, e cabe a voc\ufffd descobrir como faz\ufffd-lo. O que acha? Interessado em uma competi\ufffd\ufffdo amig\ufffdvel?\");\n+                    cm.sendNext(\"Of course, it's not that simple. There are other ways to prevent the other group from dropping monsters, and it's up to you to figure out how to do it. What do you think? Interested in a friendly competition?\");\n                     cm.dispose();\n                 } else if (select == 1) {\n-                    cm.sendNext(\"Por favor lembre-se. Nunca \ufffd uma boa ideia guardar seus CP's. #bOs CP's que voc\ufffd usou ir\ufffdo ajudar a determinar o vencedor e o perdedor da Folia.\");\n+                    cm.sendNext(\"Please remember. It's never a good idea to keep your CP's. #bThe CPs you used will help determine the winner and loser of Monster Carnival.\");\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bHabilidade#k \ufffd uma op\ufffd\ufffdo de usar habilidades tais como Escurid\ufffdo, Fraqueza, e outras para prevenir o grupo oposto de matar outros monstros. S\ufffdo necess\ufffdrios muitos CP's, mas vale muito a pena. O \ufffdnico problema \ufffd que eles n\ufffdo duram muito. Use essa t\ufffdtica com sabedoria!\");\n+                    cm.sendNext(\"#bAbility#k is an option to use abilities such as Darkness, Weakness, and others to prevent the opposing group from killing other monsters. Not many CPs are needed, but it's worth it. The only problem is they do not last very long. Use this tactic wisely!\");\n                 }\n             } else if (status == 65) {\n                 if (select == 1) {\n-                    cm.sendNext(\"Oh, e n\ufffdo se preocupe em tranformar-se em um fantasma. Na Folia de Monstros, #bvoc\ufffd n\ufffdo perder\ufffd EXP ap\ufffds a morte#k. \ufffd realmente uma exper\ufffdncia como nenhuma outra!\");\n+                    cm.sendNext(\"Oh, and do not worry about turning into a ghost. In the Monster Carnival, #byou will not lose EXP after death#k. So it's really an experience like no other!\");\n                     cm.dispose();\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bProtetor#k \ufffd basicamente um item invocado que aumenta dr\ufffdsticamente as habilidades dos monstros invocados pelo seu grupo. Protetor funciona enquanto n\ufffdo for demolido pelo grupo oposto, ent\ufffdo eu surigo que voc\ufffd invoque v\ufffdrios monstros primeiro, e ent\ufffdo traga o Protetor.\");\n+                    cm.sendNext(\"#bProtetor#k basically an invoked item that drastically increases the abilities of the monsters invoked by your group. Protector works until it is demolished by the opposing group, so I'm hoping you'll summon several monsters first, and then bring the Protector.\");\n                 }\n             } else if (status == 66) {\n-                cm.sendNext(\"Por \ufffdltimo, enquanto estiver na Folia de Monstros, #bvoc\ufffd n\ufffdo pode usar items/po\ufffd\ufffdes de recupera\ufffd\ufffdo que voc\ufffd leva por ai contigo.#k Entretanto, os monstros deixam esses items cair de vez em quando, e #bassim que peg\ufffd-los, o item ativar\ufffd imediatamente#k. \ufffd por isso que \ufffd importante saber quando pegar estes items.\");\n+                cm.sendNext(\"Lastly, while in the Monster Carnival, #byou can not use items / recovery potions that you carry around with you. #kMeanwhile, the monsters let these items fall for good. when, and when you #bget them, the item will immediately activate#k. That's why it's important to know when to get these items.\");\n                 cm.dispose();\n             } else if (status == 77) {\n                 var allDone;"}, {"sha": "d9cf1d2b6e67a49870ed8be4b86e9748bc5fbcb5", "filename": "scripts/npc/2042003.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042003.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -21,7 +21,7 @@ function action(mode, type, selection) {\n             status--;\n         if (status == 0) {\n             cm.warpParty(980000000);\n-            cm.cancelarSaida();\n+            cm.cancelCPQLobby();\n             cm.dispose();\n         }\n     }"}, {"sha": "84801867a75ab186c71253638f76e82f6528dac5", "filename": "scripts/npc/2042004.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042004.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -9,7 +9,7 @@ function start() {\n \n function action(mode, type, selection) {\n     cm.warpParty(980000000);\n-    cm.cancelarSaida();\n+    cm.cancelCPQLobby();\n     cm.dispose();\n }\n "}, {"sha": "04bb08c1fd59969a14af65a4012c209ba395bdf2", "filename": "scripts/npc/2042005.js", "status": "modified", "additions": 24, "deletions": 14, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042005.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,6 +1,13 @@\n-var cpqMinLvl = 30;\n-var cpqMaxLvl = 255;\n-var cpqMinAmt = 0;\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Jayd - translated CPQ contents to English\n+---------------------------------------------------------------------------------------------------\n+**/\n+\n+var cpqMinLvl = 51;\n+var cpqMaxLvl = 69;\n+var cpqMinAmt = 2;\n var cpqMaxAmt = 6;\n \n function start() {\n@@ -23,10 +30,10 @@ function action(mode, type, selection) {\n         if (status == 0) {\n             if (cm.getParty() == null) {\n                 status = 10;\n-                cm.sendOk(\"#e\ufffd necess\ufffdrio criar um grupo antes de come\ufffdar o Festival de Monstros!#k\");\n+                cm.sendOk(\"You need to create a party before you can participate in Monster Carnival!\");\n             } else if (!cm.isLeader()) {\n                 status = 10;\n-                cm.sendOk(\"Se voc\ufffd quer come\ufffdar o Festival, avise o #bl\ufffdder do grupo#k para falar comigo.\");\n+                cm.sendOk(\"If you want to start the battle, let the #bleader#k come and speak to me.\");\n             } else {\n                 var leaderMapid = cm.getMapId();\n                 var party = cm.getParty().getMembers();\n@@ -45,15 +52,18 @@ function action(mode, type, selection) {\n \n                 if (party >= 1) {\n                     status = 10;\n-                    cm.sendOk(\"Voc\ufffd n\ufffdo tem n\ufffdmero suficiente de pessoas em seu grupo. Voc\ufffd precisa de um grupo com #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k membros e eles devem estar no mapa com voc\ufffd.\");\n+                    cm.sendOk(\"You do not have enough people in your party. You need a party with #b\" + cpqMinAmt + \"#k - #r\" + cpqMaxAmt + \"#k members and they should be on the map with you.\");\n                 } else if (lvlOk != inMap) {\n                     status = 10;\n-                    cm.sendOk(\"Certifique se todos em seu grupo est\ufffdo dentre os n\ufffdveis corretos (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n+                    cm.sendOk(\"Make sure everyone in your party is among the correct levels (\" + cpqMinLvl + \"~\" + cpqMaxLvl + \")!\");\n                 } else if (isOutMap > 0) {\n                     status = 10;\n-                    cm.sendOk(\"Existe algu\ufffdm do grupo que n\ufffdo esta no mapa!\");\n+                    cm.sendOk(\"There are some of the party members that is not on the map!\");\n                 } else {\n-                    cm.sendCPQMapLists2();\n+                    if (!cm.sendCPQMapLists2()) {\n+                        cm.sendOk(\"All Monster Carnival fields are currently in use! Try again later.\");\n+                        cm.dispose();\n+                    }\n                 }\n             }\n         } else if (status == 1) {\n@@ -62,15 +72,15 @@ function action(mode, type, selection) {\n                     cm.challengeParty2(selection);\n                     cm.dispose();\n                 } else {\n-                    cm.sendOk(\"A sala esta cheia.\");\n+                    cm.sendOk(\"The room is currently full.\");\n                     cm.dispose();\n                 }\n             } else {\n                 var party = cm.getParty().getMembers();\n-                if ((selection === 0 || selection === 1 ) && party.size() < 1) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 2 player para entrar na competi\ufffd\ufffdo.\");\n-                } else if ((selection === 2 ) && party.size() < 1) {\n-                    cm.sendOk(\"Voc\ufffd precisa de no m\ufffdnimo 3 player para entrar na competi\ufffd\ufffdo.\");\n+                if ((selection === 0 || selection === 1 ) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 2)) {\n+                    cm.sendOk(\"You need at least 2 players to participate in the battle!\");\n+                } else if ((selection === 2 ) && party.size() < (Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS ? 1 : 3)) {\n+                    cm.sendOk(\"You need at least 3 players to participate in the battle!\");\n                 } else {\n                     cm.cpqLobby2(selection);\n                 }"}, {"sha": "e47fbcc0afa2618217dbc06253f78941973970a4", "filename": "scripts/npc/2042007.js", "status": "modified", "additions": 22, "deletions": 9, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042007.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,3 +1,9 @@\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Jayd - translated CPQ contents to English\n+---------------------------------------------------------------------------------------------------\n+**/\n \n var status = 0;\n var rnk = -1;\n@@ -21,26 +27,33 @@ function action(mode, type, selection) {\n         else\n             status--;\n         \n-        if (cm.getChar().getMap().isCPQLoserMap()) {\n+        if (cm.getPlayer().getMapId() == 980030010) {\n+            if (status == 0) {\n+                cm.sendNext(\"I hope you had fun at the Monster Carnival!\");\n+            } else if (status > 0) {\n+                cm.warp(980030000, 0);\n+                cm.dispose();\n+            }\n+        } else if (cm.getChar().getMap().isCPQLoserMap()) {\n             if (status == 0) {\n                 if (cm.getChar().getParty() != null) {\n                     var shiu = \"\";\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shiu += \"#rA#k\";\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, apesar da sua excelente performance. A vit\ufffdria pode ser sua da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle despite your excellent performance. Victory can be yours next time! \\r\\n\\r\\n#bYour result: \" + shiu);\n                         rnk = 10;\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shiu += \"#rB#k\";\n                         rnk = 20;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, mesmo com sua \ufffdtima performance. S\ufffd mais um pouquinho, e a vit\ufffdria poderia ter sido sua.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle, even with your ultimate performance. Just a little bit, and the victory could have been yours! \\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shiu += \"#rC#k\";\n                         rnk = 30;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha. A vit\ufffdria est\ufffd para aqueles que se esfor\ufffdam. Vejo seus esfor\ufffdos, ent\ufffdo a vit\ufffdria n\ufffdo est\ufffd t\ufffdo longe do seu alcance. Continue assim!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either drew or lost the battle. Victory is for those who strive. I see your efforts, so victory is not far from your reach. Keep it up!\\r\\n\\r\\n#bYour result: \" + shiu);\n                     } else {\n                         shiu += \"#rD#k\";\n                         rnk = 40;\n-                        cm.sendOk(\"Infelizmente, voc\ufffd ou empatou ou perdeu a batalha, e sua performance claramente reflete nisso. Espero mais de voc\ufffd da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shiu);\n+                        cm.sendOk(\"Unfortunately, you either equalized or lost the battle, and your performance clearly reflects on it. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shiu);\n                     }\n                 } else {\n                     cm.warp(980030000, 0);\n@@ -81,19 +94,19 @@ function action(mode, type, selection) {\n                     if (cm.getPlayer().getFestivalPoints() >= 300) {\n                         shi += \"#rA#k\";\n                         rnk = 1;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria!!! Que \ufffdtima performance! O grupo advers\ufffdrio n\ufffdo p\ufffdde fazer nada! Espero o mesmo bom trabalho da pr\ufffdxima vez!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory!!! What a performance! The opposite group could not do anything! I hope the same good work next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 100) {\n                         shi += \"#rB#k\";\n                         rnk = 2;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria! Isso foi impressionante! Voc\ufffd fez um bom trabalho contra o grupo advers\ufffdrio! S\ufffd mais um pouco, e voc\ufffd definitivamente vai conseguir um A na pr\ufffdxima vez. \\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory! That was awesome! You did a good job against the opposing group! Just a little longer, and you'll definitely get an A next time! \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else if (cm.getPlayer().getFestivalPoints() >= 50) {\n                         shi += \"#rC#k\";\n                         rnk = 3;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria. Voc\ufffd fez algumas coisas c\ufffd e l\ufffd, mas essa n\ufffdo pode ser considerada uma boa vit\ufffdria. Espero mais de ti da pr\ufffdxima vez.\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory. You did some things here and there, but that can not be considered a good victory. I expect more from you next time. \\r\\n\\r\\n#bYour result: \" + shi);\n                     } else {\n                         shi += \"#rD#k\";\n                         rnk = 4;\n-                        cm.sendOk(\"Parab\ufffdns pela sua vit\ufffdria, entretanto sua performance n\ufffdo refletiu muito bem isso. Seja mais ativo na sua pr\ufffdxima participa\ufffd\ufffdo da Folia de Monstros!\\r\\n\\r\\n#bNota da Folia de Monstros : \" + shi);\n+                        cm.sendOk(\"Congratulations on your victory, though your performance did not quite reflect that. Be more active in your next participation in the Monster Carnival! \\r\\n\\r\\n#bYour result: \" + shi);\n                     }\n                 } else {\n                     cm.warp(980030000, 0);"}, {"sha": "3225fb385ef6283c740e15c425f12ce6aa4f1b73", "filename": "scripts/npc/2042008.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042008.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -21,7 +21,7 @@ function action(mode, type, selection) {\n             status--;\n         if (status == 0) {\n             cm.warpParty(980030000, 4);\n-            cm.cancelarSaida();\n+            cm.cancelCPQLobby();\n             cm.dispose();\n         }\n     }"}, {"sha": "3225fb385ef6283c740e15c425f12ce6aa4f1b73", "filename": "scripts/npc/2042009.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2042009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042009.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -21,7 +21,7 @@ function action(mode, type, selection) {\n             status--;\n         if (status == 0) {\n             cm.warpParty(980030000, 4);\n-            cm.cancelarSaida();\n+            cm.cancelCPQLobby();\n             cm.dispose();\n         }\n     }"}, {"sha": "cd71c9f626cc52f347c5a243982b022a58529bc3", "filename": "scripts/npc/2094002.js", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2094002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/2094002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2094002.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -43,10 +43,6 @@ function action(mode, type, selection) {\n                 break;\n             case 925100100:\n                 var emp = eim.getProperty(\"stage2\");\n-                if (emp == null) {\n-                    eim.setProperty(\"stage2\", \"0\");\n-                    emp = \"0\";\n-                }\n                 if (emp.equals(\"0\")) {\n                     if (cm.haveItem(4001120,20)) {\n                         cm.sendNext(\"Excellent! Now hunt me 20 Rising Medals.\");\n@@ -55,7 +51,6 @@ function action(mode, type, selection) {\n                         eim.setProperty(\"stage2\", \"1\");\n                     } else {\n                         cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rookie Medals.\");\n-                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300114, level, true);\n                     }\n                 } else if (emp.equals(\"1\")) {\n                     if (cm.haveItem(4001121,20)) {\n@@ -65,7 +60,6 @@ function action(mode, type, selection) {\n                         eim.setProperty(\"stage2\", \"2\");\n                     } else {\n                         cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rising Medals.\");\n-                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300115, level, true);\n                     }\n                 } else if (emp.equals(\"2\")) {\n                     if (cm.haveItem(4001122,20)) {\n@@ -76,7 +70,6 @@ function action(mode, type, selection) {\n                         eim.showClearEffect(cm.getMapId());\n                     } else {\n                         cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Veteran Medals.\");\n-                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300116, level, true);\n                     }\n                 } else {\n                     cm.sendNext(\"The next stage has opened. GO!\");"}, {"sha": "8fd5c1d715f876de90d5520a5385417bfba10451", "filename": "scripts/npc/9201014.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9201014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9201014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201014.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -27,7 +27,7 @@\n \t1.0 - First Version by Angel\n         2.0 - Second Version by happydud3 & XotiCraze\n         3.0 - Third Version by RonanLana (HeavenMS)\n-        4.0 - Four Version bby Drago (MapleStorySA)\n+        4.0 - Fourth Version by Drago (MapleStorySA)\n ---------------------------------------------------------------------------------------------------\n **/\n var status = -1;"}, {"sha": "cf5dffdb196a99c38bef007322e46010296e1729", "filename": "scripts/npc/9900000.js", "status": "modified", "additions": 55, "deletions": 35, "changes": 90, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9900000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9900000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9900000.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -22,74 +22,94 @@\n /*\n  * @Name         NimaKIN\n  * @Author:      Signalize\n+ * @Author:      MainlandHero - repurposed to be the style setter in-game for mesos\n  * @NPC:         9900000\n- * @Purpose:     Hair/Face/Eye Changer -- May set job as GM too\n- * @GMSPurpose:  Sets one's job as a GM.\n+ * @Purpose:     Hair/Face/Eye Changer\n  * @Map:         180000000\n  */\n var status = 0;\n var beauty = 0;\n var haircolor = Array();\n var skin = [0, 1, 2, 3, 4, 5, 9, 10];\n-var fhair= [31000, 31010, 31020, 31030, 31040, 31050, 31060, 31070, 31080, 31090, 31100, 31110, 31120, 31130, 31140, 31150, 31160, 31170, 31180, 31190, 31200, 31210, 31220, 31230, 31240, 31250, 31260, 31270, 31280, 31290, 31300, 31310, 31320, 31330, 31340, 31350, 31400, 31410, 31420, 31440, 31450, 31460, 31470, 31480, 31490, 31510, 31520, 31530, 31540, 31550, 31560, 31570, 31580, 31590, 31600, 31610, 31620, 31630, 31640, 31650, 31670, 31680, 31690, 31700, 31710, 31720, 31730, 31740, 31750, 31760, 31770, 31780, 31790, 31800, 31810];\n-var hair = [30000, 30010, 30020, 30030, 30040, 30050, 30060, 30070, 30080, 30090, 30110, 30120, 30130, 30140, 30150, 30160, 30170, 30180, 30190, 30200, 30210, 30220, 30230, 30240, 30250, 30260, 30270, 30280, 30290, 30300, 30310, 30320, 30330, 30340, 30350, 30360, 30370, 30400, 30410, 30420, 30440, 30450, 30460, 30470, 30480, 30490, 30510, 30520, 30530, 30540, 30550, 30560, 30570, 30580, 30590, 30600, 30610, 30620, 30630, 30640, 30650, 30660, 30670, 30680, 30690, 30700, 30710, 30720, 30730, 30740, 30750, 30760, 30770, 30780, 30790, 30800, 30810, 30820, 30840];\n+var fhair= [31000, 31010, 31020, 31030, 31040, 31050, 31060, 31070, 31080, 31090, 31100, 31110, 31120, 31130, 31140, 31150, 31160, 31170, 31180, 31190, 31200, 31210, 31220, 31230, 31240, 31250, 31260, 31270, 31280, 31290, 31300, 31310, 31320, 31330, 31340, 31350, 31400, 31410, 31420, 31440, 31450, 31460, 31470, 31480, 31490, 31510, 31520, 31530, 31540, 31550, 31560, 31570, 31580, 31590, 31600, 31610, 31620, 31630, 31640, 31650, 31670, 31660, 31680, 31690, 31700, 31710, 31720, 31730, 31740, 31750, 31760, 31770, 31780, 31790, 31800, 31810, 31820, 31830, 31840, 31850, 31860, 31870, 31880, 31890, 31910, 31920, 31930, 31940, 31950, 34010, 34020, 34030, 34050, 34110];\n+var hair = [30000, 30010, 30020, 30030, 30040, 30050, 30060, 30070, 30080, 30090, 30110, 30120, 30130, 30140, 30150, 30160, 30170, 30180, 30190, 30200, 30210, 30220, 30230, 30240, 30250, 30260, 30270, 30280, 30290, 30300, 30310, 30320, 30330, 30340, 30350, 30360, 30370, 30400, 30410, 30420, 30440, 30450, 30460, 30470, 30480, 30490, 30510, 30520, 30530, 30540, 30550, 30560, 30570, 30580, 30590, 30600, 30610, 30620, 30630, 30640, 30650, 30660, 30670, 30680, 30690, 30700, 30710, 30720, 30730, 30740, 30750, 30760, 30770, 30780, 30790, 30800, 30810, 30820, 30830, 30840, 30860, 30870, 30880, 30890, 30900, 30910, 30920, 30930, 30940, 30950, 30990, 33000, 33040, 33100];\n var hairnew = Array();\n-var face = [20000, 20001, 20002, 20003, 20004, 20005, 20006, 20007, 20008, 20009, 20010, 20011, 20012, 20013, 20014, 20016, 20017, 20018, 20019, 20020, 20021, 20022, 20023, 20024, 20026];\n-var fface = [21000, 21001, 21002, 21003, 21004, 21005, 21006, 21007, 21008, 21009, 21010, 21011, 21012, 21013, 21014, 21016, 21017, 21018, 21019, 21020, 21021, 21022, 21024, 21025];\n+var face = [20000, 20001, 20002, 20003, 20004, 20005, 20006, 20007, 20008, 20009, 20010, 20011, 20012, 20013, 20014, 20015, 20016, 20017, 20018, 20019, 20020, 20021, 20022, 20023, 20024, 20025, 20026, 20027, 20028, 20029, 20031, 20032];\n+var fface = [21000, 21001, 21002, 21003, 21004, 21005, 21006, 21007, 21008, 21009, 21010, 21011, 21012, 21013, 21014, 21016, 21017, 21018, 21019, 21020, 21021, 21022, 21023, 21024, 21025, 21026, 21027, 21029, 21030];\n var facenew = Array();\n var colors = Array();\n+var price = 100000;\n \n function start() {\n-    if(cm.getPlayer().gmLevel() < 2) {\n+    if(cm.getPlayer().gmLevel() < 1) {\n         cm.sendOk(\"Hey wassup?\");\n         cm.dispose();\n         return;\n     }\n     \n-    cm.sendSimple(\"Hey there, I can change your look. What would you like to change?\\r\\n#L0#Skin#l\\r\\n#L1#Hair#l\\r\\n#L5#Female Hair#l\\r\\n#L2#Hair Color#l\\r\\n#L3#Eye#l\\r\\n#L6#Female Eyes#l\\r\\n#L4#Eye Color#l\\r\\n#L7#Set GM job#l\");\n+\tif(cm.getPlayer().isMale()){\n+\t\tcm.sendSimple(\"Hey there, you can change your look for \" + price + \" mesos. What would you like to change?\\r\\n#L0#Skin#l\\r\\n#L1#Male Hair#l\\r\\n#L2#Hair Color#l\\r\\n#L3#Male Regular Eyes#l\\r\\n#L4#Eye Color#l\");\n+\t}else{\n+\t\tcm.sendSimple(\"Hey there, you can change your look for \" + price + \" mesos. What would you like to change?\\r\\n#L0#Skin#l\\r\\n#L5#Female Hair#l\\r\\n#L2#Hair Color#l\\r\\n#L6#Female Eyes#l\\r\\n#L4#Eye Color#l\");\n+\t}\n }\n \n function action(mode, type, selection) {\n     status++;\n-    if (mode != 1 || cm.getPlayer().gmLevel() < 2){\n+    if (mode != 1 || cm.getPlayer().gmLevel() < 1){\n         cm.dispose();\n         return;\n     }\n     if (status == 1) {\n         beauty = selection + 1;\n-        if (selection == 0)\n-            cm.sendStyle(\"Pick one?\", skin);\n-        else if (selection == 1 || selection == 5) {\n-            for each(var i in selection == 1 ? hair : fhair)\n-                hairnew.push(i);\n-            cm.sendStyle(\"Pick one?\", hairnew);\n-        } else if (selection == 2) {\n-            for(var k = 0; k < 8; k++)\n-                haircolor.push(cm.getPlayer().getHair() + k);\n-            cm.sendStyle(\"Pick one?\", haircolor);\n-        } else if (selection == 3 || selection == 6) {\n-            for each(var j in selection == 3 ? face : fface)\n-                facenew.push(j);\n-            cm.sendStyle(\"Pick one?\", facenew);\n-        } else if (selection == 4) {\n-            for(var i = 0; i < 9; i++)\n-                colors.push(cm.getPlayer().getFace() + (i*100));\n-            cm.sendStyle(\"Pick one?\", colors);\n-        } else if (selection == 7) {\n-            cm.changeJobById(910);\n+\t\tif(cm.getMeso() > price){\n+\t\t\tif (selection == 0)\n+\t\t\t\tcm.sendStyle(\"Pick one?\", skin);\n+\t\t\telse if (selection == 1 || selection == 5) {\n+\t\t\t\tfor each(var i in selection == 1 ? hair : fhair)\n+\t\t\t\t\thairnew.push(i);\n+\t\t\t\tcm.sendStyle(\"Pick one?\", hairnew);\n+\t\t\t} else if (selection == 2) {\n+\t\t\t\tvar baseHair = parseInt(cm.getPlayer().getHair() / 10) * 10;\n+\t\t\t\tfor(var k = 0; k < 8; k++)\n+\t\t\t\t\thaircolor.push(baseHair + k);\n+\t\t\t\tcm.sendStyle(\"Pick one?\", haircolor);\n+\t\t\t} else if (selection == 3 || selection == 6) {\n+\t\t\t\tfor each(var j in selection == 3 ? face : fface)\n+\t\t\t\t\tfacenew.push(j);\n+\t\t\t\tcm.sendStyle(\"Pick one?\", facenew);\n+\t\t\t} else if (selection == 4) {\n+\t\t\t\tvar baseFace = parseInt(cm.getPlayer().getFace() / 1000) * 1000 + parseInt(cm.getPlayer().getFace() % 100);\n+\t\t\t\tfor(var i = 0; i < 9; i++)\n+\t\t\t\t\tcolors.push(baseFace + (i*100));\n+\t\t\t\tcm.sendStyle(\"Pick one?\", colors);\n+\t\t\t}\n+\t\t} else {\n+\t\t\tcm.sendNext(\"You don't have enough mesos. Sorry to say this, but without \" + price + \" mesos, you won't be able to change your look!\");\n             cm.dispose();\n-        }\n+\t\t}\n+        \n     } else if (status == 2){\n-        if (beauty == 1)\n+        if (beauty == 1){\n             cm.setSkin(skin[selection]);\n-        if (beauty == 2 || beauty == 6)\n+\t\t\tcm.gainMeso(-price);\n+\t\t}\n+        if (beauty == 2 || beauty == 6){\n             cm.setHair(hairnew[selection]);\n-        if (beauty == 3)\n+\t\t\tcm.gainMeso(-price);\n+\t\t}\n+        if (beauty == 3){\n             cm.setHair(haircolor[selection]);\n-        if (beauty == 4 || beauty == 7)\n+\t\t\tcm.gainMeso(-price);\n+\t\t}\n+        if (beauty == 4 || beauty == 7){\n             cm.setFace(facenew[selection]);\n-        if (beauty == 5)\n+\t\t\tcm.gainMeso(-price);\n+\t\t}\n+        if (beauty == 5){\n             cm.setFace(colors[selection]);\n+\t\t\tcm.gainMeso(-price);\n+\t\t}\n         cm.dispose();\n     }\n }\n\\ No newline at end of file"}, {"sha": "cb2379c3149e478765c167295c8281a8eb2e065c", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -46,6 +46,7 @@ function writeFeatureTab_PQs() {\n         addFeature(\"GuildPQ & queue with multi-lobby system available.\");\n         addFeature(\"Brand-new PQs: BossRushPQ, CafePQ.\");\n         addFeature(\"Mu Lung Dojo.\");\n+        addFeature(\"Monster Carnival 1 & 2 - thanks Dragohe4rt & Jayd!\");\n         addFeature(\"Capt. Latanica with party fighting the boss.\");\n         addFeature(\"Filled up missing obligatory event script methods.\");\n         addFeature(\"Secured uniquety of active lobby-name instances.\");\n@@ -74,6 +75,7 @@ function writeFeatureTab_Quests() {\n \n function writeFeatureTab_PlayerSocialNetwork() {\n         addFeature(\"Guild and Alliance system fully functional.\");\n+        addFeature(\"Guild contract system held in Guild Headquarters.\");\n         addFeature(\"Party for novices-only.\");\n         addFeature(\"P. members' HPBar accounts HP gain on equips.\");\n         addFeature(\"Thoroughly reviewed P. Shops and H. Merchants.\");\n@@ -85,6 +87,7 @@ function writeFeatureTab_PlayerSocialNetwork() {\n         addFeature(\"Protected and improved face expression system.\");\n         addFeature(\"Automated support for Player NPCs and Hall of Fame.\");\n         addFeature(\"Engagement & Wedding system with ring effects.\");\n+        addFeature(\"Wedding Wishlists - thanks Dragohe4rt!\");\n         addFeature(\"Equipments displays to everyone it's level & EXP info.\");\n         addFeature(\"Further improved the existent minigame mechanics.\");\n         addFeature(\"Trade complete using handshake synchronization.\");\n@@ -188,6 +191,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Enhanced AP auto-assigner: focus on eqp demands.\");\n         addFeature(\"Enhanced inventory check: free slots smartly fetched.\");\n         addFeature(\"Enhanced petloot handler: no brute-force inv. checks.\");\n+        addFeature(\"Matching system: everyone's decision to trigger action.\");\n         addFeature(\"Players-appointed bestsellers for Owl and Cash Shop.\");\n         addFeature(\"Tweaked pet/mount hunger to a balanced growth rate.\");\n         addFeature(\"Consistent experience and meso gain system.\");"}, {"sha": "ab5f3ff5cf7e4f160be760e7501c318da527dc14", "filename": "scripts/npc/cpqchallenge.js", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/cpqchallenge.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/cpqchallenge.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/cpqchallenge.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,4 +1,11 @@\n-/* global cm */\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Jayd - translated CPQ contents to English\n+---------------------------------------------------------------------------------------------------\n+**/\n+\n+importPackage(Packages.constants);\n \n var status = 0;\n var party;\n@@ -27,13 +34,14 @@ function action(mode, type, selection) {\n             status++;\n         else\n             status--;\n+        \n         if (status == 0) {\n             if (cm.getParty().getMembers().size() == party.size()) {\n                 cm.getPlayer().setChallenged(true);\n                 var snd = \"\";\n                 for (var i = 0; i < party.size(); i++)\n-                    snd += \"#bNome: \" + party.get(i).getName() + \" / (Level: \" + party.get(i).getLevel() + \") / \" + party.get(i).getJobNameById(party.get(i).getJobId()) + \"#k\\r\\n\\r\\n\";\n-                cm.sendAcceptDecline(snd + \"Gostaria de lutar contra este grupo no Festival de Monstros?\");\n+                    snd += \"#bName: \" + party.get(i).getName() + \" / (Level: \" + party.get(i).getLevel() + \") / \" + GameConstants.getJobName(party.get(i).getJobId()) + \"#k\\r\\n\\r\\n\";\n+                cm.sendAcceptDecline(snd + \"Would you like to fight this party at the Monster Carnival?\");\n             } else {\n                 return;\n             }\n@@ -45,7 +53,7 @@ function action(mode, type, selection) {\n                 cm.getChar().getParty().setEnemy(ch.getParty());\n                 cm.getChar().setChallenged(false);\n             } else {\n-                cm.sendOk(\"O numero de players entre os times nao esta igual.\");\n+                cm.sendOk(\"The number of players between the teams is not the same.\");\n             }\n             cm.dispose();\n         }"}, {"sha": "d8454eb4f41be0a5fdd42974eee2c1bf792ed6f4", "filename": "scripts/npc/cpqchallenge2.js", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/cpqchallenge2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/cpqchallenge2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/cpqchallenge2.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,3 +1,12 @@\n+/**\n+-- Version Info -----------------------------------------------------------------------------------\n+\t1.0 - First Version by Drago (MapleStorySA)\n+        2.0 - Second Version by Jayd - translated CPQ contents to English\n+---------------------------------------------------------------------------------------------------\n+**/\n+\n+importPackage(Packages.constants);\n+\n var status = 0;\n var party;\n \n@@ -26,13 +35,14 @@ function action(mode, type, selection) {\n             status++;\n         else\n             status--;\n+        \n         if (status == 0) {\n             if (cm.getParty().getMembers().size() == party.size()) {\n                 cm.getPlayer().setChallenged(true);\n                 var snd = \"\";\n                 for (var i = 0; i < party.size(); i++)\n-                    snd += \"#bNome: \" + party.get(i).getName() + \" / (Level: \" + party.get(i).getLevel() + \") / \" + party.get(i).getJobNameById(party.get(i).getJobId()) + \"#k\\r\\n\\r\\n\";\n-                cm.sendAcceptDecline(snd + \"Gostaria de lutar contra este grupo no Festival de Monstros?\");\n+                    snd += \"#bName: \" + party.get(i).getName() + \" / (Level: \" + party.get(i).getLevel() + \") / \" + GameConstants.getJobName(party.get(i).getJobId()) + \"#k\\r\\n\\r\\n\";\n+                cm.sendAcceptDecline(snd + \"Would you like to fight this party at the Monster Carnival?\");\n             } else {\n                 return;\n             }"}, {"sha": "b683623e8172963ebb97bfa2d81172251f903cc3", "filename": "scripts/npc/credits.js", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/credits.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/npc/credits.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/credits.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -90,6 +90,8 @@ function writeServerStaff_OdinMS() {\n }\n \n function writeServerStaff_Contributors() {\n+        addPerson(\"Jayd\", \"Contributor\");\n+        addPerson(\"Dragohe4rt\", \"Contributor\");\n         addPerson(\"Jvlaple\", \"Contributor\");\n         addPerson(\"Stereo\", \"Contributor\");\n         addPerson(\"AngelSL\", \"Contributor\");"}, {"sha": "066ea6e26ea6d7ec52e135bb79fba86ce2ca5750", "filename": "scripts/portal/TD_MC_enterboss2.js", "status": "modified", "additions": 41, "deletions": 25, "changes": 66, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/portal/TD_MC_enterboss2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/portal/TD_MC_enterboss2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/TD_MC_enterboss2.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -20,34 +20,50 @@ function enter(pi) {\n         return true;\n     }\n     else if(pi.isQuestStarted(2332) && pi.hasItem(4032388)){\n-        if(pi.getPlayer().getParty() != null){\n-            pi.getPlayer().showHint(\"The next part of the quest is solo only! Must leave party.\");\n-            return false;\n-        }\n-        else{\n-            pi.forceCompleteQuest(2332, 1300002);\n-            pi.getPlayer().message(\"You've found the princess!\");\n-            pi.giveCharacterExp(4400 * 1.5, pi.getPlayer());\n-            var pm = pi.getEventManager(\"MK_PrimeMinister\");\n-            pm.setProperty(\"player\", pi.getPlayer().getName());\n-            \n-            pm.startInstance(pi.getPlayer());\n-            pi.playPortalSound();\n-            return true;\n+        pi.forceCompleteQuest(2332, 1300002);\n+        pi.getPlayer().message(\"You've found the princess!\");\n+        pi.giveCharacterExp(4400 * 1.5, pi.getPlayer());\n+        \n+        var em = pi.getEventManager(\"MK_PrimeMinister\");\n+        var party = pi.getPlayer().getParty();\n+        if (party != null) {\n+            if (em.startInstance(party, pi.getMap())) {\n+                pi.playPortalSound();\n+                return true;\n+            } else {\n+                pi.message(\"Another party is already challenging the boss in this channel.\");\n+                return false;\n+            }\n+        } else {\n+            if (em.startInstance(pi.getPlayer(), pi.getMap())) {\n+                pi.playPortalSound();\n+                return true;\n+            } else {\n+                pi.message(\"Another party is already challenging the boss in this channel.\");\n+                return false;\n+            }\n         }\n     }\n     else if(pi.isQuestStarted(2333) || (pi.isQuestCompleted(2332) && !pi.isQuestStarted(2333))){\n-        if(pi.getPlayer().getParty() != null){\n-            pi.getPlayer().showHint(\"The next part of the quest is solo only! Must leave party.\");\n-            return false;\n-        }\n-        else{\n-            var pm = pi.getEventManager(\"MK_PrimeMinister\");\n-            pm.setProperty(\"player\", pi.getPlayer().getName());\n-            \n-            pm.startInstance(pi.getPlayer());\n-            pi.playPortalSound();\n-            return true;\n+        var em = pi.getEventManager(\"MK_PrimeMinister\");\n+        \n+        var party = pi.getPlayer().getParty();\n+        if (party != null) {\n+            if (em.startInstance(1, party, pi.getMap())) {\n+                pi.playPortalSound();\n+                return true;\n+            } else {\n+                pi.message(\"Another party is already challenging the boss in this channel.\");\n+                return false;\n+            }\n+        } else {\n+            if (em.startInstance(pi.getPlayer(), pi.getMap())) {\n+                pi.playPortalSound();\n+                return true;\n+            } else {\n+                pi.message(\"Another party is already challenging the boss in this channel.\");\n+                return false;\n+            }\n         }\n     }\n     else{"}, {"sha": "da10135554dce59f0254c1af80b4c3670cbebc25", "filename": "scripts/quest/2333.js", "status": "modified", "additions": 0, "deletions": 15, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/quest/2333.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/scripts/quest/2333.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2333.js?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -2,12 +2,8 @@\n \tQUEST: Where's Violetta?\n \tNPC: none\n */\n-importPackage(Packages.server.life);\n \n var status = -1;\n-var timeLimit = 10; //10 minutes\n-var eventTimer = 1000 * 60 * timeLimit;\n-var mobId = 3300008; //Prime Minister\n \n function start(mode, type, selection){\n \tif(mode == -1 || (mode == 0 && status == 0)){\n@@ -28,10 +24,6 @@ function start(mode, type, selection){\n \t}\n \telse if (status == 2){\n \t\tqm.forceStartQuest();\n-\t\tvar eim = qm.getEventInstance();\n-\t\teim.startEventTimer(eventTimer);\n-\t\tqm.getPlayer().getMap().getPortal(1).setPortalState(false);\n-\t\tqm.getPlayer().getMap().spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(mobId), new java.awt.Point(292, 143));\n \t\tqm.dispose();\n \t}\n }\n@@ -53,13 +45,6 @@ function end(mode, type, selection){\n \telse if(status == 1){\n \t\tqm.gainExp(15000);\n \t\tqm.forceCompleteQuest();\n-\n-\t\tvar eim = qm.getEventInstance();\n-\t\tqm.getPlayer().getMap().getPortal(1).setPortalState(true);\n-\t\teim.stopEventTimer();\n-\t\teim.warpEventTeam(106021600);\n-\n-\t\teim.dispose();\n \t\tqm.dispose();\n \t}\n }\n\\ No newline at end of file"}, {"sha": "ca2d8c6e210e7f38c4fc0847ba3d057b9b76164a", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -42,7 +42,7 @@ CREATE TABLE IF NOT EXISTS `accounts` (\n   `rewardpoints` int(11) NOT NULL DEFAULT '0',\n   `votepoints` int(11) NOT NULL DEFAULT '0',\n   `hwid` varchar(12) NOT NULL DEFAULT '',\n-  `lingua` int(1) NOT NULL DEFAULT '2',\n+  `language` int(1) NOT NULL DEFAULT '2',\n   PRIMARY KEY (`id`),\n   UNIQUE KEY `name` (`name`),\n   KEY `ranking1` (`id`,`banned`),"}, {"sha": "478a60e8bcd49e21dfa19e014a29ad187e15a760", "filename": "sql/db_drops.sql", "status": "modified", "additions": 2, "deletions": 141, "changes": 143, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -17945,7 +17945,7 @@ USE `heavenms`;\n (8800002, 2280013, 1, 4, 0, 20000), \n (8800002, 2280015, 1, 4, 0, 20000), \n (8800002, 2280016, 1, 4, 0, 20000), \n-(8800002, 2280014, 1, 4, 0, 20000), \n+(8800002, 2280014, 1, 4, 0, 20000), #-- thanks Tochi for noting item description not following pattern\n (8800002, 2290084, 1, 4, 0, 40000), \n (8800002, 2290016, 1, 4, 0, 40000), \n (8800002, 2290022, 1, 4, 0, 40000), \n@@ -20769,6 +20769,7 @@ DELETE FROM temp_data WHERE dropperid >= 9300127 AND dropperid <= 9300136;\n DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n \n # add CPQ items, CPQ specific items found thanks to Dragohe4rt\n+# thanks Vcoc for pointing out inexistent itemids among those listed here\n   INSERT IGNORE INTO temp_data (`dropperid`, `itemid`, `minimum_quantity`, `maximum_quantity`, `questid`, `chance`) VALUES\n (9300127, 2022157, 1, 1, 0, 200000),\n (9300127, 2022158, 1, 1, 0, 200000),\n@@ -20780,13 +20781,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300127, 2022164, 1, 1, 0, 200000),\n (9300127, 2022165, 1, 1, 0, 200000),\n (9300127, 2022166, 1, 1, 0, 200000),\n-(9300127, 2022167, 1, 1, 0, 200000),\n-(9300127, 2022168, 1, 1, 0, 200000),\n-(9300127, 2022169, 1, 1, 0, 200000),\n-(9300127, 2022170, 1, 1, 0, 200000),\n-(9300127, 2022171, 1, 1, 0, 200000),\n-(9300127, 2022172, 1, 1, 0, 200000),\n-(9300127, 2022173, 1, 1, 0, 200000),\n (9300127, 2022174, 1, 1, 0, 200000),\n (9300127, 2022175, 1, 1, 0, 200000),\n (9300127, 2022176, 1, 1, 0, 200000),\n@@ -20803,13 +20797,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300128, 2022164, 1, 1, 0, 200000),\n (9300128, 2022165, 1, 1, 0, 200000),\n (9300128, 2022166, 1, 1, 0, 200000),\n-(9300128, 2022167, 1, 1, 0, 200000),\n-(9300128, 2022168, 1, 1, 0, 200000),\n-(9300128, 2022169, 1, 1, 0, 200000),\n-(9300128, 2022170, 1, 1, 0, 200000),\n-(9300128, 2022171, 1, 1, 0, 200000),\n-(9300128, 2022172, 1, 1, 0, 200000),\n-(9300128, 2022173, 1, 1, 0, 200000),\n (9300128, 2022174, 1, 1, 0, 200000),\n (9300128, 2022175, 1, 1, 0, 200000),\n (9300128, 2022176, 1, 1, 0, 200000),\n@@ -20826,13 +20813,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300129, 2022164, 1, 1, 0, 200000),\n (9300129, 2022165, 1, 1, 0, 200000),\n (9300129, 2022166, 1, 1, 0, 200000),\n-(9300129, 2022167, 1, 1, 0, 200000),\n-(9300129, 2022168, 1, 1, 0, 200000),\n-(9300129, 2022169, 1, 1, 0, 200000),\n-(9300129, 2022170, 1, 1, 0, 200000),\n-(9300129, 2022171, 1, 1, 0, 200000),\n-(9300129, 2022172, 1, 1, 0, 200000),\n-(9300129, 2022173, 1, 1, 0, 200000),\n (9300129, 2022174, 1, 1, 0, 200000),\n (9300129, 2022175, 1, 1, 0, 200000),\n (9300129, 2022176, 1, 1, 0, 200000),\n@@ -20849,13 +20829,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300130, 2022164, 1, 1, 0, 200000),\n (9300130, 2022165, 1, 1, 0, 200000),\n (9300130, 2022166, 1, 1, 0, 200000),\n-(9300130, 2022167, 1, 1, 0, 200000),\n-(9300130, 2022168, 1, 1, 0, 200000),\n-(9300130, 2022169, 1, 1, 0, 200000),\n-(9300130, 2022170, 1, 1, 0, 200000),\n-(9300130, 2022171, 1, 1, 0, 200000),\n-(9300130, 2022172, 1, 1, 0, 200000),\n-(9300130, 2022173, 1, 1, 0, 200000),\n (9300130, 2022174, 1, 1, 0, 200000),\n (9300130, 2022175, 1, 1, 0, 200000),\n (9300130, 2022176, 1, 1, 0, 200000),\n@@ -20872,13 +20845,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300131, 2022164, 1, 1, 0, 200000),\n (9300131, 2022165, 1, 1, 0, 200000),\n (9300131, 2022166, 1, 1, 0, 200000),\n-(9300131, 2022167, 1, 1, 0, 200000),\n-(9300131, 2022168, 1, 1, 0, 200000),\n-(9300131, 2022169, 1, 1, 0, 200000),\n-(9300131, 2022170, 1, 1, 0, 200000),\n-(9300131, 2022171, 1, 1, 0, 200000),\n-(9300131, 2022172, 1, 1, 0, 200000),\n-(9300131, 2022173, 1, 1, 0, 200000),\n (9300131, 2022174, 1, 1, 0, 200000),\n (9300131, 2022175, 1, 1, 0, 200000),\n (9300131, 2022176, 1, 1, 0, 200000),\n@@ -20895,13 +20861,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300132, 2022164, 1, 1, 0, 200000),\n (9300132, 2022165, 1, 1, 0, 200000),\n (9300132, 2022166, 1, 1, 0, 200000),\n-(9300132, 2022167, 1, 1, 0, 200000),\n-(9300132, 2022168, 1, 1, 0, 200000),\n-(9300132, 2022169, 1, 1, 0, 200000),\n-(9300132, 2022170, 1, 1, 0, 200000),\n-(9300132, 2022171, 1, 1, 0, 200000),\n-(9300132, 2022172, 1, 1, 0, 200000),\n-(9300132, 2022173, 1, 1, 0, 200000),\n (9300132, 2022174, 1, 1, 0, 200000),\n (9300132, 2022175, 1, 1, 0, 200000),\n (9300132, 2022176, 1, 1, 0, 200000),\n@@ -20918,13 +20877,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300133, 2022164, 1, 1, 0, 200000),\n (9300133, 2022165, 1, 1, 0, 200000),\n (9300133, 2022166, 1, 1, 0, 200000),\n-(9300133, 2022167, 1, 1, 0, 200000),\n-(9300133, 2022168, 1, 1, 0, 200000),\n-(9300133, 2022169, 1, 1, 0, 200000),\n-(9300133, 2022170, 1, 1, 0, 200000),\n-(9300133, 2022171, 1, 1, 0, 200000),\n-(9300133, 2022172, 1, 1, 0, 200000),\n-(9300133, 2022173, 1, 1, 0, 200000),\n (9300133, 2022174, 1, 1, 0, 200000),\n (9300133, 2022175, 1, 1, 0, 200000),\n (9300133, 2022176, 1, 1, 0, 200000),\n@@ -20941,13 +20893,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300134, 2022164, 1, 1, 0, 200000),\n (9300134, 2022165, 1, 1, 0, 200000),\n (9300134, 2022166, 1, 1, 0, 200000),\n-(9300134, 2022167, 1, 1, 0, 200000),\n-(9300134, 2022168, 1, 1, 0, 200000),\n-(9300134, 2022169, 1, 1, 0, 200000),\n-(9300134, 2022170, 1, 1, 0, 200000),\n-(9300134, 2022171, 1, 1, 0, 200000),\n-(9300134, 2022172, 1, 1, 0, 200000),\n-(9300134, 2022173, 1, 1, 0, 200000),\n (9300134, 2022174, 1, 1, 0, 200000),\n (9300134, 2022175, 1, 1, 0, 200000),\n (9300134, 2022176, 1, 1, 0, 200000),\n@@ -20964,13 +20909,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300135, 2022164, 1, 1, 0, 200000),\n (9300135, 2022165, 1, 1, 0, 200000),\n (9300135, 2022166, 1, 1, 0, 200000),\n-(9300135, 2022167, 1, 1, 0, 200000),\n-(9300135, 2022168, 1, 1, 0, 200000),\n-(9300135, 2022169, 1, 1, 0, 200000),\n-(9300135, 2022170, 1, 1, 0, 200000),\n-(9300135, 2022171, 1, 1, 0, 200000),\n-(9300135, 2022172, 1, 1, 0, 200000),\n-(9300135, 2022173, 1, 1, 0, 200000),\n (9300135, 2022174, 1, 1, 0, 200000),\n (9300135, 2022175, 1, 1, 0, 200000),\n (9300135, 2022176, 1, 1, 0, 200000),\n@@ -20987,13 +20925,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300136, 2022164, 1, 1, 0, 200000),\n (9300136, 2022165, 1, 1, 0, 200000),\n (9300136, 2022166, 1, 1, 0, 200000),\n-(9300136, 2022167, 1, 1, 0, 200000),\n-(9300136, 2022168, 1, 1, 0, 200000),\n-(9300136, 2022169, 1, 1, 0, 200000),\n-(9300136, 2022170, 1, 1, 0, 200000),\n-(9300136, 2022171, 1, 1, 0, 200000),\n-(9300136, 2022172, 1, 1, 0, 200000),\n-(9300136, 2022173, 1, 1, 0, 200000),\n (9300136, 2022174, 1, 1, 0, 200000),\n (9300136, 2022175, 1, 1, 0, 200000),\n (9300136, 2022176, 1, 1, 0, 200000),\n@@ -21010,13 +20941,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300315, 2022164, 1, 1, 0, 200000),\n (9300315, 2022165, 1, 1, 0, 200000),\n (9300315, 2022166, 1, 1, 0, 200000),\n-(9300315, 2022167, 1, 1, 0, 200000),\n-(9300315, 2022168, 1, 1, 0, 200000),\n-(9300315, 2022169, 1, 1, 0, 200000),\n-(9300315, 2022170, 1, 1, 0, 200000),\n-(9300315, 2022171, 1, 1, 0, 200000),\n-(9300315, 2022172, 1, 1, 0, 200000),\n-(9300315, 2022173, 1, 1, 0, 200000),\n (9300315, 2022174, 1, 1, 0, 200000),\n (9300315, 2022175, 1, 1, 0, 200000),\n (9300315, 2022176, 1, 1, 0, 200000),\n@@ -21033,13 +20957,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300316, 2022164, 1, 1, 0, 200000),\n (9300316, 2022165, 1, 1, 0, 200000),\n (9300316, 2022166, 1, 1, 0, 200000),\n-(9300316, 2022167, 1, 1, 0, 200000),\n-(9300316, 2022168, 1, 1, 0, 200000),\n-(9300316, 2022169, 1, 1, 0, 200000),\n-(9300316, 2022170, 1, 1, 0, 200000),\n-(9300316, 2022171, 1, 1, 0, 200000),\n-(9300316, 2022172, 1, 1, 0, 200000),\n-(9300316, 2022173, 1, 1, 0, 200000),\n (9300316, 2022174, 1, 1, 0, 200000),\n (9300316, 2022175, 1, 1, 0, 200000),\n (9300316, 2022176, 1, 1, 0, 200000),\n@@ -21056,13 +20973,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300317, 2022164, 1, 1, 0, 200000),\n (9300317, 2022165, 1, 1, 0, 200000),\n (9300317, 2022166, 1, 1, 0, 200000),\n-(9300317, 2022167, 1, 1, 0, 200000),\n-(9300317, 2022168, 1, 1, 0, 200000),\n-(9300317, 2022169, 1, 1, 0, 200000),\n-(9300317, 2022170, 1, 1, 0, 200000),\n-(9300317, 2022171, 1, 1, 0, 200000),\n-(9300317, 2022172, 1, 1, 0, 200000),\n-(9300317, 2022173, 1, 1, 0, 200000),\n (9300317, 2022174, 1, 1, 0, 200000),\n (9300317, 2022175, 1, 1, 0, 200000),\n (9300317, 2022176, 1, 1, 0, 200000),\n@@ -21079,13 +20989,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300318, 2022164, 1, 1, 0, 200000),\n (9300318, 2022165, 1, 1, 0, 200000),\n (9300318, 2022166, 1, 1, 0, 200000),\n-(9300318, 2022167, 1, 1, 0, 200000),\n-(9300318, 2022168, 1, 1, 0, 200000),\n-(9300318, 2022169, 1, 1, 0, 200000),\n-(9300318, 2022170, 1, 1, 0, 200000),\n-(9300318, 2022171, 1, 1, 0, 200000),\n-(9300318, 2022172, 1, 1, 0, 200000),\n-(9300318, 2022173, 1, 1, 0, 200000),\n (9300318, 2022174, 1, 1, 0, 200000),\n (9300318, 2022175, 1, 1, 0, 200000),\n (9300318, 2022176, 1, 1, 0, 200000),\n@@ -21102,13 +21005,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300319, 2022164, 1, 1, 0, 200000),\n (9300319, 2022165, 1, 1, 0, 200000),\n (9300319, 2022166, 1, 1, 0, 200000),\n-(9300319, 2022167, 1, 1, 0, 200000),\n-(9300319, 2022168, 1, 1, 0, 200000),\n-(9300319, 2022169, 1, 1, 0, 200000),\n-(9300319, 2022170, 1, 1, 0, 200000),\n-(9300319, 2022171, 1, 1, 0, 200000),\n-(9300319, 2022172, 1, 1, 0, 200000),\n-(9300319, 2022173, 1, 1, 0, 200000),\n (9300319, 2022174, 1, 1, 0, 200000),\n (9300319, 2022175, 1, 1, 0, 200000),\n (9300319, 2022176, 1, 1, 0, 200000),\n@@ -21125,13 +21021,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300320, 2022164, 1, 1, 0, 200000),\n (9300320, 2022165, 1, 1, 0, 200000),\n (9300320, 2022166, 1, 1, 0, 200000),\n-(9300320, 2022167, 1, 1, 0, 200000),\n-(9300320, 2022168, 1, 1, 0, 200000),\n-(9300320, 2022169, 1, 1, 0, 200000),\n-(9300320, 2022170, 1, 1, 0, 200000),\n-(9300320, 2022171, 1, 1, 0, 200000),\n-(9300320, 2022172, 1, 1, 0, 200000),\n-(9300320, 2022173, 1, 1, 0, 200000),\n (9300320, 2022174, 1, 1, 0, 200000),\n (9300320, 2022175, 1, 1, 0, 200000),\n (9300320, 2022176, 1, 1, 0, 200000),\n@@ -21148,13 +21037,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300321, 2022164, 1, 1, 0, 200000),\n (9300321, 2022165, 1, 1, 0, 200000),\n (9300321, 2022166, 1, 1, 0, 200000),\n-(9300321, 2022167, 1, 1, 0, 200000),\n-(9300321, 2022168, 1, 1, 0, 200000),\n-(9300321, 2022169, 1, 1, 0, 200000),\n-(9300321, 2022170, 1, 1, 0, 200000),\n-(9300321, 2022171, 1, 1, 0, 200000),\n-(9300321, 2022172, 1, 1, 0, 200000),\n-(9300321, 2022173, 1, 1, 0, 200000),\n (9300321, 2022174, 1, 1, 0, 200000),\n (9300321, 2022175, 1, 1, 0, 200000),\n (9300321, 2022176, 1, 1, 0, 200000),\n@@ -21171,13 +21053,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300322, 2022164, 1, 1, 0, 200000),\n (9300322, 2022165, 1, 1, 0, 200000),\n (9300322, 2022166, 1, 1, 0, 200000),\n-(9300322, 2022167, 1, 1, 0, 200000),\n-(9300322, 2022168, 1, 1, 0, 200000),\n-(9300322, 2022169, 1, 1, 0, 200000),\n-(9300322, 2022170, 1, 1, 0, 200000),\n-(9300322, 2022171, 1, 1, 0, 200000),\n-(9300322, 2022172, 1, 1, 0, 200000),\n-(9300322, 2022173, 1, 1, 0, 200000),\n (9300322, 2022174, 1, 1, 0, 200000),\n (9300322, 2022175, 1, 1, 0, 200000),\n (9300322, 2022176, 1, 1, 0, 200000),\n@@ -21194,13 +21069,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300323, 2022164, 1, 1, 0, 200000),\n (9300323, 2022165, 1, 1, 0, 200000),\n (9300323, 2022166, 1, 1, 0, 200000),\n-(9300323, 2022167, 1, 1, 0, 200000),\n-(9300323, 2022168, 1, 1, 0, 200000),\n-(9300323, 2022169, 1, 1, 0, 200000),\n-(9300323, 2022170, 1, 1, 0, 200000),\n-(9300323, 2022171, 1, 1, 0, 200000),\n-(9300323, 2022172, 1, 1, 0, 200000),\n-(9300323, 2022173, 1, 1, 0, 200000),\n (9300323, 2022174, 1, 1, 0, 200000),\n (9300323, 2022175, 1, 1, 0, 200000),\n (9300323, 2022176, 1, 1, 0, 200000),\n@@ -21217,13 +21085,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300324, 2022164, 1, 1, 0, 200000),\n (9300324, 2022165, 1, 1, 0, 200000),\n (9300324, 2022166, 1, 1, 0, 200000),\n-(9300324, 2022167, 1, 1, 0, 200000),\n-(9300324, 2022168, 1, 1, 0, 200000),\n-(9300324, 2022169, 1, 1, 0, 200000),\n-(9300324, 2022170, 1, 1, 0, 200000),\n-(9300324, 2022171, 1, 1, 0, 200000),\n-(9300324, 2022172, 1, 1, 0, 200000),\n-(9300324, 2022173, 1, 1, 0, 200000),\n (9300324, 2022174, 1, 1, 0, 200000),\n (9300324, 2022175, 1, 1, 0, 200000),\n (9300324, 2022176, 1, 1, 0, 200000),"}, {"sha": "1e2c7bcb42ff38a499625699ed1b453df28cd427", "filename": "sql/db_shopupdate.sql", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_shopupdate.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/sql/db_shopupdate.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_shopupdate.sql?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -159,11 +159,10 @@ INSERT IGNORE INTO `shopitems` (`shopid`, `itemid`, `price`, `pitch`, `position`\n (2130000, 2030100, 450, 0, 126),\n (9201060, 2030100, 450, 0, 114),\n (9270021, 2030100, 450, 0, 118),\n-(9270022, 2030100, 450, 0, 114),\n+(9270022, 2030100, 450, 0, 114),  -- Thanks Rednor for finding duplicate item on NPC\n (1338, 2030100, 450, 0, 114),\n (9270057, 2030100, 450, 0, 4),\n-(9270065, 2030100, 450, 0, 3),\n-(9270022, 2030100, 450, 0, 118);\n+(9270065, 2030100, 450, 0, 3);\n \n -- Thanks to Vcoc\n -- GMShop: Sacks, GmEquip, Cheese & Onyx, Utils, "}, {"sha": "9dcade52feed91d6ac630ca1d4efc9769df76dc3", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 68, "deletions": 50, "changes": 118, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -161,7 +161,6 @@\n import constants.skills.Sniper;\n import constants.skills.Swordsman;\n import constants.skills.ThunderBreaker;\n-import net.server.channel.handlers.PartyOperationHandler;\n import scripting.item.ItemScriptManager;\n import server.life.MobSkillFactory;\n import server.maps.MapleMapItem;\n@@ -1063,12 +1062,14 @@ public synchronized void changeJob(MapleJob newJob) {\n             gainSp(spGain, GameConstants.getSkillBook(newJob.getId()), true);\n         }\n         \n-        // thanks xinyifly for finding out job advancements awarding APs\n-        /*\n-        if (newJob.getId() % 10 >= 1) {\n-            gainAp(5, true);\n+        // thanks xinyifly for finding out missing AP awards (AP Reset can be used as a compass)\n+        if (newJob.getId() % 100 >= 1) {\n+            if (this.isCygnus()) {\n+                gainAp(7, true);\n+            } else {\n+                gainAp(5, true);\n+            }\n         }\n-        */\n         \n         if (!isGM()) {\n             for (byte i = 1; i < 5; i++) {\n@@ -1128,6 +1129,7 @@ public synchronized void changeJob(MapleJob newJob) {\n             effLock.unlock();\n         }\n         \n+        setMPC(new MaplePartyCharacter(this));\n         silentPartyUpdate();\n         \n         if (dragon != null) {\n@@ -1152,7 +1154,7 @@ public synchronized void changeJob(MapleJob newJob) {\n         \n         if (ServerConstants.USE_ANNOUNCE_CHANGEJOB) {\n             if (!this.isGM()) {\n-                broadcastAcquaintances(6, \"[\" + GameConstants.ordinal(GameConstants.getJobBranch(newJob)) + \" Job] \" + name + \" has just become a \" + newJob.name() + \".\");\n+                broadcastAcquaintances(6, \"[\" + GameConstants.ordinal(GameConstants.getJobBranch(newJob)) + \" Job] \" + name + \" has just become a \" + GameConstants.getJobName(this.job.getId()) + \".\");    // thanks Vcoc for noticing job name appearing in uppercase here\n             }\n         }\n     }\n@@ -1199,14 +1201,16 @@ public void broadcastStance() {\n     }\n     \n     public MapleMap getWarpMap(int map) {\n-\tMapleMap target;\n+\tMapleMap warpMap;\n         EventInstanceManager eim = getEventInstance();\n-\tif (eim == null) {\n-            target = client.getChannelServer().getMapFactory().getMap(map);\n+\tif (eim != null) {\n+            warpMap = eim.getMapInstance(map);\n+        } else if (this.getMonsterCarnival() != null && this.getMonsterCarnival().getEventMap().getId() == map) {\n+            warpMap = this.getMonsterCarnival().getEventMap();\n \t} else {\n-            target = eim.getMapInstance(map);\n+            warpMap = client.getChannelServer().getMapFactory().getMap(map);\n \t}\n-\treturn target;\n+\treturn warpMap;\n     }\n     \n     // for use ONLY inside OnUserEnter map scripts that requires a player to change map while still moving between maps.\n@@ -1812,14 +1816,14 @@ public void releaseControlledMonsters() {\n         }\n     }\n     \n-    private boolean useItem(final int id) {\n-        if (id / 1000000 == 2) {\n-            if (ii.isConsumeOnPickup(id)) {\n-                if (ItemConstants.isPartyItem(id)) {\n+    public boolean applyConsumeOnPickup(final int itemid) {\n+        if (itemid / 1000000 == 2) {\n+            if (ii.isConsumeOnPickup(itemid)) {\n+                if (ItemConstants.isPartyItem(itemid)) {\n                     List<MapleCharacter> pchr = this.getPartyMembersOnSameMap();\n                     \n-                    if(!ItemConstants.isPartyAllcure(id)) {\n-                        MapleStatEffect mse = ii.getItemEffect(id);\n+                    if(!ItemConstants.isPartyAllcure(itemid)) {\n+                        MapleStatEffect mse = ii.getItemEffect(itemid);\n                         \n                         if(!pchr.isEmpty()) {\n                             for (MapleCharacter mc : pchr) {\n@@ -1838,7 +1842,11 @@ private boolean useItem(final int id) {\n                         }\n                     }\n                 } else {\n-                    ii.getItemEffect(id).applyTo(this);\n+                    ii.getItemEffect(itemid).applyTo(this);\n+                }\n+                \n+                if (itemid / 10000 == 238) {\n+                    this.getMonsterBook().addCard(client, itemid);\n                 }\n                 return true;\n             }\n@@ -1955,10 +1963,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                         this.getCashShop().gainCash(1, nxGain);\n                         \n                         showHint(\"You have earned #e#b\" + nxGain + \" NX#k#n. (\" + this.getCashShop().getCash(1) + \" NX)\", 300);\n-                    } else if (useItem(mItem.getItemId())) {\n-                        if (mItem.getItemId() / 10000 == 238) {\n-                            this.getMonsterBook().addCard(client, mItem.getItemId());\n-                        }\n+                    } else if (applyConsumeOnPickup(mItem.getItemId())) {\n                     } else if (MapleInventoryManipulator.addFromDrop(client, mItem, true)) {\n                     } else if (mItem.getItemId() == 4031868) {\n                         this.getMap().broadcastMessage(MaplePacketCreator.updateAriantPQRanking(this.getName(), this.getItemQuantity(4031868, false), false));\n@@ -5647,11 +5652,11 @@ public boolean hasMerchant() {\n     }\n \n     public boolean haveItem(int itemid) {\n-        return getItemQuantity(itemid, false) > 0;\n+        return getItemQuantity(itemid, ItemConstants.isEquipment(itemid)) > 0;\n     }\n     \n     public boolean haveCleanItem(int itemid) {\n-        return getCleanItemQuantity(itemid, false) > 0;\n+        return getCleanItemQuantity(itemid, ItemConstants.isEquipment(itemid)) > 0;\n     }\n     \n     public boolean hasEmptySlot(int itemId) {\n@@ -5847,7 +5852,7 @@ public boolean isGuildLeader() {    // true on guild master or jr. master\n     }\n     \n     public boolean attemptCatchFish(int baitLevel) {\n-        return GameConstants.isFishingArea(mapid) && this.getPosition().getY() > 0 && ItemConstants.isFishingChair(chair.get()) && this.getWorldServer().registerFisherPlayer(this, baitLevel);\n+        return ServerConstants.USE_FISHING_SYSTEM && GameConstants.isFishingArea(mapid) && this.getPosition().getY() > 0 && ItemConstants.isFishingChair(chair.get()) && this.getWorldServer().registerFisherPlayer(this, baitLevel);\n     }\n     \n     public void leaveMap() {\n@@ -5969,8 +5974,15 @@ public synchronized void levelUp(boolean takeexp) {\n             }\n         } else {\n             int remainingAp = 5;\n-            if (isCygnus() && level > 10 && level < 70) {\n-                remainingAp++;\n+            \n+            if (isCygnus()) {\n+                if (level > 10) {\n+                    if (level <= 17) {\n+                        remainingAp += 2;\n+                    } else if (level < 77) {\n+                        remainingAp++;\n+                    }\n+                }\n             }\n             \n             gainAp(remainingAp, true);\n@@ -6119,23 +6131,7 @@ public void run() {\n             Runnable r = new Runnable() {\n                 @Override\n                 public void run() {\n-                    MapleParty party;\n-                    boolean partyLeader;\n-                    \n-                    prtLock.lock();\n-                    try {\n-                        party = getParty();\n-                        partyLeader = party != null && isPartyLeader();\n-                    } finally {\n-                        prtLock.unlock();\n-                    }\n-                    \n-                    if (party != null) {\n-                        if(partyLeader) {\n-                            party.assignNewLeader(client);\n-                        }\n-                        PartyOperationHandler.leaveParty(party, mpc, client);\n-\n+                    if (leaveParty()) {\n                         showHint(\"You have reached #blevel 10#k, therefore you must leave your #rstarter party#k.\");\n                     }\n                 }\n@@ -6147,6 +6143,28 @@ public void run() {\n         levelUpMessages();\n         guildUpdate();\n     }\n+    \n+    public boolean leaveParty() {\n+        MapleParty party;\n+        boolean partyLeader;\n+\n+        prtLock.lock();\n+        try {\n+            party = getParty();\n+            partyLeader = party != null && isPartyLeader();\n+        } finally {\n+            prtLock.unlock();\n+        }\n+\n+        if (party != null) {\n+            if(partyLeader) party.assignNewLeader(client);\n+            MapleParty.leaveParty(party, client);\n+\n+            return true;\n+        } else {\n+            return false;\n+        }\n+    }\n \n     private void levelUpMessages() {\n         if (level % 5 != 0) { //Performance FTW?\n@@ -10288,11 +10306,11 @@ public void setChallenged(boolean challenged) {\n         this.challenged = challenged;\n     }\n \n-    public void setLingua(int num) {\n-        getClient().setLingua(num);\n+    public void setLanguage(int num) {\n+        getClient().setLanguage(num);\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            try (PreparedStatement ps = con.prepareStatement(\"UPDATE accounts SET lingua = ? WHERE id = ?\")) {\n+            try (PreparedStatement ps = con.prepareStatement(\"UPDATE accounts SET language = ? WHERE id = ?\")) {\n                 ps.setInt(1, num);\n                 ps.setInt(2, getClient().getAccID());\n                 ps.executeUpdate();\n@@ -10304,8 +10322,8 @@ public void setLingua(int num) {\n         }\n     }\n \n-    public int getLingua() {\n-        return getClient().getLingua();\n+    public int getLanguage() {\n+        return getClient().getLanguage();\n     }\n     \n }\n\\ No newline at end of file"}, {"sha": "11d6945ba8ee79902c88f66b1233f217fc7c924f", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 37, "deletions": 17, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -90,12 +90,13 @@\n \tpublic static final String CLIENT_KEY = \"CLIENT\";\n         public static final String CLIENT_HWID = \"HWID\";\n         public static final String CLIENT_NIBBLEHWID = \"HWID2\";\n+        public static final String CLIENT_REMOTE_ADDRESS = \"REMOTE_IP\";\n \tprivate MapleAESOFB send;\n \tprivate MapleAESOFB receive;\n \tprivate final IoSession session;\n \tprivate MapleCharacter player;\n \tprivate int channel = 1;\n-\tprivate int accId = 0;\n+\tprivate int accId = -4;\n \tprivate boolean loggedIn = false;\n \tprivate boolean serverTransition = false;\n \tprivate Calendar birthday = null;\n@@ -124,7 +125,7 @@\n         private int visibleWorlds;\n \tprivate long lastNpcClick;\n \tprivate long sessionId;\n-        private int lingua = 0;\n+        private int lang = 0;\n         \n         static {\n             for (int i = 0; i < 200; i++) {\n@@ -534,24 +535,23 @@ public int login(String login, String pwd, String nibbleHwid) {\n                 if (loginattempt > 4) {\n                         loggedIn = false;\n \t\t\tMapleSessionCoordinator.getInstance().closeSession(session, false);\n-                        return loginok;\n+                        return 6;   // thanks Survival_Project for finding out an issue with AUTOMATIC_REGISTER here\n \t\t}\n \t\t\n \t\tConnection con = null;\n \t\tPreparedStatement ps = null;\n \t\tResultSet rs = null;\n \t\ttry {\n \t\t\tcon = DatabaseConnection.getConnection();\n-\t\t\tps = con.prepareStatement(\"SELECT id, password, gender, banned, pin, pic, characterslots, tos, lingua FROM accounts WHERE name = ?\");\n+\t\t\tps = con.prepareStatement(\"SELECT id, password, gender, banned, pin, pic, characterslots, tos, language FROM accounts WHERE name = ?\");\n \t\t\tps.setString(1, login);\n \t\t\trs = ps.executeQuery();\n+                        accId = -2;\n \t\t\tif (rs.next()) {\n \t\t\t\taccId = rs.getInt(\"id\");\n-                                if (accId == 0) {\n-                                        // odd case where accId is actually attributed as 0 (further on this leads to getLoginState ACCID = 0, an absurd), thanks Thora for finding this issue\n-                                        return 15;\n-                                } else if (accId < 0) {\n+                                if (accId <= 0) {\n                                         FilePrinter.printError(FilePrinter.LOGIN_EXCEPTION, \"Tried to login with accid \" + accId);\n+                                        return 15;\n                                 }\n                                 \n                                 boolean banned = (rs.getByte(\"banned\") == 1);\n@@ -560,7 +560,7 @@ public int login(String login, String pwd, String nibbleHwid) {\n \t\t\t\tpic = rs.getString(\"pic\");\n \t\t\t\tgender = rs.getByte(\"gender\");\n \t\t\t\tcharacterSlots = rs.getByte(\"characterslots\");\n-                                lingua = rs.getInt(\"lingua\");\n+                                lang = rs.getInt(\"language\");\n \t\t\t\tString passhash = rs.getString(\"password\");\n \t\t\t\tbyte tos = rs.getByte(\"tos\");\n \n@@ -583,7 +583,9 @@ public int login(String login, String pwd, String nibbleHwid) {\n \t\t\t\t\tloggedIn = false;\n \t\t\t\t\tloginok = 4;\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t} else {\n+                                accId = -3;\n+                        }\n \t\t} catch (SQLException e) {\n \t\t\te.printStackTrace();\n \t\t} finally {\n@@ -822,9 +824,10 @@ public int getLoginState() {  // 0 = LOGIN_NOTLOGGEDIN, 1= LOGIN_SERVER_TRANSITI\n \t\t\tint state = rs.getInt(\"loggedin\");\n \t\t\tif (state == LOGIN_SERVER_TRANSITION) {\n \t\t\t\tif (rs.getTimestamp(\"lastlogin\").getTime() + 30000 < Server.getInstance().getCurrentTime()) {\n+                                        int accountId = accId;\n \t\t\t\t\tstate = LOGIN_NOTLOGGEDIN;\n-                                        MapleSessionCoordinator.getInstance().closeSession(session, null);\n-\t\t\t\t\tupdateLoginState(LOGIN_NOTLOGGEDIN);\n+\t\t\t\t\tupdateLoginState(LOGIN_NOTLOGGEDIN);   // ACCID = 0, issue found thanks to Tochi & K u ssss o & Thora & Omo Oppa\n+                                        this.setAccID(accountId);\n \t\t\t\t}\n \t\t\t}\n \t\t\trs.close();\n@@ -1026,6 +1029,9 @@ private void disconnectInternal(boolean shutdown, boolean cashshop) {//once per\n                                 MapleSessionCoordinator.getInstance().closeSession(session, false);\n                                 session.removeAttribute(MapleClient.CLIENT_KEY);\n                         }\n+                        if (!Server.getInstance().hasCharacteridInTransition(session)) {\n+                                updateLoginState(MapleClient.LOGIN_NOTLOGGEDIN);\n+                        }\n                         \n                         engines = null; // thanks Tochi for pointing out a NPE here\n                 }\n@@ -1068,7 +1074,21 @@ public Channel getChannelServer(byte channel) {\n \n         public boolean deleteCharacter(int cid, int senderAccId) {\n                 try {\n-                        return MapleCharacter.deleteCharFromDB(MapleCharacter.loadCharFromDB(cid, this, false), senderAccId);\n+                        MapleCharacter chr = MapleCharacter.loadCharFromDB(cid, this, false);\n+                        \n+                        Integer partyid = chr.getWorldServer().getCharacterPartyid(cid);\n+                        if (partyid != null) {\n+                                this.setPlayer(chr);\n+                            \n+                                MapleParty party = chr.getWorldServer().getParty(partyid);\n+                                chr.setParty(party);\n+                                chr.getMPC();\n+                                chr.leaveParty();   // thanks Vcoc for pointing out deleted characters would still stay in a party\n+                                \n+                                this.setPlayer(null);\n+                        }\n+                        \n+                        return MapleCharacter.deleteCharFromDB(chr, senderAccId);\n                 } catch(SQLException ex) {\n                         ex.printStackTrace();\n                         return false;\n@@ -1545,11 +1565,11 @@ public boolean canBypassPic() {\n                 return MapleLoginBypassCoordinator.getInstance().canLoginBypass(getNibbleHWID(), accId, true);\n         }\n         \n-        public int getLingua() {\n-                return lingua;\n+        public int getLanguage() {\n+                return lang;\n         }\n \n-        public void setLingua(int lingua) {\n-                this.lingua = lingua;\n+        public void setLanguage(int lingua) {\n+                this.lang = lingua;\n         }\n }\n\\ No newline at end of file"}, {"sha": "a1d9c3e9e6e6633347f7d966e72d842bc706625a", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -186,7 +186,7 @@ private void registerLv0Commands(){\n         addCommand(\"uptime\", UptimeCommand.class);\n         addCommand(\"gacha\", GachaCommand.class);\n         addCommand(\"dispose\", DisposeCommand.class);\n-        addCommand(\"changel\", ChangeLinguaCommand.class);\n+        addCommand(\"changel\", ChangeLanguageCommand.class);\n         addCommand(\"equiplv\",  EquipLvCommand.class);\n         addCommand(\"showrates\", ShowRatesCommand.class);\n         addCommand(\"rates\", RatesCommand.class);"}, {"sha": "729adfd926944ef9b37bc246e278f8766515d651", "filename": "src/client/command/commands/gm0/ChangeLanguageCommand.java", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/ChangeLanguageCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/ChangeLanguageCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/ChangeLanguageCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -26,7 +26,7 @@\n import client.command.Command;\n import client.MapleClient;\n \n-public class ChangeLinguaCommand extends Command {\n+public class ChangeLanguageCommand extends Command {\n     {\n         setDescription(\"\");\n     }\n@@ -37,6 +37,6 @@ public void execute(MapleClient c, String[] params) {\n             c.getPlayer().yellowMessage(\"Syntax: !changel <0=ptb, 1=esp, 2=eng>\");\n             return;\n         }\n-        c.setLingua(Integer.parseInt(params[0]));\n+        c.setLanguage(Integer.parseInt(params[0]));\n     }\n }", "previous_filename": "src/client/command/commands/gm0/ChangeLinguaCommand.java"}, {"sha": "38b4ae02e16d4be50d3f9ced3a308f4c5915bb8a", "filename": "src/client/command/commands/gm0/GmCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/GmCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/GmCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/GmCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -51,7 +51,7 @@ public void execute(MapleClient c, String[] params) {\n             return;\n         }\n         String message = player.getLastCommandMessage();\n-        Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[GM MESSAGE]:\" + MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message));\n+        Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[GM Message]:\" + MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message));\n         Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.serverNotice(1, message));\n         FilePrinter.printError(FilePrinter.COMMAND_GM, MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message);\n         player.dropMessage(5, \"Your message '\" + message + \"' was sent to GMs.\");"}, {"sha": "eeae357f7bde38ba3243e1f9c170a203feffcc47", "filename": "src/client/command/commands/gm0/ReportBugCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/ReportBugCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm0/ReportBugCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/ReportBugCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -44,7 +44,7 @@ public void execute(MapleClient c, String[] params) {\n             return;\n         }\n         String message = player.getLastCommandMessage();\n-        Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[BUG]:\" + MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message));\n+        Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[Bug]:\" + MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message));\n         Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.serverNotice(1, message));\n         FilePrinter.printError(FilePrinter.COMMAND_BUG, MapleCharacter.makeMapleReadable(player.getName()) + \": \" + message);\n         player.dropMessage(5, \"Your bug '\" + message + \"' was submitted successfully to our developers. Thank you!\");"}, {"sha": "161c5da4340dc7d803bd01cf404122b2c9b50779", "filename": "src/client/command/commands/gm4/CakeCommand.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm4/CakeCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm4/CakeCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/CakeCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -42,7 +42,6 @@ public void execute(MapleClient c, String[] params) {\n             double mobHp = Double.parseDouble(params[0]);\n             int newHp = (mobHp <= 0) ? Integer.MAX_VALUE : ((mobHp > Integer.MAX_VALUE) ? Integer.MAX_VALUE : (int) mobHp);\n \n-            monster.getStats().setHp(newHp);\n             monster.setStartingHp(newHp);\n         }\n "}, {"sha": "6508ae7a78ed269491ee7f5511521f0a209caf19", "filename": "src/client/command/commands/gm4/ForceVacCommand.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm4/ForceVacCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm4/ForceVacCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/ForceVacCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -54,6 +54,7 @@ public void execute(MapleClient c, String[] params) {\n \n                 if (mapItem.getMeso() > 0) {\n                     player.gainMeso(mapItem.getMeso(), true);\n+                } else if (player.applyConsumeOnPickup(mapItem.getItemId())) {    // thanks Vcoc for pointing out consumables on pickup not being processed here\n                 } else if (mapItem.getItemId() == 4031865 || mapItem.getItemId() == 4031866) {\n                     // Add NX to account, show effect and make item disappear\n                     player.getCashShop().gainCash(1, mapItem.getItemId() == 4031865 ? 100 : 250);"}, {"sha": "18700b424bf73f510a78dde99bac8d1404b1999e", "filename": "src/client/command/commands/gm5/DebugCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm5/DebugCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/command/commands/gm5/DebugCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm5/DebugCommand.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -84,7 +84,7 @@ public void execute(MapleClient c, String[] params) {\n             case \"portal\":\n                 MaplePortal portal = player.getMap().findClosestPortal(player.getPosition());\n                 if (portal != null)\n-                    player.dropMessage(6, \"Closest portal: \" + portal.getId() + \" '\" + portal.getName() + \"' Type: \" + portal.getType() + \" --> toMap: \" + portal.getTargetMapId() + \" scriptname: '\" + portal.getScriptName() + \"' state: \" + portal.getPortalState() + \".\");\n+                    player.dropMessage(6, \"Closest portal: \" + portal.getId() + \" '\" + portal.getName() + \"' Type: \" + portal.getType() + \" --> toMap: \" + portal.getTargetMapId() + \" scriptname: '\" + portal.getScriptName() + \"' state: \" + (portal.getPortalState() ? 1 : 0) + \".\");\n                 else player.dropMessage(6, \"There is no portal on this map.\");\n                 break;\n "}, {"sha": "4aa0da0e240f57d4f2e4c35abdc602b749092a73", "filename": "src/client/creator/CharacterFactory.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/creator/CharacterFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/creator/CharacterFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/creator/CharacterFactory.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -93,7 +93,7 @@ protected synchronized static int createNewCharacter(MapleClient c, String name,\n                 c.announce(MaplePacketCreator.addNewCharEntry(newchar));\n                 \n                 Server.getInstance().createCharacterEntry(newchar);\n-                Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[NEW CHAR]: \" + c.getAccountName() + \" has created a new character with IGN \" + name));\n+                Server.getInstance().broadcastGMMessage(c.getWorld(), MaplePacketCreator.sendYellowTip(\"[New Char]: \" + c.getAccountName() + \" has created a new character with IGN \" + name));\n                 FilePrinter.print(FilePrinter.CREATED_CHAR + c.getAccountName() + \".txt\", c.getAccountName() + \" created character with IGN \" + name);\n                 \n                 return 0;"}, {"sha": "77c89044b86bc300456f30f15bb54053a026893c", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -265,8 +265,12 @@ public static boolean checkSpace(MapleClient c, int itemid, int quantity, String\n         MapleCharacter chr = c.getPlayer();\n         MapleInventory inv = chr.getInventory(type);\n         \n-        if(ii.isPickupRestricted(itemid) && haveItemWithId(inv, itemid)) {\n-            return false;\n+        if (ii.isPickupRestricted(itemid)) {\n+            if (haveItemWithId(inv, itemid)) {\n+                return false;\n+            } else if (ItemConstants.isEquipment(itemid) && haveItemWithId(chr.getInventory(MapleInventoryType.EQUIPPED), itemid)) {\n+                return false;\n+            }\n         }\n         \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n@@ -313,8 +317,12 @@ public static int checkSpaceProgressively(MapleClient c, int itemid, int quantit\n         MapleCharacter chr = c.getPlayer();\n         MapleInventory inv = chr.getInventory(type);\n         \n-        if(ii.isPickupRestricted(itemid) && haveItemWithId(inv, itemid)) {\n-            return 0;\n+        if (ii.isPickupRestricted(itemid)) {\n+            if (haveItemWithId(inv, itemid)) {\n+                return 0;\n+            } else if (ItemConstants.isEquipment(itemid) && haveItemWithId(chr.getInventory(MapleInventoryType.EQUIPPED), itemid)) {\n+                return 0;   // thanks Captain & Aika & Vcoc for pointing out inventory checkup on player trades missing out one-of-a-kind items.\n+            }\n         }\n         \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n@@ -430,7 +438,7 @@ public static void removeById(MapleClient c, MapleInventoryType type, int itemId\n             }\n         }\n         if (removeQuantity > 0 && type != MapleInventoryType.CANHOLD) {\n-            throw new RuntimeException(\"[HACK] Not enough items available of Item:\" + itemId + \", Quantity (After Quantity/Over Current Quantity): \" + (quantity - removeQuantity) + \"/\" + quantity);\n+            throw new RuntimeException(\"[Hack] Not enough items available of Item:\" + itemId + \", Quantity (After Quantity/Over Current Quantity): \" + (quantity - removeQuantity) + \"/\" + quantity);\n         }\n     }\n "}, {"sha": "f46907eec6d11a6a7964e552c7f0ae9e29b9b9ad", "filename": "src/client/newyear/NewYearCardRecord.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/newyear/NewYearCardRecord.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/newyear/NewYearCardRecord.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/newyear/NewYearCardRecord.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -318,7 +318,7 @@ public static void removeAllNewYearCard(boolean send, MapleCharacter chr) {\n                         other.removeNewYearRecord(nyc);\n                         other.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(other, nyc, 0xE, 0));\n \n-                        other.dropMessage(6, \"[NEW YEAR] \" + chr.getName() + \" threw away the New Year card.\");\n+                        other.dropMessage(6, \"[New Year] \" + chr.getName() + \" threw away the New Year card.\");\n                     }\n                 }\n             } else {\n@@ -336,7 +336,7 @@ public static void removeAllNewYearCard(boolean send, MapleCharacter chr) {\n                         other.removeNewYearRecord(nyc);\n                         other.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(other, nyc, 0xE, 0));\n \n-                        other.dropMessage(6, \"[NEW YEAR] \" + chr.getName() + \" threw away the New Year card.\");\n+                        other.dropMessage(6, \"[New Year] \" + chr.getName() + \" threw away the New Year card.\");\n                     }\n                 }\n             }"}, {"sha": "929106d9e5ef855bc3775fe06b550711de64922a", "filename": "src/client/processor/DueyProcessor.java", "status": "modified", "additions": 3, "deletions": 20, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/processor/DueyProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/client/processor/DueyProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/DueyProcessor.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -42,6 +42,7 @@\n import net.server.channel.Channel;\n import server.DueyPackages;\n import server.MapleItemInformationProvider;\n+import server.MapleTrade;\n import tools.DatabaseConnection;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n@@ -230,24 +231,6 @@ private static void showDueyNotification(MapleClient c, MapleCharacter player) {\n         }\n     }\n     \n-    private static int getFee(long meso) {\n-        long fee = 0;\n-        if (meso >= 100000000) {\n-            fee = (meso * 6) / 100;\n-        } else if (meso >= 25000000) {\n-            fee = (meso * 5) / 100;\n-        } else if (meso >= 10000000) {\n-            fee = (meso * 4) / 100;\n-        } else if (meso >= 5000000) {\n-            fee = (meso * 3) / 100;\n-        } else if (meso >= 1000000) {\n-            fee = (meso * 18) / 1000;\n-        } else if (meso >= 100000) {\n-            fee = (meso * 8) / 1000;\n-        }\n-        return (int) fee;\n-    }\n-    \n     private static void addMesoToDB(int mesos, String sName, int recipientID) {\n         addItemToDB(null, 1, mesos, sName, recipientID);\n     }\n@@ -404,7 +387,7 @@ public static void dueySendItem(MapleClient c, byte inventId, short itemPos, sho\n                         }\n \n                         MapleKarmaManipulator.toggleKarmaFlagToUntradeable(item);\n-                        addItemToDB(item, amount, mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+                        addItemToDB(item, amount, mesos - MapleTrade.getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n                     } else {\n                         if (item != null) {\n                             c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_INCORRECT_REQUEST.getCode()));\n@@ -415,7 +398,7 @@ public static void dueySendItem(MapleClient c, byte inventId, short itemPos, sho\n                     c.getPlayer().gainMeso(-finalcost, false);\n                     c.announce(MaplePacketCreator.sendDueyMSG(DueyProcessor.Actions.TOCLIENT_SEND_SUCCESSFULLY_SENT.getCode()));    \n \n-                    addMesoToDB(mesos - getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n+                    addMesoToDB(mesos - MapleTrade.getFee(mesos), c.getPlayer().getName(), getAccIdFromCNAME(recipient, false));\n                 }\n \n                 if (rClient != null && rClient.isLoggedIn() && !rClient.getPlayer().isAwayFromWorld()) {"}, {"sha": "cde341f421c8850a5adde329b817fb7bb8352846", "filename": "src/constants/LanguageConstants.java", "status": "modified", "additions": 49, "deletions": 49, "changes": 98, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/constants/LanguageConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/constants/LanguageConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/LanguageConstants.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -7,65 +7,65 @@\n  * @author Drago - Dragohe4rt\n  */\n public class LanguageConstants {\n-\t// Portugues\n-    public static String CPQAzul;\n-    public static String CPQErro;\n-    public static String CPQEntrada;\n-    public static String CPQEscolha;\n-    public static String CPQVermelho;\n+    \n+    public static String CPQBlue;\n+    public static String CPQError;\n+    public static String CPQEntry;\n+    public static String CPQFindError;\n+    public static String CPQRed;\n     public static String CPQPlayerExit;\n-    public static String CPQEntradaLobby;\n-    public static String CPQInicioEscolha;\n-    public static String CPQTempoExtendido;\n-    public static String CPQLiderNaoEncontrado;\n-    public static String CPQInicioEscolhaEmEscolha;\n-    public static String CPQInicioEscolhaEnviada;\n+    public static String CPQEntryLobby;\n+    public static String CPQPickRoom;\n+    public static String CPQExtendTime;\n+    public static String CPQLeaderNotFound;\n+    public static String CPQChallengeRoomAnswer;\n+    public static String CPQChallengeRoomSent;\n \n-    public static LanguageConstants Linguas(MapleCharacter chr) {\n-        if (chr.getLingua() == 0) {\n-            LanguageConstants.CPQAzul = \"Maple Azul\";\n-            LanguageConstants.CPQVermelho = \"Maple Vermelho\";\n-            LanguageConstants.CPQTempoExtendido = \"O tempo foi estendido.\";\n+    public static LanguageConstants Languages(MapleCharacter chr) {\n+        if (chr.getLanguage() == 0) {\n+            LanguageConstants.CPQBlue = \"Maple Azul\";\n+            LanguageConstants.CPQRed = \"Maple Vermelho\";\n+            LanguageConstants.CPQExtendTime = \"O tempo foi estendido.\";\n             LanguageConstants.CPQPlayerExit = \" deixou o Carnaval de Monstros.\";\n-            LanguageConstants.CPQErro = \"Ocorreu um problema. Favor recriar a sala.\";\n-            LanguageConstants.CPQLiderNaoEncontrado = \"Nao foi possivel encontrar o Lider.\";\n-            LanguageConstants.CPQInicioEscolha = \"Inscreva-se no Festival de Monstros!\\\\r\\\\n\";            \n-            LanguageConstants.CPQInicioEscolhaEmEscolha = \"O grupo esta respondendo um desafio no momento.\";\n-            LanguageConstants.CPQInicioEscolhaEnviada = \"Um desafio foi enviado para o grupo na sala. Aguarde um momento.\";\n-            LanguageConstants.CPQEscolha = \"Nao foi possivel encontrar um grupo nesta sala.\\\\r\\\\nProvavelmente o grupo foi desfeito dentro da sala!\";\n-            LanguageConstants.CPQEntradaLobby = \"Agora voce ira receber desafios de outros grupos. Se voce nao aceitar um desafio em 3 minutos, voce sera levado para fora.\";\n-            LanguageConstants.CPQEntrada = \"Voce pode selecionar \\\"Invocar Monstros\\\", \\\"Habilidade\\\", ou \\\"Protetor\\\" como sua tatica durante o Carnaval dos Monstros. Use Tab a F1~F12 para acesso rapido!\";\n+            LanguageConstants.CPQError = \"Ocorreu um problema. Favor recriar a sala.\";\n+            LanguageConstants.CPQLeaderNotFound = \"Nao foi possivel encontrar o Lider.\";\n+            LanguageConstants.CPQPickRoom = \"Inscreva-se no Festival de Monstros!\\r\\n\";            \n+            LanguageConstants.CPQChallengeRoomAnswer = \"O grupo esta respondendo um desafio no momento.\";\n+            LanguageConstants.CPQChallengeRoomSent = \"Um desafio foi enviado para o grupo na sala. Aguarde um momento.\";\n+            LanguageConstants.CPQFindError = \"Nao foi possivel encontrar um grupo nesta sala.\\r\\nProvavelmente o grupo foi desfeito dentro da sala!\";\n+            LanguageConstants.CPQEntryLobby = \"Agora voce ira receber desafios de outros grupos. Se voce nao aceitar um desafio em 3 minutos, voce sera levado para fora.\";\n+            LanguageConstants.CPQEntry = \"Voce pode selecionar \\\"Invocar Monstros\\\", \\\"Habilidade\\\", ou \\\"Protetor\\\" como sua tatica durante o Carnaval dos Monstros. Use Tab a F1~F12 para acesso rapido!\";\n \n             \n             \n-        } else if (chr.getLingua() == 1) {\n-            LanguageConstants.CPQAzul = \"Maple Azul\";\n-            LanguageConstants.CPQVermelho = \"Maple Rojo\";\n-            LanguageConstants.CPQTempoExtendido = \"El tiempo se ha ampliado.\";\n+        } else if (chr.getLanguage() == 1) {\n+            LanguageConstants.CPQBlue = \"Maple Azul\";\n+            LanguageConstants.CPQRed = \"Maple Rojo\";\n+            LanguageConstants.CPQExtendTime = \"El tiempo se ha ampliado.\";\n             LanguageConstants.CPQPlayerExit = \" ha dejado el Carnaval de Monstruos.\";\n-            LanguageConstants.CPQLiderNaoEncontrado = \"No se pudo encontrar el Lider.\";\n-            LanguageConstants.CPQInicioEscolha = \"!Inscribete en el Festival de Monstruos!\\\\r\\\\n\";\n-            LanguageConstants.CPQErro = \"Se ha producido un problema. Por favor, volver a crear una sala.\";\n-            LanguageConstants.CPQInicioEscolhaEmEscolha = \"El grupo esta respondiendo un desafio en el momento.\";\n-            LanguageConstants.CPQInicioEscolhaEnviada = \"Un desafio fue enviado al grupo en la sala. Espera un momento.\";\n-            LanguageConstants.CPQEscolha = \"No se pudo encontrar un grupo en esta sala.\\\\r\\\\nProbablemente el grupo fue deshecho dentro de la sala!\";\n-            LanguageConstants.CPQEntradaLobby = \"Ahora usted recibira los retos de otros grupos. Si usted no acepta un desafio en 3 minutos, usted sera llevado hacia fuera.\";\n-            LanguageConstants.CPQEntrada = \"Usted puede seleccionar \\\"Invocar Monstruos \\\", \\\"Habilidad \\\", o \\\"Protector \\\" como su tactica durante el Carnaval de los Monstruos. Utilice Tab y F1 ~ F12 para acceso rapido!\";\n+            LanguageConstants.CPQLeaderNotFound = \"No se pudo encontrar el Lider.\";\n+            LanguageConstants.CPQPickRoom = \"!Inscribete en el Festival de Monstruos!\\r\\n\";\n+            LanguageConstants.CPQError = \"Se ha producido un problema. Por favor, volver a crear una sala.\";\n+            LanguageConstants.CPQChallengeRoomAnswer = \"El grupo esta respondiendo un desafio en el momento.\";\n+            LanguageConstants.CPQChallengeRoomSent = \"Un desafio fue enviado al grupo en la sala. Espera un momento.\";\n+            LanguageConstants.CPQFindError = \"No se pudo encontrar un grupo en esta sala.\\r\\nProbablemente el grupo fue deshecho dentro de la sala!\";\n+            LanguageConstants.CPQEntryLobby = \"Ahora usted recibira los retos de otros grupos. Si usted no acepta un desafio en 3 minutos, usted sera llevado hacia fuera.\";\n+            LanguageConstants.CPQEntry = \"Usted puede seleccionar \\\"Invocar Monstruos \\\", \\\"Habilidad \\\", o \\\"Protector \\\" como su tactica durante el Carnaval de los Monstruos. Utilice Tab y F1 ~ F12 para acceso rapido!\";\n \n             \n-        } else if (chr.getLingua() == 2) {\n-            LanguageConstants.CPQAzul = \"Maple Blue\";\n-            LanguageConstants.CPQVermelho = \"Maple Red\";\n+        } else if (chr.getLanguage() == 2) {\n+            LanguageConstants.CPQBlue = \"Maple Blue\";\n+            LanguageConstants.CPQRed = \"Maple Red\";\n             LanguageConstants.CPQPlayerExit = \" left the Carnival of Monsters.\";\n-            LanguageConstants.CPQTempoExtendido = \"The time has been extended.\";\n-            LanguageConstants.CPQLiderNaoEncontrado = \"Could not find the Leader.\";\n-            LanguageConstants.CPQErro = \"There was a problem. Please re-create a room.\";\n-            LanguageConstants.CPQInicioEscolha = \"Sign up for the Monster Festival!\\\\r\\\\n\";\n-            LanguageConstants.CPQInicioEscolhaEmEscolha = \"The group is currently facing a challenge.\";\n-            LanguageConstants.CPQInicioEscolhaEnviada = \"A challenge has been sent to the group in the room. Please wait a while.\";\n-            LanguageConstants.CPQEscolha = \"We could not find a group in this room.\\\\r\\\\nProbably the group was scrapped inside the room!\";\n-            LanguageConstants.CPQEntradaLobby = \"You will now receive challenges from other groups. If you do not accept a challenge within 3 minutes, you will be taken out.\";\n-            LanguageConstants.CPQEntrada = \"You can select \\\"Summon Monsters \\\", \\\"Ability \\\", or \\\"Protector \\\" as your tactic during the Monster Carnival. Use Tab and F1 ~ F12 for quick access!\";\n+            LanguageConstants.CPQExtendTime = \"The time has been extended.\";\n+            LanguageConstants.CPQLeaderNotFound = \"Could not find the Leader.\";\n+            LanguageConstants.CPQError = \"There was a problem. Please re-create a room.\";\n+            LanguageConstants.CPQPickRoom = \"Sign up for the Monster Festival!\\r\\n\";\n+            LanguageConstants.CPQChallengeRoomAnswer = \"The group is currently facing a challenge.\";\n+            LanguageConstants.CPQChallengeRoomSent = \"A challenge has been sent to the group in the room. Please wait a while.\";\n+            LanguageConstants.CPQFindError = \"We could not find a group in this room.\\r\\nProbably the group was scrapped inside the room!\";\n+            LanguageConstants.CPQEntryLobby = \"You will now receive challenges from other groups. If you do not accept a challenge within 3 minutes, you will be taken out.\";\n+            LanguageConstants.CPQEntry = \"You can select \\\"Summon Monsters \\\", \\\"Ability \\\", or \\\"Protector \\\" as your tactic during the Monster Carnival. Use Tab and F1 ~ F12 for quick access!\";\n             \n         }\n         return null;"}, {"sha": "e506de0c23d145b061e808e5b0510946541e1f65", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -28,7 +28,7 @@\n     public static final long  COUPON_INTERVAL = 60 * 60 * 1000;\t//60 minutes, 3600000.\n     public static final long  UPDATE_INTERVAL = 777;            //Dictates the frequency on which the \"centralized server time\" is updated.\n     \n-    public static final boolean ENABLE_PIC = false;             //Pick true/false to enable or disable Pic. Delete character required PIC available.\n+    public static final boolean ENABLE_PIC = false;             //Pick true/false to enable or disable Pic. Delete character requires PIC available.\n     public static final boolean ENABLE_PIN = false;             //Pick true/false to enable or disable Pin.\n     \n     public static final int BYPASS_PIC_EXPIRATION = 20;         //Enables PIC bypass, which will remain active for that account by that client machine for N minutes. Set 0 to disable.\n@@ -48,6 +48,7 @@\n     \n     //Ip Configuration\n     public static String HOST;\n+    public static boolean LOCALSERVER;\n \n     //Other Configuration\n     public static boolean JAVA_8;\n@@ -66,6 +67,7 @@\n     public static final boolean USE_MAXRANGE = true;                //Will send and receive packets from all events on a map, rather than those of only view range.\n     public static final boolean USE_MAXRANGE_ECHO_OF_HERO = true;\n     public static final boolean USE_MTS = false;\n+    public static final boolean USE_CPQ = true;                     //Renders the CPQ available or not.\n     public static final boolean USE_AUTOHIDE_GM = false;            //When enabled, GMs are automatically hidden when joining. Thanks to Steven Deblois (steven1152).\n     public static final boolean USE_BUYBACK_SYSTEM = true;          //Enables the HeavenMS-builtin buyback system, to be used by dead players when clicking the MTS button.\n     public static final boolean USE_FIXED_RATIO_HPMP_UPDATE = true; //Enables the HeavenMS-builtin HPMP update based on the current pool to max pool ratio.\n@@ -108,6 +110,7 @@\n     public static final boolean USE_ENABLE_CHAT_LOG = false;        //Write in-game chat to log\n     public static final boolean USE_REBIRTH_SYSTEM = false;         //Flag to enable/disable rebirth system\n     public static final boolean USE_MAP_OWNERSHIP_SYSTEM = true;    //Flag to enable/disable map ownership system\n+    public static final boolean USE_FISHING_SYSTEM = true;          //Flag to enable/disable fishing system\n     \n     //Events/PQs Configuration\n     public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;  //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n@@ -219,6 +222,7 @@\n     public static final int QUEST_POINT_PER_EVENT_CLEAR = 1;     //Each completed event instance awards N quest points, set 0 to disable.\n     \n     //Guild Configuration\n+    public static final int CREATE_GUILD_MIN_PARTNERS = 6;       //Minimum number of members on Guild Headquarters to establish a new guild.\n     public static final int CREATE_GUILD_COST = 1500000;\n     public static final int CHANGE_EMBLEM_COST = 5000000;\n     public static final int EXPAND_GUILD_BASE_COST = 500000;\n@@ -302,6 +306,7 @@\n \n             //Server Host\n             ServerConstants.HOST = p.getProperty(\"HOST\");\n+            ServerConstants.LOCALSERVER = ServerConstants.HOST.startsWith(\"127.\") || ServerConstants.HOST.startsWith(\"localhost\");\n \n             //Sql Database\n             ServerConstants.DB_URL = p.getProperty(\"URL\");"}, {"sha": "bd924fb78eeda89dc215168e8b4fb784a78eae9d", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -34,6 +34,7 @@\n \n import client.MapleClient;\n import constants.ServerConstants;\n+import java.net.InetSocketAddress;\n \n import net.server.Server;\n import net.server.audit.locks.MonitoredLockType;\n@@ -105,6 +106,8 @@ private boolean isLoginServerHandler() {\n     \n     @Override\n     public void sessionOpened(IoSession session) {\n+        session.setAttribute(MapleClient.CLIENT_REMOTE_ADDRESS, ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress());\n+        \n         if (!Server.getInstance().isOnline()) {\n             MapleSessionCoordinator.getInstance().closeSession(session, true);\n             return;"}, {"sha": "0e74859312ff67508b22f9fa0846b6b7762b8426", "filename": "src/net/server/Server.java", "status": "modified", "additions": 29, "deletions": 6, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -98,6 +98,7 @@\n import tools.AutoJCE;\n import tools.DatabaseConnection;\n import tools.Pair;\n+import org.apache.mina.core.session.IoSession;\n \n public class Server {\n     \n@@ -1630,12 +1631,12 @@ private int loadAccountCharactersView(Integer accId, int gmLevel, int fromWorldi\n         return gmLevel;\n     }\n     \n-    private static String getRemoteIp(InetSocketAddress isa) {\n-        return isa.getAddress().getHostAddress();\n+    private static String getRemoteIp(IoSession session) {\n+        return MapleSessionCoordinator.getSessionRemoteAddress(session);\n     }\n     \n-    public void setCharacteridInTransition(InetSocketAddress isa, int charId) {\n-        String remoteIp = getRemoteIp(isa);\n+    public void setCharacteridInTransition(IoSession session, int charId) {\n+        String remoteIp = getRemoteIp(session);\n         \n         lgnWLock.lock();\n         try {\n@@ -1645,8 +1646,8 @@ public void setCharacteridInTransition(InetSocketAddress isa, int charId) {\n         }\n     }\n     \n-    public boolean validateCharacteridInTransition(InetSocketAddress isa, int charId) {\n-        String remoteIp = getRemoteIp(isa);\n+    public boolean validateCharacteridInTransition(IoSession session, int charId) {\n+        String remoteIp = getRemoteIp(session);\n         \n         lgnWLock.lock();\n         try {\n@@ -1657,6 +1658,28 @@ public boolean validateCharacteridInTransition(InetSocketAddress isa, int charId\n         }\n     }\n     \n+    public Integer freeCharacteridInTransition(IoSession session) {\n+        String remoteIp = getRemoteIp(session);\n+        \n+        lgnWLock.lock();\n+        try {\n+            return transitioningChars.remove(remoteIp);\n+        } finally {\n+            lgnWLock.unlock();\n+        }\n+    }\n+    \n+    public boolean hasCharacteridInTransition(IoSession session) {\n+        String remoteIp = getRemoteIp(session);\n+        \n+        lgnRLock.lock();\n+        try {\n+            return transitioningChars.containsKey(remoteIp);\n+        } finally {\n+            lgnRLock.unlock();\n+        }\n+    }\n+    \n     public void registerLoginState(MapleClient c) {\n         srvLock.lock();\n         try {"}, {"sha": "dc3c97b018a63fb807dbb24d93456556e8414807", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -106,6 +106,7 @@\n     private MapleEvent event;\n     private boolean finishedShutdown = false;\n     private int usedDojo = 0;\n+    private Set<Integer> usedMC = new HashSet<>();\n     \n     private ScheduledFuture<?> respawnTask;\n     \n@@ -992,6 +993,22 @@ public void runCheckOwnedMapsSchedule() {\n         }\n     }\n     \n+    private static int getMonsterCarnivalRoom(boolean cpq1, int field) {\n+        return (cpq1 ? 0 : 100) + field;\n+    }\n+    \n+    public void initMonsterCarnival(boolean cpq1, int field) {\n+        usedMC.add(getMonsterCarnivalRoom(cpq1, field));\n+    }\n+    \n+    public void finishMonsterCarnival(boolean cpq1, int field) {\n+        usedMC.remove(getMonsterCarnivalRoom(cpq1, field));\n+    }\n+    \n+    public boolean canInitMonsterCarnival(boolean cpq1, int field) {\n+        return !usedMC.contains(getMonsterCarnivalRoom(cpq1, field));\n+    }\n+    \n     private static int getChannelSchedulerIndex(int mapid) {\n         int section = 1000000000 / ServerConstants.CHANNEL_LOCKS;\n         return mapid / section;"}, {"sha": "1e71f990ad9f637a029ca5d97e0072a900e91202", "filename": "src/net/server/channel/handlers/GuildOperationHandler.java", "status": "modified", "additions": 57, "deletions": 25, "changes": 82, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/GuildOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/GuildOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GuildOperationHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -30,8 +30,13 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import tools.MaplePacketCreator;\n import client.MapleCharacter;\n+import java.util.HashSet;\n+import java.util.Set;\n import net.server.Server;\n+import net.server.coordinator.matchchecker.MatchCheckerListenerFactory.MatchCheckerType;\n import net.server.guild.MapleAlliance;\n+import net.server.world.MapleParty;\n+import net.server.world.World;\n \n public final class GuildOperationHandler extends AbstractMaplePacketHandler {\n     private boolean isGuildNameAcceptable(String name) {\n@@ -56,36 +61,37 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 //c.announce(MaplePacketCreator.showGuildInfo(mc));\n                 break;\n             case 0x02:\n-                if (mc.getGuildId() > 0 || mc.getMapId() != 200000301) {\n-                    c.getPlayer().dropMessage(1, \"You cannot create a new Guild while in one.\");\n+                if (mc.getGuildId() > 0) {\n+                    mc.dropMessage(1, \"You cannot create a new Guild while in one.\");\n                     return;\n                 }\n                 if (mc.getMeso() < ServerConstants.CREATE_GUILD_COST) {\n-                    c.getPlayer().dropMessage(1, \"You do not have \" + GameConstants.numberWithCommas(ServerConstants.CREATE_GUILD_COST) + \" mesos to create a Guild.\");\n+                    mc.dropMessage(1, \"You do not have \" + GameConstants.numberWithCommas(ServerConstants.CREATE_GUILD_COST) + \" mesos to create a Guild.\");\n                     return;\n                 }\n                 String guildName = slea.readMapleAsciiString();\n                 if (!isGuildNameAcceptable(guildName)) {\n-                    c.getPlayer().dropMessage(1, \"The Guild name you have chosen is not accepted.\");\n+                    mc.dropMessage(1, \"The Guild name you have chosen is not accepted.\");\n                     return;\n                 }\n                 \n-                int gid = Server.getInstance().createGuild(mc.getId(), guildName);\n-                if (gid == 0) {\n-                    c.announce(MaplePacketCreator.genericGuildMessage((byte) 0x1c));\n+                Set<MapleCharacter> eligibleMembers = new HashSet<>(MapleGuild.getEligiblePlayersForGuild(mc));\n+                if (eligibleMembers.size() < ServerConstants.CREATE_GUILD_MIN_PARTNERS) {\n+                    mc.dropMessage(1, \"The Guild you are trying to create don't meet the minimum criteria of number of founders.\");\n                     return;\n                 }\n-                mc.gainMeso(-ServerConstants.CREATE_GUILD_COST, true, false, true);\n                 \n-                mc.getMGC().setGuildId(gid);\n-                Server.getInstance().getGuild(mc.getGuildId(), mc.getWorld(), mc);  // initialize guild structure\n-                Server.getInstance().changeRank(gid, mc.getId(), 1);\n+                if (!MapleParty.createParty(mc, true)) {\n+                    mc.dropMessage(1, \"You cannot create a new Guild while in a party.\");\n+                    return;\n+                }\n                 \n-                c.announce(MaplePacketCreator.showGuildInfo(mc));\n+                Set<Integer> eligibleCids = new HashSet<>();\n+                for (MapleCharacter chr : eligibleMembers) {\n+                    eligibleCids.add(chr.getId());\n+                }\n                 \n-                c.getPlayer().dropMessage(1, \"You have successfully created a Guild.\");\n-                mc.getGuild().broadcastNameChanged();\n-                mc.getGuild().broadcastEmblemChanged();\n+                c.getWorldServer().getMatchCheckerCoordinator().createMatchConfirmation(MatchCheckerType.GUILD_CREATION, c.getWorld(), mc.getId(), eligibleCids, guildName);                \n                 break;\n             case 0x05:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {\n@@ -101,13 +107,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             case 0x06:\n                 if (mc.getGuildId() > 0) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" attempted to join a guild when s/he is already in one.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" attempted to join a guild when s/he is already in one.\");\n                     return;\n                 }\n-                gid = slea.readInt();\n+                int gid = slea.readInt();\n                 int cid = slea.readInt();\n                 if (cid != mc.getId()) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" attempted to join a guild with a different character id.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" attempted to join a guild with a different character id.\");\n                     return;\n                 }\n                 \n@@ -121,7 +127,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \n                 int s = Server.getInstance().addGuildMember(mc.getMGC(), mc);\n                 if (s == 0) {\n-                    c.getPlayer().dropMessage(1, \"The guild you are trying to join is already full.\");\n+                    mc.dropMessage(1, \"The guild you are trying to join is already full.\");\n                     mc.getMGC().setGuildId(0);\n                     return;\n                 }\n@@ -139,7 +145,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 cid = slea.readInt();\n                 String name = slea.readMapleAsciiString();\n                 if (cid != mc.getId() || !name.equals(mc.getName()) || mc.getGuildId() <= 0) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" tried to quit guild under the name \\\"\" + name + \"\\\" and current guild id of \" + mc.getGuildId() + \".\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" tried to quit guild under the name \\\"\" + name + \"\\\" and current guild id of \" + mc.getGuildId() + \".\");\n                     return;\n                 }\n                 \n@@ -162,7 +168,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 cid = slea.readInt();\n                 name = slea.readMapleAsciiString();\n                 if (mc.getGuildRank() > 2 || mc.getGuildId() <= 0) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" is trying to expel without rank 1 or 2.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" is trying to expel without rank 1 or 2.\");\n                     return;\n                 }\n                 \n@@ -171,7 +177,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             case 0x0d:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() != 1) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" tried to change guild rank titles when s/he does not have permission.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" tried to change guild rank titles when s/he does not have permission.\");\n                     return;\n                 }\n                 String ranks[] = new String[5];\n@@ -185,7 +191,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 cid = slea.readInt();\n                 byte newRank = slea.readByte();\n                 if (mc.getGuildRank() > 2 || (newRank <= 2 && mc.getGuildRank() != 1) || mc.getGuildId() <= 0) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" is trying to change rank outside of his/her permissions.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" is trying to change rank outside of his/her permissions.\");\n                     return;\n                 }\n                 if (newRank <= 1 || newRank > 5) {\n@@ -195,7 +201,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             case 0x0f:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() != 1 || mc.getMapId() != 200000301) {\n-                    System.out.println(\"[hax] \" + mc.getName() + \" tried to change guild emblem without being the guild leader.\");\n+                    System.out.println(\"[Hack] \" + mc.getName() + \" tried to change guild emblem without being the guild leader.\");\n                     return;\n                 }\n                 if (mc.getMeso() < ServerConstants.CHANGE_EMBLEM_COST) {\n@@ -219,14 +225,40 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             case 0x10:\n                 if (mc.getGuildId() <= 0 || mc.getGuildRank() > 2) {\n-                    if(mc.getGuildId() <= 0) System.out.println(\"[hax] \" + mc.getName() + \" tried to change guild notice while not in a guild.\");\n+                    if(mc.getGuildId() <= 0) System.out.println(\"[Hack] \" + mc.getName() + \" tried to change guild notice while not in a guild.\");\n                     return;\n                 }\n                 String notice = slea.readMapleAsciiString();\n                 if (notice.length() > 100) {\n                     return;\n                 }\n                 Server.getInstance().setGuildNotice(mc.getGuildId(), notice);\n+                break;\n+            case 0x1E:\n+                slea.readInt();\n+                World wserv = c.getWorldServer();\n+                \n+                if (mc.getParty() != null) {\n+                    wserv.getMatchCheckerCoordinator().dismissMatchConfirmation(mc.getId());\n+                    return;\n+                }\n+                \n+                int leaderid = wserv.getMatchCheckerCoordinator().getMatchConfirmationLeaderid(mc.getId());\n+                if (leaderid != -1) {\n+                    boolean result = slea.readByte() != 0;\n+                    if (result) {\n+                        MapleCharacter leader = wserv.getPlayerStorage().getCharacterById(leaderid);\n+                        if (leader != null) {\n+                            int partyid = leader.getPartyId();\n+                            if (partyid != -1) {\n+                                MapleParty.joinParty(mc, partyid, true);\n+                            }\n+                        }\n+                    }\n+                    \n+                    wserv.getMatchCheckerCoordinator().answerMatchConfirmation(mc.getId(), result);\n+                }\n+                \n                 break;\n             default:\n                 System.out.println(\"Unhandled GUILD_OPERATION packet: \\n\" + slea.toString());"}, {"sha": "3b2539afbf89316eea77364bcca561c3e77d0c2c", "filename": "src/net/server/channel/handlers/MessengerHandler.java", "status": "modified", "additions": 75, "deletions": 74, "changes": 149, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/MessengerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/MessengerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MessengerHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -37,91 +37,92 @@\n public final class MessengerHandler extends AbstractMaplePacketHandler {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        c.tryacquireClient();\n-        try {\n-            String input;\n-            byte mode = slea.readByte();\n-            MapleCharacter player = c.getPlayer();\n-            World world = c.getWorldServer();\n-            MapleMessenger messenger = player.getMessenger();\n-            switch (mode) {\n-                case 0x00:\n-                    int messengerid = slea.readInt();\n-                    if (messenger == null) {\n-                        if (messengerid == 0) {\n-                            MapleInviteCoordinator.removeInvite(InviteType.MESSENGER, player.getId());\n-                            \n-                            MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, 0);\n-                            messenger = world.createMessenger(messengerplayer);\n-                            player.setMessenger(messenger);\n-                            player.setMessengerPosition(0);\n-                        } else {\n-                            messenger = world.getMessenger(messengerid);\n-                            if (messenger != null) {\n-                                Pair<InviteResult, MapleCharacter> inviteRes = MapleInviteCoordinator.answerInvite(InviteType.MESSENGER, player.getId(), messengerid, true);\n-                                InviteResult res = inviteRes.getLeft();\n-                                if (res == InviteResult.ACCEPTED) {\n-                                    int position = messenger.getLowestPosition();\n-                                    MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, position);\n-                                    if (messenger.getMembers().size() < 3) {\n-                                        player.setMessenger(messenger);\n-                                        player.setMessengerPosition(position);\n-                                        world.joinMessenger(messenger.getId(), messengerplayer, player.getName(), messengerplayer.getChannel());\n+        if (c.tryacquireClient()) {\n+            try {\n+                String input;\n+                byte mode = slea.readByte();\n+                MapleCharacter player = c.getPlayer();\n+                World world = c.getWorldServer();\n+                MapleMessenger messenger = player.getMessenger();\n+                switch (mode) {\n+                    case 0x00:\n+                        int messengerid = slea.readInt();\n+                        if (messenger == null) {\n+                            if (messengerid == 0) {\n+                                MapleInviteCoordinator.removeInvite(InviteType.MESSENGER, player.getId());\n+\n+                                MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, 0);\n+                                messenger = world.createMessenger(messengerplayer);\n+                                player.setMessenger(messenger);\n+                                player.setMessengerPosition(0);\n+                            } else {\n+                                messenger = world.getMessenger(messengerid);\n+                                if (messenger != null) {\n+                                    Pair<InviteResult, MapleCharacter> inviteRes = MapleInviteCoordinator.answerInvite(InviteType.MESSENGER, player.getId(), messengerid, true);\n+                                    InviteResult res = inviteRes.getLeft();\n+                                    if (res == InviteResult.ACCEPTED) {\n+                                        int position = messenger.getLowestPosition();\n+                                        MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, position);\n+                                        if (messenger.getMembers().size() < 3) {\n+                                            player.setMessenger(messenger);\n+                                            player.setMessengerPosition(position);\n+                                            world.joinMessenger(messenger.getId(), messengerplayer, player.getName(), messengerplayer.getChannel());\n+                                        }\n+                                    } else {\n+                                        player.message(\"Could not verify your Maple Messenger accept since the invitation rescinded.\");\n                                     }\n-                                } else {\n-                                    player.message(\"Could not verify your Maple Messenger accept since the invitation rescinded.\");\n                                 }\n                             }\n+                        } else {\n+                            MapleInviteCoordinator.answerInvite(InviteType.MESSENGER, player.getId(), messengerid, false);\n                         }\n-                    } else {\n-                        MapleInviteCoordinator.answerInvite(InviteType.MESSENGER, player.getId(), messengerid, false);\n-                    }\n-                    break;\n-                case 0x02:\n-                    player.closePlayerMessenger();\n-                    break;\n-                case 0x03:\n-                    if (messenger == null) {\n-                        c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : This Maple Messenger is currently unavailable. Please quit this chat.\"));\n-                    } else if (messenger.getMembers().size() < 3) {\n-                        input = slea.readMapleAsciiString();\n-                        MapleCharacter target = c.getChannelServer().getPlayerStorage().getCharacterByName(input);\n-                        if (target != null) {\n-                            if (target.getMessenger() == null) {\n-                                if (MapleInviteCoordinator.createInvite(InviteType.MESSENGER, c.getPlayer(), messenger.getId(), target.getId())) {\n-                                    target.getClient().announce(MaplePacketCreator.messengerInvite(c.getPlayer().getName(), messenger.getId()));\n-                                    c.announce(MaplePacketCreator.messengerNote(input, 4, 1));\n+                        break;\n+                    case 0x02:\n+                        player.closePlayerMessenger();\n+                        break;\n+                    case 0x03:\n+                        if (messenger == null) {\n+                            c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : This Maple Messenger is currently unavailable. Please quit this chat.\"));\n+                        } else if (messenger.getMembers().size() < 3) {\n+                            input = slea.readMapleAsciiString();\n+                            MapleCharacter target = c.getChannelServer().getPlayerStorage().getCharacterByName(input);\n+                            if (target != null) {\n+                                if (target.getMessenger() == null) {\n+                                    if (MapleInviteCoordinator.createInvite(InviteType.MESSENGER, c.getPlayer(), messenger.getId(), target.getId())) {\n+                                        target.getClient().announce(MaplePacketCreator.messengerInvite(c.getPlayer().getName(), messenger.getId()));\n+                                        c.announce(MaplePacketCreator.messengerNote(input, 4, 1));\n+                                    } else {\n+                                        c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : \" + input + \" is already managing a Maple Messenger invitation\"));\n+                                    }\n                                 } else {\n-                                    c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : \" + input + \" is already managing a Maple Messenger invitation\"));\n+                                    c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : \" + input + \" is already using Maple Messenger\"));\n                                 }\n                             } else {\n-                                c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : \" + input + \" is already using Maple Messenger\"));\n+                                if (world.find(input) > -1) {\n+                                    world.messengerInvite(c.getPlayer().getName(), messenger.getId(), input, c.getChannel());\n+                                } else {\n+                                    c.announce(MaplePacketCreator.messengerNote(input, 4, 0));\n+                                }\n                             }\n                         } else {\n-                            if (world.find(input) > -1) {\n-                                world.messengerInvite(c.getPlayer().getName(), messenger.getId(), input, c.getChannel());\n-                            } else {\n-                                c.announce(MaplePacketCreator.messengerNote(input, 4, 0));\n-                            }\n+                            c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : You cannot have more than 3 people in the Maple Messenger\"));\n+                        }\n+                        break;\n+                    case 0x05:\n+                        String targeted = slea.readMapleAsciiString();\n+                        world.declineChat(targeted, player);\n+                        break;\n+                    case 0x06:\n+                        if (messenger != null) {\n+                            MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, player.getMessengerPosition());\n+                            input = slea.readMapleAsciiString();\n+                            world.messengerChat(messenger, input, messengerplayer.getName());\n                         }\n-                    } else {\n-                        c.announce(MaplePacketCreator.messengerChat(player.getName() + \" : You cannot have more than 3 people in the Maple Messenger\"));\n-                    }\n-                    break;\n-                case 0x05:\n-                    String targeted = slea.readMapleAsciiString();\n-                    world.declineChat(targeted, player);\n-                    break;\n-                case 0x06:\n-                    if (messenger != null) {\n-                        MapleMessengerCharacter messengerplayer = new MapleMessengerCharacter(player, player.getMessengerPosition());\n-                        input = slea.readMapleAsciiString();\n-                        world.messengerChat(messenger, input, messengerplayer.getName());\n-                    }\n-                    break;\n+                        break;\n+                }\n+            } finally {\n+                c.releaseClient();\n             }\n-        } finally {\n-            c.releaseClient();\n         }\n     }\n }"}, {"sha": "4156bdfc3d0be9782f5c82debc6c6b3437cc0c6f", "filename": "src/net/server/channel/handlers/MonsterCarnivalHandler.java", "status": "modified", "additions": 94, "deletions": 97, "changes": 191, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/MonsterCarnivalHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MonsterCarnivalHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -47,120 +47,117 @@\n \n     @Override\n     public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        c.tryacquireClient();\n-        try {\n+        if (c.tryacquireClient()) {\n             try {\n-                int tab = slea.readByte();\n-                int num = slea.readByte();\n-                int neededCP = 0;\n-                if (tab == 0) { \n-                    final List<Pair<Integer, Integer>> mobs = c.getPlayer().getMap().getMobsToSpawn();\n-                    if (num >= mobs.size() || c.getPlayer().getCP() < mobs.get(num).right) {\n-                        c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n-                        c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                    \n-                    final MapleMonster mob = MapleLifeFactory.getMonster(mobs.get(num).left);\n-                    MonsterCarnival mcpq = c.getPlayer().getMonsterCarnival();\n-                    if (mcpq != null) {                        \n-                        if (!mcpq.canSummonR() && c.getPlayer().getTeam() == 0 || !mcpq.canSummonB() && c.getPlayer().getTeam() == 1) {\n-                            c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n+                try {\n+                    int tab = slea.readByte();\n+                    int num = slea.readByte();\n+                    int neededCP = 0;\n+                    if (tab == 0) { \n+                        final List<Pair<Integer, Integer>> mobs = c.getPlayer().getMap().getMobsToSpawn();\n+                        if (num >= mobs.size() || c.getPlayer().getCP() < mobs.get(num).right) {\n+                            c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n                             c.announce(MaplePacketCreator.enableActions());\n                             return;\n                         }\n-                        \n-                        if (c.getPlayer().getTeam() == 0) {\n-                            mcpq.summonR();\n-                        } else {\n-                            mcpq.summonB();\n+\n+                        final MapleMonster mob = MapleLifeFactory.getMonster(mobs.get(num).left);\n+                        MonsterCarnival mcpq = c.getPlayer().getMonsterCarnival();\n+                        if (mcpq != null) {                        \n+                            if (!mcpq.canSummonR() && c.getPlayer().getTeam() == 0 || !mcpq.canSummonB() && c.getPlayer().getTeam() == 1) {\n+                                c.announce(MaplePacketCreator.CPQMessage((byte) 2));\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            }\n+\n+                            if (c.getPlayer().getTeam() == 0) {\n+                                mcpq.summonR();\n+                            } else {\n+                                mcpq.summonB();\n+                            }\n+\n+                            Point spawnPos = c.getPlayer().getMap().getRandomSP(c.getPlayer().getTeam());\n+                            mob.setPosition(spawnPos);\n+\n+                            c.getPlayer().getMap().addMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n+                            c.getPlayer().getMap().addAllMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n+                            c.announce(MaplePacketCreator.enableActions());\n                         }\n-                        \n-                        Point spawnPos = c.getPlayer().getMap().getRandomSP(c.getPlayer().getTeam());\n-                        mob.setPosition(spawnPos);\n-                        \n-                        c.getPlayer().getMap().addMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n-                        c.getPlayer().getMap().addAllMonsterSpawn(mob, 1, c.getPlayer().getTeam());\n-                        c.announce(MaplePacketCreator.enableActions());\n-                    }\n \n-                    neededCP = mobs.get(num).right;\n-                } else if (tab == 1) { //debuffs\n-                    final List<Integer> skillid = c.getPlayer().getMap().getSkillIds();\n-                    if (num >= skillid.size()) {\n-                        c.getPlayer().dropMessage(5, \"Ocorreu um erro.\");\n-                        c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                    final MCSkill skill = MapleCarnivalFactory.getInstance().getSkill(skillid.get(num)); //ugh wtf\n-                    if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n-                        c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n-                        c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                    final MapleDisease dis = skill.getDisease();\n-                    MapleParty enemies = c.getPlayer().getParty().getEnemy();\n-                    if (skill.targetsAll) {\n-                        int chanceAcerto = 0;\n-                        if (dis.getDisease() == 121 || dis.getDisease() == 122 || dis.getDisease() == 125 || dis.getDisease() == 126) {\n-                            chanceAcerto = (int) (Math.random() * 100);\n+                        neededCP = mobs.get(num).right;\n+                    } else if (tab == 1) { //debuffs\n+                        final List<Integer> skillid = c.getPlayer().getMap().getSkillIds();\n+                        if (num >= skillid.size()) {\n+                            c.getPlayer().dropMessage(5, \"An unexpected error has occurred.\");\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n+                        }\n+                        final MCSkill skill = MapleCarnivalFactory.getInstance().getSkill(skillid.get(num)); //ugh wtf\n+                        if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n+                            c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n                         }\n-                        if (chanceAcerto <= 80) {\n-                            for (MaplePartyCharacter chrS : enemies.getPartyMembers()) {\n+                        final MapleDisease dis = skill.getDisease();\n+                        MapleParty enemies = c.getPlayer().getParty().getEnemy();\n+                        if (skill.targetsAll) {\n+                            int chanceAcerto = 0;\n+                            if (dis.getDisease() == 121 || dis.getDisease() == 122 || dis.getDisease() == 125 || dis.getDisease() == 126) {\n+                                chanceAcerto = (int) (Math.random() * 100);\n+                            }\n+                            if (chanceAcerto <= 80) {\n+                                for (MaplePartyCharacter chrS : enemies.getPartyMembers()) {\n+                                    if (dis == null) {\n+                                        chrS.getPlayer().dispel();\n+                                    } else {\n+                                        chrS.getPlayer().giveDebuff(dis, skill.getSkill());\n+                                    }\n+                                }\n+                            }\n+                        } else {\n+                            int amount = enemies.getMembers().size() - 1;\n+                            int randd = (int) Math.floor(Math.random() * amount);\n+                            MapleCharacter chrApp = c.getPlayer().getMap().getCharacterById(enemies.getMemberByPos(randd).getId());\n+                            if (chrApp != null && chrApp.getMap().isCPQMap()) {\n                                 if (dis == null) {\n-                                    chrS.getPlayer().dispel();\n+                                    chrApp.dispel();\n                                 } else {\n-                                    chrS.getPlayer().giveDebuff(dis, skill.getSkill());\n-                                }\n-                                if (!skill.targetsAll) {\n-                                    break;\n+                                    chrApp.giveDebuff(dis, skill.getSkill());\n                                 }\n                             }\n                         }\n-                    } else {\n-                        int amount = enemies.getMembers().size() - 1;\n-                        int randd = (int) Math.floor(Math.random() * amount);\n-                        MapleCharacter chrApp = c.getChannelServer().getPlayerStorage().getCharacterById(enemies.getMemberByPos(randd).getId());\n-                        if (chrApp != null && chrApp.getMap().isCPQMap()) {\n-                            if (dis == null) {\n-                                chrApp.dispel();\n-                            } else {\n-                                chrApp.giveDebuff(dis, skill.getSkill());\n-                            }\n-                        }\n-                    }\n-                    neededCP = skill.cpLoss;\n-                    c.announce(MaplePacketCreator.enableActions());\n-                } else if (tab == 2) { //protectors\n-                    final MCSkill skill = MapleCarnivalFactory.getInstance().getGuardian(num);\n-                    if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n-                        c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n+                        neededCP = skill.cpLoss;\n                         c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    }\n-                    int success = c.getPlayer().getMap().spawnGuardian(c.getPlayer().getTeam(), num);\n-                    if (success == -1 || success == 0 || success == 2) {\n-                        if (success == -1) {\n-                            c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n-                        } else if (success == 0) {\n-                            c.announce(MaplePacketCreator.CPQMessage((byte) 4));\n-                        } else if (success == 2) {\n-                            c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                    } else if (tab == 2) { //protectors\n+                        final MCSkill skill = MapleCarnivalFactory.getInstance().getGuardian(num);\n+                        if (skill == null || c.getPlayer().getCP() < skill.cpLoss) {\n+                            c.announce(MaplePacketCreator.CPQMessage((byte) 1));\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n+                        }\n+                        int success = c.getPlayer().getMap().spawnGuardian(c.getPlayer().getTeam(), num);\n+                        if (success == -1 || success == 0 || success == 2) {\n+                            if (success == -1) {\n+                                c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                            } else if (success == 0) {\n+                                c.announce(MaplePacketCreator.CPQMessage((byte) 4));\n+                            } else if (success == 2) {\n+                                c.announce(MaplePacketCreator.CPQMessage((byte) 3));\n+                            }\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return;\n+                        } else {\n+                            neededCP = skill.cpLoss;\n                         }\n-                        c.announce(MaplePacketCreator.enableActions());\n-                        return;\n-                    } else {\n-                        neededCP = skill.cpLoss;\n                     }\n+                    c.getPlayer().gainCP(-neededCP);\n+                    c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.playerSummoned(c.getPlayer().getName(), tab, num));\n+                }catch (Exception e) {\n+                    e.printStackTrace();\n                 }\n-                c.getPlayer().gainCP(-neededCP);\n-                c.getPlayer().getMap().broadcastMessage(MaplePacketCreator.playerSummoned(c.getPlayer().getName(), tab, num));\n-            }catch (Exception e) {\n-                e.printStackTrace();\n+            } finally {\n+                c.releaseClient();\n             }\n-        } finally {\n-            c.releaseClient();\n         }\n     }\n-\n }"}, {"sha": "f780cbb3960a71d52e10294b769605a01356478b", "filename": "src/net/server/channel/handlers/NewYearCardHandler.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/NewYearCardHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/NewYearCardHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NewYearCardHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -100,7 +100,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         NewYearCardRecord.updateNewYearCard(newyear);\n \n                         player.getClient().getAbstractPlayerInteraction().gainItem(4301000, (short)1);\n-                        if(!newyear.getMessage().isEmpty()) player.dropMessage(6, \"[NEW YEAR] \" + newyear.getSenderName() + \": \" + newyear.getMessage());\n+                        if(!newyear.getMessage().isEmpty()) player.dropMessage(6, \"[New Year] \" + newyear.getSenderName() + \": \" + newyear.getMessage());\n \n                         player.addNewYearRecord(newyear);\n                         player.announce(MaplePacketCreator.onNewYearCardRes(player, newyear, 6, 0));    // successfully rcvd\n@@ -110,17 +110,17 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         MapleCharacter sender = c.getWorldServer().getPlayerStorage().getCharacterById(newyear.getSenderId());\n                         if(sender != null && sender.isLoggedinWorld()) {\n                             sender.getMap().broadcastMessage(MaplePacketCreator.onNewYearCardRes(sender, newyear, 0xD, 0));\n-                            sender.dropMessage(6, \"[NEW YEAR] Your addressee successfully received the New Year card.\");\n+                            sender.dropMessage(6, \"[New Year] Your addressee successfully received the New Year card.\");\n                         }\n                     } else {\n                         player.announce(MaplePacketCreator.onNewYearCardRes(player, -1, 5, 0x10));  // inventory full\n                     }\n                 } else {\n-                    player.dropMessage(6, \"[NEW YEAR] The sender of the New Year card already dropped it. Nothing to receive.\");\n+                    player.dropMessage(6, \"[New Year] The sender of the New Year card already dropped it. Nothing to receive.\");\n                 }\n             } else {\n                 if(newyear == null) {\n-                    player.dropMessage(6, \"[NEW YEAR] The sender of the New Year card already dropped it. Nothing to receive.\");\n+                    player.dropMessage(6, \"[New Year] The sender of the New Year card already dropped it. Nothing to receive.\");\n                 }\n             }\n         }"}, {"sha": "b80c4cc0d56d05a7fd65521d7f149f61aa54c4c2", "filename": "src/net/server/channel/handlers/PartyOperationHandler.java", "status": "modified", "additions": 9, "deletions": 99, "changes": 108, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PartyOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PartyOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PartyOperationHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -34,72 +34,33 @@\n import net.server.coordinator.MapleInviteCoordinator;\n import net.server.coordinator.MapleInviteCoordinator.InviteResult;\n import net.server.coordinator.MapleInviteCoordinator.InviteType;\n+import net.server.coordinator.MapleMatchCheckerCoordinator;\n+import net.server.coordinator.matchchecker.MatchCheckerListenerFactory.MatchCheckerType;\n import scripting.event.EventInstanceManager;\n import server.maps.MapleMap;\n import tools.Pair;\n \n import java.util.List;\n+import server.partyquest.MonsterCarnival;\n \n public final class PartyOperationHandler extends AbstractMaplePacketHandler {\n     \n-    public static void leaveParty(MapleParty party, MaplePartyCharacter partyplayer, MapleClient c) {\n-        World world = c.getWorldServer();\n-        MapleCharacter player = c.getPlayer();\n-        \n-        if (party != null && partyplayer != null) {\n-            if (partyplayer.getId() == party.getLeaderId()) {\n-                c.getWorldServer().removeMapPartyMembers(party.getId());\n-\n-                world.updateParty(party.getId(), PartyOperation.DISBAND, partyplayer);\n-                if (player.getEventInstance() != null) {\n-                    player.getEventInstance().disbandParty();\n-                }\n-            } else {\n-                player.getMap().removePartyMember(player);\n-\n-                world.updateParty(party.getId(), PartyOperation.LEAVE, partyplayer);\n-                if (player.getEventInstance() != null) {\n-                    player.getEventInstance().leftParty(player);\n-                }\n-            }\n-\n-            player.setParty(null);\n-        }\n-    }\n-    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int operation = slea.readByte();\n         MapleCharacter player = c.getPlayer();\n         World world = c.getWorldServer();\n         MapleParty party = player.getParty();\n-        MaplePartyCharacter partyplayer = player.getMPC();\n         switch (operation) {\n             case 1: { // create\n-               \tif(player.getLevel() < 10 && !ServerConstants.USE_PARTY_FOR_STARTERS) {\n-                    c.announce(MaplePacketCreator.partyStatusMessage(10));\n-                    return;\n-            \t}\n-                if (party == null) {\n-                    partyplayer = new MaplePartyCharacter(player);\n-                    party = world.createParty(partyplayer);\n-                    player.setParty(party);\n-                    player.setMPC(partyplayer);\n-                    player.getMap().addPartyMember(player);\n-                    player.silentPartyUpdate();\n-                    \n-                    player.partyOperationUpdate(party, null);\n-                    c.announce(MaplePacketCreator.partyCreated(party, partyplayer.getId()));\n-                } else {\n-                    c.announce(MaplePacketCreator.serverNotice(5, \"You can't create a party as you are already in one.\"));\n-                }\n+               \tMapleParty.createParty(player, false);\n                 break;\n             }\n             case 2: { // leave/disband\n                 if (party != null) {\n                     List<MapleCharacter> partymembers = player.getPartyMembers();\n \n-                    leaveParty(party, partyplayer, c);\n+                    MapleParty.leaveParty(party, c);\n                     player.partyOperationUpdate(party, partymembers);\n                 }\n                 break;\n@@ -110,27 +71,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Pair<InviteResult, MapleCharacter> inviteRes = MapleInviteCoordinator.answerInvite(InviteType.PARTY, player.getId(), partyid, true);\n                 InviteResult res = inviteRes.getLeft();\n                 if (res == InviteResult.ACCEPTED) {\n-                    if (party == null) {\n-                        party = world.getParty(partyid);\n-                        if (party != null) {\n-                            if (party.getMembers().size() < 6) {\n-                                partyplayer = new MaplePartyCharacter(player);\n-                                player.getMap().addPartyMember(player);\n-\n-                                world.updateParty(party.getId(), PartyOperation.JOIN, partyplayer);\n-                                player.receivePartyMemberHP();\n-                                player.updatePartyMemberHP();\n-\n-                                player.partyOperationUpdate(party, null);\n-                            } else {\n-                                c.announce(MaplePacketCreator.partyStatusMessage(17));\n-                            }\n-                        } else {\n-                            c.announce(MaplePacketCreator.serverNotice(5, \"The person you have invited to the party is already in one.\"));\n-                        }\n-                    } else {\n-                        c.announce(MaplePacketCreator.serverNotice(5, \"You can't join the party as you are already in one.\"));\n-                    }\n+                    MapleParty.joinParty(player, partyid, false);\n                 } else {\n                     c.announce(MaplePacketCreator.serverNotice(5, \"You couldn't join the party due to an expired invitation request.\"));\n                 }\n@@ -151,19 +92,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     \n                     if (invited.getParty() == null) {\n                         if (party == null) {\n-                            if(player.getLevel() < 10 && !ServerConstants.USE_PARTY_FOR_STARTERS) {\n-                                c.announce(MaplePacketCreator.partyStatusMessage(10));\n+                            if (!MapleParty.createParty(player, false)) {\n                                 return;\n                             }\n                             \n-                            partyplayer = new MaplePartyCharacter(player);\n-                            party = world.createParty(partyplayer);\n-                            player.setParty(party);\n-                            player.setMPC(partyplayer);\n-                            player.getMap().addPartyMember(player);\n-                            \n-                            player.partyOperationUpdate(party, null);\n-                            c.announce(MaplePacketCreator.partyCreated(party, partyplayer.getId()));\n+                            party = player.getParty();\n                         }\n                         if (party.getMembers().size() < 6) {\n                             if (MapleInviteCoordinator.createInvite(InviteType.PARTY, player, party.getId(), invited.getId())) {\n@@ -184,30 +117,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             case 5: { // expel\n                 int cid = slea.readInt();\n-                if (partyplayer.equals(party.getLeader())) {\n-                    MaplePartyCharacter expelled = party.getMemberById(cid);\n-                    if (expelled != null) {\n-                        MapleCharacter emc = expelled.getPlayer();\n-                        if(emc != null) {\n-                            List<MapleCharacter> partyMembers = emc.getPartyMembers();\n-                            \n-                            MapleMap map = emc.getMap();\n-                            if(map != null) map.removePartyMember(emc);\n-                            \n-                            EventInstanceManager eim = emc.getEventInstance();\n-                            if(eim != null) {\n-                                eim.leftParty(emc);\n-                            }\n-                            \n-                            emc.setParty(null);\n-                            world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n-                            \n-                            emc.partyOperationUpdate(party, partyMembers);\n-                        } else {\n-                            world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n-                        }\n-                    }\n-                }\n+                MapleParty.expelFromParty(party, c, cid);\n                 break;\n             }\n             case 6: { // change leader"}, {"sha": "68b5a5923636b6640a0230039cb70eb477b93a84", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -484,7 +484,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 byte targetSlot = slea.readByte();\n \n                 if (targetSlot < 1 || targetSlot > 9) {\n-                    System.out.println(\"[h4x] \" + chr.getName() + \" Trying to dupe on trade slot.\");\n+                    System.out.println(\"[Hack] \" + chr.getName() + \" Trying to dupe on trade slot.\");\n                     c.announce(MaplePacketCreator.enableActions());\n                     return;\n                 }"}, {"sha": "0523d9c586c222108c9b8b428e0fef577bf81463", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -59,7 +59,6 @@\n import client.inventory.MaplePet;\n import constants.GameConstants;\n import constants.ServerConstants;\n-import java.net.InetSocketAddress;\n import java.util.Collections;\n import java.util.Comparator;\n import java.util.HashSet;\n@@ -128,7 +127,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 IoSession session = c.getSession();\n                 String remoteHwid;\n                 if (player == null) {\n-                    if (!server.validateCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), cid)) {\n+                    if (!server.validateCharacteridInTransition(session, cid)) {\n                         c.disconnect(true, false);\n                         return;\n                     }"}, {"sha": "36e632c1cb27099959e1af392d42a0c04a23d98c", "filename": "src/net/server/channel/handlers/RingActionHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/RingActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/RingActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RingActionHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -412,10 +412,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \n                                 MapleCharacter guestChr = c.getWorldServer().getPlayerStorage().getCharacterById(guest);\n                                 if(guestChr != null && MapleInventoryManipulator.checkSpace(guestChr.getClient(), newItemId, 1, \"\") && MapleInventoryManipulator.addById(guestChr.getClient(), newItemId, (short) 1, expiration)) {\n-                                    guestChr.dropMessage(6, \"[WEDDING] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding!\");\n+                                    guestChr.dropMessage(6, \"[Wedding] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding!\");\n                                 } else {\n                                     if(guestChr != null && guestChr.isLoggedinWorld()) {\n-                                        guestChr.dropMessage(6, \"[WEDDING] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\");\n+                                        guestChr.dropMessage(6, \"[Wedding] You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\");\n                                     } else {\n                                         c.getPlayer().sendNote(name, \"You've been invited to \" + groom + \" and \" + bride + \"'s Wedding! Receive your invitation from Duey!\", (byte) 0);\n                                     }"}, {"sha": "1dae1aa6e675b33c42646f976607af568f71737d", "filename": "src/net/server/channel/handlers/WeddingHandler.java", "status": "modified", "additions": 96, "deletions": 95, "changes": 191, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/WeddingHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/channel/handlers/WeddingHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/WeddingHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -33,122 +33,123 @@\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         \n-        c.tryacquireClient();\n-        try {\n-            MapleCharacter chr = c.getPlayer();\n-            final byte mode = slea.readByte();\n-            \n-            if (mode == 6) { //additem\n-                short slot = slea.readShort();\n-                int itemid = slea.readInt();\n-                short quantity = slea.readShort();\n-\n-                MapleMarriage marriage = c.getPlayer().getMarriageInstance();\n-                if (marriage != null) {\n-                    try {\n-                        boolean groomWishlist = marriage.giftItemToSpouse(chr.getId());\n-                        String groomWishlistProp = \"giftedItem\" + (groomWishlist ? \"G\" : \"B\") + chr.getId();\n-                        \n-                        int giftCount = marriage.getIntProperty(groomWishlistProp);\n-                        if (giftCount < ServerConstants.WEDDING_GIFT_LIMIT) {\n-                            int cid = marriage.getIntProperty(groomWishlist ? \"groomId\" : \"brideId\");\n-                            if (chr.getId() != cid) {   // cannot gift yourself\n-                                MapleCharacter spouse = marriage.getPlayerById(cid);\n-                                if (spouse != null) {\n-                                    MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n-                                    MapleInventory chrInv = chr.getInventory(type);\n-\n-                                    chrInv.lockInventory();\n-                                    try {\n-                                        Item item = chrInv.getItem((byte) slot);\n-                                        if (item != null) {\n-                                            if (!item.isUntradeable()) {\n-                                                if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n-                                                    Item newItem = item.copy();\n-\n-                                                    marriage.addGiftItem(groomWishlist, newItem);\n-                                                    MapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false, false);\n-\n-                                                    if (ServerConstants.USE_ENFORCE_MERCHANT_SAVE) chr.saveCharToDB(false); \n-                                                    marriage.saveGiftItemsToDb(c, groomWishlist, cid);\n-\n-                                                    MapleKarmaManipulator.toggleKarmaFlagToUntradeable(newItem);\n-                                                    marriage.setIntProperty(groomWishlistProp, giftCount + 1);\n-\n-                                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xB, marriage.getWishlistItems(groomWishlist), Collections.singletonList(newItem)));\n+        if (c.tryacquireClient()) {\n+            try {\n+                MapleCharacter chr = c.getPlayer();\n+                final byte mode = slea.readByte();\n+\n+                if (mode == 6) { //additem\n+                    short slot = slea.readShort();\n+                    int itemid = slea.readInt();\n+                    short quantity = slea.readShort();\n+\n+                    MapleMarriage marriage = c.getPlayer().getMarriageInstance();\n+                    if (marriage != null) {\n+                        try {\n+                            boolean groomWishlist = marriage.giftItemToSpouse(chr.getId());\n+                            String groomWishlistProp = \"giftedItem\" + (groomWishlist ? \"G\" : \"B\") + chr.getId();\n+\n+                            int giftCount = marriage.getIntProperty(groomWishlistProp);\n+                            if (giftCount < ServerConstants.WEDDING_GIFT_LIMIT) {\n+                                int cid = marriage.getIntProperty(groomWishlist ? \"groomId\" : \"brideId\");\n+                                if (chr.getId() != cid) {   // cannot gift yourself\n+                                    MapleCharacter spouse = marriage.getPlayerById(cid);\n+                                    if (spouse != null) {\n+                                        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+                                        MapleInventory chrInv = chr.getInventory(type);\n+\n+                                        chrInv.lockInventory();\n+                                        try {\n+                                            Item item = chrInv.getItem((byte) slot);\n+                                            if (item != null) {\n+                                                if (!item.isUntradeable()) {\n+                                                    if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n+                                                        Item newItem = item.copy();\n+\n+                                                        marriage.addGiftItem(groomWishlist, newItem);\n+                                                        MapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false, false);\n+\n+                                                        if (ServerConstants.USE_ENFORCE_MERCHANT_SAVE) chr.saveCharToDB(false); \n+                                                        marriage.saveGiftItemsToDb(c, groomWishlist, cid);\n+\n+                                                        MapleKarmaManipulator.toggleKarmaFlagToUntradeable(newItem);\n+                                                        marriage.setIntProperty(groomWishlistProp, giftCount + 1);\n+\n+                                                        c.announce(Wedding.OnWeddingGiftResult((byte) 0xB, marriage.getWishlistItems(groomWishlist), Collections.singletonList(newItem)));\n+                                                    }\n+                                                } else {\n+                                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n                                                 }\n-                                            } else {\n-                                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n                                             }\n+                                        } finally {\n+                                            chrInv.unlockInventory();\n                                         }\n-                                    } finally {\n-                                        chrInv.unlockInventory();\n+                                    } else {\n+                                        c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n                                     }\n                                 } else {\n                                     c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n                                 }\n                             } else {\n-                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xC, marriage.getWishlistItems(groomWishlist), null));\n+                            }\n+                        } catch (NumberFormatException nfe) {}\n+                    } else {\n+                        c.announce(MaplePacketCreator.enableActions());\n+                    }\n+                } else if (mode == 7) { // take items\n+                    slea.readByte();    // invType\n+                    int itemPos = slea.readByte();\n+\n+                    MapleMarriage marriage = chr.getMarriageInstance();\n+                    if (marriage != null) {\n+                        Boolean groomWishlist = marriage.isMarriageGroom(chr);\n+                        if (groomWishlist != null) {\n+                            Item item = marriage.getGiftItem(c, groomWishlist, itemPos);\n+                            if (item != null) {\n+                                if (MapleInventory.checkSpot(chr, item)) {\n+                                    marriage.removeGiftItem(groomWishlist, item);\n+                                    marriage.saveGiftItemsToDb(c, groomWishlist, chr.getId());\n+\n+                                    MapleInventoryManipulator.addFromDrop(c, item, true);\n+\n+                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                                } else {\n+                                    c.getPlayer().dropMessage(1, \"Free a slot on your inventory before collecting this item.\");\n+                                    c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                                }\n+                            } else {\n+                                c.getPlayer().dropMessage(1, \"You have already collected this item.\");\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n                             }\n-                        } else {\n-                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xC, marriage.getWishlistItems(groomWishlist), null));\n                         }\n-                    } catch (NumberFormatException nfe) {}\n-                } else {\n-                    c.announce(MaplePacketCreator.enableActions());\n-                }\n-            } else if (mode == 7) { // take items\n-                slea.readByte();    // invType\n-                int itemPos = slea.readByte();\n-                \n-                MapleMarriage marriage = chr.getMarriageInstance();\n-                if (marriage != null) {\n-                    Boolean groomWishlist = marriage.isMarriageGroom(chr);\n-                    if (groomWishlist != null) {\n-                        Item item = marriage.getGiftItem(c, groomWishlist, itemPos);\n-                        if (item != null) {\n+                    } else {\n+                        List<Item> items = c.getAbstractPlayerInteraction().getUnclaimedMarriageGifts();\n+                        try {\n+                            Item item = items.get(itemPos);\n                             if (MapleInventory.checkSpot(chr, item)) {\n-                                marriage.removeGiftItem(groomWishlist, item);\n-                                marriage.saveGiftItemsToDb(c, groomWishlist, chr.getId());\n-                                \n-                                MapleInventoryManipulator.addFromDrop(c, item, true);\n+                                items.remove(itemPos);\n+                                MapleMarriage.saveGiftItemsToDb(c, items, chr.getId());\n \n-                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                                MapleInventoryManipulator.addFromDrop(c, item, true);\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, Collections.singletonList(\"\"), items));\n                             } else {\n                                 c.getPlayer().dropMessage(1, \"Free a slot on your inventory before collecting this item.\");\n-                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n+                                c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, Collections.singletonList(\"\"), items));\n                             }\n-                        } else {\n+                        } catch (Exception e) {\n                             c.getPlayer().dropMessage(1, \"You have already collected this item.\");\n-                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), marriage.getGiftItems(c, groomWishlist)));\n-                        }\n-                    }\n-                } else {\n-                    List<Item> items = c.getAbstractPlayerInteraction().getUnclaimedMarriageGifts();\n-                    try {\n-                        Item item = items.get(itemPos);\n-                        if (MapleInventory.checkSpot(chr, item)) {\n-                            items.remove(itemPos);\n-                            MapleMarriage.saveGiftItemsToDb(c, items, chr.getId());\n-\n-                            MapleInventoryManipulator.addFromDrop(c, item, true);\n-                            c.announce(Wedding.OnWeddingGiftResult((byte) 0xF, Collections.singletonList(\"\"), items));\n-                        } else {\n-                            c.getPlayer().dropMessage(1, \"Free a slot on your inventory before collecting this item.\");\n                             c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, Collections.singletonList(\"\"), items));\n                         }\n-                    } catch (Exception e) {\n-                        c.getPlayer().dropMessage(1, \"You have already collected this item.\");\n-                        c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, Collections.singletonList(\"\"), items));\n                     }\n+                } else if (mode == 8) { // out of Wedding Registry\n+                    c.announce(MaplePacketCreator.enableActions());\n+                } else {\n+                    System.out.println(mode);\n                 }\n-            } else if (mode == 8) { // out of Wedding Registry\n-                c.announce(MaplePacketCreator.enableActions());\n-            } else {\n-                System.out.println(mode);\n+            } finally {\n+                c.releaseClient();\n             }\n-        } finally {\n-            c.releaseClient();\n         }\n     }\n }\n\\ No newline at end of file"}, {"sha": "3172cab6edc4a52ca6425202e45c0e4bda0826bf", "filename": "src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "status": "added", "additions": 358, "deletions": 0, "changes": 358, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleMatchCheckerCoordinator.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,358 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator;\n+\n+import client.MapleCharacter;\n+import net.server.PlayerStorage;\n+import net.server.Server;\n+import net.server.coordinator.matchchecker.AbstractMatchCheckerListener;\n+import net.server.coordinator.matchchecker.MatchCheckerListenerFactory.MatchCheckerType;\n+import net.server.world.World;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import java.util.concurrent.Semaphore;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleMatchCheckerCoordinator {\n+    \n+    private final Map<Integer, MapleMatchCheckingElement> matchEntries = new HashMap<>();\n+    \n+    private final Set<Integer> pooledCids = new HashSet<>();\n+    private final Semaphore semaphorePool = new Semaphore(7);\n+    \n+    private class MapleMatchCheckingEntry {\n+        private boolean accepted;\n+        private int cid;\n+        \n+        private MapleMatchCheckingEntry(int cid) {\n+            this.cid = cid;\n+            this.accepted = false;\n+        }\n+        \n+        private boolean setAccept() {\n+            if (!this.accepted) {\n+                this.accepted = true;\n+                return true;\n+            } else {\n+                return false;\n+            }\n+        }\n+        \n+        private boolean getAccept() {\n+            return this.accepted;\n+        }\n+    }\n+    \n+    private class MapleMatchCheckingElement {\n+        private int leaderCid;\n+        private int world;\n+        \n+        private MatchCheckerType matchType;\n+        private AbstractMatchCheckerListener listener;\n+        \n+        private Map<Integer, MapleMatchCheckingEntry> confirmingMembers = new HashMap<>();\n+        private int confirmCount;\n+        \n+        private String message;\n+        \n+        private MapleMatchCheckingElement(MatchCheckerType matchType, int leaderCid, int world, AbstractMatchCheckerListener leaderListener, Set<Integer> matchPlayers, String message) {\n+            this.leaderCid = leaderCid;\n+            this.world = world;\n+            this.listener = leaderListener;\n+            this.confirmCount = 0;\n+            this.message = message;\n+            this.matchType = matchType;\n+            \n+            for (Integer cid : matchPlayers) {\n+                MapleMatchCheckingEntry mmcEntry = new MapleMatchCheckingEntry(cid);\n+                confirmingMembers.put(cid, mmcEntry);\n+            }\n+        }\n+        \n+        private boolean acceptEntry(int cid) {\n+            MapleMatchCheckingEntry mmcEntry = confirmingMembers.get(cid);\n+            if (mmcEntry != null) {\n+                if (mmcEntry.setAccept()) {\n+                    this.confirmCount++;\n+                    \n+                    if (this.confirmCount == this.confirmingMembers.size()) {\n+                        return true;\n+                    }\n+                }\n+            }\n+            \n+            return false;\n+        }\n+        \n+        private Set<Integer> getMatchPlayers() {\n+            return confirmingMembers.keySet();\n+        }\n+        \n+        private Set<MapleCharacter> getMatchCharacters() {\n+            Set<MapleCharacter> players = new HashSet<>();\n+            \n+            World wserv = Server.getInstance().getWorld(world);\n+            if (wserv != null) {\n+                PlayerStorage ps = wserv.getPlayerStorage();\n+                \n+                for (Integer cid : getMatchPlayers()) {\n+                    MapleCharacter chr = ps.getCharacterById(cid);\n+                    if (chr != null) {\n+                        players.add(chr);\n+                    }\n+                }\n+            }\n+            \n+            return players;\n+        }\n+        \n+        private void dispatchMatchCreated() {\n+            Set<MapleCharacter> nonLeaderMatchPlayers = getMatchCharacters();\n+            MapleCharacter leader = null;\n+            \n+            for (MapleCharacter chr : nonLeaderMatchPlayers) {\n+                if (chr.getId() == leaderCid) {\n+                    leader = chr;\n+                    break;\n+                }\n+            }\n+            \n+            nonLeaderMatchPlayers.remove(leader);\n+            listener.onMatchCreated(leader, nonLeaderMatchPlayers, message);\n+        }\n+        \n+        private void dispatchMatchResult(boolean accept) {\n+            if (accept) {\n+                listener.onMatchAccepted(leaderCid, getMatchCharacters(), message);\n+            } else {\n+                listener.onMatchDeclined(leaderCid, getMatchCharacters(), message);\n+            }\n+        }\n+        \n+        private void dispatchMatchDismissed() {\n+            listener.onMatchDismissed(leaderCid, getMatchCharacters(), message);\n+        }\n+    }\n+    \n+    private void unpoolMatchPlayer(Integer cid) {\n+        unpoolMatchPlayers(Collections.singleton(cid));\n+    }\n+    \n+    private void unpoolMatchPlayers(Set<Integer> matchPlayers) {\n+        for (Integer cid : matchPlayers) {\n+            pooledCids.remove(cid);\n+        }\n+    }\n+    \n+    private boolean poolMatchPlayer(Integer cid) {\n+        return poolMatchPlayers(Collections.singleton(cid));\n+    }\n+    \n+    private boolean poolMatchPlayers(Set<Integer> matchPlayers) {\n+        Set<Integer> pooledPlayers = new HashSet<>();\n+        \n+        for (Integer cid : matchPlayers) {\n+            if (!pooledCids.add(cid)) {\n+                unpoolMatchPlayers(pooledPlayers);\n+                return false;\n+            } else {\n+                pooledPlayers.add(cid);\n+            }\n+        }\n+        \n+        return true;\n+    }\n+    \n+    private boolean isMatchingAvailable(Set<Integer> matchPlayers) {\n+        for (Integer cid : matchPlayers) {\n+            if (matchEntries.containsKey(cid)) {\n+                return false;\n+            }\n+        }\n+        \n+        return true;\n+    }\n+    \n+    public int getMatchConfirmationLeaderid(int cid) {\n+        MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+        if (mmce != null) {\n+            return mmce.leaderCid;\n+        } else {\n+            return -1;\n+        }\n+    }\n+    \n+    public MatchCheckerType getMatchConfirmationType(int cid) {\n+        MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+        if (mmce != null) {\n+            return mmce.matchType;\n+        } else {\n+            return null;\n+        }\n+    }\n+    \n+    private void createMatchConfirmationInternal(MatchCheckerType matchType, int world, int leaderCid, AbstractMatchCheckerListener leaderListener, Set<Integer> players, String message) {\n+        MapleMatchCheckingElement mmce = new MapleMatchCheckingElement(matchType, leaderCid, world, leaderListener, players, message);\n+        \n+        for (Integer cid : players) {\n+            matchEntries.put(cid, mmce);\n+        }\n+        \n+        mmce.dispatchMatchCreated();\n+        \n+        if (mmce.acceptEntry(leaderCid)) {\n+            acceptMatchElement(mmce, leaderCid);\n+        }\n+    }\n+    \n+    public boolean createMatchConfirmation(MatchCheckerType matchType, int world, int leaderCid, Set<Integer> players, String message) {\n+        try {\n+            semaphorePool.acquire();\n+            try {\n+                if (poolMatchPlayers(players)) {\n+                    try {\n+                        if (isMatchingAvailable(players)) {\n+                            AbstractMatchCheckerListener leaderListener = matchType.getListener();\n+                            createMatchConfirmationInternal(matchType, world, leaderCid, leaderListener, players, message);\n+                            return true;\n+                        }\n+                    } finally {\n+                        unpoolMatchPlayers(players);\n+                    }\n+                }\n+            } finally {\n+                semaphorePool.release();\n+            }\n+        } catch (InterruptedException ie) {\n+            ie.printStackTrace();\n+        }\n+        \n+        return false;\n+    }\n+    \n+    private void disposeMatchElement(MapleMatchCheckingElement mmce) {\n+        Set<Integer> matchPlayers = mmce.getMatchPlayers();\n+        while (!poolMatchPlayers(matchPlayers)) {\n+            try {\n+                Thread.sleep(1000);\n+            } catch (InterruptedException ie) {}\n+        }\n+        \n+        try {\n+            for (Integer cid : matchPlayers) {\n+                matchEntries.remove(cid);\n+            }\n+        } finally {\n+            unpoolMatchPlayers(matchPlayers);\n+        }\n+    }\n+    \n+    private void acceptMatchElement(MapleMatchCheckingElement mmce, int cid) {\n+        if (mmce.acceptEntry(cid)) {\n+            unpoolMatchPlayer(cid);\n+            disposeMatchElement(mmce);\n+            \n+            mmce.dispatchMatchResult(true);\n+        }\n+    }\n+    \n+    private void denyMatchElement(MapleMatchCheckingElement mmce, int cid) {\n+        unpoolMatchPlayer(cid);\n+        disposeMatchElement(mmce);\n+        \n+        mmce.dispatchMatchResult(false);\n+    }\n+    \n+    private void dismissMatchElement(MapleMatchCheckingElement mmce, int cid) {\n+        unpoolMatchPlayer(cid);\n+        disposeMatchElement(mmce);\n+        \n+        mmce.dispatchMatchDismissed();\n+    }\n+    \n+    public boolean answerMatchConfirmation(int cid, boolean accept) {\n+        try {\n+            semaphorePool.acquire();\n+            try {\n+                while (matchEntries.containsKey(cid)) {\n+                    if (poolMatchPlayer(cid)) {\n+                        try {\n+                            MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+\n+                            if (mmce != null) {\n+                                if (accept) {\n+                                    acceptMatchElement(mmce, cid);\n+                                } else {\n+                                    denyMatchElement(mmce, cid);\n+                                }\n+\n+                                return true;\n+                            }\n+                        } finally {\n+                            unpoolMatchPlayer(cid);\n+                        }\n+                    }\n+                }\n+            } finally {\n+                semaphorePool.release();\n+            }\n+        } catch (InterruptedException ie) {\n+            ie.printStackTrace();\n+        }\n+        \n+        return false;\n+    }\n+    \n+    public boolean dismissMatchConfirmation(int cid) {\n+        try {\n+            semaphorePool.acquire();\n+            try {\n+                while (matchEntries.containsKey(cid)) {\n+                    if (poolMatchPlayer(cid)) {\n+                        try {\n+                            MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+\n+                            if (mmce != null) {\n+                                dismissMatchElement(mmce, cid);\n+                                return true;\n+                            }\n+                        } finally {\n+                            unpoolMatchPlayer(cid);\n+                        }\n+                    }\n+                }\n+            } finally {\n+                semaphorePool.release();\n+            }\n+        } catch (InterruptedException ie) {\n+            ie.printStackTrace();\n+        }\n+        \n+        return false;\n+    }\n+        \n+}"}, {"sha": "048a3f77fddd3dfc6c3a70c15d2bc74487b9f817", "filename": "src/net/server/coordinator/MapleSessionCoordinator.java", "status": "modified", "additions": 44, "deletions": 9, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleSessionCoordinator.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -19,6 +19,7 @@\n */\n package net.server.coordinator;\n \n+import client.MapleCharacter;\n import client.MapleClient;\n import constants.ServerConstants;\n \n@@ -28,7 +29,6 @@\n import org.apache.mina.core.session.IoSession;\n import tools.DatabaseConnection;\n \n-import java.net.InetSocketAddress;\n import java.sql.Connection;\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n@@ -220,8 +220,8 @@ private Lock getCoodinatorLock(String remoteHost) {\n         return poolLock.get(Math.abs(remoteHost.hashCode()) % 100);\n     }\n     \n-    private static String getRemoteIp(IoSession session) {\n-        return ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress();\n+    public static String getSessionRemoteAddress(IoSession session) {\n+        return (String) session.getAttribute(MapleClient.CLIENT_REMOTE_ADDRESS);\n     }\n     \n     private static MapleClient getSessionClient(IoSession session) {\n@@ -245,7 +245,7 @@ public void updateOnlineSession(IoSession session) {\n     public boolean canStartLoginSession(IoSession session) {\n         if (!ServerConstants.DETERRED_MULTICLIENT) return true;\n         \n-        String remoteHost = getRemoteIp(session);\n+        String remoteHost = getSessionRemoteAddress(session);\n         Lock lock = getCoodinatorLock(remoteHost);\n         \n         try {\n@@ -305,7 +305,7 @@ public boolean canStartLoginSession(IoSession session) {\n     }\n     \n     public void closeLoginSession(IoSession session) {\n-        String remoteIp = getRemoteIp(session);\n+        String remoteIp = getSessionRemoteAddress(session);\n         Set<IoSession> lrh = loginRemoteHosts.get(remoteIp);\n         if (lrh != null) {\n             lrh.remove(session);\n@@ -336,7 +336,7 @@ public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbl\n             return AntiMulticlientResult.SUCCESS;\n         }\n         \n-        String remoteHost = getRemoteIp(session);\n+        String remoteHost = getSessionRemoteAddress(session);\n         Lock lock = getCoodinatorLock(remoteHost);\n         \n         try {\n@@ -402,7 +402,7 @@ public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbl\n     }\n     \n     public AntiMulticlientResult attemptGameSession(IoSession session, int accountId, String remoteHwid) {\n-        String remoteHost = getRemoteIp(session);\n+        String remoteHost = getSessionRemoteAddress(session);\n         if (!ServerConstants.DETERRED_MULTICLIENT) {\n             associateRemoteHostHwid(remoteHost, remoteHwid);\n             return AntiMulticlientResult.SUCCESS;\n@@ -472,14 +472,47 @@ public AntiMulticlientResult attemptGameSession(IoSession session, int accountId\n         }\n     }\n     \n+    private static MapleClient fetchInTransitionSessionClient(IoSession session) {\n+        String remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n+        \n+        if (remoteHwid != null) {   // maybe this session was currently in-transition?\n+            int hwidLen = remoteHwid.length();\n+            if (hwidLen <= 8) {\n+                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid);\n+            } else {\n+                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n+            }\n+            \n+            MapleClient client = new MapleClient(null, null, session);\n+            Integer cid = Server.getInstance().freeCharacteridInTransition(session);\n+            if (cid != null) {\n+                try {\n+                    client.setAccID(MapleCharacter.loadCharFromDB(cid, client, false).getAccountID());\n+                } catch (SQLException sqle) {\n+                    sqle.printStackTrace();\n+                }\n+            }\n+            \n+            session.setAttribute(MapleClient.CLIENT_KEY, client);\n+            return client;\n+        }\n+        \n+        return null;\n+    }\n+    \n     public void closeSession(IoSession session, Boolean immediately) {\n+        MapleClient client = getSessionClient(session);\n+        if (client == null) {\n+            client = fetchInTransitionSessionClient(session);\n+        }\n+        \n         String hwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID); // making sure to clean up calls to this function on login phase\n         onlineRemoteHwids.remove(hwid);\n         \n         hwid = (String) session.removeAttribute(MapleClient.CLIENT_HWID);\n         onlineRemoteHwids.remove(hwid);\n         \n-        MapleClient client = getSessionClient(session);\n         if (client != null) {\n             if (hwid != null) { // is a game session\n                 onlineClients.remove(client.getAccID());\n@@ -496,10 +529,12 @@ public void closeSession(IoSession session, Boolean immediately) {\n         if (immediately != null) {\n             session.close(immediately);\n         }\n+        \n+        // session.removeAttribute(MapleClient.CLIENT_REMOTE_ADDRESS); No real need for removing String property on closed sessions\n     }\n     \n     public String getGameSessionHwid(IoSession session) {\n-        String remoteHost = getRemoteIp(session);\n+        String remoteHost = getSessionRemoteAddress(session);\n         return cachedHostHwids.get(remoteHost);\n     }\n     "}, {"sha": "f8fde0d921a0d33fa06e5f68c3cf561fe7624363", "filename": "src/net/server/coordinator/matchchecker/AbstractMatchCheckerListener.java", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/AbstractMatchCheckerListener.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/AbstractMatchCheckerListener.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/AbstractMatchCheckerListener.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,34 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator.matchchecker;\n+\n+import client.MapleCharacter;\n+import java.util.Set;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public interface AbstractMatchCheckerListener {\n+    public void onMatchCreated(MapleCharacter leader, Set<MapleCharacter> nonLeaderMatchPlayers, String message);\n+    public void onMatchAccepted(int leaderid, Set<MapleCharacter> matchPlayers, String message);\n+    public void onMatchDeclined(int leaderid, Set<MapleCharacter> matchPlayers, String message);\n+    public void onMatchDismissed(int leaderid, Set<MapleCharacter> matchPlayers, String message);\n+}"}, {"sha": "648ab081b70b958b7dafe6f5ad1729b7f7f1842e", "filename": "src/net/server/coordinator/matchchecker/MatchCheckerListenerFactory.java", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/MatchCheckerListenerFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/MatchCheckerListenerFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/MatchCheckerListenerFactory.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,45 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator.matchchecker;\n+\n+import net.server.coordinator.matchchecker.listener.MatchCheckerGuildCreation;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MatchCheckerListenerFactory {\n+    \n+    public enum MatchCheckerType {\n+        \n+        GUILD_CREATION(MatchCheckerGuildCreation.loadListener());\n+        \n+        private final AbstractMatchCheckerListener listener;\n+        \n+        private MatchCheckerType(AbstractMatchCheckerListener listener) {\n+            this.listener = listener;\n+        }\n+        \n+        public AbstractMatchCheckerListener getListener() {\n+            return this.listener;\n+        }\n+    }\n+    \n+}"}, {"sha": "18ee1d27aec93fd960497140767605f67cebffd1", "filename": "src/net/server/coordinator/matchchecker/MatchCheckerListenerRecipe.java", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/MatchCheckerListenerRecipe.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/MatchCheckerListenerRecipe.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/MatchCheckerListenerRecipe.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,28 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator.matchchecker;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public interface MatchCheckerListenerRecipe {\n+    public AbstractMatchCheckerListener getListener();\n+}"}, {"sha": "49f52a4b3b3591daffb27fe18e80245ac0b9794c", "filename": "src/net/server/coordinator/matchchecker/listener/MatchCheckerGuildCreation.java", "status": "added", "additions": 181, "deletions": 0, "changes": 181, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/listener/MatchCheckerGuildCreation.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/coordinator/matchchecker/listener/MatchCheckerGuildCreation.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/listener/MatchCheckerGuildCreation.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -0,0 +1,181 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator.matchchecker.listener;\n+\n+import client.MapleCharacter;\n+import constants.GameConstants;\n+import constants.ServerConstants;\n+import net.server.coordinator.matchchecker.AbstractMatchCheckerListener;\n+import net.server.coordinator.matchchecker.MatchCheckerListenerRecipe;\n+import net.server.guild.MapleGuild;\n+import net.server.guild.MapleGuildCharacter;\n+import java.util.Set;\n+import net.server.Server;\n+import net.server.world.MapleParty;\n+import tools.MaplePacketCreator;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MatchCheckerGuildCreation implements MatchCheckerListenerRecipe {\n+    \n+    private static void broadcastGuildCreationDismiss(Set<MapleCharacter> nonLeaderMatchPlayers) {\n+        for (MapleCharacter chr : nonLeaderMatchPlayers) {\n+            if (chr.isLoggedinWorld()) {\n+                chr.announce(MaplePacketCreator.genericGuildMessage((byte) 0x26));\n+            }\n+        }\n+    }\n+    \n+    public static AbstractMatchCheckerListener loadListener() {\n+        return (new MatchCheckerGuildCreation()).getListener();\n+    }\n+    \n+    @Override\n+    public AbstractMatchCheckerListener getListener() {\n+        return new AbstractMatchCheckerListener() {\n+            \n+            @Override\n+            public void onMatchCreated(MapleCharacter leader, Set<MapleCharacter> nonLeaderMatchPlayers, String message) {\n+                byte[] createGuildPacket = MaplePacketCreator.createGuildMessage(leader.getName(), message);\n+                \n+                for (MapleCharacter chr : nonLeaderMatchPlayers) {\n+                    if (chr.isLoggedinWorld()) {\n+                        chr.announce(createGuildPacket);\n+                    }\n+                }\n+            }\n+            \n+            @Override\n+            public void onMatchAccepted(int leaderid, Set<MapleCharacter> matchPlayers, String message) {\n+                MapleCharacter leader = null;\n+                for (MapleCharacter chr : matchPlayers) {\n+                    if (chr.getId() == leaderid) {\n+                        leader = chr;\n+                        break;\n+                    }\n+                }\n+                \n+                if (leader == null || !leader.isLoggedinWorld()) {\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                matchPlayers.remove(leader);\n+                \n+                if (leader.getGuildId() > 0) {\n+                    leader.dropMessage(1, \"You cannot create a new Guild while in one.\");\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                int partyid = leader.getPartyId();\n+                if (partyid == -1 || !leader.isPartyLeader()) {\n+                    leader.dropMessage(1, \"You cannot establish the creation of a new Guild without leading a party.\");\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                if (leader.getMapId() != 200000301) {\n+                    leader.dropMessage(1, \"You cannot establish the creation of a new Guild outside of the Guild Headquarters.\");\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                for (MapleCharacter chr : matchPlayers) {\n+                    if (leader.getMap().getCharacterById(chr.getId()) == null) {\n+                        leader.dropMessage(1, \"You cannot establish the creation of a new Guild if one of the members is not present here.\");\n+                        broadcastGuildCreationDismiss(matchPlayers);\n+                        return;\n+                    }\n+                }\n+                if (leader.getMeso() < ServerConstants.CREATE_GUILD_COST) {\n+                    leader.dropMessage(1, \"You do not have \" + GameConstants.numberWithCommas(ServerConstants.CREATE_GUILD_COST) + \" mesos to create a Guild.\");\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                \n+                int gid = Server.getInstance().createGuild(leader.getId(), message);\n+                if (gid == 0) {\n+                    leader.announce(MaplePacketCreator.genericGuildMessage((byte) 0x23));\n+                    broadcastGuildCreationDismiss(matchPlayers);\n+                    return;\n+                }\n+                leader.gainMeso(-ServerConstants.CREATE_GUILD_COST, true, false, true);\n+                \n+                leader.getMGC().setGuildId(gid);\n+                MapleGuild guild = Server.getInstance().getGuild(leader.getGuildId(), leader.getWorld(), leader);  // initialize guild structure\n+                Server.getInstance().changeRank(gid, leader.getId(), 1);\n+                \n+                leader.announce(MaplePacketCreator.showGuildInfo(leader));\n+                leader.dropMessage(1, \"You have successfully created a Guild.\");\n+                \n+                for (MapleCharacter chr : matchPlayers) {\n+                    boolean cofounder = chr.getPartyId() == partyid;\n+                    \n+                    MapleGuildCharacter mgc = chr.getMGC();\n+                    mgc.setGuildId(gid);\n+                    mgc.setGuildRank(cofounder ? 2 : 5);\n+                    mgc.setAllianceRank(5);\n+\n+                    Server.getInstance().addGuildMember(mgc, chr);\n+                    \n+                    if (chr.isLoggedinWorld()) {\n+                        chr.announce(MaplePacketCreator.showGuildInfo(chr));\n+                        \n+                        if (cofounder) {\n+                            chr.dropMessage(1, \"You have successfully cofounded a Guild.\");\n+                        } else {\n+                            chr.dropMessage(1, \"You have successfully joined the new Guild.\");\n+                        }\n+                    }\n+                    \n+                    chr.saveGuildStatus(); // update database\n+                }\n+                \n+                guild.broadcastNameChanged();\n+                guild.broadcastEmblemChanged();\n+            }\n+            \n+            @Override\n+            public void onMatchDeclined(int leaderid, Set<MapleCharacter> matchPlayers, String message) {\n+                for (MapleCharacter chr : matchPlayers) {\n+                    if (chr.getId() == leaderid && chr.getClient() != null) {\n+                        MapleParty.leaveParty(chr.getParty(), chr.getClient());\n+                    }\n+                    \n+                    if (chr.isLoggedinWorld()) {\n+                        chr.announce(MaplePacketCreator.genericGuildMessage((byte)0x24));\n+                    }\n+                }\n+            }\n+            \n+            @Override\n+            public void onMatchDismissed(int leaderid, Set<MapleCharacter> matchPlayers, String message) {\n+                for (MapleCharacter chr : matchPlayers) {\n+                    if (chr.getId() == leaderid && chr.getClient() != null) {\n+                        MapleParty.leaveParty(chr.getParty(), chr.getClient());\n+                    }\n+                    \n+                    if (chr.isLoggedinWorld()) {\n+                        chr.message(\"All cofounders must not be in a party when performing the Guild creation.\");\n+                    }\n+                }\n+            }\n+        };\n+    }\n+}"}, {"sha": "947b6c62e091ef3d9822929ccc97a947ef036110", "filename": "src/net/server/guild/MapleAlliance.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/guild/MapleAlliance.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/guild/MapleAlliance.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleAlliance.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -57,7 +57,7 @@\n     public MapleAlliance(String name, int id) {\n         this.name = name;\n         allianceId = id;\n-        String[] ranks = {\"Master\", \"Jr.Master\", \"Member\", \"Member\", \"Member\"};\n+        String[] ranks = {\"Master\", \"Jr. Master\", \"Member\", \"Member\", \"Member\"};\n         for (int i = 0; i < 5; i++) {\n             rankTitles[i] = ranks[i];\n         }"}, {"sha": "3c614d74bd55d9ef8f97f88e18af68dade75a176", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -34,6 +34,7 @@\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n+import java.util.HashSet;\n import java.util.Set;\n \n import java.util.concurrent.locks.Lock;\n@@ -746,7 +747,20 @@ public static boolean answerInvitation(int targetId, String targetName, int guil\n         }\n         return false;\n     }\n-\n+    \n+    public static Set<MapleCharacter> getEligiblePlayersForGuild(MapleCharacter guildLeader) {\n+        Set<MapleCharacter> guildMembers = new HashSet<>();\n+        guildMembers.add(guildLeader);\n+        \n+        for (MapleCharacter chr : guildLeader.getMap().getAllPlayers()) {\n+            if (chr.getParty() == null && chr.getGuild() == null) {\n+                guildMembers.add(chr);\n+            }\n+        }\n+        \n+        return guildMembers;\n+    }\n+    \n     public static void displayGuildRanks(MapleClient c, int npcid) {\n         try {\n             ResultSet rs;"}, {"sha": "b5e7ba5d48ad42b428ae81e55d629f6f8c3186c1", "filename": "src/net/server/handlers/login/CharSelectedHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/CharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/CharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -23,7 +23,6 @@\n \n import client.MapleClient;\n import java.net.InetAddress;\n-import java.net.InetSocketAddress;\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n@@ -103,7 +102,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), charId);\n+        server.setCharacteridInTransition(session, charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "0a505747ffad92ada579565e0459075b334ce1b8", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1,7 +1,6 @@\n package net.server.handlers.login;\n \n import java.net.InetAddress;\n-import java.net.InetSocketAddress;\n import java.net.UnknownHostException;\n \n import net.AbstractMaplePacketHandler;\n@@ -85,7 +84,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+            server.setCharacteridInTransition(session, charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "8692faaf1ef54f634c0914331fd0cc698c81f3c0", "filename": "src/net/server/handlers/login/LoginPasswordHandler.java", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/LoginPasswordHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/LoginPasswordHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/LoginPasswordHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -38,9 +38,9 @@\n import java.sql.ResultSet;\n import java.sql.Statement;\n import java.io.UnsupportedEncodingException;\n-import java.net.InetSocketAddress;\n import java.security.MessageDigest;\n import java.security.NoSuchAlgorithmException;\n+import net.server.coordinator.MapleSessionCoordinator;\n import org.apache.mina.core.session.IoSession;\n \n public final class LoginPasswordHandler implements MaplePacketHandler {\n@@ -57,15 +57,22 @@ private static String hashpwSHA512(String pwd) throws NoSuchAlgorithmException,\n     }\n \n     private static String getRemoteIp(IoSession session) {\n-        return ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress();\n+        return MapleSessionCoordinator.getSessionRemoteAddress(session);\n     }\n     \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         String remoteHost = getRemoteIp(c.getSession());\n-        if (remoteHost.startsWith(\"127.\") && !ServerConstants.HOST.startsWith(\"127.\")) {\n-            c.announce(MaplePacketCreator.getLoginFailed(13));   // cannot login as localhost if it's not a test server\n-            return;\n+        if (remoteHost.startsWith(\"127.\")) {\n+            if (!ServerConstants.LOCALSERVER) {  // thanks Mills for noting HOST can also have a field named \"localhost\"\n+                c.announce(MaplePacketCreator.getLoginFailed(13));   // cannot login as localhost if it's not a local server\n+                return;\n+            }\n+        } else {\n+            if (ServerConstants.LOCALSERVER) {\n+                c.announce(MaplePacketCreator.getLoginFailed(13));   // cannot login as non-localhost if it's a local server\n+                return;\n+            }\n         }\n         \n         String login = slea.readMapleAsciiString();"}, {"sha": "ed76cee00d166a445f3085318019a28e518e384f", "filename": "src/net/server/handlers/login/RegisterPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/RegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/RegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/RegisterPicHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -9,7 +9,6 @@\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n-import java.net.InetSocketAddress;\n import net.server.coordinator.MapleSessionCoordinator;\n import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import org.apache.mina.core.session.IoSession;\n@@ -88,7 +87,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+            server.setCharacteridInTransition(session, charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "b308b8ad3c4b5c69549c66623350246e9438e0f1", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -2,11 +2,11 @@\n \n import client.MapleClient;\n import java.net.InetAddress;\n-import java.net.InetSocketAddress;\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import net.server.world.World;\n import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n@@ -15,7 +15,7 @@\n \n public final class ViewAllCharRegisterPicHandler extends AbstractMaplePacketHandler {\n \n-    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n         switch (res) {\n             case REMOTE_PROCESSING:\n                 return 10;\n@@ -57,8 +57,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         IoSession session = c.getSession();\n-        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n-        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n             c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n             return;\n         }\n@@ -90,7 +90,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+        server.setCharacteridInTransition(session, charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "66dae5c4ad40431a8f5acf23611ddd3e28b5f04f", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -23,11 +23,11 @@\n \n import client.MapleClient;\n import java.net.InetAddress;\n-import java.net.InetSocketAddress;\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import net.server.world.World;\n import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n@@ -36,7 +36,7 @@\n \n public final class ViewAllCharSelectedHandler extends AbstractMaplePacketHandler {\n \n-    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n         switch (res) {\n             case REMOTE_PROCESSING:\n                 return 10;\n@@ -77,8 +77,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         IoSession session = c.getSession();\n-        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n-        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n             c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n             return;\n         }\n@@ -113,7 +113,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+        server.setCharacteridInTransition(session, charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "ace134cb3b36af93a7196c793e457d8f36ae0c82", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -10,13 +10,13 @@\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n-import java.net.InetSocketAddress;\n import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import org.apache.mina.core.session.IoSession;\n \n public class ViewAllCharSelectedWithPicHandler extends AbstractMaplePacketHandler {\n \n-    private static int parseAntiMulticlientError(MapleSessionCoordinator.AntiMulticlientResult res) {\n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n         switch (res) {\n             case REMOTE_PROCESSING:\n                 return 10;\n@@ -59,8 +59,8 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         IoSession session = c.getSession();\n-        MapleSessionCoordinator.AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n-        if (res != MapleSessionCoordinator.AntiMulticlientResult.SUCCESS) {\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n             c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n             return;\n         }\n@@ -90,7 +90,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             \n             server.unregisterLoginState(c);\n             c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+            server.setCharacteridInTransition(session, charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "fa9724a979efabc4a469f072f61aad6e82ea694f", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 156, "deletions": 0, "changes": 156, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -21,7 +21,9 @@\n  */\n package net.server.world;\n \n+import client.MapleCharacter;\n import client.MapleClient;\n+import constants.ServerConstants;\n import java.util.Collection;\n import java.util.Collections;\n import java.util.LinkedList;\n@@ -34,7 +36,13 @@\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import net.server.coordinator.MapleMatchCheckerCoordinator;\n+import net.server.coordinator.matchchecker.MatchCheckerListenerFactory.MatchCheckerType;\n+import scripting.event.EventInstanceManager;\n import server.maps.MapleDoor;\n+import server.maps.MapleMap;\n+import server.partyquest.MonsterCarnival;\n+import tools.MaplePacketCreator;\n \n public class MapleParty {\n \n@@ -315,4 +323,152 @@ public boolean equals(Object obj) {\n         }\n         return true;\n     }\n+    \n+    public static boolean createParty(MapleCharacter player, boolean silentCheck) {\n+        MapleParty party = player.getParty();\n+        if (party == null) {\n+            if(player.getLevel() < 10 && !ServerConstants.USE_PARTY_FOR_STARTERS) {\n+                player.announce(MaplePacketCreator.partyStatusMessage(10));\n+                return false;\n+            }\n+\n+            MaplePartyCharacter partyplayer = new MaplePartyCharacter(player);\n+            party = player.getWorldServer().createParty(partyplayer);\n+            player.setParty(party);\n+            player.setMPC(partyplayer);\n+            player.getMap().addPartyMember(player);\n+            player.silentPartyUpdate();\n+\n+            player.partyOperationUpdate(party, null);\n+            player.announce(MaplePacketCreator.partyCreated(party, partyplayer.getId()));\n+            \n+            return true;\n+        } else {\n+            if (!silentCheck) {\n+                player.announce(MaplePacketCreator.partyStatusMessage(16));\n+            }\n+            \n+            return false;\n+        }\n+    }\n+    \n+    public static boolean joinParty(MapleCharacter player, int partyid, boolean silentCheck) {\n+        MapleParty party = player.getParty();\n+        World world = player.getWorldServer();\n+        \n+        if (party == null) {\n+            party = world.getParty(partyid);\n+            if (party != null) {\n+                if (party.getMembers().size() < 6) {\n+                    MaplePartyCharacter partyplayer = new MaplePartyCharacter(player);\n+                    player.getMap().addPartyMember(player);\n+\n+                    world.updateParty(party.getId(), PartyOperation.JOIN, partyplayer);\n+                    player.receivePartyMemberHP();\n+                    player.updatePartyMemberHP();\n+\n+                    player.partyOperationUpdate(party, null);\n+                    return true;\n+                } else {\n+                    if (!silentCheck) {\n+                        player.announce(MaplePacketCreator.partyStatusMessage(17));\n+                    }\n+                }\n+            } else {\n+                player.announce(MaplePacketCreator.serverNotice(5, \"You couldn't join the party since it had already been disbanded.\"));\n+            }\n+        } else {\n+            if (!silentCheck) {\n+                player.announce(MaplePacketCreator.serverNotice(5, \"You can't join the party as you are already in one.\"));\n+            }\n+        }\n+        \n+        return false;\n+    }\n+    \n+    public static void leaveParty(MapleParty party, MapleClient c) {\n+        World world = c.getWorldServer();\n+        MapleCharacter player = c.getPlayer();\n+        MaplePartyCharacter partyplayer = player.getMPC();\n+        \n+        if (party != null && partyplayer != null) {\n+            if (partyplayer.getId() == party.getLeaderId()) {\n+                c.getWorldServer().removeMapPartyMembers(party.getId());\n+                \n+                MonsterCarnival mcpq = player.getMonsterCarnival();\n+                if (mcpq != null) {\n+                    mcpq.leftParty(player.getId());\n+                }\n+                \n+                world.updateParty(party.getId(), PartyOperation.DISBAND, partyplayer);\n+                \n+                EventInstanceManager eim = player.getEventInstance();\n+                if(eim != null) {\n+                    eim.disbandParty();\n+                }\n+            } else {\n+                MapleMap map = player.getMap();\n+                if (map != null) {\n+                    map.removePartyMember(player);\n+                }\n+                \n+                MonsterCarnival mcpq = player.getMonsterCarnival();\n+                if (mcpq != null) {\n+                    mcpq.leftParty(player.getId());\n+                }\n+\n+                world.updateParty(party.getId(), PartyOperation.LEAVE, partyplayer);\n+                \n+                EventInstanceManager eim = player.getEventInstance();\n+                if(eim != null) {\n+                    eim.leftParty(player);\n+                }\n+            }\n+            \n+            player.setParty(null);\n+            \n+            MapleMatchCheckerCoordinator mmce = c.getWorldServer().getMatchCheckerCoordinator();\n+            if (mmce.getMatchConfirmationLeaderid(player.getId()) == player.getId() && mmce.getMatchConfirmationType(player.getId()) == MatchCheckerType.GUILD_CREATION) {\n+                mmce.dismissMatchConfirmation(player.getId());\n+            }\n+        }\n+    }\n+    \n+    public static void expelFromParty(MapleParty party, MapleClient c, int expelCid) {\n+        World world = c.getWorldServer();\n+        MapleCharacter player = c.getPlayer();\n+        MaplePartyCharacter partyplayer = player.getMPC();\n+        \n+        if (party != null && partyplayer != null) {\n+            if (partyplayer.equals(party.getLeader())) {\n+                MaplePartyCharacter expelled = party.getMemberById(expelCid);\n+                if (expelled != null) {\n+                    MapleCharacter emc = expelled.getPlayer();\n+                    if(emc != null) {\n+                        List<MapleCharacter> partyMembers = emc.getPartyMembers();\n+\n+                        MapleMap map = emc.getMap();\n+                        if(map != null) map.removePartyMember(emc);\n+                        \n+                        MonsterCarnival mcpq = player.getMonsterCarnival();\n+                        if (mcpq != null) {\n+                            mcpq.leftParty(emc.getId());\n+                        }\n+                        \n+                        EventInstanceManager eim = emc.getEventInstance();\n+                        if(eim != null) {\n+                            eim.leftParty(emc);\n+                        }\n+\n+                        emc.setParty(null);\n+                        world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n+\n+                        emc.partyOperationUpdate(party, partyMembers);\n+                    } else {\n+                        world.updateParty(party.getId(), PartyOperation.EXPEL, expelled);\n+                    }\n+                }\n+            }\n+        }\n+    }\n }"}, {"sha": "2d0f6779250c858afbd4be414beebff9a8de018e", "filename": "src/net/server/world/MaplePartyCharacter.java", "status": "modified", "additions": 0, "deletions": 95, "changes": 95, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/MaplePartyCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/MaplePartyCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MaplePartyCharacter.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -142,99 +142,4 @@ public int getWorld() {\n         return world;\n     }\n     \n-    public String getJobNameById(int job) {\n-        switch (job) {\n-            case 0:\n-                return \"Aprendiz\";\n-            case 100:\n-                return \"Guerreiro\";// Warrior\n-            case 110:\n-                return \"Soldado\";\n-            case 111:\n-                return \"Templario\";\n-            case 112:\n-                return \"Heroi\";\n-            case 120:\n-                return \"Escudeiro\";\n-            case 121:\n-                return \"Cavaleiro Branco\";\n-            case 122:\n-                return \"Paladino\";\n-            case 130:\n-                return \"Lanceiro\";\n-            case 131:\n-                return \"Cavaleiro Draconiano\";\n-            case 132:\n-                return \"Cavaleiro Negro\";\n-\n-            case 200:\n-                return \"Bruxo\";\n-            case 210:\n-                return \"Feiticeiro (Fogo, Veneno)\";\n-            case 211:\n-                return \"Mago (Fogo, Veneno)\";\n-            case 212:\n-                return \"Arquimago (Fogo, Veneno)\";\n-            case 220:\n-                return \"Feiticeiro (Gelo, Raio)\";\n-            case 221:\n-                return \"Mago (Gelo, Raio)\";\n-            case 222:\n-                return \"Arquimago (Gelo, Raio)\";\n-            case 230:\n-                return \"Clerigo\";\n-            case 231:\n-                return \"Sacerdote\";\n-            case 232:\n-                return \"Sumo Sacerdote\";\n-\n-            case 300:\n-                return \"Arqueiro\";\n-            case 310:\n-                return \"Cacador\";\n-            case 311:\n-                return \"Rastreador\";\n-            case 312:\n-                return \"Mestre Arqueiro\";\n-            case 320:\n-                return \"Balestreiro\";\n-            case 321:\n-                return \"Atirador\";\n-            case 322:\n-                return \"Atirador De Elite\";\n-\n-            case 400:\n-                return \"Gatuno\";\n-            case 410:\n-                return \"Mercenario\";\n-            case 411:\n-                return \"Andarilho\";\n-            case 412:\n-                return \"Lorde Negro\";\n-            case 420:\n-                return \"Arruaceiro\";\n-            case 421:\n-                return \"Mestre Arruaceiro\";\n-            case 422:\n-                return \"Mestre Das Sombras\";\n-\n-            case 500:\n-                return \"Pirata\";\n-            case 510:\n-                return \"Lutador\";\n-            case 511:\n-                return \"Saqueador\";\n-            case 512:\n-                return \"Foragido\";\n-            case 520:\n-                return \"Pistoleiro\";\n-            case 521:\n-                return \"Bucaneiro\";\n-            case 522:\n-                return \"Capitao\";\n-\n-            default:\n-                return \"Unknown Job\";\n-        }\n-    }\n }"}, {"sha": "b4fef1e3375149b6b9b36ae34bab53ed8b1e3d3d", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -85,14 +85,15 @@\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n import tools.Pair;\n+import tools.packets.Fishing;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n import net.server.coordinator.MapleInviteCoordinator;\n import net.server.coordinator.MapleInviteCoordinator.InviteResult;\n import net.server.coordinator.MapleInviteCoordinator.InviteType;\n-import tools.packets.Fishing;\n+import net.server.coordinator.MapleMatchCheckerCoordinator;\n \n /**\n  *\n@@ -113,6 +114,7 @@\n     private Map<Integer, Pair<Integer, Integer>> relationshipCouples = new HashMap<>();\n     private Map<Integer, MapleGuildSummary> gsStore = new HashMap<>();\n     private PlayerStorage players = new PlayerStorage();\n+    private MapleMatchCheckerCoordinator matchChecker = new MapleMatchCheckerCoordinator();\n     \n     private final ReentrantReadWriteLock chnLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.WORLD_CHANNELS, true);\n     private ReadLock chnRLock = chnLock.readLock();\n@@ -488,6 +490,10 @@ public int compare(Entry<Integer, SortedMap<Integer, MapleCharacter>> o1, Entry<\n     public PlayerStorage getPlayerStorage() {\n         return players;\n     }\n+    \n+    public MapleMatchCheckerCoordinator getMatchCheckerCoordinator() {\n+        return matchChecker;\n+    }\n \n     public void addPlayer(MapleCharacter chr) {\n         players.addPlayer(chr);\n@@ -1267,7 +1273,15 @@ public void addCashItemBought(Integer snid) {\n     \n     private List<List<Pair<Integer, Integer>>> getBoughtCashItems() {\n         if (ServerConstants.USE_ENFORCE_ITEM_SUGGESTION) {\n-            return new ArrayList<>(0);\n+            List<List<Pair<Integer, Integer>>> boughtCounts = new ArrayList<>(9);\n+            \n+            // thanks GabrielSin for pointing out an issue here\n+            for (int i = 0; i < 9; i++) {\n+                List<Pair<Integer, Integer>> tabCounts = new ArrayList<>(0);\n+                boughtCounts.add(tabCounts);\n+            }\n+            \n+            return boughtCounts;\n         }\n         \n         suggestRLock.lock();"}, {"sha": "267b83352cd972ce6a411c0d83580a4dda9b96ab", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 95, "deletions": 64, "changes": 159, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -57,6 +57,7 @@\n import client.inventory.Item;\n import client.inventory.ItemFactory;\n import client.inventory.MaplePet;\n+import constants.GameConstants;\n import constants.ItemConstants;\n import constants.LanguageConstants;\n import net.server.PlayerStorage;\n@@ -400,8 +401,8 @@ public void changeJob(MapleJob job) {\n \t\tgetPlayer().changeJob(job);\n \t}\n \n-\tpublic MapleJob getJobName(int id) {\n-\t\treturn MapleJob.getById(id);\n+\tpublic String getJobName(int id) {\n+\t\treturn GameConstants.getJobName(id);\n \t}\n \n \tpublic MapleStatEffect getItemEffect(int itemId) {\n@@ -617,7 +618,7 @@ public String getSkillBookInfo(int itemid) {\n         }\n         \n         // By Drago/Dragohe4rt CPQ + WED\n-        public int calcAvgLvl(int map) {\n+        public int cpqCalcAvgLvl(int map) {\n             int num = 0;\n             int avg = 0;\n             for (MapleMapObject mmo : c.getChannelServer().getMapFactory().getMap(map).getAllPlayer()) {\n@@ -628,30 +629,38 @@ public int calcAvgLvl(int map) {\n             return avg;\n         }\n \n-        public void sendCPQMapLists() {\n-            String msg = LanguageConstants.Linguas(getPlayer()).CPQInicioEscolha;\n+        public boolean sendCPQMapLists() {\n+            String msg = LanguageConstants.Languages(getPlayer()).CPQPickRoom;\n+            int msgLen = msg.length();\n             for (int i = 0; i < 6; i++) {\n                 if (fieldTaken(i)) {\n                     if (fieldLobbied(i)) {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (n\u00edvel: \"\n-                                + calcAvgLvl(980000100 + i * 100) + \" / \"\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (Level: \"  // \"Carnival field\" GMS-like improvement thanks to Jayd\n+                                + cpqCalcAvgLvl(980000100 + i * 100) + \" / \"\n                                 + getPlayerCount(980000100 + i * 100) + \"x\"\n-                                + getPlayerCount(980000100 + i * 100) + \")  #l\\\\r\\\\n\";\n-                    } else {\n-                        continue;\n+                                + getPlayerCount(980000100 + i * 100) + \")  #l\\r\\n\";\n                     }\n                 } else {\n                     if (i >= 0 && i <= 3) {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (2x2) #l\\\\r\\\\n\";\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (2x2) #l\\r\\n\";\n                     } else {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (3x3) #l\\\\r\\\\n\";\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (3x3) #l\\r\\n\";\n                     }\n                 }\n             }\n-            sendSimple(msg);\n+            \n+            if (msg.length() > msgLen) {\n+                sendSimple(msg);\n+                return true;\n+            } else {\n+                return false;\n+            }\n         }\n \n         public boolean fieldTaken(int field) {\n+            if (!c.getChannelServer().canInitMonsterCarnival(true, field)) {\n+                return true;\n+            }\n             if (!c.getChannelServer().getMapFactory().getMap(980000100 + field * 100).getAllPlayer().isEmpty()) {\n                 return true;\n             }\n@@ -684,7 +693,7 @@ public void cpqLobby(int field) {\n                     mc = ps.getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.changeMap(map, map.getPortal(0));\n-                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Linguas(mc).CPQEntradaLobby));\n+                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Languages(mc).CPQEntryLobby));\n                         TimerManager tMan = TimerManager.getInstance();\n                         tMan.schedule(new Runnable() {\n                             @Override\n@@ -710,7 +719,7 @@ public MapleCharacter getChrById(int id) {\n             return c.getChannelServer().getPlayerStorage().getCharacterById(id);\n         }\n \n-        public void cancelarSaida() {\n+        public void cancelCPQLobby() {\n             PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n             for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n                 MapleCharacter mc = ps.getCharacterById(mpc.getId());\n@@ -719,10 +728,21 @@ public void cancelarSaida() {\n                 }\n             }\n         }\n+        \n+        private void warpoutCPQLobby() {\n+            MapleMap lobbyMap = c.getPlayer().getMap();\n+            MapleMap out = this.getWarpMap((lobbyMap.getId() > 980030000) ? 980000000 : 980030000);\n+            for (MapleCharacter mc : lobbyMap.getAllPlayers()) {\n+                mc.resetCP();\n+                mc.setTeam(-1);\n+                mc.setMonsterCarnival(null);\n+                mc.changeMap(out, out.getPortal(0));\n+            }\n+        }\n \n         public void startCPQ(final MapleCharacter challenger, final int field) {\n             try {\n-                cancelarSaida();\n+                cancelCPQLobby();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"Nao existe oponente!\");\n@@ -759,14 +779,19 @@ public void run() {\n                 tMan.schedule(new Runnable() {\n                     @Override\n                     public void run() {\n-                        PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n-                        for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n-                            mc.setMonsterCarnival(null);\n-                        }\n-                        for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n-                            mc.setMonsterCarnival(null);\n+                        try {\n+                            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                            for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n+                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                mc.setMonsterCarnival(null);\n+                            }\n+                            for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n+                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                mc.setMonsterCarnival(null);\n+                            }\n+                        } catch (NullPointerException npe) {\n+                            warpoutCPQLobby();\n+                            return;\n                         }\n                         \n                         new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, true, (field / 100) % 10);\n@@ -779,7 +804,7 @@ public void run() {\n \n         public void startCPQ2(final MapleCharacter challenger, final int field) {\n             try {\n-                cancelarSaida();\n+                cancelCPQLobby();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"N\u00e3o existe oponente!\");\n@@ -798,15 +823,19 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                 tMan.schedule(new Runnable() {\n                     @Override\n                     public void run() {\n-                        PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n-                        \n-                        for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n-                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n-                            mc.setMonsterCarnival(null);\n-                        }\n-                        for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n-                            MapleCharacter mc = ps.getCharacterById(mpc.getId());\n-                            mc.setMonsterCarnival(null);\n+                        try {\n+                            PlayerStorage ps = c.getChannelServer().getPlayerStorage();\n+                            for (MaplePartyCharacter mpc : getPlayer().getParty().getMembers()) {\n+                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                mc.setMonsterCarnival(null);\n+                            }\n+                            for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n+                                MapleCharacter mc = ps.getCharacterById(mpc.getId());\n+                                mc.setMonsterCarnival(null);\n+                            }\n+                        } catch (NullPointerException npe) {\n+                            warpoutCPQLobby();\n+                            return;\n                         }\n                         \n                         new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, false, (field / 1000) % 10);\n@@ -817,35 +846,45 @@ public void run() {\n             }\n         }\n \n-        public void sendCPQMapLists2() {\n-            String msg = LanguageConstants.Linguas(getPlayer()).CPQInicioEscolha;\n+        public boolean sendCPQMapLists2() {\n+            String msg = LanguageConstants.Languages(getPlayer()).CPQPickRoom;\n+            int msgLen = msg.length();\n             for (int i = 0; i < 3; i++) {\n                 if (fieldTaken2(i)) {\n                     if (fieldLobbied2(i)) {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (N\u00edvel: \"\n-                                + calcAvgLvl(980031000 + i * 1000) + \"#l\\\\r\\\\n\";\n-                    } else {\n-                        continue;\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (Level: \"  // \"Carnival field\" GMS-like improvement thanks to Jayd\n+                                + cpqCalcAvgLvl(980031000 + i * 1000) + \" / \"\n+                                + getPlayerCount(980031000 + i * 1000) + \"x\"\n+                                + getPlayerCount(980031000 + i * 1000) + \")  #l\\r\\n\";\n                     }\n                 } else {\n                     if (i == 0 || i == 1) {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (2x2) #l\\\\r\\\\n\";\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (2x2) #l\\r\\n\";\n                     } else {\n-                        msg += \"#b#L\" + i + \"#Map \" + (i + 1) + \" (3x3) #l\\\\r\\\\n\";\n+                        msg += \"#b#L\" + i + \"#Carnival Field \" + (i + 1) + \" (3x3) #l\\r\\n\";\n                     }\n                 }\n             }\n-            sendSimple(msg);\n+            \n+            if (msg.length() > msgLen) {\n+                sendSimple(msg);\n+                return true;\n+            } else {\n+                return false;\n+            }\n         }\n \n         public boolean fieldTaken2(int field) {\n-            if (!c.getChannelServer().getMapFactory().getMap(980031000 + field * 1000).getAllPlayer().isEmpty()) {\n+            if (!c.getChannelServer().canInitMonsterCarnival(false, field)) {\n                 return true;\n             }\n             if (!c.getChannelServer().getMapFactory().getMap(980031000 + field * 1000).getAllPlayer().isEmpty()) {\n                 return true;\n             }\n-            if (!c.getChannelServer().getMapFactory().getMap(980031000 + field * 1000).getAllPlayer().isEmpty()) {\n+            if (!c.getChannelServer().getMapFactory().getMap(980031100 + field * 1000).getAllPlayer().isEmpty()) {\n+                return true;\n+            }\n+            if (!c.getChannelServer().getMapFactory().getMap(980031200 + field * 1000).getAllPlayer().isEmpty()) {\n                 return true;\n             }\n             return false;\n@@ -868,10 +907,10 @@ public void cpqLobby2(int field) {\n                 map = cs.getMapFactory().getMap(980031000 + 1000 * field);\n                 for (MaplePartyCharacter mpc : c.getPlayer().getParty().getMembers()) {\n                     final MapleCharacter mc;\n-                    mc = ps.getCharacterByName(mpc.getName());\n+                    mc = ps.getCharacterById(mpc.getId());\n                     if (mc != null) {\n                         mc.changeMap(map, map.getPortal(0));\n-                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Linguas(mc).CPQEntradaLobby));\n+                        mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.Languages(mc).CPQEntryLobby));\n                         TimerManager tMan = TimerManager.getInstance();\n                         tMan.schedule(new Runnable() {\n                             @Override\n@@ -899,7 +938,7 @@ public void challengeParty2(int field) {\n             for (MapleMapObject mmo : map.getAllPlayer()) {\n                 MapleCharacter mc = (MapleCharacter) mmo;\n                 if (mc.getParty() == null) {\n-                    sendOk(LanguageConstants.Linguas(mc).CPQEscolha);\n+                    sendOk(LanguageConstants.Languages(mc).CPQFindError);\n                     return;\n                 }\n                 if (mc.getParty().getLeader().getId() == mc.getId()) {\n@@ -915,10 +954,10 @@ public void challengeParty2(int field) {\n                     }\n                     NPCScriptManager.getInstance().start(\"cpqchallenge2\", leader.getClient(), npc, members);\n                 } else {\n-                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n+                    sendOk(LanguageConstants.Languages(leader).CPQChallengeRoomAnswer);\n                 }\n             } else {\n-                sendOk(LanguageConstants.Linguas(leader).CPQLiderNaoEncontrado);\n+                sendOk(LanguageConstants.Languages(leader).CPQLeaderNotFound);\n             }\n         }\n \n@@ -930,13 +969,13 @@ public void challengeParty(int field) {\n             MapleCharacter leader = null;\n             MapleMap map = c.getChannelServer().getMapFactory().getMap(980000100 + 100 * field);\n             if (map.getAllPlayer().size() != getPlayer().getParty().getMembers().size()) {\n-                sendOk(\"erro\");\n+                sendOk(\"An unexpected error regarding the other party has occurred.\");\n                 return;\n             }\n             for (MapleMapObject mmo : map.getAllPlayer()) {\n                 MapleCharacter mc = (MapleCharacter) mmo;\n                 if (mc.getParty() == null) {\n-                    sendOk(LanguageConstants.Linguas(mc).CPQEscolha);\n+                    sendOk(LanguageConstants.Languages(mc).CPQFindError);\n                     return;\n                 }\n                 if (mc.getParty().getLeader().getId() == mc.getId()) {\n@@ -952,23 +991,15 @@ public void challengeParty(int field) {\n                     }\n                     \n                     NPCScriptManager.getInstance().start(\"cpqchallenge\", leader.getClient(), npc, members);\n-                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEnviada);\n+                    sendOk(LanguageConstants.Languages(leader).CPQChallengeRoomSent);\n                 } else {\n-                    sendOk(LanguageConstants.Linguas(leader).CPQInicioEscolhaEmEscolha);\n+                    sendOk(LanguageConstants.Languages(leader).CPQChallengeRoomAnswer);\n                 }\n             } else {\n-                sendOk(LanguageConstants.Linguas(leader).CPQLiderNaoEncontrado);\n+                sendOk(LanguageConstants.Languages(leader).CPQLeaderNotFound);\n             }\n         }\n-\n-        public MapleCharacter getCharByName(String namee) {\n-            try {\n-                return getClient().getChannelServer().getPlayerStorage().getCharacterByName(namee);\n-            } catch (Exception e) {\n-                return null;\n-            }\n-        }\n-\n+        \n         public void sendMarriageWishlist(boolean groom) {\n             MapleCharacter player = this.getPlayer();\n             MapleMarriage marriage = player.getMarriageInstance();"}, {"sha": "0ce3949a2891cd5c270bae8e872adeb1b99d3434", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1657,7 +1657,7 @@ public boolean canWearEquipment(MapleCharacter chr, Equip equip, int dst) {\n         if (!EquipSlot.getFromTextSlot(islot).isAllowed(dst, isCash(id))) {\n             equip.wear(false);\n             String itemName = MapleItemInformationProvider.getInstance().getName(equip.getItemId());\n-            Server.getInstance().broadcastGMMessage(chr.getWorld(), MaplePacketCreator.sendYellowTip(\"[WARNING]: \" + chr.getName() + \" tried to equip \" + itemName + \" into slot \" + dst + \".\"));\n+            Server.getInstance().broadcastGMMessage(chr.getWorld(), MaplePacketCreator.sendYellowTip(\"[Warning]: \" + chr.getName() + \" tried to equip \" + itemName + \" into slot \" + dst + \".\"));\n             AutobanFactory.PACKET_EDIT.alert(chr, chr.getName() + \" tried to forcibly equip an item.\");\n             FilePrinter.printError(FilePrinter.EXPLOITS + chr.getName() + \".txt\", chr.getName() + \" tried to equip \" + itemName + \" into \" + dst + \" slot.\");\n             return false;"}, {"sha": "5d75c620409ffc814ff176f6dc5776ab176454e1", "filename": "src/server/MapleMarriage.java", "status": "modified", "additions": 32, "deletions": 27, "changes": 59, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleMarriage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleMarriage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleMarriage.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -69,15 +69,18 @@ public void initializeGiftItems() {\n     }\n \n     public List<Item> getGiftItems(MapleClient c, boolean groom) {\n-        c.tryacquireClient();\n-        try {\n-            List<Item> gifts = getGiftItemsList(groom);\n-            synchronized (gifts) {\n-                return new LinkedList<>(gifts);\n+        if (c.tryacquireClient()) {\n+            try {\n+                List<Item> gifts = getGiftItemsList(groom);\n+                synchronized (gifts) {\n+                    return new LinkedList<>(gifts);\n+                }\n+            } finally {\n+                c.releaseClient();\n             }\n-        } finally {\n-            c.releaseClient();\n         }\n+        \n+        return new LinkedList<>();\n     }\n \n     private List<Item> getGiftItemsList(boolean groom) {\n@@ -140,21 +143,22 @@ public static boolean claimGiftItems(MapleClient c, MapleCharacter chr) {\n     }\n         \n     public static List<Item> loadGiftItemsFromDb(MapleClient c, int cid) {\n-        c.tryacquireClient();\n-        try {\n-            List<Item> items = new LinkedList<>();\n+        List<Item> items = new LinkedList<>();\n+        if (c.tryacquireClient()) {\n             try {\n-                for (Pair<Item, MapleInventoryType> it : ItemFactory.MARRIAGE_GIFTS.loadItems(cid, false)) {\n-                    items.add(it.getLeft());\n+                try {\n+                    for (Pair<Item, MapleInventoryType> it : ItemFactory.MARRIAGE_GIFTS.loadItems(cid, false)) {\n+                        items.add(it.getLeft());\n+                    }\n+                } catch (SQLException sqle) {\n+                    sqle.printStackTrace();\n                 }\n-            } catch (SQLException sqle) {\n-                sqle.printStackTrace();\n+            } finally {\n+                c.releaseClient();\n             }\n-\n-            return items;\n-        } finally {\n-            c.releaseClient();\n         }\n+        \n+        return items;\n     }\n         \n     public void saveGiftItemsToDb(MapleClient c, boolean groom, int cid) {\n@@ -167,17 +171,18 @@ public static void saveGiftItemsToDb(MapleClient c, List<Item> giftItems, int ci\n             items.add(new Pair<>(it, it.getInventoryType()));\n         }\n \n-        c.tryacquireClient();\n-        try {\n+        if (c.tryacquireClient()) {\n             try {\n-                Connection con = DatabaseConnection.getConnection();\n-                ItemFactory.MARRIAGE_GIFTS.saveItems(items, cid, con);\n-                con.close();\n-            } catch (SQLException sqle) {\n-                sqle.printStackTrace();\n+                try {\n+                    Connection con = DatabaseConnection.getConnection();\n+                    ItemFactory.MARRIAGE_GIFTS.saveItems(items, cid, con);\n+                    con.close();\n+                } catch (SQLException sqle) {\n+                    sqle.printStackTrace();\n+                }\n+            } finally {\n+                c.releaseClient();\n             }\n-        } finally {\n-            c.releaseClient();\n         }\n     }\n }"}, {"sha": "8b5591062e5aba52c291a50bfdf2c138934059f1", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -944,13 +944,26 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             if (skill != null) {\n                 final MapleDisease dis = skill.getDisease();\n                 MapleParty opposition = applyfrom.getParty().getEnemy();\n-                for (MaplePartyCharacter enemyChrs : opposition.getPartyMembers()) {\n-                    MapleCharacter chrApp = enemyChrs.getPlayer();\n+                if (skill.targetsAll) {\n+                    for (MaplePartyCharacter enemyChrs : opposition.getPartyMembers()) {\n+                        MapleCharacter chrApp = enemyChrs.getPlayer();\n+                        if (chrApp != null && chrApp.getMap().isCPQMap()) {\n+                            if (dis == null) {\n+                                chrApp.dispel();\n+                            } else {\n+                                chrApp.giveDebuff(dis, MCSkill.getMobSkill(dis.getDisease(), skill.level));\n+                            }\n+                        }\n+                    }\n+                } else {\n+                    int amount = opposition.getMembers().size() - 1;\n+                    int randd = (int) Math.floor(Math.random() * amount);\n+                    MapleCharacter chrApp = applyfrom.getMap().getCharacterById(opposition.getMemberByPos(randd).getId());\n                     if (chrApp != null && chrApp.getMap().isCPQMap()) {\n                         if (dis == null) {\n                             chrApp.dispel();\n                         } else {\n-                            chrApp.giveDebuff(dis, MCSkill.getMobSkill(dis.getDisease()));\n+                            chrApp.giveDebuff(dis, MCSkill.getMobSkill(dis.getDisease(), skill.level));\n                         }\n                     }\n                 }"}, {"sha": "bba71f378e32e59b7500f64e60033bbbf20f27b0", "filename": "src/server/MapleTrade.java", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleTrade.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/MapleTrade.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleTrade.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -83,7 +83,7 @@ public MapleTrade(byte number, MapleCharacter c) {\n         this.number = number;\n     }\n \n-    private static int getFee(long meso) {\n+    public static int getFee(long meso) {\n         long fee = 0;\n         if (meso >= 100000000) {\n             fee = (meso * 6) / 100;\n@@ -179,7 +179,7 @@ public void setMeso(int meso) {\n             throw new RuntimeException(\"Trade is locked.\");\n         }\n         if (meso < 0) {\n-            System.out.println(\"[h4x] \" + chr.getName() + \" Trying to trade < 0 mesos\");\n+            System.out.println(\"[Hack] \" + chr.getName() + \" Trying to trade < 0 mesos\");\n             return;\n         }\n         if (chr.getMeso() >= meso) {\n@@ -372,12 +372,30 @@ private static void cancelTradeInternal(MapleCharacter chr, byte selfResult, byt\n         chr.setTrade(null);\n     }\n     \n+    private static byte[] tradeResultsPair(byte result) {\n+        byte selfResult, partnerResult;\n+        \n+        if (result == TradeResult.PARTNER_CANCEL.getValue()) {\n+            partnerResult = result;\n+            selfResult = TradeResult.NO_RESPONSE.getValue();\n+        } else if (result == TradeResult.UNSUCCESSFUL_UNIQUE_ITEM_LIMIT.getValue()) {\n+            partnerResult = TradeResult.UNSUCCESSFUL.getValue();\n+            selfResult = result;\n+        } else {\n+            partnerResult = result;\n+            selfResult = result;\n+        }\n+        \n+        return new byte[]{selfResult, partnerResult};\n+    }\n+    \n     private synchronized void tradeCancelHandshake(boolean updateSelf, byte result) {\n         byte selfResult, partnerResult;\n         MapleTrade self;\n         \n-        partnerResult = result;\n-        selfResult = (result == TradeResult.PARTNER_CANCEL.getValue() ? TradeResult.NO_RESPONSE.getValue() : result);\n+        byte[] pairedResult = tradeResultsPair(result);\n+        selfResult = pairedResult[0];\n+        partnerResult = pairedResult[1];\n         \n         if (updateSelf) {\n             self = this;"}, {"sha": "7aa48eb7668f00e6567685adec815505ebb9e1fd", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -127,9 +127,9 @@ public void unlockMonster() {\n         externalLock.unlock();\n     }\n \n-    private void initWithStats(MapleMonsterStats stats) {\n+    private void initWithStats(MapleMonsterStats baseStats) {\n         setStance(5);\n-        this.stats = stats;\n+        this.stats = baseStats.copy();\n         hp.set(stats.getHp());\n         mp = stats.getMp();\n         \n@@ -223,7 +223,8 @@ public synchronized void addHp(int hp) {\n         this.hp.addAndGet(hp);\n     }\n     \n-    public void setStartingHp(int hp) {\n+    public synchronized void setStartingHp(int hp) {\n+        stats.setHp(hp);    // refactored mob stats after non-static HP pool suggestion thanks to twigs\n         this.hp.set(hp);\n     }\n "}, {"sha": "bf8073b4ab54e288937399cbb5a1ad76decb534b", "filename": "src/server/life/MapleMonsterStats.java", "status": "modified", "additions": 51, "deletions": 14, "changes": 65, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/life/MapleMonsterStats.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/life/MapleMonsterStats.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonsterStats.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -21,6 +21,7 @@\n */\n package server.life;\n \n+import java.lang.reflect.Field;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.HashMap;\n@@ -36,20 +37,20 @@\n  * @author Frz\n  */\n public class MapleMonsterStats {\n-    private boolean changeable;\n-    private int exp, hp, mp, level, PADamage, PDDamage, MADamage, MDDamage, dropPeriod, cp, buffToGive = -1, removeAfter;\n-    private boolean boss, undead, ffaLoot, isExplosiveReward, firstAttack, removeOnMiss;\n-    private String name;\n-    private Map<String, Integer> animationTimes = new HashMap<String, Integer>();\n-    private Map<Element, ElementalEffectiveness> resistance = new HashMap<Element, ElementalEffectiveness>();\n-    private List<Integer> revives = Collections.emptyList();\n-    private byte tagColor, tagBgColor;\n-    private List<Pair<Integer, Integer>> skills = new ArrayList<Pair<Integer, Integer>>();\n-    private Pair<Integer, Integer> cool = null;\n-    private BanishInfo banish = null;\n-    private List<loseItem> loseItem = null;\n-    private selfDestruction selfDestruction = null;\n-    private boolean friendly;\n+    public boolean changeable;\n+    public int exp, hp, mp, level, PADamage, PDDamage, MADamage, MDDamage, dropPeriod, cp, buffToGive = -1, removeAfter;\n+    public boolean boss, undead, ffaLoot, isExplosiveReward, firstAttack, removeOnMiss;\n+    public String name;\n+    public Map<String, Integer> animationTimes = new HashMap<String, Integer>();\n+    public Map<Element, ElementalEffectiveness> resistance = new HashMap<Element, ElementalEffectiveness>();\n+    public List<Integer> revives = Collections.emptyList();\n+    public byte tagColor, tagBgColor;\n+    public List<Pair<Integer, Integer>> skills = new ArrayList<Pair<Integer, Integer>>();\n+    public Pair<Integer, Integer> cool = null;\n+    public BanishInfo banish = null;\n+    public List<loseItem> loseItem = null;\n+    public selfDestruction selfDestruction = null;\n+    public boolean friendly;\n \n     public void setChange(boolean change) {\n         this.changeable = change;\n@@ -337,4 +338,40 @@ public void setMADamage(int MADamage) {\n     public void setMDDamage(int MDDamage) {\n         this.MDDamage = MDDamage;\n     } \n+    \n+    public MapleMonsterStats copy() {\n+        MapleMonsterStats copy = new MapleMonsterStats();\n+        try {\n+            FieldCopyUtil.setFields(this, copy);\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            try {\n+                Thread.sleep(10000);\n+            } catch (Exception ex) {\n+                \n+            }\n+            \n+        }\n+        \n+        return copy;\n+    }\n+    \n+    // FieldCopyUtil src: http://www.codesenior.com/en/tutorial/Java-Copy-Fields-From-One-Object-to-Another-Object-with-Reflection\n+    private static class FieldCopyUtil { // thanks to Codesenior dev team\n+        private static void setFields(Object from, Object to) {\n+            Field[] fields = from.getClass().getDeclaredFields();\n+            for (Field field : fields) {\n+                try {\n+                    Field fieldFrom = from.getClass().getDeclaredField(field.getName());\n+                    Object value = fieldFrom.get(from);\n+                    to.getClass().getDeclaredField(field.getName()).set(to, value);\n+\n+                } catch (IllegalAccessException e) {\n+                    e.printStackTrace();\n+                } catch (NoSuchFieldException e) {\n+                    e.printStackTrace();\n+                }\n+            }\n+        }\n+    }\n }"}, {"sha": "06853f45e8f5e48c4e7faba19cef2e24a24b638e", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -48,6 +48,7 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import net.server.audit.locks.MonitoredLockType;\n+import server.MapleTrade;\n \n /**\n  *\n@@ -274,6 +275,7 @@ public void buy(MapleClient c, int item, short quantity) {\n             if (c.getPlayer().getMeso() >= price) {\n                 if (canBuy(c, newItem)) {\n                     c.getPlayer().gainMeso(-price, false);\n+                    price -= MapleTrade.getFee(price);  // thanks BHB for pointing out trade fees not applying here\n                     \n                     synchronized (sold) {\n                         sold.add(new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), newItem.getQuantity(), price));"}, {"sha": "5bac4baeb64f5b4cf09d565ba8fa38b4e32a1c5c", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 16, "deletions": 17, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -1264,19 +1264,19 @@ public boolean damageMonster(final MapleCharacter chr, final MapleMonster monste\n     }\n     \n     public void broadcastBalrogVictory(String leaderName) {\n-        getWorldServer().dropMessage(6, \"[VICTORY] \" + leaderName + \"'s party has successfully defeated the Balrog! Praise to them, they finished with \" + countAlivePlayers() + \" players alive.\");\n+        getWorldServer().dropMessage(6, \"[Victory] \" + leaderName + \"'s party has successfully defeated the Balrog! Praise to them, they finished with \" + countAlivePlayers() + \" players alive.\");\n     }\n     \n     public void broadcastHorntailVictory() {\n-        getWorldServer().dropMessage(6, \"[VICTORY] To the crew that have finally conquered Horned Tail after numerous attempts, I salute thee! You are the true heroes of Leafre!!\");\n+        getWorldServer().dropMessage(6, \"[Victory] To the crew that have finally conquered Horned Tail after numerous attempts, I salute thee! You are the true heroes of Leafre!!\");\n     }\n     \n     public void broadcastZakumVictory() {\n-        getWorldServer().dropMessage(6, \"[VICTORY] At last, the tree of evil that for so long overwhelmed Ossyria has fallen. To the crew that managed to finally conquer Zakum, after numerous attempts, victory! You are the true heroes of Ossyria!!\");\n+        getWorldServer().dropMessage(6, \"[Victory] At last, the tree of evil that for so long overwhelmed Ossyria has fallen. To the crew that managed to finally conquer Zakum, after numerous attempts, victory! You are the true heroes of Ossyria!!\");\n     }\n     \n     public void broadcastPinkBeanVictory(int channel) {\n-        getWorldServer().dropMessage(6, \"[VICTORY] In a swift stroke of sorts, the crew that has attempted Pink Bean at channel \" + channel + \" has ultimately defeated it. The Temple of Time shines radiantly once again, the day finally coming back, as the crew that managed to finally conquer it returns victoriously from the battlefield!!\");\n+        getWorldServer().dropMessage(6, \"[Victory] In a swift stroke of sorts, the crew that has attempted Pink Bean at channel \" + channel + \" has ultimately defeated it. The Temple of Time shines radiantly once again, the day finally coming back, as the crew that managed to finally conquer it returns victoriously from the battlefield!!\");\n     }\n     \n     private boolean removeKilledMonsterObject(MapleMonster monster) {\n@@ -1893,7 +1893,7 @@ public void spawnAllMonsterIdFromMapSpawnList(int id) {\n     \n     public void spawnAllMonsterIdFromMapSpawnList(int id, int difficulty, boolean isPq) {\n         for(SpawnPoint sp: getAllMonsterSpawn()) {\n-            if(sp.getMonsterId() == id) {\n+            if(sp.getMonsterId() == id && sp.shouldForceSpawn()) {\n                 spawnMonster(sp.getMonster(), difficulty, isPq);\n             }\n         }\n@@ -2079,7 +2079,7 @@ public boolean canSpawn(MapleCharacter chr) {\n     public MaplePortal getDoorPortal(int doorid) {\n         MaplePortal doorPortal = portals.get(0x80 + doorid);\n         if(doorPortal == null) {\n-            FilePrinter.printError(FilePrinter.EXCEPTION, \"[DOOR] \" + mapName + \"(\" + mapid + \") does not contain door portalid \" + doorid);\n+            FilePrinter.printError(FilePrinter.EXCEPTION, \"[Door] \" + mapName + \"(\" + mapid + \") does not contain door portalid \" + doorid);\n             return portals.get(0x80);\n         }\n         \n@@ -4334,10 +4334,10 @@ public int spawnGuardian(int team, int num) {\n             if (team == 0 && redTeamBuffs.size() >= 4 || team == 1 && blueTeamBuffs.size() >= 4) {\n                 return 2;\n             }\n-            final MCSkill skil = MapleCarnivalFactory.getInstance().getGuardian(num);\n-            if (team == 0 && redTeamBuffs.contains(skil)) {\n+            final MCSkill skill = MapleCarnivalFactory.getInstance().getGuardian(num);\n+            if (team == 0 && redTeamBuffs.contains(skill)) {\n                 return 0;\n-            } else if (team == 1 && blueTeamBuffs.contains(skil)) {\n+            } else if (team == 1 && blueTeamBuffs.contains(skill)) {\n                 return 0;\n             }\n             GuardianSpawnPoint pt = this.getRandomGuardianSpawn(team);\n@@ -4352,29 +4352,28 @@ public int spawnGuardian(int team, int num) {\n             reactor.resetReactorActions(0);\n             this.spawnReactor(reactor);\n             reactor.setGuardian(pt);\n-            this.buffMonsters(team, skil);\n+            this.buffMonsters(team, skill);\n             getReactorByOid(reactor.getObjectId()).hitReactor(((MapleCharacter) this.getAllPlayer().get(0)).getClient());\n         } catch (Exception e) {\n             e.printStackTrace();\n         }\n         return 1;\n     }\n \n-    public void buffMonsters(int team, MCSkill skil) {\n+    public void buffMonsters(int team, MCSkill skill) {\n+        if (skill == null) return;\n+        \n         if (team == 0) {\n-            redTeamBuffs.add(skil);\n+            redTeamBuffs.add(skill);\n         } else if (team == 1) {\n-            blueTeamBuffs.add(skil);\n+            blueTeamBuffs.add(skill);\n         }\n         for (MapleMapObject mmo : this.mapobjects.values()) {\n             if (mmo.getType() == MapleMapObjectType.MONSTER) {\n                 MapleMonster mob = (MapleMonster) mmo;\n                 if (mob.getTeam() == team) {\n-                    if (skil != null) {\n-                        skil.getSkill().applyEffect(null, mob, false, null);\n-                    }\n+                    skill.getSkill().applyEffect(null, mob, false, null);\n                 }\n-\n             }\n         }\n     }"}, {"sha": "ed3ba67bc75ef479d43c85816af3562f89783ade", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -42,6 +42,7 @@\n import tools.data.output.MaplePacketLittleEndianWriter;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.MapleTrade;\n \n /**\n  *\n@@ -279,6 +280,7 @@ public boolean buy(MapleClient c, int item, short quantity) {\n                             }\n                             \n                             c.getPlayer().gainMeso(-price, false);\n+                            price -= MapleTrade.getFee(price);  // thanks BHB for pointing out trade fees not applying here\n                             owner.gainMeso(price, true);\n                             \n                             SoldItem soldItem = new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), quantity, price);"}, {"sha": "7f006f17148262cf8365eb55aa34e4f59df45e6e", "filename": "src/server/partyquest/MapleCarnivalFactory.java", "status": "modified", "additions": 31, "deletions": 8, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/partyquest/MapleCarnivalFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/partyquest/MapleCarnivalFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MapleCarnivalFactory.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -2,7 +2,9 @@\n \n import client.MapleDisease;\n import java.io.File;\n+import java.util.ArrayList;\n import java.util.HashMap;\n+import java.util.List;\n import java.util.Map;\n import server.life.MobSkillFactory;\n import provider.MapleDataProvider;\n@@ -20,6 +22,9 @@\n     private final Map<Integer, MCSkill> skills = new HashMap<Integer, MCSkill>();\n     private final Map<Integer, MCSkill> guardians = new HashMap<Integer, MCSkill>();\n     private final MapleDataProvider dataRoot = MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Skill.wz\"));\n+    \n+    private final List<Integer> singleTargetedSkills = new ArrayList<>();\n+    private final List<Integer> multiTargetedSkills = new ArrayList<>();\n \n     public MapleCarnivalFactory() {\n         //whoosh\n@@ -35,15 +40,36 @@ private void initialize() {\n             return;\n         }\n         for (MapleData z : dataRoot.getData(\"MCSkill.img\")) {\n-            skills.put(Integer.parseInt(z.getName()), new MCSkill(MapleDataTool.getInt(\"spendCP\", z, 0), MapleDataTool.getInt(\"mobSkillID\", z, 0), MapleDataTool.getInt(\"level\", z, 0), MapleDataTool.getInt(\"target\", z, 1) > 1));\n+            Integer id = Integer.parseInt(z.getName());\n+            MCSkill ms = new MCSkill(MapleDataTool.getInt(\"spendCP\", z, 0), MapleDataTool.getInt(\"mobSkillID\", z, 0), MapleDataTool.getInt(\"level\", z, 0), MapleDataTool.getInt(\"target\", z, 1) > 1);\n+            \n+            skills.put(id, ms);\n+            if (ms.targetsAll) {\n+                multiTargetedSkills.add(id);\n+            } else {\n+                singleTargetedSkills.add(id);\n+            }\n         }\n         for (MapleData z : dataRoot.getData(\"MCGuardian.img\")) {\n             guardians.put(Integer.parseInt(z.getName()), new MCSkill(MapleDataTool.getInt(\"spendCP\", z, 0), MapleDataTool.getInt(\"mobSkillID\", z, 0), MapleDataTool.getInt(\"level\", z, 0), true));\n         }\n     }\n \n+    private MCSkill randomizeSkill(boolean multi) {\n+        if (multi) {\n+            return skills.get(multiTargetedSkills.get((int) (Math.random() * multiTargetedSkills.size())));\n+        } else {\n+            return skills.get(multiTargetedSkills.get((int) (Math.random() * multiTargetedSkills.size())));\n+        }\n+    }\n+    \n     public MCSkill getSkill(final int id) {\n-        return skills.get(id);\n+        MCSkill skill = skills.get(id);\n+        if (skill != null && skill.skillid <= 0) {\n+            return randomizeSkill(skill.targetsAll);\n+        } else {\n+            return skill;\n+        }\n     }\n \n     public MCSkill getGuardian(final int id) {\n@@ -63,17 +89,14 @@ public MCSkill(int _cpLoss, int _skillid, int _level, boolean _targetsAll) {\n         }\n \n         public MobSkill getSkill() {\n-            return getMobSkill(skillid);\n+            return getMobSkill(skillid, level);\n         }\n         \n-        public static MobSkill getMobSkill(int skillid) {\n-            return MobSkillFactory.getMobSkill(skillid, 1); //level?\n+        public static MobSkill getMobSkill(int skillid, int level) {\n+            return MobSkillFactory.getMobSkill(skillid, level);\n         }\n \n         public MapleDisease getDisease() {\n-            if (skillid <= 0) {\n-                return MapleDisease.getRandom();\n-            }\n             return MapleDisease.getBySkill(skillid);\n         }\n     }"}, {"sha": "26bff2ec1735b9ff6512ab1f8447857457561ead", "filename": "src/server/partyquest/MonsterCarnival.java", "status": "modified", "additions": 38, "deletions": 32, "changes": 70, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/partyquest/MonsterCarnival.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/server/partyquest/MonsterCarnival.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnival.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -29,7 +29,7 @@\n     private long startTime = 0;\n     private int summonsR = 8, summonsB = 8, room = 0;\n     private MapleCharacter leader1, leader2, Grupo1, Grupo2;\n-    private int redCP, blueCP, redTotalCP, blueTotalCP;\n+    private int redCP, blueCP, redTotalCP, blueTotalCP, redTimeupCP, blueTimeupCP;\n     private boolean cpq1;\n \n     public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, int room) {\n@@ -42,6 +42,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n             p1.setEnemy(p2);\n             p2.setEnemy(p1);\n             map = cs.getMapFactory().getDisposableMap(mapid);\n+            startTime = System.currentTimeMillis() + 10 * 60 * 1000;\n             int redPortal = 0;\n             int bluePortal = 0;\n             if (map.isPurpleCPQMap()) {\n@@ -55,7 +56,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                     mc.setTeam(0);\n                     mc.setFestivalPoints(0);\n                     mc.forceChangeMap(map, map.getPortal(redPortal));\n-                    mc.dropMessage(6, LanguageConstants.Linguas(mc).CPQEntrada);\n+                    mc.dropMessage(6, LanguageConstants.Languages(mc).CPQEntry);\n                     if (p1.getLeader().getId() == mc.getId()) {\n                         leader1 = mc;\n                     }\n@@ -69,7 +70,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                     mc.setTeam(1);\n                     mc.setFestivalPoints(0);\n                     mc.forceChangeMap(map, map.getPortal(bluePortal));\n-                    mc.dropMessage(6, LanguageConstants.Linguas(mc).CPQEntrada);\n+                    mc.dropMessage(6, LanguageConstants.Languages(mc).CPQEntry);\n                     if (p2.getLeader().getId() == mc.getId()) {\n                         leader2 = mc;\n                     }\n@@ -78,16 +79,16 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n             }\n             if (Grupo1 == null || Grupo2 == null) {\n                 for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                    mpc.getPlayer().dropMessage(5, LanguageConstants.Linguas(mpc.getPlayer()).CPQErro);\n+                    mpc.getPlayer().dropMessage(5, LanguageConstants.Languages(mpc.getPlayer()).CPQError);\n                 }\n                 for (MaplePartyCharacter mpc : p2.getMembers()) {\n-                    mpc.getPlayer().dropMessage(5, LanguageConstants.Linguas(mpc.getPlayer()).CPQErro);\n+                    mpc.getPlayer().dropMessage(5, LanguageConstants.Languages(mpc.getPlayer()).CPQError);\n                 }\n                 return;\n             }\n-            Grupo1.getClient().announce(MaplePacketCreator.startMonsterCarnival(Grupo1, 0, 1));\n-            Grupo2.getClient().announce(MaplePacketCreator.startMonsterCarnival(Grupo2, 1, 0));\n-            startTime = System.currentTimeMillis() + 60 * 10000;\n+            \n+            // thanks Atoot, Vcoc for noting double CPQ functional being sent to players in CPQ start\n+            \n             timer = TimerManager.getInstance().schedule(new Runnable() {\n                 @Override\n                 public void run() {\n@@ -106,12 +107,8 @@ public void run() {\n                     respawn();\n                 }\n             }, ServerConstants.RESPAWN_INTERVAL);\n-            TimerManager.getInstance().schedule(new Runnable() {\n-                @Override\n-                public void run() {\n-                    map.addClock(60 * 10);\n-                }\n-            }, 2000);\n+            \n+            cs.initMonsterCarnival(cpq1, room);\n         } catch (Exception e) {\n             e.printStackTrace();\n         }\n@@ -140,18 +137,18 @@ public void playerDisconnected(int charid) {\n             String teamS = \"\";\n             switch (team) {\n                 case 0:\n-                    teamS = LanguageConstants.Linguas(chrMap).CPQVermelho;\n+                    teamS = LanguageConstants.Languages(chrMap).CPQRed;\n                     break;\n                 case 1:\n-                    teamS = LanguageConstants.Linguas(chrMap).CPQAzul;\n+                    teamS = LanguageConstants.Languages(chrMap).CPQBlue;\n                     break;\n             }\n-            chrMap.dropMessage(5, teamS + LanguageConstants.Linguas(chrMap).CPQPlayerExit);\n+            chrMap.dropMessage(5, teamS + LanguageConstants.Languages(chrMap).CPQPlayerExit);\n         }\n         earlyFinish();\n     }\n \n-    public void earlyFinish() {\n+    private void earlyFinish() {\n         dispose(true);\n     }\n \n@@ -180,12 +177,12 @@ public boolean canSummonB() {\n     }\n \n     protected void dispose(boolean warpout) {\n-        Channel cs = Server.getInstance().getWorld(p1.getLeader().getWorld()).getChannel(p1.getLeader().getChannel());\n+        Channel cs = map.getChannelServer();\n         MapleMap out;\n         if (!cpq1) { // cpq2\n-            out = cs.getMapFactory().getMap(980030000);\n+            out = cs.getMapFactory().getMap(980030010);\n         } else {\n-            out = cs.getMapFactory().getMap(980000000);\n+            out = cs.getMapFactory().getMap(980000010);\n         }\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n             MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n@@ -227,7 +224,8 @@ protected void dispose(boolean warpout) {\n         leader2.getParty().setEnemy(null);\n         map.dispose();\n         map = null;\n-\n+        \n+        cs.finishMonsterCarnival(cpq1, room);\n     }\n \n     public void exit() {\n@@ -238,9 +236,9 @@ public void exit() {\n         return this.timer;\n     }\n \n-    public void finish(int winningTeam) {\n+    private void finish(int winningTeam) {\n         try {\n-            Channel cs = Server.getInstance().getWorld(p1.getLeader().getWorld()).getChannel(p1.getLeader().getChannel());\n+            Channel cs = map.getChannelServer();\n             if (winningTeam == 0) {\n                 for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n                     MapleCharacter mc = cs.getPlayerStorage().getCharacterById(mpc.getId());\n@@ -306,9 +304,9 @@ public void finish(int winningTeam) {\n         }\n     }\n \n-    public void timeUp() {\n-        int cp1 = this.redTotalCP;\n-        int cp2 = this.blueTotalCP;\n+    private void timeUp() {\n+        int cp1 = this.redTimeupCP;\n+        int cp2 = this.blueTimeupCP;\n         if (cp1 == cp2) {\n             extendTime();\n             return;\n@@ -328,11 +326,11 @@ public int getTimeLeftSeconds() {\n         return (int) (getTimeLeft() / 1000);\n     }\n \n-    public void extendTime() {\n+    private void extendTime() {\n         for (MapleCharacter chrMap : map.getAllPlayers()) {\n-            chrMap.dropMessage(5, LanguageConstants.Linguas(chrMap).CPQTempoExtendido);\n+            chrMap.dropMessage(5, LanguageConstants.Languages(chrMap).CPQExtendTime);\n         }\n-        startTime = System.currentTimeMillis() + 3 * 1000;\n+        startTime = System.currentTimeMillis() + 3 * 60 * 1000;\n         map.addClock(3 * 60);\n         timer = TimerManager.getInstance().schedule(new Runnable() {\n             @Override\n@@ -345,12 +343,16 @@ public void run() {\n             public void run() {\n                 complete();\n             }\n-        }, 3 * 60 * 1000 - 10);\n+        }, 3 * 60 * 1000 - 10 * 1000); // thanks Vcoc for noticing a time set issue here\n     }\n \n     public void complete() {\n         int cp1 = this.redTotalCP;\n         int cp2 = this.blueTotalCP;\n+        \n+        this.redTimeupCP = cp1;\n+        this.blueTimeupCP = cp2;\n+        \n         if (cp1 == cp2) {\n             return;\n         }\n@@ -361,7 +363,7 @@ public void complete() {\n             throw new RuntimeException(\"Os lideres estao em canais diferentes.\");\n         }\n \n-        Channel cs = Server.getInstance().getWorld(p1.getLeader().getWorld()).getChannel(p1.getLeader().getChannel());\n+        Channel cs = map.getChannelServer();\n         map.killAllMonsters();\n         for (MaplePartyCharacter mpc : leader1.getParty().getMembers()) {\n             MapleCharacter mc;\n@@ -508,4 +510,8 @@ public void setCP(int CP, int team) {\n     public int getRoom() {\n         return this.room;\n     }\n+    \n+    public MapleMap getEventMap() {\n+        return this.map;\n+    }\n }"}, {"sha": "2ffeaf616c0cc413229e97a6e4eaed2712263c9f", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -4212,8 +4212,8 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n                 mplew.writeInt(reactor.getId());\n                 mplew.write(reactor.getState());\n                 mplew.writePos(pos);\n-                mplew.writeShort(0);\n                 mplew.write(0);\n+                mplew.writeShort(0);\n                 return mplew.getPacket();\n         }\n \n@@ -4225,8 +4225,8 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n                 mplew.writeInt(reactor.getObjectId());\n                 mplew.write(reactor.getState());\n                 mplew.writePos(pos);\n-                mplew.writeShort(stance);\n-                mplew.write(0);\n+                mplew.write(stance);\n+                mplew.writeShort(0);\n                 mplew.write(5); // frame delay, set to 5 since there doesn't appear to be a fixed formula for it\n                 return mplew.getPacket();\n         }\n@@ -4387,7 +4387,17 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n                 mplew.writeMapleAsciiString(charName);\n                 return mplew.getPacket();\n         }\n-\n+        \n+        public static byte[] createGuildMessage(String masterName, String guildName) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.GUILD_OPERATION.getValue());\n+                mplew.write(0x3);\n+                mplew.writeInt(0);\n+                mplew.writeMapleAsciiString(masterName);\n+                mplew.writeMapleAsciiString(guildName);\n+                return mplew.getPacket();\n+        }\n+        \n         /**\n          * Gets a Heracle/guild message packet.\n          *"}, {"sha": "672215c05ecad01f1bd461c1aaf10f2baf64972a", "filename": "src/tools/packets/Fishing.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/tools/packets/Fishing.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/src/tools/packets/Fishing.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/packets/Fishing.java?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -125,9 +125,9 @@ public static void doFishing(MapleCharacter chr, int baitLevel, double yearLikel\n     \n     public static int getRandomItem(){ \n         int rand = (int)(100.0 * Math.random()); \n-        int[] commons = {1002851, 2002020, 2002020, 2000006, 2000018, 2002018, 2002024, 2002027, 2002027, 2000018, 2000018, 2000018 , 2000018, 2002030, 2002018, 2000016}; // filler' up \n+        int[] commons = {1002851, 2002020, 2002020, 2000006, 2000018, 2002018, 2002024, 2002027, 2002027, 2000018, 2000018, 2000018, 2000018, 2002030, 2002018, 2000016}; // filler' up \n         int[] uncommons = {1000025, 1002662, 1002812, 1002850, 1002881, 1002880, 1012072, 4020009, 2043220, 2043022, 2040543, 2044420, 2040943, 2043713, 2044220, 2044120, 2040429, 2043220, 2040943}; // filler' uptoo \n-        int[] rares = {1002859, 1002553, 01002762, 01002763, 01002764, 01002765, 01002766, 01002663, 1002788, 1002949, 2049100, 2340000, 2040822,2040822,2040822,2040822,2040822,2040822,2040822,2040822}; // filler' uplast \n+        int[] rares = {1002859, 1002553, 1002762, 1002763, 1002764, 1002765, 1002766, 1002663, 1002788, 1002949, 2049100, 2340000, 2040822, 2040822, 2040822, 2040822}; // filler' uplast \n         \n         if(rand >= 25){ \n             return commons[(int)(commons.length * Math.random())]; "}, {"sha": "6807a2ba1902a255b464065dd83188d73fbe6d01", "filename": "tools/MapleQuestItemFetcher/nbproject/private/private.xml", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/tools/MapleQuestItemFetcher/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/tools/MapleQuestItemFetcher/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleQuestItemFetcher/nbproject/private/private.xml?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -2,9 +2,6 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group>\n-            <file>file:/C:/Nexon/HeavenMS/tools/MapleQuestItemFetcher/src/tools/MapleItemInformationProvider.java</file>\n-            <file>file:/C:/Nexon/HeavenMS/tools/MapleQuestItemFetcher/src/maplequestitemfetcher/MapleQuestItemFetcher.java</file>\n-        </group>\n+        <group/>\n     </open-files>\n </project-private>"}, {"sha": "8625d7136c0c16383d6a3ae4257a3fc7119132fa", "filename": "wz/Map.wz/WorldMap/WorldMap010.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/Map.wz/WorldMap/WorldMap010.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/Map.wz/WorldMap/WorldMap010.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap010.img.xml?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -783,6 +783,7 @@\n         <int name=\"26\" value=\"106021401\"/>\n         <int name=\"27\" value=\"106021402\"/>\n         <int name=\"28\" value=\"106021800\"/>\n+        <int name=\"29\" value=\"106021601\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"92\">"}, {"sha": "ab0b1a06c858f68342d3134557929db1f2c4d0c7", "filename": "wz/Map.wz/WorldMap/WorldMap014.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/Map.wz/WorldMap/WorldMap014.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/Map.wz/WorldMap/WorldMap014.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap014.img.xml?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -150,6 +150,7 @@\n       <imgdir name=\"mapNo\">\n         <int name=\"0\" value=\"106021600\"/>\n         <int name=\"1\" value=\"106021700\"/>\n+        <int name=\"2\" value=\"106021601\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"20\">"}, {"sha": "3bdd97de95789236b978060bc46e45f082503fac", "filename": "wz/String.wz/Consume.img.xml", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/String.wz/Consume.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/83266508af2bce7ed466b1cac860b41b5cb32f0c/wz/String.wz/Consume.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Consume.img.xml?ref=83266508af2bce7ed466b1cac860b41b5cb32f0c", "patch": "@@ -8017,23 +8017,23 @@\n   </imgdir>\n   <imgdir name=\"2280013\">\n     <string name=\"name\" value=\"[Skill Book] Final Blow\"/>\n-    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Lv Aran\\nCondition: #cFinal Blow# not available\"/>\n+    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Advancement Aran\\nCondition: #cFinal Blow# not available\"/>\n   </imgdir>\n   <imgdir name=\"2280014\">\n     <string name=\"name\" value=\"[Skill Book] High Defense\"/>\n-    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Lv Aran\\nCondition: #cHigh Defense# not available\"/>\n+    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Advancement Aran\\nCondition: #cHigh Defense# not available\"/>\n   </imgdir>\n   <imgdir name=\"2280015\">\n     <string name=\"name\" value=\"[Skill Book] Combo Tempest\"/>\n-    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Tempest# not available\"/>\n+    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Advancement Aran\\nCondition: #cCombo Tempest# not available\"/>\n   </imgdir>\n   <imgdir name=\"2280017\">\n     <string name=\"name\" value=\"[Skill Book] Pig&apos;s Weakness\"/>\n     <string name=\"desc\" value=\"Skill Book from which you can learn about the #cPig&apos;s Weakness# skill.\\nCondition: #cPig&apos;s Weakness# not available\"/>\n   </imgdir>\n   <imgdir name=\"2280016\">\n     <string name=\"name\" value=\"[Skill Book] Combo Barrier\"/>\n-    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Barrier# not available\"/>\n+    <string name=\"desc\" value=\"Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Advancement Aran\\nCondition: #cCombo Barrier# not available\"/>\n   </imgdir>\n   <imgdir name=\"2280018\">\n     <string name=\"name\" value=\"[Skill Book] Stump&apos;s Weakness\"/>"}]}]},
