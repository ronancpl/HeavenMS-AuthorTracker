{"fetchDate": "2019-12-19", "content": [{"sha": "5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NWVlMGNkMWM5ODAwMmQ4MWIzNDMyMTJiODVlZGU3Yjk3ZThhNDVjZQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-11-10T19:48:35Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-11-10T19:48:35Z"}, "message": "Using Java ThreadPool + Mob Skills & Event Instance patch + Eqp Merge\n\nServer source now uses Java ThreadPool, recycling used thread resources for next uses.\nAdded Grenade visual effect for other players.\nImplemented an attempt towards unsynced mob behavior, where reportedly players were able to pin same mob in different sections of the map.\nSolved several deadlock issues, mostly regarding character synchronized methods, event instance scripts and player/item vision-unvision.\nSolved an issue where mobs would not cast some skills of it's skillset. Frequent behavior on low-leveled mobs.\nFixed a bug on 2nd Maker quest where players could complete it by merely disassembling an equipment.\nNew custom mechanic: equipment merge. Similarly to the Bazaar NPC, every equipment after the selected one is used up, and a fraction of their stat amounts are used as stat gains on the currently equipped items. If restrictions are enabled, players must be high-leveled and Maker lv3 to use it.\nSkill Storm Break no longer uses up arrows.\nAdded a server flag to allow access for all Aran job skills from the beginning.\nImplemented Battleship and Super Transformation questline scripts.\nFixed a desynchronization within pet position and cash inventory position, that could potentially lead to some inventory issues until relogin.\nImproved timestamp handling in some handler classes. Spam detection is entirely a server-side matter, hence removed usage of client-sided timestamp content.\nRefactored some pet response packets, improving some of their behaviors.\nFixed some quest issues: Maker lv1 and Omega Sector meteorite one.", "tree": {"sha": "73e0cb8495392c0d81ee74bd4defeecfeb7cc389", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/73e0cb8495392c0d81ee74bd4defeecfeb7cc389"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "html_url": "https://github.com/ronancpl/HeavenMS/commit/5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "00675ab95d0c95a880a8829ea17b977291e2b1d6", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/00675ab95d0c95a880a8829ea17b977291e2b1d6", "html_url": "https://github.com/ronancpl/HeavenMS/commit/00675ab95d0c95a880a8829ea17b977291e2b1d6"}], "stats": {"total": 11179, "additions": 6108, "deletions": 5071}, "files": [{"sha": "31c1d321803f401c65484e7a6d3b7623e1e32132", "filename": "README.md", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -9,7 +9,7 @@ Regarding distributability and usage of the code presented here: like it was bef\n \n This is a NetBeans 8.0.2 Project, that MUST be built and run under JDK/JRE 7 (1.7.0_79+) in order to run properly. This means that it's easier to install the project via opening the server project folder inside NetBeans' IDE. Once installed, build this project on your machine and run the server using the \"launch.bat\" application.\n \n-In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of server source, in order to perceive it at it's full potential. My opinion, though! Refer to \"README_wzchanges.txt\" for more information on what has been changed from Nexon's v83 WZ files.\n+In this project, many gameplay-wise issues generated from either the original WZ files and the server source have been partially or completely solved. Considering the use of the provided edited WZ's and server-side wz.xml files should be of the greatest importance when dealing with this instance of server source, in order to perceive it at it's full potential. My opinion, though!\n \n The main objective of this project is to try as best as possible to recreate what once was the original MapleStory v83, while adding up some flavors that spices up the gameplay. In other words, aim to get the best of the MapleStory of that era.\n \n@@ -48,7 +48,7 @@ Client files & general tools: https://drive.google.com/drive/folders/0BzDsHSr-0V\n \n   * Fraysa's https://hostr.co/gJbLZITRVHmv\n \n-  * MapleSilver's starting on window-mode.\n+  * Eric's MapleSilver starting on window-mode.\n \n ---\n ### Development information\n@@ -175,7 +175,7 @@ Finally, select \"Clean and Build project\" to build the JAR file for the MapleSto\n The client's set-up is quite straightforward:\n \n 1. From \"ManagerMsv83.exe\", install MapleStory on your folder of preference (e.g. \"C:\\Nexon\\MapleStory\") and follow their instructions.\n-2. Once done, erase these files: \"HShield\" (folder), \"ASPLauncher.exe\", \"MapleStory.exe\" and \"patcher.exe\".\n+2. Once done, erase these files: \"HShield\" (folder), \"ASPLnchr.exe\", \"MapleStory.exe\" and \"Patcher.exe\".\n 3. Extract into the client folder the \"localhost.exe\" from the provided link.\n 4. Overwrite the original WZ files with the ones provided from either one of those folders on the Google Drive:\n \t- \"commit???_wz\" (last published RELEASE, referring to commit of same number)."}, {"sha": "35b5017b61f56ce09ce77a57dfa8ee20041740eb", "filename": "docs/feature_list.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -89,6 +89,7 @@ Cash & Items:\n * Storage with \"Arrange Items\" feature functional.\n * Close-quarters evaluation mode for items (sandbox).\n * Further improved Karma scissors & Untradeable items mechanics.\n+* Reviewed pet/item position data inconsistency within CASH inventory.\n * Spikes on shoes.\n * Vega's spell.\n * Owl of Minerva.\n@@ -175,6 +176,7 @@ Server potentials:\n * Delete Character (requires ENABLE_PIC activated).\n * Smoothed up view-all-char feature, now showing properly all available characters and not disconnecting players too often.\n * Centralized getcurrenttime throughout several server handlers, boosting it's performance overall.\n+* Centralized server timestamping, several timestamps received from clients are now unused, preventing some spammable exploits.\n * Autosaver (periodically saves on DB current state of every player in-game).\n * Both fixed and randomized versions of HP/MP growth rate available, regarding player job (enable one at ServerConstants). Placeholder for HP/MP washing feature.\n * Implemented methods to get the current Players' MaxHP/MaxMP method with equipment HP/MP gains already summed up.\n@@ -191,6 +193,7 @@ Custom NPCs:\n * Asia: scroll & rarities shop NPC.\n * Abdula: lists droppers of needed skill/mastery books.\n * Agent E: accessory crafter.\n+* Dalair: automatized equipment-merger.\n * Donation Box: automatized item-buyer.\n * Coco & Ace of Hearts: C. scroll crafters.\n \n@@ -239,6 +242,7 @@ Project:\n * Reviewed SQL data, eliminating duplicated entries on the tables.\n * Improved login phase, using cache over DB queries.\n * Usage of HikariCP to improve the DB connection management.\n+* Usage of Java Threadpool to improve runnable call management.\n * Developed many survey tools for content profiling.\n * Developed a robust anti-exploit login coordinator system.\n * Protected many flaws with login management system."}, {"sha": "40390bc48411db1bdf3d15c13cd4c3e3763eedd1", "filename": "docs/moveactions.txt", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/moveactions.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/moveactions.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/moveactions.txt?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "previous_filename": "tools/SQL/userstances.txt"}, {"sha": "56831b2afe67a5af6b947ae53289d83db55d70e5", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 44, "deletions": 5, "changes": 49, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -2,12 +2,15 @@\n \tSpiegelmann -> 2042000\n \tCoco -> 9000017\n \tAgent E -> 9000036\n+\tDalair -> 9000040\n \tDonation Box -> 9000041\n-\tAbdula -> 9209000\n+\tAbdula -> 9209000 *\n \n-CUSTOM NPC SHOPS:\n-\tAsia -> 2082014\n-\tT-1337 -> 9201101\n+CUSTOM NPC SHOPS (db_shopupdate.sql):\n+\tAsia -> 2082014 *\n+\tT-1337 -> 9201101 *\n+\n+\t* : those won't get disabled when USE_ENABLE_CUSTOM_NPC_SCRIPTS = false\n \n LOGS:\n \n@@ -1414,4 +1417,40 @@ Removido possibilidade de colocar itens \"untradeable\" no Duey.\n Removido possibilidade de preparar engagements enquanto segurando aneis de casamento.\n \n 23 Outubro 2018,\n-Adicionado script para quest de 4o job de Cygnus Knights.\n\\ No newline at end of file\n+Adicionado script para quest de 4o job de Cygnus Knights.\n+\n+25 - 27 Outubro 2018,\n+Scripts de eventos agora executam em uma thread separada, assim resolvendo poss\u00edveis problemas de deadlocks.\n+Realizada tentativa de solu\u00e7\u00e3o para casos onde jogadores percebem mobs em pontos diferentes do mapa em certas situa\u00e7\u00f5es.\n+Clareado um problema de deadlock relacionado a packets de vis\u00e3o/desaparecimento de jogadores e mobs.\n+Resolvido diversos problemas de deadlocks relacionados com event instances.\n+Implementado ThreadManager. Este sistema utiliza a abordagem de ThreadPool para reciclagem de threads utilizadas, assim eliminando realiza\u00e7\u00e3o de overhead ao criar novas threads a todo uso.\n+Resolvido certos casos onde requisi\u00e7\u00e3o de item pickup de jogador n\u00e3o era devidamente registrado pelo servidor como a\u00e7\u00e3o v\u00e1lida.\n+\n+29 - 31 Outubro 2018,\n+Corrigido mobs n\u00e3o lan\u00e7ando skills em determinados casos. Comportamento not\u00e1vel era mobs de n\u00edvel baixo utilizando nenhuma skill.\n+Skill Storm Break n\u00e3o mais remove flechas ao ser utilizada.\n+Implementado m\u00e9todo que for\u00e7a altera\u00e7\u00e3o na posi\u00e7\u00e3o atual de mobs no mapa.\n+Mobs que forem atacados de muito longe ter\u00e3o suas posi\u00e7\u00f5es atualizadas para todos os jogadores no mapa, buscando assim evitar dessincroniza\u00e7\u00f5es entre clientes.\n+Adicionado drops de red bean porridge em alguns mobs de El Nath.\n+Implementado flag para op\u00e7\u00e3o de aquisi\u00e7\u00e3o de belts de Dojo regular ou f\u00e1cil.\n+Corrigido map banish de mobs n\u00e3o funcionando corretamente ap\u00f3s as \u00faltimas atualiza\u00e7\u00f5es do MoveLifeHandler.\n+Corrigido bug na quest do 2nd Maker que permitia conclus\u00e3o de quest ao realizar disassemble em equipamentos.\n+Adicionado nova mec\u00e2nica custom: amalgama de equipamentos. Jogadores acima do n\u00edvel 160, que possuem Maker level 3, poder\u00e3o utilizar esta mec\u00e2nica para alavancar atributos dos itens equipados.\n+Refatorado m\u00e9todo de ganho de fama para n\u00e3o mais usar modificador synchronized, assim evitando poss\u00edvel caso de deadlock.\n+Adicionado server flag que permite acesso a todas as skills de job de Aran ao iniciar novo job.\n+Corrigido hor\u00e1rio irregular no sistema do servidor.\n+Adicionado scripts para skill quests de Battleship e Super Transformation.\n+\n+03 Novembro 2018,\n+Corrigido caso onde pets estavam com posi\u00e7\u00f5es de invent\u00e1rio desatualizadas, levando a certas inconsist\u00eancias com evoluir/administrar pets.\n+\n+05 Novembro 2018,\n+Alterado administra\u00e7\u00e3o de timestamp nos handlers. Agora detec\u00e7\u00e3o de spam \u00e9 inteiramente responsabilidade do servidor, onde a detec\u00e7\u00e3o de spam ocorre de acordo com quantidade de vezes que um pacote \u00e9 recebido num dado intervalo de tempo estipulado internamente.\n+Refatorado packets que lidam com respostas a comandos de pets.\n+\n+07 - 09 Novembro 2018,\n+Corrigido drop data de Ultra Gray com item inexistente.\n+Corrigido quest de meteoritos mudando estado da quest mesmo quando jogador n\u00e3o recebe o item devido a invent\u00e1rio cheio.\n+Corrigido quest de Maker lv1 retirando mesos al\u00e9m da quantidade esperada, ao realizar a\u00e7\u00f5es da quest.\n+Adicionado server flag que lida com utiliza\u00e7\u00e3o de features NPCs custom.\n\\ No newline at end of file"}, {"sha": "40b59731b0b81e1b2dda319c3ba707c8c8c7a8a0", "filename": "docs/npcmarkups.txt", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/npcmarkups.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/docs/npcmarkups.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/npcmarkups.txt?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,28 @@\n+Source: http://metropi.forumotion.net/t32-npc-scripting-guide-from-ragezone\n+\n+NPC Markups:\n+#b = Blue text.\n+#c[itemid]# Shows how many [itemid] the player has in their inventory.\n+#d = Purple text.\n+#e = Bold text.\n+#f[imagelocation]# - Shows an image inside the .wz files.\n+#g = Green text.\n+#h # - Shows the name of the player.\n+#i[itemid]# - Shows a picture of the item.\n+#k = Black text.\n+#l - Selection close.\n+#m[mapid]# - Shows the name of the map.\n+#n = Normal text (removes bold).\n+#o[mobid]# - Shows the name of the mob.\n+#p[npcid]# - Shows the name of the NPC.\n+#q[skillid]# - Shows the name of the skill.\n+#r = Red text.\n+#s[skillid]# - Shows the image of the skill.\n+#t[itemid]# - Shows the name of the item.\n+#v[itemid]# - Shows a picture of the item.\n+#x - Returns \"0%\" (need more information on this).\n+#z[itemid]# - Shows the name of the item.\n+#B[%]# - Shows a 'progress' bar.\n+#F[imagelocation]# - Shows an image inside the .wz files.\n+#L[number]# Selection open.\n+\\r\\n - Moves down a line.\n\\ No newline at end of file"}, {"sha": "eda4afffdd54ca9e82e72f7cd7f072c1b4d7bebf", "filename": "scripts/event/4jship.js", "status": "added", "additions": 138, "deletions": 0, "changes": 138, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/event/4jship.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/event/4jship.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jship.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,138 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+/**\n+ * @Author Ronan\n+ * Event - Kyrin's Test Quest\n+**/\n+\n+var entryMap = 912010000;\n+var exitMap = 120000101;\n+\n+var minMapId = 912010000;\n+var maxMapId = 912010200;\n+\n+var eventTime = 4; //4 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function setLobbyRange() {\n+    return lobbyRange;\n+}\n+\n+function init() {\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"4jship_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    eim.setProperty(\"canLeave\", \"0\");\n+\n+    eim.getInstanceMap(entryMap).resetPQ(level);\n+\n+    respawnStages(eim);\n+    eim.startEventTimer(eventTime * 60000);\n+    eim.schedule(\"playerCanLeave\", 1 * 60000);\n+    eim.schedule(\"playerSurvived\", 2 * 60000);\n+    return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {}\n+\n+function playerCanLeave(eim) {\n+    eim.setIntProperty(\"canLeave\", 1);\n+}\n+\n+function playerSurvived(eim) {\n+    if (eim.getLeader().isAlive()) {\n+        eim.setIntProperty(\"canLeave\", 2);\n+        eim.dropMessage(5, \"Kyrin: You have passed the test. Now for the closing part... Are you able reach the exit over there?\");\n+    } else {\n+        eim.dropMessage(5, \"Kyrin: You have failed the test. Aww, don't have such a sad face, just try it again later, ok?\");\n+    }\n+}\n+\n+function playerEntry(eim, player) {\n+    var map = eim.getMapInstance(entryMap);\n+    player.changeMap(map, map.getPortal(0));\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+    eim.unregisterPlayer(player);\n+    eim.dispose();\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function playerLeft(eim, player) {}\n+\n+function scheduledTimeout(eim) {\n+    var player = eim.getPlayers().get(0);\n+    playerExit(eim, player);\n+    player.changeMap(exitMap);\n+}\n+\n+function playerDisconnected(eim, player) {\n+    playerExit(eim, player);\n+}\n+\n+function changedMap(eim, chr, mapid) {\n+    if(mapid < minMapId || mapid > maxMapId) playerExit(eim, chr);\n+}\n+\n+function clearPQ(eim) {\n+    eim.stopEventTimer();\n+    eim.setEventCleared();\n+    \n+    var player = eim.getPlayers().get(0);\n+    eim.unregisterPlayer(player);\n+    player.changeMap(exitMap);\n+    \n+    eim.dispose();\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function monsterKilled(mob, eim) {}\n+\n+function leftParty(eim, player) {}\n+\n+function disbandParty(eim) {}\n+\n+function monsterValue(eim, mobId) {\n+    return 1;\n+}\n+\n+function friendlyKilled(mob, eim) {\n+    if(em.getProperty(\"noEntry\") != \"false\") {\n+        var player = eim.getPlayers().get(0);\n+        playerExit(eim, player);\n+        player.changeMap(exitMap);\n+    }\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function cancelSchedule() {}\n+\n+function dispose() {}"}, {"sha": "565d7c6f27a6826fcadaab4a3a14163a042d9ca3", "filename": "scripts/event/4jsuper.js", "status": "added", "additions": 140, "deletions": 0, "changes": 140, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/event/4jsuper.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/event/4jsuper.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jsuper.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,140 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+/**\n+ * @Author Ronan\n+ * Event - Kyrin's Test Quest\n+**/\n+\n+var entryMap = 912010100;\n+var exitMap = 120000101;\n+\n+var minMapId = 912010100;\n+var maxMapId = 912010200;\n+\n+var eventTime = 4; //4 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function setLobbyRange() {\n+    return lobbyRange;\n+}\n+\n+function init() {\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"4jsuper_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    eim.setProperty(\"canLeave\", \"0\");\n+\n+    eim.getInstanceMap(entryMap).resetPQ(level);\n+\n+    respawnStages(eim);\n+    eim.startEventTimer(eventTime * 60000);\n+    eim.schedule(\"playerCanLeave\", 1 * 60000);\n+    eim.schedule(\"playerSurvived\", 2 * 60000);\n+    return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {}\n+\n+function playerCanLeave(eim) {\n+    eim.setIntProperty(\"canLeave\", 1);\n+}\n+\n+function playerSurvived(eim) {\n+    if (eim.getLeader().isAlive()) {\n+        eim.setIntProperty(\"canLeave\", 2);\n+        eim.dropMessage(5, \"Kyrin: You have passed the test. Now for the closing part... Are you able reach the exit over there?\");\n+    } else {\n+        eim.dropMessage(5, \"Kyrin: You have failed the test. Aww, don't have such a sad face, just try it again later, ok?\");\n+    }\n+}\n+\n+function playerEntry(eim, player) {\n+    var map = eim.getMapInstance(entryMap);\n+    player.changeMap(map, map.getPortal(0));\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+    eim.unregisterPlayer(player);\n+    eim.dispose();\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function playerLeft(eim, player) {}\n+\n+function scheduledTimeout(eim) {\n+    var player = eim.getPlayers().get(0);\n+    playerExit(eim, player);\n+    player.changeMap(exitMap);\n+}\n+\n+function playerDisconnected(eim, player) {\n+    playerExit(eim, player);\n+}\n+\n+function changedMap(eim, chr, mapid) {\n+    if(mapid < minMapId || mapid > maxMapId) playerExit(eim, chr);\n+}\n+\n+function changedLeader(eim, leader) {}\n+\n+function clearPQ(eim) {\n+    eim.stopEventTimer();\n+    eim.setEventCleared();\n+    \n+    var player = eim.getPlayers().get(0);\n+    eim.unregisterPlayer(player);\n+    player.changeMap(exitMap);\n+    \n+    eim.dispose();\n+    em.setProperty(\"noEntry\",\"false\");\n+}\n+\n+function monsterKilled(mob, eim) {}\n+\n+function leftParty(eim, player) {}\n+\n+function disbandParty(eim) {}\n+\n+function monsterValue(eim, mobId) {\n+    return 1;\n+}\n+\n+function friendlyKilled(mob, eim) {\n+    if(em.getProperty(\"noEntry\") != \"false\") {\n+        var player = eim.getPlayers().get(0);\n+        playerExit(eim, player);\n+        player.changeMap(exitMap);\n+    }\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function cancelSchedule() {}\n+\n+function dispose() {}"}, {"sha": "3a1c038675b9d464407c0e4582b32ac9d3abc9dc", "filename": "scripts/npc/1032000.js", "status": "modified", "additions": 23, "deletions": 11, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1032000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1032000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1032000.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -3,6 +3,7 @@ var maps = [104000000, 102000000, 100000000, 103000000, 120000000];\n var cost = [1000, 1000, 1000, 1000, 800];\n var selectedMap = -1;\n var mesos;\n+var hasCoupon = false;\n \n function start() {\n     cm.sendNext(\"Hello, I drive the Regular Cab. If you want to go from town to town safely and fast, then ride our cab. We'll glady take you to your destination with an affordable price.\");\n@@ -33,22 +34,33 @@ function action(mode, type, selection) {\n                 selStr += \"\\r\\n#L\" + i + \"##m\" + maps[i] + \"# (\" + (cm.getJobId() == 0 ? cost[i] / 10 : cost[i]) + \" mesos)#l\";\n             cm.sendSimple(selStr);\n         } else if (status == 2) {\n-            cm.sendYesNo(\"You don't have anything else to do here, huh? Do you really want to go to #b#m\" + maps[selection] + \"##k? It'll cost you #b\"+ (cm.getJobId() == 0 ? cost[selection] / 10 : cost[selection]) + \" mesos#k.\");\n-            selectedMap = selection;\n-        } else if (status == 3) {\n-            if (cm.getJobId() == 0) {\n-            \tmesos = cost[selectedMap] / 10;\n+            if (maps[selection] == 100000000 && cm.getMapId() == 101000000 && cm.haveItem(4032288)) {\n+                cm.sendYesNo(\"Hmm, I see you have been recommended by Neinheart to come to Victoria Island to improve your knightly skills. Well, just this time the ride will be free of charges. Will you take the ride?\");\n+                hasCoupon = true;\n             } else {\n-            \tmesos = cost[selectedMap];\n+                cm.sendYesNo(\"You don't have anything else to do here, huh? Do you really want to go to #b#m\" + maps[selection] + \"##k? It'll cost you #b\"+ (cm.getJobId() == 0 ? cost[selection] / 10 : cost[selection]) + \" mesos#k.\");\n             }\n             \n-            if (cm.getMeso() < mesos) {\n-                cm.sendNext(\"You don't have enough mesos. Sorry to say this, but without them, you won't be able to ride the cab.\");\n-                cm.dispose();\n-                return;\n+            selectedMap = selection;\n+        } else if (status == 3) {\n+            if (!hasCoupon) {\n+                if (cm.getJobId() == 0) {\n+                    mesos = cost[selectedMap] / 10;\n+                } else {\n+                    mesos = cost[selectedMap];\n+                }\n+\n+                if (cm.getMeso() < mesos) {\n+                    cm.sendNext(\"You don't have enough mesos. Sorry to say this, but without them, you won't be able to ride the cab.\");\n+                    cm.dispose();\n+                    return;\n+                }\n+\n+                cm.gainMeso(-mesos);\n+            } else {\n+                cm.gainItem(4032288, -1);\n             }\n             \n-            cm.gainMeso(-mesos);\n             cm.warp(maps[selectedMap], 0);\n             cm.dispose();\n         }"}, {"sha": "ec0aee22878d3148d9e6b1fe1141440e9692e29e", "filename": "scripts/npc/1052014.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1052014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1052014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052014.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -79,7 +79,7 @@ function action(mode, type, selection) {\n                     \n                 if(status == 0) {\n                         hasCoin = cm.haveItem(coinId);\n-                        cm.sendNext(\"This is the vending machine of the Internet Cafe. Place your erasers or #t\" + coinId + \"# earned throughout the quests to redeem a prize. You can place #bany amount of erasers#k, however take note that bigger shots improves the reward possibilities!\");\n+                        cm.sendNext(\"This is the vending machine of the Internet Cafe. Place your erasers or #t\" + coinId + \"# earned throughout the quests to redeem a prize. You can place #bany amount of erasers#k, however take note that placing #rdifferent erasers#k and #rbigger shots of any of them#k will improve the reward possibilities!\");\n                 } else if(status == 1) {\n                         var sendStr;\n                         currentTier = getRewardTier();"}, {"sha": "dfc900e45aefe7ed504ce7af8022ec6e9a3cd897", "filename": "scripts/npc/1090000.js", "status": "modified", "additions": 50, "deletions": 2, "changes": 52, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1090000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1090000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1090000.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,8 +33,39 @@ spawnPnpc = false;\n spawnPnpcFee = 7000000;\n jobType = 5;\n \n+var advQuest = 0;\n function start() {\n-    if (parseInt(cm.getJobId() / 100) == jobType && cm.canSpawnPlayerNpc(Packages.constants.GameConstants.getHallOfFameMapid(cm.getJob()))) {\n+    if (cm.isQuestStarted(6330)) {\n+        if (cm.getEventInstance() != null) {    // missing script for skill test found thanks to Lost(tm)\n+            advQuest = 5;                       // string visibility thanks to iPunchEm & Glvelturall\n+            cm.sendNext(\"Not bad at all. Let's discuss this outside!\");\n+            cm.setQuestProgress(6330, 0, 1);\n+        } else if (cm.getQuestProgress(6330, 0) == 0) {\n+            advQuest = 1;\n+            cm.sendNext(\"You're ready, right? Now try to withstand my attacks for 2 minutes. I won't go easy on you. Good luck, because you will need it.\");\n+        } else {\n+            advQuest = 3;\n+            cm.teachSkill(5121003, 0, 10, -1);\n+            cm.forceCompleteQuest(6330);\n+            \n+            cm.sendNext(\"Congratulations. You have managed to pass my test. I'll teach you a new skill called \\\"Super Transformation\\\".\\r\\n\\r\\n  #s5221003#    #b#q5221003##k\");\n+        }\n+    } else if (cm.isQuestStarted(6370)) {\n+        if (cm.getEventInstance() != null) {\n+            advQuest = 6;\n+            cm.sendNext(\"Not bad at all. Let's discuss this outside!\");\n+            cm.setQuestProgress(6370, 0, 1);\n+        } else if (cm.getQuestProgress(6370, 0) == 0) {\n+            advQuest = 2;\n+            cm.sendNext(\"You're ready, right? Now try to withstand my attacks for 2 minutes. I won't go easy on you. Good luck, because you will need it.\");\n+        } else {\n+            advQuest = 4;\n+            cm.teachSkill(5221006, 0, 10, -1);\n+            cm.forceCompleteQuest(6370);\n+            \n+            cm.sendNext(\"Congratulations. You have managed to pass my test. I'll teach you a new skill called \\\"Battleship\\\".\\r\\n\\r\\n  #s5221006#    #b#q5221006##k\");\n+        }\n+    } else if (parseInt(cm.getJobId() / 100) == jobType && cm.canSpawnPlayerNpc(Packages.constants.GameConstants.getHallOfFameMapid(cm.getJob()))) {\n         spawnPnpc = true;\n         \n         var sendStr = \"You have walked a long way to reach the power, wisdom and courage you hold today, haven't you? What do you say about having right now #ra NPC on the Hall of Fame holding the current image of your character#k? Do you like it?\";\n@@ -82,7 +113,24 @@ function action(mode, type, selection) {\n         start();\n         return;\n     } else {\n-        if(spawnPnpc) {\n+        if (advQuest > 0) {\n+            if (advQuest < 3) {\n+                var em = cm.getEventManager(advQuest == 1 ? \"4jship\" : \"4jsuper\");\n+                if(!em.startInstance(cm.getPlayer())) {\n+                    cm.sendOk(\"Someone is already challenging the test. Please try again later.\");\n+                }\n+            } else if (advQuest < 5) {\n+                if (advQuest == 3) {\n+                    cm.sendOk(\"It is similar to that of 'Transformation', but it's much more powerful than that. Keep training, and hope to see you around.\");\n+                } else {\n+                    cm.sendOk(\"Unlike most of the other skills you used as a Pirate, this one definitely is different. You can actually ride the 'Battleship' and attack enemies with it. Your DEF level will increase for the time you're on board, so that'll help you tremendously in combat situations. May you become the best Gunslinger out there...\");\n+                }\n+            } else {\n+                cm.warp(120000101);\n+            }\n+            \n+            cm.dispose();\n+        } else if(spawnPnpc) {\n             if(mode > 0) {\n                 if(cm.getMeso() < spawnPnpcFee) {\n                     cm.sendOk(\"Sorry, you don't have enough mesos to purchase your place on the Hall of Fame.\");"}, {"sha": "888d506e5b17bd2913203365ca5dd21db0f2c89a", "filename": "scripts/npc/1100003.js", "status": "modified", "additions": 6, "deletions": 19, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1100003.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1100003.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1100003.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -12,12 +12,8 @@\n var menu = new Array(\"Victoria Island\");\n var method;\n \n-var hasCoupon = false;\n-\n function start() {\n \tstatus = -1;\n-        if(cm.haveItem(4032288)) hasCoupon = true;\n-        \n \taction(1, 0, 0);\n }\n \n@@ -36,22 +32,13 @@ function action(mode, type, selection) {\n \t\t}\n \t\tstatus++;\n \t\tif (status == 0) {\n-                        if(!hasCoupon) {\n-                                var display = \"\";\n-                                for(var i=0; i < menu.length; i++) {\n-\t\t\t\t\tdisplay += \"\\r\\n#L\"+i+\"##b Victoria Island (1000 mesos)#k\";\n-\t\t\t\t}\t\t\t\n-\t\t\t\tcm.sendSimple(\"Eh, Hello...again. Do you want to leave Ereve and go somewhere else? If so, you've come to the right place. I operate a ferry that goes from #bEreve#k to #bVictoria Island#k, I can take you to #bVictoria Island#k if you want... You'll have to pay a fee of #b1000#k Mesos.\\r\\n\"+display);\n-                        } else {\n-                                cm.sendYesNo(\"Hmm, hi there. I see you have been recommended by Neinheart to go to Victoria Island to improve your knightly skills. Well, just this time the ride will be free of charges. Will you embark?\");\n-                        }\n-\t\t\t\n+                        var display = \"\";\n+                        for(var i=0; i < menu.length; i++) {\n+                                display += \"\\r\\n#L\"+i+\"##b Victoria Island (1000 mesos)#k\";\n+                        }\t\t\t\n+                        cm.sendSimple(\"Eh, Hello...again. Do you want to leave Ereve and go somewhere else? If so, you've come to the right place. I operate a ferry that goes from #bEreve#k to #bVictoria Island#k, I can take you to #bVictoria Island#k if you want... You'll have to pay a fee of #b1000#k Mesos.\\r\\n\"+display);\n \t\t} else if(status == 1) {\n-                        if(hasCoupon) {\n-                                cm.gainItem(4032288, -1);\n-\t\t\t\tcm.warp(200090031);\n-\t\t\t\tcm.dispose();\n-                        } else if(cm.getMeso() < 1000) {\n+                        if(cm.getMeso() < 1000) {\n \t\t\t\tcm.sendNext(\"Hmm... Are you sure you have #b1000#k Mesos? Check your Inventory and make sure you have enough. You must pay the fee or I can't let you get on...\");\n \t\t\t\tcm.dispose();\n \t\t\t} else {"}, {"sha": "02b897740e81782c6208e4b00d5f3f418b7c347a", "filename": "scripts/npc/1100006.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1100006.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1100006.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1100006.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -10,6 +10,6 @@\n **/\n \n function start() {\n-    cm.sendOk(\"Ah, such lovely winds. This should be a perfect voyage as long as no stupid customer falls off for attempting some weird skill. Of course, I'm talking about you. Please refain from using your skills.\");\n+    cm.sendOk(\"Ah, such lovely winds. This should be a perfect voyage as long as no stupid customer falls off for attempting some weird skill. Of course, I'm talking about you. Please refrain from using your skills.\");\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "7837038476c884a8f99665d7fe2ca43417245ec6", "filename": "scripts/npc/1101001.js", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1101001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/1101001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1101001.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1,11 +1,15 @@\n  /* \n \tNPC Name: \t\tDivine Bird\n \tMap(s): \t\tErev\n-\tDescription: \t\tBuff\n+\tDescription: \t\t3rd job KoC Buff\n */\n+importPackage(Packages.constants);\n \n function start() {\n-    cm.useItem(2022458);\n+    if (cm.getPlayer().isCygnus() && GameConstants.getJobBranch(cm.getJob()) > 2) {\n+        cm.useItem(2022458);\n+    }\n+    \n     cm.sendOk(\"Don't stop training. Every ounce of your energy is required to protect the world of Maple....\");\n-\tcm.dispose();\n+    cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "45d5ef912b03185e2dd10dda810a974b05e497e4", "filename": "scripts/npc/2042000.js", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2042000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2042000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -49,18 +49,24 @@ function action(mode, type, selection) {\n                         status--;\n     \n                 if(status == 0) {\n+                        if (!Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                                cm.sendOk(\"The Monster Carnival is currently unavailable.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+                    \n                         var selStr = \"The Monster Carnival is currently unavailable, but instead I offer a steadfast #bore refining#k service for you, taxing #r\" + ((feeMultiplier * 100) | 0) + \"%#k over the usual fee to synthetize them. What will you do?#b\";\n                         \n                         var options = new Array(\"Refine mineral ores\",\"Refine jewel ores\");\n                         if(refineCrystals) {\n-                            options.push(\"Refine crystal ores\");\n+                                options.push(\"Refine crystal ores\");\n                         }\n                         if(refineRocks) {\n-                            options.push(\"Refine plates/jewels\");\n+                                options.push(\"Refine plates/jewels\");\n                         }\n                         \n                         for (var i = 0; i < options.length; i++){\n-                            selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n+                                selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";\n                         }\n                         \n                         cm.sendSimple(selStr);"}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050014.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050014.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050015.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050015.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050015.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050015.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050016.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050016.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050016.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050016.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050017.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050017.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050017.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050017.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050018.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050018.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050018.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050018.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "5a43f0112ead4b850c39ec5f872c68f9d30d5888", "filename": "scripts/npc/2050019.js", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050019.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2050019.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2050019.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,10 +47,14 @@ function action(mode, type, selection) {\n                                 \n                                 var progress = cm.getQuestProgress(3421, 0);\n                                 if((progress >> meteoriteId) % 2 == 0 || (progress == 63 && !cm.haveItem(4031117, 6))) {\n-                                        progress |= (1 << meteoriteId);\n-                                        \n-                                        cm.gainItem(4031117, 1);\n-                                        cm.setQuestProgress(3421, 0, progress);\n+                                        if (cm.canHold(4031117, 1)) {\n+                                                progress |= (1 << meteoriteId);\n+                                                \n+                                                cm.gainItem(4031117, 1);\n+                                                cm.setQuestProgress(3421, 0, progress);\n+                                        } else {\n+                                                cm.getPlayer().dropMessage(1, \"Have a ETC slot available for this item.\");\n+                                        }\n                                 }\n                         }\n                         "}, {"sha": "6c9f1abed2ff413277774d5a5c8267fa4643825a", "filename": "scripts/npc/2091005.js", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -25,26 +25,27 @@\n * @Map(s): Dojo Hall\n */\n importPackage(Packages.server.maps);\n+importPackage(Packages.constants);\n \n var disabled = false;\n var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);\n var belt_level = Array(25, 35, 45, 60, 75);\n var belt_on_inventory;\n-\n-/* var belt_points = Array(200, 1800, 4000, 9200, 17000); */\n-var belt_points = Array(10, 90, 200, 460, 850); /* Watered down version */\n+var belt_points;\n \n var status = -1;\n var selectedMenu = -1;\n var dojoWarp = 0;\n \n function start() {\n-    if(disabled) {\n+    if (disabled) {\n         cm.sendOk(\"My master has requested that the dojo be #rclosed#k at this time so I can't let you in.\");\n         cm.dispose();\n         return;\n     }\n     \n+    belt_points = ServerConstants.USE_FAST_DOJO_UPGRADE ? Array(10, 90, 200, 460, 850) : Array(200, 1800, 4000, 9200, 17000);\n+    \n     belt_on_inventory = new Array();\n     for (var i = 0; i < belts.length; i++) {\n         belt_on_inventory.push(cm.haveItemWithId(belts[i], true));"}, {"sha": "f2cc998982b1419d30aeab109789bc110f359086", "filename": "scripts/npc/2101013.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2101013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/2101013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101013.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -14,7 +14,7 @@ function action(mode, type, selection) {\n \tif (mode == -1) {\n \t\tcm.dispose();\n \t} else {\n-\tif (status == 0 && mode == 0) {\n+\tif (mode == 0) {\n \t\tcm.sendNext(\"Aye...are you scared of speed or heights? You can't trust my flying skills? Trust me, I've worked out all the kinks!\");\n \t\tcm.dispose();\n \t\treturn;\n@@ -26,7 +26,7 @@ function action(mode, type, selection) {\n \tif(status == 0){\n \t\tcm.sendNext(\"I don't know how you found out about this, but you came to the right place! For those that wandered around Nihal Desert and are getting homesick, I am offering a flight straight to Victorial Island, non-stop! Don't worry about the flying ship--it's only fallen once or twice! Don't you feel claustrophobic being in a long flight on that small ship?\");\n \t} else if(status == 1){\n-\t\tcm.sendAcceptDecline(\"Please remember two things. One, this line is actually for overseas shipping, so #rI cannot gurantee exactly which town you'll land#k. Two, since I am putting you in this special flight, it'll be a bit expensive. The service charge is #e#b10,000 mesos#n#k. There's a flight thats about to take off. Are you interested in this direct flight?\");\n+\t\tcm.sendYesNo(\"Please remember two things. One, this line is actually for overseas shipping, so #rI cannot gurantee exactly which town you'll land#k. Two, since I am putting you in this special flight, it'll be a bit expensive. The service charge is #e#b10,000 mesos#n#k. There's a flight thats about to take off. Are you interested in this direct flight?\");\n \t} else if(status == 2){\n \t\tcm.sendNext(\"Okay, ready to takeoff~\");\n \t} else if(status == 3){"}, {"sha": "57e58dde3c6115ad721ca3886e08847154ee35ee", "filename": "scripts/npc/9000017.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000017.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000017.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000017.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -51,6 +51,12 @@ function action(mode, type, selection) {\n     }\n \n     if (status == 0) {\n+        if (!Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+            cm.sendOk(\"Hi, I'm #b#p\" + cm.getNpc() + \"##k.\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n         var selStr = \"Hey traveler! Come, come closer... We offer a #bhuge opportunity of business#k to you. If you want to know what it is, keep listening...\";\n         cm.sendNext(selStr);\n     }"}, {"sha": "ba2581eedd34426b9ad8245ae34cb8106ffe995a", "filename": "scripts/npc/9000036.js", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000036.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000036.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000036.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -39,6 +39,12 @@ var equip;\n var maxEqp = 0;\n \n function start() {\n+    if (!Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+        cm.sendOk(\"Hi, I'm #b#p\" + cm.getNpc() + \"##k.\");\n+        cm.dispose();\n+        return;\n+    }\n+    \n     cm.getPlayer().setCS(true);\n     var selStr = \"Hello, I am the #bAccessory NPC Crafter#k! My works are widely recognized to be too fine, up to the point at which all my items mimic not only the appearance but too the attributes of them! Everything I charge is some 'ingredients' to make them and, of course, a fee for my services. On what kind of equipment are you interessed?#b\";\n     var options = [\"Pendants\",\"Face accessories\",\"Eye accessories\",\"Belts & medals\",\"Rings\"/*,\"#t4032496#\"*/];\n@@ -56,7 +62,7 @@ function action(mode, type, selection) {\n     if (status == 0) {\n         if (selection == 0) { //pendants\n             var selStr = \"Well, I've got these pendants on my repertoire:#b\";\n-            items = [1122018,1122007,1122001,1122002,1122003,1122004,1122005,1122006,1122058];\n+            items = [1122018,1122007,1122001,1122003,1122004,1122006,1122002,1122005,1122058];\n             for (var i = 0; i < items.length; i++)\n                 selStr += \"\\r\\n#L\" + i + \"##t\" + items[i] + \"##b\";\n         }else if (selection == 1) { //face accessory\n@@ -103,9 +109,9 @@ function action(mode, type, selection) {\n         if (selectedType != 3) selectedItem = selection;\n         \n         if (selectedType == 0) { //pendant refine\n-            var matSet = [[4003004, 4030012, 4001356, 4000026], [4000026, 4001356, 4000073, 4001006], [4001344, 4003001, 4003004, 4003005], [4001344, 4003001, 4003004, 4003005], [4001344, 4003001, 4003004, 4003005], [4001344, 4003001, 4003004, 4003005], [4001344, 4003001, 4003004, 4003005], [4001344, 4003001, 4003004, 4003005], [1122007, 4003002, 4000413]];\n-            var matQtySet = [[20, 20, 5, 1], [5, 5, 10, 1], [10, 4, 20, 4], [20, 8, 20, 8], [10, 4, 20, 4], [15, 6, 30, 6], [20, 8, 40, 8], [15, 6, 30, 6], [1, 1, 1]];\n-            var costSet = [150000, 500000, 200000, 400000, 200000, 300000, 400000, 300000, 2500000];\n+            var matSet = [[4003004, 4030012, 4001356, 4000026], [4000026, 4001356, 4000073, 4001006], [4001343, 4011002, 4003004, 4003005], [4001343, 4011006, 4003004, 4003005], [4000091, 4011005, 4003004, 4003005], [4000091, 4011001, 4003004, 4003005], [4000469, 4011000, 4003004, 4003005], [4000469, 4011004, 4003004, 4003005], [1122007, 4003002, 4000413]];\n+            var matQtySet = [[20, 20, 5, 1], [5, 5, 10, 1], [10, 2, 20, 4], [10, 1, 20, 4], [15, 3, 30, 6], [15, 3, 30, 6], [20, 5, 20, 8], [20, 4, 40, 8], [1, 1, 1]];\n+            var costSet = [150000, 500000, 200000, 200000, 300000, 300000, 400000, 400000, 2500000];\n         }else if (selectedType == 1) { //face accessory refine\n             var matSet = [[4006000, 4003004],[4006000, 4003004,4000026],[4006000, 4003004,4000026,4000082,4003002],[4006000, 4003005],[4006000, 4003005,4000026],[4006000, 4003005,4000026,4000082,4003002],[4001006, 4011008],[4001006, 4011008],[4001006, 4011008],[4001006, 4011008]];\n             var matQtySet = [[5,5],[5,5,5],[5,5,5,5,1],[5,5],[5,5,5],[5,5,5,5,1],[1,1],[1,1],[1,1],[1,1]];\n@@ -145,9 +151,9 @@ function action(mode, type, selection) {\n         var prompt = \"You want me to make \";\n         if(selectedType != 3) {\n             if (qty == 1)\n-                prompt += \"a #t\" + item + \"#?\";\n+                prompt += \"a #b#t\" + item + \"##k?\";\n             else\n-                prompt += qty + \" #t\" + item + \"#?\";\n+                prompt += \"#b\" + qty + \" #t\" + item + \"##k?\";\n         }\n         else prompt += \"a #bbelt#k or a #bmedal#k?\";\n         "}, {"sha": "004ba79aab43dd9884f7c3fc0d8b62ca9b0f23e6", "filename": "scripts/npc/9000040.js", "status": "modified", "additions": 59, "deletions": 18, "changes": 77, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000040.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000040.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000040.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -19,31 +19,72 @@\n */\n /* Dalair\n \tMedal NPC.\n+\n+        NPC Equipment Merger:\n+        * @author Ronan Lana\n  */\n \n+importPackage(Packages.client.processor);\n+importPackage(Packages.constants);\n+\n var status;\n- \n+var mergeFee = 50000;\n+var name;\n+\n function start() {\n-        status = -1;\n-        action(1, 0, 0);\n+    status = -1;\n+    action(1, 0, 0);\n }\n \n function action(mode, type, selection) {\n-        if (mode == -1) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && type > 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+\n+        if(status == 0) {\n+            if (!Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                cm.sendOk(\"The medal ranking system is currently unavailable...\");\n+                cm.dispose();\n+                return;\n+            }\n+            \n+            var levelLimit = !cm.getPlayer().isCygnus() ? 160 : 110;\n+            var selStr = \"The medal ranking system is currently unavailable... Therefore, I am providing the #bEquipment Merge#k service! \";\n+            \n+            if (!ServerConstants.USE_STARTER_MERGE && (cm.getPlayer().getLevel() < levelLimit || MakerProcessor.getMakerSkillLevel(cm.getPlayer()) < 3)) {\n+                selStr += \"However, you must have #rMaker level 3#k and at least #rlevel 110#k (Cygnus Knight), #rlevel 160#k (other classes) and a fund of #r\" + cm.numberWithCommas(mergeFee) + \" mesos#k to use the service.\";\n+                cm.sendOk(selStr);\n+                cm.dispose();\n+            } else if (cm.getMeso() < mergeFee) {\n+                selStr += \"I'm sorry, but this service tax is of #r\" + cm.numberWithCommas(mergeFee) + \" mesos#k, which it seems you unfortunately don't have right now... Please, stop by again later.\";\n+                cm.sendOk(selStr);\n                 cm.dispose();\n-        } else {\n-                if (mode == 0 && type > 0) {\n-                        cm.dispose();\n-                        return;\n-                }\n-                if (mode == 1)\n-                        status++;\n-                else\n-                        status--;\n-    \n-                if(status == 0) {\n-                        cm.sendOk(\"The medal ranking system is currently unavailable.\");\n-                        cm.dispose();\n-                }\n+            } else {\n+                selStr += \"For the fee of #r\" + cm.numberWithCommas(mergeFee) + \"#k mesos, merge unnecessary equipments in your inventory into your currently equipped gears to get stat boosts into them, statups based on the attributes of the items used on the merge!\";\n+                cm.sendNext(selStr);\n+            }\n+        } else if(status == 1) {\n+            selStr = \"#rWARNING#b: Make sure you have your items ready to merge at the slots #rAFTER#b the item you have selected to merge.#k Any items #bunder#k the item selected will be merged thoroughly.\\r\\n\\r\\nNote that equipments receiving bonuses from merge are going to become #rUntradeable#k thereon, and equipments that already received the merge bonus #rcannot be used for merge#k.\\r\\n\\r\\n\";\n+            cm.sendGetText(selStr);\n+        } else if(status == 2) {\n+            name = cm.getText();\n+            \n+            if (cm.getPlayer().mergeAllItemsFromName(name)) {\n+                cm.gainMeso(-mergeFee);\n+                cm.sendOk(\"Merging complete! Thanks for using the service and enjoy your new equipment stats.\");\n+            } else {\n+                cm.sendOk(\"There is no #b'\" + name + \"'#k in your #bEQUIP#k inventory!\");\n+            }\n+            \n+            cm.dispose();\n         }\n+    }\n }"}, {"sha": "1d2cc250ef9765f1df436515721695d713c32be7", "filename": "scripts/npc/9000041.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000041.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9000041.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000041.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -42,6 +42,12 @@ function action(mode, type, selection) {\n     }\n \n     if (status == 0) {\n+        if (!Packages.constants.ServerConstants.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+            cm.sendOk(\"The medal ranking system is currently unavailable...\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n         var selStr = \"Hello, I am the #bBazaar NPC#k! Sell to me any item on your inventory you don't need. #rWARNING#b: Make sure you have your items ready to sell at the slots #rAFTER#b the item you have selected to sell.#k Any items #bunder#k the item selected will be sold thoroughly.\";\n         for (var i = 0; i < options.length; i++)\n             selStr += \"\\r\\n#L\" + i + \"# \" + options[i] + \"#l\";"}, {"sha": "2a8686d764de4e4d3e0529986b61a24d278f5099", "filename": "scripts/npc/9201056.js", "status": "modified", "additions": 4, "deletions": 13, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9201056.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9201056.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201056.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -20,7 +20,6 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n var status = 0;\n-var goToMansion = false;\n var fee = 15000;\n \n function start() {\n@@ -37,19 +36,11 @@ function action(mode, type, selection) {\n     else {\n         status++;\n         if (cm.getPlayer().getMapId() == 682000000) {\n-            if (status == 0)\n-                cm.sendSimple(\"Where to, boss? \\r\\n#b#L0#New Leaf City (\" + fee + \" mesos)#l\\r\\n#L1#Haunted Mansion#l#k\");\n-            else if (status == 1) {\n+            if (status == 0) {\n                 if (selection == 0)\n-                    cm.sendYesNo(\"You want to go to New Leaf City?\");\n-                else {\n-                    goToMansion = true;\n-                    cm.sendYesNo(\"You're sure you want to enter the Mansion?\");\n-                }\n-            } else if (status == 2) {\n-                if(goToMansion) {\n-                    cm.warp(682000100, 0);\n-                } else if(cm.getMeso() >= fee) {\n+                    cm.sendYesNo(\"Would you like to return back to #bcivilization#k? The fee is \" + fee + \" mesos.\");\n+            } else if (status == 1) {\n+                if(cm.getMeso() >= fee) {\n                     cm.gainMeso(-fee);\n                     cm.warp(600000000);\n                 } else {"}, {"sha": "691effb7e7b4373c4e2f500eefc1483eda224fc8", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -98,6 +98,7 @@ function writeFeatureTab_CashItems() {\n         addFeature(\"Storage with 'Arrange Items' feature functional.\");\n         addFeature(\"Close-quarters evaluation mode for items.\");\n         addFeature(\"Reviewed Karma scissors & Untradeable items.\");\n+        addFeature(\"Reviewed an pet position issue within CASH inventory.\");\n         addFeature(\"Scroll for Spikes on Shoes.\");\n         addFeature(\"Scroll for Cold Protection.\");\n         addFeature(\"Vega's spell.\");\n@@ -187,6 +188,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Delete Character.\");\n         addFeature(\"Smooth view-all-char, now showing all account chars.\");\n         addFeature(\"Centralized servertime, boosting handler performance.\");\n+        addFeature(\"Centralized timestamping, unused rcvd timestamps.\");\n         addFeature(\"Autosaver (periodically saves player's data on DB).\");\n         addFeature(\"Fixed and randomized HP/MP growth rate available.\");\n         addFeature(\"Players' MaxHP/MaxMP method accounting equip gain.\");\n@@ -211,6 +213,7 @@ function writeFeatureTab_CustomNPCs() {\n         addFeature(\"Asia: scroll & rarities shop NPC.\");\n         addFeature(\"Abdula: lists droppers of needed skill/mastery books.\");\n         addFeature(\"Agent E: accessory crafter.\");\n+        addFeature(\"Dalair: automatized equipment-merger.\");\n         addFeature(\"Donation Box: automatized item-buyer.\");\n         addFeature(\"Coco & Ace of Hearts: C. scroll crafters.\");\n }\n@@ -240,6 +243,7 @@ function writeFeatureTab_Project() {\n         addFeature(\"Protected many flaws with login management system.\");\n         addFeature(\"Developed a robust anti-exploit login coordinator.\");\n         addFeature(\"Usage of HikariCP to improve DB connection calls.\");\n+        addFeature(\"Usage of Java Threadpool to improve runnable calls.\");\n         addFeature(\"Developed many survey tools for content profiling.\");\n         addFeature(\"ThreadTracker: runtime tool for deadlock detection.\");\n         addFeature(\"Channel, World and Server-wide timer management.\");"}, {"sha": "d7a5ddcab8aa3332bc75dd1578690f49b2977307", "filename": "scripts/portal/enterDisguise1.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterDisguise1.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,7 +33,7 @@ function enter(pi) {\n                 }\n                 \n                 if(pi.haveItem(4032101 + jobtype, 1)) {\n-                        pi.message(\"You have already challenged the Master of Disguise, report your success to Neinheart.\");\n+                        pi.message(\"You have already challenged the Master of Disguise, report your success to the Chief Knight.\");\n                         return false;\n                 }\n                 "}, {"sha": "b242657cfc111ec50c8143500d1890ed7cb70a73", "filename": "scripts/portal/enterDisguise2.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterDisguise2.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,7 +33,7 @@ function enter(pi) {\n                 }\n                 \n                 if(pi.haveItem(4032101 + jobtype, 1)) {\n-                        pi.message(\"You have already challenged the Master of Disguise, report your success to Neinheart.\");\n+                        pi.message(\"You have already challenged the Master of Disguise, report your success to the Chief Knight.\");\n                         return false;\n                 }\n                 "}, {"sha": "cf0b2c64a6bb269c28c9e22a8b50ca4963511059", "filename": "scripts/portal/enterDisguise3.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise3.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise3.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterDisguise3.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,7 +33,7 @@ function enter(pi) {\n                 }\n                 \n                 if(pi.haveItem(4032101 + jobtype, 1)) {\n-                        pi.message(\"You have already challenged the Master of Disguise, report your success to Neinheart.\");\n+                        pi.message(\"You have already challenged the Master of Disguise, report your success to the Chief Knight.\");\n                         return false;\n                 }\n                 "}, {"sha": "929887d8519931a92227560338b457d8b5d39c11", "filename": "scripts/portal/enterDisguise4.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterDisguise4.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,7 +33,7 @@ function enter(pi) {\n                 }\n                 \n                 if(pi.haveItem(4032101 + jobtype, 1)) {\n-                        pi.message(\"You have already challenged the Master of Disguise, report your success to Neinheart.\");\n+                        pi.message(\"You have already challenged the Master of Disguise, report your success to the Chief Knight.\");\n                         return false;\n                 }\n                 "}, {"sha": "ddc080000a96c1f4b2d3d6fc026f131f7bf3ed07", "filename": "scripts/portal/enterDisguise5.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise5.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/enterDisguise5.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterDisguise5.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,7 +33,7 @@ function enter(pi) {\n                 }\n                 \n                 if(pi.haveItem(4032101 + jobtype, 1)) {\n-                        pi.message(\"You have already challenged the Master of Disguise, report your success to Neinheart.\");\n+                        pi.message(\"You have already challenged the Master of Disguise, report your success to the Chief Knight.\");\n                         return false;\n                 }\n                 "}, {"sha": "b24830505bbbce83bd438f6e4d88a583247f2ab6", "filename": "scripts/portal/s4ship_out.js", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/s4ship_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/s4ship_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/s4ship_out.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,32 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+function enter(pi) {\n+    var exit = pi.getEventInstance().getIntProperty(\"canLeave\");\n+    if (exit == 0) {\n+        pi.message(\"You have to wait one minute before you can leave this place.\");\n+        return false;\n+    } else if (exit == 2) {\n+        pi.warp(912010200);\n+        return true;\n+    } else {\n+        pi.warp(120000101);\n+        return true;\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "b24830505bbbce83bd438f6e4d88a583247f2ab6", "filename": "scripts/portal/s4super_out.js", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/s4super_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/portal/s4super_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/s4super_out.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,32 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+function enter(pi) {\n+    var exit = pi.getEventInstance().getIntProperty(\"canLeave\");\n+    if (exit == 0) {\n+        pi.message(\"You have to wait one minute before you can leave this place.\");\n+        return false;\n+    } else if (exit == 2) {\n+        pi.warp(912010200);\n+        return true;\n+    } else {\n+        pi.warp(120000101);\n+        return true;\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "74815877db82c22e8d4673af317aea49d530001a", "filename": "scripts/quest/21101.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21101.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21101.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21101.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -20,6 +20,7 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n importPackage(Packages.client);\n+importPackage(Packages.constants);\n \n status = -1;\n \n@@ -47,8 +48,10 @@ function start(mode, type, selection) {\n             qm.changeJobById(2100);\n             qm.resetStats();\n             \n-            //qm.teachSkill(21000000, 0, 10, -1);   //learned later...\n-            //qm.teachSkill(21001003, 0, 20, -1);   //learned later...\n+            if (ServerConstants.USE_FULL_ARAN_SKILLSET) {\n+                qm.teachSkill(21000000, 0, 10, -1);   //combo ability\n+                qm.teachSkill(21001003, 0, 20, -1);   //polearm booster\n+            }\n             \n             qm.completeQuest();\n "}, {"sha": "da8713a1cd38e3f901c38233a7a1afa017e7b1b6", "filename": "scripts/quest/21201.js", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21201.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -20,6 +20,7 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n importPackage(Packages.client);\n+importPackage(Packages.constants);\n \n var status = -1;\n \n@@ -65,6 +66,13 @@ function end(mode, type, selection) {\n \n                 qm.gainItem(1142130, true);\n                 qm.changeJobById(2110);\n+                \n+                if (ServerConstants.USE_FULL_ARAN_SKILLSET) {\n+                    qm.teachSkill(21100000, 0, 20, -1);   //polearm mastery\n+                    qm.teachSkill(21100002, 0, 30, -1);   //final charge\n+                    qm.teachSkill(21100004, 0, 20, -1);   //combo smash\n+                    qm.teachSkill(21100005, 0, 20, -1);   //combo drain\n+                }\n \n                 qm.completeQuest();\n             }"}, {"sha": "0d3e60695cdb768deae785f056f602e3aa333509", "filename": "scripts/quest/21302.js", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21302.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/21302.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21302.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -20,6 +20,7 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n importPackage(Packages.client);\n+importPackage(Packages.constants);\n \n var status = -1;\n \n@@ -49,6 +50,10 @@ function end(mode, type, selection) {\n             \n             qm.gainItem(1142131, true);\n             qm.changeJobById(2111);\n+            \n+            if (ServerConstants.USE_FULL_ARAN_SKILLSET) {\n+                qm.teachSkill(21110002, 0, 20, -1);   //full swing\n+            }\n \n             qm.completeQuest();\n         }"}, {"sha": "4e89e74cca2b9fab359c3b1fc77ff069ee514af0", "filename": "scripts/quest/3239.js", "status": "modified", "additions": 38, "deletions": 23, "changes": 61, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/3239.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/3239.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3239.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1,30 +1,45 @@\n-importPackage(Packages.tools);\n+var status = -1;\n \n function end(mode, type, selection) {\n-    var rnd;\n-\n-    if (mode != 1) {\n+    if (mode == -1) {\n         qm.dispose();\n     } else {\n-\tif(qm.haveItem(4031092, 10)) {\n-\t\tif(qm.canHold(4031092)) {\n-\t\t\tqm.sendOk(\"Well done! You brought back all the #t4031092# that were missing. Here, get this scroll as a token of my gratitude...\");\n-\t\t\tqm.gainItem(4031092, -10);\n-\n-\t\t\trnd = Math.floor(Math.random() * 4);\n-\t\t\tif(rnd == 0) qm.gainItem(2040704, 1);\n-\t\t\telse if(rnd == 1) qm.gainItem(2040705, 1);\n-\t\t\telse if(rnd == 2) qm.gainItem(2040707, 1);\n-\t\t\telse qm.gainItem(2040708, 1);\n-\n-\t\t\tqm.gainExp(2700);\n-\t\t\tqm.forceCompleteQuest();\n+        if(mode == 0 && type > 0) {\n+            qm.dispose();\n+            return;\n+        }\n+        \n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+        \n+        if (status == 0) {\n+            if(qm.haveItem(4031092, 10)) {\n+\t\tif(qm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.USE).getNumFreeSlot() >= 1) {\n+                    qm.sendOk(\"Well done! You brought back all the #t4031092# that were missing. Here, take this scroll as a token of my gratitude...\");\n+\t\t} else {\n+                    qm.sendOk(\"Free a space on your USE inventory before receiving your prize.\");\n+                    qm.dispose();\n+                    return;\n \t\t}\n-\t\telse {\n-\t\t\tqm.sendOk(\"Free a space on your USE inventory before receiving your prize.\");\n-\t\t}\n-\t}\n-\t\n-        qm.dispose();\n+            } else {\n+                qm.sendOk(\"Please return me 10 #t4031092# that went missing on this room.\");\n+                qm.dispose();\n+                return;\n+            }\n+        } else if (status == 1) {\n+            qm.gainItem(4031092, -10);\n+            \n+            rnd = Math.floor(Math.random() * 4);\n+            if(rnd == 0) qm.gainItem(2040704, 1);\n+            else if(rnd == 1) qm.gainItem(2040705, 1);\n+            else if(rnd == 2) qm.gainItem(2040707, 1);\n+            else qm.gainItem(2040708, 1);\n+\n+            qm.gainExp(2700);\n+            qm.forceCompleteQuest();\n+            qm.dispose();\n+        }\n     }\n }\n\\ No newline at end of file"}, {"sha": "b9f4cfaa979884e08fe4bace893762f591e920d9", "filename": "scripts/quest/6030.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/6030.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/scripts/quest/6030.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/6030.js?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -49,7 +49,7 @@ function end(mode, type, selection) {\n             qm.sendNextPrev(\"And remember this: the maxima of #bExchange#k, the area of the fundamentals of Alchemy where the total amount of the material does not change, is that no item can be created from nothing. Understood?\");\n         } else if (status == 5) {\n             qm.gainMeso(-10000);\n-\n+            \n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "804a38728486a06204fc4fcb746db9879d3e1d3f", "filename": "sql/db_drops.sql", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -19295,7 +19295,7 @@ USE `heavenms`;\n (4230116, 2382042, 1, 1, 0, 10000),\n (4230117, 2382055, 1, 1, 0, 10000),\n (4230118, 2382067, 1, 1, 0, 10000),\n-(4240000, 2383011, 1, 1, 0, 10000),\n+(4240000, 2383011, 1, 1, 0, 20000),\n (1210102, 4001354, 1, 1, 28209, 80000),\n (1110101, 4031773, 1, 1, 2145, 80000),\n (1130100, 4031773, 1, 1, 2145, 80000),\n@@ -20292,7 +20292,15 @@ USE `heavenms`;\n (9400110, 4000092, 1, 1, 0, 400000),\n (9400111, 4000093, 1, 1, 0, 400000),\n (3210201, 4031524, 1, 1, 8848, 200000),\n-(3110101, 4031527, 1, 1, 8849, 400000);\n+(3110101, 4031527, 1, 1, 8849, 400000),\n+(5100000, 2022001, 1, 1, 0, 20000),\n+(5100001, 2022001, 1, 1, 0, 20000),\n+(5130105, 2022001, 1, 1, 0, 20000),\n+(5130106, 2022001, 1, 1, 0, 20000),\n+(6130102, 2022001, 1, 1, 0, 20000),\n+(6130103, 2022001, 1, 1, 0, 20000),\n+(6130200, 2022001, 1, 1, 0, 20000),\n+(6130201, 2022001, 1, 1, 0, 20000);\n \n # (dropperid, itemid, minqty, maxqty, questid, chance)\n \n@@ -20478,7 +20486,8 @@ USE `heavenms`;\n (8142100, 2040205, 1, 1, 0, 750),\n (9400580, 2048010, 1, 1, 0, 750),\n (5110302, 2048010, 1, 1, 0, 750),\n-(4230118, 4240000, 1, 1, 0, 750),\n+(4230118, 2048011, 1, 1, 0, 750),\n+(4240000, 2048011, 1, 1, 0, 750),\n (6400100, 2048011, 1, 1, 0, 750),\n (5130107, 2048012, 1, 1, 0, 750),\n (6230601, 2048012, 1, 1, 0, 750),"}, {"sha": "5f1f93ab9dae555ef2ff7a6b89258048e4333d1f", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 300, "deletions": 102, "changes": 402, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -72,6 +72,7 @@\n import server.MapleStorage;\n import server.MapleTrade;\n import server.TimerManager;\n+import server.ThreadManager;\n import server.events.MapleEvents;\n import server.events.RescueGaga;\n import server.events.gm.MapleFitness;\n@@ -109,6 +110,7 @@\n import client.autoban.AutobanManager;\n import client.creator.CharacterFactoryRecipe;\n import client.inventory.Equip;\n+import client.inventory.Equip.StatUpgrade;\n import client.inventory.Item;\n import client.inventory.ItemFactory;\n import client.inventory.MapleInventory;\n@@ -159,12 +161,10 @@\n import server.maps.MapleMapItem;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n-import server.movement.AbsoluteLifeMovement;\n-import server.movement.LifeMovementFragment;\n \n public class MapleCharacter extends AbstractMapleCharacterObject {\n     private static final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-    private static final String LEVEL_200 = \"[Congrats] %s has reached Level 200! Congratulate %s on such an amazing achievement!\";\n+    private static final String LEVEL_200 = \"[Congrats] %s has reached Level %d! Congratulate %s on such an amazing achievement!\";\n     private static final String[] BLOCKED_NAMES = {\"admin\", \"owner\", \"moderator\", \"intern\", \"donor\", \"administrator\", \"help\", \"helper\", \"alert\", \"notice\", \"maplestory\", \"fuck\", \"wizet\", \"fucking\", \"negro\", \"fuk\", \"fuc\", \"penis\", \"pussy\", \"asshole\", \"gay\",\n         \"nigger\", \"homo\", \"suck\", \"cum\", \"shit\", \"shitty\", \"condom\", \"security\", \"official\", \"rape\", \"nigga\", \"sex\", \"tit\", \"boner\", \"orgy\", \"clit\", \"asshole\", \"fatass\", \"bitch\", \"support\", \"gamemaster\", \"cock\", \"gaay\", \"gm\",\n         \"operate\", \"master\", \"sysop\", \"party\", \"GameMaster\", \"community\", \"message\", \"event\", \"test\", \"meso\", \"Scania\", \"yata\", \"AsiaSoft\", \"henesys\"};\n@@ -853,10 +853,15 @@ public void Hide(boolean hide, boolean login) {\n                 List<Pair<MapleBuffStat, Integer>> ldsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n                 getMap().broadcastGMMessage(this, MaplePacketCreator.giveForeignBuff(id, ldsstat), false);\n                 for (MapleMonster mon : this.getControlledMonsters()) {\n-                    mon.setController(null);\n-                    mon.setControllerHasAggro(false);\n-                    mon.setControllerKnowsAboutAggro(false);\n-                    mon.getMap().updateMonsterController(mon);\n+                    mon.lockMonster();\n+                    try {\n+                        mon.setController(null);\n+                        mon.setControllerHasAggro(false);\n+                        mon.setControllerKnowsAboutAggro(false);\n+                        mon.getMap().updateMonsterController(mon);\n+                    } finally {\n+                        mon.unlockMonster();\n+                    }\n                 }\n             }\n             announce(MaplePacketCreator.enableActions());\n@@ -1178,11 +1183,7 @@ public void broadcastStance(int newStance) {\n     }\n     \n     public void broadcastStance() {\n-        AbsoluteLifeMovement alm = new AbsoluteLifeMovement(0, getPosition(), 0, getStance());\n-        alm.setPixelsPerSecond(new Point(0, 0));\n-        List<LifeMovementFragment> moveUpdate = Collections.singletonList((LifeMovementFragment) alm);\n-        \n-        map.broadcastMessage(this, MaplePacketCreator.movePlayer(id, moveUpdate), false);\n+        map.broadcastMessage(this, MaplePacketCreator.movePlayer(id, this.getIdleMovement()), false);\n     }\n     \n     public MapleMap getWarpMap(int map) {\n@@ -1592,11 +1593,11 @@ private void changeMapInternal(final MapleMap to, final Point pos, final byte[]\n             map.addPlayer(this);\n             visitMap(map);\n             \n+            silentPartyUpdateInternal(getParty());  // EIM script calls inside\n             prtLock.lock();\n             try {\n                 if (party != null) {\n                     mpc.setMapId(to.getId());\n-                    silentPartyUpdateInternal();\n                     client.announce(MaplePacketCreator.updateParty(client.getChannel(), party, PartyOperation.SILENT_UPDATE, null));\n                     updatePartyMemberHPInternal();\n                 }\n@@ -1605,8 +1606,7 @@ private void changeMapInternal(final MapleMap to, final Point pos, final byte[]\n             }\n             \n             if (getMap().getHPDec() > 0) resetHpDecreaseTask();\n-        }\n-        else {\n+        } else {\n             FilePrinter.printError(FilePrinter.MAPLE_MAP, \"Character \" + this.getName() + \" got stuck when moving to map \" + map.getId() + \".\");\n         }\n         \n@@ -1708,19 +1708,29 @@ public void checkMessenger() {\n     }\n \n     public void checkMonsterAggro(MapleMonster monster) {\n-        if (!monster.isControllerHasAggro()) {\n-            if (monster.getController() == this) {\n-                monster.setControllerHasAggro(true);\n-            } else {\n-                monster.switchController(this, true);\n+        monster.lockMonster();\n+        try {\n+            if (!monster.isControllerHasAggro()) {\n+                if (monster.getController() == this) {\n+                    monster.setControllerHasAggro(true);\n+                } else {\n+                    monster.switchController(this, true);\n+                }\n             }\n+        } finally {\n+            monster.unlockMonster();\n         }\n     }\n \n     public void controlMonster(MapleMonster monster, boolean aggro) {\n-        monster.setController(this);\n-        controlled.add(monster);\n-        client.announce(MaplePacketCreator.controlMonster(monster, false, aggro));\n+        monster.lockMonster();\n+        try {\n+            monster.setController(this);\n+            controlled.add(monster);\n+            client.announce(MaplePacketCreator.controlMonster(monster, false, aggro));\n+        } finally {\n+            monster.unlockMonster();\n+        }\n     }\n     \n     private boolean useItem(final int id) {\n@@ -1768,7 +1778,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n \t\t\n         if (ob instanceof MapleMapItem) {\n             MapleMapItem mapitem = (MapleMapItem) ob;\n-            if (System.currentTimeMillis() - mapitem.getDropTime() < 900 || !mapitem.canBePickedBy(this)) {\n+            if (System.currentTimeMillis() - mapitem.getDropTime() < 400 || !mapitem.canBePickedBy(this)) {\n                 client.announce(MaplePacketCreator.enableActions());\n                 return;\n             }\n@@ -1778,6 +1788,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                 mpcs = getPartyMembersOnSameMap();\n             }\n             \n+            String itemScriptName = null;\n             mapitem.lockItem();\n             try {\n                 if (mapitem.isPickedUp()) {\n@@ -1852,12 +1863,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                     } else if (mItem.getItemId() / 10000 == 243) {\n                         MapleItemInformationProvider.scriptedItem info = ii.getScriptedItemInfo(mItem.getItemId());\n                         if (info.runOnPickup()) {\n-                            ItemScriptManager ism = ItemScriptManager.getInstance();\n-                            String scriptName = info.getScript();\n-                            if (ism.scriptExists(scriptName)) {\n-                                ism.getItemScript(client, scriptName);\n-                            }\n-\n+                            itemScriptName = info.getScript();\n                         } else {\n                             if (!MapleInventoryManipulator.addFromDrop(client, mItem, true)) {\n                                 client.announce(MaplePacketCreator.enableActions());\n@@ -1890,6 +1896,13 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n             } finally {\n                 mapitem.unlockItem();\n             }\n+            \n+            if (itemScriptName != null) {\n+                ItemScriptManager ism = ItemScriptManager.getInstance();\n+                if (ism.scriptExists(itemScriptName)) {\n+                    ism.runItemScript(client, itemScriptName);\n+                }\n+            }\n         }\n         client.announce(MaplePacketCreator.enableActions());\n     }\n@@ -2913,26 +2926,32 @@ private void gainExpInternal(long gain, int equip, int party, boolean show, bool\n         }\n     }\n \n-    private synchronized int applyFame(int delta) {\n-        int newFame = fame + delta;\n-        if (newFame < -30000) {\n-            delta = -(30000 + fame);\n-        } else if (newFame > 30000) {\n-            delta = 30000 - fame;\n+    private Pair<Integer, Integer> applyFame(int delta) {\n+        petLock.lock();\n+        try {\n+            int newFame = fame + delta;\n+            if (newFame < -30000) {\n+                delta = -(30000 + fame);\n+            } else if (newFame > 30000) {\n+                delta = 30000 - fame;\n+            }\n+\n+            fame += delta;\n+            return new Pair<>(fame, delta);\n+        } finally {\n+            petLock.unlock();\n         }\n-        \n-        fame += delta;\n-        return delta;\n     }\n     \n     public void gainFame(int delta) {\n         gainFame(delta, null, 0);\n     }\n     \n     public boolean gainFame(int delta, MapleCharacter fromPlayer, int mode) {\n-        delta = applyFame(delta);\n+        Pair<Integer, Integer> fameRes = applyFame(delta);\n+        delta = fameRes.getRight();\n         if (delta != 0) {\n-            int thisFame = fame;\n+            int thisFame = fameRes.getLeft();\n             updateSingleStat(MapleStat.FAME, thisFame);\n             \n             if (fromPlayer != null) {\n@@ -3571,10 +3590,10 @@ private boolean cancelEffect(MapleStatEffect effect, boolean overwrite, long sta\n                 for (MapleCharacter chr : townChars) {\n                     destroyDoor.getTownDoor().sendDestroyData(chr.getClient());\n                 }\n-                if(destroyDoor.getTownPortal().getId() == 0x80) {\n+                if (destroyDoor.getTownPortal().getId() == 0x80) {\n                     for (MapleCharacter chr : townChars) {\n                         MapleDoor door = chr.getMainTownDoor();\n-                        if(door != null) {\n+                        if (door != null) {\n                             destroyDoor.getTownDoor().sendSpawnData(chr.getClient());\n                         }\n                     }\n@@ -4180,29 +4199,33 @@ public MapleDoor getMainTownDoor() {\n     }\n     \n     public void applyPartyDoor(MapleDoor door, boolean partyUpdate) {\n+        MapleParty chrParty;\n         prtLock.lock();\n         try {\n             if (!partyUpdate) {\n                 pdoor = door;\n             }\n             \n-            if (party != null) {\n-                party.addDoor(id, door);\n-                silentPartyUpdateInternal();\n+            chrParty = getParty();\n+            if (chrParty != null) {\n+                chrParty.addDoor(id, door);\n             }\n         } finally {\n             prtLock.unlock();\n         }\n+        \n+        silentPartyUpdateInternal(chrParty);\n     }\n     \n     private MapleDoor removePartyDoor(boolean partyUpdate) {\n         MapleDoor ret = null;\n+        MapleParty chrParty;\n         \n         prtLock.lock();\n         try {\n-            if (party != null) {\n-                party.removeDoor(id);\n-                silentPartyUpdateInternal();\n+            chrParty = getParty();\n+            if (chrParty != null) {\n+                chrParty.removeDoor(id);\n             }\n             \n             if (!partyUpdate) {\n@@ -4213,6 +4236,7 @@ private MapleDoor removePartyDoor(boolean partyUpdate) {\n             prtLock.unlock();\n         }\n         \n+        silentPartyUpdateInternal(chrParty);\n         return ret;\n     }\n     \n@@ -5796,18 +5820,16 @@ public synchronized void levelUp(boolean takeexp) {\n             if (level == maxClassLevel) {\n                 if (!this.isGM()) {\n                     if (ServerConstants.PLAYERNPC_AUTODEPLOY) {\n-                        Thread t = new Thread(new Runnable() {\n+                        ThreadManager.getInstance().newTask(new Runnable() {\n                             @Override\n                             public void run() {\n                                 MaplePlayerNPC.spawnPlayerNPC(GameConstants.getHallOfFameMapid(job), MapleCharacter.this);\n                             }\n                         });\n-\n-                        t.start();\n                     }\n \n                     final String names = (getMedalText() + name);\n-                    getWorldServer().broadcastPacket(MaplePacketCreator.serverNotice(6, String.format(LEVEL_200, names, names)));\n+                    getWorldServer().broadcastPacket(MaplePacketCreator.serverNotice(6, String.format(LEVEL_200, names, maxClassLevel, names)));\n                 }\n             }\n \n@@ -5874,22 +5896,27 @@ public void run() {\n             Runnable r = new Runnable() {\n                 @Override\n                 public void run() {\n+                    MapleParty party;\n+                    boolean partyLeader;\n+                    \n                     prtLock.lock();\n                     try {\n-                        if (party != null) {\n-                            if(isPartyLeader()) party.assignNewLeader(client);\n-                            PartyOperationHandler.leaveParty(party, mpc, client);\n-\n-                            showHint(\"You have reached #blevel 10#k, therefore you must leave your #rstarter party#k.\");\n-                        }\n+                        party = getParty();\n+                        partyLeader = party != null && isPartyLeader();\n                     } finally {\n                         prtLock.unlock();\n                     }\n+                    \n+                    if (party != null) {\n+                        if(partyLeader) party.assignNewLeader(client);\n+                        PartyOperationHandler.leaveParty(party, mpc, client);\n+\n+                        showHint(\"You have reached #blevel 10#k, therefore you must leave your #rstarter party#k.\");\n+                    }\n                 }\n             };\n \n-            Thread t = new Thread(r);\n-            t.start();\n+            ThreadManager.getInstance().newTask(r);\n         }\n \n         levelUpMessages();\n@@ -7567,8 +7594,7 @@ public void run() {\n                 }\n             };\n             \n-            Thread t = new Thread(r);  //spawns a new thread to deal with this\n-            t.start();\n+            ThreadManager.getInstance().newTask(r);  //spawns a new thread to deal with this\n         } else {\n             saveCharToDB(true);\n         }\n@@ -8439,23 +8465,34 @@ public boolean gainSlots(int type, int slots, boolean update) {\n     \n     public int sellAllItemsFromName(byte invTypeId, String name) {\n         //player decides from which inventory items should be sold.\n-        \n         MapleInventoryType type = MapleInventoryType.getByType(invTypeId);\n         \n-        Item it = getInventory(type).findByName(name);\n-        if(it == null) {\n-            return(-1);\n+        MapleInventory inv = getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            Item it = inv.findByName(name);\n+            if(it == null) {\n+                return(-1);\n+            }\n+\n+            return(sellAllItemsFromPosition(ii, type, it.getPosition()));\n+        } finally {\n+            inv.unlockInventory();\n         }\n-        \n-        return(sellAllItemsFromPosition(ii, type, it.getPosition()));\n     }\n     \n     public int sellAllItemsFromPosition(MapleItemInformationProvider ii, MapleInventoryType type, short pos) {\n         int mesoGain = 0;\n         \n-        for(short i = pos; i <= getInventory(type).getSlotLimit(); i++) {\n-            if(getInventory(type).getItem(i) == null) continue;\n-            mesoGain += standaloneSell(getClient(), ii, type, i, getInventory(type).getItem(i).getQuantity());\n+        MapleInventory inv = getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            for(short i = pos; i <= inv.getSlotLimit(); i++) {\n+                if(inv.getItem(i) == null) continue;\n+                mesoGain += standaloneSell(getClient(), ii, type, i, inv.getItem(i).getQuantity());\n+            }\n+        } finally {\n+            inv.unlockInventory();\n         }\n         \n         return(mesoGain);\n@@ -8465,36 +8502,199 @@ private int standaloneSell(MapleClient c, MapleItemInformationProvider ii, Maple\n         if (quantity == 0xFFFF || quantity == 0) {\n             quantity = 1;\n         }\n-        Item item = getInventory(type).getItem((short) slot);\n-        if (item == null){ //Basic check\n+        \n+        MapleInventory inv = getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            Item item = inv.getItem((short) slot);\n+            if (item == null){ //Basic check\n+                return(0);\n+            }\n+\n+            int itemid = item.getItemId();\n+            if (ItemConstants.isRechargeable(itemid)) {\n+                quantity = item.getQuantity();\n+            } else if (ItemConstants.isWeddingToken(itemid) || ItemConstants.isWeddingRing(itemid)) {\n+                return(0);\n+            }\n+\n+            if (quantity < 0) {\n+                return(0);\n+            }\n+            short iQuant = item.getQuantity();\n+            if (iQuant == 0xFFFF) {\n+                iQuant = 1;\n+            }\n+\n+            if (quantity <= iQuant && iQuant > 0) {\n+                MapleInventoryManipulator.removeFromSlot(c, type, (byte) slot, quantity, false);\n+                int recvMesos = ii.getPrice(itemid, quantity);\n+                if (recvMesos > 0) {\n+                    gainMeso(recvMesos, false);\n+                    return(recvMesos);\n+                }\n+            }\n+\n             return(0);\n+        } finally {\n+            inv.unlockInventory();\n         }\n+    }\n+    \n+    private static boolean hasMergeFlag(Item item) {\n+        return (item.getFlag() & ItemConstants.MERGE_UNTRADEABLE) == ItemConstants.MERGE_UNTRADEABLE;\n+    }\n+    \n+    private static void setMergeFlag(Item item) {\n+        int flag = item.getFlag();\n+        flag |= ItemConstants.MERGE_UNTRADEABLE;\n+        flag |= ItemConstants.UNTRADEABLE;\n+        item.setFlag((byte) flag);\n+    }\n+    \n+    private List<Equip> getUpgradeableEquipped() {\n+        List<Equip> list = new LinkedList<>();\n         \n-        int itemid = item.getItemId();\n-        if (ItemConstants.isRechargeable(itemid)) {\n-            quantity = item.getQuantity();\n-        } else if (ItemConstants.isWeddingToken(itemid) || ItemConstants.isWeddingRing(itemid)) {\n-            return(0);\n+        for (Item item : getInventory(MapleInventoryType.EQUIPPED)) {\n+            if (ii.isUpgradeable(item.getItemId())) {\n+                list.add((Equip) item);\n+            }\n         }\n         \n-        if (quantity < 0) {\n-            return(0);\n+        return list;\n+    }\n+    \n+    private static List<Equip> getEquipsWithStat(List<Pair<Equip, Map<StatUpgrade, Short>>> equipped, StatUpgrade stat) {\n+        List<Equip> equippedWithStat = new LinkedList<>();\n+        \n+        for (Pair<Equip, Map<StatUpgrade, Short>> eq : equipped) {\n+            if (eq.getRight().containsKey(stat)) {\n+                equippedWithStat.add(eq.getLeft());\n+            }\n+        }\n+        \n+        return equippedWithStat;\n+    }\n+    \n+    public boolean mergeAllItemsFromName(String name) {\n+        MapleInventoryType type = MapleInventoryType.EQUIP;\n+        \n+        MapleInventory inv = getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            Item it = inv.findByName(name);\n+            if(it == null) {\n+                return false;\n+            }\n+\n+            Map<StatUpgrade, Float> statups = new LinkedHashMap<>();\n+            mergeAllItemsFromPosition(statups, it.getPosition());\n+\n+            List<Pair<Equip, Map<StatUpgrade, Short>>> upgradeableEquipped = new LinkedList<>();\n+            Map<Equip, List<Pair<StatUpgrade, Integer>>> equipUpgrades = new LinkedHashMap<>();\n+            for (Equip eq : getUpgradeableEquipped()) {\n+                upgradeableEquipped.add(new Pair<>(eq, eq.getStats()));\n+                equipUpgrades.put(eq, new LinkedList<Pair<StatUpgrade, Integer>>());\n+            }\n+\n+            /*\n+            for (Entry<StatUpgrade, Float> e : statups.entrySet()) {\n+                System.out.println(e);\n+            }\n+            */\n+\n+            for (Entry<StatUpgrade, Float> e : statups.entrySet()) {\n+                Double ev = Math.sqrt(e.getValue());\n+\n+                Set<Equip> extraEquipped = new LinkedHashSet<>(equipUpgrades.keySet());\n+                List<Equip> statEquipped = getEquipsWithStat(upgradeableEquipped, e.getKey());\n+                float extraRate = (float)(0.2 * Math.random());\n+\n+                if (!statEquipped.isEmpty()) {\n+                    float statRate = 1.0f - extraRate;\n+\n+                    int statup = (int) Math.ceil((ev * statRate) / statEquipped.size());\n+                    for (Equip statEq : statEquipped) {\n+                        equipUpgrades.get(statEq).add(new Pair<>(e.getKey(), statup));\n+                        extraEquipped.remove(statEq);\n+                    }\n+                }\n+\n+                if (!extraEquipped.isEmpty()) {\n+                    int statup = (int) Math.round((ev * extraRate) / extraEquipped.size());\n+                    if (statup > 0) {\n+                        for (Equip extraEq : extraEquipped) {\n+                            equipUpgrades.get(extraEq).add(new Pair<>(e.getKey(), statup));\n+                        }\n+                    }\n+                }\n+            }\n+\n+            dropMessage(6, \"EQUIPMENT MERGE operation results:\");\n+            for (Entry<Equip, List<Pair<StatUpgrade, Integer>>> eqpUpg : equipUpgrades.entrySet()) {\n+                List<Pair<StatUpgrade, Integer>> eqpStatups = eqpUpg.getValue();\n+                if (!eqpStatups.isEmpty()) {\n+                    Equip eqp = eqpUpg.getKey();\n+                    setMergeFlag(eqp);\n+\n+                    String showStr = \" '\" + MapleItemInformationProvider.getInstance().getName(eqp.getItemId()) + \"': \";\n+                    String upgdStr = eqp.gainStats(eqpStatups).getLeft();\n+\n+                    this.forceUpdateItem(eqp);\n+\n+                    showStr += upgdStr;\n+                    dropMessage(6, showStr);\n+                }\n+            }\n+            \n+            return true;\n+        } finally {\n+            inv.unlockInventory();\n         }\n-        short iQuant = item.getQuantity();\n-        if (iQuant == 0xFFFF) {\n-            iQuant = 1;\n+    }\n+    \n+    public void mergeAllItemsFromPosition(Map<StatUpgrade, Float> statups, short pos) {\n+        MapleInventory inv = getInventory(MapleInventoryType.EQUIP);\n+        inv.lockInventory();\n+        try {\n+            for(short i = pos; i <= inv.getSlotLimit(); i++) {\n+                standaloneMerge(statups, getClient(), MapleInventoryType.EQUIP, i, inv.getItem(i));\n+            }\n+        } finally {\n+            inv.unlockInventory();\n+        }\n+    }\n+\n+    private void standaloneMerge(Map<StatUpgrade, Float> statups, MapleClient c, MapleInventoryType type, short slot, Item item) {\n+        short quantity;\n+        if (item == null || (quantity = item.getQuantity()) < 1 || ii.isCash(item.getItemId()) || !ii.isUpgradeable(item.getItemId()) || hasMergeFlag(item)){\n+            return;\n         }\n         \n-        if (quantity <= iQuant && iQuant > 0) {\n-            MapleInventoryManipulator.removeFromSlot(c, type, (byte) slot, quantity, false);\n-            int recvMesos = ii.getPrice(itemid, quantity);\n-            if (recvMesos > 0) {\n-                gainMeso(recvMesos, false);\n-                return(recvMesos);\n+        Equip e = (Equip) item;\n+        for (Entry<StatUpgrade, Short> s : e.getStats().entrySet()) {\n+            Float newVal = statups.get(s.getKey());\n+            \n+            float incVal = s.getValue().floatValue();\n+            switch (s.getKey()) {\n+                case incPAD:\n+                case incMAD:\n+                case incPDD:\n+                case incMDD:\n+                    incVal = (float) Math.log(incVal);\n+                    break;\n+            }\n+            \n+            if (newVal != null) {\n+                newVal += incVal;\n+            } else {\n+                newVal = incVal;\n             }\n+            \n+            statups.put(s.getKey(), newVal);\n         }\n         \n-        return(0);\n+        MapleInventoryManipulator.removeFromSlot(c, type, (byte) slot, quantity, false);\n     }\n     \n     public void setShop(MapleShop shop) {\n@@ -8599,17 +8799,12 @@ public void silentGiveBuffs(List<Pair<Long, PlayerBuffValueHolder>> buffs) {\n     }\n \n     public void silentPartyUpdate() {\n-        prtLock.lock();\n-        try {\n-            silentPartyUpdateInternal();\n-        } finally {\n-            prtLock.unlock();\n-        }\n+        silentPartyUpdateInternal(getParty());\n     }\n     \n-    private void silentPartyUpdateInternal() {\n-        if (party != null) {\n-            getWorldServer().updateParty(party.getId(), PartyOperation.SILENT_UPDATE, getMPC());\n+    private void silentPartyUpdateInternal(MapleParty chrParty) {\n+        if (chrParty != null) {\n+            getWorldServer().updateParty(chrParty.getId(), PartyOperation.SILENT_UPDATE, getMPC());\n         }\n     }\n \n@@ -8662,7 +8857,7 @@ public void runFullnessSchedule(int petSlot) {\n         }\n     }\n     \n-    public void runTirednessSchedule() {\n+    public boolean runTirednessSchedule() {\n         if(maplemount != null) {\n             int tiredness = maplemount.incrementAndGetTiredness();\n             \n@@ -8671,8 +8866,11 @@ public void runTirednessSchedule() {\n                 maplemount.setTiredness(99);\n                 this.dispelSkill(this.getJobType() * 10000000 + 1004);\n                 this.dropMessage(6, \"Your mount grew tired! Treat it some revitalizer before riding it again!\");\n+                return false;\n             }\n         }\n+        \n+        return true;\n     }\n \n     public void startMapEffect(String msg, int itemId) {\n@@ -8956,7 +9154,7 @@ public void sendSpawnData(MapleClient client) {\n         if (!this.isHidden() || client.getPlayer().gmLevel() > 1) {\n             client.announce(MaplePacketCreator.spawnPlayerMapObject(client, this, false));\n             \n-            if(hasBuffFromSourceid(getJobMapChair(job))) {\n+            if (buffEffects.containsKey(getJobMapChair(job))) { // mustn't effLock, chrLock this function\n                 client.announce(MaplePacketCreator.giveForeignChairSkillEffect(id));\n             }\n         }"}, {"sha": "341577b9f593ebe4165043bbc0f7fb096da429dc", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 26, "deletions": 3, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -74,6 +74,7 @@\n import scripting.quest.QuestScriptManager;\n import server.life.MapleMonster;\n import server.MapleTrade;\n+import server.ThreadManager;\n import server.maps.*;\n import server.quest.MapleQuest;\n \n@@ -159,7 +160,7 @@ public AbstractPlayerInteraction getAbstractPlayerInteraction() {\n         }\n \n \tpublic void sendCharList(int server) {\n-\t\tthis.announce(MaplePacketCreator.getCharList(this, server));\n+\t\tthis.announce(MaplePacketCreator.getCharList(this, server, 0));\n \t}\n \n \tpublic List<MapleCharacter> loadCharacters(int serverId) {\n@@ -878,11 +879,33 @@ private void removePlayer(World wserv) {\n \t\t}\n \t}\n \n-\tpublic final synchronized void disconnect(boolean shutdown, boolean cashshop) {//once per MapleClient instance\n+        public final void disconnect(final boolean shutdown, final boolean cashshop) {\n+                if (isDisconnecting()) {\n+                        ThreadManager.getInstance().newTask(new Runnable() {\n+                                @Override\n+                                public void run() {\n+                                        disconnectInternal(shutdown, cashshop);\n+                                }\n+                        });\n+                }\n+        }\n+        \n+        public final void forceDisconnect() {\n+                if (isDisconnecting()) {\n+                        disconnectInternal(true, false);\n+                }\n+        }\n+        \n+        private synchronized boolean isDisconnecting() {\n                 if (disconnecting) {\n-\t\t\treturn;\n+\t\t\treturn false;\n \t\t}\n+                \n \t\tdisconnecting = true;\n+                return true;\n+        }\n+        \n+\tprivate void disconnectInternal(boolean shutdown, boolean cashshop) {//once per MapleClient instance\n \t\tif (player != null && player.isLoggedin() && player.getClient() != null) {\n \t\t\tfinal int messengerid = player.getMessenger() == null ? 0 : player.getMessenger().getId();\n \t\t\t//final int fid = player.getFamilyId();"}, {"sha": "118041175466b2902f26c8f74510d64877ba7537", "filename": "src/client/autoban/AutobanManager.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/autoban/AutobanManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/autoban/AutobanManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/autoban/AutobanManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -6,6 +6,7 @@\n package client.autoban;\n \n import client.MapleCharacter;\n+import constants.ServerConstants;\n import java.util.HashMap;\n import java.util.Map;\n import net.server.Server;\n@@ -109,11 +110,15 @@ public void setTimestamp(int type, int time, int times) {\n         if (this.timestamp[type] == time) {  \n             this.timestampcounter[type]++;\n             if (this.timestampcounter[type] >= times) {\n-                chr.getClient().disconnect(false, false);\n+                if (ServerConstants.USE_AUTOBAN) {\n+                    chr.getClient().disconnect(false, false);\n+                }\n+                \n                 FilePrinter.print(FilePrinter.EXPLOITS, \"Player \" + chr + \" was caught spamming TYPE \" + type + \" and has been disconnected.\");\n             }\n             return;\n         }\n         this.timestamp[type] = time;\n+        this.timestampcounter[type] = 0;\n     }\n }"}, {"sha": "9e4941dcf6cf45757a66f60d1e50fbe69b6a18c2", "filename": "src/client/command/commands/gm0/TimeCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm0/TimeCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm0/TimeCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/TimeCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -40,7 +40,7 @@\n     @Override\n     public void execute(MapleClient client, String[] params) {\n         DateFormat dateFormat = new SimpleDateFormat(\"HH:mm:ss\");\n-        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        dateFormat.setTimeZone(TimeZone.getDefault());\n         client.getPlayer().yellowMessage(\"HeavenMS Server Time: \" + dateFormat.format(new Date()));\n     }\n }"}, {"sha": "591d44b3b2ca04cf8673fd3c52bb9b6cdf0978e6", "filename": "src/client/command/commands/gm2/SummonCommand.java", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm2/SummonCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm2/SummonCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/SummonCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -43,7 +43,9 @@ public void execute(MapleClient c, String[] params) {\n         }\n \n         MapleCharacter victim = c.getChannelServer().getPlayerStorage().getCharacterByName(params[0]);\n-        if (victim == null) {//If victim isn't on current channel, loop all channels on current world.\n+        if (victim == null) {\n+            //If victim isn't on current channel, loop all channels on current world.\n+            \n             for (Channel ch : Server.getInstance().getChannelsFromWorld(c.getWorld())) {\n                 victim = ch.getPlayerStorage().getCharacterByName(params[0]);\n                 if (victim != null) {\n@@ -61,9 +63,10 @@ public void execute(MapleClient c, String[] params) {\n                     victim.getEventInstance().unregisterPlayer(victim);\n                 }\n             }\n+            \n             //Attempt to join the warpers instance.\n             if (player.getEventInstance() != null && changingEvent) {\n-                if (player.getClient().getChannel() == victim.getClient().getChannel()) {//just in case.. you never know...\n+                if (player.getClient().getChannel() == victim.getClient().getChannel()) {\n                     player.getEventInstance().registerPlayer(victim);\n                     victim.changeMap(player.getEventInstance().getMapInstance(player.getMapId()), player.getMap().findClosestPortal(player.getPosition()));\n                 } else {"}, {"sha": "43d1fc56f7c2f536ac3f7244ae954c7476cafcba", "filename": "src/client/command/commands/gm5/DebugCommand.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm5/DebugCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm5/DebugCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm5/DebugCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -71,7 +71,8 @@ public void execute(MapleClient c, String[] params) {\n                 List<MapleMapObject> monsters = player.getMap().getMapObjectsInRange(player.getPosition(), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.MONSTER));\n                 for (MapleMapObject monstermo : monsters) {\n                     MapleMonster monster = (MapleMonster) monstermo;\n-                    player.message(\"Monster ID: \" + monster.getId() + \" Aggro target: \" + ((monster.getController() != null) ? monster.getController().getName() : \"<none>\"));\n+                    MapleCharacter controller = monster.getController();\n+                    player.message(\"Monster ID: \" + monster.getId() + \" Aggro target: \" + ((controller != null) ? controller.getName() : \"<none>\"));\n                 }\n                 break;\n "}, {"sha": "34edf2ae0e3cbeee7f03cd6cd54cc49fb3b5b0bb", "filename": "src/client/command/commands/gm6/ServerAddChannelCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerAddChannelCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerAddChannelCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/ServerAddChannelCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import net.server.Server;\n+import server.ThreadManager;\n \n public class ServerAddChannelCommand extends Command {\n     {\n@@ -44,7 +45,7 @@ public void execute(MapleClient c, String[] params) {\n \n         final int worldid = Integer.parseInt(params[0]);\n \n-        new Thread(new Runnable() {\n+        ThreadManager.getInstance().newTask(new Runnable() {\n             @Override\n             public void run() {\n                 int chid = Server.getInstance().addChannel(worldid);\n@@ -64,6 +65,6 @@ public void run() {\n                     }\n                 }\n             }\n-        }).start();\n+        });\n     }\n }"}, {"sha": "98074e262833cd87247611cfc7d684006a0964e1", "filename": "src/client/command/commands/gm6/ServerAddWorldCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerAddWorldCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerAddWorldCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/ServerAddWorldCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import net.server.Server;\n+import server.ThreadManager;\n \n public class ServerAddWorldCommand extends Command {\n     {\n@@ -37,7 +38,7 @@\n     public void execute(MapleClient c, String[] params) {\n         final MapleCharacter player = c.getPlayer();\n         \n-        new Thread(new Runnable() {\n+        ThreadManager.getInstance().newTask(new Runnable() {\n             @Override\n             public void run() {\n                 int wid = Server.getInstance().addWorld();\n@@ -54,6 +55,6 @@ public void run() {\n                     }\n                 }\n             }\n-        }).start();\n+        });\n     }\n }"}, {"sha": "0c8112e6e4244f83671b13faf7af9a60ed377c9c", "filename": "src/client/command/commands/gm6/ServerRemoveChannelCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerRemoveChannelCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerRemoveChannelCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/ServerRemoveChannelCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import net.server.Server;\n+import server.ThreadManager;\n \n public class ServerRemoveChannelCommand extends Command {\n     {\n@@ -43,7 +44,7 @@ public void execute(MapleClient c, String[] params) {\n         }\n \n         final int worldId = Integer.parseInt(params[0]);\n-        new Thread(new Runnable() {\n+        ThreadManager.getInstance().newTask(new Runnable() {\n             @Override\n             public void run() {\n                 if(Server.getInstance().removeChannel(worldId)) {\n@@ -56,6 +57,6 @@ public void run() {\n                     }\n                 }\n             }\n-        }).start();\n+        });\n     }\n }"}, {"sha": "35acf28b470889fab74067716288375e327d907c", "filename": "src/client/command/commands/gm6/ServerRemoveWorldCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerRemoveWorldCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/command/commands/gm6/ServerRemoveWorldCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/ServerRemoveWorldCommand.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import net.server.Server;\n+import server.ThreadManager;\n \n public class ServerRemoveWorldCommand extends Command {\n     {\n@@ -43,7 +44,7 @@ public void execute(MapleClient c, String[] params) {\n             return;\n         }\n \n-        new Thread(new Runnable() {\n+        ThreadManager.getInstance().newTask(new Runnable() {\n             @Override\n             public void run() {\n                 if(Server.getInstance().removeWorld()) {\n@@ -60,6 +61,6 @@ public void run() {\n                     }\n                 }\n             }\n-        }).start();\n+        });\n     }\n }"}, {"sha": "2959774f18f71ce9063183ed8b19c8c277a5b781", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 74, "deletions": 42, "changes": 116, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -24,8 +24,10 @@\n import client.MapleClient;\n import constants.ServerConstants;\n import constants.ExpTable;\n+import java.util.HashMap;\n import java.util.LinkedList;\n import java.util.List;\n+import java.util.Map;\n import server.MapleItemInformationProvider;\n import tools.MaplePacketCreator;\n import tools.Pair;\n@@ -47,7 +49,7 @@ public int getValue() {\n         }\n     }\n     \n-    private static enum StatUpgrade {\n+    public static enum StatUpgrade {\n \n         incDEX(0), incSTR(1), incINT(2), incLUK(3),\n         incMHP(4), incMMP(5), incPAD(6), incMAD(7),\n@@ -332,49 +334,30 @@ private void improveDefaultStats(List<Pair<StatUpgrade, Integer>> stats) {\n         if(jump > 0) getUnitStatUpgrade(stats, StatUpgrade.incJump, jump, false);\n     }\n     \n-    private void gainLevel(MapleClient c) {\n-        List<Pair<StatUpgrade, Integer>> stats = new LinkedList<>();\n-                \n-        if(isElemental) {\n-            List<Pair<String, Integer>> elementalStats = MapleItemInformationProvider.getInstance().getItemLevelupStats(getItemId(), itemLevel);\n-            \n-            for(Pair<String, Integer> p: elementalStats) {\n-                if(p.getRight() > 0) stats.add(new Pair<>(StatUpgrade.valueOf(p.getLeft()), p.getRight()));\n-            }\n-        }\n+    public Map<StatUpgrade, Short> getStats() {\n+        Map<StatUpgrade, Short> stats = new HashMap<>(5);\n         \n-        if(!stats.isEmpty()) {\n-            if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n-                if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n-                getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n-            }\n-        }\n-        else {\n-            isUpgradeable = false;\n-            \n-            improveDefaultStats(stats);\n-            if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n-                if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n-                getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n-            }\n-            \n-            if(isUpgradeable) {\n-                while(stats.isEmpty()) {\n-                    improveDefaultStats(stats);\n-                    if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n-                        if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n-                        getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n-                    }\n-                }\n-            }\n-        }\n-        \n-        itemLevel++;\n-        boolean gotVicious = false, gotSlot = false;\n-        \n-        String lvupStr = \"'\" + MapleItemInformationProvider.getInstance().getName(this.getItemId()) + \"' is now level \" + itemLevel + \"! \";\n-        String showStr = \"#e'\" + MapleItemInformationProvider.getInstance().getName(this.getItemId()) + \"'#b is now #elevel #r\" + itemLevel + \"#k#b!\";\n+        if(dex > 0) stats.put(StatUpgrade.incDEX, dex);\n+        if(str > 0) stats.put(StatUpgrade.incSTR, str);\n+        if(_int > 0) stats.put(StatUpgrade.incINT,_int);\n+        if(luk > 0) stats.put(StatUpgrade.incLUK, luk);\n+        if(hp > 0) stats.put(StatUpgrade.incMHP, hp);\n+        if(mp > 0) stats.put(StatUpgrade.incMMP, mp);\n+        if(watk > 0) stats.put(StatUpgrade.incPAD, watk);\n+        if(matk > 0) stats.put(StatUpgrade.incMAD, matk);\n+        if(wdef > 0) stats.put(StatUpgrade.incPDD, wdef);\n+        if(mdef > 0) stats.put(StatUpgrade.incMDD, mdef);\n+        if(avoid > 0) stats.put(StatUpgrade.incEVA, avoid);\n+        if(acc > 0) stats.put(StatUpgrade.incACC, acc);\n+        if(speed > 0) stats.put(StatUpgrade.incSpeed, speed);\n+        if(jump > 0) stats.put(StatUpgrade.incJump, jump);\n         \n+        return stats;\n+    }\n+    \n+    public Pair<String, Pair<Boolean, Boolean>> gainStats(List<Pair<StatUpgrade, Integer>> stats) {\n+        boolean gotSlot = false, gotVicious = false;\n+        String lvupStr = \"\";\n         Integer statUp, maxStat = ServerConstants.MAX_EQUIPMNT_STAT;\n         for (Pair<StatUpgrade, Integer> stat : stats) {\n             switch (stat.getLeft()) {\n@@ -460,6 +443,55 @@ private void gainLevel(MapleClient c) {\n             }\n         }\n         \n+        return new Pair<>(lvupStr, new Pair<>(gotSlot, gotVicious));\n+    }\n+    \n+    private void gainLevel(MapleClient c) {\n+        List<Pair<StatUpgrade, Integer>> stats = new LinkedList<>();\n+        \n+        if(isElemental) {\n+            List<Pair<String, Integer>> elementalStats = MapleItemInformationProvider.getInstance().getItemLevelupStats(getItemId(), itemLevel);\n+            \n+            for(Pair<String, Integer> p: elementalStats) {\n+                if(p.getRight() > 0) stats.add(new Pair<>(StatUpgrade.valueOf(p.getLeft()), p.getRight()));\n+            }\n+        }\n+        \n+        if(!stats.isEmpty()) {\n+            if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n+                if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n+                getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n+            }\n+        } else {\n+            isUpgradeable = false;\n+            \n+            improveDefaultStats(stats);\n+            if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n+                if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n+                getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n+            }\n+            \n+            if(isUpgradeable) {\n+                while(stats.isEmpty()) {\n+                    improveDefaultStats(stats);\n+                    if(ServerConstants.USE_EQUIPMNT_LVLUP_SLOTS) {\n+                        if(vicious > 0) getUnitSlotUpgrade(stats, StatUpgrade.incVicious);\n+                        getUnitSlotUpgrade(stats, StatUpgrade.incSlot);\n+                    }\n+                }\n+            }\n+        }\n+        \n+        itemLevel++;\n+        \n+        String lvupStr = \"'\" + MapleItemInformationProvider.getInstance().getName(this.getItemId()) + \"' is now level \" + itemLevel + \"! \";\n+        String showStr = \"#e'\" + MapleItemInformationProvider.getInstance().getName(this.getItemId()) + \"'#b is now #elevel #r\" + itemLevel + \"#k#b!\";\n+        \n+        Pair<String, Pair<Boolean, Boolean>> res = gainStats(stats);\n+        lvupStr += res.getLeft();\n+        boolean gotSlot = res.getRight().getLeft();\n+        boolean gotVicious = res.getRight().getRight();\n+        \n         if(gotVicious) {\n             //c.getPlayer().dropMessage(6, \"A new Vicious Hammer opportunity has been found on the '\" + MapleItemInformationProvider.getInstance().getName(getItemId()) + \"'!\");\n             lvupStr += \"+VICIOUS \";"}, {"sha": "8173dd5b1dc1d47cbe145e0122aec5334d3864a4", "filename": "src/client/inventory/Item.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/Item.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/Item.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Item.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -73,6 +73,7 @@ public Item copy() {\n \n     public void setPosition(short position) {\n         this.position = position;\n+        if (this.pet != null) this.pet.setPosition(position);\n     }\n \n     public void setQuantity(short quantity) {"}, {"sha": "2f9b8d3fd069951c8fe40d819377fa59dc495c62", "filename": "src/client/inventory/MaplePet.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/MaplePet.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/MaplePet.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MaplePet.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -215,7 +215,7 @@ public void gainClosenessFullness(MapleCharacter owner, int incCloseness, int in\n             enjoyed = false;\n         }\n         \n-        owner.getMap().broadcastMessage(MaplePacketCreator.commandResponse(owner.getId(), slot, type, enjoyed));\n+        owner.getMap().broadcastMessage(MaplePacketCreator.petFoodResponse(owner.getId(), slot, enjoyed, false));\n         saveToDb();\n         \n         Item petz = owner.getInventory(MapleInventoryType.CASH).getItem(getPosition());"}, {"sha": "c70d133bfb7a3a629caae087882c138d4dcc6e4f", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -188,6 +188,7 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                                 short newQ = (short) Math.min(oldQ + quantity, slotMax);\n                                 quantity -= (newQ - oldQ);\n                                 eItem.setQuantity(newQ);\n+                                item.setPosition(eItem.getPosition());\n                                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(1, eItem))));\n                             }\n                         } else {\n@@ -209,6 +210,8 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                         item.setQuantity((short) (quantity + newQ));\n                         return false;\n                     }\n+                    nItem.setPosition(newSlot);\n+                    item.setPosition(newSlot);\n                     c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n                     if(MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n                 }\n@@ -223,6 +226,8 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                     c.announce(MaplePacketCreator.getShowInventoryFull());\n                     return false;\n                 }\n+                nItem.setPosition(newSlot);\n+                item.setPosition(newSlot);\n                 c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n                 if(MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n                 c.announce(MaplePacketCreator.enableActions());\n@@ -234,6 +239,7 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n                 c.announce(MaplePacketCreator.getShowInventoryFull());\n                 return false;\n             }\n+            item.setPosition(newSlot);\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, item))));\n             if(MapleInventoryManipulator.isSandboxItem(item)) chr.setHasSandboxItem();\n         } else {"}, {"sha": "c563bbc49c6f21fb5b4fd61a30c49717029f4d56", "filename": "src/client/processor/AssignAPProcessor.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/AssignAPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/AssignAPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/AssignAPProcessor.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -43,6 +43,7 @@\n import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n+import server.ThreadManager;\n import tools.MaplePacketCreator;\n import tools.Randomizer;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -333,13 +334,12 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                     AutobanFactory.PACKET_EDIT.alert(chr, \"Didn't send full packet for Auto Assign.\");\n                     \n                     final MapleClient client = c;\n-                    Thread t = new Thread(new Runnable() {\n+                    ThreadManager.getInstance().newTask(new Runnable() {\n                         @Override\n                         public void run() {\n                             client.disconnect(false, false);\n                         }\n                     });\n-                    t.start();\n                     \n                     return;\n                 }"}, {"sha": "7c8d868a888c7fa2ae2b0adc6120f15ceb74c1c7", "filename": "src/client/processor/AssignSPProcessor.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/AssignSPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/AssignSPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/AssignSPProcessor.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -30,6 +30,7 @@\n import client.autoban.AutobanFactory;\n import constants.GameConstants;\n import constants.skills.Aran;\n+import server.ThreadManager;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n \n@@ -55,13 +56,12 @@ public static void SPAssignAction(MapleClient c, int skillid) {\n                 FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to use skill \" + skillid + \" without it being in their job.\\r\\n\");\n                 \n                 final MapleClient client = c;\n-                Thread t = new Thread(new Runnable() {\n+                ThreadManager.getInstance().newTask(new Runnable() {\n                     @Override\n                     public void run() {\n                         client.disconnect(true, false);\n                     }\n                 });\n-                t.start();\n                 \n                 return;\n             }"}, {"sha": "7c913bebcf81bfc1185e5eedab725d53f895b499", "filename": "src/client/processor/MakerProcessor.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/MakerProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/client/processor/MakerProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/MakerProcessor.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -20,6 +20,7 @@\n package client.processor;\n \n import client.MapleClient;\n+import client.MapleCharacter;\n import client.inventory.Equip;\n import client.inventory.Item;\n import client.inventory.MapleInventoryType;\n@@ -199,7 +200,7 @@ public static void makerAction(SeekableLittleEndianAccessor slea, MapleClient c)\n                             c.announce(MaplePacketCreator.showMakerEffect(makerSucceeded));\n                             c.getPlayer().getMap().broadcastMessage(c.getPlayer(), MaplePacketCreator.showForeignMakerEffect(c.getPlayer().getId(), makerSucceeded), false);\n \n-                            if(toCreate == 4260003 && c.getPlayer().getQuestStatus(6033) == 1) {\n+                            if(toCreate == 4260003 && type == 3 && c.getPlayer().getQuestStatus(6033) == 1) {\n                                 c.getAbstractPlayerInteraction().setQuestProgress(6033, 1);\n                             }\n                         } else {\n@@ -282,6 +283,10 @@ private static int getMakerReagentSlots(int itemId) {\n         return null;\n     }\n     \n+    public static int getMakerSkillLevel(MapleCharacter chr) {\n+        return chr.getSkillLevel((chr.getJob().getId() / 1000) * 10000000 + 1007);\n+    }\n+    \n     private static short getCreateStatus(MapleClient c, MakerItemFactory.MakerItemCreateEntry recipe) {\n         if(recipe == null) {\n             return -1;\n@@ -299,7 +304,7 @@ private static short getCreateStatus(MapleClient c, MakerItemFactory.MakerItemCr\n             return 3;\n         }\n         \n-        if(c.getPlayer().getSkillLevel((c.getPlayer().getJob().getId() / 1000) * 10000000 + 1007) < recipe.getReqSkillLevel()) {\n+        if(getMakerSkillLevel(c.getPlayer()) < recipe.getReqSkillLevel()) {\n             return 4;\n         }\n         "}, {"sha": "40f6e9afccdf5a71e2f3f09bb32a360775753771", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -45,6 +45,7 @@\n     public final static int SANDBOX = 0x40;             // let 0x40 until it's proven something uses this\n     public final static int PET_COME = 0x80;\n     public final static int ACCOUNT_SHARING = 0x100;\n+    public final static int MERGE_UNTRADEABLE = 0x200;\n \n     public final static boolean EXPIRING_ITEMS = true;\n     public final static Set<Integer> permanentItemids = new HashSet<>();"}, {"sha": "2f3c64c057d4209d63ff572d4a79244b8813422d", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -82,7 +82,7 @@\n     public static final boolean USE_ENFORCE_HPMP_SWAP = false;      //Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     public static final boolean USE_ENFORCE_MOB_LEVEL_RANGE = true; //Players N levels below the killed mob will gain no experience from defeating it.\n     public static final boolean USE_ENFORCE_JOB_LEVEL_RANGE = false;//Caps the player level on the minimum required to advance their current jobs.\n-    public static final boolean USE_ENFORCE_JOB_SP_RANGE = true;   //Caps the player SP level on the total obtainable by their current jobs. After changing jobs, missing SP will be retrieved.\n+    public static final boolean USE_ENFORCE_JOB_SP_RANGE = false;   //Caps the player SP level on the total obtainable by their current jobs. After changing jobs, missing SP will be retrieved.\n     public static final boolean USE_ENFORCE_ITEM_SUGGESTION = false;//Forces the Owl of Minerva and the Cash Shop to always display the defined item array instead of those featured by the players.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_CASH = true;//Forces players to not sell CASH items via merchants.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_PET = true; //Forces players to not sell pets via merchants. (since non-named pets gets dirty name and other possible DB-related issues)\n@@ -115,6 +115,10 @@\n     public static final boolean USE_MAKER_PERMISSIVE_ATKUP = true;  //Allows players to use attack-based strengthening gems on non-weapon items.\n     public static final boolean USE_MAKER_FEE_HEURISTICS = true;    //Apply compiled values for stimulants and reagents into the Maker fee calculations (max error revolves around 50k mesos). Set false to use basic constant values instead (results are never higher than requested by the client-side).\n     \n+    //Custom Configuration\n+    public static final boolean USE_ENABLE_CUSTOM_NPC_SCRIPT = true;//Enables usage of custom HeavenMS NPC scripts (Agent E, Coco, etc). Will not disable Abdula (it's actually useful for the gameplay), quests or NPC shops.\n+    public static final boolean USE_STARTER_MERGE = false;          //Allows any players to use the Equipment Merge custom mechanic (as opposed to the high-level, Maker lv3 requisites).\n+    \n     //Commands Configuration\n     public static final boolean BLOCK_GENERATE_CASH_ITEM = false;   //Prevents creation of cash items with the item/drop command.\n     public static final boolean USE_WHOLE_SERVER_RANKING = false;   //Enables a ranking pool made from every character registered on the server for the \"ranks\" command, instead of separated by worlds.\n@@ -133,7 +137,7 @@\n     public static final int PARTY_EXPERIENCE_MOD = 1;               //Change for event stuff.\n     \n     //Miscellaneous Configuration\n-    public static String TIMEZONE = \"-GMT3\";\n+    public static String TIMEZONE = \"GMT-3\";\n     public static boolean USE_DISPLAY_NUMBERS_WITH_COMMA = true;        //Enforce comma on displayed strings (use this when USE_UNITPRICE_WITH_COMMA is active and you still want to display comma-separated values).\n     public static boolean USE_UNITPRICE_WITH_COMMA = true;              //Set this accordingly with the layout of the unitPrices on Item.wz XML's, whether it's using commas or dots to represent fractions.\n     public static final byte MIN_UNDERLEVEL_TO_EXP_GAIN = 20;           //Characters are unable to get EXP from a mob if their level are under this threshold, only if \"USE_ENFORCE_MOB_LEVEL_RANGE\" is enabled. For bosses, this attribute is doubled.\n@@ -178,6 +182,7 @@\n     public static final boolean USE_ULTRA_THREE_SNAILS = true;  //Massive damage on shell toss.\n     \n     //Other Skills Configuration\n+    public static final boolean USE_FULL_ARAN_SKILLSET = false; //Enables starter availability to all Aran job skills. Suggestion thanks to Masterrulax.\n     public static final boolean USE_FAST_REUSE_HERO_WILL = true;//Greatly reduce cooldown on Hero's Will.\n     public static final boolean USE_ANTI_IMMUNITY_CRASH = true; //Crash skills additionally removes the mob's invincibility buffs. Suggestion thanks to Celestial.\n     public static final boolean USE_UNDISPEL_HOLY_SHIELD = true;//Holy shield buff also prevents players from suffering dispel from mobs.\n@@ -245,6 +250,7 @@\n     public static final long EVENT_LOBBY_DELAY = 10;            //Cooldown duration in seconds before reopening an event lobby.\n     \n     //Dojo Configuration\n+    public static final boolean USE_FAST_DOJO_UPGRADE = true;   //Reduced Dojo training points amount required for a belt upgrade.\n     public static final boolean USE_DEADLY_DOJO = false;        //Should bosses really use 1HP,1MP attacks in dojo?\n     public static final int DOJO_ENERGY_ATK = 100;              //Dojo energy gain when deal attack\n     public static final int DOJO_ENERGY_DMG =  20;              //Dojo energy gain when recv attack"}, {"sha": "c692af89e81cad379622c20d06e3b990befa98d8", "filename": "src/constants/skills/WindArcher.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/skills/WindArcher.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/constants/skills/WindArcher.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/skills/WindArcher.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -33,6 +33,7 @@\n     public static final int BOW_BOOSTER = 13101001;\n     public static final int FINAL_ATTACK = 13101002;\n     public static final int SOUL_ARROW = 13101003;\n+    public static final int STORM_BREAK = 13101005;\n     public static final int WIND_WALK = 13101006;\n     public static final int HURRICANE = 13111002;\n     public static final int PUPPET = 13111004;"}, {"sha": "01fb6993d0855fe71fc91d14e0b7ac0c0aef59a7", "filename": "src/net/PacketProcessor.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/PacketProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/PacketProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/PacketProcessor.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -136,6 +136,7 @@ public void reset(int channel) {\n             registerHandler(RecvOpcode.NPC_TALK, new NPCTalkHandler());\n             registerHandler(RecvOpcode.NPC_TALK_MORE, new NPCMoreTalkHandler());\n             registerHandler(RecvOpcode.QUEST_ACTION, new QuestActionHandler());\n+            registerHandler(RecvOpcode.GRENADE_EFFECT, new GrenadeEffectHandler());\n             registerHandler(RecvOpcode.NPC_SHOP, new NPCShopHandler());\n             registerHandler(RecvOpcode.ITEM_SORT, new InventoryMergeHandler());\n             registerHandler(RecvOpcode.ITEM_MOVE, new ItemMoveHandler());"}, {"sha": "6040f9fb030526f6645d3a16973e926c04a1dafd", "filename": "src/net/opcodes/RecvOpcode.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/opcodes/RecvOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/opcodes/RecvOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/opcodes/RecvOpcode.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -114,7 +114,8 @@\n     TROCK_ADD_MAP(0x66),\n     REPORT(0x6A),\n     QUEST_ACTION(0x6B),\n-    //lolno\n+    //USER_CALC_DAMAGE_STAT_SET_REQUEST(0x6C),\n+    GRENADE_EFFECT(0x6D),\n     SKILL_MACRO(0x6E),\n     USE_ITEM_REWARD(0x70),\n     MAKER_SKILL(0x71),"}, {"sha": "55110e68c6740b78be8794fd6ba51307a62c9a4b", "filename": "src/net/opcodes/SendOpcode.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/opcodes/SendOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/opcodes/SendOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/opcodes/SendOpcode.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -228,6 +228,7 @@\n     GIVE_FOREIGN_BUFF(0xC7),\n     CANCEL_FOREIGN_BUFF(0xC8),\n     UPDATE_PARTYMEMBER_HP(0xC9),\n+    THROW_GRENADE(0xCC),\n     CANCEL_CHAIR(0xCD),\n     SHOW_ITEM_GAIN_INCHAT(0xCE),\n     DOJO_WARP_UP(0xCF),"}, {"sha": "ba77848f2eb8cc1d59bee054ac5e57445e5cc1a1", "filename": "src/net/server/PlayerStorage.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/PlayerStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/PlayerStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/PlayerStorage.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -102,7 +102,7 @@ public final void disconnectAll() {\n         for(MapleCharacter mc : chrList) {\n             MapleClient client = mc.getClient();\n             if(client != null) {\n-                client.disconnect(true, false);\n+                client.forceDisconnect();\n             }\n         }\n         "}, {"sha": "4f7ee9261bd71110764b191c01358b278cd18f08", "filename": "src/net/server/Server.java", "status": "modified", "additions": 38, "deletions": 1, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -85,8 +85,10 @@\n import constants.ItemConstants;\n import constants.GameConstants;\n import constants.ServerConstants;\n+import java.util.TimeZone;\n import server.CashShop.CashItemFactory;\n import server.MapleSkillbookInformationProvider;\n+import server.ThreadManager;\n import server.TimerManager;\n import server.life.MaplePlayerNPCFactory;\n import server.quest.MapleQuest;\n@@ -147,6 +149,10 @@ public static Server getInstance() {\n     private boolean online = false;\n     public static long uptime = System.currentTimeMillis();\n     \n+    public int getCurrentTimestamp() {\n+        return (int) (Server.getInstance().getCurrentTime() - Server.uptime);\n+    }\n+    \n     public long getCurrentTime() {  // returns a slightly delayed time value, under frequency of UPDATE_INTERVAL\n         return serverCurrentTime;\n     }\n@@ -825,18 +831,46 @@ private void initWorldPlayerRanking() {\n         return rankSystem;\n     }\n     \n+    private static void clearUnreferencedPetIds() {\n+        PreparedStatement ps = null;\n+        Connection con = null;\n+        try {\n+            con = DatabaseConnection.getConnection();\n+            \n+            ps = con.prepareStatement(\"UPDATE inventoryitems SET petid = -1, expiration = 0 WHERE petid != -1 AND petid NOT IN (SELECT petid FROM pets)\");\n+            ps.executeUpdate();\n+            \n+            ps.close();\n+            con.close();\n+        } catch(SQLException ex) {\n+            ex.printStackTrace();\n+        } finally {\n+            try {\n+                if(ps != null && !ps.isClosed()) {\n+                    ps.close();\n+                }\n+                if(con != null && !con.isClosed()) {\n+                    con.close();\n+                }\n+            } catch (SQLException e) {\n+                e.printStackTrace();\n+            }\n+        }\n+    }\n+    \n     public void init() {\n         Properties p = loadWorldINI();\n         if(p == null) {\n             System.exit(0);\n         }\n \n         System.out.println(\"HeavenMS v\" + ServerConstants.VERSION + \" starting up.\\r\\n\");\n-\n         \n         if(ServerConstants.SHUTDOWNHOOK)\n             Runtime.getRuntime().addShutdownHook(new Thread(shutdown(false)));\n         \n+        TimeZone.setDefault(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        \n         Connection c = null;\n         try {\n             c = DatabaseConnection.getConnection();\n@@ -856,13 +890,15 @@ public void init() {\n             sqle.printStackTrace();\n         }\n         \n+        clearUnreferencedPetIds();\n         MapleCashidGenerator.loadExistentCashIdsFromDb();\n         \n         IoBuffer.setUseDirectBuffer(false);\n         IoBuffer.setAllocator(new SimpleBufferAllocator());\n         acceptor = new NioSocketAcceptor();\n         acceptor.getFilterChain().addLast(\"codec\", (IoFilter) new ProtocolCodecFilter(new MapleCodecFactory()));\n         \n+        ThreadManager.getInstance().start();\n         TimerManager tMan = TimerManager.getInstance();\n         tMan.start();\n         tMan.register(tMan.purge(), ServerConstants.PURGING_INTERVAL);//Purging ftw...\n@@ -1716,6 +1752,7 @@ public void run() {\n                     \n                     resetServerWorlds();\n                     \n+                    ThreadManager.getInstance().stop();\n                     TimerManager.getInstance().purge();\n                     TimerManager.getInstance().stop();\n "}, {"sha": "7ad940f346ff635fe1df7085508036381acae5bb", "filename": "src/net/server/audit/ThreadTracker.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/ThreadTracker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/ThreadTracker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/ThreadTracker.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -153,7 +153,7 @@ public void accessThreadTracker(boolean update, boolean lock, MonitoredLockType\n                                 StackTraceElement[] ste = threads.get(l).getStackTrace();\n                                 if(ste.length > 0) {\n                                     DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-                                    dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+                                    dateFormat.setTimeZone(TimeZone.getDefault());\n                                     String df = dateFormat.format(new Date());\n                                     \n                                     FilePrinter.print(FilePrinter.DEADLOCK_LOCKS, printThreadLog(tt, df));\n@@ -195,7 +195,7 @@ public void accessThreadTracker(boolean update, boolean lock, MonitoredLockType\n                     }\n                 } else {    // print status\n                     DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-                    dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+                    dateFormat.setTimeZone(TimeZone.getDefault());\n \n                     FilePrinter.printError(FilePrinter.DEADLOCK_STATE, printThreadTrackerState(dateFormat.format(new Date())));\n                     //FilePrinter.printError(FilePrinter.DEADLOCK_STATE, \"[\" + dateFormat.format(new Date()) + \"] Presenting current lock path for lockid \" + lockId.name() + \".\\r\\n\" + printLockStatus(lockId) + \"\\r\\n-------------------------------\\r\\n\");"}, {"sha": "22fbc26183f7faa72c58f471d5ce109420fdcd7a", "filename": "src/net/server/audit/locks/active/TrackerReadLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerReadLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -62,7 +62,7 @@ public void lock() {\n         if(ServerConstants.USE_THREAD_TRACKER) {\n             if(deadlockedState != null) {\n                 DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-                dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+                dateFormat.setTimeZone(TimeZone.getDefault());\n \n                 //FilePrinter.printError(FilePrinter.DEADLOCK_ERROR, \"[CRITICAL] \" + dateFormat.format(new Date()) + \" Deadlock occurred when trying to use the '\" + id.name() + \"' lock resources:\\r\\n\" + printStackTrace(deadlockedState) + \"\\r\\n\\r\\n\");\n                 ThreadTracker.getInstance().accessThreadTracker(true, true, id, hashcode);"}, {"sha": "c60fe5f892fb772899da8c7f98d1fa2bd58d2d3b", "filename": "src/net/server/audit/locks/active/TrackerReentrantLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerReentrantLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -64,7 +64,7 @@ public void lock() {\n         if(ServerConstants.USE_THREAD_TRACKER) {\n             if(deadlockedState != null) {\n                 DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-                dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+                dateFormat.setTimeZone(TimeZone.getDefault());\n \n                 //FilePrinter.printError(FilePrinter.DEADLOCK_ERROR, \"[CRITICAL] \" + dateFormat.format(new Date()) + \" Deadlock occurred when trying to use the '\" + id.name() + \"' lock resources:\\r\\n\" + printStackTrace(deadlockedState) + \"\\r\\n\\r\\n\");\n                 ThreadTracker.getInstance().accessThreadTracker(true, true, id, hashcode);"}, {"sha": "82bc429106b01dca5854ee1537086be8d142c74b", "filename": "src/net/server/audit/locks/active/TrackerWriteLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/active/TrackerWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/active/TrackerWriteLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -60,7 +60,7 @@ public void lock() {\n         if(ServerConstants.USE_THREAD_TRACKER) {\n             if(deadlockedState != null) {\n                 DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-                dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+                dateFormat.setTimeZone(TimeZone.getDefault());\n \n                 //FilePrinter.printError(FilePrinter.DEADLOCK_ERROR, \"[CRITICAL] \" + dateFormat.format(new Date()) + \" Deadlock occurred when trying to use the '\" + id.name() + \"' lock resources:\\r\\n\" + printStackTrace(deadlockedState) + \"\\r\\n\\r\\n\");\n                 ThreadTracker.getInstance().accessThreadTracker(true, true, id, hashcode);"}, {"sha": "9e98b776bfae6ba899cd3a3cf86b892870456d3d", "filename": "src/net/server/audit/locks/empty/EmptyReadLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyReadLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -41,7 +41,7 @@ public EmptyReadLock(MonitoredLockType type) {\n     \n     private static String printThreadStack(StackTraceElement[] list) {\n         DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        dateFormat.setTimeZone(TimeZone.getDefault());\n         String df = dateFormat.format(new Date());\n         \n         String s = \"\\r\\n\" + df + \"\\r\\n\";"}, {"sha": "dd2916c1e93a2948a81641bdede1b70d32554174", "filename": "src/net/server/audit/locks/empty/EmptyReentrantLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyReentrantLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -41,7 +41,7 @@ public EmptyReentrantLock(MonitoredLockType type) {\n     \n     private static String printThreadStack(StackTraceElement[] list) {\n         DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        dateFormat.setTimeZone(TimeZone.getDefault());\n         String df = dateFormat.format(new Date());\n         \n         String s = \"\\r\\n\" + df + \"\\r\\n\";"}, {"sha": "c1615f2fa375da14f1a27e4aafb8dab4781bd5b2", "filename": "src/net/server/audit/locks/empty/EmptyWriteLock.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/audit/locks/empty/EmptyWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/empty/EmptyWriteLock.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -41,7 +41,7 @@ public EmptyWriteLock(MonitoredLockType type) {\n     \n     private static String printThreadStack(StackTraceElement[] list) {\n         DateFormat dateFormat = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss\");\n-        dateFormat.setTimeZone(TimeZone.getTimeZone(ServerConstants.TIMEZONE));\n+        dateFormat.setTimeZone(TimeZone.getDefault());\n         String df = dateFormat.format(new Date());\n         \n         String s = \"\\r\\n\" + df + \"\\r\\n\";"}, {"sha": "df5168eaeb4c4864c6de7d846d3cf4d5c04c7857", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -259,8 +259,9 @@ else if(attack.skill == DragonKnight.DRAGON_ROAR || attack.skill == SuperGM.SUPE\n                     else if(attack.skill == Shadower.BOOMERANG_STEP)\n                         distanceToDetect += 60000;\n                     \n-                    if(distance > distanceToDetect) {\n+                    if (distance > distanceToDetect) {\n                         AutobanFactory.DISTANCE_HACK.alert(player, \"Distance Sq to monster: \" + distance + \" SID: \" + attack.skill + \" MID: \" + monster.getId());\n+                        monster.refreshMobPosition();\n                     }\n                     \n                     int totDamageToOneMonster = 0;\n@@ -338,7 +339,7 @@ public void run() {\n                         }\n                     }\n                     \n-                    if (job == 2111 || job == 2112) {\n+                    if (player.isAran()) {\n                     \tif (player.getBuffedValue(MapleBuffStat.WK_CHARGE) != null) {\n                             Skill snowCharge = SkillFactory.getSkill(Aran.SNOW_CHARGE);\n                             if (totDamageToOneMonster > 0) {"}, {"sha": "622f7ef75cd31a65a7887d1a61ff48764ff3e9e4", "filename": "src/net/server/channel/handlers/AutoAggroHandler.java", "status": "modified", "additions": 18, "deletions": 9, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/AutoAggroHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/AutoAggroHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AutoAggroHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -26,6 +26,7 @@\n import server.life.MapleMonster;\n import server.maps.MapleMap;\n import tools.data.input.SeekableLittleEndianAccessor;\n+import client.MapleCharacter;\n \n public final class AutoAggroHandler extends AbstractMaplePacketHandler {\n \n@@ -38,18 +39,26 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int oid = slea.readInt();\n         \n         MapleMonster monster = map.getMonsterByOid(oid);\n-        if (monster != null && monster.getController() != null) {\n-            if (!monster.isControllerHasAggro()) {\n-                if (map.getCharacterById(monster.getController().getId()) == null) {\n-                    monster.switchController(c.getPlayer(), true);\n+        if (monster != null) {\n+            MapleCharacter currentController = monster.getController();\n+            monster.lockMonster();\n+            try {\n+                if (currentController != null) {\n+                    if (!monster.isControllerHasAggro()) {\n+                        if (map.getCharacterById(currentController.getId()) == null) {\n+                            monster.switchController(c.getPlayer(), true);\n+                        } else {\n+                            monster.switchController(currentController, true);\n+                        }\n+                    } else if (map.getCharacterById(currentController.getId()) == null) {\n+                        monster.switchController(c.getPlayer(), true);\n+                    }\n                 } else {\n-                    monster.switchController(monster.getController(), true);\n+                    monster.switchController(c.getPlayer(), true);\n                 }\n-            } else if (map.getCharacterById(monster.getController().getId()) == null) {\n-                monster.switchController(c.getPlayer(), true);\n+            } finally {\n+                monster.unlockMonster();\n             }\n-        } else if (monster != null && monster.getController() == null) {\n-            monster.switchController(c.getPlayer(), true);\n         }\n     }\n }"}, {"sha": "c02bb17b597d3cb17956369bf1bc948671330a4e", "filename": "src/net/server/channel/handlers/ChangeChannelHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/ChangeChannelHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/ChangeChannelHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeChannelHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -25,6 +25,7 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n import client.autoban.AutobanFactory;\n+import net.server.Server;\n \n /**\n  *\n@@ -35,7 +36,8 @@\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int channel = slea.readByte() + 1;\n-        c.getPlayer().getAutobanManager().setTimestamp(6, slea.readInt(), 2);\n+        slea.readInt();\n+        c.getPlayer().getAutobanManager().setTimestamp(6, Server.getInstance().getCurrentTimestamp(), 3);\n         if(c.getChannel() == channel) {\n                 AutobanFactory.GENERAL.alert(c.getPlayer(), \"CCing to same channel.\");\n                 c.disconnect(false, false);"}, {"sha": "b08adf7649747c8ed45d17442be7701ace91322f", "filename": "src/net/server/channel/handlers/GrenadeEffectHandler.java", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/GrenadeEffectHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/GrenadeEffectHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GrenadeEffectHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,57 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.channel.handlers;\n+\n+import client.MapleClient;\n+import client.MapleCharacter;\n+import constants.skills.Gunslinger;\n+import constants.skills.NightWalker;\n+import net.AbstractMaplePacketHandler;\n+import tools.MaplePacketCreator;\n+import tools.data.input.SeekableLittleEndianAccessor;\n+import java.awt.Point;\n+import tools.FilePrinter;\n+\n+/*\n+ * @author GabrielSin\n+ */\n+public class GrenadeEffectHandler extends AbstractMaplePacketHandler {\n+ \n+    @Override\n+    public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        MapleCharacter chr = c.getPlayer();\n+        Point position = new Point(slea.readInt(), slea.readInt());\n+        int keyDown = slea.readInt();\n+        int skillId = slea.readInt();\n+       \n+        switch (skillId) {\n+            case NightWalker.POISON_BOMB:\n+            case Gunslinger.GRENADE:\n+                int skillLevel = chr.getSkillLevel(skillId);\n+                if (skillLevel > 0) {\n+                    chr.getMap().broadcastMessage(chr, MaplePacketCreator.throwGrenade(chr.getId(), position, keyDown, skillId, skillLevel), position);\n+                }\n+                break;\n+            default:\n+                FilePrinter.printError(FilePrinter.UNHANDLED_EVENT, \"The skill id: \" + skillId + \" is not coded in \" + this.getClass().getName() + \".\");\n+        }\n+    }\n+ \n+}\n\\ No newline at end of file"}, {"sha": "44204ddf7233cc33e0e7cddc172f53ded6b24cc1", "filename": "src/net/server/channel/handlers/HealOvertimeHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/HealOvertimeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/HealOvertimeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/HealOvertimeHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -38,12 +38,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         if(!chr.isLoggedinWorld()) return;\n         \n         AutobanManager abm = chr.getAutobanManager();\n-        int timestamp = (int) (Server.getInstance().getCurrentTime() - Server.uptime);\n+        int timestamp = Server.getInstance().getCurrentTimestamp();\n         slea.skip(8);\n         \n         short healHP = slea.readShort();\n         if (healHP != 0) {\n-            abm.setTimestamp(8, timestamp, 3);  // thanks Vcoc for pointing out d/c happening here\n+            abm.setTimestamp(8, timestamp, 4);  // thanks Vcoc for pointing out d/c happening here\n             if ((abm.getLastSpam(0) + 1500) > timestamp) AutobanFactory.FAST_HP_HEALING.addPoint(abm, \"Fast hp healing\");\n             \n             int abHeal = 120 + (int)(20 * MapleMapFactory.getMapRecoveryRate(chr.getMapId())); // Sleepywood sauna and showa spa...\n@@ -58,7 +58,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         short healMP = slea.readShort();\n         if (healMP != 0 && healMP < 1000) {\n-            abm.setTimestamp(9, timestamp, 3);\n+            abm.setTimestamp(9, timestamp, 4);\n             if ((abm.getLastSpam(1) + 1500) > timestamp) AutobanFactory.FAST_MP_HEALING.addPoint(abm, \"Fast mp healing\");\n             chr.addMP(healMP);\n             abm.spam(1, timestamp);"}, {"sha": "43ec9f437ea518c49cbd212ea277fc789722ccce", "filename": "src/net/server/channel/handlers/InventoryMergeHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/InventoryMergeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/InventoryMergeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/InventoryMergeHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -31,14 +31,16 @@\n import client.inventory.Item;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n+import net.server.Server;\n import server.MapleItemInformationProvider;\n \n public final class InventoryMergeHandler extends AbstractMaplePacketHandler {\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n-        chr.getAutobanManager().setTimestamp(2, slea.readInt(), 3);\n+        slea.readInt();\n+        chr.getAutobanManager().setTimestamp(2, Server.getInstance().getCurrentTimestamp(), 4);\n         \n         if(!ServerConstants.USE_ITEM_SORT) {\n             c.announce(MaplePacketCreator.enableActions());"}, {"sha": "8d6e30505dfc85a1dbe17fc1038b42cadccfaf1a", "filename": "src/net/server/channel/handlers/InventorySortHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/InventorySortHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/InventorySortHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/InventorySortHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -24,7 +24,6 @@\n import java.util.ArrayList;\n import java.util.List;\n \n-import constants.ServerConstants;\n import net.AbstractMaplePacketHandler;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -35,7 +34,9 @@\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.inventory.ModifyInventory;\n+import constants.ServerConstants;\n import server.MapleItemInformationProvider;\n+import net.server.Server;\n \n /**\n  *\n@@ -187,7 +188,8 @@ public PairedQuicksort(ArrayList<Item> A, int primarySort, int secondarySort) {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n-        chr.getAutobanManager().setTimestamp(3, slea.readInt(), 3);\n+        slea.readInt();\n+        chr.getAutobanManager().setTimestamp(3, Server.getInstance().getCurrentTimestamp(), 4);\n         \n         if(!ServerConstants.USE_ITEM_SORT) {\n             c.announce(MaplePacketCreator.enableActions());"}, {"sha": "1bc1acb6bb558d4f179c3fa0ab3d1e2d220d1a69", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 38, "deletions": 26, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -61,7 +61,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t}\n                 \n \t\tMapleMonster monster = (MapleMonster) mmo;\n-                List<MapleCharacter> banishPlayers = new LinkedList<>();\n+                List<MapleCharacter> banishPlayers = null;\n                 \n \t\tbyte pNibbles = slea.readByte();\n \t\tbyte rawActivity = slea.readByte();\n@@ -70,22 +70,25 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tshort pOption = slea.readShort();\n                 slea.skip(8);\n                 \n-\t\tif (rawActivity >= 0) {\n+                if (rawActivity >= 0) {\n \t\t\trawActivity = (byte) (rawActivity & 0xFF >> 1);\n \t\t}\n \n \t\tboolean isAttack = inRangeInclusive(rawActivity, 12, 20);\n \t\tboolean isSkill = inRangeInclusive(rawActivity, 21, 25);\n \n \t\tbyte attackId = (byte) (isAttack ? rawActivity - 12 : -1);\n-\t\tboolean nextMovementCouldBeSkill = (pNibbles & 0x0F) != 0;\n+                isSkill |= (pNibbles != 0);\n+                \n+\t\tboolean nextMovementCouldBeSkill = true;\n \t\tboolean pUnk = (pNibbles & 0xF0) != 0;\n                 \n                 boolean currentController = (monster.getController() == player);\n                 \n \t\tMobSkill toUse = null;\n                 int useSkillId = 0, useSkillLevel = 0;\n                 \n+                int rnd = 0;\n                 if (isSkill) {\n                         int noSkills = monster.getNoSkills();\n                         if (noSkills > 0) {\n@@ -95,21 +98,21 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 useSkillId = skillToUse.getLeft();\n                                 useSkillLevel = skillToUse.getRight();\n                                 toUse = MobSkillFactory.getMobSkill(useSkillId, useSkillLevel);\n-                        } else {\n+                                \n+                                rnd = rndSkill;\n                                 nextMovementCouldBeSkill = false;\n                         }\n-                } else {\n-                        nextMovementCouldBeSkill = false;\n                 }\n                 \n                 int mobMp;\n                 if (toUse != null && toUse.getHP() >= (int) (((float) monster.getHp() / monster.getMaxHp()) * 100) && monster.canUseSkill(toUse)) {\n                         mobMp = monster.getMp();\n-                    \n+                        \n                         int animationTime = MapleMonsterInformationProvider.getInstance().getMobSkillAnimationTime(toUse);\n-                        if(animationTime > 0) {\n-                                toUse.applyDelayedEffect(player, monster, true, banishPlayers, animationTime);\n+                        if(animationTime > 0 && toUse.getSkillId() != 129) {\n+                                toUse.applyDelayedEffect(player, monster, true, animationTime);\n                         } else {\n+                                banishPlayers = new LinkedList<>();\n                                 toUse.applyEffect(player, monster, true, banishPlayers);\n                         }\n                 } else {\n@@ -138,36 +141,45 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tshort start_y = slea.readShort(); // hmm...\n \t\tPoint startPos = new Point(start_x, start_y - 2);\n \t\tList<LifeMovementFragment> res = parseMovement(slea);\n-\t\tif (!currentController) {\n-\t\t\tif (monster.isAttackedBy(player)) {\n-\t\t\t\tmonster.switchController(player, true);\n-\t\t\t} else {\n-\t\t\t\treturn;\n-\t\t\t}\n-\t\t} else if (rawActivity == -1 && monster.isControllerKnowsAboutAggro() && !monster.isMobile() && !monster.isFirstAttack()) {\n-                        monster.setControllerHasAggro(false);\n-                        monster.setControllerKnowsAboutAggro(false);\n-\t\t}\n+\t\t\n+                boolean aggro;\n+                monster.lockMonster();\n+                try {\n+                        if (!currentController) {\n+                                if (monster.isAttackedBy(player)) {\n+                                        monster.switchController(player, true);\n+                                } else {\n+                                        return;\n+                                }\n+                        } else if (rawActivity == -1 && monster.isControllerKnowsAboutAggro() && !monster.isMobile() && !monster.isFirstAttack()) {\n+                                monster.setControllerHasAggro(false);\n+                                monster.setControllerKnowsAboutAggro(false);\n+                        }\n+\n+                        aggro = monster.isControllerHasAggro();\n+                        if (aggro) {\n+                                monster.setControllerKnowsAboutAggro(true);\n+                        }\n+                } finally {\n+                        monster.unlockMonster();\n+                }\n                 \n-\t\tboolean aggro = monster.isControllerHasAggro();\n                 if (toUse != null) {\n                         c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro, toUse.getSkillId(), toUse.getSkillLevel()));\n \t\t} else {\n \t\t\tc.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro));\n \t\t}\n                 \n-\t\tif (aggro) {\n-\t\t\tmonster.setControllerKnowsAboutAggro(true);\n-\t\t}\n-                \n \t\tif (res != null) {\n                         map.broadcastMessage(player, MaplePacketCreator.moveMonster(objectid, nextMovementCouldBeSkill, rawActivity, useSkillId, useSkillLevel, pOption, startPos, res), monster.getPosition());\n \t\t\tupdatePosition(res, monster, -2);\n \t\t\tmap.moveMonster(monster, monster.getPosition());\n \t\t}\n                 \n-                for (MapleCharacter chr : banishPlayers) {\n-                       chr.changeMapBanish(monster.getBanish().getMap(), monster.getBanish().getPortal(), monster.getBanish().getMsg());\n+                if (banishPlayers != null) {\n+                        for (MapleCharacter chr : banishPlayers) {\n+                               chr.changeMapBanish(monster.getBanish().getMap(), monster.getBanish().getPortal(), monster.getBanish().getMsg());\n+                        }\n                 }\n \t}\n "}, {"sha": "cc75179265449d3fb55b1f13c2f58fb377be53c2", "filename": "src/net/server/channel/handlers/PetCommandHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/PetCommandHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/PetCommandHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetCommandHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -54,8 +54,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         if (Randomizer.nextInt(101) <= petCommand.getProbability()) {\n             pet.gainClosenessFullness(chr, petCommand.getIncrease(), 0, command);\n+            chr.getMap().broadcastMessage(MaplePacketCreator.commandResponse(chr.getId(), petIndex, false, command, false));\n         } else {\n-            chr.getMap().broadcastMessage(MaplePacketCreator.commandResponse(chr.getId(), petIndex, command, false));\n+            chr.getMap().broadcastMessage(MaplePacketCreator.commandResponse(chr.getId(), petIndex, true, command, false));\n         }\n     }\n }"}, {"sha": "23e9b7f4b0f36c6c9e805d2bca59ae32c0df0eb0", "filename": "src/net/server/channel/handlers/PetFoodHandler.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/PetFoodHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/PetFoodHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetFoodHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -21,15 +21,16 @@\n  */\n package net.server.channel.handlers;\n \n+import net.AbstractMaplePacketHandler;\n import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.inventory.MaplePet;\n import client.autoban.AutobanManager;\n import client.inventory.Item;\n-import net.AbstractMaplePacketHandler;\n import client.inventory.manipulator.MapleInventoryManipulator;\n+import net.server.Server;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n@@ -44,7 +45,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         abm.spam(2);\n-        abm.setTimestamp(1, slea.readInt(), 3);\n+        slea.readInt(); // timestamp issue detected thanks to Masterrulax\n+        abm.setTimestamp(1, Server.getInstance().getCurrentTimestamp(), 3);\n         if (chr.getNoPets() == 0) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;"}, {"sha": "b432d75e1e7e7d1244f69de5bfc449f4d408bfab", "filename": "src/net/server/channel/handlers/RangedAttackHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/RangedAttackHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/RangedAttackHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RangedAttackHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -163,7 +163,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         }\n                     }\n                 }\n-            }\n+            }            \n             boolean soulArrow = chr.getBuffedValue(MapleBuffStat.SOULARROW) != null;\n             boolean shadowClaw = chr.getBuffedValue(MapleBuffStat.SHADOW_CLAW) != null;\n             if (projectile != 0) {\n@@ -179,7 +179,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n             }\n             \n-            if (projectile != 0 || soulArrow || attack.skill == 11101004 || attack.skill == 15111007 || attack.skill == 14101006 || attack.skill == 4111004) {\n+            if (projectile != 0 || soulArrow || attack.skill == 11101004 || attack.skill == 15111007 || attack.skill == 14101006 || attack.skill == 4111004 || attack.skill == 13101005) {\n             \tint visProjectile = projectile; //visible projectile sent to players\n                 if (ItemConstants.isThrowingStar(projectile)) {\n                     MapleInventory cash = chr.getInventory(MapleInventoryType.CASH);\n@@ -192,7 +192,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             }\n                         }\n                     }\n-                } else if (soulArrow || attack.skill == 3111004 || attack.skill == 3211004 || attack.skill == 11101004 || attack.skill == 15111007 || attack.skill == 14101006) {\n+                } else if (soulArrow || attack.skill == 3111004 || attack.skill == 3211004 || attack.skill == 11101004 || attack.skill == 15111007 || attack.skill == 14101006 || attack.skill == 13101005) {\n                     visProjectile = 0;\n                 }\n                 "}, {"sha": "98a7511ed14acb6a019903eb6e91d60b4b6d9b46", "filename": "src/net/server/channel/handlers/ScriptedItemHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/ScriptedItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/ScriptedItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ScriptedItemHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -49,7 +49,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         if (item == null || item.getItemId() != itemId || item.getQuantity() < 1 || !ism.scriptExists(info.getScript())) {\n             return;\n         }\n-        ism.getItemScript(c, info.getScript());\n+        ism.runItemScript(c, info.getScript());\n         c.announce(MaplePacketCreator.enableActions());\n         //NPCScriptManager.getInstance().start(c, info.getNpc(), null, null);        \n     }"}, {"sha": "6b72dbcd7604837b813dc44fd76fe06529822a97", "filename": "src/net/server/channel/handlers/SpecialMoveHandler.java", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/SpecialMoveHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/SpecialMoveHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SpecialMoveHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -30,7 +30,6 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleCharacter;\n import client.MapleClient;\n-import client.MapleStat;\n import client.Skill;\n import client.SkillFactory;\n import constants.ServerConstants;\n@@ -41,14 +40,15 @@\n import constants.skills.Paladin;\n import constants.skills.Priest;\n import constants.skills.SuperGM;\n-\n+import net.server.Server;\n \n public final class SpecialMoveHandler extends AbstractMaplePacketHandler {\n     \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n     \tMapleCharacter chr = c.getPlayer();\n-        chr.getAutobanManager().setTimestamp(4, slea.readInt(), 3);\n+        slea.readInt();\n+        chr.getAutobanManager().setTimestamp(4, Server.getInstance().getCurrentTimestamp(), 5);\n         int skillid = slea.readInt();\n         \n         /*\n@@ -99,9 +99,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 chr.getMap().broadcastMessage(chr, MaplePacketCreator.showMagnet(mobId, success), false);\n                 MapleMonster monster = chr.getMap().getMonsterByOid(mobId);\n                 if (monster != null) {\n-                \tif (!monster.isBoss()) {\n-                \t\tmonster.switchController(chr, monster.isControllerHasAggro());\n-                \t}\n+                    if (!monster.isBoss()) {\n+                        monster.lockMonster();\n+                        try {\n+                            monster.switchController(chr, monster.isControllerHasAggro());\n+                        } finally {\n+                            monster.unlockMonster();\n+                        }\n+                    }\n                 }\n             }\n             byte direction = slea.readByte();"}, {"sha": "a5685f34a3a1663d571243ae77a5eda4fa656d85", "filename": "src/net/server/channel/handlers/TouchReactorHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/TouchReactorHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/TouchReactorHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TouchReactorHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -32,6 +32,8 @@\n  * @author Generic\n  */\n public final class TouchReactorHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int oid = slea.readInt();\n         MapleReactor reactor = c.getPlayer().getMap().getReactorByOid(oid);"}, {"sha": "753fefbe68dad013b5c2f034c3a97c5a02d49ab5", "filename": "src/net/server/channel/handlers/UseCatchItemHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/UseCatchItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/UseCatchItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCatchItemHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -27,6 +27,7 @@\n import client.autoban.AutobanManager;\n import constants.ItemConstants;\n import net.AbstractMaplePacketHandler;\n+import net.server.Server;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import server.life.MapleMonster;\n import tools.MaplePacketCreator;\n@@ -41,7 +42,8 @@\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         AutobanManager abm = chr.getAutobanManager();\n-        abm.setTimestamp(5, slea.readInt(), 3);\n+        slea.readInt();\n+        abm.setTimestamp(5, Server.getInstance().getCurrentTimestamp(), 4);\n         slea.readShort();\n         int itemId = slea.readInt();\n         int monsterid = slea.readInt();"}, {"sha": "ac5df671488bc9d2ccec827e45efaa2f25a2fd7d", "filename": "src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -35,7 +35,6 @@\n /**\n  * @author Ronan\n  */\n-\n public final class UseOwlOfMinervaHandler extends AbstractMaplePacketHandler {\n \n     @Override"}, {"sha": "13017a5a17b1af496ccb461892899d03e7d4e0a4", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1402,7 +1402,9 @@ public void runMountSchedule() {\n             \n             int dpVal = dp.getValue() + 1;\n             if(dpVal == ServerConstants.MOUNT_EXHAUST_COUNT) {\n-                chr.runTirednessSchedule();\n+                if (!chr.runTirednessSchedule()) {\n+                    continue;\n+                }\n                 dpVal = 0;\n             }\n             "}, {"sha": "fedd040262abb4afa22345d6417b196254df409a", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -512,21 +512,21 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n                                 petId = MaplePet.createPet(id);\n \n                                 if(from != null) {\n-                                    evolved = MaplePet.loadFromDb(id, (short) 0, petId);\n-\n-                                    Point pos = getPlayer().getPosition();\n-                                    pos.y -= 12;\n-                                    evolved.setPos(pos);\n-                                    evolved.setFh(getPlayer().getMap().getFootholds().findBelow(evolved.getPos()).getId());\n-                                    evolved.setStance(0);\n-                                    evolved.setSummoned(true);\n-\n-                                    evolved.setName(from.getName().compareTo(MapleItemInformationProvider.getInstance().getName(from.getItemId())) != 0 ? from.getName() : MapleItemInformationProvider.getInstance().getName(id));\n-                                    evolved.setCloseness(from.getCloseness());\n-                                    evolved.setFullness(from.getFullness());\n-                                    evolved.setLevel(from.getLevel());\n-                                    evolved.setExpiration(System.currentTimeMillis() + expires);\n-                                    evolved.saveToDb();\n+                                        evolved = MaplePet.loadFromDb(id, (short) 0, petId);\n+\n+                                        Point pos = getPlayer().getPosition();\n+                                        pos.y -= 12;\n+                                        evolved.setPos(pos);\n+                                        evolved.setFh(getPlayer().getMap().getFootholds().findBelow(evolved.getPos()).getId());\n+                                        evolved.setStance(0);\n+                                        evolved.setSummoned(true);\n+\n+                                        evolved.setName(from.getName().compareTo(MapleItemInformationProvider.getInstance().getName(from.getItemId())) != 0 ? from.getName() : MapleItemInformationProvider.getInstance().getName(id));\n+                                        evolved.setCloseness(from.getCloseness());\n+                                        evolved.setFullness(from.getFullness());\n+                                        evolved.setLevel(from.getLevel());\n+                                        evolved.setExpiration(System.currentTimeMillis() + expires);\n+                                        evolved.saveToDb();\n                                 }\n \n                                 //MapleInventoryManipulator.addById(c, id, (short) 1, null, petId, expires == -1 ? -1 : System.currentTimeMillis() + expires);"}, {"sha": "e04da80608281fdefed46b675cfb19611709cee7", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 161, "deletions": 264, "changes": 425, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -69,6 +69,7 @@\n import scripting.AbstractPlayerInteraction;\n import scripting.event.worker.EventScriptScheduler;\n import server.MapleItemInformationProvider;\n+import server.ThreadManager;\n import server.life.MapleLifeFactory;\n import server.life.MapleNPC;\n import tools.MaplePacketCreator;\n@@ -228,51 +229,42 @@ public void giveEventPlayersMeso(int gain, int mapId) {\n                 \n \t}\n \n-\tpublic synchronized void registerPlayer(MapleCharacter chr) {\n+\tpublic synchronized void registerPlayer(final MapleCharacter chr) {\n \t\tif (chr == null || !chr.isLoggedinWorld() || disposed) {\n \t\t\treturn;\n \t\t}\n                 \n+                wL.lock();\n                 try {\n-                        wL.lock();\n-                        try {\n-                                if(chars.containsKey(chr.getId())) {\n-                                        return;\n-                                }\n-                                \n-                                chars.put(chr.getId(), chr);\n-                                chr.setEventInstance(this);\n-                        } finally {\n-                                wL.unlock();\n+                        if(chars.containsKey(chr.getId())) {\n+                                return;\n                         }\n-                        \n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerEntry\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\n+                        chars.put(chr.getId(), chr);\n+                        chr.setEventInstance(this);\n+                } finally {\n+                        wL.unlock();\n+                }\n+                \n+                try {\n+                        em.getIv().invokeFunction(\"playerEntry\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}  \n         \n-        public void exitPlayer(MapleCharacter chr) {\n+        public void exitPlayer(final MapleCharacter chr) {\n \t\tif (chr == null || !chr.isLoggedin()){\n \t\t\treturn;\n \t\t}\n-\t\ttry {\n-\t\t\tunregisterPlayer(chr);\n-                        \n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerExit\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\t\t\n+                unregisterPlayer(chr);\n+                \n+                try {\n+                        em.getIv().invokeFunction(\"playerExit\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n         \n         public void dropMessage(int type, String message) {\n@@ -297,15 +289,10 @@ public void startEventTimer(long time) {\n                 event_schedule = TimerManager.getInstance().schedule(new Runnable() {\n                         @Override\n                         public void run() {\n+                                dismissEventTimer();\n+                                \n                                 try {\n-                                        dismissEventTimer();\n-                                        \n-                                        sL.lock();\n-                                        try {\n-                                                em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n-                                        } finally {\n-                                                sL.unlock();\n-                                        }\n+                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement scheduledTimeout function.\", ex);\n                                 }\n@@ -314,31 +301,25 @@ public void run() {\n \t}\n         \n         public void addEventTimer(long time) {\n-                if(event_schedule != null) {\n-                        if(event_schedule.cancel(false)) {\n+                if (event_schedule != null) {\n+                        if (event_schedule.cancel(false)) {\n                                 long nextTime = getTimeLeft() + time;\n                                 eventTime += time;\n \n                                 event_schedule = TimerManager.getInstance().schedule(new Runnable() {\n                                         @Override\n                                         public void run() {\n+                                                dismissEventTimer();\n+\n                                                 try {\n-                                                        dismissEventTimer();\n-                                                        \n-                                                        sL.lock();\n-                                                        try {\n-                                                                em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n-                                                        } finally {\n-                                                                sL.unlock();\n-                                                        }\n+                                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement scheduledTimeout function.\", ex);\n                                                 }\n                                         }\n                                 }, nextTime);\n                         }\n-                }\n-                else {\n+                } else {\n                         startEventTimer(time);\n                 }\n         }\n@@ -358,6 +339,7 @@ public void stopEventTimer() {\n                         event_schedule.cancel(false);\n                         event_schedule = null;\n                 }\n+                \n                 dismissEventTimer();\n         }\n         \n@@ -370,7 +352,7 @@ public long getTimeLeft() {\n \t}\n \n         public void registerParty(MapleCharacter chr) {\n-                if(chr.isPartyLeader()) {\n+                if (chr.isPartyLeader()) {\n                         registerParty(chr.getParty(), chr.getMap());\n                 }\n         }\n@@ -390,20 +372,16 @@ public void registerExpedition(MapleExpedition exped) {\n         private void registerExpeditionTeam(MapleExpedition exped, int recruitMap) {\n \t\texpedition = exped;\n                 \n-                for(MapleCharacter chr: exped.getMembers()) {\n-                        if(chr.getMapId() == recruitMap)\n+                for (MapleCharacter chr: exped.getMembers()) {\n+                        if (chr.getMapId() == recruitMap) {\n                                 registerPlayer(chr);\n+                        }\n                 }\n \t}\n \n-\tpublic void unregisterPlayer(MapleCharacter chr) {\n+\tpublic void unregisterPlayer(final MapleCharacter chr) {\n                 try {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerUnregistered\", EventInstanceManager.this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n+                        em.getIv().invokeFunction(\"playerUnregistered\", EventInstanceManager.this, chr);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, \"Event '\" + em.getName() + \"' does not implement playerUnregistered function.\", ex);\n                 }\n@@ -462,180 +440,140 @@ public void registerMonster(MapleMonster mob) {\n \t\t}\n \t}\n \n-\tpublic void movePlayer(MapleCharacter chr) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"moveMap\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\tpublic void movePlayer(final MapleCharacter chr) {\n+                try {\n+                        em.getIv().invokeFunction(\"moveMap\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n         \n-        public void changedMap(MapleCharacter chr, int mapId) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"changedMap\", this, chr, mapId);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {} // optional\n+        public void changedMap(final MapleCharacter chr, final int mapId) {\n+                try {\n+                        em.getIv().invokeFunction(\"changedMap\", EventInstanceManager.this, chr, mapId);\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n-        public void afterChangedMap(MapleCharacter chr, int mapId) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"afterChangedMap\", this, chr, mapId);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {} // optional\n+        public void afterChangedMap(final MapleCharacter chr, final int mapId) {\n+                try {\n+                        em.getIv().invokeFunction(\"afterChangedMap\", EventInstanceManager.this, chr, mapId);\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n-        public void changedLeader(MapleCharacter ldr) {\n+        public synchronized void changedLeader(final MapleCharacter ldr) {\n                 try {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"changedLeader\", this, ldr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n-                \n+                        em.getIv().invokeFunction(\"changedLeader\", EventInstanceManager.this, ldr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n+\t\t\n                 leaderId = ldr.getId();\n \t}\n \t\n-\tpublic void monsterKilled(MapleMonster mob, boolean hasKiller) {\n+\tpublic void monsterKilled(final MapleMonster mob, final boolean hasKiller) {\n+                int scriptResult = 0;\n+                \n \t\tsL.lock();\n                 try {\n                         mobs.remove(mob);\n                         \n                         if(eventStarted) {\n-                                try {\n-                                        em.getIv().invokeFunction(\"monsterKilled\", mob, this, hasKiller);\n-                                } catch (ScriptException | NoSuchMethodException ex) {\n-                                        ex.printStackTrace();\n-                                }\n+                                scriptResult = 1;\n \n                                 if (mobs.isEmpty()) {\n-                                        try {\n-                                                em.getIv().invokeFunction(\"allMonstersDead\", this, hasKiller);\n-                                        } catch (ScriptException | NoSuchMethodException ex) {\n-                                                ex.printStackTrace();\n-                                        }\n+                                        scriptResult = 2;\n                                 }\n                         }\n                 } finally {\n                         sL.unlock();\n                 }\n-        }\n-        \n-        public void friendlyKilled(MapleMonster mob, boolean hasKiller) {\n-\t\ttry {\n-                        sL.lock();\n+                \n+                if (scriptResult > 0) {\n                         try {\n-                                em.getIv().invokeFunction(\"friendlyKilled\", mob, this, hasKiller);\n-                        } finally {\n-                                sL.unlock();\n+                                em.getIv().invokeFunction(\"monsterKilled\", mob, EventInstanceManager.this, hasKiller);\n+                        } catch (ScriptException | NoSuchMethodException ex) {\n+                                ex.printStackTrace();\n+                        }\n+                        \n+                        if (scriptResult > 1) {\n+                                try {\n+                                        em.getIv().invokeFunction(\"allMonstersDead\", EventInstanceManager.this, hasKiller);\n+                                } catch (ScriptException | NoSuchMethodException ex) {\n+                                        ex.printStackTrace();\n+                                }\n                         }\n+                }\n+        }\n+        \n+        public void friendlyKilled(final MapleMonster mob, final boolean hasKiller) {\n+                try {\n+                        em.getIv().invokeFunction(\"friendlyKilled\", mob, EventInstanceManager.this, hasKiller);\n                 } catch (ScriptException | NoSuchMethodException ex) {} //optional\n \t}\n \n-\tpublic void playerKilled(MapleCharacter chr) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerDead\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n+\tpublic void playerKilled(final MapleCharacter chr) {\n+                ThreadManager.getInstance().newTask(new Runnable() {\n+                        @Override\n+                        public void run() {\n+                                try {\n+                                        em.getIv().invokeFunction(\"playerDead\", EventInstanceManager.this, chr);\n+                                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n                         }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {} // optional\n+                });\n \t}\n \n-        public void reviveMonster(MapleMonster mob) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"monsterRevive\", this, mob);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {} // optional\n+        public void reviveMonster(final MapleMonster mob) {\n+                try {\n+                        em.getIv().invokeFunction(\"monsterRevive\", EventInstanceManager.this, mob);\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n \t}\n         \n-\tpublic boolean revivePlayer(MapleCharacter chr) {\n-\t\ttry {\n-                        Object b;\n-                    \n-                        sL.lock();\n-                        try {\n-                                b = em.getIv().invokeFunction(\"playerRevive\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n+\tpublic boolean revivePlayer(final MapleCharacter chr) {\n+                try {\n+                        Object b = em.getIv().invokeFunction(\"playerRevive\", EventInstanceManager.this, chr);\n+                        if (b instanceof Boolean) {\n+                                return (Boolean) b;\n                         }\n-                    \n-\t\t\tif (b instanceof Boolean) {\n-\t\t\t\treturn (Boolean) b;\n-\t\t\t}\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {} // optional\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n                 \n \t\treturn true;\n \t}\n         \n-\tpublic void playerDisconnected(MapleCharacter chr) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerDisconnected\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\tpublic void playerDisconnected(final MapleCharacter chr) {\n+                try {\n+                        em.getIv().invokeFunction(\"playerDisconnected\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n                 \n                 MapleEventRecallCoordinator.getInstance().storeEventInstance(chr.getId(), this);\n \t}\n-\n-\t/**\n-\t *\n-\t * @param chr\n-\t * @param mob\n-\t */\n-\tpublic void monsterKilled(MapleCharacter chr, MapleMonster mob) {\n-\t\ttry {\n-\t\t\tInteger kc = killCount.get(chr);\n+        \n+\tpublic void monsterKilled(MapleCharacter chr, final MapleMonster mob) {\n+                try {\n                         int inc;\n                         \n-                        sL.lock();\n-                        try {\n-                            if(ServerConstants.JAVA_8)\n-                                  inc = (int)em.getIv().invokeFunction(\"monsterValue\", this, mob.getId());\n-                            else\n-                                   inc = ((Double) em.getIv().invokeFunction(\"monsterValue\", this, mob.getId())).intValue();\n-                        } finally {\n-                                sL.unlock();\n+                        if (ServerConstants.JAVA_8) {\n+                                inc = (int)em.getIv().invokeFunction(\"monsterValue\", EventInstanceManager.this, mob.getId());\n+                        } else {\n+                                inc = ((Double) em.getIv().invokeFunction(\"monsterValue\", EventInstanceManager.this, mob.getId())).intValue();\n                         }\n                         \n-\t\t\tif (kc == null) {\n-\t\t\t\tkc = inc;\n-\t\t\t} else {\n-\t\t\t\tkc += inc;\n-\t\t\t}\n-\t\t\tkillCount.put(chr, kc);\n-\t\t\tif (expedition != null){\n-\t\t\t\texpedition.monsterKilled(chr, mob);\n-\t\t\t}\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+                        if (inc != 0) {\n+                                Integer kc = killCount.get(chr);\n+                                if (kc == null) {\n+                                        kc = inc;\n+                                } else {\n+                                        kc += inc;\n+                                }\n+                                killCount.put(chr, kc);\n+                                if (expedition != null){\n+                                        expedition.monsterKilled(chr, mob);\n+                                }\n+                        }\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n \n \tpublic int getKillCount(MapleCharacter chr) {\n@@ -650,32 +588,20 @@ public void dispose() {\n                 } finally {\n                         rL.unlock();\n                 }\n-            \n-                Thread t = new Thread( new Runnable() {\n-                        @Override\n-                        public void run() {\n-                                dispose(false);\n-                        }\n-                });\n                 \n-                t.start();\n+                dispose(false);\n         }\n         \n         public synchronized void dispose(boolean shutdown) {    // should not trigger any event script method after disposed\n                 if(disposed) return;\n                 \n                 disposed = true;\n                 try {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"dispose\", this);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n+                        em.getIv().invokeFunction(\"dispose\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }\n-\n+                \n                 mapFactory.dispose();\n                 ess.dispose();\n                 \n@@ -738,13 +664,8 @@ public void schedule(final String methodName, long delay) {\n                                         @Override\n                                         public void run() {\n                                                 try {\n-                                                        sL.lock();\n-                                                        try {\n-                                                               if(em == null) return;\n-                                                               em.getIv().invokeFunction(methodName, EventInstanceManager.this);\n-                                                        } finally {\n-                                                                sL.unlock();\n-                                                        }\n+                                                        if(em == null) return;\n+                                                        em.getIv().invokeFunction(methodName, EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         ex.printStackTrace();\n                                                 }\n@@ -848,56 +769,36 @@ public int getIntProperty(String key) {\n                 }\n         }\n \t\n-\tpublic void leftParty(MapleCharacter chr) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"leftParty\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\tpublic void leftParty(final MapleCharacter chr) {\n+                try {\n+                        em.getIv().invokeFunction(\"leftParty\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n \n \tpublic void disbandParty() {\n \t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"disbandParty\", this);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+                        em.getIv().invokeFunction(\"disbandParty\", EventInstanceManager.this);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n \n \tpublic void clearPQ() {\n                 try {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"clearPQ\", this);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+                        em.getIv().invokeFunction(\"clearPQ\", EventInstanceManager.this);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n \n-\tpublic void removePlayer(MapleCharacter chr) {\n-\t\ttry {\n-                        sL.lock();\n-                        try {\n-                                em.getIv().invokeFunction(\"playerExit\", this, chr);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n-\t\t} catch (ScriptException | NoSuchMethodException ex) {\n-\t\t\tex.printStackTrace();\n-\t\t}\n+\tpublic void removePlayer(final MapleCharacter chr) {\n+                try {\n+                        em.getIv().invokeFunction(\"playerExit\", EventInstanceManager.this, chr);\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n \t}\n \n \tpublic boolean isLeader(MapleCharacter chr) {\n@@ -1158,15 +1059,11 @@ private void disposeExpedition() {\n                 }\n         }\n         \n-        public final void startEvent() {\n+        public final synchronized void startEvent() {\n+                eventStarted = true;\n+                \n                 try {\n-                        sL.lock();\n-                        try {\n-                                eventStarted = true;\n-                                em.getIv().invokeFunction(\"afterSetup\", this);\n-                        } finally {\n-                                sL.unlock();\n-                        }\n+                        em.getIv().invokeFunction(\"afterSetup\", EventInstanceManager.this);\n                 } catch (ScriptException | NoSuchMethodException ex) {\n                         ex.printStackTrace();\n                 }"}, {"sha": "9b365e95dd4d3b3808dab744939dd657c790a765", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -60,6 +60,8 @@\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.ThreadManager;\n+//import jdk.nashorn.api.scripting.ScriptUtils;\n \n /**\n  *\n@@ -647,12 +649,11 @@ public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr,\n             if(p != null) {\n                 List<MaplePartyCharacter> lmpc;\n                 \n-                /*\n-                if(ServerConstants.JAVA_8)\n+                /*if(ServerConstants.JAVA_8) {\n                     lmpc = new ArrayList<>(((Map<String, MaplePartyCharacter>)(ScriptUtils.convert(p, Map.class))).values());\n-                else\n+                } else {\n                     lmpc = new ArrayList<>((List<MaplePartyCharacter>) p);\n-                */\n+                }*/\n                 \n                 lmpc = new ArrayList<>((List<MaplePartyCharacter>) p);\n                 party.setEligibleMembers(lmpc);\n@@ -809,8 +810,7 @@ public int getTransportationTime(int travelTime) {\n     }\n     \n     private void fillEimQueue() {\n-        Thread t = new Thread(new EventManagerWorker());  //call new thread to fill up readied instances queue\n-        t.start();\n+        ThreadManager.getInstance().newTask(new EventManagerWorker());  //call new thread to fill up readied instances queue\n     }\n     \n     private EventInstanceManager getReadyInstance() {"}, {"sha": "c762ae5b0736a083c282ea56485fd8e4ce4391a7", "filename": "src/scripting/event/worker/EventScriptScheduler.java", "status": "modified", "additions": 46, "deletions": 51, "changes": 97, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/worker/EventScriptScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/event/worker/EventScriptScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/worker/EventScriptScheduler.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -32,6 +32,7 @@\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n+import server.ThreadManager;\n \n /**\n  *\n@@ -105,68 +106,62 @@ private void runBaseSchedule() {\n     \n     public void registerEntry(final Runnable scheduledAction, final long duration) {\n         \n-        Thread t = new Thread(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            schedulerLock.lock();\n-                            try {\n-                                idleProcs = 0;\n-                                if(schedulerTask == null) {\n-                                    if(disposed) return;\n+        ThreadManager.getInstance().newTask(new Runnable() {\n+            @Override\n+            public void run() {\n+                schedulerLock.lock();\n+                try {\n+                    idleProcs = 0;\n+                    if(schedulerTask == null) {\n+                        if(disposed) return;\n \n-                                    schedulerTask = TimerManager.getInstance().register(monitorTask, ServerConstants.MOB_STATUS_MONITOR_PROC, ServerConstants.MOB_STATUS_MONITOR_PROC);\n-                                }\n+                        schedulerTask = TimerManager.getInstance().register(monitorTask, ServerConstants.MOB_STATUS_MONITOR_PROC, ServerConstants.MOB_STATUS_MONITOR_PROC);\n+                    }\n \n-                                registeredEntries.put(scheduledAction, Server.getInstance().getCurrentTime() + duration);\n-                            } finally {\n-                                schedulerLock.unlock();\n-                            }\n-                        }\n-                    });\n-        \n-        t.start();\n+                    registeredEntries.put(scheduledAction, Server.getInstance().getCurrentTime() + duration);\n+                } finally {\n+                    schedulerLock.unlock();\n+                }\n+            }\n+        });\n     }\n     \n     public void cancelEntry(final Runnable scheduledAction) {\n         \n-        Thread t = new Thread(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            schedulerLock.lock();\n-                            try {\n-                                registeredEntries.remove(scheduledAction);\n-                            } finally {\n-                                schedulerLock.unlock();\n-                            }\n-                        }\n-                    });\n-        \n-        t.start();\n+        ThreadManager.getInstance().newTask(new Runnable() {\n+            @Override\n+            public void run() {\n+                schedulerLock.lock();\n+                try {\n+                    registeredEntries.remove(scheduledAction);\n+                } finally {\n+                    schedulerLock.unlock();\n+                }\n+            }\n+        });\n     }\n     \n     public void dispose() {\n         \n-        Thread t = new Thread(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            schedulerLock.lock();\n-                            try {\n-                                if(schedulerTask != null) {\n-                                    schedulerTask.cancel(false);\n-                                    schedulerTask = null;\n-                                }\n+        ThreadManager.getInstance().newTask(new Runnable() {\n+            @Override\n+            public void run() {\n+                schedulerLock.lock();\n+                try {\n+                    if(schedulerTask != null) {\n+                        schedulerTask.cancel(false);\n+                        schedulerTask = null;\n+                    }\n \n-                                registeredEntries.clear();\n-                                disposed = true;\n-                            } finally {\n-                                schedulerLock.unlock();\n-                            }\n-                            \n-                            disposeLocks();\n-                        }\n-                    });\n-        \n-        t.start();\n+                    registeredEntries.clear();\n+                    disposed = true;\n+                } finally {\n+                    schedulerLock.unlock();\n+                }\n+\n+                disposeLocks();\n+            }\n+        });\n     }\n     \n     private void disposeLocks() {"}, {"sha": "c001a879e60a592043e53893fb7b62bd8b90ad4f", "filename": "src/scripting/item/ItemScriptManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/item/ItemScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/item/ItemScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/item/ItemScriptManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -59,7 +59,7 @@ public boolean scriptExists(String scriptName) {\n         return scriptFile.exists();\n     }\n \n-    public void getItemScript(MapleClient c, String scriptName) {\n+    public void runItemScript(MapleClient c, String scriptName) {\n         if (scripts.containsKey(scriptName)) {\n             try {\n                 scripts.get(scriptName).invokeFunction(\"start\", new ItemScriptMethods(c));"}, {"sha": "a17239dfe06804ba9d2220a96e9d2a119e58e95e", "filename": "src/scripting/map/MapScriptManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/map/MapScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/scripting/map/MapScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/map/MapScriptManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -62,7 +62,7 @@ public boolean scriptExists(String scriptName, boolean firstUser) {\n         return scriptFile.exists();\n     }\n \n-    public void getMapScript(MapleClient c, String scriptName, boolean firstUser) {\n+    public void runMapScript(MapleClient c, String scriptName, boolean firstUser) {\n         if (scripts.containsKey(scriptName)) {\n             try {\n                 scripts.get(scriptName).invokeFunction(\"start\", new MapScriptMethods(c));"}, {"sha": "6b729d6c8a2e7c84eff4f7c1d1460094804a7758", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -646,7 +646,7 @@ private static double testYourLuck(double prop, int dices) {   // revamped testY\n     }\n     \n     public static boolean rollSuccessChance(double prop) {\n-        return Math.random() > testYourLuck(prop / 100.0, ServerConstants.SCROLL_CHANCE_RATE);\n+        return Math.random() >= testYourLuck(prop / 100.0, ServerConstants.SCROLL_CHANCE_RATE);\n     }\n     \n     private static short getMaximumShortMaxIfOverflow(int value1, int value2) {\n@@ -1238,9 +1238,11 @@ public boolean isLootRestricted(int itemId) {\n         boolean bRestricted = false;\n         if(itemId != 0) {\n             MapleData data = getItemData(itemId);\n-            bRestricted = MapleDataTool.getIntConvert(\"info/tradeBlock\", data, 0) == 1;\n-            if (!bRestricted) {\n-                bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n+            if (data != null) {\n+                bRestricted = MapleDataTool.getIntConvert(\"info/tradeBlock\", data, 0) == 1;\n+                if (!bRestricted) {\n+                    bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n+                }\n             }\n         }\n         "}, {"sha": "427881d56afba333ff1e1dc4e6ad5f7925788340", "filename": "src/server/ThreadManager.java", "status": "added", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/ThreadManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/ThreadManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/ThreadManager.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -0,0 +1,72 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server;\n+\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.RejectedExecutionHandler;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class ThreadManager {\n+    private static ThreadManager instance = new ThreadManager();\n+    \n+    public static ThreadManager getInstance() {\n+        return instance;\n+    }\n+    \n+    private ThreadPoolExecutor tpe;\n+    \n+    private ThreadManager() {}\n+    \n+    private class RejectedExecutionHandlerImpl implements RejectedExecutionHandler {\n+\n+        @Override\n+        public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {\n+            Thread t = new Thread(r);\n+            t.start();\n+        }\n+\n+    }\n+    \n+    public void newTask(Runnable r) {\n+        tpe.execute(r);\n+    }\n+    \n+    public void start() {\n+        RejectedExecutionHandler reh = new RejectedExecutionHandlerImpl();\n+        ThreadFactory tf = Executors.defaultThreadFactory();\n+        \n+        tpe = new ThreadPoolExecutor(20, 1000, 77, TimeUnit.SECONDS, new ArrayBlockingQueue<Runnable>(50), tf, reh);\n+    }\n+    \n+    public void stop() {\n+        tpe.shutdown();\n+        try {\n+            tpe.awaitTermination(5, TimeUnit.MINUTES);\n+        } catch (InterruptedException ie) {}\n+    }\n+    \n+}"}, {"sha": "58af15616e4bb9b27ba7ae81641666fb84e61ff2", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 59, "deletions": 28, "changes": 87, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -573,15 +573,28 @@ private void giveExpToCharacter(MapleCharacter attacker, float exp, boolean isKi\n         }\n     }\n \n+    private void removeController() {\n+        this.lockMonster();\n+        try {\n+            MapleCharacter chrController = getController();\n+            if (chrController != null) { // this can/should only happen when a hidden gm attacks the monster\n+                chrController.announce(MaplePacketCreator.stopControllingMonster(this.getObjectId()));\n+                chrController.stopControllingMonster(this);\n+            }\n+            \n+            setController(null);\n+            setControllerHasAggro(false);\n+            setControllerKnowsAboutAggro(false);\n+        } finally {\n+            this.unlockMonster();\n+        }\n+    }\n+    \n     public MapleCharacter killBy(final MapleCharacter killer) {\n         distributeExperience(killer != null ? killer.getId() : 0);\n-\n-        MapleCharacter chrController = getController();\n-        if (chrController != null) { // this can/should only happen when a hidden gm attacks the monster\n-            chrController.announce(MaplePacketCreator.stopControllingMonster(this.getObjectId()));\n-            chrController.stopControllingMonster(this);\n-        }\n-\n+        \n+        removeController();\n+        \n         final List<Integer> toSpawn = this.getRevives(); // this doesn't work (?)\n         if (toSpawn != null) {\n             final MapleMap reviveMap = map;\n@@ -647,8 +660,9 @@ public void run() {\n                                     }\n                                 }\n                                 \n-                                for(int i = 8810017; i >= 8810010; i--)\n+                                for(int i = 8810017; i >= 8810010; i--) {\n                                     reviveMap.killMonster(reviveMap.getMonsterById(i), killer, true);\n+                                }\n                             }\n                             \n                             if(eim != null) {\n@@ -787,20 +801,24 @@ public void setController(MapleCharacter controller) {\n     }\n \n     public void switchController(MapleCharacter newController, boolean immediateAggro) {\n-        MapleCharacter controllers = getController();\n-        if (controllers == newController) {\n-            return;\n-        }\n-        if (controllers != null) {\n-            controllers.stopControllingMonster(this);\n-            controllers.getClient().announce(MaplePacketCreator.stopControllingMonster(getObjectId()));\n-        }\n-        newController.controlMonster(this, immediateAggro);\n-        setController(newController);\n-        if (immediateAggro) {\n-            setControllerHasAggro(true);\n+        this.lockMonster();\n+        try {\n+            MapleCharacter controllers = getController();\n+            if (controllers == newController) {\n+                return;\n+            }\n+            \n+            removeController();\n+            \n+            newController.controlMonster(this, immediateAggro);\n+            setController(newController);\n+            if (immediateAggro) {\n+                setControllerHasAggro(true);\n+            }\n+            setControllerKnowsAboutAggro(false);\n+        } finally {\n+            this.unlockMonster();\n         }\n-        setControllerKnowsAboutAggro(false);\n     }\n \n     public void addListener(MonsterListener listener) {\n@@ -863,28 +881,29 @@ public boolean hasBossHPBar() {\n     }\n     \n     @Override\n-    public void sendSpawnData(MapleClient c) {\n-        if (!isAlive()) {\n+    public void sendSpawnData(MapleClient client) {\n+        if (hp.get() <= 0) { // mustn't monsterLock this function\n             return;\n         }\n-        if (isFake()) {\n-            c.announce(MaplePacketCreator.spawnFakeMonster(this, 0));\n+        if (fake) {\n+            client.announce(MaplePacketCreator.spawnFakeMonster(this, 0));\n         } else {\n-            c.announce(MaplePacketCreator.spawnMonster(this, false));\n+            client.announce(MaplePacketCreator.spawnMonster(this, false));\n         }\n+        \n         statiLock.lock();\n         try {\n             if (stati.size() > 0) {\n                 for (final MonsterStatusEffect mse : this.stati.values()) {\n-                    c.announce(MaplePacketCreator.applyMonsterStatus(getObjectId(), mse, null));\n+                    client.announce(MaplePacketCreator.applyMonsterStatus(getObjectId(), mse, null));\n                 }\n             }\n         } finally {\n             statiLock.unlock();\n         }\n         \n         if (hasBossHPBar()) {\n-            c.announceBossHpBar(this, this.hashCode(), makeBossHPBarPacket());\n+            client.announceBossHpBar(this, this.hashCode(), makeBossHPBarPacket());\n         }\n     }\n \n@@ -1155,6 +1174,18 @@ public void run() {\n         \n         map.getChannelServer().registerMobStatus(map.getId(), effect, cancelTask, duration);\n     }\n+    \n+    public void refreshMobPosition() {\n+        updateMobPosition(getPosition());\n+    }\n+    \n+    public void updateMobPosition(Point newPoint) {\n+        removeController();\n+        setPosition(newPoint);\n+        map.broadcastMessage(MaplePacketCreator.moveMonster(this.getObjectId(), false, -1, 0, 0, 0, this.getPosition(), this.getIdleMovement()));\n+        map.moveMonster(this, this.getPosition());\n+        map.updateMonsterController(this);\n+    }\n \n     private void debuffMobStat(MonsterStatus stat) {\n         statiLock.lock();"}, {"sha": "a86fad44598bcff5d0693ed43db502ccebe832da", "filename": "src/server/life/MapleNPC.java", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MapleNPC.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MapleNPC.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleNPC.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -44,12 +44,8 @@ public void sendShop(MapleClient c) {\n \n     @Override\n     public void sendSpawnData(MapleClient client) {\n-        if (this.getId() > 9010010 && this.getId() < 9010014) {\n-            client.announce(MaplePacketCreator.spawnNPCRequestController(this, false));\n-        } else {\n-            client.announce(MaplePacketCreator.spawnNPC(this));\n-            client.announce(MaplePacketCreator.spawnNPCRequestController(this, true));\n-        }\n+        client.announce(MaplePacketCreator.spawnNPC(this));\n+        client.announce(MaplePacketCreator.spawnNPCRequestController(this, true));\n     }\n \n     @Override"}, {"sha": "768e1589b4f82add141eb4c649a1fbe69783df66", "filename": "src/server/life/MobSkill.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MobSkill.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/life/MobSkill.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkill.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -103,12 +103,12 @@ public void setLimit(int limit) {\n         this.limit = limit;\n     }\n \n-    public void applyDelayedEffect(final MapleCharacter player, final MapleMonster monster, final boolean skill, final List<MapleCharacter> banishPlayers, int animationTime) {\n+    public void applyDelayedEffect(final MapleCharacter player, final MapleMonster monster, final boolean skill, int animationTime) {\n         Runnable toRun = new Runnable() {\n                             @Override\n                             public void run() {\n                                 if(monster.isAlive()) {\n-                                    applyEffect(player, monster, skill, banishPlayers);\n+                                    applyEffect(player, monster, skill, null);\n                                 }\n                             }\n                         };"}, {"sha": "8c54788a73e28ab4ea18e5f15e7f8f6fa9ecc0b9", "filename": "src/server/maps/AbstractAnimatedMapleMapObject.java", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/AbstractAnimatedMapleMapObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/AbstractAnimatedMapleMapObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/AbstractAnimatedMapleMapObject.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -21,18 +21,35 @@\n */\n package server.maps;\n \n+import java.awt.Point;\n+import java.util.Collections;\n+import java.util.List;\n+import server.movement.AbsoluteLifeMovement;\n+import server.movement.LifeMovementFragment;\n+\n public abstract class AbstractAnimatedMapleMapObject extends AbstractMapleMapObject implements AnimatedMapleMapObject {\n     private int stance;\n \n+    @Override\n     public int getStance() {\n         return stance;\n     }\n \n+    @Override\n     public void setStance(int stance) {\n         this.stance = stance;\n     }\n \n+    @Override\n     public boolean isFacingLeft() {\n         return Math.abs(stance) % 2 == 1;\n     }\n+    \n+    public List<LifeMovementFragment> getIdleMovement() {\n+        AbsoluteLifeMovement alm = new AbsoluteLifeMovement(0, getPosition(), 0, getStance());\n+        alm.setPixelsPerSecond(new Point(0, 0));\n+        \n+        List<LifeMovementFragment> moveUpdate = Collections.singletonList((LifeMovementFragment) alm);\n+        return moveUpdate;\n+    }\n }"}, {"sha": "dfad7418da9d8ca53a2b8bc525412a2acce10e61", "filename": "src/server/maps/MapleDoorObject.java", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleDoorObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleDoorObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDoorObject.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -25,6 +25,7 @@\n import client.MapleClient;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n+import net.server.world.MapleParty;\n import tools.MaplePacketCreator;\n \n /**\n@@ -84,10 +85,9 @@ private Point getLinkedPortalPosition() {\n     }\n     \n     public void warp(final MapleCharacter chr) {\n-        boolean onParty = chr.getParty() != null;\n-        \n-        if (chr.getId() == ownerId || (onParty && chr.getParty().getMemberById(ownerId) != null)) {\n-            if(!inTown() && !onParty) {\n+        MapleParty party = chr.getParty();\n+        if (chr.getId() == ownerId || (party != null && party.getMemberById(ownerId) != null)) {\n+            if(!inTown() && party == null) {\n                 chr.changeMap(to, getLinkedPortalId());\n             } else {\n                 chr.changeMap(to, getLinkedPortalPosition());\n@@ -100,8 +100,10 @@ public void warp(final MapleCharacter chr) {\n \n     @Override\n     public void sendSpawnData(MapleClient client) {\n-        if (from.getId() == client.getPlayer().getMapId()) {\n-            if (client.getPlayer().getParty() != null && (ownerId == client.getPlayer().getId() || client.getPlayer().getParty().getMemberById(ownerId) != null)) {\n+        MapleCharacter chr = client.getPlayer();\n+        if (from.getId() == chr.getMapId()) {\n+            MapleParty party = chr.getParty();\n+            if (party != null && (ownerId == chr.getId() || party.getMemberById(ownerId) != null)) {\n                 client.announce(MaplePacketCreator.partyPortal(this.getFrom().getId(), this.getTo().getId(), this.toPosition()));\n             }\n             \n@@ -112,8 +114,10 @@ public void sendSpawnData(MapleClient client) {\n \n     @Override\n     public void sendDestroyData(MapleClient client) {\n-        if (from.getId() == client.getPlayer().getMapId()) {\n-            if (client.getPlayer().getParty() != null && (ownerId == client.getPlayer().getId() || client.getPlayer().getParty().getMemberById(ownerId) != null)) {\n+        MapleCharacter chr = client.getPlayer();\n+        if (from.getId() == chr.getMapId()) {\n+            MapleParty party = chr.getParty();\n+            if (party != null && (ownerId == chr.getId() || party.getMemberById(ownerId) != null)) {\n                 client.announce(MaplePacketCreator.partyPortal(999999999, 999999999, new Point(-1, -1)));\n             }\n             client.announce(MaplePacketCreator.removeDoor(ownerId, inTown()));"}, {"sha": "6632b919405da08d5d44dac53e8dc2ad2cb411bd", "filename": "src/server/maps/MapleDragon.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleDragon.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleDragon.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleDragon.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -35,8 +35,8 @@ public MapleDragon(MapleCharacter chr) {\n         super();\n         this.owner = chr;\n         this.setPosition(chr.getPosition());\n-\t\tthis.setStance(chr.getStance());\n-        sendSpawnData(chr.getClient());\n+        this.setStance(chr.getStance());\n+        this.sendSpawnData(chr.getClient());\n     }\n \n     @Override\n@@ -45,8 +45,8 @@ public MapleMapObjectType getType() {\n     }\n \n     @Override\n-    public void sendSpawnData(MapleClient c) {\n-        c.announce(MaplePacketCreator.spawnDragon(this));     \n+    public void sendSpawnData(MapleClient client) {\n+        client.announce(MaplePacketCreator.spawnDragon(this));     \n     }\n \n     @Override"}, {"sha": "4db00db6d0f184d8a6e1292f14f082e38713ee39", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -645,15 +645,14 @@ public int getMesos() {\n         return mesos;\n     }\n \n-    @Override\n-    public void sendDestroyData(MapleClient client) {\n-    }\n-\n     @Override\n     public MapleMapObjectType getType() {\n         return MapleMapObjectType.HIRED_MERCHANT;\n     }\n-\n+    \n+    @Override\n+    public void sendDestroyData(MapleClient client) {}\n+    \n     @Override\n     public void sendSpawnData(MapleClient client) {\n         client.announce(MaplePacketCreator.spawnHiredMerchantBox(this));"}, {"sha": "d0cea46a48f01b52f17ee88c9c3ba95f24b2094c", "filename": "src/server/maps/MapleKite.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleKite.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleKite.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleKite.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -3,7 +3,6 @@\n import java.awt.Point;\n import client.MapleCharacter;\n import client.MapleClient;\n-import constants.ServerConstants;\n import tools.MaplePacketCreator;\n \n public class MapleKite extends AbstractMapleMapObject {"}, {"sha": "086b72f63f84419b3600ccee7be513392afdf5d8", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 33, "deletions": 24, "changes": 57, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1552,9 +1552,11 @@ public void updateMonsterController(MapleMonster monster) {\n             if (!monster.isAlive()) {\n                 return;\n             }\n-            if (monster.getController() != null) {\n-                if (monster.getController().getMap() != this) {\n-                    monster.getController().stopControllingMonster(monster);\n+            \n+            MapleCharacter chrController = monster.getController();\n+            if (chrController != null) {\n+                if (chrController.getMap() != this) {\n+                    chrController.stopControllingMonster(monster);\n                 } else {\n                     return;\n                 }\n@@ -1574,7 +1576,7 @@ public void updateMonsterController(MapleMonster monster) {\n             } finally {\n                 chrRLock.unlock();\n             }\n-            if (newController != null) {// was a new controller found? (if not no one is on the map)\n+            if (newController != null) { // was a new controller found? (if not no one is on the map)\n                 if (monster.isFirstAttack()) {\n                     newController.controlMonster(monster, true);\n                     monster.setControllerHasAggro(true);\n@@ -1588,6 +1590,15 @@ public void updateMonsterController(MapleMonster monster) {\n         }\n     }\n \n+    private Map<Integer, MapleMapObject> getCopyMapObjects() {\n+        objectRLock.lock();\n+        try {\n+            return new HashMap<>(mapobjects);\n+        } finally {\n+            objectRLock.unlock();\n+        }\n+    }\n+    \n     public List<MapleMapObject> getMapObjects() {\n         objectRLock.lock();\n         try {\n@@ -2340,14 +2351,14 @@ public void addPlayer(final MapleCharacter chr) {\n             \n             if (onFirstUserEnter.length() != 0 && !chr.hasEntered(onFirstUserEnter, mapid) && MapScriptManager.getInstance().scriptExists(onFirstUserEnter, true)) {\n                 chr.enteredScript(onFirstUserEnter, mapid);\n-                MapScriptManager.getInstance().getMapScript(chr.getClient(), onFirstUserEnter, true);\n+                MapScriptManager.getInstance().runMapScript(chr.getClient(), onFirstUserEnter, true);\n             }\n         }\n         if (onUserEnter.length() != 0) {\n             if (onUserEnter.equals(\"cygnusTest\") && (mapid < 913040000 || mapid > 913040006)) {\n                 chr.saveLocation(\"INTRO\");\n             }\n-            MapScriptManager.getInstance().getMapScript(chr.getClient(), onUserEnter, false);\n+            MapScriptManager.getInstance().runMapScript(chr.getClient(), onUserEnter, false);\n         }\n         if (FieldLimit.CANNOTUSEMOUNTS.check(fieldLimit) && chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {\n             chr.cancelEffectFromBuffStat(MapleBuffStat.MONSTER_RIDING);\n@@ -2629,10 +2640,15 @@ public void removePlayer(MapleCharacter chr) {\n         }\n \n         for (MapleMonster monster : chr.getControlledMonsters()) {\n-            monster.setController(null);\n-            monster.setControllerHasAggro(false);\n-            monster.setControllerKnowsAboutAggro(false);\n-            updateMonsterController(monster);\n+            monster.lockMonster();\n+            try {\n+                monster.setController(null);\n+                monster.setControllerHasAggro(false);\n+                monster.setControllerKnowsAboutAggro(false);\n+                updateMonsterController(monster);\n+            } finally {\n+                monster.unlockMonster();\n+            }\n         }\n         \n         chr.leaveMap();\n@@ -3042,7 +3058,7 @@ public MapleCharacter getCharacterById(int id) {\n     }\n \n     private static void updateMapObjectVisibility(MapleCharacter chr, MapleMapObject mo) {\n-        if (!chr.isMapObjectVisible(mo)) { // item entered view range\n+        if (!chr.isMapObjectVisible(mo)) { // object entered view range\n             if (mo.getType() == MapleMapObjectType.SUMMON || mo.getPosition().distanceSq(chr.getPosition()) <= getRangedDistance()) {\n                 chr.addVisibleMapObject(mo);\n                 mo.sendSpawnData(chr.getClient());\n@@ -3055,27 +3071,22 @@ private static void updateMapObjectVisibility(MapleCharacter chr, MapleMapObject\n \n     public void moveMonster(MapleMonster monster, Point reportedPos) {\n         monster.setPosition(reportedPos);\n-        chrRLock.lock();\n-        try {\n-            for (MapleCharacter chr : characters) {\n-                updateMapObjectVisibility(chr, monster);\n-            }\n-        } finally {\n-            chrRLock.unlock();\n+        for (MapleCharacter chr : getAllPlayers()) {\n+            updateMapObjectVisibility(chr, monster);\n         }\n     }\n \n     public void movePlayer(MapleCharacter player, Point newPosition) {\n         player.setPosition(newPosition);\n-        Collection<MapleMapObject> visibleObjects = player.getVisibleMapObjects();\n         \n-        objectRLock.lock();\n         try {\n+            Collection<MapleMapObject> visibleObjects = player.getVisibleMapObjects();\n             MapleMapObject[] visibleObjectsNow = visibleObjects.toArray(new MapleMapObject[visibleObjects.size()]);\n-            \n+\n+            Map<Integer, MapleMapObject> mapObjects = getCopyMapObjects();\n             for (MapleMapObject mo : visibleObjectsNow) {\n                 if (mo != null) {\n-                    if (mapobjects.get(mo.getObjectId()) == mo) {\n+                    if (mapObjects.get(mo.getObjectId()) == mo) {\n                         updateMapObjectVisibility(player, mo);\n                     } else {\n                         player.removeVisibleMapObject(mo);\n@@ -3084,8 +3095,6 @@ public void movePlayer(MapleCharacter player, Point newPosition) {\n             }\n         } catch (Exception e) {\n             e.printStackTrace();\n-        } finally {\n-            objectRLock.unlock();\n         }\n         \n         for (MapleMapObject mo : getMapObjectsInRange(player.getPosition(), getRangedDistance(), rangedMapobjectTypes)) {"}, {"sha": "5a1a677c25199c921b01c905d96ffee5b725c531", "filename": "src/server/maps/MapleSummon.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleSummon.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/server/maps/MapleSummon.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleSummon.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -47,11 +47,12 @@ public MapleSummon(MapleCharacter owner, int skill, Point pos, SummonMovementTyp\n         setPosition(pos);\n     }\n \n+    @Override\n     public void sendSpawnData(MapleClient client) {\n-        if (this != null) client.announce(MaplePacketCreator.spawnSummon(this, false));\n-\n+        client.announce(MaplePacketCreator.spawnSummon(this, false));\n     }\n \n+    @Override\n     public void sendDestroyData(MapleClient client) {\n         client.announce(MaplePacketCreator.removeSummon(this, true));\n     }"}, {"sha": "56de91e59d3fed7380dc020579ba07ee2e77c92a", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 49, "deletions": 15, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -877,12 +877,28 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n          *\n          * @param c The MapleClient to load characters of.\n          * @param serverId The ID of the server requested.\n+         * @param status The charlist request result.\n          * @return The character list packet.\n+         * \n+         * Possible values for <code>status</code>:\n+         * <br> 2: ID deleted or blocked<br>\n+         * <br> 3: ID deleted or blocked<br>\n+         * <br> 4: Incorrect password<br>\n+         * <br> 5: Not an registered ID<br> \n+         * <br> 6: Trouble logging in?<br>\n+         * <br> 10: Server handling too many connections<br>\n+         * <br> 11: Only 20 years or older<br>\n+         * <br> 13: Unable to log as master at IP<br>\n+         * <br> 14: Wrong gateway or personal info<br>\n+         * <br> 15: Still processing request<br>\n+         * <br> 16: Verify account via email<br>\n+         * <br> 17: Wrong gateway or personal info<br>\n+         * <br> 21: Verify account via email<br>\n          */\n-        public static byte[] getCharList(MapleClient c, int serverId) {\n+        public static byte[] getCharList(MapleClient c, int serverId, int status) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.CHARLIST.getValue());\n-                mplew.write(0);\n+                mplew.write(status);\n                 List<MapleCharacter> chars = c.loadCharacters(serverId);\n                 mplew.write((byte) chars.size());\n                 for (MapleCharacter chr : chars) {\n@@ -1425,7 +1441,6 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.write(1);\n                 mplew.writeInt(life.getObjectId());\n                 return mplew.getPacket();\n-                //return spawnMonsterInternal(life, true, false, false, 0, false);\n         }\n \n         /**\n@@ -2140,11 +2155,11 @@ private static void addMarriageRingLook(MapleClient target, final MaplePacketLit\n                         \n                         MapleCharacter targetChr = target.getPlayer();\n                         if (targetChr != null && targetChr.getPartnerId() == chr.getId()) {\n-                            mplew.writeInt(0);    // 1a pessoa: ser 0 0 implica match...\n-                            mplew.writeInt(0);    // 3a pessoa: 1 2 2 1 funciona!\n+                            mplew.writeInt(0);\n+                            mplew.writeInt(0);\n                         } else {\n-                            mplew.writeInt(chr.getId());    // 1a pessoa: ser 0 0 implica match...\n-                            mplew.writeInt(ring.getPartnerChrId());    // 3a pessoa: 1 2 2 1 funciona!\n+                            mplew.writeInt(chr.getId());\n+                            mplew.writeInt(ring.getPartnerChrId());\n                         }\n                         \n                         mplew.writeInt(ring.getItemId());\n@@ -2386,6 +2401,18 @@ private static void addAttackBody(LittleEndianWriter lew, MapleCharacter chr, in\n                         }\n                 }\n         }\n+        \n+        public static byte[] throwGrenade(int cid, Point p, int keyDown, int skillId, int skillLevel) { // packets found thanks to GabrielSin\n+                MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.THROW_GRENADE.getValue());\n+                mplew.writeInt(cid);\n+                mplew.writeInt(p.x);\n+                mplew.writeInt(p.y);\n+                mplew.writeInt(keyDown);\n+                mplew.writeInt(skillId);\n+                mplew.writeInt(skillLevel);\n+                return mplew.getPacket();\n+        }\n \n         // someone thought it was a good idea to handle floating point representation through packets ROFL\n         private static int doubleToShortBits(double d) {\n@@ -4765,19 +4792,26 @@ private static void addPetInfo(final MaplePacketLittleEndianWriter mplew, MapleP\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] commandResponse(int cid, byte index, int animation, boolean success) {\n-                //AE 00 01 00 00 00 00 01 00 00\n+        public static byte[] petFoodResponse(int cid, byte index, boolean success, boolean balloonType) {\n+                final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.PET_COMMAND.getValue());\n+                mplew.writeInt(cid);\n+                mplew.write(index);\n+                mplew.write(1);\n+                mplew.writeBool(success);\n+                mplew.writeBool(balloonType);\n+                return mplew.getPacket();\n+        }\n+        \n+        public static byte[] commandResponse(int cid, byte index, boolean talk, int animation, boolean balloonType) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.PET_COMMAND.getValue());\n                 mplew.writeInt(cid);\n                 mplew.write(index);\n-                mplew.write((animation == 1 || !success) ? 1 : 0);\n+                mplew.write(0);\n                 mplew.write(animation);\n-                if (animation == 1) {\n-                        mplew.write(0);\n-                } else {\n-                        mplew.writeShort(success ? 1 : 0);\n-                }\n+                mplew.writeBool(!talk);\n+                mplew.writeBool(balloonType);\n                 return mplew.getPacket();\n         }\n "}, {"sha": "0c1eb6aa7da2f0bbd3a8cebbcd90aaf029d6e7e0", "filename": "wz/Item.wz/Etc/0400.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Item.wz/Etc/0400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Item.wz/Etc/0400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Etc/0400.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -8438,6 +8438,7 @@\n       </canvas>\n       <int name=\"price\" value=\"1\"/>\n       <int name=\"slotMax\" value=\"1\"/>\n+      <int name=\"quest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04001213\">"}, {"sha": "b50e388faec52be8ca7dae49c16e95746c703239", "filename": "wz/Map.wz/Map/Map2/200010000.img.xml", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/200010000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/200010000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/200010000.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -775,20 +775,6 @@\n       <int name=\"rx0\" value=\"35\"/>\n       <int name=\"rx1\" value=\"135\"/>\n     </imgdir>\n-    <imgdir name=\"37\">\n-      <string name=\"type\" value=\"n\"/>\n-      <string name=\"id\" value=\"9010012\"/>\n-      <int name=\"x\" value=\"224\"/>\n-      <int name=\"y\" value=\"-113\"/>\n-      <int name=\"mobTime\" value=\"0\"/>\n-      <string name=\"limitedname\" value=\"lie_2\"/>\n-      <int name=\"f\" value=\"0\"/>\n-      <int name=\"hide\" value=\"0\"/>\n-      <int name=\"fh\" value=\"130\"/>\n-      <int name=\"cy\" value=\"-106\"/>\n-      <int name=\"rx0\" value=\"174\"/>\n-      <int name=\"rx1\" value=\"274\"/>\n-    </imgdir>\n   </imgdir>\n   <imgdir name=\"0\">\n     <imgdir name=\"info\">"}, {"sha": "8b81cb2b7d2543a5fca099c6b9bc1670521aefbc", "filename": "wz/Map.wz/Map/Map2/240010200.img.xml", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/240010200.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/240010200.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/240010200.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -623,20 +623,6 @@\n       <int name=\"rx0\" value=\"1960\"/>\n       <int name=\"rx1\" value=\"2810\"/>\n     </imgdir>\n-    <imgdir name=\"20\">\n-      <string name=\"type\" value=\"n\"/>\n-      <string name=\"id\" value=\"9010013\"/>\n-      <int name=\"x\" value=\"1510\"/>\n-      <int name=\"y\" value=\"292\"/>\n-      <int name=\"mobTime\" value=\"0\"/>\n-      <string name=\"limitedname\" value=\"lie_3\"/>\n-      <int name=\"f\" value=\"1\"/>\n-      <int name=\"hide\" value=\"0\"/>\n-      <int name=\"fh\" value=\"78\"/>\n-      <int name=\"cy\" value=\"302\"/>\n-      <int name=\"rx0\" value=\"1460\"/>\n-      <int name=\"rx1\" value=\"1560\"/>\n-    </imgdir>\n   </imgdir>\n   <imgdir name=\"reactor\">\n     <imgdir name=\"0\">"}, {"sha": "301d4ce4c9ea36b3b9e6c17345de6d4fa4c49921", "filename": "wz/Map.wz/Map/Map2/261000000.img.xml", "status": "modified", "additions": 1365, "deletions": 1405, "changes": 2770, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/261000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map2/261000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/261000000.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce"}, {"sha": "46147881a5b7fc559d11be0cf35c81543bbf6c2a", "filename": "wz/Map.wz/Map/Map6/600000000.img.xml", "status": "modified", "additions": 30, "deletions": 6, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map6/600000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map6/600000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map6/600000000.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -11642,8 +11642,8 @@\n       <int name=\"y\" value=\"183\"/>\n       <int name=\"cy\" value=\"201\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n-      <int name=\"rx0\" value=\"2640\"/>\n-      <int name=\"rx1\" value=\"2654\"/>\n+      <int name=\"rx0\" value=\"2636\"/>\n+      <int name=\"rx1\" value=\"2650\"/>\n       <int name=\"f\" value=\"1\"/>\n       <string name=\"type\" value=\"n\"/>\n       <int name=\"fh\" value=\"473\"/>\n@@ -11678,8 +11678,8 @@\n       <int name=\"y\" value=\"482\"/>\n       <int name=\"cy\" value=\"501\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n-      <int name=\"rx0\" value=\"3472\"/>\n-      <int name=\"rx1\" value=\"3572\"/>\n+      <int name=\"rx0\" value=\"3489\"/>\n+      <int name=\"rx1\" value=\"3589\"/>\n       <int name=\"f\" value=\"1\"/>\n       <string name=\"type\" value=\"n\"/>\n       <int name=\"fh\" value=\"540\"/>\n@@ -11750,8 +11750,8 @@\n       <int name=\"y\" value=\"358\"/>\n       <int name=\"cy\" value=\"381\"/>\n       <int name=\"mobTime\" value=\"0\"/>\n-      <int name=\"rx0\" value=\"3199\"/>\n-      <int name=\"rx1\" value=\"3299\"/>\n+      <int name=\"rx0\" value=\"3197\"/>\n+      <int name=\"rx1\" value=\"3297\"/>\n       <int name=\"f\" value=\"1\"/>\n       <string name=\"type\" value=\"n\"/>\n       <int name=\"fh\" value=\"510\"/>\n@@ -11929,5 +11929,29 @@\n       <string name=\"type\" value=\"n\"/>\n       <int name=\"fh\" value=\"449\"/>\n     </imgdir>\n+    <imgdir name=\"27\">\n+      <string name=\"id\" value=\"9000040\"/>\n+      <int name=\"x\" value=\"807\"/>\n+      <int name=\"y\" value=\"434\"/>\n+      <int name=\"cy\" value=\"438\"/>\n+      <int name=\"mobTime\" value=\"0\"/>\n+      <int name=\"rx0\" value=\"757\"/>\n+      <int name=\"rx1\" value=\"857\"/>\n+      <int name=\"f\" value=\"0\"/>\n+      <string name=\"type\" value=\"n\"/>\n+      <int name=\"fh\" value=\"96\"/>\n+    </imgdir>\n+    <imgdir name=\"28\">\n+      <string name=\"id\" value=\"9000041\"/>\n+      <int name=\"x\" value=\"710\"/>\n+      <int name=\"y\" value=\"437\"/>\n+      <int name=\"cy\" value=\"439\"/>\n+      <int name=\"mobTime\" value=\"0\"/>\n+      <int name=\"rx0\" value=\"660\"/>\n+      <int name=\"rx1\" value=\"760\"/>\n+      <int name=\"f\" value=\"0\"/>\n+      <string name=\"type\" value=\"n\"/>\n+      <int name=\"fh\" value=\"78\"/>\n+    </imgdir>\n   </imgdir>\n </imgdir>"}, {"sha": "c5a1659c52660bbf6cef1eb8ecdf8889fb30fe42", "filename": "wz/Map.wz/Map/Map8/801000000.img.xml", "status": "modified", "additions": 2775, "deletions": 2782, "changes": 5557, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map8/801000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Map.wz/Map/Map8/801000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/801000000.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce"}, {"sha": "565a5f4226fc195cc9b5e0c19196b73787f8b8ae", "filename": "wz/Quest.wz/Act.img.xml", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Quest.wz/Act.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Quest.wz/Act.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Act.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -34701,14 +34701,12 @@\n     <imgdir name=\"1\">\n     </imgdir>\n     <imgdir name=\"0\">\n-      <int name=\"money\" value=\"-10000\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"6031\">\n     <imgdir name=\"1\">\n     </imgdir>\n     <imgdir name=\"0\">\n-      <int name=\"money\" value=\"-10000\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"6032\">"}, {"sha": "d794b9c56d06c258e87d6fdad43e64455242418a", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -12712,7 +12712,7 @@ Can proceed to the &quot;The Secrets Behind the Ring?&quot; quest.\n   <imgdir name=\"3329\">\n     <string name=\"name\" value=\"Keeny&apos;s Research on Roid\"/>\n     <string name=\"0\" value=\"#b#m261000000##k&apos;s favorite little Fairy #b#p2111005##k. Her dream is to one day become an alchemist herself, and apparently, she has already started a new research...\"/>\n-    <string name=\"1\" value=\"#p2111005# was studying #o5110301#, the ones that the alchemists from Alcadno came up with. She said to thoroughly investigate #o5110301#, she&apos;ll need #t4000364#... I better get her #b80 #t4000364#k from #o5110301# for her, so she can continue her research.  \\n\\n#i4000364##t4000364# #b#c4000364##k/80 \"/>\n+    <string name=\"1\" value=\"#p2111005# was studying #o5110301#, the ones that the alchemists from Alcadno came up with. She said to thoroughly investigate #o5110301#, she&apos;ll need #t4000364#... I better get her #b80 #t4000364##k from #o5110301# for her, so she can continue her research.  \\n\\n#i4000364##t4000364# #b#c4000364##k/80 \"/>\n     <string name=\"2\" value=\"I gave #p2111005# all the #t4000364#s she asked for. She broke out a wide grin while observing the complex-looking #t4000364#. She may be young, but she sure looks like an alchemist.\"/>\n     <int name=\"area\" value=\"44\"/>\n   </imgdir>"}, {"sha": "98dece9e575adc793c34be859f8eb4f675d02dde", "filename": "wz/Skill.wz/1310.img.xml", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Skill.wz/1310.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Skill.wz/1310.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/1310.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1028,6 +1028,7 @@\n           <int name=\"x\" value=\"205\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"2\">\n           <string name=\"hs\" value=\"h2\"/>\n@@ -1039,6 +1040,7 @@\n           <int name=\"x\" value=\"210\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"3\">\n           <string name=\"hs\" value=\"h3\"/>\n@@ -1050,6 +1052,7 @@\n           <int name=\"x\" value=\"215\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"4\">\n           <string name=\"hs\" value=\"h4\"/>\n@@ -1061,6 +1064,7 @@\n           <int name=\"x\" value=\"220\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"5\">\n           <string name=\"hs\" value=\"h5\"/>\n@@ -1072,6 +1076,7 @@\n           <int name=\"x\" value=\"225\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"6\">\n           <string name=\"hs\" value=\"h6\"/>\n@@ -1083,6 +1088,7 @@\n           <int name=\"x\" value=\"230\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"7\">\n           <string name=\"hs\" value=\"h7\"/>\n@@ -1094,6 +1100,7 @@\n           <int name=\"x\" value=\"235\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"8\">\n           <string name=\"hs\" value=\"h8\"/>\n@@ -1105,6 +1112,7 @@\n           <int name=\"x\" value=\"240\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"9\">\n           <string name=\"hs\" value=\"h9\"/>\n@@ -1116,6 +1124,7 @@\n           <int name=\"x\" value=\"245\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"10\">\n           <string name=\"hs\" value=\"h10\"/>\n@@ -1127,6 +1136,7 @@\n           <int name=\"x\" value=\"250\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"11\">\n           <string name=\"hs\" value=\"h11\"/>\n@@ -1138,6 +1148,7 @@\n           <int name=\"x\" value=\"255\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"12\">\n           <string name=\"hs\" value=\"h12\"/>\n@@ -1149,6 +1160,7 @@\n           <int name=\"x\" value=\"260\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"13\">\n           <string name=\"hs\" value=\"h13\"/>\n@@ -1160,6 +1172,7 @@\n           <int name=\"x\" value=\"265\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"14\">\n           <string name=\"hs\" value=\"h14\"/>\n@@ -1171,6 +1184,7 @@\n           <int name=\"x\" value=\"270\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"15\">\n           <string name=\"hs\" value=\"h15\"/>\n@@ -1182,6 +1196,7 @@\n           <int name=\"x\" value=\"275\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"16\">\n           <string name=\"hs\" value=\"h16\"/>\n@@ -1193,6 +1208,7 @@\n           <int name=\"x\" value=\"280\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"17\">\n           <string name=\"hs\" value=\"h17\"/>\n@@ -1204,6 +1220,7 @@\n           <int name=\"x\" value=\"285\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"18\">\n           <string name=\"hs\" value=\"h18\"/>\n@@ -1215,6 +1232,7 @@\n           <int name=\"x\" value=\"290\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"19\">\n           <string name=\"hs\" value=\"h19\"/>\n@@ -1226,6 +1244,7 @@\n           <int name=\"x\" value=\"295\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n         <imgdir name=\"20\">\n           <string name=\"hs\" value=\"h20\"/>\n@@ -1237,6 +1256,7 @@\n           <int name=\"x\" value=\"300\"/>\n           <vector name=\"lt\" x=\"-230\" y=\"-90\"/>\n           <vector name=\"rb\" x=\"0\" y=\"0\"/>\n+          <int name=\"bulletCount\" value=\"0\"/>\n         </imgdir>\n       </imgdir>\n       <imgdir name=\"hit\">"}, {"sha": "a7b0597f0934aab12f194a24117e3385d14f4265", "filename": "wz/Skill.wz/1311.img.xml", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Skill.wz/1311.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/Skill.wz/1311.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/1311.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -1633,121 +1633,121 @@\n           <string name=\"hs\" value=\"h1\"/>\n           <int name=\"mpCon\" value=\"18\"/>\n           <int name=\"damage\" value=\"160\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"2\">\n           <string name=\"hs\" value=\"h2\"/>\n           <int name=\"mpCon\" value=\"18\"/>\n           <int name=\"damage\" value=\"170\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"3\">\n           <string name=\"hs\" value=\"h3\"/>\n           <int name=\"mpCon\" value=\"18\"/>\n           <int name=\"damage\" value=\"180\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"4\">\n           <string name=\"hs\" value=\"h4\"/>\n           <int name=\"mpCon\" value=\"18\"/>\n           <int name=\"damage\" value=\"190\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"5\">\n           <string name=\"hs\" value=\"h5\"/>\n           <int name=\"mpCon\" value=\"18\"/>\n           <int name=\"damage\" value=\"200\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"6\">\n           <string name=\"hs\" value=\"h6\"/>\n           <int name=\"mpCon\" value=\"23\"/>\n           <int name=\"damage\" value=\"210\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"7\">\n           <string name=\"hs\" value=\"h7\"/>\n           <int name=\"mpCon\" value=\"23\"/>\n           <int name=\"damage\" value=\"220\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"8\">\n           <string name=\"hs\" value=\"h8\"/>\n           <int name=\"mpCon\" value=\"23\"/>\n           <int name=\"damage\" value=\"230\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"9\">\n           <string name=\"hs\" value=\"h9\"/>\n           <int name=\"mpCon\" value=\"23\"/>\n           <int name=\"damage\" value=\"240\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"10\">\n           <string name=\"hs\" value=\"h10\"/>\n           <int name=\"mpCon\" value=\"23\"/>\n           <int name=\"damage\" value=\"250\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"11\">\n           <string name=\"hs\" value=\"h11\"/>\n           <int name=\"mpCon\" value=\"28\"/>\n           <int name=\"damage\" value=\"260\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"12\">\n           <string name=\"hs\" value=\"h12\"/>\n           <int name=\"mpCon\" value=\"28\"/>\n           <int name=\"damage\" value=\"270\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"13\">\n           <string name=\"hs\" value=\"h13\"/>\n           <int name=\"mpCon\" value=\"28\"/>\n           <int name=\"damage\" value=\"280\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"14\">\n           <string name=\"hs\" value=\"h14\"/>\n           <int name=\"mpCon\" value=\"28\"/>\n           <int name=\"damage\" value=\"290\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"15\">\n           <string name=\"hs\" value=\"h15\"/>\n           <int name=\"mpCon\" value=\"28\"/>\n           <int name=\"damage\" value=\"300\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"16\">\n           <string name=\"hs\" value=\"h16\"/>\n           <int name=\"mpCon\" value=\"33\"/>\n           <int name=\"damage\" value=\"310\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"17\">\n           <string name=\"hs\" value=\"h17\"/>\n           <int name=\"mpCon\" value=\"33\"/>\n           <int name=\"damage\" value=\"320\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"18\">\n           <string name=\"hs\" value=\"h18\"/>\n           <int name=\"mpCon\" value=\"33\"/>\n           <int name=\"damage\" value=\"330\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"19\">\n           <string name=\"hs\" value=\"h19\"/>\n           <int name=\"mpCon\" value=\"33\"/>\n           <int name=\"damage\" value=\"340\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n         <imgdir name=\"20\">\n           <string name=\"hs\" value=\"h20\"/>\n           <int name=\"mpCon\" value=\"33\"/>\n           <int name=\"damage\" value=\"350\"/>\n-          <int name=\"attackCount\" value=\"3\"/>\n+          <int name=\"bulletCount\" value=\"3\"/>\n         </imgdir>\n       </imgdir>\n       <imgdir name=\"ball\">"}, {"sha": "010b4255ca962f2dee49ab310ee4b722e53162ec", "filename": "wz/String.wz/Consume.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/String.wz/Consume.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/5ee0cd1c98002d81b343212b85ede7b97e8a45ce/wz/String.wz/Consume.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Consume.img.xml?ref=5ee0cd1c98002d81b343212b85ede7b97e8a45ce", "patch": "@@ -8181,7 +8181,7 @@\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cHigh Mastery# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290129\">\n-    <string name=\"name\" value=\"[Mastery Book]High Mastery 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] High Mastery 30\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cHigh Mastery# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290130\">"}]}]},
