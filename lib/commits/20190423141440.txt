{"fetchDate": "2019-12-19", "content": [{"sha": "e18061ffaf192e5ecb362e722183a22ee293e3ab", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ZTE4MDYxZmZhZjE5MmU1ZWNiMzYyZTcyMjE4M2EyMmVlMjkzZTNhYg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-23T14:14:40Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-23T14:14:40Z"}, "message": "Turnabout on Character stats concurrency + Null remote IP patch\n\nCleared the concurrency conflicts that started occuring after the abstract character's listener code was set to run on new thread, potentally leading to several onStatChange mishaps.\nAdded a check for remoteHost being possibly null when opening a new session with the client.", "tree": {"sha": "802610f87aec21f3271bdea53fd51ca0c2d6af2f", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/802610f87aec21f3271bdea53fd51ca0c2d6af2f"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/e18061ffaf192e5ecb362e722183a22ee293e3ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/e18061ffaf192e5ecb362e722183a22ee293e3ab", "html_url": "https://github.com/ronancpl/HeavenMS/commit/e18061ffaf192e5ecb362e722183a22ee293e3ab", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/e18061ffaf192e5ecb362e722183a22ee293e3ab/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1376c295e11365b82591816c84366b6408b35231", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/1376c295e11365b82591816c84366b6408b35231", "html_url": "https://github.com/ronancpl/HeavenMS/commit/1376c295e11365b82591816c84366b6408b35231"}], "stats": {"total": 90, "additions": 48, "deletions": 42}, "files": [{"sha": "81001fc17debdf290224d948db63484f80f9a92e", "filename": "docs/issues.txt", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -47,7 +47,6 @@ Missing features list:\n ---------------------------\n ** Packet issues & advanced PQs **\n - Mystic Doors (won't deploy players properly is some situations, only destination map matches).\n-- Ariant Party Quest\n - Nett's Pyramid Party Quest\n ---------------------------\n "}, {"sha": "38d0fbcee6c278d31cc2bee242a119b5e92376f5", "filename": "docs/leftover.txt", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/leftover.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/leftover.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/leftover.txt?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -1,6 +1,7 @@\n // Missing contents in HeavenMS (as of commit 311), compiled here thanks to ---\n \n Uncoded features:\n+NX Format\n Name Change\n World transfer\n MTS (v53)"}, {"sha": "f8373a83fe340b5b65b5a99c87e204a512df6547", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -1817,4 +1817,7 @@ Ajustado drops de mobs, agora sendo buscado na DB.\n Ajustado diversas mec\u00e2nicas da AriantPQ, tais como update visual da pontua\u00e7\u00e3o de jogadores (ao dropar itens, ganhar itens, acessar mapa de evento), pontos de batalha persistindo na DB, etc.\n \n 21 Abril 2019,\n-Adicionado debug de packets descrito pelo Atoot.\n\\ No newline at end of file\n+Adicionado debug de packets descrito pelo Atoot.Adicionado debug de packets descrito pelo Atoot.\n+\n+22 Abril 2019,\n+Revisado refatora\u00e7\u00e3o recente em acesso a valores de stats de jogadores levando a inconsist\u00eancia nos valores dos mesmos ao coloc\u00e1-los para rodar em uma nova thread sem prote\u00e7\u00e3o concorrente.\n\\ No newline at end of file"}, {"sha": "b584987590aa9bed2825dcab4de894daa114665c", "filename": "src/client/AbstractMapleCharacterObject.java", "status": "modified", "additions": 3, "deletions": 24, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/client/AbstractMapleCharacterObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/client/AbstractMapleCharacterObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/AbstractMapleCharacterObject.java?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -213,36 +213,15 @@ private void setHpMpApUsed(int mpApUsed) {\n     }\n     \n     private void dispatchHpChanged(final int oldHp) {\n-        Runnable r = new Runnable() {   // thanks BHB (BHB88) for detecting a deadlock case within player stats.\n-            @Override\n-            public void run() {\n-                listener.onHpChanged(oldHp);\n-            }\n-        };\n-        \n-        map.registerCharacterStatUpdate(r);\n+        listener.onHpChanged(oldHp);\n     }\n     \n     private void dispatchHpmpPoolUpdated() {\n-        Runnable r = new Runnable() {\n-            @Override\n-            public void run() {\n-                listener.onHpmpPoolUpdate();\n-            }\n-        };\n-        \n-        map.registerCharacterStatUpdate(r);\n+        listener.onHpmpPoolUpdate();\n     }\n     \n     private void dispatchStatPoolUpdateAnnounced() {\n-        Runnable r = new Runnable() {\n-            @Override\n-            public void run() {\n-                listener.onAnnounceStatPoolUpdate();\n-            }\n-        };\n-        \n-        map.registerCharacterStatUpdate(r);\n+        listener.onAnnounceStatPoolUpdate();\n     }\n     \n     protected void setHp(int newHp) {"}, {"sha": "5e0d36d71207d3147f43b6b42a980ed7366b7e42", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 15, "deletions": 7, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -8590,14 +8590,22 @@ private void hpChangeAction(int oldHp) {\n                 }\n             }\n         }\n+        \n+        final boolean chrDied = playerDied;\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                updatePartyMemberHP();    // thanks BHB (BHB88) for detecting a deadlock case within player stats.\n \n-        updatePartyMemberHP();\n-\n-        if (playerDied) {\n-            playerDead();\n-        } else {\n-            checkBerserk(isHidden());\n-        }\n+                if (chrDied) {\n+                    playerDead();\n+                } else {\n+                    checkBerserk(isHidden());\n+                }\n+            }\n+        };\n+        \n+        map.registerCharacterStatUpdate(r);\n     }\n     \n     private Pair<MapleStat, Integer> calcHpRatioUpdate(int newHp, int oldHp) {"}, {"sha": "58a43e75edb8467094a015daca2343be09d9caae", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -106,7 +106,18 @@ private boolean isLoginServerHandler() {\n     \n     @Override\n     public void sessionOpened(IoSession session) {\n-        session.setAttribute(MapleClient.CLIENT_REMOTE_ADDRESS, ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress());\n+        String remoteHost;\n+        try {\n+            remoteHost = ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress();\n+            \n+            if (remoteHost == null) {\n+                remoteHost = \"null\";\n+            }\n+        } catch (NullPointerException npe) {    // thanks Agassy, Alchemist for pointing out possibility of remoteHost = null.\n+            remoteHost = \"null\";\n+        }\n+        \n+        session.setAttribute(MapleClient.CLIENT_REMOTE_ADDRESS, remoteHost);\n         \n         if (!Server.getInstance().isOnline()) {\n             MapleSessionCoordinator.getInstance().closeSession(session, true);"}, {"sha": "818139142bded6a3303ef09b4850168f09a2eabf", "filename": "src/net/server/handlers/login/LoginPasswordHandler.java", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/net/server/handlers/login/LoginPasswordHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/e18061ffaf192e5ecb362e722183a22ee293e3ab/src/net/server/handlers/login/LoginPasswordHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/LoginPasswordHandler.java?ref=e18061ffaf192e5ecb362e722183a22ee293e3ab", "patch": "@@ -63,16 +63,21 @@ private static String getRemoteIp(IoSession session) {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         String remoteHost = getRemoteIp(c.getSession());\n-        if (remoteHost.startsWith(\"127.\")) {\n-            if (!ServerConstants.LOCALSERVER) {  // thanks Mills for noting HOST can also have a field named \"localhost\"\n-                c.announce(MaplePacketCreator.getLoginFailed(13));   // cannot login as localhost if it's not a local server\n-                return;\n+        if (!remoteHost.contentEquals(\"null\")) {\n+            if (remoteHost.startsWith(\"127.\")) {\n+                if (!ServerConstants.LOCALSERVER) { // thanks Mills for noting HOST can also have a field named \"localhost\"\n+                    c.announce(MaplePacketCreator.getLoginFailed(13));  // cannot login as localhost if it's not a local server\n+                    return;\n+                }\n+            } else {\n+                if (ServerConstants.LOCALSERVER) {\n+                    c.announce(MaplePacketCreator.getLoginFailed(13));  // cannot login as non-localhost if it's a local server\n+                    return;\n+                }\n             }\n         } else {\n-            if (ServerConstants.LOCALSERVER) {\n-                c.announce(MaplePacketCreator.getLoginFailed(13));   // cannot login as non-localhost if it's a local server\n-                return;\n-            }\n+            c.announce(MaplePacketCreator.getLoginFailed(14));          // thanks Alchemist for noting remoteHost could be null\n+            return;\n         }\n         \n         String login = slea.readMapleAsciiString();"}]}]},
