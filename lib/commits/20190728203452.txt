{"fetchDate": "2019-12-19", "content": [{"sha": "85812ba48932eda720910c6bf2be4a3a5f2385b9", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ODU4MTJiYTQ4OTMyZWRhNzIwOTEwYzZiZjJiZTRhM2E1ZjIzODViOQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-07-28T20:34:52Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-07-28T20:34:52Z"}, "message": "Heal & Summons atk limit + Skills on change job + Java8 scripting fix\n\nAdjusted reactor drops, now performing spray-like for any reactor.\nRevised usage of synchronized statements in several methods in the source.\nFixed a quest from the Aran questline using \"password\" system unpredictedly.\nFixed column name in table \"reports\".\nFixed commands \"startquest\" and \"completequest\" not using the quest's NPC in the talk window.\nFixed HP regen bonuses such as sauna robes and from Endure skill, when applied in maps with improved regen, leading to false-positives (with the heal on the player).\nFixed a recent typo on a property from HenesysPQ.\nFixed \"Combat Step\" effect showing twice for other players.\nFixed type-cast issues within some script-hubbing methods in some Java classes.\nReactivated an unused flag that ignores level difference when applying EXP gains to party players.\nFixed Gaviota not disappearing after attack, as defined in the description of the skill.\nFixed CPQ1 field 3 & 4 not allowing players to use summons/protectors.\nFixed exped leaders still receiving exped creation packets even though it was dismissed due to failure on starting (daily entry limit, other fail cases).\nFixed a locking issue that would show up due to a infinite loop case within the procedure that makes disappear items immediately if there were already many items on map.\nFixed several summon skills not using buff icons.\nFixed max damage calculation for summons getting extremely low values when either a player doesn't equip a weapon or attack value is too low.\nFixed explosive loots not taking effect at all, although loot drop-types were already implemented.\nFixed NPE cases when trying to update position of summons/dragons server-side.\nReviewed reactor reset of reactors that disappears for a while. They are now supposed to return immediately once issued a reset.", "tree": {"sha": "1fc0b13d47f30d6b65bcea1cd647647f2bd8e1f9", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/1fc0b13d47f30d6b65bcea1cd647647f2bd8e1f9"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/85812ba48932eda720910c6bf2be4a3a5f2385b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/85812ba48932eda720910c6bf2be4a3a5f2385b9", "html_url": "https://github.com/ronancpl/HeavenMS/commit/85812ba48932eda720910c6bf2be4a3a5f2385b9", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/85812ba48932eda720910c6bf2be4a3a5f2385b9/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "442d45bef2818166f9c314a52a7043ae038f0a0a", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/442d45bef2818166f9c314a52a7043ae038f0a0a", "html_url": "https://github.com/ronancpl/HeavenMS/commit/442d45bef2818166f9c314a52a7043ae038f0a0a"}], "stats": {"total": 758, "additions": 475, "deletions": 283}, "files": [{"sha": "c03774e7fb31a90303acb17f3407ab2e1de88575", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -31,7 +31,7 @@ Java 8 SDK & NetBeans bundle: https://www.oracle.com/technetwork/pt/java/javase/\n \n **Change log:**\n \n-  * Fixed Monster Magnet crashing the caster when trying to pull bosses.\n+  * Fixed Monster Magnet crashing the caster when trying to pull bosses. Drawback: Dojo HPBar becomes unavailable.\n \n   * Fixed some 'rn' problems with quest icons & removed \"tab\" from party leader changed message. https://hostr.co/tsYsQzzV6xT0\n "}, {"sha": "834b6a68eabf1f7617fb00abc35ba3be4a6e96c3", "filename": "docs/area_bosses/AreaBoss.js", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/docs/area_bosses/AreaBoss.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/docs/area_bosses/AreaBoss.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/area_bosses/AreaBoss.js?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "previous_filename": "docs/area_bosses/BossEvent.js"}, {"sha": "c876cdebb72cf8b947afa6743f2e273219646cd7", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -2014,4 +2014,39 @@ Revisado limite de dano aplic\u00e1vel por alguns summons, cujo valor limite estava\n Implementado normaliza\u00e7\u00e3o de fuso hor\u00e1rio em pacotes enviados ao cliente. Agora o sistema utiliza mesmo fuso hor\u00e1rio definido nas flags do servidor.\n Corrigido certos casos onde grupos dentro de lobby de CPQ n\u00e3o conseguiam ser desafiados, geralmente ocorrendo ao se desconectar ap\u00f3s o desafio ter sido aceito e antes de come\u00e7ar a inst\u00e2ncia.\n Revisado script de cr\u00e9ditos.\n-Adicionado checagem por GM's no m\u00e9todo de autoban de jogador.\n\\ No newline at end of file\n+Adicionado checagem por GM's no m\u00e9todo de autoban de jogador.\n+\n+17 Julho 2019,\n+Corrigido drops de reatores n\u00e3o utilizando o sistema de drops sequenciais.\n+Revisado uso de sincroniza\u00e7\u00f5es em v\u00e1rios m\u00e9todos do sistema, tais como nos m\u00e9todos de coloca\u00e7\u00e3o de novos itens no mapa, detec\u00e7\u00e3o de toque em reatores, tabela de convidados em casamento, aplica\u00e7\u00e3o de dano de jogadores em mobs, recep\u00e7\u00e3o de pacotes.\n+\n+18 Julho 2019,\n+Corrigido aplica\u00e7\u00e3o indevida de requisi\u00e7\u00e3o de palavra-chave que prosseguia quest em uma das quests na questline de Aran.\n+Corrigido nome errado em coluna da tabela \"reports\".\n+Corrigido uso de NPC default na conversa padr\u00e3o que ocorre ao se utilizar o comando \"startquest\" e \"completequest\".\n+\n+19 Julho 2019,\n+Corrigido quest onde mobs podem aparecer na \u00e1rea do NPC Grendel permitindo repetir os ganhos de quest tanto quanto respawn de mobs \u00e0 vontade.\n+Corrigido robes de sauna e outros, que permitem ganhos b\u00f4nus de HP, gerando ganhos 10x maiores que o esperado.\n+Ajustado limites para recupera\u00e7\u00e3o de HP de forma a permitir ganhos em v\u00e1rios casos onde h\u00e1 a aplica\u00e7\u00e3o de b\u00f4nus, tais como usando sauna robe, Endure skill.\n+\n+22 Julho 2019,\n+Corrigido atributo de contagem de dano em mob aliado da HenesysPQ n\u00e3o instanciado.\n+Corrigido skill \"Combat Step\" sendo considerado um \"buff\" pelo sistema do servidor. Isso implicava em duplica\u00e7\u00e3o de efeito visual para outros jogadores.\n+\n+26 - 27 Julho 2019,\n+Corrigido problemas de cast de tipos que passou a ocorrer ap\u00f3s trocar para Java 8.\n+Ajustado flag que permite jogadores a ganhar EXP de mob independente de diferen\u00e7as de n\u00edvel.\n+Corrigido Gaviota n\u00e3o sumindo ap\u00f3s lan\u00e7ar ataque.\n+Corrigido funcionalidade de ignorar items de pets n\u00e3o se mantendo ap\u00f3s trocar de mapas.\n+Corrigido CPQ1 campo 3 e 4 n\u00e3o permitindo jogadores a usar summons/protectors em campo.\n+Corrigido l\u00edderes de expedi\u00e7\u00e3o recebendo pacote de timer para fase de registro em casos onde a expedi\u00e7\u00e3o falhou em ser iniciada.\n+Corrigido problema de locking ocorrendo recentemente ao tentar rodar limpeza de itens no mapa (ocorre ao realizar drops de v\u00e1rios itens, mais antigos imediatamente sumindo), problema ocorrendo devido a um caso de loop infinito.\n+Corrigido v\u00e1rias skills de summons n\u00e3o utilizando o \u00edcone de buff no canto superior direito da tela.\n+Corrigido alguns danos de summons sendo calculados extremamente baixos quando o jogador n\u00e3o equipa uma arma ou o mesmo n\u00e3o possui pelo menos uma dezena em ataque.\n+\n+28 Julho 2019,\n+Corrigido funcionalidade de loot explosivo de mobs n\u00e3o aplicando devidamente.\n+Corrigido linguagens, bastante usado na MCPQ, n\u00e3o utilizando o valor requisitado pelo jogador ao logar/trocar de canais.\n+Corrigido casos de NPE ao tentar realizar updates de posi\u00e7\u00e3o lado-servidor em alguns summons de jogador.\n+Revisado reset de reatores em reatores que est\u00e3o desaparecidos por um tempo, para retornar de imediato.\n\\ No newline at end of file"}, {"sha": "52b0eafefa287608818d340b19d11b0c96506ed5", "filename": "launch.bat", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/launch.bat", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/launch.bat", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/launch.bat?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -1,6 +1,6 @@\n @echo off\n @title HeavenMS\n-set PATH=C:\\Program Files\\Java\\jdk1.7.0_79\\bin;%PATH%\n+set PATH=C:\\Program Files\\Java\\jdk1.8.0_211\\bin;%PATH%\n set CLASSPATH=.;dist\\*\n java -Xmx2048m -Dwzpath=wz\\ net.server.Server\n pause\n\\ No newline at end of file"}, {"sha": "d08448f6c750081c7f288783c9a58825deac5bcd", "filename": "nbproject/build-impl.xml", "status": "modified", "additions": 41, "deletions": 69, "changes": 110, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/build-impl.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/build-impl.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/build-impl.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -46,51 +46,15 @@ is divided into following sections:\n         <property file=\"${user.properties.file}\"/>\n         <!-- The two properties below are usually overridden -->\n         <!-- by the active platform. Just a fallback. -->\n-        <property name=\"default.javac.source\" value=\"1.4\"/>\n-        <property name=\"default.javac.target\" value=\"1.4\"/>\n+        <property name=\"default.javac.source\" value=\"1.6\"/>\n+        <property name=\"default.javac.target\" value=\"1.6\"/>\n     </target>\n     <target depends=\"-pre-init,-init-private,-init-user\" name=\"-init-project\">\n         <property file=\"nbproject/configs/${config}.properties\"/>\n         <property file=\"nbproject/project.properties\"/>\n     </target>\n     <target depends=\"-pre-init,-init-private,-init-user,-init-project,-init-macrodef-property\" name=\"-do-init\">\n-        <j2seproject1:property name=\"platform.home\" value=\"platforms.${platform.active}.home\"/>\n-        <j2seproject1:property name=\"platform.bootcp\" value=\"platforms.${platform.active}.bootclasspath\"/>\n-        <j2seproject1:property name=\"platform.compiler\" value=\"platforms.${platform.active}.compile\"/>\n-        <j2seproject1:property name=\"platform.javac.tmp\" value=\"platforms.${platform.active}.javac\"/>\n-        <condition property=\"platform.javac\" value=\"${platform.home}/bin/javac\">\n-            <equals arg1=\"${platform.javac.tmp}\" arg2=\"$${platforms.${platform.active}.javac}\"/>\n-        </condition>\n-        <property name=\"platform.javac\" value=\"${platform.javac.tmp}\"/>\n-        <j2seproject1:property name=\"platform.java.tmp\" value=\"platforms.${platform.active}.java\"/>\n-        <condition property=\"platform.java\" value=\"${platform.home}/bin/java\">\n-            <equals arg1=\"${platform.java.tmp}\" arg2=\"$${platforms.${platform.active}.java}\"/>\n-        </condition>\n-        <property name=\"platform.java\" value=\"${platform.java.tmp}\"/>\n-        <j2seproject1:property name=\"platform.javadoc.tmp\" value=\"platforms.${platform.active}.javadoc\"/>\n-        <condition property=\"platform.javadoc\" value=\"${platform.home}/bin/javadoc\">\n-            <equals arg1=\"${platform.javadoc.tmp}\" arg2=\"$${platforms.${platform.active}.javadoc}\"/>\n-        </condition>\n-        <property name=\"platform.javadoc\" value=\"${platform.javadoc.tmp}\"/>\n-        <condition property=\"platform.invalid\" value=\"true\">\n-            <or>\n-                <contains string=\"${platform.javac}\" substring=\"$${platforms.\"/>\n-                <contains string=\"${platform.java}\" substring=\"$${platforms.\"/>\n-                <contains string=\"${platform.javadoc}\" substring=\"$${platforms.\"/>\n-            </or>\n-        </condition>\n-        <fail unless=\"platform.home\">Must set platform.home</fail>\n-        <fail unless=\"platform.bootcp\">Must set platform.bootcp</fail>\n-        <fail unless=\"platform.java\">Must set platform.java</fail>\n-        <fail unless=\"platform.javac\">Must set platform.javac</fail>\n-        <fail if=\"platform.invalid\">\n- The J2SE Platform is not correctly set up.\n- Your active platform is: ${platform.active}, but the corresponding property \"platforms.${platform.active}.home\" is not found in the project's properties files. \n- Either open the project in the IDE and setup the Platform with the same name or add it manually.\n- For example like this:\n-     ant -Duser.properties.file=&lt;path_to_property_file&gt; jar (where you put the property \"platforms.${platform.active}.home\" in a .properties file)\n-  or ant -Dplatforms.${platform.active}.home=&lt;path_to_JDK_home&gt; jar (where no properties file is used) \n-  </fail>\n+        <property name=\"platform.java\" value=\"${java.home}/bin/java\"/>\n         <available file=\"${manifest.file}\" property=\"manifest.available\"/>\n         <condition property=\"splashscreen.available\">\n             <and>\n@@ -112,7 +76,7 @@ is divided into following sections:\n             <and>\n                 <isset property=\"javac.profile\"/>\n                 <length length=\"0\" string=\"${javac.profile}\" when=\"greater\"/>\n-                <matches pattern=\"1\\.[89](\\..*)?\" string=\"${javac.source}\"/>\n+                <matches pattern=\"((1\\.[89])|9)(\\..*)?\" string=\"${javac.source}\"/>\n             </and>\n         </condition>\n         <condition property=\"do.archive\">\n@@ -190,6 +154,7 @@ is divided into following sections:\n         <property name=\"application.args\" value=\"\"/>\n         <property name=\"source.encoding\" value=\"${file.encoding}\"/>\n         <property name=\"runtime.encoding\" value=\"${source.encoding}\"/>\n+        <property name=\"manifest.encoding\" value=\"${source.encoding}\"/>\n         <condition property=\"javadoc.encoding.used\" value=\"${javadoc.encoding}\">\n             <and>\n                 <isset property=\"javadoc.encoding\"/>\n@@ -217,6 +182,20 @@ is divided into following sections:\n         <condition else=\"\" property=\"javac.profile.cmd.line.arg\" value=\"-profile ${javac.profile}\">\n             <isset property=\"profile.available\"/>\n         </condition>\n+        <condition else=\"false\" property=\"jdkBug6558476\">\n+            <and>\n+                <matches pattern=\"1\\.[56]\" string=\"${java.specification.version}\"/>\n+                <not>\n+                    <os family=\"unix\"/>\n+                </not>\n+            </and>\n+        </condition>\n+        <condition else=\"false\" property=\"javac.fork\">\n+            <or>\n+                <istrue value=\"${jdkBug6558476}\"/>\n+                <istrue value=\"${javac.external.vm}\"/>\n+            </or>\n+        </condition>\n         <property name=\"jar.index\" value=\"false\"/>\n         <property name=\"jar.index.metainf\" value=\"${jar.index}\"/>\n         <property name=\"copylibs.rebase\" value=\"true\"/>\n@@ -242,6 +221,7 @@ is divided into following sections:\n         <condition else=\"\" property=\"testng.debug.mode\" value=\"-mixed\">\n             <istrue value=\"${junit+testng.available}\"/>\n         </condition>\n+        <property name=\"java.failonerror\" value=\"true\"/>\n     </target>\n     <target name=\"-post-init\">\n         <!-- Empty placeholder for easier customization. -->\n@@ -284,7 +264,7 @@ is divided into following sections:\n                 <property location=\"${build.dir}/empty\" name=\"empty.dir\"/>\n                 <mkdir dir=\"${empty.dir}\"/>\n                 <mkdir dir=\"@{apgeneratedsrcdir}\"/>\n-                <javac debug=\"@{debug}\" deprecation=\"${javac.deprecation}\" destdir=\"@{destdir}\" encoding=\"${source.encoding}\" excludes=\"@{excludes}\" executable=\"${platform.javac}\" fork=\"yes\" includeantruntime=\"false\" includes=\"@{includes}\" source=\"${javac.source}\" sourcepath=\"@{sourcepath}\" srcdir=\"@{srcdir}\" target=\"${javac.target}\" tempdir=\"${java.io.tmpdir}\">\n+                <javac debug=\"@{debug}\" deprecation=\"${javac.deprecation}\" destdir=\"@{destdir}\" encoding=\"${source.encoding}\" excludes=\"@{excludes}\" fork=\"${javac.fork}\" includeantruntime=\"false\" includes=\"@{includes}\" source=\"${javac.source}\" sourcepath=\"@{sourcepath}\" srcdir=\"@{srcdir}\" target=\"${javac.target}\" tempdir=\"${java.io.tmpdir}\">\n                     <src>\n                         <dirset dir=\"@{gensrcdir}\" erroronmissingdir=\"false\">\n                             <include name=\"*\"/>\n@@ -324,7 +304,7 @@ is divided into following sections:\n             <sequential>\n                 <property location=\"${build.dir}/empty\" name=\"empty.dir\"/>\n                 <mkdir dir=\"${empty.dir}\"/>\n-                <javac debug=\"@{debug}\" deprecation=\"${javac.deprecation}\" destdir=\"@{destdir}\" encoding=\"${source.encoding}\" excludes=\"@{excludes}\" executable=\"${platform.javac}\" fork=\"yes\" includeantruntime=\"false\" includes=\"@{includes}\" source=\"${javac.source}\" sourcepath=\"@{sourcepath}\" srcdir=\"@{srcdir}\" target=\"${javac.target}\" tempdir=\"${java.io.tmpdir}\">\n+                <javac debug=\"@{debug}\" deprecation=\"${javac.deprecation}\" destdir=\"@{destdir}\" encoding=\"${source.encoding}\" excludes=\"@{excludes}\" fork=\"${javac.fork}\" includeantruntime=\"false\" includes=\"@{includes}\" source=\"${javac.source}\" sourcepath=\"@{sourcepath}\" srcdir=\"@{srcdir}\" target=\"${javac.target}\" tempdir=\"${java.io.tmpdir}\">\n                     <src>\n                         <dirset dir=\"@{gensrcdir}\" erroronmissingdir=\"false\">\n                             <include name=\"*\"/>\n@@ -405,7 +385,7 @@ is divided into following sections:\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n                 <property name=\"junit.forkmode\" value=\"perTest\"/>\n-                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" jvm=\"${platform.java}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n+                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n                     <test methods=\"@{testmethods}\" name=\"@{testincludes}\" todir=\"${build.test.results.dir}\"/>\n                     <syspropertyset>\n                         <propertyref prefix=\"test-sys-prop.\"/>\n@@ -428,7 +408,7 @@ is divided into following sections:\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n                 <property name=\"junit.forkmode\" value=\"perTest\"/>\n-                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" jvm=\"${platform.java}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n+                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n                     <batchtest todir=\"${build.test.results.dir}\">\n                         <fileset dir=\"${build.test.classes.dir}\" excludes=\"@{excludes},${excludes},${test.binaryexcludes}\" includes=\"${test.binaryincludes}\">\n                             <filename name=\"${test.binarytestincludes}\"/>\n@@ -460,7 +440,7 @@ is divided into following sections:\n                 </condition>\n                 <union id=\"test.set\"/>\n                 <taskdef classname=\"org.testng.TestNGAntTask\" classpath=\"${run.test.classpath}\" name=\"testng\"/>\n-                <testng classfilesetref=\"test.set\" failureProperty=\"tests.failed\" jvm=\"${platform.java}\" listeners=\"org.testng.reporters.VerboseReporter\" methods=\"${testng.methods.arg}\" mode=\"${testng.mode}\" outputdir=\"${build.test.results.dir}\" suitename=\"HeavenMS\" testname=\"TestNG tests\" workingDir=\"${work.dir}\">\n+                <testng classfilesetref=\"test.set\" failureProperty=\"tests.failed\" listeners=\"org.testng.reporters.VerboseReporter\" methods=\"${testng.methods.arg}\" mode=\"${testng.mode}\" outputdir=\"${build.test.results.dir}\" suitename=\"HeavenMS\" testname=\"TestNG tests\" workingDir=\"${work.dir}\">\n                     <xmlfileset dir=\"${build.test.classes.dir}\" includes=\"@{testincludes}\"/>\n                     <propertyset>\n                         <propertyref prefix=\"test-sys-prop.\"/>\n@@ -540,7 +520,7 @@ is divided into following sections:\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n                 <property name=\"junit.forkmode\" value=\"perTest\"/>\n-                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" jvm=\"${platform.java}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n+                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n                     <test methods=\"@{testmethods}\" name=\"@{testincludes}\" todir=\"${build.test.results.dir}\"/>\n                     <syspropertyset>\n                         <propertyref prefix=\"test-sys-prop.\"/>\n@@ -565,7 +545,7 @@ is divided into following sections:\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n                 <property name=\"junit.forkmode\" value=\"perTest\"/>\n-                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" jvm=\"${platform.java}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n+                <junit dir=\"${work.dir}\" errorproperty=\"tests.failed\" failureproperty=\"tests.failed\" fork=\"true\" forkmode=\"${junit.forkmode}\" showoutput=\"true\" tempdir=\"${build.dir}\">\n                     <batchtest todir=\"${build.test.results.dir}\">\n                         <fileset dir=\"${build.test.classes.dir}\" excludes=\"@{excludes},${excludes},${test.binaryexcludes}\" includes=\"${test.binaryincludes}\">\n                             <filename name=\"${test.binarytestincludes}\"/>\n@@ -707,7 +687,7 @@ is divided into following sections:\n             <sequential>\n                 <property environment=\"env\"/>\n                 <resolve name=\"profiler.current.path\" value=\"${profiler.info.pathvar}\"/>\n-                <java classname=\"@{classname}\" dir=\"${profiler.info.dir}\" fork=\"true\" jvm=\"${profiler.info.jvm}\">\n+                <java classname=\"@{classname}\" dir=\"${profiler.info.dir}\" failonerror=\"${java.failonerror}\" fork=\"true\" jvm=\"${profiler.info.jvm}\">\n                     <jvmarg line=\"${endorsed.classpath.cmd.line.arg}\"/>\n                     <jvmarg value=\"${profiler.info.jvmargs.agent}\"/>\n                     <jvmarg line=\"${profiler.info.jvmargs}\"/>\n@@ -742,9 +722,6 @@ is divided into following sections:\n                     <classpath>\n                         <path path=\"@{classpath}\"/>\n                     </classpath>\n-                    <bootclasspath>\n-                        <path path=\"${platform.bootcp}\"/>\n-                    </bootclasspath>\n                 </nbjpdastart>\n             </sequential>\n         </macrodef>\n@@ -760,9 +737,7 @@ is divided into following sections:\n         </macrodef>\n     </target>\n     <target name=\"-init-debug-args\">\n-        <exec executable=\"${platform.java}\" outputproperty=\"version-output\">\n-            <arg value=\"-version\"/>\n-        </exec>\n+        <property name=\"version-output\" value=\"java version &quot;${ant.java.version}\"/>\n         <condition property=\"have-jdk-older-than-1.4\">\n             <or>\n                 <contains string=\"${version-output}\" substring=\"java version &quot;1.0\"/>\n@@ -787,7 +762,7 @@ is divided into following sections:\n             <attribute default=\"${debug.classpath}\" name=\"classpath\"/>\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n-                <java classname=\"@{classname}\" dir=\"${work.dir}\" fork=\"true\" jvm=\"${platform.java}\">\n+                <java classname=\"@{classname}\" dir=\"${work.dir}\" failonerror=\"${java.failonerror}\" fork=\"true\">\n                     <jvmarg line=\"${endorsed.classpath.cmd.line.arg}\"/>\n                     <jvmarg line=\"${debug-args-line}\"/>\n                     <jvmarg value=\"-Xrunjdwp:transport=${debug-transport},address=${jpda.address}\"/>\n@@ -814,7 +789,7 @@ is divided into following sections:\n             <attribute default=\"jvm\" name=\"jvm\"/>\n             <element name=\"customize\" optional=\"true\"/>\n             <sequential>\n-                <java classname=\"@{classname}\" dir=\"${work.dir}\" fork=\"true\" jvm=\"${platform.java}\">\n+                <java classname=\"@{classname}\" dir=\"${work.dir}\" failonerror=\"${java.failonerror}\" fork=\"true\">\n                     <jvmarg line=\"${endorsed.classpath.cmd.line.arg}\"/>\n                     <jvmarg value=\"-Dfile.encoding=${runtime.encoding}\"/>\n                     <redirector errorencoding=\"${runtime.encoding}\" inputencoding=\"${runtime.encoding}\" outputencoding=\"${runtime.encoding}\"/>\n@@ -853,7 +828,7 @@ is divided into following sections:\n                     </chainedmapper>\n                 </pathconvert>\n                 <taskdef classname=\"org.netbeans.modules.java.j2seproject.copylibstask.CopyLibs\" classpath=\"${libs.CopyLibs.classpath}\" name=\"copylibs\"/>\n-                <copylibs compress=\"${jar.compress}\" excludeFromCopy=\"${copylibs.excludes}\" index=\"${jar.index}\" indexMetaInf=\"${jar.index.metainf}\" jarfile=\"${dist.jar}\" manifest=\"@{manifest}\" rebase=\"${copylibs.rebase}\" runtimeclasspath=\"${run.classpath.without.build.classes.dir}\">\n+                <copylibs compress=\"${jar.compress}\" excludeFromCopy=\"${copylibs.excludes}\" index=\"${jar.index}\" indexMetaInf=\"${jar.index.metainf}\" jarfile=\"${dist.jar}\" manifest=\"@{manifest}\" manifestencoding=\"UTF-8\" rebase=\"${copylibs.rebase}\" runtimeclasspath=\"${run.classpath.without.build.classes.dir}\">\n                     <fileset dir=\"${build.classes.dir}\" excludes=\"${dist.archive.excludes}\"/>\n                     <manifest>\n                         <attribute name=\"Class-Path\" value=\"${jar.classpath}\"/>\n@@ -865,7 +840,7 @@ is divided into following sections:\n     </target>\n     <target name=\"-init-presetdef-jar\">\n         <presetdef name=\"jar\" uri=\"http://www.netbeans.org/ns/j2se-project/1\">\n-            <jar compress=\"${jar.compress}\" index=\"${jar.index}\" jarfile=\"${dist.jar}\">\n+            <jar compress=\"${jar.compress}\" index=\"${jar.index}\" jarfile=\"${dist.jar}\" manifestencoding=\"UTF-8\">\n                 <j2seproject1:fileset dir=\"${build.classes.dir}\" excludes=\"${dist.archive.excludes}\"/>\n             </jar>\n         </presetdef>\n@@ -988,31 +963,31 @@ is divided into following sections:\n     </target>\n     <target depends=\"init\" if=\"do.archive+manifest.available\" name=\"-do-jar-copy-manifest\">\n         <tempfile deleteonexit=\"true\" destdir=\"${build.dir}\" property=\"tmp.manifest.file\"/>\n-        <copy file=\"${manifest.file}\" tofile=\"${tmp.manifest.file}\"/>\n+        <copy encoding=\"${manifest.encoding}\" file=\"${manifest.file}\" outputencoding=\"UTF-8\" tofile=\"${tmp.manifest.file}\"/>\n     </target>\n     <target depends=\"init,-do-jar-create-manifest,-do-jar-copy-manifest\" if=\"do.archive+main.class.available\" name=\"-do-jar-set-mainclass\">\n-        <manifest file=\"${tmp.manifest.file}\" mode=\"update\">\n+        <manifest encoding=\"UTF-8\" file=\"${tmp.manifest.file}\" mode=\"update\">\n             <attribute name=\"Main-Class\" value=\"${main.class}\"/>\n         </manifest>\n     </target>\n     <target depends=\"init,-do-jar-create-manifest,-do-jar-copy-manifest\" if=\"do.archive+profile.available\" name=\"-do-jar-set-profile\">\n-        <manifest file=\"${tmp.manifest.file}\" mode=\"update\">\n+        <manifest encoding=\"UTF-8\" file=\"${tmp.manifest.file}\" mode=\"update\">\n             <attribute name=\"Profile\" value=\"${javac.profile}\"/>\n         </manifest>\n     </target>\n     <target depends=\"init,-do-jar-create-manifest,-do-jar-copy-manifest\" if=\"do.archive+splashscreen.available\" name=\"-do-jar-set-splashscreen\">\n         <basename file=\"${application.splash}\" property=\"splashscreen.basename\"/>\n         <mkdir dir=\"${build.classes.dir}/META-INF\"/>\n         <copy failonerror=\"false\" file=\"${application.splash}\" todir=\"${build.classes.dir}/META-INF\"/>\n-        <manifest file=\"${tmp.manifest.file}\" mode=\"update\">\n+        <manifest encoding=\"UTF-8\" file=\"${tmp.manifest.file}\" mode=\"update\">\n             <attribute name=\"SplashScreen-Image\" value=\"META-INF/${splashscreen.basename}\"/>\n         </manifest>\n     </target>\n     <target depends=\"init,-init-macrodef-copylibs,compile,-pre-pre-jar,-pre-jar,-do-jar-create-manifest,-do-jar-copy-manifest,-do-jar-set-mainclass,-do-jar-set-profile,-do-jar-set-splashscreen\" if=\"do.mkdist\" name=\"-do-jar-copylibs\">\n         <j2seproject3:copylibs manifest=\"${tmp.manifest.file}\"/>\n         <echo level=\"info\">To run this application from the command line without Ant, try:</echo>\n         <property location=\"${dist.jar}\" name=\"dist.jar.resolved\"/>\n-        <echo level=\"info\">${platform.java} -jar \"${dist.jar.resolved}\"</echo>\n+        <echo level=\"info\">java -jar \"${dist.jar.resolved}\"</echo>\n     </target>\n     <target depends=\"init,compile,-pre-pre-jar,-pre-jar,-do-jar-create-manifest,-do-jar-copy-manifest,-do-jar-set-mainclass,-do-jar-set-profile,-do-jar-set-splashscreen\" if=\"do.archive\" name=\"-do-jar-jar\" unless=\"do.mkdist\">\n         <j2seproject1:jar manifest=\"${tmp.manifest.file}\"/>\n@@ -1199,7 +1174,7 @@ is divided into following sections:\n     <target depends=\"-profile-check\" description=\"Profile a selected class in the IDE.\" if=\"profiler.configured\" name=\"profile-test-with-main\">\n         <fail unless=\"run.class\">Must select one file in the IDE or set run.class</fail>\n         <startprofiler/>\n-        <antcal target=\"run-test-with-main\"/>\n+        <antcall target=\"run-test-with-main\"/>\n     </target>\n     <target depends=\"-profile-check,-profile-applet-pre72\" if=\"profiler.configured\" name=\"profile-applet\" unless=\"profiler.info.jvmargs.agent\">\n         <fail unless=\"applet.url\">Must select one file in the IDE or set applet.url</fail>\n@@ -1221,13 +1196,10 @@ is divided into following sections:\n                 </not>\n             </and>\n         </condition>\n-        <exec executable=\"${platform.java}\" failonerror=\"false\" outputproperty=\"platform.version.output\">\n-            <arg value=\"-version\"/>\n-        </exec>\n         <condition else=\"\" property=\"bug5101868workaround\" value=\"*.java\">\n-            <matches multiline=\"true\" pattern=\"1\\.[56](\\..*)?\" string=\"${platform.version.output}\"/>\n+            <matches pattern=\"1\\.[56](\\..*)?\" string=\"${java.version}\"/>\n         </condition>\n-        <javadoc additionalparam=\"-J-Dfile.encoding=${file.encoding} ${javadoc.additionalparam}\" author=\"${javadoc.author}\" charset=\"UTF-8\" destdir=\"${dist.javadoc.dir}\" docencoding=\"UTF-8\" encoding=\"${javadoc.encoding.used}\" executable=\"${platform.javadoc}\" failonerror=\"true\" noindex=\"${javadoc.noindex}\" nonavbar=\"${javadoc.nonavbar}\" notree=\"${javadoc.notree}\" private=\"${javadoc.private}\" source=\"${javac.source}\" splitindex=\"${javadoc.splitindex}\" use=\"${javadoc.use}\" useexternalfile=\"true\" version=\"${javadoc.version}\" windowtitle=\"${javadoc.windowtitle}\">\n+        <javadoc additionalparam=\"-J-Dfile.encoding=${file.encoding} ${javadoc.additionalparam}\" author=\"${javadoc.author}\" charset=\"UTF-8\" destdir=\"${dist.javadoc.dir}\" docencoding=\"UTF-8\" encoding=\"${javadoc.encoding.used}\" failonerror=\"true\" noindex=\"${javadoc.noindex}\" nonavbar=\"${javadoc.nonavbar}\" notree=\"${javadoc.notree}\" private=\"${javadoc.private}\" source=\"${javac.source}\" splitindex=\"${javadoc.splitindex}\" use=\"${javadoc.use}\" useexternalfile=\"true\" version=\"${javadoc.version}\" windowtitle=\"${javadoc.windowtitle}\">\n             <classpath>\n                 <path path=\"${javac.classpath}\"/>\n             </classpath>"}, {"sha": "6db8caa01672bc341a1a3afeb0e98658b15ca42e", "filename": "nbproject/genfiles.properties", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/genfiles.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/genfiles.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/genfiles.properties?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -1,8 +1,8 @@\n-build.xml.data.CRC32=92113194\n+build.xml.data.CRC32=92efccf9\n build.xml.script.CRC32=ff13faf5\n-build.xml.stylesheet.CRC32=8064a381@1.75.2.48\n+build.xml.stylesheet.CRC32=8064a381@1.80.1.48\n # This file is used by a NetBeans-based IDE to track changes in generated files such as build-impl.xml.\n # Do not edit this file. You may delete it but then the IDE will never regenerate such files for you.\n-nbproject/build-impl.xml.data.CRC32=92113194\n-nbproject/build-impl.xml.script.CRC32=cef58264\n-nbproject/build-impl.xml.stylesheet.CRC32=876e7a8f@1.75.2.48\n+nbproject/build-impl.xml.data.CRC32=92efccf9\n+nbproject/build-impl.xml.script.CRC32=8cda444e\n+nbproject/build-impl.xml.stylesheet.CRC32=830a3534@1.80.1.48"}, {"sha": "c1164614bd3a3b4af1a3799682ffa3864724db65", "filename": "nbproject/private/private.properties", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/private/private.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/private/private.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.properties?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -3,4 +3,4 @@ do.depend=false\n do.jar=true\n javac.debug=true\n javadoc.preview=true\n-user.properties.file=C:\\\\Users\\\\RonanLana\\\\AppData\\\\Roaming\\\\NetBeans\\\\8.0.2\\\\build.properties\n+user.properties.file=C:\\\\Users\\\\RonanLana\\\\AppData\\\\Roaming\\\\NetBeans\\\\8.2\\\\build.properties"}, {"sha": "db7c8c2d82041ed56d75938db6ee379818f50dfa", "filename": "nbproject/project.properties", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/project.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/project.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/project.properties?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -47,10 +47,11 @@ javac.classpath=\\\n # Space-separated list of extra javac options\n javac.compilerargs=\n javac.deprecation=false\n+javac.external.vm=false\n javac.processorpath=\\\n     ${javac.classpath}\n-javac.source=1.7\n-javac.target=1.7\n+javac.source=1.8\n+javac.target=1.8\n javac.test.classpath=\\\n     ${javac.classpath}:\\\n     ${build.classes.dir}\n@@ -84,7 +85,7 @@ manifest.custom.permissions=\n manifest.file=manifest.mf\n meta.inf.dir=${src.dir}/META-INF\n mkdist.disabled=false\n-platform.active=JDK_1.7\n+platform.active=default_platform\n project.license=gpl30_msv2\n project.licensePath=./nbproject/licenseheader.txt\n run.classpath=\\"}, {"sha": "980f89761ccad507b269cb9b2d6bea3078c04b85", "filename": "nbproject/project.xml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/project.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/nbproject/project.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/project.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -4,7 +4,6 @@\n     <configuration>\n         <data xmlns=\"http://www.netbeans.org/ns/j2se-project/3\">\n             <name>HeavenMS</name>\n-            <explicit-platform explicit-source-supported=\"true\"/>\n             <source-roots>\n                 <root id=\"src.dir\"/>\n             </source-roots>"}, {"sha": "18decbfa3d9254abdcf97e79781beb33c38b1e2c", "filename": "scripts/event/HenesysPQ.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/event/HenesysPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/event/HenesysPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HenesysPQ.js?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -106,7 +106,7 @@ function setup(level, lobbyid) {\n         eim.setProperty(\"level\", level);\n         eim.setProperty(\"stage\", \"0\");\n         eim.setProperty(\"bunnyCake\", \"0\");\n-        eim.setProperty(\"bunnyDamage\", \"0\");\n+        eim.setProperty(\"bunnyDamaged\", \"0\");\n         \n         eim.getInstanceMap(910010000).resetPQ(level);\n         eim.getInstanceMap(910010000).allowSummonState(false);"}, {"sha": "a21274ad52ef884804ae0dcf6f9619b9c6882269", "filename": "scripts/npc/1032109.js", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/npc/1032109.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/npc/1032109.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1032109.js?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -9,6 +9,11 @@ var status;\n var mobId = 2220100; //Blue Mushroom\n \n function start(){\n+        if (!cm.isQuestStarted(20718)) {    // thanks Stray, Ari\n+                cm.dispose();\n+                return;\n+        }\n+\n \tstatus = -1;\n \taction(1, 0, 0);\n }"}, {"sha": "04eb91b5216459095b1443901b951f6169d90a5e", "filename": "scripts/quest/21738.js", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/quest/21738.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/scripts/quest/21738.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21738.js?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -34,17 +34,22 @@ function start(mode, type, selection) {\n         else\n             status--;\n         \n-        if (status == 0) {\n-            qm.sendGetText(\"Hm, what do you want?\");\n+        if (status == 0) {  // thanks ZERO\u5091\u6d1b for noticing this quest shouldn't need a pw -- GMS-like string data thanks to skycombat\n+            qm.sendNext(\"What is it? I usually don't welcome uninvited guests, but you have a mysterious aura that makes me curious about what you have to say.\", 9);\n         } else if (status == 1) {\n-            var text = qm.getText();\n-            \n-            if(text != \"There's something strange going on in Orbis....\") {\n-                qm.sendNext(\"No business to deal with? I won't brook loitering around here, go away.\");\n-                qm.dispose();\n-            } else {\n-                qm.sendNext(\"Oh, that's right. I can sense the power emanating from you, as well. So I shall entrust something to you.\");\n-            }\n+            qm.sendNext(\"(You tell her about Giant Nependeath.)\", 3);\n+        } else if (status == 2) {\n+            qm.sendNext(\"Giant Nependeath? It's definitely a big problem, but I don't think it's enough to really affect Orbis. Wait, where did you say the Giant Nependeath was, again?\", 9);\n+        } else if (status == 3) {\n+            qm.sendNext(\"Neglected Strolling Path.\", 3);\n+        } else if (status == 4) {\n+            qm.sendNext(\"...Neglected Strolling Path? If Giant Nependeath is there, someone is trying to enter Sealed Garden! But why? And more importantly, who?\", 9);\n+        } else if (status == 5) {\n+            qm.sendNext(\"Sealed Garden?\", 3);\n+        } else if (status == 6) {\n+            qm.sendAcceptDecline(\"I can't tell you about Sealed Garden. If you want to find out, I must first see whether you are worthy of the information. Do you mind if I look into your fate?\", 9);\n+        } else if (status == 7) {\n+            qm.sendOk(\"Well, now let's look into your fate. Give me a second.\");\n         } else {\n             qm.forceStartQuest();\n             qm.dispose();"}, {"sha": "3f106d8c6c0f1b2b38a3812258cc4cece5806685", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -17406,7 +17406,7 @@ CREATE TABLE IF NOT EXISTS `reports` (\n   `victimid` int(11) NOT NULL,\n   `reason` tinyint(4) NOT NULL,\n   `chatlog` text NOT NULL,\n-  `status` text NOT NULL,\n+  `description` text NOT NULL,  # correct field name, thanks resinate\n   PRIMARY KEY (`id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;\n "}, {"sha": "ba413682f869dea54445cc20df3a75f8114db6c2", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 48, "deletions": 21, "changes": 69, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -792,28 +792,31 @@ public static boolean ban(String id, String reason, boolean accountId) {\n         }\n         return false;\n     }\n+    \n+    public int calculateMaxBaseDamage(int watk, MapleWeaponType weapon) {\n+        int mainstat, secondarystat;\n+        if (getJob().isA(MapleJob.THIEF) && weapon == MapleWeaponType.DAGGER_OTHER) {\n+            weapon = MapleWeaponType.DAGGER_THIEVES;\n+        }\n+\n+        if (weapon == MapleWeaponType.BOW || weapon == MapleWeaponType.CROSSBOW || weapon == MapleWeaponType.GUN) {\n+            mainstat = localdex;\n+            secondarystat = localstr;\n+        } else if (weapon == MapleWeaponType.CLAW || weapon == MapleWeaponType.DAGGER_THIEVES) {\n+            mainstat = localluk;\n+            secondarystat = localdex + localstr;\n+        } else {\n+            mainstat = localstr;\n+            secondarystat = localdex;\n+        }\n+        return (int) (((weapon.getMaxDamageMultiplier() * mainstat + secondarystat) / 100.0) * watk);\n+    }\n \n     public int calculateMaxBaseDamage(int watk) {\n         int maxbasedamage;\n         Item weapon_item = getInventory(MapleInventoryType.EQUIPPED).getItem((short) -11);\n         if (weapon_item != null) {\n-            MapleWeaponType weapon = ii.getWeaponType(weapon_item.getItemId());\n-            int mainstat, secondarystat;\n-            if (getJob().isA(MapleJob.THIEF) && weapon == MapleWeaponType.DAGGER_OTHER) {\n-                weapon = MapleWeaponType.DAGGER_THIEVES;\n-            }\n-\n-            if (weapon == MapleWeaponType.BOW || weapon == MapleWeaponType.CROSSBOW || weapon == MapleWeaponType.GUN) {\n-                mainstat = localdex;\n-                secondarystat = localstr;\n-            } else if (weapon == MapleWeaponType.CLAW || weapon == MapleWeaponType.DAGGER_THIEVES) {\n-                mainstat = localluk;\n-                secondarystat = localdex + localstr;\n-            } else {\n-                mainstat = localstr;\n-                secondarystat = localdex;\n-            }\n-            maxbasedamage = (int) (((weapon.getMaxDamageMultiplier() * mainstat + secondarystat) / 100.0) * watk);\n+            maxbasedamage = calculateMaxBaseDamage(watk, ii.getWeaponType(weapon_item.getItemId()));\n         } else {\n             if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n                 double weapMulti = 3;\n@@ -830,8 +833,8 @@ public int calculateMaxBaseDamage(int watk) {\n         return maxbasedamage;\n     }\n     \n-    public int calculateMaxBaseMagicDamage() {\n-        int maxbasedamage = getTotalMagic();\n+    public int calculateMaxBaseMagicDamage(int matk) {\n+        int maxbasedamage = matk;\n         int totalint = getTotalInt();\n         \n         if (totalint > 2000) {\n@@ -1110,6 +1113,29 @@ public void setMasteries(int jobId) {\n             }\n         }\n     }\n+    \n+    private void broadcastChangeJob() {\n+        for (MapleCharacter chr : map.getAllPlayers()) {\n+            MapleClient chrC = chr.getClient();\n+\n+            if (chrC != null) {     // propagate new job 3rd-person effects (FJ, Aran 1st strike, etc)\n+                this.sendDestroyData(chrC);\n+                this.sendSpawnData(chrC);\n+            }\n+        }\n+        \n+        TimerManager.getInstance().schedule(new Runnable() {    // need to delay to ensure clientside has finished reloading character data\n+            @Override\n+            public void run() {\n+                MapleCharacter thisChr = MapleCharacter.this;\n+                MapleMap map = thisChr.getMap();\n+                \n+                if (map != null) {\n+                    map.broadcastMessage(thisChr, MaplePacketCreator.showForeignEffect(thisChr.getId(), 8), false);\n+                }\n+            }\n+        }, 777);\n+    }\n \n     public synchronized void changeJob(MapleJob newJob) {\n         if (newJob == null) {\n@@ -1222,7 +1248,7 @@ public synchronized void changeJob(MapleJob newJob) {\n         setMasteries(this.job.getId());\n         guildUpdate();\n         \n-        getMap().broadcastMessage(this, MaplePacketCreator.showForeignEffect(this.getId(), 8), false);\n+        broadcastChangeJob();\n         \n         if (GameConstants.hasSPTable(newJob) && newJob.getId() != 2001) {\n             if (getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {\n@@ -7064,14 +7090,15 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             }\n             rs.close();\n             ps.close();\n-            ps = con.prepareStatement(\"SELECT name, characterslots FROM accounts WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n+            ps = con.prepareStatement(\"SELECT name, characterslots, language FROM accounts WHERE id = ?\", Statement.RETURN_GENERATED_KEYS);\n             ps.setInt(1, ret.accountid);\n             rs = ps.executeQuery();\n             if (rs.next()) {\n                 MapleClient retClient = ret.getClient();\n                 \n                 retClient.setAccountName(rs.getString(\"name\"));\n                 retClient.setCharacterSlots(rs.getByte(\"characterslots\"));\n+                retClient.setLanguage(rs.getInt(\"language\"));   // thanks Zein for noticing user language not overriding default once player is in-game\n             }\n             rs.close();\n             ps.close();"}, {"sha": "149e8b88bf8103a69ad6dc9ad166a6668cc3c5df", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -1285,12 +1285,18 @@ public void releaseClient() {\n                 actionsSemaphore.release();\n         }\n         \n-        public void lockEncoder() {\n-                encoderLock.lock();\n+        public boolean tryacquireEncoder() {\n+                if (actionsSemaphore.tryAcquire()) {\n+                        encoderLock.lock();\n+                        return true;\n+                } else {\n+                        return false;\n+                }\n \t}\n         \n         public void unlockEncoder() {\n                 encoderLock.unlock();\n+                actionsSemaphore.release();\n \t}\n \n \tprivate static class CharNameAndId {"}, {"sha": "1bd4aa0c63531d96bb6ae0d59a3d112b1c74ef1d", "filename": "src/client/SkillFactory.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/SkillFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/SkillFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/SkillFactory.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -180,6 +180,7 @@ private static Skill loadFromData(int id, MapleData data) {\n                 case NightWalker.POISON_BOMB:\n                 case NightWalker.VAMPIRE:\n                 case ChiefBandit.CHAKRA:\n+                case Aran.COMBAT_STEP:\n                 case Evan.RECOVERY_AURA:\n                     isBuff = false;\n                     break;"}, {"sha": "547f21c771d671f9b011aa62f6e3bd388e526ff9", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -265,6 +265,7 @@ private void registerLv2Commands(){\n         addCommand(\"unbug\", 2, UnBugCommand.class);\n         addCommand(\"id\", 2, IdCommand.class);\n         addCommand(\"gachalist\", GachaListCommand.class);\n+        addCommand(\"loot\", LootCommand.class);\n         \n         commandsNameDesc.add(levelCommandsCursor);\n     }"}, {"sha": "358d6642dade2279a1d8fea8b292aa899896a0c2", "filename": "src/client/command/commands/gm3/QuestCompleteCommand.java", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/commands/gm3/QuestCompleteCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/commands/gm3/QuestCompleteCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/QuestCompleteCommand.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -26,6 +26,7 @@\n import client.command.Command;\n import client.MapleClient;\n import client.MapleCharacter;\n+import server.quest.MapleQuest;\n \n public class QuestCompleteCommand extends Command {\n     {\n@@ -44,7 +45,13 @@ public void execute(MapleClient c, String[] params) {\n         int questId = Integer.parseInt(params[0]);\n \n         if (player.getQuestStatus(questId) == 1) {\n-            c.getAbstractPlayerInteraction().forceCompleteQuest(questId);\n+            MapleQuest quest = MapleQuest.getInstance(questId);\n+            if (quest != null && quest.getNpcRequirement(true) != -1) {\n+                c.getAbstractPlayerInteraction().forceCompleteQuest(questId, quest.getNpcRequirement(true));\n+            } else {\n+                c.getAbstractPlayerInteraction().forceCompleteQuest(questId);\n+            }\n+            \n             player.dropMessage(5, \"QUEST \" + questId + \" completed.\");\n         } else {\n             player.dropMessage(5, \"QUESTID \" + questId + \" not started or already completed.\");"}, {"sha": "831ab05b2e9044be9a87a3c9afe48accbe82167c", "filename": "src/client/command/commands/gm3/QuestStartCommand.java", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/commands/gm3/QuestStartCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/client/command/commands/gm3/QuestStartCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/QuestStartCommand.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -26,6 +26,7 @@\n import client.command.Command;\n import client.MapleClient;\n import client.MapleCharacter;\n+import server.quest.MapleQuest;\n \n public class QuestStartCommand extends Command {\n     {\n@@ -44,7 +45,13 @@ public void execute(MapleClient c, String[] params) {\n         int questid = Integer.parseInt(params[0]);\n \n         if (player.getQuestStatus(questid) == 0) {\n-            c.getAbstractPlayerInteraction().forceStartQuest(questid);\n+            MapleQuest quest = MapleQuest.getInstance(questid);\n+            if (quest != null && quest.getNpcRequirement(false) != -1) {\n+                c.getAbstractPlayerInteraction().forceStartQuest(questid, quest.getNpcRequirement(false));\n+            } else {\n+                c.getAbstractPlayerInteraction().forceStartQuest(questid);\n+            }\n+            \n             player.dropMessage(5, \"QUEST \" + questid + \" started.\");\n         } else {\n             player.dropMessage(5, \"QUESTID \" + questid + \" already started/completed.\");"}, {"sha": "7a61ceeddb5b2098b0b89aa1497a0f2d09b904e2", "filename": "src/constants/skills/Aran.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/constants/skills/Aran.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/constants/skills/Aran.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/skills/Aran.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -29,6 +29,7 @@\n     public static final int DOUBLE_SWING = 21000002;\n     public static final int TRIPLE_SWING = 21100001;\n     public static final int COMBO_ABILITY = 21000000;\n+    public static final int COMBAT_STEP = 21001001;\n     public static final int POLEARM_BOOSTER = 21001003;\n     public static final int MAPLE_WARRIOR = 21121000;\n     public static final int FREEZE_STANDING = 21121003;"}, {"sha": "cad289e166bff754c8d8f991193f3cdda04f6b0b", "filename": "src/net/mina/MaplePacketEncoder.java", "status": "modified", "additions": 32, "deletions": 32, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/mina/MaplePacketEncoder.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/mina/MaplePacketEncoder.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/mina/MaplePacketEncoder.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -24,7 +24,6 @@\n import constants.ServerConstants;\n import client.MapleClient;\n import constants.OpcodeConstants;\n-import net.opcodes.SendOpcode;\n import net.server.coordinator.MapleSessionCoordinator;\n import org.apache.mina.core.buffer.IoBuffer;\n import org.apache.mina.core.session.IoSession;\n@@ -43,40 +42,41 @@ public void encode(final IoSession session, final Object message, final Protocol\n         final MapleClient client = (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n \n         try {\n-            client.lockEncoder();\n-            try {\n-                final MapleAESOFB send_crypto = client.getSendCrypto();\n-                final byte[] input = (byte[]) message;\n-                if (ServerConstants.USE_DEBUG_SHOW_PACKET) {\n-                    int packetLen = input.length;\n-                    int pHeader = readFirstShort(input);\n-                    String pHeaderStr = Integer.toHexString(pHeader).toUpperCase();\n-                    String op = lookupRecv(pHeader);\n-                    String Recv = \"ServerSend:\" + op + \" [\" + pHeaderStr + \"] (\" + packetLen + \")\\r\\n\";\n-                    if (packetLen <= 50000) {\n-                        String RecvTo = Recv + HexTool.toString(input) + \"\\r\\n\" + HexTool.toStringFromAscii(input);\n-                        System.out.println(RecvTo);\n-                        if (op == null) {\n-                            System.out.println(\"UnknownPacket:\" + RecvTo);\n+            if (client.tryacquireEncoder()) {\n+                try {\n+                    final MapleAESOFB send_crypto = client.getSendCrypto();\n+                    final byte[] input = (byte[]) message;\n+                    if (ServerConstants.USE_DEBUG_SHOW_PACKET) {\n+                        int packetLen = input.length;\n+                        int pHeader = readFirstShort(input);\n+                        String pHeaderStr = Integer.toHexString(pHeader).toUpperCase();\n+                        String op = lookupRecv(pHeader);\n+                        String Recv = \"ServerSend:\" + op + \" [\" + pHeaderStr + \"] (\" + packetLen + \")\\r\\n\";\n+                        if (packetLen <= 50000) {\n+                            String RecvTo = Recv + HexTool.toString(input) + \"\\r\\n\" + HexTool.toStringFromAscii(input);\n+                            System.out.println(RecvTo);\n+                            if (op == null) {\n+                                System.out.println(\"UnknownPacket:\" + RecvTo);\n+                            }\n+                        } else {\n+                            FilePrinter.print(FilePrinter.PACKET_STREAM + MapleSessionCoordinator.getSessionRemoteAddress(session) + \".txt\", HexTool.toString(new byte[]{input[0], input[1]}) + \" ...\");\n                         }\n-                    } else {\n-                        FilePrinter.print(FilePrinter.PACKET_STREAM + MapleSessionCoordinator.getSessionRemoteAddress(session) + \".txt\", HexTool.toString(new byte[]{input[0], input[1]}) + \" ...\");\n                     }\n+\n+                    final byte[] unencrypted = new byte[input.length];\n+                    System.arraycopy(input, 0, unencrypted, 0, input.length);\n+                    final byte[] ret = new byte[unencrypted.length + 4];\n+                    final byte[] header = send_crypto.getPacketHeader(unencrypted.length);\n+                    MapleCustomEncryption.encryptData(unencrypted);\n+\n+                    send_crypto.crypt(unencrypted);\n+                    System.arraycopy(header, 0, ret, 0, 4);\n+                    System.arraycopy(unencrypted, 0, ret, 4, unencrypted.length);\n+\n+                    out.write(IoBuffer.wrap(ret));\n+                } finally {\n+                    client.unlockEncoder();\n                 }\n-                \n-                final byte[] unencrypted = new byte[input.length];\n-                System.arraycopy(input, 0, unencrypted, 0, input.length);\n-                final byte[] ret = new byte[unencrypted.length + 4];\n-                final byte[] header = send_crypto.getPacketHeader(unencrypted.length);\n-                MapleCustomEncryption.encryptData(unencrypted);\n-            \n-                send_crypto.crypt(unencrypted);\n-                System.arraycopy(header, 0, ret, 0, 4);\n-                System.arraycopy(unencrypted, 0, ret, 4, unencrypted.length);\n-                \n-                out.write(IoBuffer.wrap(ret));\n-            } finally {\n-                client.unlockEncoder();\n             }\n //            System.arraycopy(unencrypted, 0, ret, 4, unencrypted.length);\n //            out.write(ByteBuffer.wrap(ret));"}, {"sha": "4433d65d4c6b7639a6c48ee0932e5855da391ea7", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -460,6 +460,7 @@ public boolean addExpedition(MapleExpedition exped) {\n             }\n             \n             expeditions.put(exped.getType(), exped);\n+            exped.beginRegistration();  // thanks Conrad for noticing leader still receiving packets on failure-to-register cases\n             return true;\n         }\n     }"}, {"sha": "8162296a1e3d9bc164ded94b1a26e07571c98477", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -134,8 +134,9 @@ public MapleStatEffect getAttackEffect(MapleCharacter chr, Skill theSkill) {\n         }\n     }\n \n-    protected synchronized void applyAttack(AttackInfo attack, final MapleCharacter player, int attackCount) {\n-        if (player.getMap().isOwnershipRestricted(player)) {\n+    protected void applyAttack(AttackInfo attack, final MapleCharacter player, int attackCount) {\n+        final MapleMap map = player.getMap();\n+        if (map.isOwnershipRestricted(player)) {\n             return;\n         }\n         \n@@ -150,7 +151,7 @@ protected synchronized void applyAttack(AttackInfo attack, final MapleCharacter\n                 theSkill = SkillFactory.getSkill(GameConstants.getHiddenSkill(attack.skill)); //returns back the skill id if its not a hidden skill so we are gucci\n                 attackEffect = attack.getAttackEffect(player, theSkill);\n                 if (attackEffect == null) {\n-                    player.getClient().announce(MaplePacketCreator.enableActions());\n+                    player.announce(MaplePacketCreator.enableActions());\n                     return;\n                 }\n \n@@ -176,7 +177,7 @@ protected synchronized void applyAttack(AttackInfo attack, final MapleCharacter\n                             }\n                         }\n                     } else {\n-                        player.getClient().announce(MaplePacketCreator.enableActions());\n+                        player.announce(MaplePacketCreator.enableActions());\n                     }\n                 }\n                 \n@@ -195,7 +196,6 @@ protected synchronized void applyAttack(AttackInfo attack, final MapleCharacter\n             }*/\n             \n             int totDamage = 0;\n-            final MapleMap map = player.getMap();\n \n             if (attack.skill == ChiefBandit.MESO_EXPLOSION) {\n                 int delay = 0;\n@@ -308,7 +308,7 @@ else if(attack.skill == Shadower.BOOMERANG_STEP)\n                                     TimerManager.getInstance().schedule(new Runnable() {\n                                         @Override\n                                         public void run() {\n-                                            player.getMap().spawnMesoDrop(Math.min((int) Math.max(((double) eachdf / (double) 20000) * (double) maxmeso, (double) 1), maxmeso), new Point((int) (monster.getPosition().getX() + Randomizer.nextInt(100) - 50), (int) (monster.getPosition().getY())), monster, player, true, (byte) 2);\n+                                            map.spawnMesoDrop(Math.min((int) Math.max(((double) eachdf / (double) 20000) * (double) maxmeso, (double) 1), maxmeso), new Point((int) (monster.getPosition().getX() + Randomizer.nextInt(100) - 50), (int) (monster.getPosition().getY())), monster, player, true, (byte) 2);\n                                         }\n                                     }, delay);\n                                     delay += 100;\n@@ -333,7 +333,7 @@ public void run() {\n                                     List<MonsterDropEntry> toSteal = new ArrayList<>();\n                                     toSteal.add(mi.retrieveDrop(monster.getId()).get(i));\n                                     \n-                                    player.getMap().dropItemsFromMonster(toSteal, player, monster);\n+                                    map.dropItemsFromMonster(toSteal, player, monster);\n                                     monster.addStolen(toSteal.get(0).itemId);\n                                 }\n                             }"}, {"sha": "dec1b5c1b9f4e5af641fa9f9d3225d37a26a0cda", "filename": "src/net/server/channel/handlers/HealOvertimeHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/HealOvertimeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/HealOvertimeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/HealOvertimeHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -25,6 +25,7 @@\n import client.MapleClient;\n import client.autoban.AutobanFactory;\n import client.autoban.AutobanManager;\n+import constants.GameConstants;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n import server.maps.MapleMapFactory;\n@@ -46,7 +47,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             abm.setTimestamp(8, timestamp, 28);  // thanks Vcoc & Thora for pointing out d/c happening here\n             if ((abm.getLastSpam(0) + 1500) > timestamp) AutobanFactory.FAST_HP_HEALING.addPoint(abm, \"Fast hp healing\");\n             \n-            int abHeal = 120 + (int)(20 * MapleMapFactory.getMapRecoveryRate(chr.getMapId())); // Sleepywood sauna and showa spa...\n+            int abHeal = (int)(77 * MapleMapFactory.getMapRecoveryRate(chr.getMapId()) * 1.5); // thanks Ari for noticing players not getting healed in sauna in certain cases\n             if (healHP > abHeal) {\n                 AutobanFactory.HIGH_HP_HEALING.autoban(chr, \"Healing: \" + healHP + \"; Max is \" + abHeal + \".\");\n                 return;"}, {"sha": "0b8bb9f0997785fbf88a2ef3a2533eb08f39ffad", "filename": "src/net/server/channel/handlers/MoveDragonHandler.java", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveDragonHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveDragonHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveDragonHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -37,14 +37,16 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         final Point startPos = new Point(slea.readShort(), slea.readShort());\n         long movementDataStart = slea.getPosition();\n         final MapleDragon dragon = chr.getDragon();\n-        updatePosition(slea, dragon, 0);\n-        long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n-        if (dragon != null && movementDataLength > 0) {\n-            slea.seek(movementDataStart);\n-            if (chr.isHidden()) {\n-                chr.getMap().broadcastGMMessage(chr, MaplePacketCreator.moveDragon(dragon, startPos, slea, movementDataLength));\n-            } else {\n-                chr.getMap().broadcastMessage(chr, MaplePacketCreator.moveDragon(dragon, startPos, slea, movementDataLength), dragon.getPosition());\n+        if (dragon != null) {\n+            updatePosition(slea, dragon, 0);\n+            long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n+            if (movementDataLength > 0) {\n+                slea.seek(movementDataStart);\n+                if (chr.isHidden()) {\n+                    chr.getMap().broadcastGMMessage(chr, MaplePacketCreator.moveDragon(dragon, startPos, slea, movementDataLength));\n+                } else {\n+                    chr.getMap().broadcastMessage(chr, MaplePacketCreator.moveDragon(dragon, startPos, slea, movementDataLength), dragon.getPosition());\n+                }\n             }\n         }\n     }"}, {"sha": "67d6704ed90eccd4ed8b2b111d088b21fc69602a", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -143,14 +143,15 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tPoint startPos = new Point(start_x, start_y - 2);\n \t\tPoint serverStartPos = new Point(monster.getPosition());\n \t\tlong movementDataStart = slea.getPosition();\n-        updatePosition(slea, monster, -2);\n-        long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n-\t\t\n-        Boolean aggro = monster.aggroMoveLifeUpdate(player);\n-        if (aggro == null) return;\n-        \n-        if (nextUse != null) {\n-            c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro, nextSkillId, nextSkillLevel));\n+                \n+                updatePosition(slea, monster, -2);  // Thanks Doodle and ZERO\u5091\u6d1b for noticing sponge-based bosses moving out of stage in case of no-offset applied\n+                long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n+\n+                Boolean aggro = monster.aggroMoveLifeUpdate(player);\n+                if (aggro == null) return;\n+\n+                if (nextUse != null) {\n+                        c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro, nextSkillId, nextSkillLevel));\n \t\t} else {\n \t\t\tc.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, mobMp, aggro));\n \t\t}"}, {"sha": "911ffd2ce850195f1af438baf0c8cc008da62554", "filename": "src/net/server/channel/handlers/MoveSummonHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveSummonHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/MoveSummonHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveSummonHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -44,10 +44,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             }\n         }\n-        long movementDataStart = slea.getPosition();\n-        updatePosition(slea, summon, 0);\n-        long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n         if (summon != null) {\n+            long movementDataStart = slea.getPosition();\n+            updatePosition(slea, summon, 0);\n+            long movementDataLength = slea.getPosition() - movementDataStart; //how many bytes were read by updatePosition\n             slea.seek(movementDataStart);\n             player.getMap().broadcastMessage(player, MaplePacketCreator.moveSummon(player.getId(), oid, startPos, slea, movementDataLength), summon.getPosition());\n         }"}, {"sha": "b0619ac4fe73cdc7a1db2a7a5d48db2218a5575e", "filename": "src/net/server/channel/handlers/PetExcludeItemsHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/PetExcludeItemsHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/PetExcludeItemsHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PetExcludeItemsHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -33,6 +33,8 @@\n  * @author Ronan\n  */\n public final class PetExcludeItemsHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         final int petId = slea.readInt();\n         slea.skip(4);"}, {"sha": "1698aa373260f39d20fd7a6a2dfc361425273806", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -203,6 +203,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 \n                 if (!newcomer) {\n+                    c.setLanguage(player.getClient().getLanguage());\n                     c.setCharacterSlots((byte) player.getClient().getCharacterSlots());\n                     player.newClient(c);\n                 }"}, {"sha": "4972eefa73b60cb3529a345f1327a12800aad5b9", "filename": "src/net/server/channel/handlers/SummonDamageHandler.java", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/SummonDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/channel/handlers/SummonDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SummonDamageHandler.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -26,9 +26,14 @@\n import client.Skill;\n import client.SkillFactory;\n import client.autoban.AutobanFactory;\n+import client.inventory.Item;\n+import client.inventory.MapleInventoryType;\n+import client.inventory.MapleWeaponType;\n import client.status.MonsterStatusEffect;\n+import constants.skills.Outlaw;\n import java.util.ArrayList;\n import java.util.List;\n+import server.MapleItemInformationProvider;\n import server.MapleStatEffect;\n import server.life.MapleMonster;\n import server.life.MapleMonsterInformationProvider;\n@@ -115,15 +120,29 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n                 player.getMap().damageMonster(player, target, damage);\n             }\n         }\n+        \n+        if (summon.getSkill() == Outlaw.GAVIOTA) {  // thanks Periwinks for noticing Gaviota not cancelling after grenade toss\n+            player.cancelEffect(summonEffect, false, -1);\n+        }\n     }\n     \n     private static int calcMaxDamage(MapleStatEffect summonEffect, MapleCharacter player, boolean magic) {\n         double maxDamage;\n         \n         if (magic) {\n-            maxDamage = player.calculateMaxBaseMagicDamage() * (0.05 * summonEffect.getMatk());\n+            int matk = Math.max(player.getTotalMagic(), 14);\n+            maxDamage = player.calculateMaxBaseMagicDamage(matk) * (0.05 * summonEffect.getMatk());\n         } else {\n-            int maxBaseDmg = player.calculateMaxBaseDamage(player.getTotalWatk());  // thanks Conrad for detecting some summons legitimately hitting over the calculated limit\n+            int watk = Math.max(player.getTotalWatk(), 14);\n+            Item weapon_item = player.getInventory(MapleInventoryType.EQUIPPED).getItem((short) -11);\n+            \n+            int maxBaseDmg;  // thanks Conrad, Atoot for detecting some summons legitimately hitting over the calculated limit\n+            if (weapon_item != null) {\n+                maxBaseDmg = player.calculateMaxBaseDamage(watk, MapleItemInformationProvider.getInstance().getWeaponType(weapon_item.getItemId()));\n+            } else {\n+                maxBaseDmg = player.calculateMaxBaseDamage(watk, MapleWeaponType.SWORD1H);\n+            }\n+            \n             float summonDmgMod = (maxBaseDmg >= 438) ? 0.054f : 0.077f;\n             maxDamage = maxBaseDmg * (summonDmgMod * summonEffect.getWatk());\n         }"}, {"sha": "79cef27403d77fd9853ac37c895d939a75075dd5", "filename": "src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/coordinator/MapleMatchCheckerCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleMatchCheckerCoordinator.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -300,7 +300,7 @@ public boolean createMatchConfirmation(MatchCheckerType matchType, int world, in\n     }\n     \n     private void disposeMatchElement(MapleMatchCheckingElement mmce) {\n-        Set<Integer> matchPlayers = mmce.getMatchPlayers();\n+        Set<Integer> matchPlayers = mmce.getMatchPlayers();     // thanks Ai for noticing players getting match-stuck on certain cases\n         while (!poolMatchPlayers(matchPlayers)) {\n             try {\n                 Thread.sleep(1000);"}, {"sha": "fa1df90ca4a941f0c274555e1dd2fddc160d8594", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -47,6 +47,7 @@\n import java.util.Map.Entry;\n import java.util.SortedMap;\n import java.util.TreeMap;\n+import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n@@ -130,7 +131,7 @@\n     \n     private Set<Integer> queuedGuilds = new HashSet<>();\n     private Map<Integer, Pair<Pair<Boolean, Boolean>, Pair<Integer, Integer>>> queuedMarriages = new HashMap<>();\n-    private Map<Integer, Set<Integer>> marriageGuests = new HashMap<>();\n+    private Map<Integer, Set<Integer>> marriageGuests = new ConcurrentHashMap<>();\n     \n     private Map<Integer, Integer> partyChars = new HashMap<>();\n     private Map<Integer, MapleParty> parties = new HashMap<>();\n@@ -720,7 +721,7 @@ public void putMarriageQueued(int marriageId, boolean cathedral, boolean premium\n         return new Pair<>(type, guests);\n     }\n     \n-    public synchronized boolean addMarriageGuest(int marriageId, int playerId) {\n+    public boolean addMarriageGuest(int marriageId, int playerId) {\n         Set<Integer> guests = marriageGuests.get(marriageId);\n         if(guests != null) {\n             if(guests.contains(playerId)) return false;"}, {"sha": "b6f8c031a6fdfb76dbbdb638a30f9cbd18f44b43", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 28, "deletions": 10, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -236,25 +236,43 @@ public boolean canHold(int itemid, int quantity, int removeItemid, int removeQua\n                 return canHoldAllAfterRemoving(Collections.singletonList(itemid), Collections.singletonList(quantity), Collections.singletonList(removeItemid), Collections.singletonList(removeQuantity));\n         }\n         \n-        private List<Integer> convertToIntegerArray(List<Double> list) {\n-                List<Integer> intList = new LinkedList<>();\n-                for(Double d: list) {\n-                        intList.add(d.intValue());\n+        private List<Integer> convertToIntegerArray(List<Object> list) {\n+                List<Integer> intList = new ArrayList<>();      // JAVA 7 Rhino script engine. Thanks Bruno, felipepm10 for noticing a typecast issue here.\n+                \n+                if (ServerConstants.JAVA_8) {\n+                        for (Object d: list) {\n+                                intList.add(((Integer) d).intValue());\n+                        }\n+                } else {\n+                        for (Object d: list) {\n+                                intList.add(((Double) d).intValue());\n+                        }\n                 }\n \n                 return intList;\n         }\n         \n-        public boolean canHoldAll(List<Double> itemids) {\n-                List<Double> quantity = new LinkedList<>();\n-                for (int i = 0; i < itemids.size(); i++) {\n-                        quantity.add(1.0);\n+        public boolean canHoldAll(List<Object> itemids) {\n+                List<Object> quantity = new LinkedList<>();\n+                \n+                if (ServerConstants.JAVA_8) {\n+                        Integer intOne = 1;\n+                    \n+                        for (int i = 0; i < itemids.size(); i++) {\n+                                quantity.add(intOne);\n+                        }\n+                } else {\n+                        Double doubleOne = 1.0;\n+                    \n+                        for (int i = 0; i < itemids.size(); i++) {\n+                                quantity.add(doubleOne);\n+                        }\n                 }\n-            \n+                \n                 return canHoldAll(itemids, quantity);\n         }\n         \n-        public boolean canHoldAll(List<Double> itemids, List<Double> quantity) {\n+        public boolean canHoldAll(List<Object> itemids, List<Object> quantity) {\n                 return canHoldAll(convertToIntegerArray(itemids), convertToIntegerArray(quantity), true);\n         }\n         "}, {"sha": "bce4b556da9d05b3c4a157d983c58d31b5d7baf9", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 20, "deletions": 16, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -911,24 +911,28 @@ public MapleMonster getMonster(int mid) {\n                 return(MapleLifeFactory.getMonster(mid));\n         }\n         \n-        private List<Integer> convertToIntegerArray(List<Double> list) {\n-            List<Integer> intList;\n-            if(ServerConstants.JAVA_8)\n-                 intList=new ArrayList<Integer> (new ArrayList(java.util.Arrays.asList(list.toArray())));\n-            else\n-            {\n-                 intList = new ArrayList<>();\n-                for(Double d: list) intList.add(d.intValue());\n+        private List<Integer> convertToIntegerArray(List<Object> list) {\n+            List<Integer> intList = new ArrayList<>();\n+            \n+            if (ServerConstants.JAVA_8) {\n+                for (Object d: list) {\n+                    intList.add(((Integer) d).intValue());\n+                }\n+            } else {\n+                for (Object d: list) {\n+                    intList.add(((Double) d).intValue());\n+                }\n             }\n-                return intList;\n+            \n+            return intList;\n         }\n         \n-        public void setEventClearStageExp(List<Double> gain) {\n+        public void setEventClearStageExp(List<Object> gain) {\n                 onMapClearExp.clear();\n                 onMapClearExp.addAll(convertToIntegerArray(gain));\n         }\n         \n-        public void setEventClearStageMeso(List<Double> gain) {\n+        public void setEventClearStageMeso(List<Object> gain) {\n                 onMapClearMeso.clear();\n                 onMapClearMeso.addAll(convertToIntegerArray(gain));\n         }\n@@ -959,7 +963,7 @@ private void dropExclusiveItems(MapleCharacter chr) {\n                 }\n         }\n         \n-        public final void setExclusiveItems(List<Double> items) {\n+        public final void setExclusiveItems(List<Object> items) {\n                 List<Integer> exclusive = convertToIntegerArray(items);\n                 \n                 wL.lock();\n@@ -972,19 +976,19 @@ public final void setExclusiveItems(List<Double> items) {\n                 }\n         }\n         \n-        public final void setEventRewards(List<Double> rwds, List<Double> qtys, int expGiven) {\n+        public final void setEventRewards(List<Object> rwds, List<Object> qtys, int expGiven) {\n                 setEventRewards(1, rwds, qtys, expGiven);\n         }\n         \n-        public final void setEventRewards(List<Double> rwds, List<Double> qtys) {\n+        public final void setEventRewards(List<Object> rwds, List<Object> qtys) {\n                 setEventRewards(1, rwds, qtys);\n         }\n         \n-        public final void setEventRewards(int eventLevel, List<Double> rwds, List<Double> qtys) {\n+        public final void setEventRewards(int eventLevel, List<Object> rwds, List<Object> qtys) {\n                 setEventRewards(eventLevel, rwds, qtys, 0);\n         }\n         \n-        public final void setEventRewards(int eventLevel, List<Double> rwds, List<Double> qtys, int expGiven) {\n+        public final void setEventRewards(int eventLevel, List<Object> rwds, List<Object> qtys, int expGiven) {\n                 // fixed EXP will be rewarded at the same time the random item is given\n \n                 if(eventLevel <= 0 || eventLevel > ServerConstants.MAX_EVENT_LEVELS) return;"}, {"sha": "2a15dc29468eca4009a3b9eb72950efdce945ad7", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -167,10 +167,19 @@ private void emptyLocks() {\n         startLock = startLock.dispose();\n     }\n     \n-    private List<Integer> convertToIntegerArray(List<Double> list) {\n+    private List<Integer> convertToIntegerArray(List<Object> list) {\n         List<Integer> intList = new ArrayList<>();\n-        for(Double d: list) intList.add(d.intValue());\n-\n+        \n+        if (ServerConstants.JAVA_8) {\n+            for (Object d: list) {\n+                intList.add(((Integer) d).intValue());\n+            }\n+        } else {\n+            for (Object d: list) {\n+                intList.add(((Double) d).intValue());\n+            }\n+        }\n+        \n         return intList;\n     }\n     \n@@ -181,7 +190,7 @@ public long getLobbyDelay() {\n     private List<Integer> getLobbyRange() {\n         try {\n             if (!ServerConstants.JAVA_8) {\n-                return convertToIntegerArray((List<Double>)iv.invokeFunction(\"setLobbyRange\", (Object) null));\n+                return convertToIntegerArray((List<Object>)iv.invokeFunction(\"setLobbyRange\", (Object) null));\n             } else {  // java 8 support here thanks to MedicOP\n                 ScriptObjectMirror object = (ScriptObjectMirror) iv.invokeFunction(\"setLobbyRange\", (Object) null);\n                 int[] to = object.to(int[].class);"}, {"sha": "c84b5e2517f1376b1baccf4df029878d2317f170", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -35,6 +35,7 @@\n import scripting.AbstractPlayerInteraction;\n import server.MapleItemInformationProvider;\n import server.MapleStatEffect;\n+import server.MapleShop;\n import server.MapleShopFactory;\n import server.events.gm.MapleEvent;\n import server.gachapon.MapleGachapon;\n@@ -83,6 +84,7 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import tools.FilePrinter;\n \n /**\n  *\n@@ -400,7 +402,14 @@ public void resetStats() {\n \t}\n         \n         public void openShopNPC(int id) {\n-            MapleShopFactory.getInstance().getShop(id).sendShop(c);\n+            MapleShop shop = MapleShopFactory.getInstance().getShop(id);\n+            \n+            if (shop != null) {\n+                shop.sendShop(c);\n+            } else {    // check for missing shopids thanks to resinate\n+                FilePrinter.printError(FilePrinter.NPC_UNCODED, \"Shop ID: \" + id + \" is missing from database.\");\n+                MapleShopFactory.getInstance().getShop(11000).sendShop(c);\n+            }\n         }\n \n \tpublic void maxMastery() {"}, {"sha": "89ff6c338ade37af01b72f966e903972b81c6feb", "filename": "src/scripting/reactor/ReactorActionManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/reactor/ReactorActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/reactor/ReactorActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorActionManager.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -105,7 +105,7 @@ public void dropItems(boolean meso, int mesoChance, int minMeso, int maxMeso, in\n     }\n \n     public void dropItems(int posX, int posY, boolean meso, int mesoChance, int minMeso, int maxMeso, int minItems) {\n-        dropItems(false, posX, posY, meso, mesoChance, minMeso, maxMeso, minItems);\n+        dropItems(true, posX, posY, meso, mesoChance, minMeso, maxMeso, minItems);  // all reactors actually drop items sequentially... thanks inhyuk for pointing this out!\n     }\n     \n     public void dropItems(boolean delayed, int posX, int posY, boolean meso, int mesoChance, final int minMeso, final int maxMeso, int minItems) {"}, {"sha": "6e06f41ee90a30995f34aacf4f61d3b2aa0354ec", "filename": "src/scripting/reactor/ReactorScriptManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/reactor/ReactorScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/scripting/reactor/ReactorScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorScriptManager.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -114,7 +114,7 @@ public void untouch(MapleClient c, MapleReactor reactor) {\n         touching(c, reactor, false);\n     }\n \n-    public synchronized void touching(MapleClient c, MapleReactor reactor, boolean touching) {\n+    private void touching(MapleClient c, MapleReactor reactor, boolean touching) {\n         try {\n             Invocable iv = getInvocable(\"reactor/\" + reactor.getId() + \".js\", c);\n             if (iv == null) return;"}, {"sha": "64f9e72401338d0c175aa5946c25c34ebac6333c", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 5, "deletions": 16, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -1340,7 +1340,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n         if (localstatups.size() > 0) {\n             byte[] buff = null;\n             byte[] mbuff = null;\n-            if (getSummonMovementType() == null && this.isActive(applyto)) {\n+            if (this.isActive(applyto)) {\n                 buff = MaplePacketCreator.giveBuff((skill ? sourceid : -sourceid), localDuration, localstatups);\n             }\n             if (isDash()) {\n@@ -1390,11 +1390,10 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n             }\n \n             if (buff != null) {\n-                if (!hasNoIcon()) { //Thanks flav for such a simple release! :)\n-                    applyto.announce(buff);\n-                } else {\n-                    System.out.println(\"<Error> NO buff icon for id \" + sourceid);\n-                }\n+                //Thanks flav for such a simple release! :)\n+                //Thanks Conrad, Atoot for noticing summons not using buff icon\n+                \n+                applyto.announce(buff);\n             }\n \n             long starttime = Server.getInstance().getCurrentTime();\n@@ -1820,16 +1819,6 @@ private SummonMovementType getSummonMovementType() {\n         return null;\n     }\n \n-    public boolean hasNoIcon() {\n-        return (sourceid == 3111002 || sourceid == 3211002 || + // puppet, puppet\n-                sourceid == 3211005 || + // golden eagle\n-                sourceid == 2121005 || sourceid == 2221005 || + // elquines, ifrit\n-                sourceid == 2321003 || sourceid == 3121006 || + // bahamut, phoenix\n-                sourceid == 3221005 || sourceid == 3111005 || + // frostprey, silver hawk\n-                sourceid == 2311006 || sourceid == 5220002 || + // summon dragon, wrath of the octopi\n-                sourceid == 5211001 || sourceid == 5211002); // octopus, gaviota\n-    }\n-\n     public boolean isSkill() {\n         return skill;\n     }"}, {"sha": "17335dd105cd3c9d76400c5da29fc352c6698c75", "filename": "src/server/expeditions/MapleExpedition.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/expeditions/MapleExpedition.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/expeditions/MapleExpedition.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/expeditions/MapleExpedition.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -109,7 +109,6 @@ public MapleExpedition(MapleCharacter player, MapleExpeditionType met, boolean s\n                 minSize = (minPlayers != 0) ? minPlayers : type.getMinSize();\n                 maxSize = (maxPlayers != 0) ? maxPlayers : type.getMaxSize();\n \t\tbossLogs = new CopyOnWriteArrayList<>();\n-\t\tbeginRegistration();\n \t}\n         \n         public int getMinSize() {\n@@ -120,7 +119,7 @@ public int getMaxSize() {\n                 return maxSize;\n         }\n \n-\tprivate void beginRegistration() {\n+\tpublic void beginRegistration() {\n \t\tregistering = true;\n                 leader.announce(MaplePacketCreator.getClock(type.getRegistrationTime() * 60));\n \t\tif (!silent) {"}, {"sha": "0bb34c0d7f0d7a5adb2336e13a61e190b8de997c", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -548,14 +548,21 @@ private void distributePartyExperience(Map<MapleCharacter, Long> partyParticipat\n         int totalPartyLevel = 0;\n         \n         // thanks G h o s t, Alfred, Vcoc, BHB for poiting out a bug in detecting party members after membership transactions in a party took place\n-        for (MapleCharacter member : partyParticipation.keySet().iterator().next().getPartyMembersOnSameMap()) {\n-            if (!leechInterval.inInterval(member.getLevel())) {\n-                underleveled.add(member);\n-                continue;\n+        if (!ServerConstants.USE_ENFORCE_MOB_LEVEL_RANGE) {\n+            for (MapleCharacter member : partyParticipation.keySet().iterator().next().getPartyMembersOnSameMap()) {\n+                if (!leechInterval.inInterval(member.getLevel())) {\n+                    underleveled.add(member);\n+                    continue;\n+                }\n+\n+                totalPartyLevel += member.getLevel();\n+                expMembers.add(member);\n+            }\n+        } else {    // thanks Ari for noticing unused server flag after EXP system overhaul\n+            for (MapleCharacter member : partyParticipation.keySet().iterator().next().getPartyMembersOnSameMap()) {\n+                totalPartyLevel += member.getLevel();\n+                expMembers.add(member);\n             }\n-            \n-            totalPartyLevel += member.getLevel();\n-            expMembers.add(member);\n         }\n         \n         int membersSize = expMembers.size();"}, {"sha": "98eca826568718c5a78ffa2b80738763a1d5dbe9", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 19, "deletions": 30, "changes": 49, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -387,9 +387,10 @@ public void addPlayerNPCMapObject(MaplePlayerNPC pnpcobject) {\n     }\n     \n     public void addMapObject(MapleMapObject mapobject) {\n+        int curOID = getUsableOID();\n+        \n         objectWLock.lock();\n         try {\n-            int curOID = getUsableOID();\n             mapobject.setObjectId(curOID);\n             this.mapobjects.put(curOID, mapobject);\n         } finally {\n@@ -413,11 +414,11 @@ private void spawnAndAddRangedMapObject(MapleMapObject mapobject, DelayedPacketC\n \n     private void spawnAndAddRangedMapObject(MapleMapObject mapobject, DelayedPacketCreation packetbakery, SpawnCondition condition) {\n         List<MapleCharacter> inRangeCharacters = new LinkedList<>();\n+        int curOID = getUsableOID();\n         \n         chrRLock.lock();\n         objectWLock.lock();\n         try {\n-            int curOID = getUsableOID();\n             mapobject.setObjectId(curOID);\n             this.mapobjects.put(curOID, mapobject);\n             for (MapleCharacter chr : characters) {\n@@ -896,15 +897,16 @@ public int getDroppedItemCount() {\n         return droppedItemCount.get();\n     }\n     \n-    private synchronized void instantiateItemDrop(MapleMapItem mdrop) {\n+    private void instantiateItemDrop(MapleMapItem mdrop) {\n         if(droppedItemCount.get() >= ServerConstants.ITEM_LIMIT_ON_MAP) {\n             MapleMapObject mapobj;\n             \n             do {\n+                mapobj = null;\n+                \n                 objectWLock.lock();\n                 try {\n-                    mapobj = registeredDrops.remove(0).get();\n-                    while(mapobj == null) {\n+                    while (mapobj == null) {\n                         if (registeredDrops.isEmpty()) {\n                             break;\n                         }\n@@ -1576,18 +1578,11 @@ public final void destroyReactors(final int first, final int last) {\n \n     public void destroyReactor(int oid) {\n         final MapleReactor reactor = getReactorByOid(oid);\n-        broadcastMessage(MaplePacketCreator.destroyReactor(reactor));\n-        reactor.cancelReactorTimeout();\n-        reactor.setAlive(false);\n-        removeMapObject(reactor);\n         \n-        if (reactor.getDelay() > 0) {\n-            registerMapSchedule(new Runnable() {\n-                @Override\n-                public void run() {\n-                    respawnReactor(reactor);\n-                }\n-            }, reactor.getDelay());\n+        if (reactor != null) {\n+            if (reactor.destroy()) {\n+                removeMapObject(reactor);\n+            }\n         }\n     }\n \n@@ -1611,9 +1606,14 @@ public void resetReactors() {\n     \n     public final void resetReactors(List<MapleReactor> list) {\n         for (MapleReactor r : list) {\n+            if (r.forceDelayedRespawn()) {  // thanks Conrad for suggesting reactor with delay respawning immediately\n+                continue;\n+            }\n+            \n             r.lockReactor();\n             try {\n                 r.resetReactorActions(0);\n+                r.setAlive(true);\n                 broadcastMessage(MaplePacketCreator.triggerReactor(r, 0));\n             } finally {\n                 r.unlockReactor();\n@@ -1742,7 +1742,7 @@ public boolean containsNPC(int npcid) {\n     \n     public void destroyNPC(int npcid) {     // assumption: there's at most one of the same NPC in a map.\n         List<MapleMapObject> npcs = getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.NPC));\n-\n+        \n         chrRLock.lock();\n         objectWLock.lock();\n         try {\n@@ -2106,19 +2106,6 @@ public void sendPackets(MapleClient c) {\n                 c.announce(reactor.makeSpawnData());\n             }\n         });\n-\n-    }\n-\n-    private void respawnReactor(final MapleReactor reactor) {\n-        reactor.lockReactor();\n-        try {\n-            reactor.resetReactorActions(0);\n-            reactor.setAlive(true);\n-        } finally {\n-            reactor.unlockReactor();\n-        }\n-        \n-        spawnReactor(reactor);\n     }\n \n     public void spawnDoor(final MapleDoorObject door) {\n@@ -2587,6 +2574,7 @@ public void run() {\n                 break;\n             }\n         }\n+        chr.commitExcludedItems();  // thanks OishiiKawaiiDesu for noticing pet item ignore registry erasing upon changing maps\n         \n         if (chr.getMonsterCarnival() != null) {\n             chr.getClient().announce(MaplePacketCreator.getClock(chr.getMonsterCarnival().getTimeLeftSeconds()));\n@@ -3555,6 +3543,7 @@ public void run() {\n                                         reactor.lockReactor();\n                                         try {\n                                             reactor.resetReactorActions(0);\n+                                            reactor.setAlive(true);\n                                             broadcastMessage(MaplePacketCreator.triggerReactor(reactor, 0));\n                                         } finally {\n                                             reactor.unlockReactor();"}, {"sha": "036bd7757818a9781bd2d98f682da1d84f79e59e", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -278,10 +278,10 @@ public static MapleMap loadMapFromWz(int mapid, int world, int channel, EventIns\n             MapleData mcData = mapData.getChildByPath(\"monsterCarnival\");\n             if (mcData != null) {\n                 map.setDeathCP(MapleDataTool.getIntConvert(\"deathCP\", mcData, 0));\n-                map.setMaxMobs(MapleDataTool.getIntConvert(\"mobGenMax\", mcData, 0));\n+                map.setMaxMobs(MapleDataTool.getIntConvert(\"mobGenMax\", mcData, Integer.MAX_VALUE));    // thanks Atoot for noticing CPQ1 bf. 3 & 4 not accepting spawns due to undefined limits\n                 map.setTimeDefault(MapleDataTool.getIntConvert(\"timeDefault\", mcData, 0));\n                 map.setTimeExpand(MapleDataTool.getIntConvert(\"timeExpand\", mcData, 0));\n-                map.setMaxReactors(MapleDataTool.getIntConvert(\"guardianGenMax\", mcData, 0));\n+                map.setMaxReactors(MapleDataTool.getIntConvert(\"guardianGenMax\", mcData, Integer.MAX_VALUE));\n                 MapleData guardianGenData = mcData.getChildByPath(\"guardianGenPos\");\n                 for (MapleData node : guardianGenData.getChildren()) {\n                     GuardianSpawnPoint pt = new GuardianSpawnPoint(new Point(MapleDataTool.getIntConvert(\"x\", node), MapleDataTool.getIntConvert(\"y\", node)));"}, {"sha": "68ef3c9e05c45e6337110b70f840841e500a12c3", "filename": "src/server/maps/MapleReactor.java", "status": "modified", "additions": 69, "deletions": 1, "changes": 70, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleReactor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/maps/MapleReactor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleReactor.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -57,6 +57,7 @@\n     private boolean shouldCollect;\n     private boolean attackHit;\n     private ScheduledFuture<?> timeoutTask = null;\n+    private Runnable delayedRespawnRun = null;\n     private GuardianSpawnPoint guardian = null;\n     private byte facingDirection = 0;\n     private Lock reactorLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.REACTOR, true);\n@@ -165,7 +166,9 @@ public void sendDestroyData(MapleClient client) {\n \n     @Override\n     public void sendSpawnData(MapleClient client) {\n-        client.announce(makeSpawnData());\n+        if (this.isAlive()) {\n+            client.announce(makeSpawnData());\n+        }\n     }\n \n     public final byte[] makeSpawnData() {\n@@ -318,6 +321,71 @@ public void hitReactor(boolean wHit, int charPos, short stance, int skillid, Map\n             e.printStackTrace();\n         }\n     }\n+    \n+    public boolean destroy() {\n+        if (reactorLock.tryLock()) {\n+            try {\n+                boolean alive = this.isAlive();\n+                if (alive) {\n+                    this.setAlive(false);\n+                    this.cancelReactorTimeout();\n+\n+                    if (this.getDelay() > 0) {\n+                        this.delayedRespawn();\n+                    }\n+                } else if (this.inDelayedRespawn()) {\n+                    return false;\n+                } else {\n+                    return true;    // reactor neither alive nor in delayed respawn, remove map object allowed\n+                }\n+            } finally {\n+                reactorLock.unlock();\n+            }\n+        }\n+        \n+        map.broadcastMessage(MaplePacketCreator.destroyReactor(this));\n+        return false;\n+    }\n+    \n+    private void respawn() {\n+        this.lockReactor();\n+        try {\n+            this.resetReactorActions(0);\n+            this.setAlive(true);\n+        } finally {\n+            this.unlockReactor();\n+        }\n+        \n+        map.broadcastMessage(this.makeSpawnData());\n+    }\n+    \n+    public void delayedRespawn() {\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                delayedRespawnRun = null;\n+                respawn();\n+            }\n+        };\n+        \n+        delayedRespawnRun = r;\n+        map.getChannelServer().registerOverallAction(map.getId(), r, this.getDelay());\n+    }\n+    \n+    public boolean forceDelayedRespawn() {\n+        Runnable r = delayedRespawnRun;\n+        \n+        if (r != null) {\n+            map.getChannelServer().forceRunOverallAction(map.getId(), r);\n+            return true;\n+        } else {\n+            return false;\n+        }\n+    }\n+    \n+    public boolean inDelayedRespawn() {\n+        return delayedRespawnRun != null;\n+    }\n \n     public Rectangle getArea() {\n         return new Rectangle(getPosition().x + stats.getTL().x, getPosition().y + stats.getTL().y, stats.getBR().x - stats.getTL().x, stats.getBR().y - stats.getTL().y);"}, {"sha": "76630bb3dccdbf882ffc6e03b3c783cc3066008d", "filename": "src/server/partyquest/MonsterCarnival.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/partyquest/MonsterCarnival.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/server/partyquest/MonsterCarnival.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MonsterCarnival.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -94,7 +94,7 @@ public MonsterCarnival(MapleParty p1, MapleParty p2, int mapid, boolean cpq1, in\n                 public void run() {\n                     timeUp();\n                 }\n-            }, (map.getTimeDefault() - 10) * 1000);\n+            }, map.getTimeDefault() * 1000); // thanks Atoot for noticing an irregular \"event extended\" issue here\n             effectTimer = TimerManager.getInstance().schedule(new Runnable() {\n                 @Override\n                 public void run() {"}, {"sha": "a2f6c124fd49296d3449e9c63397fd23c64e6822", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -337,7 +337,7 @@ private static void addCharEntry(final MaplePacketLittleEndianWriter mplew, Mapl\n                 if (!viewall) {\n                         mplew.write(0);\n                 }\n-                if (chr.isGM()) {\n+                if (chr.isGM() || chr.isGmJob()) {  // thanks Egg Daddy (Ubaware), resinate for noticing GM jobs crashing on non-GM players account\n                         mplew.write(0);\n                         return;\n                 }\n@@ -1811,14 +1811,19 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n         }\n \n         public static byte[] dropItemFromMapObject(MapleCharacter player, MapleMapItem drop, Point dropfrom, Point dropto, byte mod) {\n+                int dropType = drop.getDropType();\n+                if (drop.hasClientsideOwnership(player) && dropType < 3) {\n+                    dropType = 2;\n+                }\n+            \n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.DROP_ITEM_FROM_MAPOBJECT.getValue());\n                 mplew.write(mod);\n                 mplew.writeInt(drop.getObjectId());\n                 mplew.writeBool(drop.getMeso() > 0); // 1 mesos, 0 item, 2 and above all item meso bag,\n                 mplew.writeInt(drop.getItemId()); // drop object ID\n                 mplew.writeInt(drop.getClientsideOwnerId()); // owner charid/partyid :)\n-                mplew.write(drop.hasClientsideOwnership(player) ? 2 : drop.getDropType()); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA\n+                mplew.write(dropType); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA\n                 mplew.writePos(dropto);\n                 mplew.writeInt(drop.getDropper().getObjectId()); // dropper oid, found thanks to Li Jixue\n "}, {"sha": "41f9468146a020a81167966554f1150a0c5efd15", "filename": "wz/Character.wz/Longcoat/01050018.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050018.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050018.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01050018.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -20,7 +20,6 @@\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"price\" value=\"15000\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <imgdir name=\"level\">\n       <imgdir name=\"info\">\n         <imgdir name=\"1\">\n@@ -115,6 +114,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}, {"sha": "e6aed8455d16c2b60f54797a67c2e6728f99b3fb", "filename": "wz/Character.wz/Longcoat/01050100.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050100.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050100.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01050100.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -16,7 +16,6 @@\n     <int name=\"reqINT\" value=\"0\"/>\n     <int name=\"reqLUK\" value=\"0\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"incPDD\" value=\"20\"/>\n     <int name=\"incSpeed\" value=\"10\"/>\n@@ -115,6 +114,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}, {"sha": "54650795eebe62bea70dd9cd6825a69f505372b1", "filename": "wz/Character.wz/Longcoat/01050127.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050127.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01050127.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01050127.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -16,7 +16,6 @@\n     <int name=\"reqINT\" value=\"0\"/>\n     <int name=\"reqLUK\" value=\"0\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"incPDD\" value=\"20\"/>\n     <int name=\"incSpeed\" value=\"5\"/>\n@@ -116,6 +115,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}, {"sha": "9304c640cae650f5f52ad70d8b9d27d54d6002f5", "filename": "wz/Character.wz/Longcoat/01051017.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051017.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051017.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01051017.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -20,7 +20,6 @@\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"price\" value=\"15000\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <imgdir name=\"level\">\n       <imgdir name=\"info\">\n         <imgdir name=\"1\">\n@@ -115,6 +114,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}, {"sha": "fa0c2cdfee6c1572a20384fd932f7de2bd01e241", "filename": "wz/Character.wz/Longcoat/01051098.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051098.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051098.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01051098.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -16,7 +16,6 @@\n     <int name=\"reqINT\" value=\"0\"/>\n     <int name=\"reqLUK\" value=\"0\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"incPDD\" value=\"20\"/>\n     <int name=\"incSpeed\" value=\"10\"/>\n@@ -115,6 +114,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}, {"sha": "c5c97730e35927b4555da4d055c9b6a0524476da", "filename": "wz/Character.wz/Longcoat/01051140.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051140.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/85812ba48932eda720910c6bf2be4a3a5f2385b9/wz/Character.wz/Longcoat/01051140.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Longcoat/01051140.img.xml?ref=85812ba48932eda720910c6bf2be4a3a5f2385b9", "patch": "@@ -16,7 +16,6 @@\n     <int name=\"reqINT\" value=\"0\"/>\n     <int name=\"reqLUK\" value=\"0\"/>\n     <int name=\"cash\" value=\"0\"/>\n-    <float name=\"recovery\" value=\"15.0\"/>\n     <int name=\"tuc\" value=\"10\"/>\n     <int name=\"incPDD\" value=\"20\"/>\n     <int name=\"incSpeed\" value=\"5\"/>\n@@ -116,6 +115,7 @@\n         </imgdir>\n       </imgdir>\n     </imgdir>\n+    <double name=\"recovery\" value=\"1,5\"/>\n   </imgdir>\n   <imgdir name=\"walk1\">\n     <imgdir name=\"0\">"}]}]},
