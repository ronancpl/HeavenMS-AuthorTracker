{"fetchDate": "2019-12-19", "content": [{"sha": "c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YzNlM2M2ZGZiYjMzZTllNDQyYzA3ZGZkZGM2ZjMyYjhlNTQzOTM5OA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-09-07T17:55:29Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-09-07T17:55:29Z"}, "message": "Event Recall + Cash Shop bestsellers + MapleSessionCoordinator rework\n\nImplemented an event recall system. Players that went disconnected during an event instance are able to rejoin the ongoing event upon relogin.\nImplemented a player-activity backed best-sellers system for the Cash Shop.\nPatched the recently added selective loot system interfering with quest items, ever disabling drops after the player picked up one item.\nImplemented a server flag for everlasting buffs.\nFixed some inconsistencies with Priest Dispel skill, sometimes crashing party players.\nFixed change job not properly showing effects for other players.\nFixed wrong fee value being taken from players that expands their guild size. Also, implemented GMS-like fee for this action.\nReworked the MapleSessionCoordinator, now evaluating client's HWID as well as remote IP. This's expected to lessen account drought time for players that are constantly changing their IP.\n\nLast but not least, added world maps for Mushroom Castle, Zipangu, CBD/Malaysia and Ellin Forest regions. Original artwork content used on files depicted in this topic are rightful property of Nexon Corps., these files thoroughly trying to adhere the \"Fair Use\" disclaimer policy, their purpose being solely to fulfill gaming experience for the areas that were already present on v83 GMS but still lacked worldmaps. For more info regarding Fair Use, please refer to \"http://www.dmlp.org/legal-guide/fair-use\".", "tree": {"sha": "113a37175acd56f87384f187fa6bd991db63a8a7", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/113a37175acd56f87384f187fa6bd991db63a8a7"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "html_url": "https://github.com/ronancpl/HeavenMS/commit/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "132f28639180aea52aba572ce8b528fbd839dec1", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/132f28639180aea52aba572ce8b528fbd839dec1", "html_url": "https://github.com/ronancpl/HeavenMS/commit/132f28639180aea52aba572ce8b528fbd839dec1"}], "stats": {"total": 3330, "additions": 2711, "deletions": 619}, "files": [{"sha": "023d4d38227202d6fe3f0300f3ca516ac26b918f", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1265,4 +1265,31 @@ Corrigido setGender n\u00e3o modificando estado do cliente para n\u00e3o-logado ao cance\n 24 Agosto 2018,\n Melhorado mec\u00e2nica de logout de l\u00edder de party, passando a lideran\u00e7a adiante antes de efetivamente deslogar, permitindo assim inst\u00e2ncias a continuarem ap\u00f3s a sa\u00edda do mesmo, dadas circunst\u00e2ncias favor\u00e1veis.\n Outra corre\u00e7\u00e3o no XMLDomMapleData, que ainda continua dando NullPointerExceptions.\n-Corrigido stati de mobs n\u00e3o protegido concorrentemente em certos casos.\n\\ No newline at end of file\n+Corrigido stati de mobs n\u00e3o protegido concorrentemente em certos casos.\n+\n+28 Agosto 2018,\n+Implementado sistema de rewarp para inst\u00e2ncias de eventos, usado por jogadores ao se reconectar ao jogo. Ideia de Alisson.\n+Adicionado contador de compras de itens do cash shop. Sugest\u00e3o de mais comprados do cash shop implementado.\n+Otimizado fun\u00e7\u00e3o goto, agora n\u00e3o mais gerando mapas de cidade/mapid a todo uso de comando.\n+\n+29 - 31 Agosto 2018,\n+Melhorado fun\u00e7\u00e3o de disconnect do MapleClient, evitando m\u00faltiplos envios de dados do jogador \u00e0 DB.\n+Desenhado (todo conte\u00fado de imagens creditado \u00e0 Nexon) e implementado novos mapas-mundi referente a regi\u00f5es de M. Shrine, Showa, CBD e Metropolis/Kampung.\n+\n+03 Agosto 2018,\n+Implementado buffs inexpir\u00e1veis.\n+Corrigido comando resetStats n\u00e3o levando em conta AP's atuais dos jogadores.\n+Corrigido novo sistema gerenciador de loots removendo a possibilidade de conseguir novos itens de quest ap\u00f3s coleta do primeiro item.\n+\n+04 Agosto 2018,\n+Corrigido um flicker na anima\u00e7\u00e3o do efeito da skill Hurricane.\n+Ajustado MapleSessionCoordinator, agora verificando HWID's ao inv\u00e9s de contar somente com o remote IP, evitando nega\u00e7\u00e3o de servi\u00e7o para usu\u00e1rios de VPNs.\n+Corrigido dispel normal incorretamente mostrando efeitos aleat\u00f3rios a outros jogadores, issue apontado por Thora.\n+Corrigido change job n\u00e3o mostrando efeito a outros jogadores.\n+Corrigido valores incorretos sendo retirado de jogadores para expans\u00e3o de guild, issue apontado por Thora.\n+\n+05 Agosto 2018,\n+Adicionado world map em Ellin Forest.\n+Protegido concorrentemente sistema de fames.\n+Adicionado ganho de quest points para jogadores que participam de PQs. Reformulado sistema de quest points para viabilizar a nova feature.\n+Otimizado m\u00e9todo de ganho de experi\u00eancia em equipamentos, agora devidamente cacheado e sem busca em strings no processo.\n\\ No newline at end of file"}, {"sha": "b7375e1e9db89b41595a4ec5f23a9af2a833341c", "filename": "nbproject/private/private.properties", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/nbproject/private/private.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/nbproject/private/private.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.properties?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -7,4 +7,4 @@ file.reference.slf4j-api-1.6.6.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\slf4j-api-1.6.6.j\n file.reference.slf4j-jdk14-1.7.5.jar=C:\\\\Nexon\\\\HeavenMS\\\\cores\\\\slf4j-jdk14-1.7.5.jar\n javac.debug=true\n javadoc.preview=true\n-user.properties.file=C:\\\\Users\\\\USER\\\\AppData\\\\Roaming\\\\NetBeans\\\\8.0.2\\\\build.properties\n+user.properties.file=C:\\\\Users\\\\RonanLana\\\\AppData\\\\Roaming\\\\NetBeans\\\\8.0.2\\\\build.properties"}, {"sha": "74ce27aa947b3726a46be3bab4f6095990dfd535", "filename": "scripts/event/HenesysPQ.js", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/event/HenesysPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/event/HenesysPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HenesysPQ.js?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -142,6 +142,11 @@ function scheduledTimeout(eim) {\n         }\n }\n \n+function bunnyDefeated(eim) {\n+        eim.dropMessage(5, \"Due to your failure to protect the Moon Bunny, you have been transported to the Exile Map.\");\n+        end(eim);\n+}\n+\n function playerUnregistered(eim, player) {}\n \n function playerExit(eim, player) {\n@@ -232,6 +237,12 @@ function clearPQ(eim) {\n \n function monsterKilled(mob, eim) {}\n \n+function friendlyKilled(mob, eim) {\n+        if (mob.getId() == 9300061) {\n+                eim.schedule(\"bunnyDefeated\", 5 * 1000);\n+        }\n+}\n+\n function allMonstersDead(eim) {}\n \n function cancelSchedule() {}"}, {"sha": "37ecd3ece95356cbbd7fa8c0f0d20372340ae9c5", "filename": "scripts/npc/2020002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/2020002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/2020002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020002.js?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -185,7 +185,7 @@ function action(mode, type, selection) {\n                     cm.gainItem(mats[i], -matQty [i]);\n             else\n                 cm.gainItem(mats, -matQty );\n-            cm.gainMeso(-cost );\n+            cm.gainMeso(-cost);\n             cm.gainItem(item, 1);\n             cm.sendOk(\"All done. Stay warm!\");\n         }"}, {"sha": "0290ddf1b1f51792b7983a79298bd327b7dfad12", "filename": "scripts/npc/9201084.js", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/9201084.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/9201084.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201084.js?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,45 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status;\n+ \n+function start() {\n+        status = -1;\n+        action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if(status == 0) {\n+                        cm.dispose();\n+                }\n+        }\n+}\n\\ No newline at end of file"}, {"sha": "9725a8388ed862c7644782143fd00e4396069977", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -32,7 +32,7 @@ var ambientSong = \"Bgm04/Shinin'Harbor\";\n var feature_tree = [];\n var feature_cursor;\n \n-var tabs = [\"PQs\", \"Skills\", \"Quests\", \"Player Social Network\", \"Cash & Items\", \"Monsters, Maps & Reactors\", \"PQ potentials\", \"Player potentials\", \"Server potentials\", \"Admin/GM commands\", \"Custom NPCs\", \"Localhost edits\", \"Project\"];\n+var tabs = [\"PQs\", \"Skills\", \"Quests\", \"Player Social Network\", \"Cash & Items\", \"Monsters, Maps & Reactors\", \"PQ potentials\", \"Player potentials\", \"Server potentials\", \"Commands\", \"Custom NPCs\", \"Localhost edits\", \"Project\"];\n \n function addFeature(feature) {\n         feature_cursor.push(feature);\n@@ -43,7 +43,7 @@ function writeFeatureTab_PQs() {\n         addFeature(\"RnJPQ/HorntailPQ/TreasurePQ/ElnathPQ/HolidayPQ.\");\n         addFeature(\"CWKPQ as Expedition-based instance.\");\n         addFeature(\"Scarga/Horntail/Showa/Balrog/Zakum/Pinkbean.\");\n-        addFeature(\"GuildPQ & queue with multi-lobby systems available.\");\n+        addFeature(\"GuildPQ & queue with multi-lobby system available.\");\n         addFeature(\"Brand-new PQs: BossRushPQ, CafePQ.\");\n         addFeature(\"Mu Lung Dojo.\");\n         addFeature(\"Capt. Latanica with party fighting the boss.\");\n@@ -128,6 +128,7 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Reactors pick items up smartly from the field.\");\n         addFeature(\"Updated scripted portals now with proper portal SFX.\");\n         addFeature(\"Reviewed Masteria, W. Tour, N. Desert and Neo City.\");\n+        addFeature(\"Added world maps for M. Castle, W. Tour & Ellin areas.\");\n         addFeature(\"Giant Cake boss drops s. bags and Maple items.\");\n }\n \n@@ -137,13 +138,14 @@ function writeFeatureTab_PQpotentials() {\n         addFeature(\"Exped system: Many parties can join a same instance.\");\n         addFeature(\"Guild queue: guild registration for the GPQ.\");\n         addFeature(\"EIM Pool system: optimized instance loadouts.\");\n+        addFeature(\"Recall system: players can rejoin PQ after d/c.\");\n }\n \n function writeFeatureTab_Playerpotentials() {\n         addFeature(\"Adventurer Mount quests functional.\");\n         addFeature(\"All Equipment levels up.\");\n         addFeature(\"Player level rates.\");\n-        addFeature(\"Gain fame by quests.\");\n+        addFeature(\"Gain fame by quests and event instances.\");\n         addFeature(\"Pet evolutions functional (not GMS-like).\");\n         addFeature(\"Reviewed keybinding system.\");\n         addFeature(\"Character slots per world/server-wide.\");\n@@ -160,6 +162,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Enhanced AP auto-assigner: focus on eqp demands.\");\n         addFeature(\"Enhanced inventory check: free slots smartly fetched.\");\n         addFeature(\"Enhanced petloot handler: no brute-force inv. checks.\");\n+        addFeature(\"Players-appointed bestsellers for Owl and Cash Shop.\");\n         addFeature(\"Tweaked pet/mount hunger to a balanced growth rate.\");\n         addFeature(\"Consistent experience and meso gain system.\");\n         addFeature(\"NPC crafters won't take items freely anymore.\");\n@@ -184,7 +187,7 @@ function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Automatic account registration - thanks shavit!\");\n }\n \n-function writeFeatureTab_AdminGMcommands() {\n+function writeFeatureTab_Commands() {\n         addFeature(\"Spawn Zakum/Horntail/Pinkbean.\");\n         addFeature(\"Several new commands.\");\n         addFeature(\"Rank command highlighting users by world or overall.\");"}, {"sha": "b90af5eae3b0b090a9b76f3397a3005bedbd3970", "filename": "scripts/npc/commands.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/commands.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/scripts/npc/commands.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/commands.js?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -47,7 +47,7 @@ function action(mode, type, selection) {\n \n                         cm.sendSimple(sendStr);\n                 } else if(status == 1) {\n-                        var lvComm, lvDesc, lvHead = (cm.getPlayer().gmLevel() < 2) ? common_heading : staff_heading;\n+                        var lvComm, lvDesc, lvHead = (selection < 2) ? common_heading : staff_heading;\n                         \n                         if(selection > 6) {\n                                 selection = 6;"}, {"sha": "57a1499d174acc9a0c70f5eb2b4af84689fbc741", "filename": "sql/db_database.sql", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -12935,6 +12935,14 @@ CREATE TABLE IF NOT EXISTS `htsquads` (\n   PRIMARY KEY (`id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n \n+CREATE TABLE IF NOT EXISTS `hwidaccounts` (\n+  `accountid` int(11) NOT NULL DEFAULT '0',\n+  `hwid` varchar(40) NOT NULL DEFAULT '',\n+  `relevance` tinyint(2) NOT NULL DEFAULT '0',\n+  `expiresat` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n+  PRIMARY KEY (`accountid`,`hwid`)\n+) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n+\n CREATE TABLE IF NOT EXISTS `hwidbans` (\n   `hwidbanid` int(10) unsigned NOT NULL AUTO_INCREMENT,\n   `hwid` varchar(30) NOT NULL,\n@@ -13005,14 +13013,6 @@ CREATE TABLE IF NOT EXISTS `ipbans` (\n   PRIMARY KEY (`ipbanid`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n \n-CREATE TABLE IF NOT EXISTS `ipaccounts` (\n-  `accountid` int(11) NOT NULL DEFAULT '0',\n-  `ip` varchar(40) NOT NULL DEFAULT '',\n-  `relevance` tinyint(2) NOT NULL DEFAULT '0',\n-  `expiresat` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n-  PRIMARY KEY (`accountid`,`ip`)\n-) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n-\n CREATE TABLE IF NOT EXISTS `keymap` (\n   `id` int(11) NOT NULL AUTO_INCREMENT,\n   `characterid` int(11) NOT NULL DEFAULT '0',"}, {"sha": "f46dbf5aee8e6511fc4ad1adecb0212a4085e641", "filename": "sql/db_drops.sql", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1871,7 +1871,7 @@ USE `heavenms`;\n (2230102, 4000020, 1, 1, 0, 200000), \n (2230102, 4000021, 1, 1, 0, 200000), \n (2230102, 4003004, 1, 1, 0, 7000), \n-(2230102, 4001372, 1, 1, 0, 200000), \n+(2230102, 4001372, 1, 1, 28282, 200000), \n (2230102, 2000001, 1, 1, 0, 40000), \n (2230102, 2000003, 1, 1, 0, 40000), \n (2230102, 2002004, 1, 1, 0, 10000), \n@@ -2107,7 +2107,7 @@ USE `heavenms`;\n (2230112, 1082186, 1, 1, 0, 700), \n (2230100, 4000007, 1, 1, 0, 200000), \n (2230100, 4030012, 1, 1, 0, 125000), \n-(2230100, 4001373, 1, 1, 0, 7000), \n+(2230100, 4001373, 1, 1, 28282, 200000), \n (2230100, 2000001, 1, 1, 0, 40000),\n (2230100, 2000003, 1, 1, 0, 40000),\n (2230100, 2002001, 1, 1, 0, 10000), \n@@ -20795,8 +20795,6 @@ USE `heavenms`;\n   UPDATE drop_data SET chance=0 WHERE itemid=2050099;\n   UPDATE drop_data SET questid=6191 WHERE itemid=4031477;\n   UPDATE drop_data SET questid=6190 WHERE itemid=4001111;\n-  UPDATE drop_data SET questid=28344 WHERE itemid=4001372;\n-  UPDATE drop_data SET questid=28282 WHERE itemid=4001373;\n \n   # two items named \"Sparta\": remove the entries where lv100 Sparta is being dropped by low-level mobs.\n   UPDATE IGNORE drop_data SET itemid=1402011 WHERE itemid=1302056 AND dropperid < 8000000;"}, {"sha": "b0038282e8c379e8f9fc5a19a256503414dccd3d", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 232, "deletions": 189, "changes": 421, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -998,7 +998,7 @@ public void removeSandboxItems() {  // sandbox idea thanks to Morty\n     }\n \n     public FameStatus canGiveFame(MapleCharacter from) {\n-        if (gmLevel > 0) {\n+        if (this.isGM()) {\n             return FameStatus.OK;\n         } else if (lastfametime >= System.currentTimeMillis() - 3600000 * 24) {\n             return FameStatus.NOT_TODAY;\n@@ -1171,9 +1171,7 @@ public void changeJob(MapleJob newJob) {\n         setMasteries(this.job.getId());\n         guildUpdate();\n         \n-        getMap().broadcastMessage(this, MaplePacketCreator.removePlayerFromMap(this.getId()), false);\n-        getMap().broadcastMessage(this, MaplePacketCreator.spawnPlayerMapObject(this), false);\n-        getMap().broadcastMessage(this, MaplePacketCreator.showForeignEffect(getId(), 8), false);\n+        getMap().broadcastMessage(this, MaplePacketCreator.showForeignEffect(this.getId(), 8), false);\n         \n         if (GameConstants.hasSPTable(newJob) && newJob.getId() != 2001) {\n             if (getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {\n@@ -1182,8 +1180,8 @@ public void changeJob(MapleJob newJob) {\n             createDragon();\n         }\n         \n-        if(ServerConstants.USE_ANNOUNCE_CHANGEJOB) {\n-            if(gmLevel > 1) {\n+        if (ServerConstants.USE_ANNOUNCE_CHANGEJOB) {\n+            if (!this.isGM()) {\n                 broadcastAcquaintances(6, \"[\" + GameConstants.ordinal(GameConstants.getJobBranch(newJob)) + \" Job] \" + name + \" has just become a \" + newJob.name() + \".\");\n             }\n         }\n@@ -2793,7 +2791,6 @@ public void run() {\n     }\n \n     public enum FameStatus {\n-\n         OK, NOT_TODAY, NOT_THIS_MONTH\n     }\n \n@@ -2887,9 +2884,39 @@ private void gainExpInternal(long gain, int equip, int party, boolean show, bool\n         }\n     }\n \n+    private synchronized int applyFame(int delta) {\n+        int newFame = fame + delta;\n+        if (newFame < -30000) {\n+            delta = -(30000 + fame);\n+        } else if (newFame > 30000) {\n+            delta = 30000 - fame;\n+        }\n+        \n+        fame += delta;\n+        return delta;\n+    }\n+    \n     public void gainFame(int delta) {\n-        this.addFame(delta);\n-        this.updateSingleStat(MapleStat.FAME, this.fame);\n+        gainFame(delta, null, 0);\n+    }\n+    \n+    public boolean gainFame(int delta, MapleCharacter fromPlayer, int mode) {\n+        delta = applyFame(delta);\n+        if (delta != 0) {\n+            int thisFame = fame;\n+            updateSingleStat(MapleStat.FAME, thisFame);\n+            \n+            if (fromPlayer != null) {\n+                fromPlayer.announce(MaplePacketCreator.giveFameResponse(mode, getName(), thisFame));\n+                announce(MaplePacketCreator.receiveFame(mode, fromPlayer.getName()));\n+            } else {\n+                announce(MaplePacketCreator.getShowFameGain(delta));\n+            }\n+            \n+            return true;\n+        } else {\n+            return false;\n+        }\n     }\n     \n     public void gainMeso(int gain) {\n@@ -5417,16 +5444,18 @@ public boolean hasEmptySlot(byte invType) {\n         return getInventory(MapleInventoryType.getByType(invType)).getNextFreeSlot() > -1;\n     }\n \n-    public void increaseGuildCapacity() { //hopefully nothing is null\n-        if (getMeso() < MapleGuild.getIncreaseGuildCost(getGuild().getCapacity())) {\n+    public void increaseGuildCapacity() {\n+        int cost = MapleGuild.getIncreaseGuildCost(getGuild().getCapacity());\n+        \n+        if (getMeso() < cost) {\n             dropMessage(1, \"You don't have enough mesos.\");\n             return;\n         }\n         \n         if(Server.getInstance().increaseGuildCapacity(guildid)) {\n-            gainMeso(-MapleGuild.getIncreaseGuildCost(getGuild().getCapacity()), true, false, false);\n+            gainMeso(-cost, true, false, true);\n         } else {\n-            dropMessage(1, \"You guild already reached the maximum capacity of players.\");\n+            dropMessage(1, \"Your guild already reached the maximum capacity of players.\");\n         }\n     }\n \n@@ -5581,155 +5610,160 @@ public void leaveMap() {\n     }\n \n     public void levelUp(boolean takeexp) {\n-        Skill improvingMaxHP = null;\n-        Skill improvingMaxMP = null;\n-        int improvingMaxHPLevel = 0;\n-        int improvingMaxMPLevel = 0;\n-\n-        boolean isBeginner = isBeginnerJob();\n-        if (ServerConstants.USE_AUTOASSIGN_STARTERS_AP && isBeginner && level < 11) {\n-            remainingAp = 0;\n-            if (level < 6) {\n-                str += 5;\n+        petLock.lock();\n+        try {\n+            Skill improvingMaxHP = null;\n+            Skill improvingMaxMP = null;\n+            int improvingMaxHPLevel = 0;\n+            int improvingMaxMPLevel = 0;\n+\n+            boolean isBeginner = isBeginnerJob();\n+            if (ServerConstants.USE_AUTOASSIGN_STARTERS_AP && isBeginner && level < 11) {\n+                remainingAp = 0;\n+                if (level < 6) {\n+                    str += 5;\n+                } else {\n+                    str += 4;\n+                    dex += 1;\n+                }\n             } else {\n-                str += 4;\n-                dex += 1;\n+                remainingAp += 5;\n+                if (isCygnus() && level > 10 && level < 70) {\n+                    remainingAp++;\n+                }\n+            }\n+\n+            if (isBeginner) {\n+                maxhp += Randomizer.rand(12, 16);\n+                maxmp += Randomizer.rand(10, 12);\n+            } else if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1)) {\n+                improvingMaxHP = isCygnus() ? SkillFactory.getSkill(DawnWarrior.MAX_HP_INCREASE) : SkillFactory.getSkill(Swordsman.IMPROVED_MAX_HP_INCREASE);\n+                if (job.isA(MapleJob.CRUSADER)) {\n+                    improvingMaxMP = SkillFactory.getSkill(1210000);\n+                } else if (job.isA(MapleJob.DAWNWARRIOR2)) {\n+                    improvingMaxMP = SkillFactory.getSkill(11110000);\n+                }\n+                improvingMaxHPLevel = getSkillLevel(improvingMaxHP);\n+                maxhp += Randomizer.rand(24, 28);\n+                maxmp += Randomizer.rand(4, 6);\n+            } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n+                improvingMaxMP = isCygnus() ? SkillFactory.getSkill(BlazeWizard.INCREASING_MAX_MP) : SkillFactory.getSkill(Magician.IMPROVED_MAX_MP_INCREASE);\n+                improvingMaxMPLevel = getSkillLevel(improvingMaxMP);\n+                maxhp += Randomizer.rand(10, 14);\n+                maxmp += Randomizer.rand(22, 24);\n+            } else if (job.isA(MapleJob.BOWMAN) || job.isA(MapleJob.THIEF) || (job.getId() > 1299 && job.getId() < 1500)) {\n+                maxhp += Randomizer.rand(20, 24);\n+                maxmp += Randomizer.rand(14, 16);\n+            } else if (job.isA(MapleJob.GM)) {\n+                maxhp = 30000;\n+                maxmp = 30000;\n+            } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n+                improvingMaxHP = isCygnus() ? SkillFactory.getSkill(ThunderBreaker.IMPROVE_MAX_HP) : SkillFactory.getSkill(5100000);\n+                improvingMaxHPLevel = getSkillLevel(improvingMaxHP);\n+                maxhp += Randomizer.rand(22, 28);\n+                maxmp += Randomizer.rand(18, 23);\n+            } else if (job.isA(MapleJob.ARAN1)) {\n+                maxhp += Randomizer.rand(44, 48);\n+                int aids = Randomizer.rand(4, 8);\n+                maxmp += aids + Math.floor(aids * 0.1);\n+            }\n+            if (improvingMaxHPLevel > 0 && (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.PIRATE) || job.isA(MapleJob.DAWNWARRIOR1))) {\n+                maxhp += improvingMaxHP.getEffect(improvingMaxHPLevel).getX();\n+            }\n+            if (improvingMaxMPLevel > 0 && (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.CRUSADER) || job.isA(MapleJob.BLAZEWIZARD1))) {\n+                maxmp += improvingMaxMP.getEffect(improvingMaxMPLevel).getX();\n+            }\n+\n+            if (ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n+                if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n+                    maxmp += localint_ / 20;\n+                } else {\n+                    maxmp += localint_ / 10;\n+                }\n             }\n-        } else {\n-            remainingAp += 5;\n-            if (isCygnus() && level > 10 && level < 70) {\n-                remainingAp++;\n-            }\n-        }\n-        \n-        if (isBeginner) {\n-            maxhp += Randomizer.rand(12, 16);\n-            maxmp += Randomizer.rand(10, 12);\n-        } else if (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.DAWNWARRIOR1)) {\n-            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(DawnWarrior.MAX_HP_INCREASE) : SkillFactory.getSkill(Swordsman.IMPROVED_MAX_HP_INCREASE);\n-            if (job.isA(MapleJob.CRUSADER)) {\n-                improvingMaxMP = SkillFactory.getSkill(1210000);\n-            } else if (job.isA(MapleJob.DAWNWARRIOR2)) {\n-                improvingMaxMP = SkillFactory.getSkill(11110000);\n-            }\n-            improvingMaxHPLevel = getSkillLevel(improvingMaxHP);\n-            maxhp += Randomizer.rand(24, 28);\n-            maxmp += Randomizer.rand(4, 6);\n-        } else if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n-            improvingMaxMP = isCygnus() ? SkillFactory.getSkill(BlazeWizard.INCREASING_MAX_MP) : SkillFactory.getSkill(Magician.IMPROVED_MAX_MP_INCREASE);\n-            improvingMaxMPLevel = getSkillLevel(improvingMaxMP);\n-            maxhp += Randomizer.rand(10, 14);\n-            maxmp += Randomizer.rand(22, 24);\n-        } else if (job.isA(MapleJob.BOWMAN) || job.isA(MapleJob.THIEF) || (job.getId() > 1299 && job.getId() < 1500)) {\n-            maxhp += Randomizer.rand(20, 24);\n-            maxmp += Randomizer.rand(14, 16);\n-        } else if (job.isA(MapleJob.GM)) {\n-            maxhp = 30000;\n-            maxmp = 30000;\n-        } else if (job.isA(MapleJob.PIRATE) || job.isA(MapleJob.THUNDERBREAKER1)) {\n-            improvingMaxHP = isCygnus() ? SkillFactory.getSkill(ThunderBreaker.IMPROVE_MAX_HP) : SkillFactory.getSkill(5100000);\n-            improvingMaxHPLevel = getSkillLevel(improvingMaxHP);\n-            maxhp += Randomizer.rand(22, 28);\n-            maxmp += Randomizer.rand(18, 23);\n-        } else if (job.isA(MapleJob.ARAN1)) {\n-            maxhp += Randomizer.rand(44, 48);\n-            int aids = Randomizer.rand(4, 8);\n-            maxmp += aids + Math.floor(aids * 0.1);\n-        }\n-        if (improvingMaxHPLevel > 0 && (job.isA(MapleJob.WARRIOR) || job.isA(MapleJob.PIRATE) || job.isA(MapleJob.DAWNWARRIOR1))) {\n-            maxhp += improvingMaxHP.getEffect(improvingMaxHPLevel).getX();\n-        }\n-        if (improvingMaxMPLevel > 0 && (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.CRUSADER) || job.isA(MapleJob.BLAZEWIZARD1))) {\n-            maxmp += improvingMaxMP.getEffect(improvingMaxMPLevel).getX();\n-        }\n-        \n-        if (ServerConstants.USE_RANDOMIZE_HPMP_GAIN) {\n-            if (job.isA(MapleJob.MAGICIAN) || job.isA(MapleJob.BLAZEWIZARD1)) {\n-                maxmp += localint_ / 20;\n-            } else {\n-                maxmp += localint_ / 10;\n+\n+            if (takeexp) {\n+                exp.addAndGet(-ExpTable.getExpNeededForLevel(level));\n+                if (exp.get() < 0) {\n+                    exp.set(0);\n+                }\n             }\n-        }\n-        \n-        if (takeexp) {\n-            exp.addAndGet(-ExpTable.getExpNeededForLevel(level));\n-            if (exp.get() < 0) {\n+            level++;\n+            if (level >= getMaxClassLevel()) {\n                 exp.set(0);\n+                level = getMaxClassLevel(); //To prevent levels past the maximum\n             }\n-        }\n-        level++;\n-        if (level >= getMaxClassLevel()) {\n-            exp.set(0);\n-            level = getMaxClassLevel(); //To prevent levels past the maximum\n-        }\n-        \n-        maxhp = Math.min(30000, maxhp);\n-        maxmp = Math.min(30000, maxmp);\n-        if (level == 200) {\n-            exp.set(0);\n-            if(ServerConstants.PLAYERNPC_AUTODEPLOY && !this.isGM()) MaplePlayerNPC.spawnPlayerNPC(GameConstants.getHallOfFameMapid(job), this);\n-        }\n-        recalcLocalStats();\n-        hp = localmaxhp;\n-        mp = localmaxmp;\n-        List<Pair<MapleStat, Integer>> statup = new ArrayList<>(10);\n-        statup.add(new Pair<>(MapleStat.AVAILABLEAP, remainingAp));\n-        statup.add(new Pair<>(MapleStat.HP, localmaxhp));\n-        statup.add(new Pair<>(MapleStat.MP, localmaxmp));\n-        statup.add(new Pair<>(MapleStat.EXP, exp.get()));\n-        statup.add(new Pair<>(MapleStat.LEVEL, level));\n-        statup.add(new Pair<>(MapleStat.MAXHP, maxhp));\n-        statup.add(new Pair<>(MapleStat.MAXMP, maxmp));\n-        statup.add(new Pair<>(MapleStat.STR, Math.min(str, Short.MAX_VALUE)));\n-        statup.add(new Pair<>(MapleStat.DEX, Math.min(dex, Short.MAX_VALUE)));\n-        if (job.getId() % 1000 > 0) {\n-        \tremainingSp[GameConstants.getSkillBook(job.getId())] += 3;\n-        \tstatup.add(new Pair<>(MapleStat.AVAILABLESP, remainingSp[GameConstants.getSkillBook(job.getId())]));\n-        }\n-        client.announce(MaplePacketCreator.updatePlayerStats(statup, this));\n-        getMap().broadcastMessage(this, MaplePacketCreator.showForeignEffect(getId(), 0), false);\n-        recalcLocalStats();\n-        setMPC(new MaplePartyCharacter(this));\n-        silentPartyUpdate();\n-        \n-        if(level == 10 && party != null) {\n-            if(this.isPartyLeader()) party.assignNewLeader(client);\n-            PartyOperationHandler.leaveParty(party, mpc, client);\n-            \n-            showHint(\"You have reached #blevel 10#k, therefore you must leave your #rstarter party#k.\");\n-        }\n-        \n-        if (this.guildid > 0) {\n-            getGuild().broadcast(MaplePacketCreator.levelUpMessage(2, level, name), this.getId());\n-        }\n-        if (ServerConstants.USE_PERFECT_PITCH && level >= 30) {\n-            //milestones?\n-            if (MapleInventoryManipulator.checkSpace(client, 4310000, (short) 1, \"\")) {\n-                MapleInventoryManipulator.addById(client, 4310000, (short) 1);\n+\n+            maxhp = Math.min(30000, maxhp);\n+            maxmp = Math.min(30000, maxmp);\n+            if (level == 200) {\n+                exp.set(0);\n+                if(ServerConstants.PLAYERNPC_AUTODEPLOY && !this.isGM()) MaplePlayerNPC.spawnPlayerNPC(GameConstants.getHallOfFameMapid(job), this);\n             }\n-        }\n-        if (level == 200 && !isGM()) {\n-            final String names = (getMedalText() + name);\n-            client.getWorldServer().broadcastPacket(MaplePacketCreator.serverNotice(6, String.format(LEVEL_200, names, names)));\n-        }\n-        \n-        if(level % 20 == 0 && ServerConstants.USE_ADD_SLOTS_BY_LEVEL == true) {\n-            if (!isGM()) {\n-                for (byte i = 1; i < 5; i++) {\n-                    gainSlots(i, 4, true);\n+            recalcLocalStats();\n+            hp = localmaxhp;\n+            mp = localmaxmp;\n+            List<Pair<MapleStat, Integer>> statup = new ArrayList<>(10);\n+            statup.add(new Pair<>(MapleStat.AVAILABLEAP, remainingAp));\n+            statup.add(new Pair<>(MapleStat.HP, localmaxhp));\n+            statup.add(new Pair<>(MapleStat.MP, localmaxmp));\n+            statup.add(new Pair<>(MapleStat.EXP, exp.get()));\n+            statup.add(new Pair<>(MapleStat.LEVEL, level));\n+            statup.add(new Pair<>(MapleStat.MAXHP, maxhp));\n+            statup.add(new Pair<>(MapleStat.MAXMP, maxmp));\n+            statup.add(new Pair<>(MapleStat.STR, Math.min(str, Short.MAX_VALUE)));\n+            statup.add(new Pair<>(MapleStat.DEX, Math.min(dex, Short.MAX_VALUE)));\n+            if (job.getId() % 1000 > 0) {\n+                    remainingSp[GameConstants.getSkillBook(job.getId())] += 3;\n+                    statup.add(new Pair<>(MapleStat.AVAILABLESP, remainingSp[GameConstants.getSkillBook(job.getId())]));\n+            }\n+            client.announce(MaplePacketCreator.updatePlayerStats(statup, this));\n+            getMap().broadcastMessage(this, MaplePacketCreator.showForeignEffect(getId(), 0), false);\n+            recalcLocalStats();\n+            setMPC(new MaplePartyCharacter(this));\n+            silentPartyUpdate();\n+\n+            if(level == 10 && party != null) {\n+                if(this.isPartyLeader()) party.assignNewLeader(client);\n+                PartyOperationHandler.leaveParty(party, mpc, client);\n+\n+                showHint(\"You have reached #blevel 10#k, therefore you must leave your #rstarter party#k.\");\n+            }\n+\n+            if (this.guildid > 0) {\n+                getGuild().broadcast(MaplePacketCreator.levelUpMessage(2, level, name), this.getId());\n+            }\n+            if (ServerConstants.USE_PERFECT_PITCH && level >= 30) {\n+                //milestones?\n+                if (MapleInventoryManipulator.checkSpace(client, 4310000, (short) 1, \"\")) {\n+                    MapleInventoryManipulator.addById(client, 4310000, (short) 1);\n                 }\n-                \n-                this.yellowMessage(\"You reached level \" + level + \". Congratulations! As a token of your success, your inventory has been expanded a little bit.\");\n-            }            \n-        }\n-        if (level % 20 == 0 && ServerConstants.USE_ADD_RATES_BY_LEVEL == true) { //For the rate upgrade\n-            revertLastPlayerRates();\n-            setPlayerRates();\n-            this.yellowMessage(\"You managed to get level \" + level + \"! Getting experience and items seems a little easier now, huh?\");\n+            }\n+            if (level == 200 && !isGM()) {\n+                final String names = (getMedalText() + name);\n+                client.getWorldServer().broadcastPacket(MaplePacketCreator.serverNotice(6, String.format(LEVEL_200, names, names)));\n+            }\n+\n+            if(level % 20 == 0 && ServerConstants.USE_ADD_SLOTS_BY_LEVEL == true) {\n+                if (!isGM()) {\n+                    for (byte i = 1; i < 5; i++) {\n+                        gainSlots(i, 4, true);\n+                    }\n+\n+                    this.yellowMessage(\"You reached level \" + level + \". Congratulations! As a token of your success, your inventory has been expanded a little bit.\");\n+                }            \n+            }\n+            if (level % 20 == 0 && ServerConstants.USE_ADD_RATES_BY_LEVEL == true) { //For the rate upgrade\n+                revertLastPlayerRates();\n+                setPlayerRates();\n+                this.yellowMessage(\"You managed to get level \" + level + \"! Getting experience and items seems a little easier now, huh?\");\n+            }\n+\n+            levelUpMessages();\n+            guildUpdate();\n+        } finally {\n+            petLock.unlock();\n         }\n-        \n-        levelUpMessages();\n-        guildUpdate();\n     }\n \n     public void gainAp(int amount) {\n@@ -6939,57 +6973,63 @@ public void removeVisibleMapObject(MapleMapObject mo) {\n         visibleMapObjects.remove(mo);\n     }\n \n-    public void resetStats() {\n+    public synchronized void resetStats() {\n         if(!ServerConstants.USE_AUTOASSIGN_STARTERS_AP) {\n             return;\n         }\n         \n         List<Pair<MapleStat, Integer>> statup = new ArrayList<>(5);\n-        int tap = 0, tsp = 1;\n+        int tap = remainingAp + str + dex + int_ + luk, tsp = 1;\n         int tstr = 4, tdex = 4, tint = 4, tluk = 4;\n-        int levelap = (isCygnus() ? 6 : 5);\n+        \n         switch (job.getId()) {\n             case 100:\n             case 1100:\n             case 2100:\n                 tstr = 35;\n-                tap = ((getLevel() - 10) * levelap) + 14;\n                 tsp += ((getLevel() - 10) * 3);\n                 break;\n             case 200:\n             case 1200:\n                 tint = 20;\n-                tap = ((getLevel() - 8) * levelap) + 29;\n                 tsp += ((getLevel() - 8) * 3);\n                 break;\n             case 300:\n             case 1300:\n             case 400:\n             case 1400:\n                 tdex = 25;\n-                tap = ((getLevel() - 10) * levelap) + 24;\n                 tsp += ((getLevel() - 10) * 3);\n                 break;\n             case 500:\n             case 1500:\n                 tdex = 20;\n-                tap = ((getLevel() - 10) * levelap) + 29;\n                 tsp += ((getLevel() - 10) * 3);\n                 break;\n         }\n-        this.remainingAp = tap;\n-        this.remainingSp[GameConstants.getSkillBook(job.getId())] = tsp;\n-        this.dex = tdex;\n-        this.int_ = tint;\n-        this.str = tstr;\n-        this.luk = tluk;\n-        statup.add(new Pair<>(MapleStat.AVAILABLEAP, tap));\n-        statup.add(new Pair<>(MapleStat.AVAILABLESP, tsp));\n-        statup.add(new Pair<>(MapleStat.STR, tstr));\n-        statup.add(new Pair<>(MapleStat.DEX, tdex));\n-        statup.add(new Pair<>(MapleStat.INT, tint));\n-        statup.add(new Pair<>(MapleStat.LUK, tluk));\n-        announce(MaplePacketCreator.updatePlayerStats(statup, this));\n+        \n+        tap -= tstr;\n+        tap -= tdex;\n+        tap -= tint;\n+        tap -= tluk;\n+        \n+        if (tap >= 0) {\n+            this.remainingAp = tap;\n+            this.remainingSp[GameConstants.getSkillBook(job.getId())] = tsp;\n+            this.str = tstr;\n+            this.dex = tdex;\n+            this.int_ = tint;\n+            this.luk = tluk;\n+            statup.add(new Pair<>(MapleStat.AVAILABLEAP, tap));\n+            statup.add(new Pair<>(MapleStat.AVAILABLESP, tsp));\n+            statup.add(new Pair<>(MapleStat.STR, tstr));\n+            statup.add(new Pair<>(MapleStat.DEX, tdex));\n+            statup.add(new Pair<>(MapleStat.INT, tint));\n+            statup.add(new Pair<>(MapleStat.LUK, tluk));\n+            announce(MaplePacketCreator.updatePlayerStats(statup, this));\n+        } else {\n+            FilePrinter.print(FilePrinter.EXCEPTION_CAUGHT, name + \" tried to get their stats reseted, without having enough AP available.\");\n+        }\n     }\n     \n     public void resetBattleshipHp() {\n@@ -8474,18 +8514,20 @@ public void updateQuestInfo(int quest, String info) {\n         }\n         announce(MaplePacketCreator.updateQuestInfo((short) qs.getQuest().getId(), qs.getNpc()));\n     }\n-\n-    private void fameGainByQuest() {\n+    \n+    public void awardQuestPoint(int awardedPoints) {\n+        if (ServerConstants.QUEST_POINT_REQUIREMENT < 1 || awardedPoints < 1) return;\n+        \n+        int delta;\n         synchronized (quests) {\n-            quest_fame += 1;\n+            quest_fame += awardedPoints;\n             \n-            int delta = quest_fame / ServerConstants.FAME_GAIN_BY_QUEST;\n-            if(delta > 0) {\n-                gainFame(delta);\n-                client.announce(MaplePacketCreator.getShowFameGain(delta));\n-            }\n-\n-            quest_fame %= ServerConstants.FAME_GAIN_BY_QUEST;\n+            delta = quest_fame / ServerConstants.QUEST_POINT_REQUIREMENT;\n+            quest_fame %= ServerConstants.QUEST_POINT_REQUIREMENT;\n+        }\n+        \n+        if(delta > 0) {\n+            gainFame(delta);\n         }\n     }\n     \n@@ -8503,8 +8545,7 @@ public void updateQuest(MapleQuestStatus quest) {\n             MapleQuest mquest = quest.getQuest();\n             short questid = mquest.getId();\n             if(!mquest.isSameDayRepeatable() && !MapleQuest.isExploitableQuest(questid)) {\n-                if(ServerConstants.FAME_GAIN_BY_QUEST > 0)\n-                    fameGainByQuest();\n+                awardQuestPoint(ServerConstants.QUEST_POINT_PER_QUEST_COMPLETE);\n             }\n             \n             announce(MaplePacketCreator.completeQuest(questid, quest.getCompletionTime()));\n@@ -8572,7 +8613,7 @@ public void run() {\n     private void runQuestExpireTask() {\n         petLock.lock();\n         try {\n-            long timeNow = System.currentTimeMillis();\n+            long timeNow = Server.getInstance().getCurrentTime();\n             List<MapleQuest> expireList = new LinkedList<>();\n             \n             for(Entry<MapleQuest, Long> qe : questExpirations.entrySet()) {\n@@ -8607,7 +8648,7 @@ public void run() {\n                 }, 10 * 1000);\n             }\n             \n-            questExpirations.put(quest, System.currentTimeMillis() + time);\n+            questExpirations.put(quest, Server.getInstance().getCurrentTime() + time);\n         } finally {\n             petLock.unlock();\n         }\n@@ -8880,6 +8921,7 @@ public boolean isVipTrockMap(int id) {\n \n         return false;\n     }\n+    \n     //EVENTS\n     private byte team = 0;\n     private MapleFitness fitness;\n@@ -8917,6 +8959,7 @@ public long getLastSnowballAttack() {\n     public void setLastSnowballAttack(long time) {\n         this.snowballattack = time;\n     }\n+    \n     //Monster Carnival\n     private int cp = 0;\n     private int obtainedcp = 0;\n@@ -9059,7 +9102,7 @@ public void increaseEquipExp(int expGain) {\n                 continue;\n             }\n \n-            if ((nEquip.getItemLevel() < ServerConstants.USE_EQUIPMNT_LVLUP) || (itemName.contains(\"Reverse\") && nEquip.getItemLevel() < 4) || (itemName.contains(\"Timeless\") && nEquip.getItemLevel() < 6)) {\n+            if ((nEquip.getItemLevel() < ServerConstants.USE_EQUIPMNT_LVLUP) || (nEquip.getItemLevel() < ii.getEquipLevel(nEquip.getItemId(), true))) {\n                 nEquip.gainItemExp(client, expGain);\n             }\n         }"}, {"sha": "7e762135d90d00d226278de934e2708eaf580c7b", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 44, "deletions": 54, "changes": 98, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -85,6 +85,8 @@\n \tpublic static final int LOGIN_SERVER_TRANSITION = 1;\n \tpublic static final int LOGIN_LOGGEDIN = 2;\n \tpublic static final String CLIENT_KEY = \"CLIENT\";\n+        public static final String CLIENT_HWID = \"HWID\";\n+        public static final String CLIENT_NIBBLEHWID = \"HWID2\";\n \tprivate MapleAESOFB send;\n \tprivate MapleAESOFB receive;\n \tprivate final IoSession session;\n@@ -507,7 +509,7 @@ public boolean checkPic(String other) {\n \t\treturn false;\n \t}\n \n-\tpublic int login(String login, String pwd) {\n+\tpublic int login(String login, String pwd, String nibbleHwid) {\n \t\tloginattempt++;\n \t\tif (loginattempt > 4) {\n \t\t\tMapleSessionCoordinator.getInstance().closeSession(session, false);\n@@ -571,7 +573,7 @@ public int login(String login, String pwd) {\n \t\t}\n                 \n \t\tif (loginok == 0 || loginok == 4) {\n-                        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptSessionLogin(session, accId, loginok == 4);\n+                        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptLoginSession(session, nibbleHwid, accId, loginok == 4);\n                         \n                         switch (res) {\n                                 case SUCCESS:\n@@ -887,71 +889,59 @@ public final synchronized void disconnect(boolean shutdown, boolean cashshop) {/\n \n                         final World wserv = getWorldServer();   // obviously wserv is NOT null if this player was online on it\n                         try {\n-                                if (channel == -1 || shutdown) {\n-                                        if(chrg != null) chrg.setCharacter(null);\n-\n-                                        wserv.removePlayer(player);\n-                                        removePlayer(wserv);\n-\n-                                        player.saveCooldowns();\n-                                        player.cancelAllDebuffs();\n-                                        player.saveCharToDB(true);\n-\n-                                        clear();\n-                                        return;\n-                                }\n-\n                                 removePlayer(wserv);\n-\t\t\t\n-\t\t\t\tif (!cashshop) {\n-\t\t\t\t\tif (!this.serverTransition) { // meaning not changing channels\n-\t\t\t\t\t\tif (messengerid > 0) {\n-\t\t\t\t\t\t\twserv.leaveMessenger(messengerid, chrm);\n-\t\t\t\t\t\t}\n-                                                /*      \n-\t\t\t\t\t\tif (fid > 0) {\n-                                                        final MapleFamily family = worlda.getFamily(fid);\n-                                                        family.\n+                                \n+                                if (!(channel == -1 || shutdown)) {\n+                                        if (!cashshop) {\n+                                                if (!this.serverTransition) { // meaning not changing channels\n+                                                        if (messengerid > 0) {\n+                                                                wserv.leaveMessenger(messengerid, chrm);\n+                                                        }\n+                                                        /*      \n+                                                        if (fid > 0) {\n+                                                                final MapleFamily family = worlda.getFamily(fid);\n+                                                                family.\n+                                                        }\n+                                                        */\n+                                                        for (MapleQuestStatus status : player.getStartedQuests()) { //This is for those quests that you have to stay logged in for a certain amount of time\n+                                                                MapleQuest quest = status.getQuest();\n+                                                                if (quest.getTimeLimit() > 0) {\n+                                                                        MapleQuestStatus newStatus = new MapleQuestStatus(quest, MapleQuestStatus.Status.NOT_STARTED);\n+                                                                        newStatus.setForfeited(player.getQuest(quest).getForfeited() + 1);\n+                                                                        player.updateQuest(newStatus);\n+                                                                }\n+                                                        }\t                   \n+                                                        if (guild != null) {\n+                                                                final Server server = Server.getInstance();\n+                                                                server.setGuildMemberOnline(player, false, player.getClient().getChannel());\n+                                                                player.getClient().announce(MaplePacketCreator.showGuildInfo(player));\n+                                                        }\n+                                                        if (bl != null) {\n+                                                                wserv.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n+                                                        }\n                                                 }\n-                                                */\n-\t\t\t\t\t\tfor (MapleQuestStatus status : player.getStartedQuests()) { //This is for those quests that you have to stay logged in for a certain amount of time\n-\t\t\t\t\t\t\tMapleQuest quest = status.getQuest();\n-\t\t\t\t\t\t\tif (quest.getTimeLimit() > 0) {\n-\t\t\t\t\t\t\t\tMapleQuestStatus newStatus = new MapleQuestStatus(quest, MapleQuestStatus.Status.NOT_STARTED);\n-\t\t\t\t\t\t\t\tnewStatus.setForfeited(player.getQuest(quest).getForfeited() + 1);\n-\t\t\t\t\t\t\t\tplayer.updateQuest(newStatus);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\t                   \n-                                                if (guild != null) {\n-\t\t\t\t\t\t\tfinal Server server = Server.getInstance();\n-\t\t\t\t\t\t\tserver.setGuildMemberOnline(player, false, player.getClient().getChannel());\n-\t\t\t\t\t\t\tplayer.getClient().announce(MaplePacketCreator.showGuildInfo(player));\n-\t\t\t\t\t\t}\n-                                                if (bl != null) {\n-\t\t\t\t\t\t\twserv.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (!this.serverTransition) { // if dc inside of cash shop.\t                \n-\t\t\t\t\t\tif (bl != null) {\n-\t\t\t\t\t\t\twserv.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n+                                        } else {\n+                                                if (!this.serverTransition) { // if dc inside of cash shop.\t                \n+                                                        if (bl != null) {\n+                                                                wserv.loggedOff(player.getName(), player.getId(), channel, player.getBuddylist().getBuddyIds());\n+                                                        }\n+                                                }\n+                                        }\n+                                }\n \t\t\t} catch (final Exception e) {\n \t\t\t\tFilePrinter.printError(FilePrinter.ACCOUNT_STUCK, e);\n \t\t\t} finally {\n                                 if (!this.serverTransition) {\n+                                        if(chrg != null) chrg.setCharacter(null);\n \t\t\t\t\twserv.removePlayer(player);\n                                         //getChannelServer().removePlayer(player); already being done\n                                         \n                                         player.saveCooldowns();\n                                         player.cancelAllDebuffs();\n                                         player.saveCharToDB(true);\n-\t\t\t\t\tif (player != null) {//no idea, occur :(\n-\t\t\t\t\t\tplayer.empty(false);\n-\t\t\t\t\t}\n+                                        \n \t\t\t\t\tplayer.logOff();\n+                                        clear();\n \t\t\t\t} else {\n                                         getChannelServer().removePlayer(player);\n "}, {"sha": "3db0b3c38ce1c802a2c59f3a5fe9135fb161322d", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -301,7 +301,7 @@ private void registerLv4Commands(){\n         \n         addCommand(\"servermessage\", 4, ServerMessageCommand.class);\n         addCommand(\"proitem\", 4, ProItemCommand.class);\n-        addCommand(\"seteqstat\", 4, SetQStatCommand.class);\n+        addCommand(\"seteqstat\", 4, SetEqStatCommand.class);\n         addCommand(\"exprate\", 4, ExpRateCommand.class);\n         addCommand(\"mesorate\", 4, MesoRateCommand.class);\n         addCommand(\"droprate\", 4, DropRateCommand.class);"}, {"sha": "8deb4c3ba85b83999609bc6b359adda22825c4b4", "filename": "src/client/command/commands/v1/GotoCommand.java", "status": "modified", "additions": 2, "deletions": 50, "changes": 52, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v1/GotoCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v1/GotoCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/v1/GotoCommand.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -26,6 +26,7 @@\n import client.MapleCharacter;\n import client.command.Command;\n import client.MapleClient;\n+import constants.GameConstants;\n import server.MaplePortal;\n import server.maps.MapleMap;\n \n@@ -38,56 +39,7 @@\n \n     @Override\n     public void execute(MapleClient c, String[] params) {\n-        final HashMap<String, Integer> gotomaps = new HashMap<String, Integer>();\n-        gotomaps.put(\"gmmap\", 180000000);\n-        gotomaps.put(\"southperry\", 60000);\n-        gotomaps.put(\"amherst\", 1000000);\n-        gotomaps.put(\"henesys\", 100000000);\n-        gotomaps.put(\"ellinia\", 101000000);\n-        gotomaps.put(\"perion\", 102000000);\n-        gotomaps.put(\"kerning\", 103000000);\n-        gotomaps.put(\"lith\", 104000000);\n-        gotomaps.put(\"sleepywood\", 105040300);\n-        gotomaps.put(\"florina\", 110000000);\n-        gotomaps.put(\"nautilus\", 120000000);\n-        gotomaps.put(\"ereve\", 130000000);\n-        gotomaps.put(\"rien\", 140000000);\n-        gotomaps.put(\"orbis\", 200000000);\n-        gotomaps.put(\"happy\", 209000000);\n-        gotomaps.put(\"elnath\", 211000000);\n-        gotomaps.put(\"ludi\", 220000000);\n-        gotomaps.put(\"aqua\", 230000000);\n-        gotomaps.put(\"leafre\", 240000000);\n-        gotomaps.put(\"mulung\", 250000000);\n-        gotomaps.put(\"herb\", 251000000);\n-        gotomaps.put(\"omega\", 221000000);\n-        gotomaps.put(\"korean\", 222000000);\n-        gotomaps.put(\"ellin\", 300000000);\n-        gotomaps.put(\"nlc\", 600000000);\n-        gotomaps.put(\"excavation\", 990000000);\n-        gotomaps.put(\"pianus\", 230040420);\n-        gotomaps.put(\"horntail\", 240060200);\n-        gotomaps.put(\"mushmom\", 100000005);\n-        gotomaps.put(\"griffey\", 240020101);\n-        gotomaps.put(\"manon\", 240020401);\n-        gotomaps.put(\"horseman\", 682000001);\n-        gotomaps.put(\"balrog\", 105090900);\n-        gotomaps.put(\"zakum\", 211042300);\n-        gotomaps.put(\"papu\", 220080001);\n-        gotomaps.put(\"showa\", 801000000);\n-        gotomaps.put(\"guild\", 200000301);\n-        gotomaps.put(\"shrine\", 800000000);\n-        gotomaps.put(\"skelegon\", 240040511);\n-        gotomaps.put(\"hpq\", 100000200);\n-        gotomaps.put(\"ht\", 240050400);\n-        gotomaps.put(\"ariant\", 260000000);\n-        gotomaps.put(\"magatia\", 261000000);\n-        gotomaps.put(\"singapore\", 540000000);\n-        gotomaps.put(\"keep\", 610020006);\n-        gotomaps.put(\"amoria\", 680000000);\n-        gotomaps.put(\"temple\", 270000100);\n-        gotomaps.put(\"neo\", 240070000);\n-        gotomaps.put(\"fm\", 910000000);\n+        final HashMap<String, Integer> gotomaps = GameConstants.GOTO_MAPS;\n \n         MapleCharacter player = c.getPlayer();\n         if (params.length < 1){"}, {"sha": "c65b9a253a0c7d883b9ac3734d6ecdb240c1036e", "filename": "src/client/command/commands/v4/ProItemCommand.java", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v4/ProItemCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v4/ProItemCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/v4/ProItemCommand.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -42,25 +42,26 @@\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n         if (params.length < 2) {\n-            player.yellowMessage(\"Syntax: !proitem <itemid> <statvalue>\");\n+            player.yellowMessage(\"Syntax: !proitem <itemid> <stat value> [<spdjmp value>]\");\n             return;\n         }\n         int itemid = Integer.parseInt(params[0]);\n-        short multiply = Short.parseShort(params[1]);\n+        short stat = (short) Math.max(0, Short.parseShort(params[1]));\n+        short spdjmp = params.length >= 3 ? (short) Math.max(0, Short.parseShort(params[2])) : 0;\n \n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n         if (type.equals(MapleInventoryType.EQUIP)) {\n             Item it = ii.getEquipById(itemid);\n             it.setOwner(player.getName());\n \n-            hardsetItemStats((Equip) it, multiply);\n+            hardsetItemStats((Equip) it, stat, spdjmp);\n             MapleInventoryManipulator.addFromDrop(c, it);\n         } else {\n             player.dropMessage(6, \"Make sure it's an equippable item.\");\n         }\n     }\n-    private static void hardsetItemStats(Equip equip, short stat) {\n+    private static void hardsetItemStats(Equip equip, short stat, short spdjmp) {\n         equip.setStr(stat);\n         equip.setDex(stat);\n         equip.setInt(stat);\n@@ -69,8 +70,8 @@ private static void hardsetItemStats(Equip equip, short stat) {\n         equip.setWatk(stat);\n         equip.setAcc(stat);\n         equip.setAvoid(stat);\n-        equip.setJump(stat);\n-        equip.setSpeed(stat);\n+        equip.setJump(spdjmp);\n+        equip.setSpeed(spdjmp);\n         equip.setWdef(stat);\n         equip.setMdef(stat);\n         equip.setHp(stat);"}, {"sha": "f616f8601f10bd8be1aa678b4e2568aa5c8ed1e7", "filename": "src/client/command/commands/v4/SetEqStatCommand.java", "status": "renamed", "additions": 19, "deletions": 19, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v4/SetEqStatCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/command/commands/v4/SetEqStatCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/v4/SetEqStatCommand.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -31,7 +31,7 @@\n import client.inventory.MapleInventoryType;\n import constants.ItemConstants;\n \n-public class SetQStatCommand extends Command {\n+public class SetEqStatCommand extends Command {\n     {\n         setDescription(\"\");\n     }\n@@ -40,33 +40,33 @@\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n         if (params.length < 1) {\n-            player.yellowMessage(\"Syntax: !seteqstat <statvalue>\");\n+            player.yellowMessage(\"Syntax: !seteqstat <stat value> [<spdjmp value>]\");\n             return;\n         }\n \n-        int newStat = Integer.parseInt(params[0]);\n+        short newStat = (short) Math.max(0, Integer.parseInt(params[0]));\n+        short newSpdJmp = params.length >= 2 ? (short) Integer.parseInt(params[1]) : 0;\n         MapleInventory equip = player.getInventory(MapleInventoryType.EQUIP);\n-\n+        \n         for (byte i = 1; i <= equip.getSlotLimit(); i++) {\n             try {\n                 Equip eu = (Equip) equip.getItem(i);\n                 if (eu == null) continue;\n \n-                short incval = (short) newStat;\n-                eu.setWdef(incval);\n-                eu.setAcc(incval);\n-                eu.setAvoid(incval);\n-                eu.setJump(incval);\n-                eu.setMatk(incval);\n-                eu.setMdef(incval);\n-                eu.setHp(incval);\n-                eu.setMp(incval);\n-                eu.setSpeed(incval);\n-                eu.setWatk(incval);\n-                eu.setDex(incval);\n-                eu.setInt(incval);\n-                eu.setStr(incval);\n-                eu.setLuk(incval);\n+                eu.setWdef(newStat);\n+                eu.setAcc(newStat);\n+                eu.setAvoid(newStat);\n+                eu.setJump(newSpdJmp);\n+                eu.setMatk(newStat);\n+                eu.setMdef(newStat);\n+                eu.setHp(newStat);\n+                eu.setMp(newStat);\n+                eu.setSpeed(newSpdJmp);\n+                eu.setWatk(newStat);\n+                eu.setDex(newStat);\n+                eu.setInt(newStat);\n+                eu.setStr(newStat);\n+                eu.setLuk(newStat);\n \n                 byte flag = eu.getFlag();\n                 flag |= ItemConstants.UNTRADEABLE;", "previous_filename": "src/client/command/commands/v4/SetQStatCommand.java"}, {"sha": "26fd6e7dd2b222647f40fee1e7928bf7477ae228", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -66,7 +66,7 @@ private StatUpgrade(int value) {\n     private float itemExp;\n     private int ringid = -1;\n     private boolean wear = false;\n-    private boolean isUpgradeable, isElemental = false;    // timeless or reverse\n+    private boolean isUpgradeable, isElemental = false;    // timeless or reverse, or any equip that could levelup on GMS for all effects\n \n     public Equip(int id, short position) {\n         this(id, position, 0);\n@@ -78,8 +78,7 @@ public Equip(int id, short position, int slots) {\n         this.itemExp = 0;\n         this.itemLevel = 1;\n         \n-        String itemName = MapleItemInformationProvider.getInstance().getName(id);\n-        if(itemName != null) this.isElemental = (itemName.contains(\"Timeless\") || itemName.contains(\"Reverse\"));\n+        this.isElemental = (MapleItemInformationProvider.getInstance().getEquipLevel(id, false) > 1);\n     }\n \n     @Override\n@@ -533,25 +532,22 @@ public void gainItemExp(MapleClient c, int gain) {  // Ronan's Equip Exp gain me\n         }\n     }\n     \n-    private boolean reachedMaxLevel(String eqpName) {\n-        if(isElemental) {\n-            if(eqpName.contains(\"Timeless\")) {\n-                if(itemLevel < 6) return false;\n-            } else {\n-                if(itemLevel < 4) return false;\n+    private boolean reachedMaxLevel() {\n+        if (isElemental) {\n+            if (itemLevel < MapleItemInformationProvider.getInstance().getEquipLevel(getItemId(), true)) {\n+                return false;\n             }\n         }\n         \n-        if(itemLevel < ServerConstants.USE_EQUIPMNT_LVLUP) return false;\n-        return true;\n+        return itemLevel >= ServerConstants.USE_EQUIPMNT_LVLUP;\n     }\n     \n     public String showEquipFeatures(MapleClient c) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         if(!ii.isUpgradeable(this.getItemId())) return \"\";\n         \n         String eqpName = ii.getName(getItemId());\n-        String eqpInfo = reachedMaxLevel(eqpName) ? \" #e#rMAX LEVEL#k#n\" : (\" EXP: #e#b\" + (int)itemExp + \"#k#n / \" + ExpTable.getEquipExpNeededForLevel(itemLevel));\n+        String eqpInfo = reachedMaxLevel() ? \" #e#rMAX LEVEL#k#n\" : (\" EXP: #e#b\" + (int)itemExp + \"#k#n / \" + ExpTable.getEquipExpNeededForLevel(itemLevel));\n         \n         return \"'\" + eqpName + \"' -> LV: #e#b\" + itemLevel + \"#k#n    \" + eqpInfo + \"\\r\\n\";\n     }"}, {"sha": "ad0ca26ca7069377b6e52c4f5f934e01b0dc3c38", "filename": "src/client/inventory/Item.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/inventory/Item.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/client/inventory/Item.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Item.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -25,10 +25,12 @@\n import java.util.Collections;\n import java.util.LinkedList;\n import java.util.List;\n-import java.util.Random;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n public class Item implements Comparable<Item> {\n \n+    private static AtomicInteger runningCashId = new AtomicInteger(0);\n+    \n     private int id, cashId, sn;\n     private short position;\n     private short quantity;\n@@ -81,7 +83,7 @@ public int getItemId() {\n \n     public int getCashId() {\n         if (cashId == 0) {\n-            cashId = new Random().nextInt(Integer.MAX_VALUE) + 1;\n+            cashId = runningCashId.incrementAndGet();\n         }\n         return cashId;\n     }"}, {"sha": "3bbb5d8b74f6a92dffe599011064966d77baf178", "filename": "src/constants/GameConstants.java", "status": "modified", "additions": 58, "deletions": 1, "changes": 59, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/constants/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/constants/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/GameConstants.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -17,7 +17,8 @@\n  */\n public class GameConstants {\n     public static String[] WORLD_NAMES = {\"Scania\", \"Bera\", \"Broa\", \"Windia\", \"Khaini\", \"Bellocan\", \"Mardia\", \"Kradia\", \"Yellonde\", \"Demethos\", \"Galicia\", \"El Nido\", \"Zenith\", \"Arcenia\", \"Kastia\", \"Judis\", \"Plana\", \"Kalluna\", \"Stius\", \"Croa\", \"Medere\"};\n-    public static final int[] OWL_DATA = new int[]{1082002, 2070005, 2070006, 1022047, 1102041, 2044705, 2340000, 2040017, 1092030, 2040804};\n+    public static final int[]  OWL_DATA = new int[]{1082002, 2070005, 2070006, 1022047, 1102041, 2044705, 2340000, 2040017, 1092030, 2040804};\n+    public static final int[] CASH_DATA = new int[]{50200004, 50200069, 50200117, 50100008, 50000047};\n     \n     // Ronan's rates upgrade system\n     private static final int[] DROP_RATE_GAIN = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14};\n@@ -40,6 +41,62 @@ public static int getPlayerBonusExpRate(int slot) {\n         return(EXP_RATE_GAIN[slot]);\n     }\n     \n+    // used by the \"goto\" command\n+    public static final HashMap<String, Integer> GOTO_MAPS = new HashMap<String, Integer>() {{\n+        put(\"gmmap\", 180000000);\n+        put(\"southperry\", 60000);\n+        put(\"amherst\", 1000000);\n+        put(\"henesys\", 100000000);\n+        put(\"ellinia\", 101000000);\n+        put(\"perion\", 102000000);\n+        put(\"kerning\", 103000000);\n+        put(\"lith\", 104000000);\n+        put(\"sleepywood\", 105040300);\n+        put(\"florina\", 110000000);\n+        put(\"nautilus\", 120000000);\n+        put(\"ereve\", 130000000);\n+        put(\"rien\", 140000000);\n+        put(\"orbis\", 200000000);\n+        put(\"happy\", 209000000);\n+        put(\"elnath\", 211000000);\n+        put(\"ludi\", 220000000);\n+        put(\"aqua\", 230000000);\n+        put(\"leafre\", 240000000);\n+        put(\"mulung\", 250000000);\n+        put(\"herb\", 251000000);\n+        put(\"omega\", 221000000);\n+        put(\"korean\", 222000000);\n+        put(\"ellin\", 300000000);\n+        put(\"nlc\", 600000000);\n+        put(\"excavation\", 990000000);\n+        put(\"pianus\", 230040420);\n+        put(\"horntail\", 240060200);\n+        put(\"mushmom\", 100000005);\n+        put(\"griffey\", 240020101);\n+        put(\"manon\", 240020401);\n+        put(\"horseman\", 682000001);\n+        put(\"balrog\", 105090900);\n+        put(\"zakum\", 211042300);\n+        put(\"papu\", 220080001);\n+        put(\"showa\", 801000000);\n+        put(\"guild\", 200000301);\n+        put(\"shrine\", 800000000);\n+        put(\"skelegon\", 240040511);\n+        put(\"hpq\", 100000200);\n+        put(\"ht\", 240050400);\n+        put(\"ariant\", 260000000);\n+        put(\"magatia\", 261000000);\n+        put(\"singapore\", 540000000);\n+        put(\"quay\", 541000000);\n+        put(\"kampung\", 551000000);\n+        put(\"keep\", 610020006);\n+        put(\"amoria\", 680000000);\n+        put(\"temple\", 270000100);\n+        put(\"square\", 103040000);\n+        put(\"neo\", 240070000);\n+        put(\"fm\", 910000000);\n+    }};\n+    \n     // MapleStory default keyset\n     private static final int[] DEFAULT_KEY = {18, 65, 2, 23, 3, 4, 5, 6, 16, 17, 19, 25, 26, 27, 31, 34, 35, 37, 38, 40, 43, 44, 45, 46, 50, 56, 59, 60, 61, 62, 63, 64, 57, 48, 29, 7, 24, 33, 41, 39};\n     private static final int[] DEFAULT_TYPE = {4, 6, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 4, 4, 5, 6, 6, 6, 6, 6, 6, 5, 4, 5, 4, 4, 4, 4, 4};"}, {"sha": "e3fb801041ec225199461e36ed09ed9b31c4e126", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -33,12 +33,12 @@\n     public static final boolean AUTOMATIC_REGISTER = true;      //Automatically register players when they login with a nonexistent username.\n     public static final boolean BCRYPT_MIGRATION = true;        //Performs a migration from old SHA-1 and SHA-512 password to bcrypt.\n     public static final boolean COLLECTIVE_CHARSLOT = false;    //Available character slots are contabilized globally rather than per world server.\n-    public static final boolean DETERRED_MULTICLIENT = false;    //Enables multi-client and suspicious remote IP detection on the login system.\n+    public static final boolean DETERRED_MULTICLIENT = false;   //Enables multi-client and suspicious remote IP detection on the login system.\n     \n     //Besides blocking logging in with several client sessions on the same machine, this also blocks suspicious login attempts for players that tries to login on an account using several diferent remote addresses.\n     \n     //Multiclient Coordinator Configuration\n-    public static final int MAX_ALLOWED_ACCOUNT_IP = 4;         //Allows up to N concurrent IP's for an account. IP's remains linked to an account longer the more times it's used to login.\n+    public static final int MAX_ALLOWED_ACCOUNT_HWID = 4;       //Allows up to N concurrent HWID's for an account. HWID's remains linked to an account longer the more times it's used to login.\n     public static final int MAX_ACCOUNT_LOGIN_ATTEMPT = 15;     //After N tries on an account, login on that account gets disabled for a short period.\n     public static final int LOGIN_ATTEMPT_DURATION = 120;       //Period in seconds the login attempt remains registered on the system.\n     \n@@ -77,7 +77,7 @@\n     public static final boolean USE_ENFORCE_HPMP_SWAP = false;      //Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     public static final boolean USE_ENFORCE_MOB_LEVEL_RANGE = true; //Players N levels below the killed mob will gain no experience from defeating it.\n     public static final boolean USE_ENFORCE_JOB_LEVEL_RANGE = false;//Caps the player level on the minimum required to advance their current jobs.\n-    public static final boolean USE_ENFORCE_OWL_SUGGESTIONS = false;//Forces the Owl of Minerva to always display the defined item array on GameConstants.OWL_DATA instead of those featured by the players.\n+    public static final boolean USE_ENFORCE_ITEM_SUGGESTION = false;//Forces the Owl of Minerva and the Cash Shop to always display the defined item array instead of those featured by the players.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_CASH = true;//Forces players to not sell CASH items via merchants.\n     public static final boolean USE_ENFORCE_UNMERCHABLE_PET = true; //Forces players to not sell pets via merchants. (since non-named pets gets dirty name and other possible DB-related issues)\n     public static final boolean USE_ENFORCE_MDOOR_POSITION = false; //Forces mystic door to be spawned near spawnpoints.\n@@ -87,11 +87,15 @@\n     public static final boolean USE_ERASE_UNTRADEABLE_DROP = true;  //Forces flagged untradeable items to disappear when dropped.\n     public static final boolean USE_ERASE_PET_ON_EXPIRATION = false;//Forces pets to be removed from inventory when expire time comes, rather than converting it to a doll.\n     public static final boolean USE_BUFF_MOST_SIGNIFICANT = true;   //When applying buffs, the player will stick with the highest stat boost among the listed, rather than overwriting stats.\n+    public static final boolean USE_BUFF_EVERLASTING = false;       //Every applied buff on players holds expiration time so high it'd be considered permanent. Suggestion thanks to Vcoc.\n     public static final boolean USE_MULTIPLE_SAME_EQUIP_DROP = true;//Enables multiple drops by mobs of the same equipment, number of possible drops based on the quantities provided at the drop data.\n     public static final boolean USE_BANISHABLE_TOWN_SCROLL = true;  //Enables town scrolls to act as if it's a \"player banish\", rendering the antibanish scroll effect available.\n+    public static final boolean USE_ENABLE_FULL_RESPAWN = true;     //At respawn task, always respawn missing mobs when they're available. Spawn count doesn't depend on how many players are currently there.\n+    \n+    //Events/PQs Configuration\n     public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;  //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n     public static final boolean USE_ENABLE_SOLO_EXPEDITIONS = true; //Enables start expeditions with any number of players. This will also bypass all the Zakum prequest.\n-    public static final boolean USE_ENABLE_FULL_RESPAWN = true;     //At respawn task, always respawn missing mobs when they're available. Spawn count doesn't depend on how many players are currently there.\n+    public static final boolean USE_ENABLE_RECALL_EVENT = true;     //Enables a disconnected player to reaccess the last event instance they were in before logging out. Recall only works if the event isn't cleared or disposed yet. Suggestion thanks to Alisson (Goukken).\n     \n     //Announcement Configuration\n     public static final boolean USE_ANNOUNCE_SHOPITEMSOLD = false;  //Automatic message sent to owner when an item from the Player Shop or Hired Merchant is sold.\n@@ -178,12 +182,19 @@\n     \n     //Quest Configuration\n     public static final boolean USE_QUEST_RATE = false;         //Exp/Meso gained by quests uses fixed server exp/meso rate times quest rate as multiplier, instead of player rates.\n-    public static final int FAME_GAIN_MIN_HOUR_INTERVAL = 24;   //Minimum time interval in hours the repeatable quest must have to be accounted for the \"fame gain by quest\".\n-    public static final int FAME_GAIN_BY_QUEST = 4;             //Fame gain each N quest completes, set 0 to disable.\n+    \n+    //Quest Points Configuration\n+    public static final int QUEST_POINT_REPEATABLE_INTERVAL = 24;//Minimum interval between repeatable quest completions for quest points to be awarded.\n+    public static final int QUEST_POINT_REQUIREMENT = 16;        //Exchange factor between N quest points to +1 fame, set 0 to disable the entire quest point mechanism.\n+    public static final int QUEST_POINT_PER_QUEST_COMPLETE = 4;  //Each completed quest awards N quest points, set 0 to disable.\n+    public static final int QUEST_POINT_PER_EVENT_CLEAR = 1;     //Each completed event instance awards N quest points, set 0 to disable.\n     \n     //Guild Configuration\n     public static final int CREATE_GUILD_COST = 1500000;\n     public static final int CHANGE_EMBLEM_COST = 5000000;\n+    public static final int EXPAND_GUILD_BASE_COST = 500000;\n+    public static final int EXPAND_GUILD_TIER_COST = 1000000;\n+    public static final int EXPAND_GUILD_MAX_COST = 5000000;\n \n     //Equipment Configuration\n     public static final boolean USE_EQUIPMNT_LVLUP_SLOTS = true;//Equips can upgrade slots at level up."}, {"sha": "0a57cbda56db3c34765e864c0e56bac2e8bbaf9e", "filename": "src/net/server/Server.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -59,6 +59,7 @@\n import net.server.guild.MapleGuildCharacter;\n import net.server.worker.CharacterDiseaseWorker;\n import net.server.worker.CouponWorker;\n+import net.server.worker.EventRecallCoordinatorWorker;\n import net.server.worker.LoginCoordinatorWorker;\n import net.server.worker.LoginStorageWorker;\n import net.server.worker.RankingCommandWorker;\n@@ -841,6 +842,7 @@ public void init() {\n         tMan.register(new RankingCommandWorker(), 5 * 60 * 1000, 5 * 60 * 1000);\n         tMan.register(new RankingLoginWorker(), ServerConstants.RANKING_INTERVAL, timeLeft);\n         tMan.register(new LoginCoordinatorWorker(), 60 * 60 * 1000, timeLeft);\n+        tMan.register(new EventRecallCoordinatorWorker(), 60 * 60 * 1000, timeLeft);\n         tMan.register(new LoginStorageWorker(), 2 * 60 * 1000, 2 * 60 * 1000);\n         \n         long timeToTake = System.currentTimeMillis();"}, {"sha": "3f338d130af0ba68ac3fe32cf8afe5f32c95136e", "filename": "src/net/server/audit/locks/MonitoredLockType.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/audit/locks/MonitoredLockType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/audit/locks/MonitoredLockType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredLockType.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -70,6 +70,7 @@\n     WORLD_PSHOPS,\n     WORLD_MERCHS,\n     WORLD_MAPOBJS,\n+    WORLD_SUGGEST,\n     EIM,\n     EIM_PARTY,\n     EIM_SCRIPT,"}, {"sha": "a44097c85ac834a68280d70073a1e448b4d47cfc", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -53,14 +53,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         }\n-        final int action = slea.readByte();\n         \n+        final int action = slea.readByte();\n         if (action == 0x03 || action == 0x1E) {\n             slea.readByte();\n             final int useNX = slea.readInt();\n             final int snCS = slea.readInt();\n             CashItem cItem = CashItemFactory.getItem(snCS);\n-            if (cItem == null || !cItem.isOnSale() || cs.getCash(useNX) < cItem.getPrice()) {\n+            if (!canBuy(cItem, cs.getCash(useNX))) {\n                 FilePrinter.printError(FilePrinter.ITEM, \"Denied to sell cash item with SN \" + cItem.getSN());\n                 c.announce(MaplePacketCreator.enableActions());\n                 return;\n@@ -87,7 +87,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 c.announce(MaplePacketCreator.showBoughtCashPackage(cashPackage, c.getAccID()));\n             }\n-            cs.gainCash(useNX, -cItem.getPrice());\n+            cs.gainCash(useNX, cItem, chr.getWorld());\n             c.announce(MaplePacketCreator.showCash(chr));\n         } else if (action == 0x04) {//TODO check for gender\n             int birthday = slea.readInt();\n@@ -113,7 +113,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             cs.gift(Integer.parseInt(recipient.get(\"id\")), chr.getName(), message, cItem.getSN());\n             c.announce(MaplePacketCreator.showGiftSucceed(recipient.get(\"name\"), cItem));\n-            cs.gainCash(4, -cItem.getPrice());\n+            cs.gainCash(4, cItem, chr.getWorld());\n             c.announce(MaplePacketCreator.showCash(chr));\n             try {\n                 chr.sendNote(recipient.get(\"name\"), chr.getName() + \" has sent you a gift! Go check out the Cash Shop.\", (byte) 0); //fame or not\n@@ -156,7 +156,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 if (chr.gainSlots(type, 8, false)) {\n                     c.announce(MaplePacketCreator.showBoughtInventorySlots(type, chr.getSlots(type)));\n-                    cs.gainCash(cash, -cItem.getPrice());\n+                    cs.gainCash(cash, cItem, chr.getWorld());\n                     c.announce(MaplePacketCreator.showCash(chr));\n                 }\n             }\n@@ -186,7 +186,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n                 if (chr.getStorage().gainSlots(8)) {\n                     c.announce(MaplePacketCreator.showBoughtStorageSlots(chr.getStorage().getSlots()));\n-                    cs.gainCash(cash, -cItem.getPrice());\n+                    cs.gainCash(cash, cItem, chr.getWorld());\n                     c.announce(MaplePacketCreator.showCash(chr));\n                 }\n             }\n@@ -202,7 +202,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \n             if (c.gainCharacterSlot()) {\n                 c.announce(MaplePacketCreator.showBoughtCharacterSlot(c.getCharacterSlots()));\n-                cs.gainCash(cash, -cItem.getPrice());\n+                cs.gainCash(cash, cItem, chr.getWorld());\n                 c.announce(MaplePacketCreator.showCash(chr));\n             } else {\n                 chr.dropMessage(1, \"You have already used up all 12 extra character slots.\");\n@@ -276,7 +276,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         cs.addToInventory(eqp);\n                         c.announce(MaplePacketCreator.showBoughtCashItem(eqp, c.getAccID()));\n                         cs.gift(partner.getId(), chr.getName(), text, eqp.getSN(), (ringid + 1));\n-                        cs.gainCash(toCharge, -itemRing.getPrice());\n+                        cs.gainCash(toCharge, itemRing, chr.getWorld());\n                         chr.addCrushRing(MapleRing.loadFromDb(ringid));\n                         try {\n                             chr.sendNote(partner.getName(), text, (byte) 1);\n@@ -357,7 +357,7 @@ public static boolean checkBirthday(MapleClient c, int idate) {\n         return c.checkBirthDate(cal);\n     }\n     \n-    public static boolean canBuy(CashItem item, int cash) {\n+    private static boolean canBuy(CashItem item, int cash) {\n         return item != null && item.isOnSale() && item.getPrice() <= cash;\n     }\n }"}, {"sha": "c8c11a79436ab3ade7da4b06b9708b6d1a273f20", "filename": "src/net/server/channel/handlers/GiveFameHandler.java", "status": "modified", "additions": 14, "deletions": 15, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/GiveFameHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/GiveFameHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GiveFameHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -42,24 +42,23 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         if (target == null || target.getId() == player.getId() || player.getLevel() < 15) {\n             return;\n         } else if (famechange != 1 && famechange != -1) {\n-        \tAutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit fame.\");\n-        \tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to fame hack with famechange \" + famechange + \"\\r\\n\");\n-        \tc.disconnect(true, false);\n-        \treturn;\n+            AutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit fame.\");\n+            FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to fame hack with famechange \" + famechange + \"\\r\\n\");\n+            c.disconnect(true, false);\n+            return;\n         }\n+        \n         FameStatus status = player.canGiveFame(target);\n-        if (status == FameStatus.OK || player.isGM()){\n-        \t if (Math.abs(target.getFame() + famechange) < 30001) {\n-                 target.addFame(famechange);\n-                 target.updateSingleStat(MapleStat.FAME, target.getFame());\n-             }\n-             if (!player.isGM()) {\n-                 player.hasGivenFame(target);\n-             }\n-             c.announce(MaplePacketCreator.giveFameResponse(mode, target.getName(), target.getFame()));\n-             target.getClient().announce(MaplePacketCreator.receiveFame(mode, player.getName()));\n+        if (status == FameStatus.OK) {\n+            if (target.gainFame(famechange, player, mode)) {\n+                if (!player.isGM()) {\n+                    player.hasGivenFame(target);\n+                }\n+            } else {\n+                player.message(\"Could not process the request, since this character currently has the minimum/maximum level of fame.\");\n+            }\n         } else {\n-        \tc.announce(MaplePacketCreator.giveFameErrorResponse(status == FameStatus.NOT_TODAY ? 3 : 4));\n+            c.announce(MaplePacketCreator.giveFameErrorResponse(status == FameStatus.NOT_TODAY ? 3 : 4));\n         }\n     }\n }\n\\ No newline at end of file"}, {"sha": "b5d1d45c18319a37a0ca5f9e30d61a39ef31b2fd", "filename": "src/net/server/channel/handlers/NoteActionHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/NoteActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/NoteActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/NoteActionHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -77,7 +77,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             if (fame > 0) {\n                 c.getPlayer().gainFame(fame);\n-                c.announce(MaplePacketCreator.getShowFameGain(fame));\n             }\n         }\n     }"}, {"sha": "21dc38a877f8197ab5fd5fb2be29e4c8ae7a10eb", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -62,7 +62,11 @@\n import java.util.Collections;\n import java.util.Comparator;\n import java.util.Map;\n+import net.server.coordinator.MapleEventRecallCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator;\n+import org.apache.mina.core.session.IoSession;\n import server.life.MobSkill;\n+import scripting.event.EventInstanceManager;\n import tools.packets.Wedding;\n \n public final class PlayerLoggedinHandler extends AbstractMaplePacketHandler {\n@@ -79,11 +83,23 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         MapleCharacter player = c.getWorldServer().getPlayerStorage().getCharacterById(cid);\n         boolean newcomer = false;\n         if (player == null) {\n-            if(!server.validateCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), cid)) {\n+            IoSession session = c.getSession();\n+            \n+            if (!server.validateCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), cid)) {\n                 c.disconnect(true, false);\n                 return;\n             }\n             \n+            if (ServerConstants.DETERRED_MULTICLIENT) {\n+                String remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n+                if (remoteHwid == null) {\n+                    c.disconnect(true, false);\n+                    return;\n+                }\n+\n+                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+            }\n+            \n             try {\n                 player = MapleCharacter.loadCharFromDB(cid, c, true);\n                 newcomer = true;\n@@ -263,7 +279,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.announce(MaplePacketCreator.requestBuddylistAdd(pendingBuddyRequest.getId(), c.getPlayer().getId(), pendingBuddyRequest.getName()));\n         }\n         \n-        if(newcomer) {\n+        if (newcomer) {\n             for(MaplePet pet : player.getPets()) {\n                 if(pet != null)\n                     world.registerPetHunger(player, player.getPetIndex(pet));\n@@ -332,6 +348,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 partner.announce(Wedding.OnNotifyWeddingPartnerTransfer(player.getId(), player.getMapId()));\n             }\n         }\n+        \n+        if (newcomer) {\n+            EventInstanceManager eim = MapleEventRecallCoordinator.getInstance().recallEventInstance(cid);\n+            if (eim != null) {\n+                eim.registerPlayer(player);\n+            }\n+        }\n     }\n     \n     private static void showDueyNotification(MapleClient c, MapleCharacter player) {"}, {"sha": "1369ca469b3c0d1389013b24b24f6a124fe2e3ad", "filename": "src/net/server/channel/handlers/SpecialMoveHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/SpecialMoveHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/SpecialMoveHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SpecialMoveHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -117,8 +117,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             int gain = lose * (ef.getY() / 100);\n             chr.setMp(chr.getMp() + gain);\n             chr.updateSingleStat(MapleStat.MP, chr.getMp());\n-        } else if (skillid == Priest.DISPEL || skillid == SuperGM.HEAL_PLUS_DISPEL) {\n-            slea.skip((skillid == Priest.DISPEL) ? 10 : 11);\n+        } else if (skillid == SuperGM.HEAL_PLUS_DISPEL) {\n+            slea.skip(11);\n             chr.getMap().broadcastMessage(chr, MaplePacketCreator.showBuffeffect(chr.getId(), skillid, chr.getSkillLevel(skillid)), false);\n         } else if (skillid % 10000000 == 1004) {\n             slea.readShort();"}, {"sha": "18aeed45707d3ab682db21bfbea718912cc33498", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -352,7 +352,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         } else if (itemType == 523) {\n             int itemid = slea.readInt();\n             \n-            if(!ServerConstants.USE_ENFORCE_OWL_SUGGESTIONS) c.getWorldServer().addOwlItemSearch(itemid);\n+            if(!ServerConstants.USE_ENFORCE_ITEM_SUGGESTION) c.getWorldServer().addOwlItemSearch(itemid);\n             player.setOwlSearch(itemid);\n             List<Pair<MaplePlayerShopItem, AbstractMapleMapObject>> hmsAvailable = c.getWorldServer().getAvailableItemBundles(itemid);\n             if(!hmsAvailable.isEmpty()) remove(c, itemId);"}, {"sha": "91a0b733a1eb32e9320f39f6033638ba3bfb5939", "filename": "src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseOwlOfMinervaHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -56,7 +56,7 @@ public int compare(Pair<Integer, Integer> p1, Pair<Integer, Integer> p2) {\n                 }\n             };\n             \n-            PriorityQueue<Pair<Integer, Integer>> queue = new PriorityQueue<>(10, comparator);\n+            PriorityQueue<Pair<Integer, Integer>> queue = new PriorityQueue<>(Math.max(1, owlSearched.size()), comparator);\n             for(Pair<Integer, Integer> p : owlSearched) {\n                 queue.add(p);\n             }"}, {"sha": "8c889a6a1be481f880cf0fad3f7a240e24cbc711", "filename": "src/net/server/coordinator/LoginStorage.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/LoginStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/LoginStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/LoginStorage.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -34,7 +34,7 @@\n  */\n public class LoginStorage {\n     \n-    ConcurrentHashMap<Integer, List<Long>> loginHistory = new ConcurrentHashMap<>();\n+    private ConcurrentHashMap<Integer, List<Long>> loginHistory = new ConcurrentHashMap<>();\n     \n     public boolean registerLogin(int accountId) {\n         List<Long> accHist = loginHistory.putIfAbsent(accountId, new LinkedList<Long>());"}, {"sha": "e790cce155e5d6fb9dae5c4ca4f70a92eb9608ab", "filename": "src/net/server/coordinator/MapleEventRecallCoordinator.java", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/MapleEventRecallCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/MapleEventRecallCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleEventRecallCoordinator.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,73 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.coordinator;\n+\n+import constants.ServerConstants;\n+import scripting.event.EventInstanceManager;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map.Entry;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class MapleEventRecallCoordinator {\n+    \n+    private final static MapleEventRecallCoordinator instance = new MapleEventRecallCoordinator();\n+    \n+    public static MapleEventRecallCoordinator getInstance() {\n+        return instance;\n+    }\n+    \n+    private ConcurrentHashMap<Integer, EventInstanceManager> eventHistory = new ConcurrentHashMap<>();\n+    \n+    private static boolean isRecallableEvent(EventInstanceManager eim) {\n+        return eim != null && !eim.isEventDisposed() && !eim.isEventCleared();\n+    }\n+    \n+    public EventInstanceManager recallEventInstance(int characterId) {\n+        EventInstanceManager eim = eventHistory.remove(characterId);\n+        return isRecallableEvent(eim) ? eim : null;\n+    }\n+    \n+    public void storeEventInstance(int characterId, EventInstanceManager eim) {\n+        if (ServerConstants.USE_ENABLE_RECALL_EVENT && isRecallableEvent(eim)) {\n+            eventHistory.put(characterId, eim);\n+        }\n+    }\n+    \n+    public void manageEventInstances() {\n+        if (!eventHistory.isEmpty()) {\n+            List<Integer> toRemove = new LinkedList<>();\n+            \n+            for (Entry<Integer, EventInstanceManager> eh : eventHistory.entrySet()) {\n+                if (!isRecallableEvent(eh.getValue())) {\n+                    toRemove.add(eh.getKey());\n+                }\n+            }\n+\n+            for (Integer r : toRemove) {\n+                eventHistory.remove(r);\n+            }\n+        }\n+    }\n+}"}, {"sha": "05850085a2f694c5f3df742fd99b5d121a5c8e86", "filename": "src/net/server/coordinator/MapleSessionCoordinator.java", "status": "modified", "additions": 182, "deletions": 31, "changes": 213, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/coordinator/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleSessionCoordinator.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -19,6 +19,7 @@\n */\n package net.server.coordinator;\n \n+import client.MapleClient;\n import constants.ServerConstants;\n \n import net.server.Server;\n@@ -33,11 +34,14 @@\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.LinkedList;\n import java.util.List;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.Map;\n+import java.util.Map.Entry;\n import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantLock;\n \n@@ -58,14 +62,18 @@ public static MapleSessionCoordinator getInstance() {\n         REMOTE_LOGGEDIN,\n         REMOTE_REACHED_LIMIT,\n         REMOTE_PROCESSING,\n+        REMOTE_NO_MATCH,\n         MANY_ACCOUNT_ATTEMPTS,\n         COORDINATOR_ERROR\n     }\n     \n     private final LoginStorage loginStorage = new LoginStorage();\n-    private final Set<String> onlineRemoteHosts = new HashSet<>();\n+    private final Set<String> onlineRemoteHwids = new HashSet<>();\n     private final Map<String, Set<IoSession>> loginRemoteHosts = new HashMap<>();\n     private final Set<String> pooledRemoteHosts = new HashSet<>();\n+    \n+    private final ConcurrentHashMap<String, String> cachedHostHwids = new ConcurrentHashMap<>();\n+    private final ConcurrentHashMap<String, Long> cachedHostTimeout = new ConcurrentHashMap<>();\n     private final List<ReentrantLock> poolLock = new ArrayList<>(100);\n     \n     private MapleSessionCoordinator() {\n@@ -74,7 +82,7 @@ private MapleSessionCoordinator() {\n         }\n     }\n     \n-    private static long ipExpirationUpdate(int relevance) {\n+    private static long hwidExpirationUpdate(int relevance) {\n         int degree = 1, i = relevance, subdegree;\n         while ((subdegree = 5 * degree) <= i) {\n             i -= subdegree;\n@@ -109,59 +117,90 @@ private static long ipExpirationUpdate(int relevance) {\n         return 3600000 * (baseTime + subdegreeTime);\n     }\n     \n-    private static void updateAccessAccount(Connection con, String remoteHost, int accountId, int loginRelevance) throws SQLException {\n-        java.sql.Timestamp nextTimestamp = new java.sql.Timestamp(Server.getInstance().getCurrentTime() + ipExpirationUpdate(loginRelevance));\n+    private static void updateAccessAccount(Connection con, String remoteHwid, int accountId, int loginRelevance) throws SQLException {\n+        java.sql.Timestamp nextTimestamp = new java.sql.Timestamp(Server.getInstance().getCurrentTime() + hwidExpirationUpdate(loginRelevance));\n         if(loginRelevance < Byte.MAX_VALUE) {\n             loginRelevance++;\n         }\n         \n-        try (PreparedStatement ps = con.prepareStatement(\"UPDATE ipaccounts SET relevance = ?, expiresat = ? WHERE accountid = ? AND ip LIKE ?\")) {\n+        try (PreparedStatement ps = con.prepareStatement(\"UPDATE hwidaccounts SET relevance = ?, expiresat = ? WHERE accountid = ? AND hwid LIKE ?\")) {\n             ps.setInt(1, loginRelevance);\n             ps.setTimestamp(2, nextTimestamp);\n             ps.setInt(3, accountId);\n-            ps.setString(4, remoteHost);\n+            ps.setString(4, remoteHwid);\n             \n             ps.executeUpdate();\n         }\n     }\n     \n-    private static void registerAccessAccount(Connection con, String remoteHost, int accountId) throws SQLException {\n-        try (PreparedStatement ps = con.prepareStatement(\"INSERT INTO ipaccounts (accountid, ip, expiresat) VALUES (?, ?, ?)\")) {\n+    private static void registerAccessAccount(Connection con, String remoteHwid, int accountId) throws SQLException {\n+        try (PreparedStatement ps = con.prepareStatement(\"INSERT INTO hwidaccounts (accountid, hwid, expiresat) VALUES (?, ?, ?)\")) {\n             ps.setInt(1, accountId);\n-            ps.setString(2, remoteHost);\n-            ps.setTimestamp(3, new java.sql.Timestamp(Server.getInstance().getCurrentTime() + ipExpirationUpdate(0)));\n+            ps.setString(2, remoteHwid);\n+            ps.setTimestamp(3, new java.sql.Timestamp(Server.getInstance().getCurrentTime() + hwidExpirationUpdate(0)));\n             \n             ps.executeUpdate();\n         }\n     }\n     \n-    private static boolean attemptAccessAccount(String remoteHost, int accountId, boolean routineCheck) {\n+    private static boolean associateHwidAccountIfAbsent(String remoteHwid, int accountId) {\n+        try {\n+            Connection con = DatabaseConnection.getConnection();\n+            int hwidCount = 0;\n+            \n+            try (PreparedStatement ps = con.prepareStatement(\"SELECT SQL_CACHE hwid FROM hwidaccounts WHERE accountid = ?\")) {\n+                ps.setInt(1, accountId);\n+                try (ResultSet rs = ps.executeQuery()) {\n+                    while (rs.next()) {\n+                        String rsHwid = rs.getString(\"hwid\");\n+                        if (rsHwid.contentEquals(remoteHwid)) {\n+                            return false;\n+                        }\n+                        \n+                        hwidCount++;\n+                    }\n+                }\n+                \n+                if (hwidCount < ServerConstants.MAX_ALLOWED_ACCOUNT_HWID) {\n+                    registerAccessAccount(con, remoteHwid, accountId);\n+                    return true;\n+                }\n+            } finally {\n+                con.close();\n+            }\n+        } catch (SQLException ex) {\n+            ex.printStackTrace();\n+        }\n+        \n+        return false;\n+    }\n+    \n+    private static boolean attemptAccessAccount(String nibbleHwid, int accountId, boolean routineCheck) {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            int ipCount = 0;\n+            int hwidCount = 0;\n             \n-            try (PreparedStatement ps = con.prepareStatement(\"SELECT SQL_CACHE * FROM ipaccounts WHERE accountid = ?\")) {\n+            try (PreparedStatement ps = con.prepareStatement(\"SELECT SQL_CACHE * FROM hwidaccounts WHERE accountid = ?\")) {\n                 ps.setInt(1, accountId);\n                 try (ResultSet rs = ps.executeQuery()) {\n                     while (rs.next()) {\n-                        if (remoteHost.contentEquals(rs.getString(\"ip\"))) {\n+                        String rsHwid = rs.getString(\"hwid\");\n+                        if (rsHwid.endsWith(nibbleHwid)) {\n                             if (!routineCheck) {\n+                                // better update HWID relevance as soon as the login is authenticated\n+                                \n                                 int loginRelevance = rs.getInt(\"relevance\");\n-                                updateAccessAccount(con, remoteHost, accountId, loginRelevance);\n+                                updateAccessAccount(con, rsHwid, accountId, loginRelevance);\n                             }\n                             \n                             return true;\n                         }\n                         \n-                        ipCount++;\n+                        hwidCount++;\n                     }\n                 }\n                 \n-                if (ipCount < ServerConstants.MAX_ALLOWED_ACCOUNT_IP) {\n-                    if (!routineCheck) {\n-                        registerAccessAccount(con, remoteHost, accountId);\n-                    }\n-                    \n+                if (hwidCount < ServerConstants.MAX_ALLOWED_ACCOUNT_HWID) {\n                     return true;\n                 }\n             } finally {\n@@ -218,7 +257,14 @@ public boolean canStartLoginSession(IoSession session) {\n         }\n         \n         try {\n-            if (onlineRemoteHosts.contains(remoteHost) || loginRemoteHosts.containsKey(remoteHost)) {\n+            String knownHwid = cachedHostHwids.get(remoteHost);\n+            if (knownHwid != null) {\n+                if (onlineRemoteHwids.contains(knownHwid)) {\n+                    return false;\n+                }\n+            }\n+            \n+            if (loginRemoteHosts.containsKey(remoteHost)) {\n                 return false;\n             }\n             \n@@ -244,11 +290,16 @@ public void closeLoginSession(IoSession session) {\n             lrh.remove(session);\n             if (lrh.isEmpty()) {\n                 loginRemoteHosts.remove(remoteIp);\n+                \n+                String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+                if (nibbleHwid != null) {\n+                    onlineRemoteHwids.remove(nibbleHwid);\n+                }\n             }\n         }\n     }\n     \n-    public AntiMulticlientResult attemptSessionLogin(IoSession session, int accountId, boolean routineCheck) {\n+    public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbleHwid, int accountId, boolean routineCheck) {\n         if (!ServerConstants.DETERRED_MULTICLIENT) return AntiMulticlientResult.SUCCESS;\n         \n         String remoteHost = getRemoteIp(session);\n@@ -289,17 +340,18 @@ public AntiMulticlientResult attemptSessionLogin(IoSession session, int accountI\n             }\n             \n             if (!routineCheck) {\n-                if (onlineRemoteHosts.contains(remoteHost)) {\n+                if (onlineRemoteHwids.contains(nibbleHwid)) {\n                     return AntiMulticlientResult.REMOTE_LOGGEDIN;\n                 }\n \n-                if (!attemptAccessAccount(remoteHost, accountId, routineCheck)) {\n+                if (!attemptAccessAccount(nibbleHwid, accountId, routineCheck)) {\n                     return AntiMulticlientResult.REMOTE_REACHED_LIMIT;\n                 }\n                 \n-                onlineRemoteHosts.add(remoteHost);\n+                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, nibbleHwid);\n+                onlineRemoteHwids.add(nibbleHwid);\n             } else {\n-                if (!attemptAccessAccount(remoteHost, accountId, routineCheck)) {\n+                if (!attemptAccessAccount(nibbleHwid, accountId, routineCheck)) {\n                     return AntiMulticlientResult.REMOTE_REACHED_LIMIT;\n                 }\n             }\n@@ -315,22 +367,121 @@ public AntiMulticlientResult attemptSessionLogin(IoSession session, int accountI\n         }\n     }\n     \n+    public AntiMulticlientResult attemptGameSession(IoSession session, int accountId, String remoteHwid) {\n+        if (!ServerConstants.DETERRED_MULTICLIENT) return AntiMulticlientResult.SUCCESS;\n+        \n+        String remoteHost = getRemoteIp(session);\n+        Lock lock = getCoodinatorLock(remoteHost);\n+        \n+        try {\n+            int tries = 0;\n+            while (true) {\n+                if (lock.tryLock()) {\n+                    try {\n+                        if (pooledRemoteHosts.contains(remoteHost)) {\n+                            return AntiMulticlientResult.REMOTE_PROCESSING;\n+                        }\n+                        \n+                        pooledRemoteHosts.add(remoteHost);\n+                    } finally {\n+                        lock.unlock();\n+                    }\n+                    \n+                    break;\n+                } else {\n+                    if(tries == 2) {\n+                        return AntiMulticlientResult.COORDINATOR_ERROR;\n+                    }\n+                    tries++;\n+                    \n+                    Thread.sleep(1777);\n+                }\n+            }\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            return AntiMulticlientResult.COORDINATOR_ERROR;\n+        }\n+        \n+        try {\n+            String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+            if (nibbleHwid != null) {\n+                onlineRemoteHwids.remove(nibbleHwid);\n+                \n+                if (remoteHwid.endsWith(nibbleHwid)) {\n+                    if (!onlineRemoteHwids.contains(remoteHwid)) {\n+                        // assumption: after a SUCCESSFUL login attempt, the incoming client WILL receive a new IoSession from the game server\n+                        \n+                        // updated session CLIENT_HWID attribute will be set when the player log in the game\n+                        onlineRemoteHwids.add(remoteHwid);\n+\n+                        cachedHostHwids.put(remoteHost, remoteHwid);\n+                        cachedHostTimeout.put(remoteHost, Server.getInstance().getCurrentTime() + 604800000);   // 1 week-time entry\n+                        \n+                        associateHwidAccountIfAbsent(remoteHwid, accountId);\n+\n+                        return AntiMulticlientResult.SUCCESS;\n+                    } else {\n+                        return AntiMulticlientResult.REMOTE_LOGGEDIN;\n+                    }\n+                } else {\n+                    return AntiMulticlientResult.REMOTE_NO_MATCH;\n+                }\n+            } else {\n+                return AntiMulticlientResult.REMOTE_NO_MATCH;\n+            }\n+        } finally {\n+            lock.lock();\n+            try {\n+                pooledRemoteHosts.remove(remoteHost);\n+            } finally {\n+                lock.unlock();\n+            }\n+        }\n+    }\n+    \n     public void closeSession(IoSession session, Boolean immediately) {\n-        onlineRemoteHosts.remove(getRemoteIp(session));\n-        if (immediately != null) session.close(immediately);\n+        String hwid = (String) session.removeAttribute(MapleClient.CLIENT_HWID);\n+        onlineRemoteHwids.remove(hwid);\n+        \n+        hwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID); // making sure to clean up calls to this function on login phase\n+        onlineRemoteHwids.remove(hwid);\n+        \n+        if (immediately != null) {\n+            session.close(immediately);\n+        }\n+    }\n+    \n+    public String getGameSessionHwid(IoSession session) {\n+        String remoteHost = getRemoteIp(session);\n+        return cachedHostHwids.get(remoteHost);\n     }\n     \n-    public void runUpdateIpHistory() {\n+    public void runUpdateHwidHistory() {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            try (PreparedStatement ps = con.prepareStatement(\"DELETE FROM ipaccounts WHERE expiresat < CURRENT_TIMESTAMP\")) {\n+            try (PreparedStatement ps = con.prepareStatement(\"DELETE FROM hwidaccounts WHERE expiresat < CURRENT_TIMESTAMP\")) {\n                 ps.execute();\n             } finally {\n                 con.close();\n             }\n         } catch (SQLException ex) {\n             ex.printStackTrace();\n         }\n+        \n+        long timeNow = Server.getInstance().getCurrentTime();\n+        List<String> toRemove = new LinkedList<>();\n+        for (Entry<String, Long> cht : cachedHostTimeout.entrySet()) {\n+            if (cht.getValue() < timeNow) {\n+                toRemove.add(cht.getKey());\n+            }\n+        }\n+        \n+        if (!toRemove.isEmpty()) {\n+            for (String s : toRemove) {\n+                cachedHostHwids.remove(s);\n+                cachedHostTimeout.remove(s);\n+            }\n+        }\n     }\n     \n     public void runUpdateLoginHistory() {"}, {"sha": "5ba2321f70f5b557b82049ad12249344d34d22d0", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -23,6 +23,7 @@\n \n import client.MapleCharacter;\n import client.MapleClient;\n+import constants.ServerConstants;\n \n import java.sql.Connection;\n import java.sql.PreparedStatement;\n@@ -752,6 +753,12 @@ public void resetAllianceGuildPlayersRank() {\n     }\n \n     public static int getIncreaseGuildCost(int size) {\n-        return 500000 * (size - 6) / 6;\n+        int cost = ServerConstants.EXPAND_GUILD_BASE_COST + Math.max(0, (size - 15) / 5) * ServerConstants.EXPAND_GUILD_TIER_COST;\n+        \n+        if (size > 30) {\n+            return Math.min(ServerConstants.EXPAND_GUILD_MAX_COST, Math.max(cost, 5000000));\n+        } else {\n+            return cost;\n+        }\n     }\n }"}, {"sha": "dd24f5987373c5fa1875b5a2a71a701b002d9990", "filename": "src/net/server/handlers/login/CharSelectedHandler.java", "status": "modified", "additions": 39, "deletions": 3, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/CharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/CharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -27,28 +27,64 @@\n import java.net.UnknownHostException;\n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import net.server.world.World;\n+import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class CharSelectedHandler extends AbstractMaplePacketHandler {\n+    \n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n \n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         int charId = slea.readInt();\n         \n         String macs = slea.readMapleAsciiString();\n         String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n         c.updateMacs(macs);\n         c.updateHWID(hwid);\n+        \n+        IoSession session = c.getSession();\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            session.close(true);\n             return;\n         }\n \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            session.close(true);\n             return;\n         }\n         \n@@ -67,7 +103,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         server.unregisterLoginState(c);\n         c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition((InetSocketAddress) c.getSession().getRemoteAddress(), charId);\n+        server.setCharacteridInTransition((InetSocketAddress) session.getRemoteAddress(), charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "3d31ff120334f93e0efe2d329d6f4a686bdc30e4", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -6,22 +6,58 @@\n \n import net.AbstractMaplePacketHandler;\n import net.server.Server;\n+import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n import net.server.world.World;\n+import org.apache.mina.core.session.IoSession;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n \n public class CharSelectedWithPicHandler extends AbstractMaplePacketHandler {\n \n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n+\n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         String pic = slea.readMapleAsciiString();\n         int charId = slea.readInt();\n         \n         String macs = slea.readMapleAsciiString();\n         String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n         c.updateMacs(macs);\n         c.updateHWID(hwid);\n+        \n+        IoSession session = c.getSession();\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n             c.getSession().close(true);\n             return;"}, {"sha": "1feada78e303ed286d1263948488d92c83967564", "filename": "src/net/server/handlers/login/LoginPasswordHandler.java", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/LoginPasswordHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/LoginPasswordHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/LoginPasswordHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -31,6 +31,7 @@\n import net.server.Server;\n import tools.BCrypt;\n import tools.DatabaseConnection;\n+import tools.HexTool;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n@@ -51,8 +52,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         String login = slea.readMapleAsciiString();\n         String pwd = slea.readMapleAsciiString();\n         c.setAccountName(login);\n-\n-        int loginok = c.login(login, pwd);\n+        \n+        slea.skip(6);   // localhost masked the initial part with zeroes...\n+        byte[] hwidNibbles = slea.read(4);\n+        int loginok = c.login(login, pwd, HexTool.toCompressedString(hwidNibbles));\n \n         Connection con = null;\n         PreparedStatement ps = null;\n@@ -63,8 +66,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 ps = con.prepareStatement(\"INSERT INTO accounts (name, password, birthday, tempban) VALUES (?, ?, ?, ?);\", Statement.RETURN_GENERATED_KEYS); //Jayd: Added birthday, tempban\n                 ps.setString(1, login);\n                 ps.setString(2, BCrypt.hashpw(pwd, BCrypt.gensalt(12)));\n-                ps.setString(3, \"2018-06-20\"); //Jayd: was added to solve the MySQL 5.7 strict checking (birthday)\n-                ps.setString(4, \"2018-06-20\"); //Jayd: was added to solve the MySQL 5.7 strict checking (tempban)\n+                ps.setString(3, \"2018-06-20\"); //Jayd's idea: was added to solve the MySQL 5.7 strict checking (birthday)\n+                ps.setString(4, \"2018-06-20\"); //Jayd's idea: was added to solve the MySQL 5.7 strict checking (tempban)\n                 ps.executeUpdate();\n                 \n                 ResultSet rs = ps.getGeneratedKeys();\n@@ -75,7 +78,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 e.printStackTrace();\n             } finally {\n                 disposeSql(con, ps);\n-                loginok = c.login(login, pwd);\n+                loginok = c.login(login, pwd, HexTool.toCompressedString(hwidNibbles));\n             }\n         }\n \n@@ -100,7 +103,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         Calendar tempban = c.getTempBanCalendar();\n         if (tempban != null) {\n-            if (tempban.getTimeInMillis() > System.currentTimeMillis()) {\n+            if (tempban.getTimeInMillis() > Calendar.getInstance().getTimeInMillis()) {\n                 c.announce(MaplePacketCreator.getTempBan(tempban.getTimeInMillis(), c.getGReason()));\n                 return;\n             }"}, {"sha": "016dd895272010d681ac07a450ac1cb892d0c21d", "filename": "src/net/server/handlers/login/RegisterPicHandler.java", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/RegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/handlers/login/RegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/RegisterPicHandler.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -10,18 +10,54 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n import client.MapleClient;\n import java.net.InetSocketAddress;\n+import net.server.coordinator.MapleSessionCoordinator;\n+import net.server.coordinator.MapleSessionCoordinator.AntiMulticlientResult;\n+import org.apache.mina.core.session.IoSession;\n \n public final class RegisterPicHandler extends AbstractMaplePacketHandler {\n \n+    private static int parseAntiMulticlientError(AntiMulticlientResult res) {\n+        switch (res) {\n+            case REMOTE_PROCESSING:\n+                return 10;\n+\n+            case REMOTE_LOGGEDIN:\n+                return 7;\n+\n+            case REMOTE_NO_MATCH:\n+                return 17;\n+                \n+            case COORDINATOR_ERROR:\n+                return 8;\n+                \n+            default:\n+                return 9;\n+        }\n+    }\n+    \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         slea.readByte();\n         int charId = slea.readInt();\n         \n         String macs = slea.readMapleAsciiString();\n-        String hwid = slea.readMapleAsciiString();\t\n+        String hwid = slea.readMapleAsciiString();\n+        \n+        if (!hwid.matches(\"[0-9A-F]{12}_[0-9A-F]{8}\")) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(17));\n+            return;\n+        }\n+        \n         c.updateMacs(macs);\n         c.updateHWID(hwid);\n+        \n+        IoSession session = c.getSession();\n+        AntiMulticlientResult res = MapleSessionCoordinator.getInstance().attemptGameSession(session, c.getAccID(), hwid);\n+        if (res != AntiMulticlientResult.SUCCESS) {\n+            c.announce(MaplePacketCreator.getAfterLoginError(parseAntiMulticlientError(res)));\n+            return;\n+        }\n+        \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n             c.getSession().close(true);\n             return;"}, {"sha": "35a6517fc292d3f117d34e77e74a6f90da5de3d4", "filename": "src/net/server/worker/EventRecallCoordinatorWorker.java", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/worker/EventRecallCoordinatorWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/worker/EventRecallCoordinatorWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/EventRecallCoordinatorWorker.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,34 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.worker;\n+\n+import net.server.coordinator.MapleEventRecallCoordinator;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class EventRecallCoordinatorWorker implements Runnable {\n+    \n+    @Override\n+    public void run() {\n+        MapleEventRecallCoordinator.getInstance().manageEventInstances();\n+    }\n+}"}, {"sha": "0bb2345547f997538665e47a3c7874a4f7489886", "filename": "src/net/server/worker/LoginCoordinatorWorker.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/worker/LoginCoordinatorWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/worker/LoginCoordinatorWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/LoginCoordinatorWorker.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -29,6 +29,6 @@\n     \n     @Override\n     public void run() {\n-        MapleSessionCoordinator.getInstance().runUpdateIpHistory();\n+        MapleSessionCoordinator.getInstance().runUpdateHwidHistory();\n     }\n }"}, {"sha": "3baee5125d7de6c838ab3f253ac964a694ac9dbb", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 114, "deletions": 5, "changes": 119, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -27,6 +27,7 @@\n import client.BuddylistEntry;\n import client.MapleCharacter;\n import client.MapleFamily;\n+import constants.GameConstants;\n import constants.ServerConstants;\n import java.sql.Connection;\n \n@@ -53,6 +54,7 @@\n \n import java.util.Set;\n import java.util.HashSet;\n+import java.util.PriorityQueue;\n import java.util.concurrent.ScheduledFuture;\n \n import scripting.event.EventInstanceManager;\n@@ -122,6 +124,11 @@\n     private MonitoredReentrantLock partyLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_PARTY, true);\n     \n     private Map<Integer, Integer> owlSearched = new LinkedHashMap<>();\n+    private List<Map<Integer, Integer>> cashItemBought = new ArrayList<>(9);\n+    private final ReentrantReadWriteLock suggestLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.WORLD_SUGGEST, true);\n+    private ReadLock suggestRLock = suggestLock.readLock();\n+    private WriteLock suggestWLock = suggestLock.writeLock();\n+    \n     private Map<Integer, Integer> disabledServerMessages = new HashMap<>();    // reuse owl lock\n     private MonitoredReentrantLock srvMessagesLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.WORLD_SRVMESSAGES);\n     private ScheduledFuture<?> srvMessagesSchedule;\n@@ -166,6 +173,10 @@ public World(int world, int flag, String eventmsg, int exprate, int droprate, in\n         petUpdate = System.currentTimeMillis();\n         mountUpdate = petUpdate;\n         \n+        for (int i = 0; i < 9; i++) {\n+            cashItemBought.add(new LinkedHashMap<Integer, Integer>());\n+        }\n+        \n         TimerManager tman = TimerManager.getInstance();\n         petsSchedule = tman.register(new PetFullnessWorker(this), 60 * 1000, 60 * 1000);\n         srvMessagesSchedule = tman.register(new ServerMessageWorker(this), 10 * 1000, 10 * 1000);\n@@ -1152,7 +1163,7 @@ private static Integer getPetKey(MapleCharacter chr, byte petSlot) {    // assum\n     }\n     \n     public void addOwlItemSearch(Integer itemid) {\n-        srvMessagesLock.lock();\n+        suggestWLock.lock();\n         try {\n             Integer cur = owlSearched.get(itemid);\n             if(cur != null) {\n@@ -1161,16 +1172,16 @@ public void addOwlItemSearch(Integer itemid) {\n                 owlSearched.put(itemid, 1);\n             }\n         } finally {\n-            srvMessagesLock.unlock();\n+            suggestWLock.unlock();\n         }\n     }\n     \n     public List<Pair<Integer, Integer>> getOwlSearchedItems() {\n-        if(ServerConstants.USE_ENFORCE_OWL_SUGGESTIONS) {\n+        if(ServerConstants.USE_ENFORCE_ITEM_SUGGESTION) {\n             return new ArrayList<>(0);\n         }\n         \n-        srvMessagesLock.lock();\n+        suggestRLock.lock();\n         try {\n             List<Pair<Integer, Integer>> searchCounts = new ArrayList<>(owlSearched.size());\n             \n@@ -1180,8 +1191,106 @@ public void addOwlItemSearch(Integer itemid) {\n             \n             return searchCounts;\n         } finally {\n-            srvMessagesLock.unlock();\n+            suggestRLock.unlock();\n+        }\n+    }\n+    \n+    public void addCashItemBought(Integer snid) {\n+        suggestWLock.lock();\n+        try {\n+            Map<Integer, Integer> tabItemBought = cashItemBought.get(snid / 10000000);\n+            \n+            Integer cur = tabItemBought.get(snid);\n+            if (cur != null) {\n+                tabItemBought.put(snid, cur + 1);\n+            } else {\n+                tabItemBought.put(snid, 1);\n+            }\n+        } finally {\n+            suggestWLock.unlock();\n+        }\n+    }\n+    \n+    private List<List<Pair<Integer, Integer>>> getBoughtCashItems() {\n+        if (ServerConstants.USE_ENFORCE_ITEM_SUGGESTION) {\n+            return new ArrayList<>(0);\n+        }\n+        \n+        suggestRLock.lock();\n+        try {\n+            List<List<Pair<Integer, Integer>>> boughtCounts = new ArrayList<>(cashItemBought.size());\n+            \n+            for (Map<Integer, Integer> tab : cashItemBought) {\n+                List<Pair<Integer, Integer>> tabItems = new LinkedList<>();\n+                boughtCounts.add(tabItems);\n+                \n+                for (Entry<Integer, Integer> e : tab.entrySet()) {\n+                    tabItems.add(new Pair<>(e.getKey(), e.getValue()));\n+                }\n+            }\n+            \n+            return boughtCounts;\n+        } finally {\n+            suggestRLock.unlock();\n+        }\n+    }\n+    \n+    private List<Integer> getMostSellerOnTab(List<Pair<Integer, Integer>> tabSellers) {\n+        List<Integer> tabLeaderboards;\n+        \n+        Comparator<Pair<Integer, Integer>> comparator = new Comparator<Pair<Integer, Integer>>() {  // descending order\n+            @Override\n+            public int compare(Pair<Integer, Integer> p1, Pair<Integer, Integer> p2) {\n+                return p2.getRight().compareTo(p1.getRight());\n+            }\n+        };\n+\n+        PriorityQueue<Pair<Integer, Integer>> queue = new PriorityQueue<>(Math.max(1, tabSellers.size()), comparator);\n+        for(Pair<Integer, Integer> p : tabSellers) {\n+            queue.add(p);\n+        }\n+\n+        tabLeaderboards = new LinkedList<>();\n+        for(int i = 0; i < Math.min(tabSellers.size(), 5); i++) {\n+            tabLeaderboards.add(queue.remove().getLeft());\n+        }\n+        \n+        return tabLeaderboards;\n+    }\n+    \n+    public List<List<Integer>> getMostSellerCashItems() {\n+        List<List<Pair<Integer, Integer>>> mostSellers = this.getBoughtCashItems();\n+        List<List<Integer>> cashLeaderboards = new ArrayList<>(9);\n+        List<Integer> tabLeaderboards;\n+        List<Integer> allLeaderboards = null;\n+        \n+        for(List<Pair<Integer, Integer>> tabSellers : mostSellers) {\n+            if (tabSellers.size() < 5) {\n+                if (allLeaderboards == null) {\n+                    List<Pair<Integer, Integer>> allSellers = new LinkedList<>();\n+                    for (List<Pair<Integer, Integer>> tabItems : mostSellers) {\n+                        allSellers.addAll(tabItems);\n+                    }\n+                    \n+                    allLeaderboards = getMostSellerOnTab(allSellers);\n+                }\n+                \n+                tabLeaderboards = new LinkedList<>();\n+                if (allLeaderboards.size() < 5) {\n+                    for(int i : GameConstants.CASH_DATA) {\n+                        tabLeaderboards.add(i);\n+                    }\n+                } else {\n+                    tabLeaderboards.addAll(allLeaderboards);\n+                }\n+            } else {\n+                tabLeaderboards = getMostSellerOnTab(tabSellers);\n+            }\n+            \n+            cashLeaderboards.add(tabLeaderboards);\n         }\n+        \n+        return cashLeaderboards;\n     }\n     \n     public void registerPetHunger(MapleCharacter chr, byte petSlot) {"}, {"sha": "919c447d716511114a67c54530fcee1bd62dc3d2", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -54,6 +54,7 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.MapleQuestStatus;\n+import client.MapleStat;\n import client.SkillFactory;\n import client.inventory.Equip;\n import client.inventory.Item;\n@@ -581,8 +582,7 @@ public Item gainItem(int id, short quantity, boolean randomStats, boolean showMe\n \t}\n         \n         public void gainFame(int delta) {\n-                c.getPlayer().addFame(delta);\n-                c.announce(MaplePacketCreator.getShowFameGain(delta));\n+                getPlayer().gainFame(delta);\n         }\n \n \tpublic void changeMusic(String songName) {"}, {"sha": "5af9606cc030e67559ddd01b7c864420b33c34e4", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -65,6 +65,7 @@\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n+import net.server.coordinator.MapleEventRecallCoordinator;\n import scripting.AbstractPlayerInteraction;\n import server.MapleItemInformationProvider;\n import server.life.MapleLifeFactory;\n@@ -599,6 +600,8 @@ public void playerDisconnected(MapleCharacter chr) {\n \t\t} catch (ScriptException | NoSuchMethodException ex) {\n \t\t\tex.printStackTrace();\n \t\t}\n+                \n+                MapleEventRecallCoordinator.getInstance().storeEventInstance(chr.getId(), this);\n \t}\n \n \t/**\n@@ -862,7 +865,7 @@ public void disbandParty() {\n \t}\n \n \tpublic void clearPQ() {\n-\t\ttry {\n+                try {\n                         sL.lock();\n                         try {\n                                 em.getIv().invokeFunction(\"clearPQ\", this);\n@@ -1157,6 +1160,10 @@ public final void startEvent() {\n         public final void setEventCleared() {\n                 eventCleared = true;\n                 \n+                for (MapleCharacter chr : getPlayers()) {\n+                        chr.awardQuestPoint(ServerConstants.QUEST_POINT_PER_EVENT_CLEAR);\n+                }\n+                \n                 sL.lock();\n                 try {\n                         em.disposeInstance(name);\n@@ -1171,6 +1178,10 @@ public final boolean isEventCleared() {\n                 return eventCleared;\n         }\n         \n+        public final boolean isEventDisposed() {\n+                return disposed;\n+        }\n+        \n         private boolean isEventTeamLeaderOn() {\n                 for(MapleCharacter chr: getPlayers()) {\n                         if(chr.getId() == getLeaderId()) return true;"}, {"sha": "c9fa8f40539b9d82712a70c2fc12fe5c1ee8bc42", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -285,6 +285,7 @@ public int getLevel() {\n \t\treturn getPlayer().getLevel();\n \t}\n \n+        @Override\n \tpublic void showEffect(String effect) {\n \t\tgetPlayer().getMap().broadcastMessage(MaplePacketCreator.environmentChange(effect, 3));\n \t}"}, {"sha": "7b94add557803dc8f92c5234145aa3e932fc68f3", "filename": "src/scripting/quest/QuestScriptManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/quest/QuestScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/quest/QuestScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/quest/QuestScriptManager.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -42,7 +42,7 @@\n     \n         private static QuestScriptManager instance = new QuestScriptManager();\n \n-\tpublic synchronized static QuestScriptManager getInstance() {\n+\tpublic static QuestScriptManager getInstance() {\n \t\treturn instance;\n \t}\n     "}, {"sha": "f10395768b62251552002bfa7656c4909708c722", "filename": "src/scripting/reactor/ReactorScriptManager.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/reactor/ReactorScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/scripting/reactor/ReactorScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorScriptManager.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -44,7 +44,7 @@\n \n     private static ReactorScriptManager instance = new ReactorScriptManager();\n     \n-    public synchronized static ReactorScriptManager getInstance() {\n+    public static ReactorScriptManager getInstance() {\n         return instance;\n     }\n     "}, {"sha": "d32991dc09d41d22d62780e607a00338e45cc174", "filename": "src/server/CashShop.java", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/CashShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/CashShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/CashShop.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -32,6 +32,8 @@\n import java.util.Map;\n import java.util.Map.Entry;\n import java.util.concurrent.locks.Lock;\n+\n+import net.server.Server;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n import provider.MapleData;\n@@ -107,18 +109,18 @@ public Item toItem() {\n             if (ItemConstants.EXPIRING_ITEMS) {\n                     if(period == 1) {\n                             if(itemId == 5211048 || itemId == 5360042) { // 4 Hour 2X coupons, the period is 1, but we don't want them to last a day.\n-                                    item.setExpiration(System.currentTimeMillis() + (1000 * 60 * 60 * 4));\n+                                    item.setExpiration(Server.getInstance().getCurrentTime() + (1000 * 60 * 60 * 4));\n                             /*\n                             } else if(itemId == 5211047 || itemId == 5360014) { // 3 Hour 2X coupons, unused as of now\n-                                    item.setExpiration(System.currentTimeMillis() + (1000 * 60 * 60 * 3));\n+                                    item.setExpiration(Server.getInstance().getCurrentTime() + (1000 * 60 * 60 * 3));\n                             */\n                             } else if(itemId == 5211060) { // 2 Hour 3X coupons.\n-                                    item.setExpiration(System.currentTimeMillis() + (1000 * 60 * 60 * 2));\n+                                    item.setExpiration(Server.getInstance().getCurrentTime() + (1000 * 60 * 60 * 2));\n                             } else {\n-                                    item.setExpiration(System.currentTimeMillis() + (1000 * 60 * 60 * 24));\n+                                    item.setExpiration(Server.getInstance().getCurrentTime() + (1000 * 60 * 60 * 24));\n                             }\n                     } else {\n-                            item.setExpiration(System.currentTimeMillis() + (1000 * 60 * 60 * 24 * period));\n+                            item.setExpiration(Server.getInstance().getCurrentTime() + (1000 * 60 * 60 * 24 * period));\n                     }\n             }\n             \n@@ -353,6 +355,11 @@ public void gainCash(int type, int cash) {\n                 break;\n         }\n     }\n+    \n+    public void gainCash(int type, CashItem buyItem, int world) {\n+        gainCash(type, -buyItem.getPrice());\n+        if(!ServerConstants.USE_ENFORCE_ITEM_SUGGESTION) Server.getInstance().getWorld(world).addCashItemBought(buyItem.getSN());\n+    }\n \n     public boolean isOpened() {\n         return opened;"}, {"sha": "e79eba08b137accc30cd26dad2cc974d7e7d5b60", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 68, "deletions": 17, "changes": 85, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -97,6 +97,8 @@ public static MapleItemInformationProvider getInstance() {\n     protected Map<Integer, MapleStatEffect> itemEffects = new HashMap<>();\n     protected Map<Integer, Map<String, Integer>> equipStatsCache = new HashMap<>();\n     protected Map<Integer, Equip> equipCache = new HashMap<>();\n+    protected Map<Integer, MapleData> equipLevelInfoCache = new HashMap<>();\n+    protected Map<Integer, Integer> equipMaxLevelCache = new HashMap<>();\n     protected Map<Integer, Integer> wholePriceCache = new HashMap<>();\n     protected Map<Integer, Double> unitPriceCache = new HashMap<>();\n     protected Map<Integer, Integer> projectileWatkCache = new HashMap<>();\n@@ -1217,7 +1219,7 @@ public String getMsg(int itemId) {\n         return ret;\n     }\n \n-    public boolean isDropRestricted(int itemId) {\n+    public boolean isLootRestricted(int itemId) {\n         if (dropRestrictionCache.containsKey(itemId)) {\n             return dropRestrictionCache.get(itemId);\n         }\n@@ -1227,16 +1229,17 @@ public boolean isDropRestricted(int itemId) {\n             MapleData data = getItemData(itemId);\n             bRestricted = MapleDataTool.getIntConvert(\"info/tradeBlock\", data, 0) == 1;\n             if (!bRestricted) {\n-                    bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n-            }\n-            if (!bRestricted) {\n-                bRestricted = MapleDataTool.getIntConvert(\"info/quest\", data, 0) == 1;\n+                bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n             }\n         }\n         \n         dropRestrictionCache.put(itemId, bRestricted);\n         return bRestricted;\n     }\n+    \n+    public boolean isDropRestricted(int itemId) {\n+        return isLootRestricted(itemId) || isQuestItem(itemId);\n+    }\n \n     public boolean isPickupRestricted(int itemId) {\n         if (pickupRestrictionCache.containsKey(itemId)) {\n@@ -1674,24 +1677,72 @@ public boolean canWearEquipment(MapleCharacter chr, Equip equip, int dst) {\n         return true;\n     }\n     \n-    public ArrayList<Pair<Integer, String>> getItemDataByName(String name)\n-    {\n+    public ArrayList<Pair<Integer, String>> getItemDataByName(String name) {\n         ArrayList<Pair<Integer, String>> ret = new ArrayList<>();\n-         for (Pair<Integer, String> itemPair : MapleItemInformationProvider.getInstance().getAllItems()) {\n-                    if (itemPair.getRight().toLowerCase().contains(name.toLowerCase())) {\n-                            ret.add(itemPair);\n+        for (Pair<Integer, String> itemPair : MapleItemInformationProvider.getInstance().getAllItems()) {\n+            if (itemPair.getRight().toLowerCase().contains(name.toLowerCase())) {\n+                ret.add(itemPair);\n+            }\n+        }\n+        return ret;\n+    }\n+\n+    private MapleData getEquipLevelInfo(int itemId) {\n+        MapleData equipLevelData = equipLevelInfoCache.get(itemId);\n+        if (equipLevelData == null) {\n+            if (equipLevelInfoCache.containsKey(itemId)) return null;\n+            \n+            MapleData iData = getItemData(itemId);\n+            if (iData != null) {\n+                MapleData data = iData.getChildByPath(\"info/level\");\n+                if (data != null) {\n+                    equipLevelData = data.getChildByPath(\"info\");\n+                }\n+            }\n+            \n+            equipLevelInfoCache.put(itemId, equipLevelData);\n+        }\n+        \n+        return equipLevelData;\n+    }\n+    \n+    public int getEquipLevel(int itemId, boolean getMaxLevel) {\n+        Integer eqLevel = equipMaxLevelCache.get(itemId);\n+        if (eqLevel == null) {\n+            eqLevel = 1;    // greater than 1 means that it was supposed to levelup on GMS\n+            \n+            MapleData data = getEquipLevelInfo(itemId);\n+            if (data != null) {\n+                if (getMaxLevel) {\n+                    int curLevel = 1;\n+\n+                    while (true) {\n+                        MapleData data2 = data.getChildByPath(Integer.toString(curLevel));\n+                        if (data2 == null || data2.getChildren().size() <= 1) {\n+                            eqLevel = curLevel;\n+                            equipMaxLevelCache.put(itemId, eqLevel);\n+                            break;\n                         }\n+                        \n+                        curLevel++;\n+                    }\n+                } else {\n+                    MapleData data2 = data.getChildByPath(\"1\");\n+                    if (data2 != null && data2.getChildren().size() > 1) {\n+                        eqLevel = 2;\n                     }\n-         return ret;\n+                }\n+            }\n+        }\n+        \n+        return eqLevel;\n     }\n-\n+    \n     public List<Pair<String, Integer>> getItemLevelupStats(int itemId, int level) {\n         List<Pair<String, Integer>> list = new LinkedList<>();\n-        MapleData data = getItemData(itemId);\n-        MapleData data1 = data.getChildByPath(\"info\").getChildByPath(\"level\");\n-        \n-        if (data1 != null) {\n-            MapleData data2 = data1.getChildByPath(\"info\").getChildByPath(Integer.toString(level));\n+        MapleData data = getEquipLevelInfo(itemId);\n+        if (data != null) {\n+            MapleData data2 = data.getChildByPath(Integer.toString(level));\n             if (data2 != null) {\n                 for (MapleData da : data2.getChildren()) {\n                     if (Math.random() < 0.9) {"}, {"sha": "6f41d687260f7d08771257f7317f0d03ea170d98", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 13, "deletions": 9, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -30,7 +30,7 @@\n import java.util.List;\n import java.util.Map;\n \n-import net.server.world.MaplePartyCharacter;\n+import net.server.Server;\n import provider.MapleData;\n import provider.MapleDataTool;\n import server.life.MapleMonster;\n@@ -997,11 +997,15 @@ private Rectangle calculateBoundingBox(Point posFrom, boolean facingLeft) {\n         return bounds;\n     }\n     \n+    public int getBuffLocalDuration() {\n+        return !ServerConstants.USE_BUFF_EVERLASTING ? duration : Integer.MAX_VALUE;\n+    }\n+    \n     public void silentApplyBuff(MapleCharacter chr, long localStartTime) {\n-        int localDuration = duration;\n+        int localDuration = getBuffLocalDuration();\n         localDuration = alchemistModifyVal(chr, localDuration, false);\n         //CancelEffectAction cancelAction = new CancelEffectAction(chr, this, starttime);\n-        //ScheduledFuture<?> schedule = TimerManager.getInstance().schedule(cancelAction, ((starttime + localDuration) - System.currentTimeMillis()));\n+        //ScheduledFuture<?> schedule = TimerManager.getInstance().schedule(cancelAction, ((starttime + localDuration) - Server.getInstance().getCurrentTime()));\n         \n         chr.registerEffect(this, localStartTime, localStartTime + localDuration, true);\n         SummonMovementType summonMovementType = getSummonMovementType();\n@@ -1021,17 +1025,17 @@ public final void applyComboBuff(final MapleCharacter applyto, int combo) {\n         final List<Pair<MapleBuffStat, Integer>> stat = Collections.singletonList(new Pair<>(MapleBuffStat.ARAN_COMBO, combo));\n         applyto.announce(MaplePacketCreator.giveBuff(sourceid, 99999, stat));\n \n-        final long starttime = System.currentTimeMillis();\n+        final long starttime = Server.getInstance().getCurrentTime();\n //\tfinal CancelEffectAction cancelAction = new CancelEffectAction(applyto, this, starttime);\n-//\tfinal ScheduledFuture<?> schedule = TimerManager.getInstance().schedule(cancelAction, ((starttime + 99999) - System.currentTimeMillis()));\n+//\tfinal ScheduledFuture<?> schedule = TimerManager.getInstance().schedule(cancelAction, ((starttime + 99999) - Server.getInstance().getCurrentTime()));\n         applyto.registerEffect(this, starttime, Long.MAX_VALUE, false);\n     }\n     \n     public void updateBuffEffect(MapleCharacter target, List<Pair<MapleBuffStat, Integer>> activeStats, long starttime) {\n-        int localDuration = duration;\n+        int localDuration = getBuffLocalDuration();\n         localDuration = alchemistModifyVal(target, localDuration, false);\n         \n-        long leftDuration = (starttime + localDuration) - System.currentTimeMillis();\n+        long leftDuration = (starttime + localDuration) - Server.getInstance().getCurrentTime();\n         if(leftDuration > 0) {\n             target.announce(MaplePacketCreator.giveBuff((skill ? sourceid : -sourceid), (int)leftDuration, activeStats));\n         }\n@@ -1043,7 +1047,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n         }\n \n         List<Pair<MapleBuffStat, Integer>> localstatups = statups;\n-        int localDuration = duration;\n+        int localDuration = getBuffLocalDuration();\n         int localsourceid = sourceid;\n         int seconds = localDuration / 1000;\n         MapleMount givemount = null;\n@@ -1155,7 +1159,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n                 }\n             }\n             \n-            long starttime = System.currentTimeMillis();\n+            long starttime = Server.getInstance().getCurrentTime();\n             //CancelEffectAction cancelAction = new CancelEffectAction(applyto, this, starttime);\n             //ScheduledFuture<?> schedule = TimerManager.getInstance().schedule(cancelAction, localDuration);\n             applyto.registerEffect(this, starttime, starttime + localDuration, false);"}, {"sha": "42ee5fc3a30f8f10773787fb5e9c86abc69ef608", "filename": "src/server/life/MobSkill.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/life/MobSkill.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/life/MobSkill.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkill.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -32,7 +32,6 @@\n import constants.GameConstants;\n import java.util.LinkedList;\n import java.util.Map;\n-import server.TimerManager;\n import tools.Randomizer;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;"}, {"sha": "c005342cb43349976e53e216f80fe6d3e2467bec", "filename": "src/server/loot/MapleLootInventory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/loot/MapleLootInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/loot/MapleLootInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/loot/MapleLootInventory.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -48,9 +48,9 @@ public MapleLootInventory(MapleCharacter from) {\n         }\n     }\n     \n-    public boolean hasItem(int itemid, int quantity) {\n+    public int hasItem(int itemid, int quantity) {\n         Integer itemQty = items.get(itemid);\n-        return itemQty != null && itemQty >= quantity;\n+        return itemQty == null ? 0 : itemQty >= quantity ? 2 : itemQty > 0 ? 1 : 0;\n     }\n     \n }"}, {"sha": "f8686dedd819a6aabab6a9d680948de00ff460cf", "filename": "src/server/loot/MapleLootManager.java", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/loot/MapleLootManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/loot/MapleLootManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/loot/MapleLootManager.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -34,25 +34,30 @@\n  */\n public class MapleLootManager {\n     \n-    private static boolean needQuestItem(MonsterDropEntry dropEntry, MapleQuest quest, MapleCharacter chr, MapleLootInventory chrInv) {\n-        if (chr.getQuestStatus(dropEntry.questid) != 1) return false;\n-        return !chrInv.hasItem(dropEntry.itemId, quest.getItemAmountNeeded(dropEntry.itemId));\n-    }\n-    \n     private static boolean isRelevantDrop(MonsterDropEntry dropEntry, List<MapleCharacter> partyMembers, List<MapleLootInventory> partyInv) {\n         MapleQuest quest = MapleQuest.getInstance(dropEntry.questid);\n-        boolean restricted = MapleItemInformationProvider.getInstance().isDropRestricted(dropEntry.itemId);\n+        int qItemAmount = quest != null ? quest.getItemAmountNeeded(dropEntry.itemId) : 0;\n         \n+        boolean restricted = MapleItemInformationProvider.getInstance().isLootRestricted(dropEntry.itemId);\n         for (int i = 0; i < partyMembers.size(); i++) {\n             MapleLootInventory chrInv = partyInv.get(i);\n             \n-            if(restricted && chrInv.hasItem(dropEntry.itemId, 1)) {\n+            if (dropEntry.questid > 0) {\n+                if (partyMembers.get(i).getQuestStatus(dropEntry.questid) != 1) {\n+                    continue;\n+                }\n+                \n+                int qItemStatus = chrInv.hasItem(dropEntry.itemId, qItemAmount);\n+                if (qItemStatus == 2) {\n+                    continue;\n+                } else if (restricted && qItemStatus == 1) {\n+                    continue;\n+                }\n+            } else if (restricted && chrInv.hasItem(dropEntry.itemId, 1) > 0) {\n                 continue;\n             }\n             \n-            if(dropEntry.questid <= 0 || needQuestItem(dropEntry, quest, partyMembers.get(i), chrInv)) {\n-                return true;\n-            }\n+            return true;\n         }\n         \n         return false;"}, {"sha": "1626ba0d5fd5f31b5e6e20df7eab07377dd67804", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -242,7 +242,7 @@ public void buy(MapleClient c, int item, short quantity) {\n             if (c.getPlayer().getMeso() >= price) {\n                 if (canBuy(c, newItem)) {\n                     c.getPlayer().gainMeso(-price, false);\n-                    if(ServerConstants.USE_ANNOUNCE_SHOPITEMSOLD) announceItemSold(newItem, price);   // idea thanks to vcoc\n+                    if(ServerConstants.USE_ANNOUNCE_SHOPITEMSOLD) announceItemSold(newItem, price);   // idea thanks to Vcoc\n                     \n                     synchronized (sold) {\n                         sold.add(new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), newItem.getQuantity(), price));"}, {"sha": "e2225dff969bd760e3caf6fd1393ae4a8c1d99cd", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1144,11 +1144,11 @@ public int countPlayers() {\n         return character;\n     }\n     \n-    public List<MapleCharacter> getPlayersInRange(Rectangle box, List<MapleCharacter> chrList) {\n+    public List<MapleCharacter> getPlayersInRange(Rectangle box, List<MapleCharacter> targets) {\n         List<MapleCharacter> character = new LinkedList<>();\n         chrRLock.lock();\n         try {\n-            for (MapleCharacter chr : chrList) {\n+            for (MapleCharacter chr : targets) {\n                 if (characters.contains(chr)) {\n                     if (box.contains(chr.getPosition())) {\n                         character.add(chr);"}, {"sha": "6a99916b96f34902e106fe47025b155ea9d5418b", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -227,7 +227,7 @@ public boolean isSameDayRepeatable() {\n         if(!repeatable) return false;\n         \n         IntervalRequirement ir = (IntervalRequirement) startReqs.get(MapleQuestRequirementType.INTERVAL);\n-        return ir.getInterval() < ServerConstants.FAME_GAIN_MIN_HOUR_INTERVAL * 60 * 60 * 1000;\n+        return ir.getInterval() < ServerConstants.QUEST_POINT_REPEATABLE_INTERVAL * 60 * 60 * 1000;\n     }\n     \n     public boolean canStartWithoutRequirements(MapleCharacter c) {\n@@ -369,12 +369,11 @@ public short getId() {\n \n     public int getItemAmountNeeded(int itemid) {\n         MapleQuestRequirement req = completeReqs.get(MapleQuestRequirementType.ITEM);\n-\t\tif(req == null)\n-\t\t\treturn 0;\n-\t\t\n-\t\tItemRequirement ireq = (ItemRequirement) req;\n+        if(req == null)\n+                return 0;\n \t\t\n-\t\treturn ireq.getItemAmountNeeded(itemid);\n+        ItemRequirement ireq = (ItemRequirement) req;\n+        return ireq.getItemAmountNeeded(itemid);\n     }\n \n     public int getMobAmountNeeded(int mid) {"}, {"sha": "aee2b0429808b689c9bd872c410efd67d64a5486", "filename": "src/server/quest/actions/FameAction.java", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/quest/actions/FameAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/server/quest/actions/FameAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/FameAction.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -50,8 +50,6 @@ public void processData(MapleData data) {\n \t\n \t@Override\n \tpublic void run(MapleCharacter chr, Integer extSelection) {\n-\t\tchr.addFame(fame);\n-\t\tchr.updateSingleStat(MapleStat.FAME, chr.getFame());\n-\t\tchr.announce(MaplePacketCreator.getShowFameGain(fame));\n+\t\tchr.gainFame(fame);\n \t}\n } "}, {"sha": "428baf3115e06febc867111508623988810846ce", "filename": "src/tools/HexTool.java", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/tools/HexTool.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/tools/HexTool.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/HexTool.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -40,6 +40,14 @@ public static String toString(byte[] bytes) {\n         }\n         return hexed.substring(0, hexed.length() - 1);\n     }\n+    \n+    public static String toCompressedString(byte[] bytes) {\n+        StringBuilder hexed = new StringBuilder();\n+        for (int i = 0; i < bytes.length; i++) {\n+            hexed.append(toString(bytes[i]));\n+        }\n+        return hexed.substring(0, hexed.length());\n+    }\n \n     public static byte[] getByteArrayFromHexString(String hex) {\n         ByteArrayOutputStream baos = new ByteArrayOutputStream();"}, {"sha": "901737f51e51b9f15dcc0e667dbdad3258838cdb", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 38, "deletions": 44, "changes": 82, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -758,6 +758,8 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n          *\n          * @param serverId\n          * @param serverName The name of the server.\n+         * @param flag\n+         * @param eventmsg\n          * @param channelLoad Load of the channel - 1200 seems to be max.\n          * @return The server info packet.\n          */\n@@ -777,8 +779,11 @@ private static void addMonsterBookInfo(final MaplePacketLittleEndianWriter mplew\n                 for (Channel ch : channelLoad) {\n                         mplew.writeMapleAsciiString(serverName + \"-\" + ch.getId());\n                         mplew.writeInt(ch.getChannelCapacity());\n-                        mplew.write(1);\n-                        mplew.writeShort(ch.getId() - 1);\n+                        \n+                        // thanks GabrielSin for this channel packet structure part\n+                        mplew.write(1);// nWorldID\n+                        mplew.write(ch.getId() - 1);// nChannelID\n+                        mplew.writeBool(false);// bAdultChannel\n                 }\n                 mplew.writeShort(0);\n                 return mplew.getPacket();\n@@ -1042,8 +1047,8 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.write(spawnPoint);\n                 mplew.writeShort(chr.getHp());\n                 mplew.writeBool(false);\n-                mplew.writeLong(getTime(System.currentTimeMillis()));\n-                mplew.writeShort(0);\n+                mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n+                mplew.writeInt(0);\n                 return mplew.getPacket();\n         }\n         \n@@ -1059,8 +1064,8 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.writeBool(true);\n                 mplew.writeInt(spawnPosition.x);    // spawn position placement thanks to Arnah (Vertisy)\n                 mplew.writeInt(spawnPosition.y);\n-                mplew.writeLong(getTime(System.currentTimeMillis()));\n-                mplew.writeShort(0);\n+                mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n+                mplew.writeInt(0);\n                 return mplew.getPacket();\n         }\n         \n@@ -2461,27 +2466,27 @@ private static int doubleToShortBits(double d) {\n                         mplew.write(mod.getInventoryType());\n                         mplew.writeShort(mod.getMode() == 2 ? mod.getOldPosition() : mod.getPosition());\n                         switch (mod.getMode()) {\n-                        case 0: {//add item\n-                                addItemInfo(mplew, mod.getItem(), true);\n-                                break;\n-                        }\n-                        case 1: {//update quantity\n-                                mplew.writeShort(mod.getQuantity());\n-                                break;\n-                        }\n-                        case 2: {//move                  \n-                                mplew.writeShort(mod.getPosition());\n-                                if (mod.getPosition() < 0 || mod.getOldPosition() < 0) {\n-                                        addMovement = mod.getOldPosition() < 0 ? 1 : 2;\n+                                case 0: {//add item\n+                                        addItemInfo(mplew, mod.getItem(), true);\n+                                        break;\n                                 }\n-                                break;\n-                        }\n-                        case 3: {//remove\n-                                if (mod.getPosition() < 0) {\n-                                        addMovement = 2;\n+                                case 1: {//update quantity\n+                                        mplew.writeShort(mod.getQuantity());\n+                                        break;\n+                                }\n+                                case 2: {//move                  \n+                                        mplew.writeShort(mod.getPosition());\n+                                        if (mod.getPosition() < 0 || mod.getOldPosition() < 0) {\n+                                                addMovement = mod.getOldPosition() < 0 ? 1 : 2;\n+                                        }\n+                                        break;\n+                                }\n+                                case 3: {//remove\n+                                        if (mod.getPosition() < 0) {\n+                                                addMovement = 2;\n+                                        }\n+                                        break;\n                                 }\n-                                break;\n-                        }\n                         }\n                         mod.clear();\n                 }\n@@ -7527,27 +7532,16 @@ public static void addCashItemInformation(final MaplePacketLittleEndianWriter mp\n                         }\n                         mplew.skip(121);\n \n+                        List<List<Integer>> mostSellers = c.getWorldServer().getMostSellerCashItems();\n                         for (int i = 1; i <= 8; i++) {\n+                                List<Integer> mostSellersTab = mostSellers.get(i);\n+                                \n                                 for (int j = 0; j < 2; j++) {\n-                                        mplew.writeInt(i);\n-                                        mplew.writeInt(j);\n-                                        mplew.writeInt(50200004);\n-\n-                                        mplew.writeInt(i);\n-                                        mplew.writeInt(j);\n-                                        mplew.writeInt(50200069);\n-\n-                                        mplew.writeInt(i);\n-                                        mplew.writeInt(j);\n-                                        mplew.writeInt(50200117);\n-\n-                                        mplew.writeInt(i);\n-                                        mplew.writeInt(j);\n-                                        mplew.writeInt(50100008);\n-\n-                                        mplew.writeInt(i);\n-                                        mplew.writeInt(j);\n-                                        mplew.writeInt(50000047);\n+                                        for (Integer snid : mostSellersTab) {\n+                                                mplew.writeInt(i);\n+                                                mplew.writeInt(j);\n+                                                mplew.writeInt(snid);\n+                                        }\n                                 }\n                         }\n "}, {"sha": "9f802c7cc7109f363487b38155b3558aa2b8d0a2", "filename": "tools/MapleInvalidItemIdFetcher/src/maplenoitemidfetcher/MapleNoItemIdFetcher.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemIdFetcher/src/maplenoitemidfetcher/MapleNoItemIdFetcher.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemIdFetcher/src/maplenoitemidfetcher/MapleNoItemIdFetcher.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleInvalidItemIdFetcher/src/maplenoitemidfetcher/MapleNoItemIdFetcher.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -43,7 +43,7 @@\n  * \n  * This application finds inexistent itemids within the drop data from\n  * the Maplestory database specified by the URL below. This program\n- * assumes all itemids haves at most 7 digits.\n+ * assumes all itemids uses 7 digits.\n  * \n  * A file is generated listing all the inexistent ids.\n  */"}, {"sha": "22ac1635ba312f5c0bca5b3119702c2945df68b1", "filename": "tools/MapleInvalidItemWithNoNameFetcher/nbbuild.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemWithNoNameFetcher/nbbuild.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemWithNoNameFetcher/nbbuild.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleInvalidItemWithNoNameFetcher/nbbuild.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleInvalidItemWithNoNameFetcher\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleInvalidItemWithNoNameFetcher.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleInvalidItemWithNoNameFetcher-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "5d1bb4528e25be23cafc0a78d9dc0a55963f7272", "filename": "tools/MapleInvalidItemWithNoNameFetcher/src/maplenoitemnamefetcher/MapleNoItemNameFetcher.java", "status": "modified", "additions": 45, "deletions": 10, "changes": 55, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemWithNoNameFetcher/src/maplenoitemnamefetcher/MapleNoItemNameFetcher.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleInvalidItemWithNoNameFetcher/src/maplenoitemnamefetcher/MapleNoItemNameFetcher.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleInvalidItemWithNoNameFetcher/src/maplenoitemnamefetcher/MapleNoItemNameFetcher.java?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -36,16 +36,16 @@\n import provider.MapleDataFileEntry;\n import provider.MapleDataProvider;\n import provider.MapleDataProviderFactory;\n+import provider.MapleDataTool;\n \n /**\n  *\n  * @author RonanLana\n  * \n- * This application finds inexistent itemids within the drop data from\n- * the Maplestory database specified by the URL below. This program\n- * assumes all itemids have at most 7 digits.\n- * \n- * A file is generated listing all the inexistent ids.\n+ * This application finds itemids with inexistent name and description from\n+ * within the server-side XMLs, then identify them on a report file along\n+ * with a XML excerpt to be appended on the String.wz xml nodes. This program\n+ * assumes all equipids are depicted using 8 digits and item using 7 digits.\n  * \n  * Estimated parse time: 2 minutes\n  */\n@@ -65,6 +65,9 @@\n     static Map<Integer, ItemType> itemsWithNoNameProperty = new HashMap<>();\n     static Set<Integer> equipsWithNoCashProperty = new HashSet<>();\n \n+    static Map<Integer, String> nameContentCache = new HashMap<>();\n+    static Map<Integer, String> descContentCache = new HashMap<>();\n+    \n     static ItemType curType = ItemType.UNDEF;\n     \n     private enum ItemType {\n@@ -78,11 +81,20 @@\n     private static void processStringSubdirectoryData(MapleData subdirData, String subdirPath) {\n         for(MapleData md : subdirData.getChildren()) {\n             try {\n-                if(md.getChildByPath(\"name\") != null) {\n-                    int itemId = Integer.parseInt(md.getName());\n+                MapleData nameData = md.getChildByPath(\"name\");\n+                MapleData descData = md.getChildByPath(\"desc\");\n+                \n+                int itemId = Integer.parseInt(md.getName());\n+                if (nameData != null && descData != null) {\n                     itemsWithNoNameProperty.remove(itemId);\n                 } else {\n-                    System.out.println(\"Found itemid on String.wz with no name property: \" + subdirPath + subdirData.getName() + \"/\" + md.getName());\n+                    if (nameData != null) {\n+                        nameContentCache.put(itemId, MapleDataTool.getString(\"name\", md));\n+                    } else if (descData != null) {\n+                        descContentCache.put(itemId, MapleDataTool.getString(\"desc\", md));\n+                    }\n+                    \n+                    System.out.println(\"Found itemid on String.wz with no full property: \" + subdirPath + subdirData.getName() + \"/\" + md.getName());\n                 }\n             } catch (NumberFormatException nfe) {\n                 System.out.println(\"Error reading string image: \" + subdirPath + subdirData.getName() + \"/\" + md.getName());\n@@ -422,10 +434,33 @@ private static void printOutputFileHeader() {\n         printWriter.println();\n     }\n     \n+    private static String getMissingEquipName(int itemid) {\n+        String s = nameContentCache.get(itemid);\n+        if (s == null) {\n+            s = \"MISSING NAME \" + itemid;\n+        }\n+        \n+        return s;\n+    }\n+    \n+    private static String getMissingEquipDesc(int itemid) {\n+        String s = descContentCache.get(itemid);\n+        if (s == null) {\n+            s = \"MISSING INFO \" + itemid;\n+        }\n+        \n+        return s;\n+    }\n+    \n     private static void writeMissingEquipInfo(Integer itemid) {\n         printWriter.println(\"      <imgdir name=\\\"\" + itemid + \"\\\">\");\n-        printWriter.println(\"        <string name=\\\"name\\\" value=\\\"MISSING NAME\\\"/>\");\n-        printWriter.println(\"        <string name=\\\"desc\\\" value=\\\"MISSING INFO\\\"/>\");\n+        \n+        String s;\n+        s = getMissingEquipName(itemid);\n+        printWriter.println(\"        <string name=\\\"name\\\" value=\\\"\" + s + \"\\\"/>\");\n+        \n+        s = getMissingEquipDesc(itemid);\n+        printWriter.println(\"        <string name=\\\"desc\\\" value=\\\"\" + s + \"\\\"/>\");\n         printWriter.println(\"      </imgdir>\");\n     }\n     "}, {"sha": "c18acb607bb147d73b2e99d1bd55bf66adf01ac0", "filename": "tools/MapleQuestlineFetcher/nbbuild.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleQuestlineFetcher/nbbuild.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleQuestlineFetcher/nbbuild.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleQuestlineFetcher/nbbuild.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleQuestlineFetcher\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleQuestlineFetcher.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleQuestlineFetcher-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "24bf91c3908ca0cb4d132e52c92b4f37661f4b17", "filename": "tools/MapleReactorDropFetcher/nbbuild.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleReactorDropFetcher/nbbuild.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/tools/MapleReactorDropFetcher/nbbuild.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleReactorDropFetcher/nbbuild.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleReactorDropFetcher\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleReactorDropFetcher.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleReactorDropFetcher-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "e32002a88048868b77096f1e10e1a3f7a0cbdce2", "filename": "wz/Map.wz/Map/Map6/682000000.img.xml", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map6/682000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map6/682000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map6/682000000.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -2389,23 +2389,23 @@\n       <int name=\"delay\" value=\"0\"/>\n     </imgdir>\n     <imgdir name=\"8\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"6\"/>\n       <int name=\"x\" value=\"403\"/>\n       <int name=\"y\" value=\"235\"/>\n       <int name=\"tm\" value=\"999999999\"/>\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"9\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"6\"/>\n       <int name=\"x\" value=\"316\"/>\n       <int name=\"y\" value=\"234\"/>\n       <int name=\"tm\" value=\"999999999\"/>\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"10\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"6\"/>\n       <int name=\"x\" value=\"487\"/>\n       <int name=\"y\" value=\"234\"/>"}, {"sha": "68246e6b7887e0812dcd009c3ebcb1af500a6b7c", "filename": "wz/Map.wz/Map/Map8/801000100.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801000100.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801000100.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/801000100.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -315,7 +315,7 @@\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"-313\"/>\n       <int name=\"y\" value=\"179\"/>"}, {"sha": "61d99cc2c176423e32a1163d41a75484f2e4399d", "filename": "wz/Map.wz/Map/Map8/801000200.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801000200.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801000200.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/801000200.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -315,7 +315,7 @@\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"-313\"/>\n       <int name=\"y\" value=\"179\"/>"}, {"sha": "b66441c2ae358eae483b58d52a011589fcdc0387", "filename": "wz/Map.wz/Map/Map8/801010000.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801010000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801010000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/801010000.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -5116,15 +5116,15 @@\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"607\"/>\n       <int name=\"y\" value=\"-130\"/>\n       <int name=\"tm\" value=\"999999999\"/>\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"2\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"-148\"/>\n       <int name=\"y\" value=\"-62\"/>"}, {"sha": "5722feabea7c754ae4ee55b46720f8a220589ff3", "filename": "wz/Map.wz/Map/Map8/801030000.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801030000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/Map/Map8/801030000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map8/801030000.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -7555,7 +7555,7 @@\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <string name=\"pn\" value=\"tp\"/>\n+      <string name=\"pn\" value=\"np\"/>\n       <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"1675\"/>\n       <int name=\"y\" value=\"77\"/>"}, {"sha": "76e492d837ae206a42c041e8953cc732d33a43be", "filename": "wz/Map.wz/WorldMap/WorldMap.img.xml", "status": "modified", "additions": 179, "deletions": 1, "changes": 180, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -64,6 +64,36 @@\n         <int name=\"19\" value=\"104040002\"/>\n         <int name=\"20\" value=\"106010000\"/>\n         <int name=\"21\" value=\"106010100\"/>\n+        <int name=\"33\" value=\"106020600\"/>\n+        <int name=\"31\" value=\"106020500\"/>\n+        <int name=\"30\" value=\"106020403\"/>\n+        <int name=\"29\" value=\"106020402\"/>\n+        <int name=\"28\" value=\"106020401\"/>\n+        <int name=\"27\" value=\"106020400\"/>\n+        <int name=\"26\" value=\"106020300\"/>\n+        <int name=\"25\" value=\"106020200\"/>\n+        <int name=\"24\" value=\"106020100\"/>\n+        <int name=\"23\" value=\"106020000\"/>\n+        <int name=\"32\" value=\"106020501\"/>\n+        <int name=\"40\" value=\"106021100\"/>\n+        <int name=\"51\" value=\"106021700\"/>\n+        <int name=\"49\" value=\"106021600\"/>\n+        <int name=\"48\" value=\"106021501\"/>\n+        <int name=\"47\" value=\"106021500\"/>\n+        <int name=\"46\" value=\"106021402\"/>\n+        <int name=\"41\" value=\"106021200\"/>\n+        <int name=\"38\" value=\"106021000\"/>\n+        <int name=\"37\" value=\"106020900\"/>\n+        <int name=\"36\" value=\"106020800\"/>\n+        <int name=\"35\" value=\"106020700\"/>\n+        <int name=\"34\" value=\"106020601\"/>\n+        <int name=\"39\" value=\"106021001\"/>\n+        <int name=\"45\" value=\"106021401\"/>\n+        <int name=\"44\" value=\"106021400\"/>\n+        <int name=\"43\" value=\"106021300\"/>\n+        <int name=\"42\" value=\"106021201\"/>\n+        <int name=\"50\" value=\"106021601\"/>\n+        <int name=\"22\" value=\"106021800\"/>\n       </imgdir>\n       <vector name=\"spot\" x=\"-230\" y=\"-67\"/>\n     </imgdir>\n@@ -202,6 +232,10 @@\n         <int name=\"43\" value=\"103040400\"/>\n       </imgdir>\n       <vector name=\"spot\" x=\"-273\" y=\"-99\"/>\n+      <canvas name=\"path\" width=\"287\" height=\"116\">\n+        <vector name=\"origin\" x=\"284\" y=\"204\"/>\n+        <int name=\"z\" value=\"2\"/>\n+      </canvas>\n     </imgdir>\n     <imgdir name=\"5\">\n       <int name=\"type\" value=\"3\"/>\n@@ -527,9 +561,26 @@\n         <int name=\"86\" value=\"221024500\"/>\n         <int name=\"87\" value=\"222020200\"/>\n         <int name=\"88\" value=\"222020300\"/>\n+        <int name=\"89\" value=\"300000000\"/>\n+        <int name=\"90\" value=\"300000010\"/>\n+        <int name=\"99\" value=\"300010300\"/>\n+        <int name=\"100\" value=\"300010400\"/>\n+        <int name=\"101\" value=\"300020000\"/>\n+        <int name=\"102\" value=\"300020100\"/>\n+        <int name=\"103\" value=\"300020200\"/>\n+        <int name=\"104\" value=\"300030000\"/>\n+        <int name=\"105\" value=\"300030100\"/>\n+        <int name=\"91\" value=\"300000011\"/>\n+        <int name=\"92\" value=\"300000012\"/>\n+        <int name=\"93\" value=\"300000001\"/>\n+        <int name=\"94\" value=\"300000002\"/>\n+        <int name=\"95\" value=\"300000100\"/>\n+        <int name=\"96\" value=\"300010000\"/>\n+        <int name=\"97\" value=\"300010100\"/>\n+        <int name=\"98\" value=\"300010200\"/>\n       </imgdir>\n       <canvas name=\"path\" width=\"59\" height=\"119\">\n-        <vector name=\"origin\" x=\"61\" y=\"103\"/>\n+        <vector name=\"origin\" x=\"-282\" y=\"-199\"/>\n         <int name=\"z\" value=\"2\"/>\n       </canvas>\n     </imgdir>\n@@ -918,6 +969,19 @@\n         <int name=\"z\" value=\"2\"/>\n       </canvas>\n     </imgdir>\n+    <imgdir name=\"23\">\n+      <vector name=\"spot\" x=\"-183\" y=\"-95\"/>\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"680000000\"/>\n+        <int name=\"1\" value=\"670000200\"/>\n+        <int name=\"2\" value=\"670010000\"/>\n+        <int name=\"3\" value=\"670000100\"/>\n+        <int name=\"4\" value=\"680000001\"/>\n+        <int name=\"5\" value=\"680000002\"/>\n+        <int name=\"6\" value=\"680000003\"/>\n+      </imgdir>\n+    </imgdir>\n     <imgdir name=\"22\">\n       <vector name=\"spot\" x=\"-266\" y=\"10\"/>\n       <int name=\"type\" value=\"3\"/>\n@@ -948,6 +1012,110 @@\n         <int name=\"z\" value=\"2\"/>\n       </canvas>\n     </imgdir>\n+    <imgdir name=\"24\">\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540000000\"/>\n+        <int name=\"1\" value=\"540000100\"/>\n+        <int name=\"2\" value=\"540000200\"/>\n+        <int name=\"3\" value=\"540000300\"/>\n+        <int name=\"4\" value=\"540010000\"/>\n+        <int name=\"5\" value=\"540020000\"/>\n+        <int name=\"6\" value=\"540020100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-8\" y=\"-152\"/>\n+      <canvas name=\"path\" width=\"287\" height=\"116\">\n+        <vector name=\"origin\" x=\"284\" y=\"204\"/>\n+        <int name=\"z\" value=\"2\"/>\n+      </canvas>\n+    </imgdir>\n+    <imgdir name=\"25\">\n+      <vector name=\"spot\" x=\"3\" y=\"-148\"/>\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541000000\"/>\n+        <int name=\"1\" value=\"541000100\"/>\n+        <int name=\"2\" value=\"541000200\"/>\n+        <int name=\"12\" value=\"541010110\"/>\n+        <int name=\"11\" value=\"541010100\"/>\n+        <int name=\"10\" value=\"541010060\"/>\n+        <int name=\"9\" value=\"541010050\"/>\n+        <int name=\"8\" value=\"541010040\"/>\n+        <int name=\"7\" value=\"541010030\"/>\n+        <int name=\"6\" value=\"541010020\"/>\n+        <int name=\"5\" value=\"541010010\"/>\n+        <int name=\"4\" value=\"541010000\"/>\n+        <int name=\"3\" value=\"541000300\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"26\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000000\"/>\n+        <int name=\"1\" value=\"550000100\"/>\n+        <int name=\"2\" value=\"550000200\"/>\n+        <int name=\"3\" value=\"550000300\"/>\n+        <int name=\"4\" value=\"550000400\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-30\" y=\"-162\"/>\n+      <int name=\"type\" value=\"3\"/>\n+    </imgdir>\n+    <imgdir name=\"27\">\n+      <vector name=\"spot\" x=\"-16\" y=\"-159\"/>\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551000000\"/>\n+        <int name=\"1\" value=\"551000100\"/>\n+        <int name=\"2\" value=\"551000200\"/>\n+        <int name=\"3\" value=\"551010000\"/>\n+        <int name=\"4\" value=\"551020000\"/>\n+        <int name=\"5\" value=\"551030000\"/>\n+        <int name=\"6\" value=\"551030100\"/>\n+        <int name=\"7\" value=\"551030200\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"28\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800000000\"/>\n+        <int name=\"1\" value=\"800010000\"/>\n+        <int name=\"2\" value=\"800010001\"/>\n+        <int name=\"3\" value=\"800010100\"/>\n+        <int name=\"4\" value=\"800020000\"/>\n+        <int name=\"5\" value=\"800020100\"/>\n+        <int name=\"6\" value=\"800020101\"/>\n+        <int name=\"7\" value=\"800020110\"/>\n+        <int name=\"8\" value=\"800020120\"/>\n+        <int name=\"9\" value=\"800020130\"/>\n+        <int name=\"10\" value=\"800020200\"/>\n+        <int name=\"11\" value=\"800020300\"/>\n+        <int name=\"12\" value=\"800030000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"5\" y=\"-170\"/>\n+      <int name=\"type\" value=\"3\"/>\n+    </imgdir>\n+    <imgdir name=\"29\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801000000\"/>\n+        <int name=\"1\" value=\"801000001\"/>\n+        <int name=\"2\" value=\"801000002\"/>\n+        <int name=\"3\" value=\"801000100\"/>\n+        <int name=\"4\" value=\"801000110\"/>\n+        <int name=\"5\" value=\"801000200\"/>\n+        <int name=\"6\" value=\"801000210\"/>\n+        <int name=\"7\" value=\"801000300\"/>\n+        <int name=\"8\" value=\"801010000\"/>\n+        <int name=\"9\" value=\"801020000\"/>\n+        <int name=\"10\" value=\"801030000\"/>\n+        <int name=\"11\" value=\"801040000\"/>\n+        <int name=\"12\" value=\"801040001\"/>\n+        <int name=\"13\" value=\"801040002\"/>\n+        <int name=\"14\" value=\"801040003\"/>\n+        <int name=\"15\" value=\"801040004\"/>\n+        <int name=\"16\" value=\"801040100\"/>\n+        <int name=\"17\" value=\"801040101\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"20\" y=\"-175\"/>\n+      <int name=\"type\" value=\"3\"/>\n+    </imgdir>\n   </imgdir>\n   <imgdir name=\"MapLink\">\n     <imgdir name=\"0\">\n@@ -1061,5 +1229,15 @@\n         </canvas>\n       </imgdir>\n     </imgdir>\n+    <imgdir name=\"11\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap140\"/>\n+        <canvas name=\"linkImg\" width=\"77\" height=\"48\">\n+          <int name=\"z\" value=\"1\"/>\n+          <vector name=\"origin\" x=\"42\" y=\"185\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"WorldTour\"/>\n+    </imgdir>\n   </imgdir>\n </imgdir>"}, {"sha": "deac0a7bffccab71b6944c69422825abe3038a03", "filename": "wz/Map.wz/WorldMap/WorldMap010.img.xml", "status": "modified", "additions": 125, "deletions": 9, "changes": 134, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap010.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap010.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap010.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -51,15 +51,6 @@\n         <int name=\"5\" value=\"103000005\"/>\n         <int name=\"6\" value=\"103000006\"/>\n         <int name=\"7\" value=\"193000000\"/>\n-        <int name=\"8\" value=\"103000100\"/>\n-        <int name=\"9\" value=\"103000101\"/>\n-        <int name=\"10\" value=\"103000102\"/>\n-        <int name=\"11\" value=\"103000103\"/>\n-        <int name=\"12\" value=\"103000104\"/>\n-        <int name=\"13\" value=\"103000105\"/>\n-        <int name=\"14\" value=\"103000200\"/>\n-        <int name=\"15\" value=\"103000201\"/>\n-        <int name=\"16\" value=\"103000202\"/>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"4\">\n@@ -810,6 +801,121 @@\n         <int name=\"13\" value=\"103040400\"/>\n       </imgdir>\n     </imgdir>\n+    <imgdir name=\"99\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-266\" y=\"-77\"/>\n+    </imgdir>\n+    <imgdir name=\"98\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000105\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-277\" y=\"-95\"/>\n+    </imgdir>\n+    <imgdir name=\"97\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000104\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-272\" y=\"-91\"/>\n+    </imgdir>\n+    <imgdir name=\"96\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000103\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-268\" y=\"-87\"/>\n+    </imgdir>\n+    <imgdir name=\"95\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000102\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-264\" y=\"-82\"/>\n+    </imgdir>\n+    <imgdir name=\"94\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000101\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-258\" y=\"-78\"/>\n+    </imgdir>\n+    <imgdir name=\"93\">\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-250\" y=\"-72\"/>\n+    </imgdir>\n+    <imgdir name=\"100\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000201\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-273\" y=\"-75\"/>\n+    </imgdir>\n+    <imgdir name=\"101\">\n+      <vector name=\"spot\" x=\"-283\" y=\"-76\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"103000202\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"102\">\n+      <vector name=\"spot\" x=\"228\" y=\"-15\"/>\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"680000000\"/>\n+        <int name=\"1\" value=\"680000001\"/>\n+        <int name=\"2\" value=\"680000002\"/>\n+        <int name=\"3\" value=\"680000003\"/>\n+        <int name=\"4\" value=\"680000100\"/>\n+        <int name=\"5\" value=\"680000110\"/>\n+        <int name=\"6\" value=\"680000200\"/>\n+        <int name=\"7\" value=\"680000210\"/>\n+        <int name=\"8\" value=\"680000300\"/>\n+        <int name=\"9\" value=\"680000400\"/>\n+        <int name=\"10\" value=\"680000401\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"103\">\n+      <vector name=\"spot\" x=\"245\" y=\"-12\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"680010000\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"104\">\n+      <vector name=\"spot\" x=\"260\" y=\"-25\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"680010100\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"105\">\n+      <vector name=\"spot\" x=\"265\" y=\"-44\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"670000100\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"106\">\n+      <vector name=\"spot\" x=\"273\" y=\"-56\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"670000200\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"107\">\n+      <vector name=\"spot\" x=\"284\" y=\"-62\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"670010000\"/>\n+      </imgdir>\n+    </imgdir>\n   </imgdir>\n   <imgdir name=\"MapLink\">\n     <imgdir name=\"0\">\n@@ -842,5 +948,15 @@\n       </imgdir>\n       <string name=\"toolTip\" value=\"Kerning Square\"/>\n     </imgdir>\n+    <imgdir name=\"3\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap014\"/>\n+        <canvas name=\"linkImg\" width=\"110\" height=\"86\">\n+          <vector name=\"origin\" x=\"202\" y=\"-113\"/>\n+          <int name=\"z\" value=\"1\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Mushroom Castle\"/>\n+    </imgdir>\n   </imgdir>\n </imgdir>"}, {"sha": "b7c69b34bea401f0cb79f513c697d66001320ea5", "filename": "wz/Map.wz/WorldMap/WorldMap014.img.xml", "status": "added", "additions": 163, "deletions": 0, "changes": 163, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap014.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap014.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap014.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,163 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap014.img\">\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap010\"/>\n+  </imgdir>\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"642\" height=\"472\">\n+      <vector name=\"origin\" x=\"321\" y=\"236\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"0\">\n+      <vector name=\"spot\" x=\"-264\" y=\"160\"/>\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020000\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <vector name=\"spot\" x=\"-226\" y=\"140\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020100\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <vector name=\"spot\" x=\"-208\" y=\"121\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020200\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <vector name=\"spot\" x=\"-190\" y=\"97\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020300\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <vector name=\"spot\" x=\"-156\" y=\"90\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020400\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <vector name=\"spot\" x=\"-149\" y=\"60\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020500\"/>\n+        <int name=\"1\" value=\"106020501\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <vector name=\"spot\" x=\"-139\" y=\"116\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020401\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <vector name=\"spot\" x=\"-118\" y=\"140\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020402\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <vector name=\"spot\" x=\"-84\" y=\"158\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020403\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <vector name=\"spot\" x=\"-129\" y=\"-34\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020600\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <vector name=\"spot\" x=\"-100\" y=\"-24\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020700\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"11\">\n+      <vector name=\"spot\" x=\"-82\" y=\"-37\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106020800\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"12\">\n+      <vector name=\"spot\" x=\"-71\" y=\"-12\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021000\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"13\">\n+      <vector name=\"spot\" x=\"-40\" y=\"0\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021100\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"14\">\n+      <vector name=\"spot\" x=\"-4\" y=\"15\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021200\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"15\">\n+      <vector name=\"spot\" x=\"29\" y=\"28\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021300\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"16\">\n+      <vector name=\"spot\" x=\"88\" y=\"30\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021400\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"17\">\n+      <vector name=\"spot\" x=\"135\" y=\"-15\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021401\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"18\">\n+      <vector name=\"spot\" x=\"131\" y=\"-56\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021402\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"19\">\n+      <vector name=\"spot\" x=\"194\" y=\"-97\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021600\"/>\n+        <int name=\"1\" value=\"106021700\"/>\n+      </imgdir>\n+    </imgdir>\n+    <imgdir name=\"20\">\n+      <vector name=\"spot\" x=\"261\" y=\"-32\"/>\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"106021800\"/>\n+      </imgdir>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "61c82e499133f7ad2875b791ff2b4e2d703c3e4c", "filename": "wz/Map.wz/WorldMap/WorldMap030.img.xml", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap030.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap030.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap030.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -602,6 +602,29 @@\n         <int name=\"2\" value=\"220000111\"/>\n       </imgdir>\n     </imgdir>\n+    <imgdir name=\"72\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300000000\"/>\n+        <int name=\"1\" value=\"300000010\"/>\n+        <int name=\"2\" value=\"300000011\"/>\n+        <int name=\"3\" value=\"300000012\"/>\n+        <int name=\"4\" value=\"300000001\"/>\n+        <int name=\"5\" value=\"300000002\"/>\n+        <int name=\"6\" value=\"300000100\"/>\n+        <int name=\"7\" value=\"300010000\"/>\n+        <int name=\"8\" value=\"300010100\"/>\n+        <int name=\"9\" value=\"300010200\"/>\n+        <int name=\"10\" value=\"300010300\"/>\n+        <int name=\"11\" value=\"300010400\"/>\n+        <int name=\"12\" value=\"300020000\"/>\n+        <int name=\"13\" value=\"300020100\"/>\n+        <int name=\"14\" value=\"300020200\"/>\n+        <int name=\"15\" value=\"300030000\"/>\n+        <int name=\"16\" value=\"300030100\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"2\"/>\n+      <vector name=\"spot\" x=\"271\" y=\"-155\"/>\n+    </imgdir>\n   </imgdir>\n   <imgdir name=\"MapLink\">\n     <imgdir name=\"0\">\n@@ -614,5 +637,15 @@\n       </imgdir>\n       <string name=\"toolTip\" value=\"Lowest Floor of Clocktower\"/>\n     </imgdir>\n+    <imgdir name=\"1\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap032\"/>\n+        <canvas name=\"linkImg\" width=\"166\" height=\"123\">\n+          <vector name=\"origin\" x=\"-155\" y=\"234\"/>\n+          <int name=\"z\" value=\"1\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Ellin Forest\"/>\n+    </imgdir>\n   </imgdir>\n </imgdir>"}, {"sha": "dd6ad0834a48154a748d12e7005a0202472fdc58", "filename": "wz/Map.wz/WorldMap/WorldMap031.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap031.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap031.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap031.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1,7 +1,7 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n <imgdir name=\"WorldMap031.img\">\n   <imgdir name=\"info\">\n-    <string name=\"parentMap\" value=\"WorldMap30\"/>\n+    <string name=\"parentMap\" value=\"WorldMap030\"/>\n   </imgdir>\n   <imgdir name=\"BaseImg\">\n     <canvas name=\"0\" width=\"640\" height=\"470\">"}, {"sha": "fc8ec1abc4b02f6632214c7dee93a5171eea2016", "filename": "wz/Map.wz/WorldMap/WorldMap032.img.xml", "status": "added", "additions": 103, "deletions": 0, "changes": 103, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap032.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap032.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap032.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,103 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap032.img\">\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"640\" height=\"470\">\n+      <vector name=\"origin\" x=\"320\" y=\"235\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap030\"/>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"0\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300000000\"/>\n+        <int name=\"1\" value=\"300000001\"/>\n+        <int name=\"2\" value=\"300000002\"/>\n+        <int name=\"3\" value=\"300000010\"/>\n+        <int name=\"4\" value=\"300000011\"/>\n+        <int name=\"5\" value=\"300000012\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-28\" y=\"19\"/>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300000100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"119\" y=\"-88\"/>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300010000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-143\" y=\"-43\"/>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300010100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-136\" y=\"11\"/>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300010200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-95\" y=\"52\"/>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300010300\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-123\" y=\"96\"/>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300010400\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-191\" y=\"80\"/>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300020000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-55\" y=\"123\"/>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300020100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"8\" y=\"158\"/>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300020200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"15\" y=\"208\"/>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300030000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"143\" y=\"10\"/>\n+    </imgdir>\n+    <imgdir name=\"11\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"300030100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"236\" y=\"-71\"/>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "820911b1c10e8c6b169d56d342d377f8df1d5065", "filename": "wz/Map.wz/WorldMap/WorldMap140.img.xml", "status": "modified", "additions": 111, "deletions": 28, "changes": 139, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap140.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap140.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap140.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -2,6 +2,9 @@\n <imgdir name=\"WorldMap140.img\">\n   <imgdir name=\"info\">\n     <string name=\"parentMap\" value=\"WorldMap\"/>\n+    <string name=\"disclaimer\" value=\"HeavenMS rev227:\n+\n+Added world maps for Mushroom Castle, Zipangu, CBD/Malaysia and Ellin Forest regions. Original artwork content used on files depicted in this topic are rightful property of Nexon Corps., these files thoroughly trying to adhere the &quot;Fair Use&quot; disclaimer policy, their purpose being solely to fulfill gaming experience for the areas that were already present on v83 GMS but still lacked worldmaps. For more info regarding Fair Use, please refer to http://www.dmlp.org/legal-guide/fair-use.\"/>\n   </imgdir>\n   <imgdir name=\"BaseImg\">\n     <canvas name=\"0\" width=\"640\" height=\"470\">\n@@ -11,56 +14,136 @@\n   </imgdir>\n   <imgdir name=\"MapList\">\n     <imgdir name=\"0\">\n-      <vector name=\"spot\" x=\"-118\" y=\"70\"/>\n-      <int name=\"type\" value=\"0\"/>\n+      <int name=\"type\" value=\"2\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"680000000\"/>\n-        <int name=\"1\" value=\"680000001\"/>\n-        <int name=\"2\" value=\"680000002\"/>\n-        <int name=\"3\" value=\"680000003\"/>\n-        <int name=\"4\" value=\"680000100\"/>\n-        <int name=\"5\" value=\"680000110\"/>\n-        <int name=\"6\" value=\"680000200\"/>\n-        <int name=\"7\" value=\"680000210\"/>\n-        <int name=\"8\" value=\"680000300\"/>\n-        <int name=\"9\" value=\"680000400\"/>\n-        <int name=\"10\" value=\"680000401\"/>\n+        <int name=\"0\" value=\"540000000\"/>\n+        <int name=\"1\" value=\"540000100\"/>\n+        <int name=\"2\" value=\"540000200\"/>\n+        <int name=\"3\" value=\"540000300\"/>\n+        <int name=\"4\" value=\"540010000\"/>\n+        <int name=\"5\" value=\"540020000\"/>\n+        <int name=\"6\" value=\"540020100\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"-29\" y=\"142\"/>\n     </imgdir>\n     <imgdir name=\"1\">\n-      <vector name=\"spot\" x=\"-45\" y=\"79\"/>\n-      <int name=\"type\" value=\"1\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"680010000\"/>\n+        <int name=\"0\" value=\"541000000\"/>\n+        <int name=\"1\" value=\"541000100\"/>\n+        <int name=\"10\" value=\"541010060\"/>\n+        <int name=\"11\" value=\"541010100\"/>\n+        <int name=\"12\" value=\"541010110\"/>\n+        <int name=\"2\" value=\"541000200\"/>\n+        <int name=\"3\" value=\"541000300\"/>\n+        <int name=\"4\" value=\"541010000\"/>\n+        <int name=\"5\" value=\"541010010\"/>\n+        <int name=\"6\" value=\"541010020\"/>\n+        <int name=\"7\" value=\"541010030\"/>\n+        <int name=\"8\" value=\"541010040\"/>\n+        <int name=\"9\" value=\"541010050\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"29\" y=\"162\"/>\n+      <int name=\"type\" value=\"2\"/>\n     </imgdir>\n     <imgdir name=\"2\">\n-      <vector name=\"spot\" x=\"8\" y=\"34\"/>\n-      <int name=\"type\" value=\"1\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"680010100\"/>\n+        <int name=\"0\" value=\"550000000\"/>\n+        <int name=\"1\" value=\"550000100\"/>\n+        <int name=\"2\" value=\"550000200\"/>\n+        <int name=\"3\" value=\"550000300\"/>\n+        <int name=\"4\" value=\"550000400\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"-210\" y=\"70\"/>\n+      <int name=\"type\" value=\"2\"/>\n     </imgdir>\n     <imgdir name=\"3\">\n-      <vector name=\"spot\" x=\"24\" y=\"-25\"/>\n-      <int name=\"type\" value=\"1\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"670000100\"/>\n+        <int name=\"0\" value=\"551000000\"/>\n+        <int name=\"1\" value=\"551000100\"/>\n+        <int name=\"2\" value=\"551000200\"/>\n+        <int name=\"3\" value=\"551010000\"/>\n+        <int name=\"4\" value=\"551020000\"/>\n+        <int name=\"5\" value=\"551030000\"/>\n+        <int name=\"6\" value=\"551030100\"/>\n+        <int name=\"7\" value=\"551030200\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"-94\" y=\"74\"/>\n+      <int name=\"type\" value=\"2\"/>\n     </imgdir>\n     <imgdir name=\"4\">\n-      <vector name=\"spot\" x=\"49\" y=\"-87\"/>\n-      <int name=\"type\" value=\"1\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"670000200\"/>\n+        <int name=\"0\" value=\"800000000\"/>\n+        <int name=\"1\" value=\"800010000\"/>\n+        <int name=\"10\" value=\"800020200\"/>\n+        <int name=\"11\" value=\"800020300\"/>\n+        <int name=\"12\" value=\"800030000\"/>\n+        <int name=\"2\" value=\"800010001\"/>\n+        <int name=\"3\" value=\"800010100\"/>\n+        <int name=\"4\" value=\"800020000\"/>\n+        <int name=\"5\" value=\"800020100\"/>\n+        <int name=\"6\" value=\"800020101\"/>\n+        <int name=\"7\" value=\"800020110\"/>\n+        <int name=\"8\" value=\"800020120\"/>\n+        <int name=\"9\" value=\"800020130\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"24\" y=\"-32\"/>\n+      <int name=\"type\" value=\"2\"/>\n     </imgdir>\n     <imgdir name=\"5\">\n-      <vector name=\"spot\" x=\"107\" y=\"-121\"/>\n-      <int name=\"type\" value=\"1\"/>\n       <imgdir name=\"mapNo\">\n-        <int name=\"0\" value=\"670010000\"/>\n+        <int name=\"0\" value=\"801000000\"/>\n+        <int name=\"1\" value=\"801000001\"/>\n+        <int name=\"10\" value=\"801030000\"/>\n+        <int name=\"11\" value=\"801040000\"/>\n+        <int name=\"12\" value=\"801040001\"/>\n+        <int name=\"13\" value=\"801040002\"/>\n+        <int name=\"14\" value=\"801040003\"/>\n+        <int name=\"15\" value=\"801040004\"/>\n+        <int name=\"16\" value=\"801040100\"/>\n+        <int name=\"17\" value=\"801040101\"/>\n+        <int name=\"2\" value=\"801000002\"/>\n+        <int name=\"3\" value=\"801000100\"/>\n+        <int name=\"4\" value=\"801000110\"/>\n+        <int name=\"5\" value=\"801000200\"/>\n+        <int name=\"6\" value=\"801000210\"/>\n+        <int name=\"7\" value=\"801000300\"/>\n+        <int name=\"8\" value=\"801010000\"/>\n+        <int name=\"9\" value=\"801020000\"/>\n       </imgdir>\n+      <vector name=\"spot\" x=\"104\" y=\"-92\"/>\n+      <int name=\"type\" value=\"2\"/>\n+    </imgdir>\n+  </imgdir>\n+  <imgdir name=\"MapLink\">\n+    <imgdir name=\"0\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap220\"/>\n+        <canvas name=\"linkImg\" width=\"152\" height=\"83\">\n+          <int name=\"z\" value=\"1\"/>\n+          <vector name=\"origin\" x=\"67\" y=\"-117\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Singapore\"/>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap230\"/>\n+        <canvas name=\"linkImg\" width=\"194\" height=\"132\">\n+          <int name=\"z\" value=\"1\"/>\n+          <vector name=\"origin\" x=\"260\" y=\"-23\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Malaysia\"/>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <imgdir name=\"link\">\n+        <string name=\"linkMap\" value=\"WorldMap210\"/>\n+        <canvas name=\"linkImg\" width=\"253\" height=\"195\">\n+          <int name=\"z\" value=\"1\"/>\n+          <vector name=\"origin\" x=\"68\" y=\"164\"/>\n+        </canvas>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Japan\"/>\n     </imgdir>\n   </imgdir>\n </imgdir>"}, {"sha": "eab16c7e42b0abbd88ac85656cee8830d1fd4df3", "filename": "wz/Map.wz/WorldMap/WorldMap210.img.xml", "status": "added", "additions": 133, "deletions": 0, "changes": 133, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap210.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap210.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap210.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,133 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap210.img\">\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"640\" height=\"470\">\n+      <vector name=\"origin\" x=\"320\" y=\"235\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap140\"/>\n+  </imgdir>\n+  <imgdir name=\"MapLink\">\n+    <imgdir name=\"0\">\n+      <imgdir name=\"link\">\n+        <canvas name=\"linkImg\" width=\"103\" height=\"100\">\n+          <vector name=\"origin\" x=\"-2\" y=\"116\"/>\n+          <int name=\"z\" value=\"1\"/>\n+        </canvas>\n+        <string name=\"linkMap\" value=\"WorldMap211\"/>\n+      </imgdir>\n+      <string name=\"toolTip\" value=\"Showa\"/>\n+    </imgdir>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"2\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800010001\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-7\" y=\"-7\"/>\n+    </imgdir>\n+    <imgdir name=\"0\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800000000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-68\" y=\"-14\"/>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"25\" y=\"63\"/>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"163\" y=\"144\"/>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020101\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"51\" y=\"6\"/>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020110\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"90\" y=\"76\"/>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020120\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"113\" y=\"25\"/>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020130\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"137\" y=\"-41\"/>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"253\" y=\"81\"/>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800020300\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"286\" y=\"43\"/>\n+    </imgdir>\n+    <imgdir name=\"11\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800030000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-14\" y=\"-25\"/>\n+    </imgdir>\n+    <imgdir name=\"12\">\n+      <int name=\"type\" value=\"2\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801000000\"/>\n+        <int name=\"1\" value=\"801000001\"/>\n+        <int name=\"2\" value=\"801000002\"/>\n+        <int name=\"3\" value=\"801000100\"/>\n+        <int name=\"4\" value=\"801000110\"/>\n+        <int name=\"5\" value=\"801000200\"/>\n+        <int name=\"6\" value=\"801000210\"/>\n+        <int name=\"7\" value=\"801000300\"/>\n+        <int name=\"8\" value=\"801010000\"/>\n+        <int name=\"9\" value=\"801020000\"/>\n+        <int name=\"10\" value=\"801030000\"/>\n+        <int name=\"11\" value=\"801040000\"/>\n+        <int name=\"12\" value=\"801040001\"/>\n+        <int name=\"13\" value=\"801040002\"/>\n+        <int name=\"14\" value=\"801040003\"/>\n+        <int name=\"15\" value=\"801040004\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"35\" y=\"-55\"/>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"800010000\"/>\n+        <int name=\"1\" value=\"800010100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-23\" y=\"33\"/>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "f834a278bfacebc97f1081598b2ee3b1063a077b", "filename": "wz/Map.wz/WorldMap/WorldMap211.img.xml", "status": "added", "additions": 98, "deletions": 0, "changes": 98, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap211.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap211.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap211.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,98 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap211.img\">\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"640\" height=\"470\">\n+      <vector name=\"origin\" x=\"320\" y=\"235\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap210\"/>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"0\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801000000\"/>\n+        <int name=\"1\" value=\"801000001\"/>\n+        <int name=\"2\" value=\"801000002\"/>\n+        <int name=\"3\" value=\"801000100\"/>\n+        <int name=\"4\" value=\"801000110\"/>\n+        <int name=\"5\" value=\"801000200\"/>\n+        <int name=\"6\" value=\"801000210\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"23\" y=\"26\"/>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <int name=\"type\" value=\"3\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801000300\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"133\" y=\"51\"/>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801010000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-51\" y=\"-37\"/>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801020000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-42\" y=\"-110\"/>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801030000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-136\" y=\"-173\"/>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040000\"/>\n+        <int name=\"1\" value=\"801040101\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"4\" y=\"179\"/>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040001\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"50\" y=\"179\"/>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040002\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"50\" y=\"153\"/>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040003\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"50\" y=\"127\"/>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040004\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"50\" y=\"101\"/>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"801040100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"97\" y=\"74\"/>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "2c0347973cb27c450955e8f38562c22b4ea7c5cc", "filename": "wz/Map.wz/WorldMap/WorldMap220.img.xml", "status": "added", "additions": 100, "deletions": 0, "changes": 100, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap220.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap220.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap220.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,100 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap220.img\">\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"640\" height=\"470\">\n+      <vector name=\"origin\" x=\"320\" y=\"235\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap140\"/>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"1\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540000100\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"-156\" y=\"50\"/>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540000200\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"-90\" y=\"82\"/>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540000300\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"-39\" y=\"80\"/>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540020000\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"1\" y=\"58\"/>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540020100\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"1\" y=\"21\"/>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541000000\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"0\"/>\n+      <vector name=\"spot\" x=\"55\" y=\"70\"/>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541000100\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"112\" y=\"54\"/>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541000200\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"141\" y=\"37\"/>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541000300\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"1\"/>\n+      <vector name=\"spot\" x=\"171\" y=\"21\"/>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"541010000\"/>\n+        <int name=\"1\" value=\"541010010\"/>\n+        <int name=\"2\" value=\"541010020\"/>\n+        <int name=\"3\" value=\"541010030\"/>\n+        <int name=\"4\" value=\"541010040\"/>\n+        <int name=\"5\" value=\"541010050\"/>\n+        <int name=\"6\" value=\"541010060\"/>\n+        <int name=\"7\" value=\"541010100\"/>\n+        <int name=\"8\" value=\"541010110\"/>\n+      </imgdir>\n+      <int name=\"type\" value=\"2\"/>\n+      <vector name=\"spot\" x=\"237\" y=\"17\"/>\n+    </imgdir>\n+    <imgdir name=\"0\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"540000000\"/>\n+        <int name=\"1\" value=\"540010000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-204\" y=\"-21\"/>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "57005242f2394c6319856882ffce3873cd352db4", "filename": "wz/Map.wz/WorldMap/WorldMap230.img.xml", "status": "added", "additions": 105, "deletions": 0, "changes": 105, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap230.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Map.wz/WorldMap/WorldMap230.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/WorldMap/WorldMap230.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -0,0 +1,105 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<imgdir name=\"WorldMap230.img\">\n+  <imgdir name=\"BaseImg\">\n+    <canvas name=\"0\" width=\"640\" height=\"470\">\n+      <vector name=\"origin\" x=\"320\" y=\"235\"/>\n+      <int name=\"z\" value=\"0\"/>\n+    </canvas>\n+  </imgdir>\n+  <imgdir name=\"info\">\n+    <string name=\"parentMap\" value=\"WorldMap140\"/>\n+  </imgdir>\n+  <imgdir name=\"MapList\">\n+    <imgdir name=\"0\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"-258\" y=\"-4\"/>\n+    </imgdir>\n+    <imgdir name=\"1\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"34\" y=\"-104\"/>\n+    </imgdir>\n+    <imgdir name=\"2\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"75\" y=\"-123\"/>\n+    </imgdir>\n+    <imgdir name=\"3\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000300\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"123\" y=\"-127\"/>\n+    </imgdir>\n+    <imgdir name=\"6\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551000100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"219\" y=\"-72\"/>\n+    </imgdir>\n+    <imgdir name=\"5\">\n+      <int name=\"type\" value=\"0\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551000000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"201\" y=\"-96\"/>\n+    </imgdir>\n+    <imgdir name=\"9\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551020000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"69\" y=\"41\"/>\n+    </imgdir>\n+    <imgdir name=\"10\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551030000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"21\" y=\"73\"/>\n+    </imgdir>\n+    <imgdir name=\"11\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551030100\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"80\" y=\"121\"/>\n+    </imgdir>\n+    <imgdir name=\"12\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551030200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"194\" y=\"120\"/>\n+    </imgdir>\n+    <imgdir name=\"4\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"550000400\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"158\" y=\"-120\"/>\n+    </imgdir>\n+    <imgdir name=\"8\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551010000\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"158\" y=\"35\"/>\n+    </imgdir>\n+    <imgdir name=\"7\">\n+      <int name=\"type\" value=\"1\"/>\n+      <imgdir name=\"mapNo\">\n+        <int name=\"0\" value=\"551000200\"/>\n+      </imgdir>\n+      <vector name=\"spot\" x=\"209\" y=\"17\"/>\n+    </imgdir>\n+  </imgdir>\n+</imgdir>"}, {"sha": "570a733968c79c879e23d455643728aaa6c868de", "filename": "wz/Quest.wz/Act.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Act.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Act.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Act.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -55982,8 +55982,8 @@\n           <int name=\"id\" value=\"4000295\"/>\n         </imgdir>\n         <imgdir name=\"4\">\n-          <int name=\"count\" value=\"-30\"/>\n-          <int name=\"id\" value=\"4001372\"/>\n+          <int name=\"count\" value=\"-15\"/>\n+          <int name=\"id\" value=\"4000030\"/>\n         </imgdir>\n         <imgdir name=\"5\">\n           <int name=\"count\" value=\"-10\"/>"}, {"sha": "96f996566900e111f4ca1ecd23ac66b45d402fe8", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -76673,8 +76673,8 @@\n           <int name=\"count\" value=\"30\"/>\n         </imgdir>\n         <imgdir name=\"4\">\n-          <int name=\"count\" value=\"30\"/>\n-          <int name=\"id\" value=\"4001372\"/>\n+          <int name=\"count\" value=\"15\"/>\n+          <int name=\"id\" value=\"4000030\"/>\n         </imgdir>\n         <imgdir name=\"5\">\n           <int name=\"id\" value=\"4032475\"/>"}, {"sha": "8300b50c21cb006f2db37d225161fe3b0db4639d", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -10317,7 +10317,7 @@ Able to proceed to &apos;For the peace of Victoria Island...&apos; as next quest\n     <string name=\"name\" value=\"Hunter&apos;s Profission\"/>\n     <int name=\"area\" value=\"50\"/>\n     <string name=\"0\" value=\"Scadur seems up to something big this time. I should move to El Nath and see what he is looking for...\"/>\n-    <string name=\"1\" value=\"So Scadur is going to set-up a &quot;Leather Festival&quot; on El Nath... I&apos;m out to find and collect all these items for him. Hope the reward of this mission is really worth it...\\n\\n#i4000021# #t4000021# #c4000021# / #r50#k\\n#i4000264# #t4000264# #c4000264# / #r10#k\\n#i4000281# #t4000281# #c4000281# / #r10#k\\n#i4000295# #t4000295# #c4000295# / #r10#k\\n#i4001372# #t4001372# #c4001372# / #r10#k\\n#i4032475# #t4032475# #c4032475# / #r5#k\"/>\n+    <string name=\"1\" value=\"So Scadur is going to set-up a &quot;Leather Festival&quot; on El Nath... I&apos;m out to find and collect all these items for him. Hope the reward of this mission is really worth it...\\n\\n#i4000021# #t4000021# #c4000021# / #r60#k\\n#i4000264# #t4000264# #c4000264# / #r30#k\\n#i4000281# #t4000281# #c4000281# / #r30#k\\n#i4000295# #t4000295# #c4000295# / #r30#k\\n#i4000030# #t4000030# #c4000030# / #r15#k\\n#i4032475# #t4032475# #c4032475# / #r10#k\"/>\n     <string name=\"2\" value=\"I helped Scadur in his &quot;Leather Festival&quot;, held on El Nath.\"/>\n   </imgdir>\n   <imgdir name=\"29000\">"}, {"sha": "f2407b85e8f5c0c632df4a4c4776e77259c70500", "filename": "wz/Quest.wz/Say.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Say.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Quest.wz/Say.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Say.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -64772,7 +64772,7 @@\n       <string name=\"0\" value=\"The new hunting season has begun! I am planning to set-up a stand here at the El-Nath Market, selling #rleathers#k of the most fine quality. And for this, I am counting on you to bring all these leathers here, obviously for a #bvery nice reward#k. If you miss that season, you&apos;re not a serious hunter. It&apos;s that important. You know, I can give you a special tip on how to hunt effectively. Are you interested?\"/>\n       <imgdir name=\"yes\">\n         <string name=\"0\" value=\"Oh hoho... Surely you do. As a hunter in training, you should get accostumed with the uncertainties that surround us. So, take this list of leathers I want you to bring, and bring them here, ok? If you pass this test, you will not regret it!\"/>\n-        <string name=\"1\" value=\"You will need firstly regular #b#t4000021##k in a bunch of 60. In #rLeafre#k, hunt for some #b#t4000264##k. In #rMu Lung#k, hunt for some #b#t4000281##k and #b#t4000295##k, these are widely appreciated around here, and quite rare to find. In #rVictoria Island#k, hunt some #b#t4001372##k, despite their pungent smell they are quite the spice.\"/>\n+        <string name=\"1\" value=\"You will need firstly regular #b#t4000021##k in a bunch of 60. In #rLeafre#k, hunt for some #b#t4000264##k. In #rMu Lung#k, hunt for some #b#t4000281##k and #b#t4000295##k, these are widely appreciated around here, and quite rare to find. In #rVictoria Island#k, hunt some #b#t4000030##k, their tough yet flexible texture form quite the spice.\"/>\n         <string name=\"2\" value=\"Finally, #b#t4032475##k. Normally their leather are not very consistent. However, once we are in open hunt season, they have some utility for adorning things. Said all that, good luck on your hunt and be safe.\"/>\n       </imgdir>\n       <imgdir name=\"no\">"}, {"sha": "01407d2f17c66428e54451da74c1f2d9a2715753", "filename": "wz/Skill.wz/312.img.xml", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Skill.wz/312.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/Skill.wz/312.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/312.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1039,12 +1039,16 @@\n           <vector name=\"origin\" x=\"90\" y=\"162\"/>\n           <int name=\"delay\" value=\"70\"/>\n         </canvas>\n-        <canvas name=\"13\" width=\"127\" height=\"268\">\n-          <vector name=\"origin\" x=\"89\" y=\"164\"/>\n+        <canvas name=\"14\" width=\"127\" height=\"274\">\n           <int name=\"delay\" value=\"70\"/>\n+          <vector name=\"origin\" x=\"88\" y=\"167\"/>\n         </canvas>\n         <string name=\"action\" value=\"shoot1\"/>\n         <int name=\"time\" value=\"960\"/>\n+        <canvas name=\"13\" width=\"127\" height=\"268\">\n+          <vector name=\"origin\" x=\"89\" y=\"164\"/>\n+          <int name=\"delay\" value=\"70\"/>\n+        </canvas>\n       </imgdir>\n       <imgdir name=\"keydown\">\n         <canvas name=\"0\" width=\"127\" height=\"276\">"}, {"sha": "4de2792d2a2e124a5e985ede566bc11e2ff62ea8", "filename": "wz/String.wz/Map.img.xml", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/String.wz/Map.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398/wz/String.wz/Map.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Map.img.xml?ref=c3e3c6dfbb33e9e442c07dfddc6f32b8e5439398", "patch": "@@ -1560,20 +1560,20 @@\n       <string name=\"mapName\" value=\"Hot Sand\"/>\n     </imgdir>\n     <imgdir name=\"180000000\">\n-      <string name=\"streetName\" value=\"Victoria Road\"/>\n-      <string name=\"mapName\" value=\"Ellinia\"/>\n+      <string name=\"streetName\" value=\"Hidden Street\"/>\n+      <string name=\"mapName\" value=\"GM Room\"/>\n     </imgdir>\n     <imgdir name=\"180000001\">\n-      <string name=\"streetName\" value=\"Victoria Road\"/>\n-      <string name=\"mapName\" value=\"Ellinia\"/>\n+      <string name=\"streetName\" value=\"Hidden Street\"/>\n+      <string name=\"mapName\" value=\"GM Room\"/>\n     </imgdir>\n     <imgdir name=\"180000002\">\n-      <string name=\"streetName\" value=\"Victoria Road\"/>\n-      <string name=\"mapName\" value=\"Ellinia\"/>\n+      <string name=\"streetName\" value=\"Hidden Street\"/>\n+      <string name=\"mapName\" value=\"GM Room\"/>\n     </imgdir>\n     <imgdir name=\"180000003\">\n-      <string name=\"streetName\" value=\"Victoria Road\"/>\n-      <string name=\"mapName\" value=\"Ellinia\"/>\n+      <string name=\"streetName\" value=\"Hidden Street\"/>\n+      <string name=\"mapName\" value=\"GM Room\"/>\n     </imgdir>\n     <imgdir name=\"190000000\">\n       <string name=\"streetName\" value=\"Premium Road\"/>"}]}]},
