{"fetchDate": "2019-12-19", "content": [{"sha": "8f76e7be25a8e521d74ca71887e3a7519de0de34", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6OGY3NmU3YmUyNWE4ZTUyMWQ3NGNhNzE4ODdlM2E3NTE5ZGUwZGUzNA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-02-17T02:07:10Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-02-17T02:07:10Z"}, "message": "Event disposing patch + Papulatus rework + V. scroll exploit patch\n\nSolved issues with PQs/events in progress not disposing properly party leavers (warping them out of the event maps).\nSolved issues with cleared PQs/events disposing players unproperly when leaving or disbanding the party.\nReworked Papulatus battle now working as an event instance, similar to how Capt Latanica battle is dealt.\nFixed a possible PE exploit with Vega's scroll.", "tree": {"sha": "b230b533c3728bd88fd7d516d818bd8ef839f6a2", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/b230b533c3728bd88fd7d516d818bd8ef839f6a2"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/8f76e7be25a8e521d74ca71887e3a7519de0de34", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8f76e7be25a8e521d74ca71887e3a7519de0de34", "html_url": "https://github.com/ronancpl/HeavenMS/commit/8f76e7be25a8e521d74ca71887e3a7519de0de34", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8f76e7be25a8e521d74ca71887e3a7519de0de34/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "278b5e814022d2164922806a6e3ec99c401a899c", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/278b5e814022d2164922806a6e3ec99c401a899c", "html_url": "https://github.com/ronancpl/HeavenMS/commit/278b5e814022d2164922806a6e3ec99c401a899c"}], "stats": {"total": 1033, "additions": 910, "deletions": 123}, "files": [{"sha": "cd199561a80a385ac97923674e78d5dffa8dcfe3", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -787,5 +787,8 @@ Adicionado novos scrolls \u00e0 venda no Spindle.\n Corrigido bug com pet Snail sendo inexpir\u00e1vel (deveria ter tempo de vida de 5 horas).\n Adicionado efeito de som ao atravessar portais para a maioria dos scripts de portais.\n \n-14 Fevereiro 2018,\n-Adicionado diversos drops de skill/mastery books para mobs level 90+.\n\\ No newline at end of file\n+14 - 16 Fevereiro 2018,\n+Adicionado diversos drops de skill/mastery books para mobs level 90+.\n+Corrigido problema com PQs onde jogadores que sa\u00edam do grupo n\u00e3o eram transportados para fora do mapa do evento devidamente.\n+Corrigido problema com PQs onde jogadores eram expulsos de eventos j\u00e1 completados ao tentar sair/debandar da party.\n+Corrigido poss\u00edvel problema de exploit com Vega's scroll.\n\\ No newline at end of file"}, {"sha": "6e6d98ba06ac16f12b59da6dacfed97539f2f616", "filename": "scripts/event/0_EXAMPLE.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/0_EXAMPLE.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/0_EXAMPLE.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/0_EXAMPLE.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -62,6 +62,10 @@ function playerExit(eim, player) {\n     // Do something with the player right before disbanding the event instance.\n }\n \n+function playerLeft(eim, player) {\n+    // Do something with the player right before leaving the party.\n+}\n+\n function changedMap(eim, player, mapid) {\n     // What to do when player've changed map, based on the mapid.\n }"}, {"sha": "0d3c85218a7d417923c23d24b8a6106d0d8854a6", "filename": "scripts/event/AmoriaPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/AmoriaPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/AmoriaPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/AmoriaPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -168,6 +168,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -208,15 +214,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "f2ebee4d50195963e05dd4fd6f957f934b58b367", "filename": "scripts/event/BossRushPQ.js", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/BossRushPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/BossRushPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BossRushPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -129,6 +129,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -167,14 +173,17 @@ function playerDisconnected(eim, player) {\n }\n \n function leftParty(eim, player) {\n-        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n                 end(eim);\n+        }\n         else\n-                playerExit(eim, player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "3010832c38d470926cecff0b2b0d4ea07db90aa3", "filename": "scripts/event/CafePQ_1.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_1.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "9c7a328bac9736912126ff903ccc704c1a7cedd0", "filename": "scripts/event/CafePQ_2.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_2.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "bf49d76788cda7d00f94b2844d80b4d08f2a296b", "filename": "scripts/event/CafePQ_3.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_3.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_3.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_3.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "7d3139a848919a85f4143cb961168419ca52c835", "filename": "scripts/event/CafePQ_4.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_4.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "ced009195ce8076d9574b3e84d10140eea68af97", "filename": "scripts/event/CafePQ_5.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_5.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_5.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_5.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "f997b049a11e1d4f15225356a99158eb8f0b72ab", "filename": "scripts/event/CafePQ_6.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_6.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/CafePQ_6.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CafePQ_6.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -134,6 +134,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -174,15 +180,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "c2a94165b2ab4ba99b0c6ffc2b3015c2abccd197", "filename": "scripts/event/ElementalBattle.js", "status": "added", "additions": 222, "deletions": 0, "changes": 222, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/ElementalBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/ElementalBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ElementalBattle.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -0,0 +1,222 @@\n+/**\n+ * @author: Ronan\n+ * @event: Vs Elemental Thanatos\n+*/\n+\n+var isPq = true;\n+var minPlayers = 2, maxPlayers = 2;\n+var minLevel = 100, maxLevel = 255;\n+var entryMap = 922020100;\n+var exitMap = 220050300;\n+var recruitMap = 220050300;\n+var clearMap = 220050300;\n+\n+var minMapId = 922020100;\n+var maxMapId = 922020100;\n+\n+var eventTime = 20;     // 20 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    For #rmagicians only#k.\";\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n+\n+        evLevel = 1;    //Rewards at clear PQ\n+        itemSet = [];\n+        itemQty = [];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel && ch.getJob().getJobNiche() == 2) {\n+                                if(ch.isLeader()) hasLeader = true;     // magician niche only\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Elemental\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"boss\", \"0\");\n+        \n+        eim.getInstanceMap(922020100).resetPQ(level);\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                end(eim);\n+        }\n+        else\n+                playerLeft(eim, player);\n+}\n+\n+function disbandParty(eim) {\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n+}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        \n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isElemental(mob) {\n+        var mobid = mob.getId();\n+        return mobid == 9300086 || mobid == 9300100;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        if(isElemental(mob)) {\n+                var killed = eim.getIntProperty(\"boss\");\n+                if(killed == 1) {\n+                        eim.showClearEffect();\n+                        eim.clearPQ();\n+                } else {\n+                        eim.setIntProperty(\"boss\", killed + 1);\n+                }\n+        }\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "bad05057c693f5f6ee6084a61f205a6cd2a5e65d", "filename": "scripts/event/EllinPQ.js", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/EllinPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/EllinPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/EllinPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -39,6 +39,9 @@ function setEventRequirements() {\n         \n         reqStr += \"\\r\\n    For #radventurers only#k.\";\n         \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n         em.setProperty(\"party\", reqStr);\n }\n \n@@ -136,6 +139,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n@@ -156,14 +165,17 @@ function playerDisconnected(eim, player) {\n }\n \n function leftParty(eim, player) {\n-        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n                 end(eim);\n+        }\n         else\n-                playerExit(eim, player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "39348cbef79adb30da1fbb06cd9068ec87edb8cd", "filename": "scripts/event/HenesysPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/HenesysPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/HenesysPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HenesysPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -129,6 +129,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -169,15 +175,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "b61a8fb2a09d231bbafe1d58ba48c738698f34a0", "filename": "scripts/event/HorntailPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/HorntailPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/HorntailPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HorntailPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -130,6 +130,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -170,15 +176,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "ef399ac32ae405b37fdf792133d62b9c4c529874", "filename": "scripts/event/KerningPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/KerningPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/KerningPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KerningPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -116,6 +116,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -156,15 +162,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "e24a4a37f0ae8976fe63c397db632c23e781f983", "filename": "scripts/event/LatanicaBattle.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LatanicaBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LatanicaBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/LatanicaBattle.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -115,6 +115,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -155,15 +161,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "7dccd58dfeee0c7ac4c5424d32c3d53c4697dd54", "filename": "scripts/event/LudiMazePQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LudiMazePQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LudiMazePQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/LudiMazePQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "46c92c1a2c329c4fdeb534df80a4f7f02c338c57", "filename": "scripts/event/LudiPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LudiPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/LudiPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/LudiPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -153,6 +153,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -193,15 +199,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "ac52682645efc86a11f69533e752dd748ce89e1f", "filename": "scripts/event/MagatiaPQ_A.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/MagatiaPQ_A.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/MagatiaPQ_A.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/MagatiaPQ_A.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -229,6 +229,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -316,15 +322,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "a0ac6b13ed063b68d7d20a2723dd627981e6dc32", "filename": "scripts/event/MagatiaPQ_Z.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/MagatiaPQ_Z.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/MagatiaPQ_Z.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/MagatiaPQ_Z.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -229,6 +229,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -316,15 +322,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "d2206138eebd6531099c2186ac3755cb65750acf", "filename": "scripts/event/OrbisPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/OrbisPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/OrbisPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/OrbisPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -183,6 +183,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -223,15 +229,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "bbd1cdfe9a6fdd4e1eff2fb4bb3a91f2b98d7821", "filename": "scripts/event/PapulatusBattle.js", "status": "added", "additions": 215, "deletions": 0, "changes": 215, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/PapulatusBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/PapulatusBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PapulatusBattle.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -0,0 +1,215 @@\n+/**\n+ * @author: Ronan\n+ * @event: Vs Papulatus\n+*/\n+\n+var isPq = true;\n+var minPlayers = 1, maxPlayers = 6;\n+var minLevel = 1, maxLevel = 255;\n+var entryMap = 220080001;\n+var exitMap = 220080000;\n+var recruitMap = 220080000;\n+var clearMap = 220080000;\n+\n+var minMapId = 220080001;\n+var maxMapId = 220080001;\n+\n+var eventTime = 45;     // 45 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n+\n+        evLevel = 1;    //Rewards at clear PQ\n+        itemSet = [];\n+        itemQty = [];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n+        \n+        expStages = [];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n+        \n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n+        return eligible;\n+}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Papulatus\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"boss\", \"0\");\n+        \n+        eim.getInstanceMap(220080001).resetPQ(level);\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n+                end(eim);\n+        }\n+        else\n+                playerLeft(eim, player);\n+}\n+\n+function disbandParty(eim) {\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n+}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        \n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isPapulatus(mob) {\n+        var mobid = mob.getId();\n+        return mobid == 8500002;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        if(isPapulatus(mob)) {\n+                eim.showClearEffect();\n+                eim.clearPQ();\n+        }\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "d839472ae18a8dbc2928ef78341599a11c4a7f44", "filename": "scripts/event/PiratePQ.js", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/PiratePQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/PiratePQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PiratePQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -196,6 +196,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMapInside(eim, mapid) {\n         var stage = eim.getIntProperty(\"curStage\");\n     \n@@ -260,21 +266,25 @@ function playerRevive(eim, player) { // player presses ok on the death pop up.\n \n \n function playerDisconnected(eim, player) {\n-        if (eim.isEventTeamLackingNow(true, minPlayers, player))\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                 end(eim);\n+        }\n         else\n                 playerExit(eim, player);\n }\n \n function leftParty(eim, player) {\n-        if (eim.isEventTeamLackingNow(false, minPlayers, player))\n+        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n                 end(eim);\n+        }\n         else\n-                playerExit(eim, player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "82a97f38b371e6b302529fae03cd752827120203", "filename": "scripts/event/TD_Battle1.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/TD_Battle1.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "a0a04ca45b73bf08d34bfcd55ee0fb38fb302ab6", "filename": "scripts/event/TD_Battle2.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/TD_Battle2.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "3403b376e6ed94ed68dfce2acecba17b0f627463", "filename": "scripts/event/TD_Battle3.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle3.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle3.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/TD_Battle3.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "b59777618caaf6750b0a6cf2101f3512ff0bd2d5", "filename": "scripts/event/TD_Battle4.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/TD_Battle4.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "49bfe43b71671da032065fa8e2e19ae73a5bfb0b", "filename": "scripts/event/TD_Battle5.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle5.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/TD_Battle5.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/TD_Battle5.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -117,6 +117,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -157,15 +163,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "57859637f96d26047f6bca84b483ff8a19b6241a", "filename": "scripts/event/ZakumPQ.js", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/ZakumPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/event/ZakumPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ZakumPQ.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -146,6 +146,12 @@ function playerExit(eim, player) {\n         player.changeMap(exitMap, 0);\n }\n \n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n@@ -186,15 +192,16 @@ function playerDisconnected(eim, player) {\n \n function leftParty(eim, player) {\n         if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n-                eim.unregisterPlayer(player);\n+                playerLeft(eim, player);\n }\n \n function disbandParty(eim) {\n-        end(eim);\n+        if (!eim.isEventCleared()) {\n+                end(eim);\n+        }\n }\n \n function monsterValue(eim, mobId) {"}, {"sha": "9edc5e5b15467cd2082eea393984078f2f7f1b41", "filename": "scripts/npc/2041023.js", "status": "modified", "additions": 74, "deletions": 4, "changes": 78, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/npc/2041023.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/npc/2041023.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041023.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -19,9 +19,79 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-//By Moogra\n+//First version by Moogra\n+\n+/**\n+ * @author: Ronan\n+ * @npc: Flo\n+ * @map: Ludibrium - Path of Time (220050300)\n+ * @func: Elemental Thanatos room\n+*/\n+\n+var status = 0;\n+var em = null;\n \n function start() {\n-    cm.sendOk(\"You seems to have no reason to meet element-based Thanatos.\");\n-    cm.dispose();\n-}\n\\ No newline at end of file\n+\tstatus = -1;\n+\taction(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && status == 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+                \n+                if (status == 0) {\n+                        if(!(cm.isQuestCompleted(6316) && (cm.isQuestStarted(6225) || cm.isQuestStarted(6315)))) {\n+                                cm.sendOk(\"You seems to have no reason to meet element-based Thanatos.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+                    \n+                        em = cm.getEventManager(\"ElementalBattle\");\n+                        if(em == null) {\n+                                cm.sendOk(\"The Elemental Battle has encountered an error.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+                    \n+                        cm.sendSimple(\"#e#b<Party Quest: Elemental Thanatos>\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nYou are looking for Elemental Thanatos, right? If you team up with another mage, with the opposite elemental affinity as yours, you guys will be able to overcome them. As a leader, talk to me when you feel ready to go.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+                } else if (status == 1) {\n+                        if (selection == 0) {\n+                                if (cm.getParty() == null) {\n+                                        cm.sendOk(\"You can participate in the party quest only if you are in a party.\");\n+                                        cm.dispose();\n+                                } else if(!cm.isLeader()) {\n+                                        cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n+                                        cm.dispose();\n+                                } else {\n+                                        var eli = em.getEligibleParty(cm.getParty());\n+                                        if(eli.size() > 0) {\n+                                                if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                        cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n+                                                }\n+                                        }\n+                                        else {\n+                                                cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n+                                        }\n+                                        \n+                                        cm.dispose();\n+                                }\n+                        } else if (selection == 1) {\n+                                cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n+                                cm.dispose();\n+                        } else {\n+                                cm.sendOk(\"#e#b<Party Quest: Elemental Thanatos>#k#n\\r\\n Team up with another mage with #rdifferent elemental affinity#k before entering the stage. This team aspect is crucial to overcome the elementals inside.\");\n+                                cm.dispose();\n+                        }\n+                }\n+        }\n+}"}, {"sha": "c4f582b3f91dab5165ae8974d582832297aec846", "filename": "scripts/npc/2041024.js", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/npc/2041024.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/npc/2041024.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2041024.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -0,0 +1,46 @@\n+/*\n+    This file is part of the HeavenMS (MapleSolaxiaV2) MapleStory Server\n+    Copyleft (L) 2017 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+var status;\n+ \n+function start() {\n+        status = -1;\n+        action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && type > 0) {\n+                        cm.dispose();\n+                        return;\n+                }\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+    \n+                if(status == 0) {\n+                        cm.sendOk(\"For those capable of great feats and bearers of an unwavering resolve, the #bfinal destination#k lies ahead past the gate. The Machine Room accepts only #rone party at a time#k, so make sure your party is ready when crossing the gate.\");\n+                        cm.dispose();\n+                }\n+        }\n+}"}, {"sha": "8e5e4cb764c8549706c8bcade5f5171a2a151622", "filename": "scripts/portal/Populatus00.js", "status": "modified", "additions": 24, "deletions": 11, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/Populatus00.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/Populatus00.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Populatus00.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -19,19 +19,32 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n  */\n+\n+/* @author RonanLana */\n+\n function enter(pi) {\n-    var papuMap = pi.getClient().getChannelServer().getMapFactory().getMap(220080001);\n-    if (papuMap.getCharacters().size() == 0) {\n-        pi.getPlayer().dropMessage(\"The room is empty. A perfect opportunity to challenge the boss.\");\n-        papuMap.resetReactors();\n-    } else { // someone is inside\n-        for (var i = 0; i < 3; i++) {\n-            if (papuMap.getMonsterById(8500000 + i) != null) {\n-                pi.getPlayer().dropMessage(\"Someone is fighting Papulatus.\");\n+    var em = pi.getEventManager(\"PapulatusBattle\");\n+\n+    if (pi.getParty() == null) {\n+        pi.playerMessage(5, \"You are currently not in a party, create one to attempt the boss.\");\n+        return false;\n+    } else if(!pi.isLeader()) {\n+        pi.playerMessage(5, \"Your party leader must enter the portal to start the battle.\");\n+        return false;\n+    } else {\n+        var eli = em.getEligibleParty(pi.getParty());\n+        if(eli.size() > 0) {\n+            if(!em.startInstance(pi.getParty(), pi.getPlayer().getMap(), 1)) {\n+                pi.playerMessage(5, \"The battle against the boss has already begun, so you may not enter this place yet.\");\n                 return false;\n             }\n         }\n-    }\n-    pi.playPortalSound(); pi.warp(220080001, \"st00\");\n-    return true;\n+        else {  //this should never appear\n+            pi.playerMessage(5, \"You cannot start this battle yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n+            return false;\n+        }\n+\n+        pi.playPortalSound();\n+        return true;\n+    }    \n }\n\\ No newline at end of file"}, {"sha": "be4c109c7444c729b7e180dd02acb51e3b631335", "filename": "scripts/portal/TD_Boss_enter.js", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_Boss_enter.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_Boss_enter.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/TD_Boss_enter.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -18,7 +18,7 @@ function enter(pi) {\n                 var eli = em.getEligibleParty(pi.getParty());\n                 if(eli.size() > 0) {\n                         if(!em.startInstance(pi.getParty(), pi.getPlayer().getMap(), 1)) {\n-                                pi.playerMessage(5, \"The battle against the boss has already begun, so you may not enter this place.\");\n+                                pi.playerMessage(5, \"The battle against the boss has already begun, so you may not enter this place yet.\");\n                                 return false;\n                         }\n                 }\n@@ -27,6 +27,7 @@ function enter(pi) {\n                         return false;\n                 }\n \n+                pi.playPortalSound();\n                 return true;\n         }\n }"}, {"sha": "a9f98df2f48e00e204484916ff8654f97f3d6d7e", "filename": "scripts/portal/TD_MC_enterboss2.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_MC_enterboss2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_MC_enterboss2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/TD_MC_enterboss2.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -25,7 +25,9 @@ function enter(pi) {\n             pi.giveCharacterExp(4400 * 1.5, pi.getPlayer());\n             var pm = pi.getEventManager(\"MK_PrimeMinister\");\n             pm.setProperty(\"player\", pi.getPlayer().getName());\n+            \n             pm.startInstance(pi.getPlayer());\n+            pi.playPortalSound();\n             return true;\n         }\n     }\n@@ -37,7 +39,9 @@ function enter(pi) {\n         else{\n             var pm = pi.getEventManager(\"MK_PrimeMinister\");\n             pm.setProperty(\"player\", pi.getPlayer().getName());\n+            \n             pm.startInstance(pi.getPlayer());\n+            pi.playPortalSound();\n             return true;\n         }\n     }"}, {"sha": "a46cfbcd69b943cddbd0a4c759e3f7db9ade4636", "filename": "scripts/portal/TD_neo_inTree.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_neo_inTree.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/TD_neo_inTree.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/TD_neo_inTree.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -19,6 +19,7 @@ function enter(pi) {\n                 pi.message(\"Someone is already challenging Nex. Wait for them to finish before you enter.\");\n                 return false;\n             } else {\n+                pi.playPortalSound();\n                 return true;\n             }\n         }"}, {"sha": "a4ee3d6e4e22af6dc285e7c6a64d2a3cabee9e6c", "filename": "scripts/portal/captinsg00.js", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/captinsg00.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/captinsg00.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/captinsg00.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -17,7 +17,7 @@ function enter(pi) {\n                         var eli = em.getEligibleParty(pi.getParty());\n                         if(eli.size() > 0) {\n                                 if(!em.startInstance(pi.getParty(), pi.getPlayer().getMap(), 1)) {\n-                                        pi.playerMessage(5, \"The battle against the boss has already begun, so you may not enter this place.\");\n+                                        pi.playerMessage(5, \"The battle against the boss has already begun, so you may not enter this place yet.\");\n                                         return false;\n                                 }\n                         }\n@@ -26,6 +26,7 @@ function enter(pi) {\n                                 return false;\n                         }\n \n+                        pi.playPortalSound();\n                         return true;\n                 }\n         }"}, {"sha": "c8df1a28187a5aa6352632bd2ff988e9c6f45b30", "filename": "scripts/portal/enterMagiclibrar.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/enterMagiclibrar.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/scripts/portal/enterMagiclibrar.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterMagiclibrar.js?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -20,10 +20,10 @@\n */\n function enter(pi) {\n     if(pi.isQuestStarted(20718)){\n-        pi.playPortalSound();\n         var cml = pi.getEventManager(\"Cygnus_Magic_Library\");\n         cml.setProperty(\"player\", pi.getPlayer().getName());\n         cml.startInstance(pi.getPlayer());\n+        pi.playPortalSound();\n     }\n     else{\n         pi.playPortalSound();"}, {"sha": "6e3e6735da5feb090c1eb2371747169c73e38929", "filename": "sql/db_database.sql", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -10643,8 +10643,8 @@ INSERT IGNORE INTO `temp_data` (`id`, `dropperid`, `itemid`, `minimum_quantity`,\n (10421, 7130100, 4031466, 1, 1, 6107, 80000),\n (10422, 6230100, 4031466, 1, 1, 6107, 30000),\n (10423, 9300100, 4031470, 1, 1, 6225, 250000),\n-(10424, 9300086, 4031470, 1, 1, 6225, 250000),\n-(10425, 9300100, 4031469, 1, 1, 6315, 250000),\n+(10424, 9300086, 4031470, 1, 1, 6225, 1000),\n+(10425, 9300100, 4031469, 1, 1, 6315, 1000),\n (10426, 9300086, 4031469, 1, 1, 6315, 250000),\n (10427, 8160000, 4031474, 1, 1, 6295, 50000),\n (10428, 8160000, 4031473, 1, 1, 6226, 20000),"}, {"sha": "5b7235bed9e689eb0a8d0bdbf6bc6684370cca8e", "filename": "src/net/server/channel/handlers/MakerSkillHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/net/server/channel/handlers/MakerSkillHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/net/server/channel/handlers/MakerSkillHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MakerSkillHandler.java?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -406,7 +406,7 @@ private static boolean addBoostedMakerItem(MapleClient c, int itemid, int stimul\n             if(!(c.getPlayer().isGM() && ServerConstants.USE_PERFECT_GM_SCROLL)) {\n                 eqp.setUpgradeSlots((byte)(eqp.getUpgradeSlots() + 1));\n             }\n-            item = MapleItemInformationProvider.getInstance().scrollEquipWithId(eqp, 2049100, true, 0, c.getPlayer().isGM());\n+            item = MapleItemInformationProvider.getInstance().scrollEquipWithId(eqp, 2049100, true, 2049100, c.getPlayer().isGM());\n         }\n         \n         if(!reagentids.isEmpty()) {"}, {"sha": "7b6c9ea1105da75e892c04007749e6a451489808", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -564,14 +564,15 @@ public void run() {\n                 return;\n             }\n             \n-            //should have a check here against PE hacks\n-            \n             Equip toScroll = (Equip) eitem;\n             if (toScroll.getUpgradeSlots() < 1) {\n                 c.getSession().write(MaplePacketCreator.getInventoryFull());\n                 return;\n             }\n             \n+            //should have a check here against PE hacks\n+            if(itemId / 1000000 != 5) itemId = 0;\n+            \n             c.getPlayer().toggleBlockCashShop();\n             \n             final int curlevel = toScroll.getLevel();"}, {"sha": "f8d92ef4ed3dcca1271e971ac9126b4558946eb4", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 30, "deletions": 13, "changes": 43, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -101,6 +101,7 @@\n         private ScheduledFuture<?> event_schedule = null;\n         private boolean disposed = false;\n         private boolean eventCleared = false;\n+        private boolean eventStarted = false;\n         \n         // multi-leveled PQ rewards!\n         private Map<Integer, List<Integer>> collectionSet = new HashMap<>(ServerConstants.MAX_EVENT_LEVELS);\n@@ -507,18 +508,20 @@ public void monsterKilled(MapleMonster mob, boolean hasKiller) {\n                 try {\n                         mobs.remove(mob);\n                         \n-                        try {\n-                                em.getIv().invokeFunction(\"monsterKilled\", mob, this, hasKiller);\n-                        } catch (ScriptException | NoSuchMethodException ex) {\n-                                ex.printStackTrace();\n-                        }\n-                        \n-                        if (mobs.isEmpty()) {\n+                        if(eventStarted) {\n                                 try {\n-                                        em.getIv().invokeFunction(\"allMonstersDead\", this, hasKiller);\n+                                        em.getIv().invokeFunction(\"monsterKilled\", mob, this, hasKiller);\n                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                         ex.printStackTrace();\n                                 }\n+\n+                                if (mobs.isEmpty()) {\n+                                        try {\n+                                                em.getIv().invokeFunction(\"allMonstersDead\", this, hasKiller);\n+                                        } catch (ScriptException | NoSuchMethodException ex) {\n+                                                ex.printStackTrace();\n+                                        }\n+                                }\n                         }\n                 } finally {\n                         sL.unlock();\n@@ -1072,6 +1075,20 @@ private void disposeExpedition() {\n                 }\n         }\n         \n+        public final void startEvent() {\n+                try {\n+                        sL.lock();\n+                        try {\n+                                eventStarted = true;\n+                                em.getIv().invokeFunction(\"afterSetup\", this);\n+                        } finally {\n+                                sL.unlock();\n+                        }\n+                } catch (ScriptException | NoSuchMethodException ex) {\n+                        ex.printStackTrace();\n+                }\n+        }\n+        \n         public final void setEventCleared() {\n                 eventCleared = true;\n                 \n@@ -1097,20 +1114,20 @@ private boolean isEventTeamLeaderOn() {\n                 return false;\n         }\n         \n-        public final boolean checkEventTeamLacking(boolean testLeader, int minPlayers) {\n+        public final boolean checkEventTeamLacking(boolean leavingEventMap, int minPlayers) {\n                 if(eventCleared && getPlayerCount() > 1) return false;\n                 \n-                if(!eventCleared && testLeader && !isEventTeamLeaderOn()) return true;\n+                if(!eventCleared && leavingEventMap && !isEventTeamLeaderOn()) return true;\n                 if(getPlayerCount() < minPlayers) return true;\n                 \n                 return false;\n         }\n         \n-        public final boolean isEventTeamLackingNow(boolean testLeader, int minPlayers, MapleCharacter quitter) {\n+        public final boolean isEventTeamLackingNow(boolean leavingEventMap, int minPlayers, MapleCharacter quitter) {\n                 if(eventCleared) {\n-                        if(getPlayerCount() <= 1) return true;\n+                        if(leavingEventMap && getPlayerCount() <= 1) return true;\n                 } else {\n-                        if(testLeader && getLeaderId() == quitter.getId()) return true;\n+                        if(leavingEventMap && getLeaderId() == quitter.getId()) return true;\n                         if(getPlayerCount() <= minPlayers) return true;\n                 }\n                 "}, {"sha": "8e99546b5adb8946575e28751df1809364e72c32", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -298,7 +298,7 @@ public boolean startInstance(int lobbyId, MapleExpedition exped, MapleCharacter\n             exped.start();\n             eim.registerExpedition(exped);\n             \n-            iv.invokeFunction(\"afterSetup\", eim);\n+            eim.startEvent();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n@@ -334,7 +334,8 @@ public boolean startInstance(int lobbyId, MapleCharacter chr, MapleCharacter lea\n             eim.setLeader(leader);\n             \n             if(chr != null) eim.registerPlayer(chr);\n-            iv.invokeFunction(\"afterSetup\", eim);\n+            \n+            eim.startEvent();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n@@ -371,7 +372,8 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, MapleC\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n-            iv.invokeFunction(\"afterSetup\", eim);\n+            \n+            eim.startEvent();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n@@ -408,7 +410,8 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n-            iv.invokeFunction(\"afterSetup\", eim);\n+            \n+            eim.startEvent();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }\n@@ -448,7 +451,8 @@ public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr,\n             \n             iv.invokeFunction(\"setup\", eim);\n             eim.setProperty(\"leader\", ldr);\n-            iv.invokeFunction(\"afterSetup\", eim);\n+            \n+            eim.startEvent();\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n         }"}, {"sha": "cdeb5917239139fba3fc865ace705081c32a1594", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8f76e7be25a8e521d74ca71887e3a7519de0de34/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=8f76e7be25a8e521d74ca71887e3a7519de0de34", "patch": "@@ -871,9 +871,9 @@ public Item scrollEquipWithId(Item equip, int scrollId, boolean usingWhiteScroll\n             if (((nEquip.getUpgradeSlots() > 0 || ItemConstants.isCleanSlate(scrollId))) || assertGM) {\n                 double prop = (double)stats.get(\"success\");\n                 if (vegaItemId == 5610000) {\n-                    prop = 30.0;\n+                    if(prop == 10.0) prop = 30.0;\n                 } else if (vegaItemId == 5610001) {\n-                    prop = 90.0;\n+                    if(prop == 60.0) prop = 90.0;\n                 } else if (vegaItemId == 2049100) {\n                     prop = 100.0;\n                 }\n@@ -884,11 +884,11 @@ public Item scrollEquipWithId(Item equip, int scrollId, boolean usingWhiteScroll\n                         case 2040727:\n                             flag |= ItemConstants.SPIKES;\n                             nEquip.setFlag((byte) flag);\n-                            return equip;\n+                            break;\n                         case 2041058:\n                             flag |= ItemConstants.COLD;\n                             nEquip.setFlag((byte) flag);\n-                            return equip;\n+                            break;\n                         case 2049000:\n                         case 2049001:\n                         case 2049002:"}]}]},
