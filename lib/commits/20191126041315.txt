{"fetchDate": "2019-12-19", "content": [{"sha": "bb586a7c0b9862fbe689c257c48e626ade3881d0", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YmI1ODZhN2MwYjk4NjJmYmU2ODljMjU3YzQ4ZTYyNmFkZTM4ODFkMA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-11-26T04:13:15Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-11-26T04:13:15Z"}, "message": "Storybook announce + AOE Mobskills & Autopot & Inventory check Patch\n\nImplemented storybook detection for the skillbook announcer.\nFixed an issue with AOE mob skills not locating players properly in certain situations.\nReviewed interaction of players within same remote network on multiclient system.\nPatched messages when leaving the expedition area showing up for leaving players.\nPatched some skill questline item chances unexpectedly too low.\nReviewed Rush questline-exclusive area not allowing multiple players in the room.\nFixed meso capacity check on shop owner happening after item transaction.\nPatched server-side autopot settings, now using threshold cooling method to determine a player's updated settings.\nReviewed locking flow regarding world/channel deployment on main class.\nFixed a scenario where items collectable by party members would not show up in case those were the only items to be dropped and none needed by the last-hitter.\nPatched an issue in the inventory space checking algorithm that would allow a transaction for multiple of the same equipments.\nRefactored Dojo entry/exit modules.\nPatched a check on Maker skill.\nFixed Cygnus FA buff getting reapplied each time the skill procs.", "tree": {"sha": "91ce542a9c21b9e056758339877e2b907d46bf8f", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/91ce542a9c21b9e056758339877e2b907d46bf8f"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/bb586a7c0b9862fbe689c257c48e626ade3881d0", "comment_count": 2, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bb586a7c0b9862fbe689c257c48e626ade3881d0", "html_url": "https://github.com/ronancpl/HeavenMS/commit/bb586a7c0b9862fbe689c257c48e626ade3881d0", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bb586a7c0b9862fbe689c257c48e626ade3881d0/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "661dcf0a9614b09571ed01ab543dfc29cc877a9e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/661dcf0a9614b09571ed01ab543dfc29cc877a9e", "html_url": "https://github.com/ronancpl/HeavenMS/commit/661dcf0a9614b09571ed01ab543dfc29cc877a9e"}], "stats": {"total": 1022, "additions": 654, "deletions": 368}, "files": [{"sha": "182227bda5d3350accbdcc9f1761c15da1cbe4ae", "filename": "config.yaml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/config.yaml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/config.yaml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/config.yaml?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -193,7 +193,7 @@ server:\n     #Besides blocking logging in with several client sessions on the same machine, this also blocks suspicious login attempts for players that tries to login on an account using several diferent remote addresses.\n \n     #Multiclient Coordinator Configuration\n-    MAX_ALLOWED_ACCOUNT_HWID: 4         #Allows up to N concurrent HWID's for an account. HWID's remains linked to an account longer the more times it's used to login.\n+    MAX_ALLOWED_ACCOUNT_HWID: 10        #Allows up to N concurrent HWID's for an account. HWID's remains linked to an account longer the more times it's used to login.\n     MAX_ACCOUNT_LOGIN_ATTEMPT: 15       #After N tries on an account, login on that account gets disabled for a short period.\n     LOGIN_ATTEMPT_DURATION: 120         #Period in seconds the login attempt remains registered on the system.\n "}, {"sha": "d7125f68ae1fc69fe1f1d2db1de971067cd27f3e", "filename": "docs/issues.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -10,7 +10,7 @@ Known issues:\n - If there are multiple bosses that shows HPBar on the map, if a player hits more than one the HPBar may start flickering on the screen.\n - Sometimes battleship may behave oddly with the enhanced buff system, making the character d/c in certain scenarios.\n - Dragon Roar doesn't show the stun effect to players.\n-- Cygnus job 'Final Attack' skills not functional.\n+- Cygnus job 'Final Attack' skill for Wind Archer not functional.\n - Steal skill doesn't deduct the loot from the drop pool from a mob.\n - Snipe will show much higher damage value than actually applicable to the attacker.\n - Some monster status such as weapon/magic reflect doesn't behave properly in certain scenarios."}, {"sha": "a4e71c40a25bb2e5f4fad46c25652e2406c972cc", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 34, "deletions": 1, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -5,6 +5,7 @@\n \tDalair -> 9000040\n \tDonation Box -> 9000041\n \tAbdula -> 9209000 *\n+\tMapleTV -> scroll_generator\n \n CUSTOM NPC SHOPS (db_shopupdate.sql):\n \tAsia -> 2082014\n@@ -2272,4 +2273,36 @@ Corrigido caso inesperado em 2nd job de pirata bloqueando sa\u00edda de jogadores do\n 13 Novembro 2019,\n Corrigido problema no sistema de matching ao tentar rodar a\u00e7\u00f5es externas enquanto travando os recursos do sistema, ao criar match.\n Corrigido caso onde novos jogadores poderiam ser agregados \u00e0 party e entrar em campo na MCPQ assim que confirma\u00e7\u00e3o de partida e contagem de in\u00edcio fossem efetivados.\n-Adicionado cache para requerimento de scrolls, assim melhorando tempo de resposta para o novo custom NPC de gera\u00e7\u00e3o de scrolls.\n\\ No newline at end of file\n+Adicionado cache para requerimento de scrolls, assim melhorando tempo de resposta para o novo custom NPC de gera\u00e7\u00e3o de scrolls.\n+\n+15 Novembro 2019,\n+Reajustado chance de drops de v\u00e1rios livros de quest para skills de 4o job.\n+\n+18 Novembro 2019,\n+Corrigido atividade recente evitando skills em \u00e1rea de mobs n\u00e3o acertando mais diversos jogadores.\n+Corrigido uso de facingLeft em aplica\u00e7\u00e3o de mobskills levando a c\u00e1lculos invi\u00e1veis de \u00e1rea de atua\u00e7\u00e3o.\n+Aprimorado sistema multi-cliente, agora permitindo login de jogadores dentro de uma mesma rede.\n+Revisado mensagens de expedi\u00e7\u00e3o finalizando abruptamente aparecendo para jogador que est\u00e1 saindo do evento.\n+Revisado posicionamento de laranja na loja da NPC Miki.\n+Corrigido drop de quest de mineiros que deveria aparecer frequentemente dropando muito raramente.\n+Revisado \u00e1rea restrita de quest para skill Rush n\u00e3o permitindo acesso a v\u00e1rios jogadores simultaneamente.\n+Corrigido ocorr\u00eancia de loop cont\u00ednuo no sistema de matching, para casos com mais de um respondente.\n+Corrigido checagem por mesos de dono das Player Shops ocorrendo ap\u00f3s inser\u00e7\u00e3o do produto no invent\u00e1rio.\n+Corrigido alerta de autopots atuando sempre, uma vez que configura\u00e7\u00f5es foram setadas no m\u00e1ximo. Modelo agora passa a usar esfriamento de limites para reaquisi\u00e7\u00e3o dos limites do lado cliente.\n+\n+19 - 20 Novembro 2019,\n+Revisado abordagem de locks de canal e mundo na classe principal.\n+Implementado detec\u00e7\u00e3o por questbooks pelo anunciador de skillbooks.\n+Adicionado buffs com bonus na contabiliza\u00e7\u00e3o de dano teto feita no handler de danos aplicados.\n+Implementado detec\u00e7\u00e3o de skills recompensadas por quests al\u00e9m dos itens de skillbooks pelo anunciador.\n+Corrigido caso onde drops de quest n\u00e3o estavam aparecendo caso fossem \u00fanicos na lista de itens a aparecer e last hitter n\u00e3o precisasse dos mesmos.\n+\n+22 - 23 Novembro 2019,\n+Corrigido caso de jogador entrando em estado inconsistente com storage de jogadores ao mudar de mapas.\n+Corrigido bug no m\u00e9todo de checagem de quantidade de slots no invent\u00e1rio para m\u00faltiplos do mesmo equipamento.\n+Corrigido buff Final Attack de Cygnus sendo reaplicado a todo acerto de skill.\n+\n+24 - 25 Novembro 2019,\n+Corrigido caso n\u00e3o sendo checado devidamente com Maker.\n+Corrigido contagem de proj\u00e9teis nos stats de skill usando tipo de dados de tamanho insuficiente.\n+Refatorado acesso a membros relativos a Dojo em canais de forma a buscar melhorar efetividade dos ingressos e libera\u00e7\u00f5es de lobby.\n\\ No newline at end of file"}, {"sha": "9e790d89febe2ead8279a1154d727bbe9bbd6164", "filename": "scripts/event/CWKPQ.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/CWKPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/CWKPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/CWKPQ.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -242,8 +242,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -310,8 +310,8 @@ function playerRevive(eim, player) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "803d102bb918f8c99cafff51ff64d6aaefbaf33f", "filename": "scripts/event/HorntailBattle.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/HorntailBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/HorntailBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HorntailBattle.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -127,8 +127,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -156,8 +156,8 @@ function playerRevive(eim, player) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "0f1729087ed47b1b872b480b8b994ec353a20b8f", "filename": "scripts/event/PinkBeanBattle.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/PinkBeanBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/PinkBeanBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PinkBeanBattle.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -129,8 +129,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -170,8 +170,8 @@ function monsterRevive(eim, mob) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "5c678722b734a7557427edff25219766cdd1793e", "filename": "scripts/event/ScargaBattle.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ScargaBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ScargaBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ScargaBattle.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -113,8 +113,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -142,8 +142,8 @@ function playerRevive(eim, player) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "fb7087c412c05dd912b8267b3eefc0ef831249eb", "filename": "scripts/event/ShowaBattle.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ShowaBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ShowaBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ShowaBattle.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -120,8 +120,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -151,8 +151,8 @@ function playerRevive(eim, player) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "38df9109c72adf66d1b45422512ce20f8f55edbd", "filename": "scripts/event/ZakumBattle.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ZakumBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/event/ZakumBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ZakumBattle.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -117,8 +117,8 @@ function scheduledTimeout(eim) {\n function changedMap(eim, player, mapid) {\n     if (mapid < minMapId || mapid > maxMapId) {\n \tif (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             eim.unregisterPlayer(player);\n+            eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n             end(eim);\n         }\n         else {\n@@ -146,8 +146,8 @@ function playerRevive(eim, player) {\n \n function playerDisconnected(eim, player) {\n     if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n-        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         eim.unregisterPlayer(player);\n+        eim.dropMessage(5, \"[Expedition] Either the leader has quit the expedition or there is no longer the minimum number of members required to continue it.\");\n         end(eim);\n     }\n     else {"}, {"sha": "07c210d9ffa0d45275af1f917fd0a9130d29a904", "filename": "scripts/map/onFirstUserEnter/dojang_1st.js", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/map/onFirstUserEnter/dojang_1st.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/map/onFirstUserEnter/dojang_1st.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onFirstUserEnter/dojang_1st.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -31,15 +31,12 @@ function start(ms) {\n     var stage = Math.floor(ms.getMapId() / 100) % 100;\n     var callBoss = false;\n     \n-    if (stage % 6 == 1) {\n-        ms.getClient().getChannelServer().startDojoSchedule(ms.getMapId());\n-    } else if(stage % 6 == 0) {\n+    if (stage % 6 == 0) {\n         ms.getClient().getChannelServer().dismissDojoSchedule(ms.getMapId(), ms.getParty());\n-    }\n+        ms.getClient().getChannelServer().setDojoProgress(ms.getMapId());\n+    } else {\n+        callBoss = ms.getClient().getChannelServer().setDojoProgress(ms.getMapId());\n         \n-    callBoss = ms.getClient().getChannelServer().setDojoProgress(ms.getMapId());\n-    \n-    if (stage % 6 > 0) {\n         var realstage = stage - ((stage / 6) | 0);\n         var mob = ms.getMonsterLifeFactory(9300183 + realstage);\n         if (callBoss && mob != null && ms.getPlayer().getMap().getMonsterById(9300216) == null) {"}, {"sha": "f83b0fd997df0653ca713f69faa0fbbe91f6a26e", "filename": "scripts/npc/2091005.js", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -26,6 +26,7 @@\n */\n \n importPackage(Packages.config);\n+importPackage(Packages.constants.game);\n \n var disabled = false;\n var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);\n@@ -69,7 +70,7 @@ function action(mode, type, selection) {\n         if(status == 0) {\n             if (isRestingSpot(cm.getPlayer().getMap().getId())) {\n                 var text = \"I'm surprised you made it this far! But it won't be easy from here on out. You still want the challenge?\\r\\n\\r\\n#b#L0#I want to continue#l\\r\\n#L1#I want to leave#l\\r\\n\";\n-                if (!cm.getPlayer().getDojoParty()) {\n+                if (!GameConstants.isDojoPartyArea(cm.getPlayer().getMapId())) {\n                     text += \"#L2#I want to record my score up to this point#l\";\n                 }\n                 cm.sendSimple(text);\n@@ -99,15 +100,14 @@ function action(mode, type, selection) {\n                                     cm.dispose();\n                                     return;\n                                 } else {\n-                                    var avDojo = cm.getClient().getChannelServer().getAvailableDojo(true);\n+                                    var avDojo = cm.getClient().getChannelServer().ingressDojo(true, 0);\n \n                                     if(avDojo < 0) {\n                                         if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n                                         else cm.sendOk(\"Either your party is already using the Dojo or your party's allotted time on the Dojo has not expired yet. Wait for them to finish to enter.\");\n                                     }\n                                     else {\n                                         cm.getClient().getChannelServer().getMapFactory().getMap(925020010 + avDojo).resetMapObjects();\n-                                        cm.getClient().getChannelServer().resetDojo(925020010 + avDojo);\n                                         \n                                         cm.resetDojoEnergy();\n                                         cm.warp(925020010 + avDojo, 0);\n@@ -120,9 +120,11 @@ function action(mode, type, selection) {\n                         } else if (cm.getPlayer().getDojoStage() > 0) {\n                             dojoWarp = cm.getPlayer().getDojoStage();\n                             cm.getPlayer().setDojoStage(0);\n-                            cm.sendYesNo(\"The last time you took the challenge by yourself, you went up to level #b\" + dojoWarp + \"#k. I can take you there right now. Do you want to go there? (Select #rNo#k to erase this record.)\");\n+                            \n+                            var stageWarp = ((dojoWarp / 6) | 0) * 5;\n+                            cm.sendYesNo(\"The last time you took the challenge by yourself, you went up to round #b\" + stageWarp + \"#k. I can take you there right now. Do you want to go there? (Select #rNo#k to erase this record.)\");\n                         } else {\n-                            var avDojo = cm.getClient().getChannelServer().getAvailableDojo(false);\n+                            var avDojo = cm.getClient().getChannelServer().ingressDojo(false, dojoWarp);\n \n                             if(avDojo < 0) {\n                                 if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n@@ -132,7 +134,6 @@ function action(mode, type, selection) {\n                             } else {\n                                 var warpDojoMap = 925020000 + (dojoWarp + 1) * 100 + avDojo;\n                                 cm.getClient().getChannelServer().resetDojoMap(warpDojoMap);\n-                                cm.getClient().getChannelServer().resetDojo(warpDojoMap);\n                                 \n                                 cm.resetDojoEnergy();\n                                 cm.warp(warpDojoMap, 0);\n@@ -164,14 +165,13 @@ function action(mode, type, selection) {\n                             cm.dispose();\n                             return;\n                         } else {\n-                            var avDojo = cm.getClient().getChannelServer().getAvailableDojo(true, cm.getParty());\n+                            var avDojo = cm.getClient().getChannelServer().ingressDojo(true, cm.getParty(), 0);\n \n                             if(avDojo < 0) {\n                                 if(avDojo == -1) cm.sendOk(\"All Dojo's are being used already. Wait for awhile before trying again.\");\n                                 else cm.sendOk(\"Either your party is already using the Dojo or your party's allotted time on the Dojo has not expired yet. Wait for them to finish to enter.\");\n                             } else {\n                                 cm.getClient().getChannelServer().resetDojoMap(925030100 + avDojo);\n-                                cm.getClient().getChannelServer().resetDojo(925030100 + avDojo);\n                                 \n                                 cm.resetPartyDojoEnergy();\n                                 cm.warpParty(925030100 + avDojo);\n@@ -299,7 +299,7 @@ function action(mode, type, selection) {\n                             }\n                         }\n                         \n-                        avDojo = cm.getClient().getChannelServer().getAvailableDojo(hasParty, cm.getParty());\n+                        avDojo = cm.getClient().getChannelServer().ingressDojo(hasParty, cm.getParty(), Math.floor((cm.getPlayer().getMap().getId()) / 100) % 100);\n                         firstEnter = true;\n                     }\n \n@@ -313,7 +313,6 @@ function action(mode, type, selection) {\n                         var dojoWarpMap = baseStg + (nextStg * 100) + avDojo;\n                         if(firstEnter) {\n                             cm.getClient().getChannelServer().resetDojoMap(dojoWarpMap);\n-                            cm.getClient().getChannelServer().resetDojo(dojoWarpMap, nextStg - 1);\n                         }\n                         \n                         //non-leader party members can progress whilst having the record saved if they don't command to enter the next stage"}, {"sha": "d5b543ee88acf11fe5d2a752cfb3de45e2e634c1", "filename": "scripts/npc/2091005_old.js", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/2091005_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/2091005_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2091005_old.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -26,6 +26,8 @@\n * @Map(s): Dojo Hall\n */\n \n+importPackage(Packages.constants.game);\n+\n var disabled = false;\n var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);\n var belt_level = Array(25, 35, 45, 60, 75);\n@@ -45,7 +47,7 @@ function start() {\n \t\n     if (isRestingSpot(cm.getPlayer().getMap().getId())) {\n         var text = \"I'm surprised you made it this far! But it won't be easy from here on out. You still want the challenge?\\r\\n\\r\\n#b#L0#I want to continue#l\\r\\n#L1#I want to leave#l\\r\\n\";\n-        if (!cm.getPlayer().getDojoParty()) {\n+        if (!GameConstants.isDojoPartyArea(cm.getPlayer().getMapId())) {\n             text += \"#L2#I want to record my score up to this point#l\";\n         }\n         cm.sendSimple(text);"}, {"sha": "fe4770623fc3819012a923fe4b33953429e6c436", "filename": "scripts/npc/9000040.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/9000040.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/9000040.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000040.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -24,7 +24,7 @@\n         * @author Ronan Lana\n  */\n \n-importPackage(Packages.client.processor);\n+importPackage(Packages.client.processor.action);\n importPackage(Packages.config);\n \n var status;"}, {"sha": "3feffe777fa8dfbdb104acd9271ab5b259400951", "filename": "scripts/npc/9209000.js", "status": "modified", "additions": 35, "deletions": 15, "changes": 50, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/9209000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/9209000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9209000.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -87,30 +87,50 @@ function action(mode, type, selection) {\n         } else if(status == 1) {\n             var sendStr = \"The following books are currently available:\\r\\n\\r\\n\";\n             if(selected == 0) selected = selection;\n-\n-            table = (selected == 1) ? skillbook : masterybook;\n-            for(var i = 0; i < table.length; i++) {\n-                sendStr += \"  #L\" + i + \"# #i\" + table[i] + \"#  #t\" + table[i] + \"##l\\r\\n\";\n+            \n+            if (selected == 1) {\n+                table = skillbook;\n+                for(var i = 0; i < table.length; i++) {\n+                    if (table[i] > 0) {\n+                        var itemid = table[i];\n+                        sendStr += \"  #L\" + i + \"# #i\" + itemid + \"#  #t\" + itemid + \"##l\\r\\n\";\n+                    } else {\n+                        var skillid = -table[i];\n+                        sendStr += \"  #L\" + i + \"# #s\" + skillid + \"#  #q\" + skillid + \"##l\\r\\n\";\n+                    }\n+                }\n+            } else {\n+                table = masterybook;\n+                for(var i = 0; i < table.length; i++) {\n+                    var itemid = table[i];\n+                    sendStr += \"  #L\" + i + \"# #i\" + itemid + \"#  #t\" + itemid + \"##l\\r\\n\";\n+                }\n             }\n-\n+            \n             cm.sendSimple(sendStr);\n \n         } else if(status == 2) {\n             selected = selection;\n-            var mobList = cm.getNamesWhoDropsItem(table[selected]);\n-            \n+\n             var sendStr;\n-            if(mobList.length == 0) {\n-                sendStr = \"No mobs drop '#b#t\" + table[selected] + \"##k'.\\r\\n\\r\\n\";\n-            } else {\n-                sendStr = \"The following mobs drop '#b#t\" + table[selected] + \"##k':\\r\\n\\r\\n\";\n+            if (table[selected] > 0) {\n+                var mobList = cm.getNamesWhoDropsItem(table[selected]);\n+                \n+                if(mobList.length == 0) {\n+                    sendStr = \"No mobs drop '#b#t\" + table[selected] + \"##k'.\\r\\n\\r\\n\";\n+                } else {\n+                    sendStr = \"The following mobs drop '#b#t\" + table[selected] + \"##k':\\r\\n\\r\\n\";\n+\n+                    for(var i = 0; i < mobList.length; i++) {\n+                        sendStr += \"  #L\" + i + \"# \" + mobList[i] + \"#l\\r\\n\";\n+                    }\n \n-                for(var i = 0; i < mobList.length; i++) {\n-                    sendStr += \"  #L\" + i + \"# \" + mobList[i] + \"#l\\r\\n\";\n+                    sendStr += \"\\r\\n\";\n                 }\n-                \n-                sendStr += \"\\r\\n\";\n+            } else {\n+                sendStr = \"\\r\\n\\r\\n\";\n             }\n+            \n             sendStr += cm.getSkillBookInfo(table[selected]);\n \n             cm.sendNext(sendStr);"}, {"sha": "6bd080459f17a5f8673d3475cc7930b02323f82b", "filename": "scripts/npc/credits.js", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/credits.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/npc/credits.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/credits.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -13,7 +13,7 @@ var name_cursor, role_cursor;\n \n // new server names are to be appended at the start of the name stack, building up the chronology.\n // make sure the server names are lexicograffically equivalent to their correspondent function.\n-var servers = [\"HeavenMS\", \"MapleSolaxia\", \"MoopleDEV\", \"MetroMS\", \"BubblesDEV\", \"OdinMS\", \"Contributors\"];\n+var servers = [\"HeavenMS\", \"MapleSolaxia\", \"MoopleDEV\", \"BubblesDEV\", \"MetroMS\", \"OdinMS\", \"Contributors\"];\n var servers_history = [];\n \n function addPerson(name, role) {\n@@ -65,19 +65,19 @@ function writeServerStaff_MoopleDEV() {\n         setHistory(2010, 2012);\n }\n \n-function writeServerStaff_MetroMS() {\n+function writeServerStaff_BubblesDEV() {\n         addPerson(\"David!\", \"Developer\");\n+        addPerson(\"Moogra\", \"Developer\");\n         addPerson(\"XxOsirisxX\", \"Contributor\");\n-        addPerson(\"Generic\", \"Contributor\");\n+        addPerson(\"MrMysterious\", \"Contributor\");\n         \n         setHistory(2009, 2010);\n }\n \n-function writeServerStaff_BubblesDEV() {\n+function writeServerStaff_MetroMS() {\n         addPerson(\"David!\", \"Developer\");\n-        addPerson(\"Moogra\", \"Developer\");\n         addPerson(\"XxOsirisxX\", \"Contributor\");\n-        addPerson(\"MrMysterious\", \"Contributor\");\n+        addPerson(\"Generic\", \"Contributor\");\n         \n         setHistory(2009, 2009);\n }"}, {"sha": "31378e49b578804741ecedabd736b6a45c2776da", "filename": "scripts/portal/dojang_tuto.js", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/dojang_tuto.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/dojang_tuto.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/dojang_tuto.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -29,6 +29,8 @@ function enter(pi) {\n     if (pi.getPlayer().getMap().getMonsterById(9300216) != null) {\n         pi.getPlayer().enteredScript(\"dojang_Msg\", pi.getPlayer().getMap().getId());\n         pi.getPlayer().setFinishedDojoTutorial();\n+        pi.getClient().getChannelServer().resetDojo(pi.getPlayer().getMap().getId());\n+        pi.getClient().getChannelServer().dismissDojoSchedule(pi.getPlayer().getMap().getId(), pi.getParty());\n         pi.playPortalSound(); pi.warp(925020001, 0);\n         return true;\n     } else {"}, {"sha": "e3f60ef36f6e4903e4d2be9ee37648c963b8960a", "filename": "scripts/portal/dojang_up.js", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/dojang_up.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/dojang_up.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/dojang_up.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -25,14 +25,15 @@\n  * @maps:     All Dojo fighting maps\n */\n \n+importPackage(Packages.constants.game);\n \n function enter(pi) {\n     try {\n         if (pi.getPlayer().getMap().getMonsterById(9300216) != null) {\n             pi.goDojoUp();\n             pi.getPlayer().getMap().setReactorState();\n             var stage = Math.floor(pi.getPlayer().getMapId() / 100) % 100;\n-            if ((stage - (stage / 6) | 0) == pi.getPlayer().getVanquisherStage() && !pi.getPlayer().getDojoParty()) // we can also try 5 * stage / 6 | 0 + 1\n+            if ((stage - (stage / 6) | 0) == pi.getPlayer().getVanquisherStage() && !GameConstants.isDojoPartyArea(pi.getPlayer().getMapId())) // we can also try 5 * stage / 6 | 0 + 1\n                 pi.getPlayer().setVanquisherKills(pi.getPlayer().getVanquisherKills() + 1);\n         } else {\n             pi.getPlayer().message(\"There are still some monsters remaining.\");"}, {"sha": "d79ce0fcfd070ce12e53d682e18b647d19b47292", "filename": "scripts/portal/s4rush.js", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/s4rush.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/scripts/portal/s4rush.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/s4rush.js?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -25,15 +25,8 @@\n  */\n function enter(pi) {\n     if(pi.isQuestStarted(6110)) {\n-        if(pi.getWarpMap(910500100).countPlayers() == 0) {\n-            pi.resetMapObjects(910500100);\n-            pi.playPortalSound(); pi.warp(910500100, 0);\n-            \n-            return true;\n-        } else {\n-            pi.getPlayer().message(\"Some other player is currently inside.\");\n-            return false;\n-        }\n+        pi.playPortalSound(); pi.warp(910500100, 0);\n+        return true;\n     } else {\n         pi.getPlayer().message(\"A mysterious force won't let you in.\");\n         return false;"}, {"sha": "85f55c30f273b39ceb5bdae02bd6254a30078df9", "filename": "sql/db_database.sql", "status": "modified", "additions": 14, "deletions": 18, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -6013,7 +6013,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (7130000, 1072210, 1, 1, 0, 800),\n (7130000, 1002275, 1, 1, 0, 1500),\n (7130000, 1072177, 1, 1, 0, 800),\n-(7130000, 4161021, 1, 1, 0, 6000),\n+(7130000, 4161021, 1, 1, 0, 7000),\n (7130000, 1072312, 1, 1, 0, 800),\n (7130000, 2044901, 1, 1, 0, 300),\n (7130000, 2040419, 1, 1, 0, 300),\n@@ -7120,7 +7120,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8140102, 1452019, 1, 1, 0, 500),\n (8140102, 1382035, 1, 1, 0, 700),\n (8140102, 1432004, 1, 1, 0, 500),\n-(8140102, 4161015, 1, 1, 0, 6000),\n+(8140102, 4161015, 1, 1, 0, 7000),\n (8140102, 1002643, 1, 1, 0, 1500),\n (8140102, 2331000, 1, 1, 0, 500),\n (8140102, 2040321, 1, 1, 0, 300),\n@@ -7152,7 +7152,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8140103, 1322045, 1, 1, 0, 700),\n (8140103, 1412021, 1, 1, 0, 700),\n (8140103, 1432011, 1, 1, 0, 500),\n-(8140103, 4161016, 1, 1, 0, 6000),\n+(8140103, 4161016, 1, 1, 0, 7000),\n (8140103, 1492010, 1, 1, 0, 500),\n (8140103, 2332000, 1, 1, 0, 500),\n (8140103, 2044314, 1, 1, 0, 300),\n@@ -7713,7 +7713,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8150100, 2041013, 1, 1, 0, 300),\n (8150100, 1002366, 1, 1, 0, 1500),\n (8150100, 1072214, 1, 1, 0, 800),\n-(8150100, 4161018, 1, 1, 0, 6000),\n+(8150100, 4161018, 1, 1, 0, 7000),\n (8150100, 1072315, 1, 1, 0, 800),\n (8150100, 1052131, 1, 1, 0, 700),\n (8150100, 2044902, 1, 1, 0, 300),\n@@ -7745,7 +7745,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8150101, 1072223, 1, 1, 0, 800),\n (8150101, 2290042, 1, 1, 0, 500),\n (8150101, 2290052, 1, 1, 0, 500),\n-(8150101, 4161018, 1, 1, 0, 6000),\n+(8150101, 4161018, 1, 1, 0, 7000),\n (8150101, 1072318, 1, 1, 0, 800),\n (8150101, 2290102, 1, 1, 0, 500),\n (8150101, 2040420, 1, 1, 0, 300),\n@@ -10287,10 +10287,6 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8190000, 0, 800, 1200, 0, 400000),\n (8190002, 0, 900, 1300, 0, 400000),\n (9400545, 0, 600, 900, 0, 400000),\n-(9001000, 0, 200, 400, 0, 400000),\n-(9001001, 0, 200, 400, 0, 400000),\n-(9001002, 0, 200, 400, 0, 400000),\n-(9001003, 0, 200, 400, 0, 400000),\n (9420500, 0, 36, 54, 0, 400000),\n (9420502, 0, 30, 42, 0, 400000),\n (9420506, 0, 56, 69, 0, 400000),\n@@ -10735,14 +10731,14 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (8500002, 4031869, 1, 1, 6360, 999999),\n (8141000, 4031873, 1, 1, 6380, 60000),\n (8141100, 4031874, 1, 1, 6390, 60000),\n-(7130101, 4001112, 1, 1, 0, 1000),\n-(8170000, 4001112, 1, 1, 0, 1500),\n-(5130107, 4001107, 1, 1, 0, 1000),\n-(8143000, 4001107, 1, 1, 0, 1500),\n-(7160000, 4001110, 1, 1, 0, 1000),\n-(8150100, 4161018, 1, 1, 0, 1000),\n-(7130000, 4161021, 1, 1, 0, 1000),\n-(8150000, 4001111, 1, 1, 0, 999999),\n+(7130101, 4001112, 1, 1, 0, 7000),\n+(8170000, 4001112, 1, 1, 0, 7500),\n+(5130107, 4001107, 1, 1, 0, 7000),\n+(8143000, 4001107, 1, 1, 0, 7500),\n+(7160000, 4001110, 1, 1, 0, 7000),\n+(8150100, 4161018, 1, 1, 0, 7000),\n+(7130000, 4161021, 1, 1, 0, 7000),\n+(8150000, 4001111, 1, 1, 0, 700000),\n (8140000, 4031477, 1, 1, 0, 10000),\n (8170000, 4031453, 1, 1, 6291, 50000),\n (8160000, 4031474, 1, 1, 6295, 50000),\n@@ -20207,7 +20203,7 @@ INSERT INTO `shopitems` (`shopitemid`, `shopid`, `itemid`, `price`, `pitch`, `po\n (2755, 9201059, 1312005, 42500, 0, 156),\n (2756, 9201059, 1302068, 352500, 0, 160),\n (2757, 9201059, 1302008, 42500, 0, 164),\n-(2758, 9201060, 2010003, 100, 0, 104),\n+(2758, 9201060, 2010003, 100, 0, 178),\n (2759, 9201060, 2061000, 1, 0, 108),\n (2760, 9201060, 2060000, 1, 0, 112),\n (2761, 9201060, 2030000, 400, 0, 116),"}, {"sha": "a9eb80b99a3645ac1b6e749ce7a25fedb28dac86", "filename": "sql/db_drops.sql", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -20278,8 +20278,8 @@ USE `heavenms`;\n (4300008, 4032521, 1, 1, 2291, 120000),\n (4300009, 4032521, 1, 1, 2291, 120000),\n (4300010, 4032521, 1, 1, 2291, 120000),\n-(5130107, 4001207, 1, 1, 0, 2285),\n-(5130108, 4001207, 1, 1, 0, 2285),\n+(5130107, 4001207, 1, 1, 20402, 100000),\n+(5130108, 4001207, 1, 1, 20402, 100000),\n (9400506, 2020020, 1, 1, 0, 100000),\n (9400506, 4031217, 1, 1, 0, 40000),\n (9400507, 2020020, 1, 1, 0, 100000),\n@@ -22844,8 +22844,6 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (8220009, 0, 1479, 7280, 0, 400000),\n (8830000, 0, 2400, 11620, 0, 400000),\n (8830007, 0, 2400, 11620, 0, 400000),\n-(9001009, 0, 1254, 6170, 0, 400000),\n-(9001011, 0, 95, 140, 0, 400000),\n (9200016, 0, 81, 119, 0, 400000),\n (9200019, 0, 203, 299, 0, 400000),\n (9300011, 0, 109, 160, 0, 400000),\n@@ -22959,9 +22957,7 @@ DELETE FROM temp_data WHERE dropperid >= 9300315 AND dropperid <= 9300324;\n (9300269, 0, 174, 850, 0, 400000),\n (9300270, 0, 418, 617, 0, 400000),\n (9300274, 0, 39, 57, 0, 400000),\n-(9300289, 0, 1704, 8530, 0, 400000),\n-(9300294, 0, 2142, 10490, 0, 400000),\n-(9300315, 0, 483, 2370, 0, 400000),\n+(9300315, 0, 483, 2370, 0, 400000),\t# thanks Vcoc for noticing some Cygnus questline bosses dropping mesos\n (9300316, 0, 516, 2540, 0, 400000),\n (9300317, 0, 552, 2710, 0, 400000),\n (9300318, 0, 588, 2890, 0, 400000),"}, {"sha": "f23d08e6c059cbd41e786a68f83ca5cab7aeb58c", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 30, "deletions": 23, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -144,6 +144,7 @@\n import constants.game.ExpTable;\n import constants.game.GameConstants;\n import constants.inventory.ItemConstants;\n+import constants.net.ServerConstants;\n import constants.skills.Aran;\n import constants.skills.Beginner;\n import constants.skills.Bishop;\n@@ -279,8 +280,8 @@\n     private Map<Integer, MapleSummon> summons = new LinkedHashMap<>();\n     private Map<Integer, MapleCoolDownValueHolder> coolDowns = new LinkedHashMap<>();\n     private EnumMap<MapleDisease, Pair<MapleDiseaseValueHolder, MobSkill>> diseases = new EnumMap<>(MapleDisease.class);\n-    public byte[] m_aQuickslotLoaded;\n-    public MapleQuickslotBinding m_pQuickslotKeyMapped;\n+    private byte[] m_aQuickslotLoaded;\n+    private MapleQuickslotBinding m_pQuickslotKeyMapped;\n     private MapleDoor pdoor = null;\n     private Map<MapleQuest, Long> questExpirations = new LinkedHashMap<>();\n     private ScheduledFuture<?> dragonBloodSchedule;\n@@ -678,7 +679,7 @@ public int addDojoPointsByMap(int mapid) {\n         int pts = 0;\n         if (dojoPoints < 17000) {\n             pts = 1 + ((mapid - 1) / 100 % 100) / 6;\n-            if (!getDojoParty()) {\n+            if (!GameConstants.isDojoPartyArea(this.getMapId())) {\n                 pts++;\n             }\n             this.dojoPoints += pts;\n@@ -1322,6 +1323,10 @@ public void changeKeybinding(int key, MapleKeyBinding keybinding) {\n         }\n     }\n     \n+    public void changeQuickslotKeybinding(byte[] aQuickslotKeyMapped) {\n+        this.m_pQuickslotKeyMapped = new MapleQuickslotBinding(aQuickslotKeyMapped);\n+    }\n+    \n     public void broadcastStance(int newStance) {\n         setStance(newStance);\n         broadcastStance();\n@@ -1820,6 +1825,8 @@ private void changeMapInternal(final MapleMap to, final Point pos, final byte[]\n             }\n         } else {\n             FilePrinter.printError(FilePrinter.MAPLE_MAP, \"Character \" + this.getName() + \" got stuck when moving to map \" + map.getId() + \".\");\n+            client.disconnect(true, false);     // thanks BHB for noticing a player storage stuck case here\n+            return;\n         }\n         \n         notifyMapTransferToPartner(map.getId());\n@@ -2804,9 +2811,7 @@ public void dispelDebuffs() {\n         dispelDebuff(MapleDisease.POISON);\n         dispelDebuff(MapleDisease.SEAL);\n         dispelDebuff(MapleDisease.WEAKEN);\n-        dispelDebuff(MapleDisease.SLOW);\n-        dispelDebuff(MapleDisease.ZOMBIFY);\n-        dispelDebuff(MapleDisease.CONFUSE);\n+        dispelDebuff(MapleDisease.SLOW);    // thanks Conrad for noticing ZOMBIFY isn't dispellable\n     }\n \n     public void cancelAllDebuffs() {\n@@ -4772,10 +4777,6 @@ public int getDojoEnergy() {\n         return dojoEnergy;\n     }\n \n-    public boolean getDojoParty() {\n-        return mapid >= 925030100 && mapid < 925040000;\n-    }\n-\n     public int getDojoPoints() {\n         return dojoPoints;\n     }\n@@ -5322,6 +5323,14 @@ public int getMapId() {\n     public MapleRing getMarriageRing() {\n         return partnerId > 0 ? marriageRing : null;\n     }\n+    \n+    public int getMasterLevel(int skill) {\n+        SkillEntry ret = skills.get(SkillFactory.getSkill(skill));\n+        if (ret == null) {\n+            return 0;\n+        }\n+        return ret.masterlevel;\n+    }\n \n     public int getMasterLevel(Skill skill) {\n         if (skills.get(skill) == null) {\n@@ -8351,9 +8360,9 @@ public final boolean insertNewChar(CharacterFactoryRecipe recipe) {\n             ps.close();\n             \n             // No quickslots, or no change.\n-            boolean bQuickslotEquals = this.m_pQuickslotKeyMapped == null || (this.m_aQuickslotLoaded != null && Arrays.equals(this.m_pQuickslotKeyMapped.m_aQuickslotKeyMapped, this.m_aQuickslotLoaded));\n+            boolean bQuickslotEquals = this.m_pQuickslotKeyMapped == null || (this.m_aQuickslotLoaded != null && Arrays.equals(this.m_pQuickslotKeyMapped.GetKeybindings(), this.m_aQuickslotLoaded));\n             if (!bQuickslotEquals) {\n-                long nQuickslotKeymapped = LongTool.BytesToLong(this.m_pQuickslotKeyMapped.m_aQuickslotKeyMapped);\n+                long nQuickslotKeymapped = LongTool.BytesToLong(this.m_pQuickslotKeyMapped.GetKeybindings());\n                 \n                 try (final PreparedStatement pInsertStatement = con.prepareStatement(\"INSERT INTO quickslotkeymapped (accountid, keymap) VALUES (?, ?) ON DUPLICATE KEY UPDATE keymap = ?;\")) {\n                     pInsertStatement.setInt(1, this.getAccountID());\n@@ -8616,9 +8625,9 @@ public synchronized void saveCharToDB(boolean notAutosave) {\n             ps.close();\n             \n             // No quickslots, or no change.\n-            boolean bQuickslotEquals = this.m_pQuickslotKeyMapped == null || (this.m_aQuickslotLoaded != null && Arrays.equals(this.m_pQuickslotKeyMapped.m_aQuickslotKeyMapped, this.m_aQuickslotLoaded));\n+            boolean bQuickslotEquals = this.m_pQuickslotKeyMapped == null || (this.m_aQuickslotLoaded != null && Arrays.equals(this.m_pQuickslotKeyMapped.GetKeybindings(), this.m_aQuickslotLoaded));\n             if (!bQuickslotEquals) {\n-                long nQuickslotKeymapped = LongTool.BytesToLong(this.m_pQuickslotKeyMapped.m_aQuickslotKeyMapped);\n+                long nQuickslotKeymapped = LongTool.BytesToLong(this.m_pQuickslotKeyMapped.GetKeybindings());\n                 \n                 try (final PreparedStatement pInsertStatement = con.prepareStatement(\"INSERT INTO quickslotkeymapped (accountid, keymap) VALUES (?, ?) ON DUPLICATE KEY UPDATE keymap = ?;\")) {\n                     pInsertStatement.setInt(1, this.getAccountID());\n@@ -9214,9 +9223,11 @@ public boolean applyHpMpChange(int hpCon, int hpchange, int mpchange) {\n             MapleKeyBinding autohpPot = this.getKeymap().get(91);\n             if (autohpPot != null) {\n                 int autohpItemid = autohpPot.getAction();\n-                if (((float) this.getHp()) / this.getCurrentMaxHp() <= this.getAutopotHpAlert()) { // try within user settings... thanks Lame, Optimist, Stealth2800\n+                float autohpAlert = this.getAutopotHpAlert();\n+                if (((float) this.getHp()) / this.getCurrentMaxHp() <= autohpAlert) { // try within user settings... thanks Lame, Optimist, Stealth2800\n                     Item autohpItem = this.getInventory(MapleInventoryType.USE).findById(autohpItemid);\n                     if (autohpItem != null) {\n+                        this.setAutopotHpAlert(0.9f * autohpAlert);\n                         PetAutopotProcessor.runAutopotAction(client, autohpItem.getPosition(), autohpItemid);\n                     }\n                 }\n@@ -9227,9 +9238,11 @@ public boolean applyHpMpChange(int hpCon, int hpchange, int mpchange) {\n             MapleKeyBinding autompPot = this.getKeymap().get(92);\n             if (autompPot != null) {\n                 int autompItemid = autompPot.getAction();\n-                if (((float) this.getMp()) / this.getCurrentMaxMp() <= this.getAutopotMpAlert()) {\n+                float autompAlert = this.getAutopotMpAlert();\n+                if (((float) this.getMp()) / this.getCurrentMaxMp() <= autompAlert) {\n                     Item autompItem = this.getInventory(MapleInventoryType.USE).findById(autompItemid);\n                     if (autompItem != null) {\n+                        this.setAutopotMpAlert(0.9f * autompAlert); // autoMP would stick to using pots at every depletion in some cases... thanks Rohenn\n                         PetAutopotProcessor.runAutopotAction(client, autompItem.getPosition(), autompItemid);\n                     }\n                 }\n@@ -9689,17 +9702,11 @@ private long getDojoTimeLeft() {\n     }\n     \n     public void showDojoClock() {\n-        if (map.isDojoFightMap()) {\n+        if (GameConstants.isDojoBossArea(map.getId())) {\n             client.announce(MaplePacketCreator.getClock((int) (getDojoTimeLeft() / 1000)));\n         }\n     }\n     \n-    public void timeoutFromDojo() {\n-        if(map.isDojoMap()) {\n-            client.getPlayer().changeMap(client.getChannelServer().getMapFactory().getMap(925020002));\n-        }\n-    }\n-    \n     public void showUnderleveledInfo(MapleMonster mob) {\n         long curTime = Server.getInstance().getCurrentTime();\n         if(nextWarningTime < curTime) {"}, {"sha": "f910a4d903acb6f54ee8642a21e86a7d1b3b4063", "filename": "src/client/inventory/MapleInventory.java", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/inventory/MapleInventory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/inventory/MapleInventory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventory.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -25,12 +25,14 @@\n import java.util.Collection;\n import java.util.Collections;\n import java.util.Comparator;\n+import java.util.HashSet;\n import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map.Entry;\n import java.util.Map;\n+import java.util.Set;\n import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n \n@@ -448,6 +450,20 @@ public short getNumFreeSlot() {\n         }\n     }\n     \n+    private static boolean checkItemRestricted(List<Pair<Item, MapleInventoryType>> items) {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        \n+        Set<Integer> itemids = new HashSet<>();\n+        for (Pair<Item, MapleInventoryType> p : items) {\n+            int itemid = p.getLeft().getItemId();\n+            if (ii.isPickupRestricted(itemid) && (p.getLeft().getQuantity() > 1 || !itemids.add(itemid))) {\n+                return false;\n+            }\n+        }\n+        \n+        return true;\n+    }\n+    \n     public static boolean checkSpot(MapleCharacter chr, Item item) {    // thanks Vcoc for noticing pshops not checking item stacks when taking item back\n         return checkSpot(chr, Collections.singletonList(item));\n     }\n@@ -476,6 +492,10 @@ public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInvent\n     public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed, boolean useProofInv) {\n         // assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0.\n         \n+        if (!checkItemRestricted(items)) {\n+            return false;\n+        }\n+        \n         Map<Integer, List<Integer>> rcvItems = new LinkedHashMap<>();\n         Map<Integer, Byte> rcvTypes = new LinkedHashMap<>();\n         \n@@ -490,7 +510,7 @@ public static boolean checkSpots(MapleCharacter chr, List<Pair<Item, MapleInvent\n                         rcvItems.put(itemId, itemQtyList);\n                         rcvTypes.put(itemId, item.right.getType());\n                 } else {\n-                        if (!ItemConstants.isRechargeable(itemId)) {\n+                        if (!ItemConstants.isEquipment(itemId) && !ItemConstants.isRechargeable(itemId)) {\n                                 qty.set(0, qty.get(0) + item.left.getQuantity());\n                         } else {\n                                 qty.add((int) item.left.getQuantity());\n@@ -548,6 +568,10 @@ public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item,\n     public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item, MapleInventoryType>> items, List<Integer> typesSlotsUsed, boolean useProofInv) {\n         //assumption: no \"UNDEFINED\" or \"EQUIPPED\" items shall be tested here, all counts are >= 0 and item list to be checked is a legal one.\n         \n+        if (!checkItemRestricted(items)) {\n+            return false;\n+        }\n+        \n         Map<Long, List<Integer>> rcvItems = new LinkedHashMap<>();\n         Map<Long, Byte> rcvTypes = new LinkedHashMap<>();\n         Map<Long, String> rcvOwners = new LinkedHashMap<>();\n@@ -565,7 +589,7 @@ public static boolean checkSpotsAndOwnership(MapleCharacter chr, List<Pair<Item,\n                         rcvOwners.put(itemHash, item.left.getOwner());\n                 } else {\n                          // thanks BHB88 for pointing out an issue with rechargeable items being stacked on inventory check\n-                        if (!ItemConstants.isRechargeable(item.left.getItemId())) {\n+                        if (!ItemConstants.isEquipment(item.left.getItemId()) && !ItemConstants.isRechargeable(item.left.getItemId())) {\n                                 qty.set(0, qty.get(0) + item.left.getQuantity());\n                         } else {\n                                 qty.add((int) item.left.getQuantity());"}, {"sha": "14428fd4b040505e6aad405e1af28183e87e3121", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -106,7 +106,7 @@ private static boolean addByIdInternal(MapleClient c, MapleCharacter chr, MapleI\n                     }\n                 }\n                 boolean sandboxItem = (flag & ItemConstants.SANDBOX) == ItemConstants.SANDBOX;\n-                while (quantity > 0 || ItemConstants.isRechargeable(itemId)) {\n+                while (quantity > 0) {\n                     short newQ = (short) Math.min(quantity, slotMax);\n                     if (newQ != 0) {\n                         quantity -= newQ;\n@@ -124,9 +124,6 @@ private static boolean addByIdInternal(MapleClient c, MapleCharacter chr, MapleI\n                         }\n                         c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, nItem))));\n                         if(sandboxItem) chr.setHasSandboxItem();\n-                        if ((ItemConstants.isRechargeable(itemId)) && quantity == 0) {\n-                            break;\n-                        }\n                     } else {\n                         c.announce(MaplePacketCreator.enableActions());\n                         return false;\n@@ -189,18 +186,18 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n     \n     private static boolean addFromDropInternal(MapleClient c, MapleCharacter chr, MapleInventoryType type, MapleInventory inv, Item item, boolean show, int petId) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        \n-        if (ii.isPickupRestricted(item.getItemId()) && chr.haveItemWithId(item.getItemId(), true)) {\n+        int itemid = item.getItemId();\n+        if (ii.isPickupRestricted(itemid) && chr.haveItemWithId(itemid, true)) {\n             c.announce(MaplePacketCreator.getInventoryFull());\n             c.announce(MaplePacketCreator.showItemUnavailable());\n             return false;\n         }\n         short quantity = item.getQuantity();\n \n         if (!type.equals(MapleInventoryType.EQUIP)) {\n-            short slotMax = ii.getSlotMax(c, item.getItemId());\n-            List<Item> existing = inv.listById(item.getItemId());\n-            if (!ItemConstants.isRechargeable(item.getItemId()) && petId == -1) {\n+            short slotMax = ii.getSlotMax(c, itemid);\n+            List<Item> existing = inv.listById(itemid);\n+            if (!ItemConstants.isRechargeable(itemid) && petId == -1) {\n                 if (existing.size() > 0) { // first update all existing slots to slotMax\n                     Iterator<Item> i = existing.iterator();\n                     while (quantity > 0) {\n@@ -222,7 +219,7 @@ private static boolean addFromDropInternal(MapleClient c, MapleCharacter chr, Ma\n                 while (quantity > 0) {\n                     short newQ = (short) Math.min(quantity, slotMax);\n                     quantity -= newQ;\n-                    Item nItem = new Item(item.getItemId(), (short) 0, newQ, petId);\n+                    Item nItem = new Item(itemid, (short) 0, newQ, petId);\n                     nItem.setExpiration(item.getExpiration());\n                     nItem.setOwner(item.getOwner());\n                     nItem.setFlag(item.getFlag());\n@@ -239,7 +236,7 @@ private static boolean addFromDropInternal(MapleClient c, MapleCharacter chr, Ma\n                     if (MapleInventoryManipulator.isSandboxItem(nItem)) chr.setHasSandboxItem();\n                 }\n             } else {\n-                Item nItem = new Item(item.getItemId(), (short) 0, quantity, petId);\n+                Item nItem = new Item(itemid, (short) 0, quantity, petId);\n                 nItem.setExpiration(item.getExpiration());\n                 nItem.setFlag(item.getFlag());\n \n@@ -266,13 +263,13 @@ private static boolean addFromDropInternal(MapleClient c, MapleCharacter chr, Ma\n             c.announce(MaplePacketCreator.modifyInventory(true, Collections.singletonList(new ModifyInventory(0, item))));\n             if (MapleInventoryManipulator.isSandboxItem(item)) chr.setHasSandboxItem();\n         } else {\n-            FilePrinter.printError(FilePrinter.ITEM, \"Tried to pickup Equip id \" + item.getItemId() + \" containing more than 1 quantity --> \" + quantity);\n+            FilePrinter.printError(FilePrinter.ITEM, \"Tried to pickup Equip id \" + itemid + \" containing more than 1 quantity --> \" + quantity);\n             c.announce(MaplePacketCreator.getInventoryFull());\n             c.announce(MaplePacketCreator.showItemUnavailable());\n             return false;\n         }\n         if (show) {\n-            c.announce(MaplePacketCreator.getShowItemGain(item.getItemId(), item.getQuantity()));\n+            c.announce(MaplePacketCreator.getShowItemGain(itemid, item.getQuantity()));\n         }\n         return true;\n     }"}, {"sha": "f592774abb5dbd3d4ce23980974d56da64d0b84e", "filename": "src/client/keybind/MapleQuickslotBinding.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/keybind/MapleQuickslotBinding.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/keybind/MapleQuickslotBinding.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/keybind/MapleQuickslotBinding.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -17,7 +17,7 @@\n             0x2A, 0x52, 0x47, 0x49, 0x1D, 0x53, 0x4F, 0x51\n     };\n \n-    public byte[] m_aQuickslotKeyMapped;\n+    private byte[] m_aQuickslotKeyMapped;\n \n     // Initializes quickslot object for the user.\n     // aKeys' length has to be 8.\n@@ -52,4 +52,9 @@ public void Encode(MaplePacketLittleEndianWriter oPacket)\n             oPacket.writeInt(nKey);\n         }\n     }\n+    \n+    public byte[] GetKeybindings() {\n+        return m_aQuickslotKeyMapped;\n+    }\n+    \n }\n\\ No newline at end of file"}, {"sha": "4ce7f25b1b9a28dd92dcd626cc46fed6e2cb573e", "filename": "src/client/processor/action/MakerProcessor.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/processor/action/MakerProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/client/processor/action/MakerProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/action/MakerProcessor.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -308,7 +308,7 @@ public static int getMakerSkillLevel(MapleCharacter chr) {\n     }\n     \n     private static short getCreateStatus(MapleClient c, MakerItemCreateEntry recipe) {\n-        if(recipe == null) {\n+        if(recipe.isInvalid()) {\n             return -1;\n         }\n         "}, {"sha": "e916af64bf2755d031bc86ae754f5e4385b59edb", "filename": "src/constants/game/GameConstants.java", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/constants/game/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/constants/game/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/game/GameConstants.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -585,6 +585,15 @@ public static boolean isDojo(int mapid) {\n         return mapid >= 925020000 && mapid < 925040000;\n     }\n     \n+    public static boolean isDojoPartyArea(int mapid) {\n+    \treturn mapid >= 925030100 && mapid < 925040000;\n+    }\n+    \n+    public static boolean isDojoBossArea(int mapid) {\n+        return isDojo(mapid) && (((mapid / 100) % 100) % 6) > 0;\n+    }\n+    \n+    \n     public static boolean isPyramid(int mapid) {\n     \treturn mapid >= 926010010 & mapid <= 930010000;\n     }"}, {"sha": "108ad0491c8446a7caf9a9efe8595fc2b0098e1f", "filename": "src/net/server/Server.java", "status": "modified", "additions": 102, "deletions": 71, "changes": 173, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -320,42 +320,52 @@ private String getIP(int world, int channel) {\n     \n     \n     private void dumpData() {\n-        wldWLock.lock();\n+        wldRLock.lock();\n         try {\n             System.out.println(worlds);\n             System.out.println(channels);\n             System.out.println(worldRecommendedList);\n             System.out.println();\n             System.out.println(\"---------------------\");\n         } finally {\n-            wldWLock.unlock();\n+            wldRLock.unlock();\n         }\n     }\n     \n     public int addChannel(int worldid) {\n-        wldWLock.lock();\n+        World world;\n+        Map<Integer, String> channelInfo;\n+        int channelid;\n+        \n+        wldRLock.lock();\n         try {\n             if(worldid >= worlds.size()) return -3;\n             \n-            Map<Integer, String> worldChannels = channels.get(worldid);\n-            if(worldChannels == null) return -3;\n+            channelInfo = channels.get(worldid);\n+            if(channelInfo == null) return -3;\n             \n-            int channelid = worldChannels.size();\n+            channelid = channelInfo.size();\n             if(channelid >= YamlConfig.config.server.CHANNEL_SIZE) return -2;\n             \n             channelid++;\n-            World world = this.getWorld(worldid);\n-            Channel channel = new Channel(worldid, channelid, getCurrentTime());\n-\n-            channel.setServerMessage(YamlConfig.config.worlds.get(worldid).why_am_i_recommended);\n-            \n-            world.addChannel(channel);\n-            worldChannels.put(channelid, channel.getIP());\n-            \n-            return channelid;\n+            world = this.getWorld(worldid);\n         } finally {\n-            wldWLock.unlock();\n+            wldRLock.unlock();\n         }\n+        \n+        Channel channel = new Channel(worldid, channelid, getCurrentTime());\n+        channel.setServerMessage(YamlConfig.config.worlds.get(worldid).why_am_i_recommended);\n+        \n+        if (world.addChannel(channel)) {\n+            wldWLock.lock();\n+            try {\n+                channelInfo.put(channelid, channel.getIP());\n+            } finally {\n+                wldWLock.unlock();\n+            }\n+        }\n+        \n+        return channelid;\n     }\n     \n     public int addWorld() {\n@@ -380,73 +390,96 @@ public int addWorld() {\n     }\n     \n     private int initWorld() {\n-        wldWLock.lock();\n+        int i;\n+        \n+        wldRLock.lock();\n         try {\n-            int i = worlds.size();\n+            i = worlds.size();\n             \n             if(i >= YamlConfig.config.server.WLDLIST_SIZE) {\n                 return -1;\n             }\n-            \n-            System.out.println(\"Starting world \" + i);\n-\n-            int exprate = YamlConfig.config.worlds.get(i).exp_rate;\n-            int mesorate = YamlConfig.config.worlds.get(i).meso_rate;\n-            int droprate = YamlConfig.config.worlds.get(i).drop_rate;\n-            int bossdroprate = YamlConfig.config.worlds.get(i).boss_drop_rate;\n-            int questrate = YamlConfig.config.worlds.get(i).quest_rate;\n-            int travelrate = YamlConfig.config.worlds.get(i).travel_rate;\n-            int fishingrate = YamlConfig.config.worlds.get(i).fishing_rate;\n-\n-            int flag = YamlConfig.config.worlds.get(i).flag;\n-            String event_message = YamlConfig.config.worlds.get(i).event_message;\n-            String why_am_i_recommended = YamlConfig.config.worlds.get(i).why_am_i_recommended;\n-            \n-            World world = new World(i,\n-                    flag,\n-                    event_message,\n-                    exprate, droprate, bossdroprate, mesorate, questrate, travelrate, fishingrate);\n-\n-            worldRecommendedList.add(new Pair<>(i, why_am_i_recommended));\n-            worlds.add(world);\n-\n-            Map<Integer, String> channelInfo = new HashMap<>();\n-            long bootTime = getCurrentTime();\n-            for (int j = 1; j <= YamlConfig.config.worlds.get(i).channels; j++) {\n-                int channelid = j;\n-                Channel channel = new Channel(i, channelid, bootTime);\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+        \n+        System.out.println(\"Starting world \" + i);\n+\n+        int exprate = YamlConfig.config.worlds.get(i).exp_rate;\n+        int mesorate = YamlConfig.config.worlds.get(i).meso_rate;\n+        int droprate = YamlConfig.config.worlds.get(i).drop_rate;\n+        int bossdroprate = YamlConfig.config.worlds.get(i).boss_drop_rate;\n+        int questrate = YamlConfig.config.worlds.get(i).quest_rate;\n+        int travelrate = YamlConfig.config.worlds.get(i).travel_rate;\n+        int fishingrate = YamlConfig.config.worlds.get(i).fishing_rate;\n+\n+        int flag = YamlConfig.config.worlds.get(i).flag;\n+        String event_message = YamlConfig.config.worlds.get(i).event_message;\n+        String why_am_i_recommended = YamlConfig.config.worlds.get(i).why_am_i_recommended;\n+\n+        World world = new World(i,\n+                flag,\n+                event_message,\n+                exprate, droprate, bossdroprate, mesorate, questrate, travelrate, fishingrate);\n+        \n+        Map<Integer, String> channelInfo = new HashMap<>();\n+        long bootTime = getCurrentTime();\n+        for (int j = 1; j <= YamlConfig.config.worlds.get(i).channels; j++) {\n+            int channelid = j;\n+            Channel channel = new Channel(i, channelid, bootTime);\n \n-                world.addChannel(channel);\n-                channelInfo.put(channelid, channel.getIP());\n+            world.addChannel(channel);\n+            channelInfo.put(channelid, channel.getIP());\n+        }\n+        \n+        boolean canDeploy;\n+        \n+        wldWLock.lock();\t// thanks Ashen for noticing a deadlock issue when trying to deploy a channel\n+        try {\n+            canDeploy = world.getId() == worlds.size();\n+            if (canDeploy) {\n+                worldRecommendedList.add(new Pair<>(i, why_am_i_recommended));\n+                worlds.add(world);\n+                channels.add(i, channelInfo);\n             }\n-\n-            channels.add(i, channelInfo);\n-\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+        \n+        if (canDeploy) {\n             world.setServerMessage(YamlConfig.config.worlds.get(i).server_message);\n-            System.out.println(\"Finished loading world \" + i + \"\\r\\n\");\n             \n+            System.out.println(\"Finished loading world \" + i + \"\\r\\n\");\n             return i;\n-        } finally {\n-            wldWLock.unlock();\n+        } else {\n+            System.out.println(\"Could not load world \" + i + \"...\\r\\n\");\n+            world.shutdown();\n+            return -2;\n         }\n     }\n     \n     public boolean removeChannel(int worldid) {   //lol don't!\n-        wldWLock.lock();\n+        World world;\n+        \n+        wldRLock.lock();\n         try {\n             if(worldid >= worlds.size()) return false;\n-            \n-            World world = worlds.get(worldid);\n-            if (world != null) {\n-                int channel = world.removeChannel();\n-\n+            world = worlds.get(worldid);\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+        \n+        if (world != null) {\n+            int channel = world.removeChannel();\n+            wldWLock.lock();\n+            try {\n                 Map<Integer, String> m = channels.get(worldid);\n                 if(m != null) m.remove(channel);\n-                \n-                return channel > -1;\n+            } finally {\n+                wldWLock.unlock();\n             }\n-        } finally {\n-            wldWLock.unlock();\n+\n+            return channel > -1;\n         }\n         \n         return false;\n@@ -472,17 +505,15 @@ public boolean removeWorld() {   //lol don't!\n             return false;\n         }\n         \n+        removeWorldPlayerRanking();\n+        w.shutdown();\n+        \n         wldWLock.lock();\n         try {\n-            if(worldid == worlds.size() - 1) {\n-                removeWorldPlayerRanking();\n-                w.shutdown();\n-                \n+            if (worldid == worlds.size() - 1) {\n                 worlds.remove(worldid);\n                 channels.remove(worldid);\n                 worldRecommendedList.remove(worldid);\n-            } else {\n-                return false;\n             }\n         } finally {\n             wldWLock.unlock();\n@@ -714,7 +745,7 @@ private void removeWorldPlayerRanking() {\n         if (!YamlConfig.config.server.USE_WHOLE_SERVER_RANKING) {\n             wldWLock.lock();\n             try {\n-                if(playerRanking.size() < this.getWorldsSize()) {\n+                if(playerRanking.size() < worlds.size()) {\n                     return;\n                 }\n                 "}, {"sha": "9d3ff78bd54a81359cf65e0906efab7b163af607", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 99, "deletions": 65, "changes": 164, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -67,6 +67,7 @@\n import org.apache.mina.transport.socket.nio.NioSocketAcceptor;\n \n import client.MapleCharacter;\n+import constants.game.GameConstants;\n import net.server.services.ServicesManager;\n import net.server.services.BaseService;\n import net.server.services.type.ChannelServices;\n@@ -97,18 +98,18 @@\n     private final Map<Integer, Integer> storedVars = new HashMap<>();\n     private Set<Integer> playersAway = new HashSet<>();\n     private Map<MapleExpeditionType, MapleExpedition> expeditions = new HashMap<>();\n+    private Map<Integer, MapleMiniDungeon> dungeons = new HashMap<>();\n     private List<MapleExpeditionType> expedType = new ArrayList<>();\n     private Set<MapleMap> ownedMaps = Collections.synchronizedSet(Collections.newSetFromMap(new WeakHashMap<MapleMap, Boolean>()));\n     private MapleEvent event;\n     private boolean finishedShutdown = false;\n-    private int usedDojo = 0;\n     private Set<Integer> usedMC = new HashSet<>();\n     \n+    private int usedDojo = 0;\n     private int[] dojoStage;\n     private long[] dojoFinishTime;\n     private ScheduledFuture<?>[] dojoTask;\n     private Map<Integer, Integer> dojoParty = new HashMap<>();\n-    private Map<Integer, MapleMiniDungeon> dungeons = new HashMap<>();\n     \n     private List<Integer> chapelReservationQueue = new LinkedList<>();\n     private List<Integer> cathedralReservationQueue = new LinkedList<>();\n@@ -226,11 +227,16 @@ private void closeChannelServices() {\n     }\n     \n     private void closeChannelSchedules() {\n-        for(int i = 0; i < 20; i++) {\n-            if(dojoTask[i] != null) {\n-                dojoTask[i].cancel(false);\n-                dojoTask[i] = null;\n+        lock.lock();\n+        try {\n+            for(int i = 0; i < dojoTask.length; i++) {\n+                if(dojoTask[i] != null) {\n+                    dojoTask[i].cancel(false);\n+                    dojoTask[i] = null;\n+                }\n             }\n+        } finally {\n+            lock.unlock();\n         }\n         \n         closeChannelServices();\n@@ -493,57 +499,74 @@ public void setStoredVar(int key, int val) {\n         this.storedVars.put(key, val);\n     }\n     \n-    public synchronized int lookupPartyDojo(MapleParty party) {\n+    public int lookupPartyDojo(MapleParty party) {\n         if(party == null) return -1;\n         \n         Integer i = dojoParty.get(party.hashCode());\n         return (i != null) ? i : -1;\n     }\n     \n-    public int getAvailableDojo(boolean isPartyDojo) {\n-        return getAvailableDojo(isPartyDojo, null);\n+    public int ingressDojo(boolean isPartyDojo, int fromStage) {\n+        return ingressDojo(isPartyDojo, null, fromStage);\n     }\n     \n-    public synchronized int getAvailableDojo(boolean isPartyDojo, MapleParty party) {\n-        int dojoList = this.usedDojo;\n-        int range, slot = 0;\n-        \n-        if(!isPartyDojo) {\n-            dojoList = dojoList >> 5;\n-            range = 15;\n-        } else {\n-            range = 5;\n-        }\n-        \n-        while((dojoList & 1) != 0) {\n-            dojoList = (dojoList >> 1);\n-            slot++;\n-        }\n-        \n-        if(slot < range) {\n-            if(party != null) {\n-                if(dojoParty.containsKey(party.hashCode())) return -2;\n-                dojoParty.put(party.hashCode(), slot);\n+    public int ingressDojo(boolean isPartyDojo, MapleParty party, int fromStage) {\n+        lock.lock();\n+        try {\n+            int dojoList = this.usedDojo;\n+            int range, slot = 0;\n+\n+            if(!isPartyDojo) {\n+                dojoList = dojoList >> 5;\n+                range = 15;\n+            } else {\n+                range = 5;\n             }\n+\n+            while((dojoList & 1) != 0) {\n+                dojoList = (dojoList >> 1);\n+                slot++;\n+            }\n+\n+            if(slot < range) {\n+                int slotMapid = (isPartyDojo ? 925030000 : 925020000) + (100 * (fromStage + 1)) + slot;\n+                int dojoSlot = getDojoSlot(slotMapid);\n                 \n-            this.usedDojo |= (1 << ((!isPartyDojo ? 5 : 0) + slot));\n-            return slot;\n-        } else {\n-            return -1;\n+                if(party != null) {\n+                    if(dojoParty.containsKey(party.hashCode())) return -2;\n+                    dojoParty.put(party.hashCode(), dojoSlot);\n+                }\n+                \n+                this.usedDojo |= (1 << dojoSlot);\n+                \n+                this.resetDojo(slotMapid);\n+                this.startDojoSchedule(slotMapid);\n+                return slot;\n+            } else {\n+                return -1;\n+            }\n+        } finally {\n+            lock.unlock();\n         }\n     }\n     \n     private void freeDojoSlot(int slot, MapleParty party) {\n         int mask = 0b11111111111111111111;\n         mask ^= (1 << slot);\n         \n-        usedDojo &= mask;\n+        lock.lock();\n+        try {\n+            usedDojo &= mask;\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n         if(party != null) {\n             if(dojoParty.remove(party.hashCode()) != null) return;\n         }\n         \n         if(dojoParty.containsValue(slot)) {    // strange case, no party there!\n-            Set<Entry<Integer, Integer>> es = Collections.unmodifiableSet(dojoParty.entrySet());\n+            Set<Entry<Integer, Integer>> es = new HashSet<>(dojoParty.entrySet());\n             \n             for(Entry<Integer, Integer> e: es) {\n                 if(e.getValue() == slot) {\n@@ -565,17 +588,12 @@ public void resetDojoMap(int fromMapId) {\n     }\n     \n     public void resetDojo(int dojoMapId) {\n-        resetDojo(dojoMapId, 0);\n+        resetDojo(dojoMapId, -1);\n     }\n     \n-    public void resetDojo(int dojoMapId, int thisStg) {\n+    private void resetDojo(int dojoMapId, int thisStg) {\n         int slot = getDojoSlot(dojoMapId);\n         this.dojoStage[slot] = thisStg;\n-        \n-        if(this.dojoTask[slot] != null) {\n-            this.dojoTask[slot].cancel(false);\n-            this.dojoTask[slot] = null;\n-        }\n     }\n     \n     public void freeDojoSectionIfEmpty(int dojoMapId) {\n@@ -595,34 +613,45 @@ public void freeDojoSectionIfEmpty(int dojoMapId) {\n             freeDojoSlot(slot, null);\n     }\n     \n-    public void startDojoSchedule(final int dojoMapId) {\n+    private void startDojoSchedule(final int dojoMapId) {\n         final int slot = getDojoSlot(dojoMapId);\n         final int stage = (dojoMapId / 100) % 100;\n         if(stage <= dojoStage[slot]) return;\n         \n         long clockTime = (stage > 36 ? 15 : (stage / 6) + 5) * 60000;\n-        this.dojoTask[slot] = TimerManager.getInstance().schedule(new Runnable() {\n-            @Override\n-            public void run() {\n-                final int delta = (dojoMapId) % 100;\n-                final int dojoBaseMap = (slot < 5) ? 925030000 : 925020000;\n-                MapleParty party = null;\n-                \n-                for (int i = 0; i < 5; i++) { //only 32 stages, but 38 maps\n-                    if (stage + i > 38) {\n-                        break;\n-                    }\n-                    for(MapleCharacter chr: getMapFactory().getMap(dojoBaseMap + (100 * (stage + i)) + delta).getAllPlayers()) {\n-                        if(chr.getMap().isDojoMap()) {\n-                            chr.timeoutFromDojo();\n+        \n+        lock.lock();\n+        try {\n+            if (this.dojoTask[slot] != null) {\n+                this.dojoTask[slot].cancel(false);\n+            }\n+            this.dojoTask[slot] = TimerManager.getInstance().schedule(new Runnable() {\n+                @Override\n+                public void run() {\n+                    final int delta = (dojoMapId) % 100;\n+                    final int dojoBaseMap = (slot < 5) ? 925030000 : 925020000;\n+                    MapleParty party = null;\n+\n+                    for (int i = 0; i < 5; i++) { //only 32 stages, but 38 maps\n+                        if (stage + i > 38) {\n+                            break;\n+                        }\n+\n+                        MapleMap dojoExit = getMapFactory().getMap(925020002);\n+                        for(MapleCharacter chr: getMapFactory().getMap(dojoBaseMap + (100 * (stage + i)) + delta).getAllPlayers()) {\n+                            if(GameConstants.isDojo(chr.getMap().getId())) {\n+                                chr.changeMap(dojoExit);\n+                            }\n+                            party = chr.getParty();\n                         }\n-                        party = chr.getParty();\n                     }\n+\n+                    freeDojoSlot(slot, party);\n                 }\n-                \n-                freeDojoSlot(slot, party);\n-            }\n-        }, clockTime + 3000);   // let the TIMES UP display for 3 seconds, then warp\n+            }, clockTime + 3000);   // let the TIMES UP display for 3 seconds, then warp\n+        } finally {\n+            lock.unlock();\n+        }\n         \n         dojoFinishTime[slot] = Server.getInstance().getCurrentTime() + clockTime;\n     }\n@@ -632,9 +661,14 @@ public void dismissDojoSchedule(int dojoMapId, MapleParty party) {\n         int stage = (dojoMapId / 100) % 100;\n         if(stage <= dojoStage[slot]) return;\n         \n-        if(this.dojoTask[slot] != null) {\n-            this.dojoTask[slot].cancel(false);\n-            this.dojoTask[slot] = null;\n+        lock.lock();\n+        try {\n+            if(this.dojoTask[slot] != null) {\n+                this.dojoTask[slot].cancel(false);\n+                this.dojoTask[slot] = null;\n+            }\n+        } finally {\n+            lock.unlock();\n         }\n         \n         freeDojoSlot(slot, party);"}, {"sha": "027f0e8691d504af8f8d0ec51d0c24a313618570", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 20, "deletions": 6, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -56,7 +56,6 @@\n import client.status.MonsterStatus;\n import client.status.MonsterStatusEffect;\n import constants.game.GameConstants;\n-import constants.net.ServerConstants;\n import constants.skills.Aran;\n import constants.skills.Assassin;\n import constants.skills.Bandit;\n@@ -102,6 +101,7 @@\n import constants.skills.ThunderBreaker;\n import constants.skills.WhiteKnight;\n import constants.skills.WindArcher;\n+import net.server.PlayerBuffValueHolder;\n import scripting.AbstractPlayerInteraction;\n \n public abstract class AbstractDealDamageHandler extends AbstractMaplePacketHandler {\n@@ -166,14 +166,17 @@ protected void applyAttack(AttackInfo attack, final MapleCharacter player, int a\n                     if (player.isAlive()) {\n                         if(attack.skill == Aran.BODY_PRESSURE || attack.skill == Marauder.ENERGY_CHARGE || attack.skill == ThunderBreaker.ENERGY_CHARGE) {  // thanks IxianMace for noticing Energy Charge skills refreshing on touch, leading to misleading buff applies\n                             // prevent touch dmg skills refreshing\n+                        } else if(attack.skill == DawnWarrior.FINAL_ATTACK || attack.skill == WindArcher.FINAL_ATTACK) {\n+                            // prevent cygnus FA refreshing\n+                            mobCount = 15;\n                         } else if(attack.skill == NightWalker.POISON_BOMB) {// Poison Bomb\n                             attackEffect.applyTo(player, new Point(attack.position.x, attack.position.y));\n                         } else {\n                             attackEffect.applyTo(player);\n                             \n-                            if (attack.skill == DawnWarrior.FINAL_ATTACK || attack.skill == Page.FINAL_ATTACK_BW || attack.skill == Page.FINAL_ATTACK_SWORD || attack.skill == Fighter.FINAL_ATTACK_SWORD\n-                                    || attack.skill == Fighter.FINAL_ATTACK_AXE || attack.skill == Spearman.FINAL_ATTACK_SPEAR || attack.skill == Spearman.FINAL_ATTACK_POLEARM || attack.skill == WindArcher.FINAL_ATTACK\n-                                    || attack.skill == DawnWarrior.FINAL_ATTACK || attack.skill == Hunter.FINAL_ATTACK || attack.skill == Crossbowman.FINAL_ATTACK) {\n+                            if (attack.skill == Page.FINAL_ATTACK_BW || attack.skill == Page.FINAL_ATTACK_SWORD || attack.skill == Fighter.FINAL_ATTACK_SWORD\n+                                    || attack.skill == Fighter.FINAL_ATTACK_AXE || attack.skill == Spearman.FINAL_ATTACK_SPEAR || attack.skill == Spearman.FINAL_ATTACK_POLEARM\n+                                    || attack.skill == Hunter.FINAL_ATTACK || attack.skill == Crossbowman.FINAL_ATTACK) {\n                                 \n                                 mobCount = 15;//:(\n                             } else if (attack.skill == Aran.HIDDEN_FULL_DOUBLE || attack.skill == Aran.HIDDEN_FULL_TRIPLE || attack.skill == Aran.HIDDEN_OVER_DOUBLE || attack.skill == Aran.HIDDEN_OVER_TRIPLE) {\n@@ -753,6 +756,17 @@ else if(orbs >= 5)\n             calcDmgMax *= (100 + ceffect.getDamage()) / 100;\n         }\n         \n+        int bonusDmgBuff = 100;\n+        for (PlayerBuffValueHolder pbvh : chr.getAllBuffs()) {\n+            int bonusDmg = pbvh.effect.getDamage() - 100;\n+            bonusDmgBuff += bonusDmg;\n+        }\n+        \n+        if (bonusDmgBuff != 100) {\n+            float dmgBuff = bonusDmgBuff / 100.0f;\n+            calcDmgMax = (long) Math.ceil(calcDmgMax * dmgBuff);\n+        }\n+        \n         if(chr.getMapId() >= 914000000 && chr.getMapId() <= 914000500) {\n             calcDmgMax += 80000; // Aran Tutorial.\n         }\n@@ -789,7 +803,7 @@ else if(orbs >= 5)\n             if(chr.getBuffEffect(MapleBuffStat.WK_CHARGE) != null) {\n                 // Charge, so now we need to check elemental effectiveness\n                 int sourceID = chr.getBuffSource(MapleBuffStat.WK_CHARGE);\n-\t\t\t\tint level = chr.getBuffedValue(MapleBuffStat.WK_CHARGE);\n+                int level = chr.getBuffedValue(MapleBuffStat.WK_CHARGE);\n                 if(monster != null) {\n                     if(sourceID == WhiteKnight.BW_FIRE_CHARGE || sourceID == WhiteKnight.SWORD_FIRE_CHARGE) {\n                         if(monster.getStats().getEffectiveness(Element.FIRE) == ElementalEffectiveness.WEAK) {\n@@ -880,7 +894,7 @@ else if(orbs >= 5)\n                     long maxWithCrit = hitDmgMax;\n                     if(canCrit) // They can crit, so up the max.\n                             maxWithCrit *= 2;\n-\n+                    \n                     // Warn if the damage is over 1.5x what we calculated above.\n                     if(damage > maxWithCrit * 1.5) {\n                         AutobanFactory.DAMAGE_HACK.alert(chr, \"DMG: \" + damage + \" MaxDMG: \" + maxWithCrit + \" SID: \" + ret.skill + \" MobID: \" + (monster != null ? monster.getId() : \"null\") + \" Map: \" + chr.getMap().getMapName() + \" (\" + chr.getMapId() + \")\");"}, {"sha": "621ce0242635bd87776e442b06d87e402b566a1c", "filename": "src/net/server/channel/handlers/CloseRangeDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/CloseRangeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/CloseRangeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CloseRangeDamageHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -68,7 +68,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         if (chr.getDojoEnergy() < 10000 && (attack.skill == 1009 || attack.skill == 10001009 || attack.skill == 20001009)) // PE hacking or maybe just lagging\n             return;\n-        if (chr.getMap().isDojoMap() && attack.numAttacked > 0) {\n+        if (GameConstants.isDojo(chr.getMap().getId()) && attack.numAttacked > 0) {\n             chr.setDojoEnergy(chr.getDojoEnergy() + YamlConfig.config.server.DOJO_ENERGY_ATK);\n             c.announce(MaplePacketCreator.getEnergy(\"energy\", chr.getDojoEnergy()));\n         }"}, {"sha": "b1f9c5630346b0fef11ce1c2054575d79a213ec1", "filename": "src/net/server/channel/handlers/MagicDamageHandler.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/MagicDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/MagicDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MagicDamageHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -27,6 +27,7 @@\n import client.Skill;\n import client.SkillFactory;\n import config.YamlConfig;\n+import constants.game.GameConstants;\n import constants.skills.Bishop;\n import constants.skills.Evan;\n import constants.skills.FPArchMage;\n@@ -56,7 +57,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t}\n \t\t}\n                 \n-                if (chr.getMap().isDojoMap() && attack.numAttacked > 0) {\n+                if (GameConstants.isDojo(chr.getMap().getId()) && attack.numAttacked > 0) {\n                         chr.setDojoEnergy(chr.getDojoEnergy() +  + YamlConfig.config.server.DOJO_ENERGY_ATK);\n                         c.announce(MaplePacketCreator.getEnergy(\"energy\", chr.getDojoEnergy()));\n                 }"}, {"sha": "c9137b68b35f76a44b1259650a8aa386fd191e14", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -130,7 +130,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \n                 String remoteHwid;\n                 if (player == null) {\n-                    remoteHwid = MapleSessionCoordinator.getInstance().getGameSessionHwid(session);\n+                    remoteHwid = MapleSessionCoordinator.getInstance().pickLoginSessionHwid(session);\n                     if (remoteHwid == null) {\n                         c.disconnect(true, false);\n                         return;"}, {"sha": "74f3f5d64f68bf9f302d9075f503a91292b8e74e", "filename": "src/net/server/channel/handlers/QuickslotKeyMappedModifiedHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/QuickslotKeyMappedModifiedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/QuickslotKeyMappedModifiedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/QuickslotKeyMappedModifiedHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -29,6 +29,6 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             aQuickslotKeyMapped[i] = (byte) slea.readInt();\n         }\n \n-        c.getPlayer().m_pQuickslotKeyMapped = new MapleQuickslotBinding(aQuickslotKeyMapped);\n+        c.getPlayer().changeQuickslotKeybinding(aQuickslotKeyMapped);\n     }\n }"}, {"sha": "5b7f7e19cb5388b2fcb00f28631ffe12bdf63ead", "filename": "src/net/server/channel/handlers/RangedAttackHandler.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/RangedAttackHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/RangedAttackHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/RangedAttackHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -32,6 +32,7 @@\n import client.inventory.MapleWeaponType;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import config.YamlConfig;\n+import constants.game.GameConstants;\n import constants.inventory.ItemConstants;\n import constants.skills.Aran;\n import constants.skills.Buccaneer;\n@@ -69,7 +70,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n         }\n         \n-        if (chr.getMap().isDojoMap() && attack.numAttacked > 0) {\n+        if (GameConstants.isDojo(chr.getMap().getId()) && attack.numAttacked > 0) {\n             chr.setDojoEnergy(chr.getDojoEnergy() + YamlConfig.config.server.DOJO_ENERGY_ATK);\n             c.announce(MaplePacketCreator.getEnergy(\"energy\", chr.getDojoEnergy()));\n         }\n@@ -104,7 +105,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             short slot = -1;\n             int projectile = 0;\n-            byte bulletCount = 1;\n+            short bulletCount = 1;\n             MapleStatEffect effect = null;\n             if (attack.skill != 0) {\n                 effect = attack.getAttackEffect(chr, null);\n@@ -168,7 +169,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             boolean shadowClaw = chr.getBuffedValue(MapleBuffStat.SHADOW_CLAW) != null;\n             if (projectile != 0) {\n                 if (!soulArrow && !shadowClaw && attack.skill != 11101004 && attack.skill != 15111007 && attack.skill != 14101006) {\n-                    byte bulletConsume = bulletCount;\n+                    short bulletConsume = bulletCount;\n \n                     if (effect != null && effect.getBulletConsume() != 0) {\n                         bulletConsume = (byte) (effect.getBulletConsume() * (hasShadowPartner ? 2 : 1));           "}, {"sha": "488937d6c119c80d65e60ced81fd60f709a7db15", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -197,7 +197,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         //in dojo player cannot use pot, so deadly attacks should be turned off as well\n-        if(is_deadly && chr.getMap().isDojoMap() && !YamlConfig.config.server.USE_DEADLY_DOJO) {\n+        if(is_deadly && GameConstants.isDojo(chr.getMap().getId()) && !YamlConfig.config.server.USE_DEADLY_DOJO) {\n             damage = 0;\n             mpattack = 0;\n         }"}, {"sha": "9133a3979657c44a5eb80843ece4c5d205223e9d", "filename": "src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -319,10 +319,14 @@ private void disposeMatchElement(MapleMatchCheckingElement mmce) {\n         }\n     }\n     \n-    private void acceptMatchElement(MapleMatchCheckingElement mmce, int cid) {\n+    private boolean acceptMatchElement(MapleMatchCheckingElement mmce, int cid) {\n         if (mmce.acceptEntry(cid)) {\n             unpoolMatchPlayer(cid);\n             disposeMatchElement(mmce);\n+            \n+            return true;\n+        } else {\n+            return false;\n         }\n     }\n     \n@@ -355,7 +359,11 @@ public boolean answerMatchConfirmation(int cid, boolean accept) {\n                                         mmce = null;\n                                     } else {\n                                         if (accept) {\n-                                            acceptMatchElement(mmce, cid);\n+                                            if (!acceptMatchElement(mmce, cid)) {\n+                                                mmce = null;\n+                                            }\n+                                            \n+                                            break;  // thanks Rohenn for noticing loop scenario here\n                                         } else {\n                                             denyMatchElement(mmce, cid);\n                                             matchEntries.remove(cid);"}, {"sha": "95fc2e62899ec410a50224f2de29bf7fa79b703c", "filename": "src/net/server/coordinator/session/MapleSessionCoordinator.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/coordinator/session/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/coordinator/session/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/session/MapleSessionCoordinator.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -547,6 +547,11 @@ public void closeSession(IoSession session, Boolean immediately) {\n         // session.removeAttribute(MapleClient.CLIENT_REMOTE_ADDRESS); No real need for removing String property on closed sessions\n     }\n     \n+    public String pickLoginSessionHwid(IoSession session) {\n+        String remoteHost = getSessionRemoteAddress(session);\n+        return cachedHostHwids.remove(remoteHost);    // thanks BHB, resinate for noticing players from same network not being able to login\n+    }\n+    \n     public String getGameSessionHwid(IoSession session) {\n         String remoteHost = getSessionRemoteHost(session);\n         return cachedHostHwids.get(remoteHost);"}, {"sha": "248699e72fdc16577d48ed26cbd48c3abdbcd4ef", "filename": "src/net/server/handlers/login/LoginPasswordHandler.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/handlers/login/LoginPasswordHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/handlers/login/LoginPasswordHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/LoginPasswordHandler.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -88,8 +88,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         slea.skip(6);   // localhost masked the initial part with zeroes...\n         byte[] hwidNibbles = slea.read(4);\n-        int loginok = c.login(login, pwd, HexTool.toCompressedString(hwidNibbles));\n-\n+        String nibbleHwid = HexTool.toCompressedString(hwidNibbles);\n+        int loginok = c.login(login, pwd, nibbleHwid);\n+        \n         Connection con = null;\n         PreparedStatement ps = null;\n \n@@ -112,7 +113,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 e.printStackTrace();\n             } finally {\n                 disposeSql(con, ps);\n-                loginok = c.login(login, pwd, HexTool.toCompressedString(hwidNibbles));\n+                loginok = c.login(login, pwd, nibbleHwid);\n             }\n         }\n "}, {"sha": "6d5181edd90190c61eeb40bb4ef6b6518512648e", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -260,10 +260,15 @@ public Channel getChannel(int channel) {\n         }\n     }\n \n-    public void addChannel(Channel channel) {\n+    public boolean addChannel(Channel channel) {\n         chnWLock.lock();\n         try {\n-            channels.add(channel);\n+            if (channel.getId() == channels.size() + 1) {\n+                channels.add(channel);\n+                return true;\n+            } else {\n+                return false;\n+            }\n         } finally {\n             chnWLock.unlock();\n         }"}, {"sha": "52680715d6d5d7ba7491cb8e81f0d70d85e97618", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -588,7 +588,10 @@ public boolean isUsingOldPqNpcStyle() {\n         }\n         \n         public Object[] getAvailableSkillBooks() {\n-                return MapleItemInformationProvider.getInstance().usableSkillBooks(this.getPlayer()).toArray();\n+                List<Integer> ret = MapleItemInformationProvider.getInstance().usableSkillBooks(this.getPlayer());\n+                ret.addAll(MapleSkillbookInformationProvider.getInstance().getTeachableSkills(this.getPlayer()));\n+                \n+                return ret.toArray();\n         }\n         \n         public Object[] getNamesWhoDropsItem(Integer itemId) {\n@@ -597,7 +600,19 @@ public boolean isUsingOldPqNpcStyle() {\n         \n         public String getSkillBookInfo(int itemid) {\n                 SkillBookEntry sbe = MapleSkillbookInformationProvider.getInstance().getSkillbookAvailability(itemid);\n-                return sbe != SkillBookEntry.UNAVAILABLE ? \"    Obtainable through #rquestline#k.\" : \"\";\n+                switch (sbe) {\n+                        case UNAVAILABLE:\n+                                return \"\";\n+                        \n+                        case QUEST_BOOK:\n+                                return \"    Obtainable through #rquestline#k (collecting book).\";\n+                                \n+                        case QUEST_REWARD:\n+                                return \"    Obtainable through #rquestline#k (quest reward).\";\n+\n+                        default:\n+                                return \"    Obtainable through #rquestline#k.\";\n+                }\n         }\n         \n         // By Drago/Dragohe4rt CPQ + WED"}, {"sha": "200b0eebe034fa5972279b202078f3993bfcda39", "filename": "src/server/MakerItemFactory.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MakerItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MakerItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MakerItemFactory.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -38,8 +38,8 @@\n     \n     public static MakerItemCreateEntry getItemCreateEntry(int toCreate, int stimulantid, Map<Integer, Short> reagentids) {\n         MakerItemCreateEntry makerEntry = ii.getMakerItemEntry(toCreate);\n-        if(makerEntry == null) {\n-            return null;\n+        if(makerEntry.isInvalid()) {\n+            return makerEntry;\n         }\n         \n           // THEY DECIDED FOR SOME BIZARRE PATTERN ON THE FEE THING, ALMOST RANDOMIZED.\n@@ -206,5 +206,9 @@ public void trimCost() {\n             reqCost = (int) (cost / 1000);\n             reqCost *= 1000;\n         }\n+        \n+        public boolean isInvalid() {    // thanks Rohenn, Wh1SK3Y for noticing some items not getting checked properly\n+            return reqLevel < 0;\n+        }\n     }\n }"}, {"sha": "235016b1741e8fe0ac87b36ed634d61ef82d1651", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -1981,10 +1981,10 @@ public MakerItemCreateEntry getMakerItemEntry(int toCreate) {\n                 PreparedStatement ps = con.prepareStatement(\"SELECT req_level, req_maker_level, req_meso, quantity FROM makercreatedata WHERE itemid = ?\");\n                 ps.setInt(1, toCreate);\n                 ResultSet rs = ps.executeQuery();\n-                int reqLevel = 0;\n-                int reqMakerLevel = 0;\n-                int cost = 0;\n-                int toGive = 0;\n+                int reqLevel = -1;\n+                int reqMakerLevel = -1;\n+                int cost = -1;\n+                int toGive = -1;\n                 if (rs.next()) {\n                     reqLevel = rs.getInt(\"req_level\");\n                     reqMakerLevel = rs.getInt(\"req_maker_level\");"}, {"sha": "2b2c2114ba9707dbb7d71be02aeb8cfd5767658a", "filename": "src/server/MapleSkillbookInformationProvider.java", "status": "modified", "additions": 95, "deletions": 13, "changes": 108, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleSkillbookInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleSkillbookInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleSkillbookInformationProvider.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -35,7 +35,9 @@\n import java.util.Set;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n+import client.MapleCharacter;\n import provider.MapleData;\n+import provider.MapleDataProvider;\n import provider.MapleDataProviderFactory;\n import provider.MapleDataTool;\n import tools.DatabaseConnection;\n@@ -57,45 +59,106 @@ public static MapleSkillbookInformationProvider getInstance() {\n     public enum SkillBookEntry {\n         UNAVAILABLE,\n         QUEST,\n+        QUEST_BOOK,\n+        QUEST_REWARD,\n         REACTOR,\n         SCRIPT\n     }\n     \n-    static String host = \"jdbc:mysql://localhost:3306/heavenms\";\n-    static String driver = \"com.mysql.jdbc.Driver\";\n-    static String username = \"root\";\n-    static String password = \"\";\n+    private static String host = \"jdbc:mysql://localhost:3306/heavenms\";\n+    private static String driver = \"com.mysql.jdbc.Driver\";\n+    private static String username = \"root\";\n+    private static String password = \"\";\n     \n-    static String rootDirectory = \".\";\n+    private static String rootDirectory = \".\";\n     \n-    static int skillbookMinItemid = 2280000;\n-    static int skillbookMaxItemid = 2300000;  // exclusively\n+    private static int skillbookMinItemid = 2280000;\n+    private static int skillbookMaxItemid = 2300000;  // exclusively\n+    \n+    private static Set<Integer> questSkills = new HashSet<>();\n     \n     static {\n         loadSkillbooks();\n     }\n     \n-    public static boolean isSkillBook(int itemid) {\n+    private static boolean is4thJobSkill(int itemid) {\n+        return itemid / 10000 % 10 == 2;\n+    }\n+    \n+    private static boolean isSkillBook(int itemid) {\n         return itemid >= skillbookMinItemid && itemid < skillbookMaxItemid;\n     }\n     \n+    private static boolean isQuestBook(int itemid) {\n+        return itemid >= 4001107 && itemid <= 4001114 || itemid >= 4161015 && itemid <= 4161023;\n+    }\n+    \n+    private static int fetchQuestbook(MapleData checkData, String quest) {\n+        MapleData questStartData = checkData.getChildByPath(quest).getChildByPath(\"0\");\n+        \n+        MapleData startReqItemData = questStartData.getChildByPath(\"item\");\n+        if (startReqItemData != null) {\n+            for (MapleData itemData : startReqItemData.getChildren()) {\n+                int itemid = MapleDataTool.getInt(\"id\", itemData, 0);\n+                if (isQuestBook(itemid)) {\n+                    return itemid;\n+                }\n+            }\n+        }\n+            \n+        MapleData startReqQuestData = questStartData.getChildByPath(\"quest\");\n+        if (startReqQuestData != null) {\n+            Set<Integer> reqQuests = new HashSet<>();\n+            \n+            for (MapleData questStatusData : startReqQuestData.getChildren()) {\n+                int reqQuest = MapleDataTool.getInt(\"id\", questStatusData, 0);\n+                if (reqQuest > 0) {\n+                    reqQuests.add(reqQuest);\n+                }\n+            }\n+            \n+            for (Integer reqQuest : reqQuests) {\n+                int book = fetchQuestbook(checkData, Integer.toString(reqQuest));\n+                if (book > -1) {\n+                    return book;\n+                }\n+            }\n+        }\n+        \n+        return -1;\n+    }\n+    \n     private static void fetchSkillbooksFromQuests() {\n-        MapleData actData = MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/\" + \"Quest.wz\")).getData(\"Act.img\");\n+        MapleDataProvider questDataProvider = MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/\" + \"Quest.wz\"));\n+        MapleData actData = questDataProvider.getData(\"Act.img\");\n+        MapleData checkData = questDataProvider.getData(\"Check.img\");\n         \n         for (MapleData questData : actData.getChildren()) {\n             for (MapleData questStatusData : questData.getChildren()) {\n                 for (MapleData questNodeData : questStatusData.getChildren()) {\n-                    if (questNodeData.getName().contentEquals(\"item\")) {\n+                    String actNodeName = questNodeData.getName();\n+                    if (actNodeName.contentEquals(\"item\")) {\n                         for (MapleData questItemData : questNodeData.getChildren()) {\n                             int itemid = MapleDataTool.getInt(\"id\", questItemData, 0);\n                             int itemcount = MapleDataTool.getInt(\"count\", questItemData, 0);\n                             \n                             if (isSkillBook(itemid) && itemcount > 0) {\n-                                foundSkillbooks.put(itemid, SkillBookEntry.QUEST);\n+                                int questbook = fetchQuestbook(checkData, questData.getName());\n+                                if (questbook < 0) {\n+                                    foundSkillbooks.put(itemid, SkillBookEntry.QUEST);\n+                                } else {\n+                                    foundSkillbooks.put(itemid, SkillBookEntry.QUEST_BOOK);\n+                                }\n+                            }\n+                        }\n+                    } else if (actNodeName.contentEquals(\"skill\")) {\n+                        for (MapleData questSkillData : questNodeData.getChildren()) {\n+                            int skillid = MapleDataTool.getInt(\"id\", questSkillData, 0);\n+                            if (is4thJobSkill(skillid)) {\n+                                // negative itemids are skill rewards\n+                                foundSkillbooks.put(-skillid, SkillBookEntry.QUEST_REWARD);\n                             }\n                         }\n-                        \n-                        break;\n                     }\n                 }\n             }\n@@ -212,4 +275,23 @@ public SkillBookEntry getSkillbookAvailability(int itemid) {\n         return sbe != null ? sbe : SkillBookEntry.UNAVAILABLE;\n     }\n     \n+    public List<Integer> getTeachableSkills(MapleCharacter chr) {\n+        List<Integer> list = new ArrayList<>();\n+        \n+        for (Integer book : foundSkillbooks.keySet()) {\n+            if (book >= 0) {\n+                continue;\n+            }\n+            \n+            int skillid = -book;\n+            if (skillid / 10000 == chr.getJob().getId()) {\n+                if (chr.getMasterLevel(skillid) == 0) {\n+                    list.add(-skillid);\n+                }\n+            }\n+        }\n+        \n+        return list;\n+    }\n+    \n }"}, {"sha": "5fa69ad6c9bbc2d8223f5b169169b836284fad14", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -146,7 +146,7 @@\n     private int itemCon, itemConNo;\n     private int damage, attackCount, fixdamage;\n     private Point lt, rb;\n-    private byte bulletCount, bulletConsume;\n+    private short bulletCount, bulletConsume;\n     private byte mapProtection;\n     private CardItemupStats cardStats;\n     \n@@ -484,8 +484,8 @@ private static MapleStatEffect loadFromData(MapleData source, int sourceid, bool\n         ret.damage = MapleDataTool.getIntConvert(\"damage\", source, 100);\n         ret.fixdamage = MapleDataTool.getIntConvert(\"fixdamage\", source, -1);\n         ret.attackCount = MapleDataTool.getIntConvert(\"attackCount\", source, 1);\n-        ret.bulletCount = (byte) MapleDataTool.getIntConvert(\"bulletCount\", source, 1);\n-        ret.bulletConsume = (byte) MapleDataTool.getIntConvert(\"bulletConsume\", source, 0);\n+        ret.bulletCount = (short) MapleDataTool.getIntConvert(\"bulletCount\", source, 1);\n+        ret.bulletConsume = (short) MapleDataTool.getIntConvert(\"bulletConsume\", source, 0);\n         ret.moneyCon = MapleDataTool.getIntConvert(\"moneyCon\", source, 0);\n         ret.itemCon = MapleDataTool.getInt(\"itemCon\", source, 0);\n         ret.itemConNo = MapleDataTool.getInt(\"itemConNo\", source, 0);\n@@ -961,6 +961,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         } else if (isCureAllAbnormalStatus()) {\n             applyto.dispelDebuff(MapleDisease.SEDUCE);\n             applyto.dispelDebuff(MapleDisease.ZOMBIFY);\n+            applyto.dispelDebuff(MapleDisease.CONFUSE);\n             applyto.dispelDebuffs();\n         } else if (isComboReset()) {\n             applyto.setCombo((short) 0);\n@@ -1008,14 +1009,16 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             }\n         }\n         if (isShadowClaw()) {\n+            short projectileConsume = this.getBulletConsume();  // noticed by shavit\n+            \n             MapleInventory use = applyto.getInventory(MapleInventoryType.USE);\n             use.lockInventory();\n             try {\n                 Item projectile = null;\n                 for (int i = 1; i <= use.getSlotLimit(); i++) { // impose order...\n                     Item item = use.getItem((short) i);\n                     if (item != null) {\n-                        if (ItemConstants.isThrowingStar(item.getItemId()) && item.getQuantity() >= 200) {\n+                        if (ItemConstants.isThrowingStar(item.getItemId()) && item.getQuantity() >= projectileConsume) {\n                             projectile = item;\n                             break;\n                         }\n@@ -1024,7 +1027,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                 if (projectile == null) {\n                     return false;\n                 } else {\n-                    MapleInventoryManipulator.removeFromSlot(applyto.getClient(), MapleInventoryType.USE, projectile.getPosition(), (short) 200, false, true);\n+                    MapleInventoryManipulator.removeFromSlot(applyto.getClient(), MapleInventoryType.USE, projectile.getPosition(), (short) projectileConsume, false, true);\n                 }\n             } finally {\n                 use.unlockInventory();\n@@ -1938,11 +1941,11 @@ public int getFixDamage() {\n         return fixdamage;\n     }\n \n-    public byte getBulletCount() {\n+    public short getBulletCount() {\n         return bulletCount;\n     }\n \n-    public byte getBulletConsume() {\n+    public short getBulletConsume() {\n         return bulletConsume;\n     }\n "}, {"sha": "57eb5db6a52769fe467b335917d163a69cbf10f3", "filename": "src/server/life/MobSkill.java", "status": "modified", "additions": 11, "deletions": 12, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/life/MobSkill.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/life/MobSkill.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkill.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -180,7 +180,7 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n                 break;\n             case 127:\n                 if (lt != null && rb != null && skill) {\n-                    for (MapleCharacter character : getPlayersInRange(monster, player)) {\n+                    for (MapleCharacter character : getPlayersInRange(monster)) {\n                         character.dispel();\n                     }\n                 } else {\n@@ -192,15 +192,15 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n                 break;\n             case 129: // Banish\n                 if (lt != null && rb != null && skill) {\n-                    for (MapleCharacter chr : getPlayersInRange(monster, player)) {\n+                    for (MapleCharacter chr : getPlayersInRange(monster)) {\n                         banishPlayers.add(chr);\n                     }\n                 } else {\n                     banishPlayers.add(player);\n                 }\n                 break;\n             case 131: // Mist\n-                monster.getMap().spawnMist(new MapleMist(calculateBoundingBox(monster.getPosition(), monster.isFacingLeft()), monster, this), x * 100, false, false, false);\n+                monster.getMap().spawnMist(new MapleMist(calculateBoundingBox(monster.getPosition()), monster, this), x * 100, false, false, false);\n                 break;\n             case 132:\n                 disease = MapleDisease.CONFUSE;\n@@ -248,7 +248,7 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n                 int skillLimit = this.getLimit();\n                 MapleMap map = monster.getMap();\n \n-                if (map.isDojoMap()) {  // spawns in dojo should be unlimited\n+                if (GameConstants.isDojo(map.getId())) {  // spawns in dojo should be unlimited\n                     skillLimit = Integer.MAX_VALUE;\n                 }\n \n@@ -333,7 +333,7 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n         if (disease != null) {\n             if (lt != null && rb != null && skill) {\n                 int i = 0;\n-                for (MapleCharacter character : getPlayersInRange(monster, player)) {\n+                for (MapleCharacter character : getPlayersInRange(monster)) {\n                     if (!character.hasActiveBuff(2321005)) {  // holy shield\n                         if (disease.equals(MapleDisease.SEDUCE)) {\n                             if (i < 10) {\n@@ -351,8 +351,8 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n         }\n     }\n \n-    private List<MapleCharacter> getPlayersInRange(MapleMonster monster, MapleCharacter player) {\n-        return monster.getMap().getPlayersInRange(calculateBoundingBox(monster.getPosition(), monster.isFacingLeft()), Collections.singletonList(player));\n+    private List<MapleCharacter> getPlayersInRange(MapleMonster monster) {\n+        return monster.getMap().getPlayersInRange(calculateBoundingBox(monster.getPosition()));\n     }\n \n     public int getSkillId() {\n@@ -411,15 +411,14 @@ public boolean makeChanceResult() {\n         return prop == 1.0 || Math.random() < prop;\n     }\n \n-    private Rectangle calculateBoundingBox(Point posFrom, boolean facingLeft) {\n-        int multiplier = facingLeft ? 1 : -1;\n-        Point mylt = new Point(lt.x * multiplier + posFrom.x, lt.y + posFrom.y);\n-        Point myrb = new Point(rb.x * multiplier + posFrom.x, rb.y + posFrom.y);\n+    private Rectangle calculateBoundingBox(Point posFrom) {\n+        Point mylt = new Point(lt.x + posFrom.x, lt.y + posFrom.y);\n+        Point myrb = new Point(rb.x + posFrom.x, rb.y + posFrom.y);\n         Rectangle bounds = new Rectangle(mylt.x, mylt.y, myrb.x - mylt.x, myrb.y - mylt.y);\n         return bounds;\n     }\n \n     private List<MapleMapObject> getObjectsInRange(MapleMonster monster, MapleMapObjectType objectType) {\n-        return monster.getMap().getMapObjectsInBox(calculateBoundingBox(monster.getPosition(), monster.isFacingLeft()), Collections.singletonList(objectType));\n+        return monster.getMap().getMapObjectsInBox(calculateBoundingBox(monster.getPosition()), Collections.singletonList(objectType));\n     }\n }"}, {"sha": "95aa1b439031e668b6e41988eb839888b8f952d7", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 8, "deletions": 16, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -758,9 +758,11 @@ private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob, f\n         final List<MonsterDropEntry>  dropEntry = new ArrayList<>();\n         final List<MonsterDropEntry> visibleQuestEntry = new ArrayList<>();\n         final List<MonsterDropEntry> otherQuestEntry = new ArrayList<>();\n-        sortDropEntries(YamlConfig.config.server.USE_SPAWN_RELEVANT_LOOT ? mob.retrieveRelevantDrops() : mi.retrieveEffectiveDrop(mob.getId()), dropEntry, visibleQuestEntry, otherQuestEntry, chr);\n         \n-        if (dropEntry.isEmpty() && visibleQuestEntry.isEmpty()) {   // thanks resinate\n+        List<MonsterDropEntry> lootEntry = YamlConfig.config.server.USE_SPAWN_RELEVANT_LOOT ? mob.retrieveRelevantDrops() : mi.retrieveEffectiveDrop(mob.getId());\n+        sortDropEntries(lootEntry, dropEntry, visibleQuestEntry, otherQuestEntry, chr);     // thanks Articuno, Limit, Rohenn for noticing quest loots not showing up in only-quest item drops scenario\n+        \n+        if (lootEntry.isEmpty()) {   // thanks resinate\n             return;\n         }\n         \n@@ -1309,15 +1311,13 @@ public int countPlayers() {\n         return pchars;\n     }\n     \n-    public List<MapleCharacter> getPlayersInRange(Rectangle box, List<MapleCharacter> targets) {\n+    public List<MapleCharacter> getPlayersInRange(Rectangle box) {\n         List<MapleCharacter> character = new LinkedList<>();\n         chrRLock.lock();\n         try {\n-            for (MapleCharacter chr : targets) {\n-                if (characters.contains(chr)) {\n-                    if (box.contains(chr.getPosition())) {\n-                        character.add(chr);\n-                    }\n+            for (MapleCharacter chr : characters) {\n+                if (box.contains(chr.getPosition())) {\n+                    character.add(chr);\n                 }\n             }\n         } finally {\n@@ -4173,14 +4173,6 @@ public void broadcastEnemyShip(final boolean state) {\n         this.setDocked(state);\n     }\n     \n-    public boolean isDojoMap() {\n-        return mapid >= 925020000 && mapid < 925040000;\n-    }\n-    \n-    public boolean isDojoFightMap() {\n-        return isDojoMap() && (((mapid / 100) % 100) % 6) > 0;\n-    }\n-    \n     public boolean isHorntailDefeated() {   // all parts of dead horntail can be found here?\n         for(int i = 8810010; i <= 8810017; i++) {\n             if (getMonsterById(i) == null) {"}, {"sha": "f541c3a7583806e805497e71a65e6653cda44957", "filename": "src/server/maps/MaplePlayerShop.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/maps/MaplePlayerShop.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/maps/MaplePlayerShop.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MaplePlayerShop.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -272,13 +272,13 @@ public boolean buy(MapleClient c, int item, short quantity) {\n                     int price = (int) Math.min((float)pItem.getPrice() * quantity, Integer.MAX_VALUE);\n                     \n                     if (c.getPlayer().getMeso() >= price) {\n+                        if (!owner.canHoldMeso(price)) {    // thanks Rohenn for noticing owner hold check misplaced\n+                            c.getPlayer().dropMessage(1, \"Transaction failed since the shop owner can't hold any more mesos.\");\n+                            c.announce(MaplePacketCreator.enableActions());\n+                            return false;\n+                        }\n+                        \n                         if (canBuy(c, newItem)) {\n-                            if (!owner.canHoldMeso(price)) {\n-                                owner.dropMessage(1, \"Transaction failed since the shop owner can't hold any more mesos.\");\n-                                c.announce(MaplePacketCreator.enableActions());\n-                                return false;\n-                            }\n-                            \n                             c.getPlayer().gainMeso(-price, false);\n                             price -= MapleTrade.getFee(price);  // thanks BHB for pointing out trade fees not applying here\n                             owner.gainMeso(price, true);"}, {"sha": "a76384904b78aaf961c25256f80079ab34110bc3", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 27, "deletions": 17, "changes": 44, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -61,6 +61,7 @@ public void processData(MapleData data) {\n \t\tfor (MapleData iEntry : data.getChildren()) {\n \t\t\tint id = MapleDataTool.getInt(iEntry.getChildByPath(\"id\"));\n \t\t\tint count = MapleDataTool.getInt(iEntry.getChildByPath(\"count\"), 1);\n+                        int period = MapleDataTool.getInt(iEntry.getChildByPath(\"period\"), 0);\n \t\t\t\n \t\t\tInteger prop = null;\n \t\t\tMapleData propData = iEntry.getChildByPath(\"prop\");\n@@ -75,7 +76,7 @@ public void processData(MapleData data) {\n \t\t\tif (iEntry.getChildByPath(\"job\") != null)\n \t\t\t\tjob = MapleDataTool.getInt(iEntry.getChildByPath(\"job\"));\n \t\t\t\n-\t\t\titems.add(new ItemData(Integer.parseInt(iEntry.getName()), id, count, prop, job, gender));\n+\t\t\titems.add(new ItemData(Integer.parseInt(iEntry.getName()), id, count, prop, job, gender, period));\n \t\t}\n                 \n                 Collections.sort(items, new Comparator<ItemData>()\n@@ -90,8 +91,8 @@ public int compare( ItemData o1, ItemData o2 )\n \t\n \t@Override\n \tpublic void run(MapleCharacter chr, Integer extSelection) {\n-                List<Pair<Integer, Integer>> takeItem = new LinkedList<>();\n-                List<Pair<Integer, Integer>> giveItem = new LinkedList<>();\n+                List<ItemData> takeItem = new LinkedList<>();\n+                List<ItemData> giveItem = new LinkedList<>();\n             \n                 int props = 0, rndProps = 0, accProps = 0;\n \t\tfor(ItemData item : items) {\n@@ -125,34 +126,38 @@ public void run(MapleCharacter chr, Integer extSelection) {\n \t\t\t}\n \t\t\t\n \t\t\tif(iEntry.getCount() < 0) { // Remove Item\n-\t\t\t\ttakeItem.add(new Pair<>(iEntry.getId(), iEntry.getCount()));\n+\t\t\t\ttakeItem.add(iEntry);\n \t\t\t} else {                    // Give Item\n-                                giveItem.add(new Pair<>(iEntry.getId(), iEntry.getCount()));\n+                                giveItem.add(iEntry);\n \t\t\t}\n \t\t}\n                 \n                 // must take all needed items before giving others\n                 \n-                for(Pair<Integer, Integer> iPair: takeItem) {\n-                        MapleInventoryType type = ItemConstants.getInventoryType(iPair.getLeft());\n-                        int quantity = iPair.getRight() * -1; // Invert\n+                for(ItemData iEntry: takeItem) {\n+                        int itemid = iEntry.getId(), count = iEntry.getCount();\n+                    \n+                        MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n+                        int quantity = count * -1; // Invert\n                         if(type.equals(MapleInventoryType.EQUIP)) {\n-                                if(chr.getInventory(type).countById(iPair.getLeft()) < quantity) {\n+                                if(chr.getInventory(type).countById(itemid) < quantity) {\n                                         // Not enough in the equip inventoty, so check Equipped...\n-                                        if(chr.getInventory(MapleInventoryType.EQUIPPED).countById(iPair.getLeft()) > quantity) {\n+                                        if(chr.getInventory(MapleInventoryType.EQUIPPED).countById(itemid) > quantity) {\n                                                 // Found it equipped, so change the type to equipped.\n                                                 type = MapleInventoryType.EQUIPPED;\n                                         }\n                                 }\n                         }\n \n-                        MapleInventoryManipulator.removeById(chr.getClient(), type, iPair.getLeft(), quantity, true, false);\n-                        chr.announce(MaplePacketCreator.getShowItemGain(iPair.getLeft(), (short) iPair.getRight().shortValue(), true));\n+                        MapleInventoryManipulator.removeById(chr.getClient(), type, itemid, quantity, true, false);\n+                        chr.announce(MaplePacketCreator.getShowItemGain(itemid, (short) count, true));\n                 }\n                 \n-                for(Pair<Integer, Integer> iPair: giveItem) {\n-                        MapleInventoryManipulator.addById(chr.getClient(), iPair.getLeft(), (short) iPair.getRight().shortValue(), \"\", -1);\n-                        chr.announce(MaplePacketCreator.getShowItemGain(iPair.getLeft(), (short) iPair.getRight().shortValue(), true));\n+                for(ItemData iEntry: giveItem) {\n+                        int itemid = iEntry.getId(), count = iEntry.getCount(), period = iEntry.getPeriod();    // thanks Vcoc for noticing quest milestone item not getting removed from inventory after a while\n+                        \n+                        MapleInventoryManipulator.addById(chr.getClient(), itemid, (short) count, \"\", -1, period > 0 ? (System.currentTimeMillis() + period * 60 * 1000) : -1);\n+                        chr.announce(MaplePacketCreator.getShowItemGain(itemid, (short) count, true));\n                 }\n \t}\n \t\n@@ -320,16 +325,17 @@ public boolean restoreLostItem(MapleCharacter chr, int itemid) {\n         }\n \t\n \tprivate class ItemData {\n-\t\tprivate final int map, id, count, job, gender;\n+\t\tprivate final int map, id, count, job, gender, period;\n \t\tprivate final Integer prop;\n \t\t\n-\t\tpublic ItemData(int map, int id, int count, Integer prop, int job, int gender) {\n+\t\tpublic ItemData(int map, int id, int count, Integer prop, int job, int gender, int period) {\n \t\t\tthis.map = map;\n                         this.id = id;\n \t\t\tthis.count = count;\n \t\t\tthis.prop = prop;\n \t\t\tthis.job = job;\n \t\t\tthis.gender = gender;\n+                        this.period = period;\n \t\t}\n \t\t\n \t\tpublic int getId() {\n@@ -351,5 +357,9 @@ public int getJob() {\n \t\tpublic int getGender() {\n \t\t\treturn gender;\n \t\t}\n+                \n+                public int getPeriod() {\n+\t\t\treturn period;\n+\t\t}\n \t}\n } "}, {"sha": "a455239cd4b3250974a2cadacd647dc8132c07ae", "filename": "wz/Item.wz/Consume/0202.img.xml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bb586a7c0b9862fbe689c257c48e626ade3881d0/wz/Item.wz/Consume/0202.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bb586a7c0b9862fbe689c257c48e626ade3881d0/wz/Item.wz/Consume/0202.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Consume/0202.img.xml?ref=bb586a7c0b9862fbe689c257c48e626ade3881d0", "patch": "@@ -4695,10 +4695,10 @@\n     </imgdir>\n     <imgdir name=\"spec\">\n       <int name=\"time\" value=\"300000\"/>\n-      <int name=\"mhpRRate\" value=\"5\"/>\n+      <int name=\"mhpRRate\" value=\"10\"/>\n       <int name=\"mhpR\" value=\"-100\"/>\n       <int name=\"mmpR\" value=\"-100\"/>\n-      <int name=\"mmpRRate\" value=\"5\"/>\n+      <int name=\"mmpRRate\" value=\"10\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"02022338\">"}]}]},
