{"fetchDate": "2019-12-19", "content": [{"sha": "cd16117553ca1fe3c153d13bfcbd913f4be397aa", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6Y2QxNjExNzU1M2NhMWZlM2MxNTNkMTNiZmNiZDkxM2Y0YmUzOTdhYQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-03-27T19:56:23Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-03-27T19:56:23Z"}, "message": "Autoassigner update + Multi-equip drop\n\nFixed spawn effect not working properly after the HT spawn sequence patch.\nFixed autoassigner not distributing AP properly for brawlers.\nMore than one of the same equipment can now be dropped by mobs. Feature uses the minimum/maximum quantity fields from the drop data to determine how many of the same will be dropped each instance.", "tree": {"sha": "1fbf327541e7ec477f0c9de0ee7600924c46c004", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/1fbf327541e7ec477f0c9de0ee7600924c46c004"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/cd16117553ca1fe3c153d13bfcbd913f4be397aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/cd16117553ca1fe3c153d13bfcbd913f4be397aa", "html_url": "https://github.com/ronancpl/HeavenMS/commit/cd16117553ca1fe3c153d13bfcbd913f4be397aa", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/cd16117553ca1fe3c153d13bfcbd913f4be397aa/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8b8ce3ca2488b8baf96ce3a081e5c7ee5dc51dbd", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8b8ce3ca2488b8baf96ce3a081e5c7ee5dc51dbd", "html_url": "https://github.com/ronancpl/HeavenMS/commit/8b8ce3ca2488b8baf96ce3a081e5c7ee5dc51dbd"}], "stats": {"total": 392, "additions": 230, "deletions": 162}, "files": [{"sha": "55c3c0e1d4f7b3f0f9216a07174276c0bbea600a", "filename": "docs/feature_list.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -69,6 +69,7 @@ Monsters, Maps & Reactors:\n * Added meso drop data for basically every missing overworld mob.\n * Monsterbook displays drop data info conformant with the underlying DB (needs custom wz). See more on the MobBookUpdate feature.\n * Every skill/mastery book is now droppable by mobs.\n+* Mobs now can drop more than one of the same equipment (number of possible drops defined at droptime, uses the minimum/maximum quantity fields on DB).\n * Added Boss HP Bar for dozens of bosses (needs provided custom wz).\n * If multiple bosses are on the same area, client will prioritize Boss HP bar of the target of the player.\n * Boats, elevator and other travelling mechanics fully working."}, {"sha": "2e7169a6875427e1bf12541ed21f05c067b9aed3", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -834,4 +834,9 @@ Modificado \"hint\" banners para usar menor espa\u00e7o visual.\n 16 - 17 Mar\u00e7o 2018,\n Resolvido problema com HP threshold em MoveLifeHandler.\n Aprimorado quests e eventos de bosses da regi\u00e3o de Mushroom Castle, agora sendo repet\u00edveis.\n-Corrigido tempo de dura\u00e7\u00e3o do Body Pressure sendo resetado sempre que acerta um mob.\n\\ No newline at end of file\n+Corrigido tempo de dura\u00e7\u00e3o do Body Pressure sendo resetado sempre que acerta um mob.\n+\n+26 - 27 Mar\u00e7o 2018,\n+Corrigido anima\u00e7\u00e3o de spawn dos bosses do dojo que foi quebrada recentemente.\n+Corrigido autoassigner para piratas somente preenchendo requisitos de gunslinger.\n+Mobs agora podem dropar mais de um equip de mesmo tipo, sistema utiliza quantidades min/max na tabela de drops.\n\\ No newline at end of file"}, {"sha": "a1a611005aaff87801e21fb7b5fa9ab8a68fa62d", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 31, "deletions": 19, "changes": 50, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -338,8 +338,8 @@ private MapleCharacter() {\n         petLootCd = System.currentTimeMillis();\n     }\n     \n-    public MapleJob getJobStyle() {\n-        int jobtype = this.getJob().getId() / 100;\n+    private static MapleJob getJobStyleInternal(int jobid, byte opt) {\n+        int jobtype = jobid / 100;\n         \n         if(jobtype == MapleJob.WARRIOR.getId() / 100 || jobtype == MapleJob.DAWNWARRIOR1.getId() / 100 || jobtype == MapleJob.ARAN1.getId() / 100) {\n             return(MapleJob.WARRIOR);\n@@ -350,7 +350,7 @@ else if(jobtype == MapleJob.MAGICIAN.getId() / 100 || jobtype == MapleJob.BLAZEW\n         }\n         \n         else if(jobtype == MapleJob.BOWMAN.getId() / 100 || jobtype == MapleJob.WINDARCHER1.getId() / 100) {\n-            if(this.getJob().getId() / 10 == MapleJob.CROSSBOWMAN.getId() / 10) return(MapleJob.CROSSBOWMAN);\n+            if(jobid / 10 == MapleJob.CROSSBOWMAN.getId() / 10) return(MapleJob.CROSSBOWMAN);\n             else return(MapleJob.BOWMAN);\n         }\n         \n@@ -359,12 +359,20 @@ else if(jobtype == MapleJob.THIEF.getId() / 100 || jobtype == MapleJob.NIGHTWALK\n         }\n         \n         else if(jobtype == MapleJob.PIRATE.getId() / 100 || jobtype == MapleJob.THUNDERBREAKER1.getId() / 100) {\n-            if(this.getStr() > this.getDex()) return(MapleJob.BRAWLER);\n+            if(opt == (byte) 0x80) return(MapleJob.BRAWLER);\n             else return(MapleJob.GUNSLINGER);\n         }\n         \n         return(MapleJob.BEGINNER);\n     }\n+    \n+    public MapleJob getJobStyle(byte opt) {\n+        return getJobStyleInternal(this.getJob().getId(), opt);\n+    }\n+    \n+    public MapleJob getJobStyle() {\n+        return getJobStyle((byte) ((this.getStr() > this.getDex()) ? 0x80 : 0x40));\n+    }\n \n     public static MapleCharacter getDefault(MapleClient c) {\n         MapleCharacter ret = new MapleCharacter();\n@@ -846,8 +854,8 @@ public void Hide(boolean hide, boolean login) {\n                     getMap().broadcastMessage(this, MaplePacketCreator.removePlayerFromMap(getId()), false);\n                 }\n                 getMap().broadcastGMMessage(this, MaplePacketCreator.spawnPlayerMapObject(this), false);\n-                List<Pair<MapleBuffStat, Integer>> dsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n-                getMap().broadcastGMMessage(this, MaplePacketCreator.giveForeignBuff(id, dsstat), false);\n+                List<Pair<MapleBuffStat, Integer>> ldsstat = Collections.singletonList(new Pair<MapleBuffStat, Integer>(MapleBuffStat.DARKSIGHT, 0));\n+                getMap().broadcastGMMessage(this, MaplePacketCreator.giveForeignBuff(id, ldsstat), false);\n                 for (MapleMonster mon : this.getControlledMonsters()) {\n                     mon.setController(null);\n                     mon.setControllerHasAggro(false);\n@@ -1678,7 +1686,7 @@ public void deleteBuddy(int otherCid) {\n         nextPendingRequest(client);\n     }\n     \n-    public static boolean deleteCharFromDB(MapleCharacter player) {\n+    public static boolean deleteCharFromDB(MapleCharacter player, int senderAccId) {\n             int cid = player.getId(), accId = -1, world = 0;\n             \n             Connection con = null;\n@@ -1696,6 +1704,10 @@ public static boolean deleteCharFromDB(MapleCharacter player) {\n                             }\n                     }\n                     \n+                    if(senderAccId != accId) {\n+                            return false;\n+                    }\n+                    \n                     try (PreparedStatement ps = con.prepareStatement(\"SELECT buddyid FROM buddies WHERE characterid = ?\")) {\n                             ps.setInt(1, cid);\n \n@@ -2180,9 +2192,9 @@ public void run() {\n                     try {\n                         long curTime = System.currentTimeMillis();\n                         \n-                        for(Entry<MapleDisease, Long> d : diseaseExpires.entrySet()) {\n-                            if(d.getValue() < curTime) {\n-                                toExpire.add(d.getKey());\n+                        for(Entry<MapleDisease, Long> de : diseaseExpires.entrySet()) {\n+                            if(de.getValue() < curTime) {\n+                                toExpire.add(de.getKey());\n                             }\n                         }\n                     } finally {\n@@ -2972,8 +2984,8 @@ private void updateEffects(Set<MapleBuffStat> removedStats) {\n             }\n             \n             Map<Integer, Pair<MapleStatEffect, Long>> bestEffects = new LinkedHashMap<>();\n-            for(Entry<MapleBuffStat, Pair<Integer, Integer>> lmse: maxStatups.entrySet()) {\n-                Integer srcid = lmse.getValue().getLeft();\n+            for(Entry<MapleBuffStat, Pair<Integer, Integer>> lmsee: maxStatups.entrySet()) {\n+                Integer srcid = lmsee.getValue().getLeft();\n                 if(!bestEffects.containsKey(srcid)) {\n                     bestEffects.put(srcid, retrievedEffects.get(srcid));\n                 }\n@@ -3156,16 +3168,16 @@ public void cancelBuffStats(MapleBuffStat stat) {\n             Map<MapleBuffStat, MapleBuffStatValueHolder> minStatBuffs = new LinkedHashMap<>();\n             \n             for(Entry<Integer, Map<MapleBuffStat, MapleBuffStatValueHolder>> mbsvhi : buffEffects.entrySet()) {\n-                for(Entry<MapleBuffStat, MapleBuffStatValueHolder> mbsvh : mbsvhi.getValue().entrySet()) {\n-                    MapleBuffStat mbs = mbsvh.getKey();\n-                    Byte it = stats.get(mbs);\n+                for(Entry<MapleBuffStat, MapleBuffStatValueHolder> mbsvhe : mbsvhi.getValue().entrySet()) {\n+                    MapleBuffStat mbs = mbsvhe.getKey();\n+                    Byte b = stats.get(mbs);\n                     \n-                    if(it != null) {\n-                        stats.put(mbs, (byte) (it + 1));\n-                        if(mbsvh.getValue().value < minStatBuffs.get(mbs).value) minStatBuffs.put(mbs, mbsvh.getValue());\n+                    if(b != null) {\n+                        stats.put(mbs, (byte) (b + 1));\n+                        if(mbsvhe.getValue().value < minStatBuffs.get(mbs).value) minStatBuffs.put(mbs, mbsvhe.getValue());\n                     } else {\n                         stats.put(mbs, (byte) 1);\n-                        minStatBuffs.put(mbs, mbsvh.getValue());\n+                        minStatBuffs.put(mbs, mbsvhe.getValue());\n                     }\n                 }\n             }"}, {"sha": "9082436d3c20a8bfed1473c7cebf64e7382c545f", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 2, "deletions": 31, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -965,38 +965,9 @@ public Channel getChannelServer(byte channel) {\n \t\treturn Server.getInstance().getChannel(world, channel);\n \t}\n \n-        private boolean hasCharacter(int cid) throws SQLException {\n-                Connection con = null;\n-                PreparedStatement ps = null;\n-                ResultSet rs = null;\n-                \n-                try {\n-                        con = DatabaseConnection.getConnection();\n-                        ps = con.prepareStatement(\"SELECT id FROM characters WHERE accountid = ?\");\n-                        ps.setInt(1, getAccID());\n-                        \n-                        rs = ps.executeQuery();\n-                        while (rs.next()) {\n-                                if (rs.getInt(\"id\") == cid) {\n-                                        return true;\n-                                }\n-                        }\n-                } finally {\n-                        if(rs != null && !rs.isClosed()) rs.close();\n-                        if(ps != null && !ps.isClosed()) ps.close();\n-                        if(con != null && !con.isClosed()) con.close();\n-                }\n-                \n-                return false;\n-        }\n-        \n-\tpublic boolean deleteCharacter(int cid) {\n+        public boolean deleteCharacter(int cid, int senderAccId) {\n                 try {\n-                        if(!hasCharacter(cid)) {\n-                                return false;\n-                        }\n-                    \n-                        return MapleCharacter.deleteCharFromDB(MapleCharacter.loadCharFromDB(cid, this, false));\n+                        return MapleCharacter.deleteCharFromDB(MapleCharacter.loadCharFromDB(cid, this, false), senderAccId);\n                 } catch(SQLException ex) {\n                         ex.printStackTrace();\n                         return false;"}, {"sha": "e9257c8562ca23574c3f2a54b596b4428224090f", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 17, "deletions": 5, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -1447,13 +1447,25 @@ else if (type.equals(\"cash\")) {\n                     \n                 case \"job\":\n \t\t\tif (sub.length == 2) {\n-\t\t\t\tplayer.changeJob(MapleJob.getById(Integer.parseInt(sub[1])));\n+                                int jobid = Integer.parseInt(sub[1]);\n+                                if(jobid < 0 || jobid >= 2200) {\n+                                        player.message(\"Jobid \" + jobid + \" is not available.\");\n+                                        break;\n+                                }\n+                            \n+\t\t\t\tplayer.changeJob(MapleJob.getById(jobid));\n \t\t\t\tplayer.equipChanged();\n \t\t\t} else if (sub.length == 3) {\n \t\t\t\tvictim = c.getChannelServer().getPlayerStorage().getCharacterByName(sub[1]);\n                                 \n                                 if(victim != null) {\n-                                        victim.changeJob(MapleJob.getById(Integer.parseInt(sub[2])));\n+                                        int jobid = Integer.parseInt(sub[2]);\n+                                        if(jobid < 0 || jobid >= 2200) {\n+                                                player.message(\"Jobid \" + jobid + \" is not available.\");\n+                                                break;\n+                                        }\n+                                    \n+                                        victim.changeJob(MapleJob.getById(jobid));\n                                         player.equipChanged();\n                                 } else {\n                                         player.message(\"Player '\" + sub[1] + \"' could not be found on this channel.\");\n@@ -1581,9 +1593,9 @@ public static boolean executeHeavenMsCommandLv3(Channel cserv, Server srv, Maple\n \t\t\tMapleMap newMap = c.getChannelServer().getMapFactory().resetMap(player.getMapId());\n                         int callerid = c.getPlayer().getId();\n                         \n-\t\t\tfor (MapleCharacter ch : oldMap.getCharacters()) {\n-\t\t\t\tch.changeMap(newMap);\n-                                if(ch.getId() != callerid) ch.dropMessage(\"You have been relocated due to map reloading. Sorry for the inconvenience.\");\n+\t\t\tfor (MapleCharacter chr : oldMap.getCharacters()) {\n+\t\t\t\tchr.changeMap(newMap);\n+                                if(chr.getId() != callerid) chr.dropMessage(\"You have been relocated due to map reloading. Sorry for the inconvenience.\");\n \t\t\t}\n \t\t\tnewMap.respawn();\n                     break;"}, {"sha": "1c7fecb1be4461babc0d256203e612e396659851", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -340,7 +340,7 @@ private void gainLevel(MapleClient c) {\n             List<Pair<String, Integer>> elementalStats = MapleItemInformationProvider.getInstance().getItemLevelupStats(getItemId(), itemLevel);\n             \n             for(Pair<String, Integer> p: elementalStats) {\n-                if(p.getRight() > 0) stats.add(new Pair(StatUpgrade.valueOf(p.getLeft()), p.getRight()));\n+                if(p.getRight() > 0) stats.add(new Pair<>(StatUpgrade.valueOf(p.getLeft()), p.getRight()));\n             }\n         }\n         "}, {"sha": "8d4f1fbb0c7b91700810ca4b4e0f8c18e093812f", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -177,6 +177,6 @@ public static boolean isWeapon(int itemId) {\n     }\n     \n     public static boolean isEquipment(int itemId) {\n-        return itemId < 2000000;\n+        return itemId < 2000000 && itemId != 0;\n     }\n }"}, {"sha": "d0efb470a59acc214d7d06eb61944ec3ab8d6303", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -70,7 +70,8 @@\n     public static final boolean USE_ERASE_PET_ON_EXPIRATION = false;//Forces pets to be removed from inventory when expire time comes, rather than converting it to a doll.\n     public static final boolean USE_BUFF_MOST_SIGNIFICANT = true;   //When applying buffs, the player will stick with the highest stat boost among the listed, rather than overwriting stats.\n     public static final boolean USE_MAKER_FEE_HEURISTICS = true;    //Apply compiled values for stimulants and reagents into the Maker fee calculations (max error revolves around 50k mesos). Set false to use basic constant values instead (results are never higher than requested by the client-side).\n-    public static final boolean USE_QUEST_RATE = false;              //Exp/Meso gained by quests uses fixed server exp/meso rate times quest rate as multiplier, instead of player rates.\n+    public static final boolean USE_QUEST_RATE = false;             //Exp/Meso gained by quests uses fixed server exp/meso rate times quest rate as multiplier, instead of player rates.\n+    public static final boolean USE_MULTIPLE_SAME_EQUIP_DROP = true;//Enables multiple drops by mobs of the same equipment, number of possible drops based on the quantities provided at the drop data.\n     \n     //Server Rates And Experience\n     public static final int EXP_RATE = 10;"}, {"sha": "22499e9b79e3226451679783f863a757800bd42b", "filename": "src/dropspider/Main.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/dropspider/Main.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/dropspider/Main.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/dropspider/Main.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -289,8 +289,8 @@ public static void dumpErrors() {\n             BufferedWriter bw = new BufferedWriter(new FileWriter(f));\n             PrintWriter pw = new PrintWriter(bw);\n \n-            for (Errors e : problems.values()) {\n-                pw.write(e.createErrorLog());\n+            for (Errors err : problems.values()) {\n+                pw.write(err.createErrorLog());\n             }\n \n             pw.flush();"}, {"sha": "8b99d6f34290663d2ee08a7fa6049cbfa0332a15", "filename": "src/net/server/audit/ThreadTracker.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/audit/ThreadTracker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/audit/ThreadTracker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/ThreadTracker.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -66,19 +66,19 @@ private String printThreadTrackerState(String dateFormat) {\n         Map<MonitoredLockType, List<Integer>> lockValues = new HashMap<>();\n         Set<Long> executingThreads = new HashSet<>();\n         \n-        for(Map.Entry<Long, AtomicInteger> lock : lockCount.entrySet()) {\n-            if(lock.getValue().get() != 0) {\n-                executingThreads.add(lockThreads.get(lock.getKey()));\n+        for(Map.Entry<Long, AtomicInteger> lc : lockCount.entrySet()) {\n+            if(lc.getValue().get() != 0) {\n+                executingThreads.add(lockThreads.get(lc.getKey()));\n                 \n-                MonitoredLockType lockId = lockIds.get(lock.getKey());\n+                MonitoredLockType lockId = lockIds.get(lc.getKey());\n                 List<Integer> list = lockValues.get(lockId);\n                 \n                 if(list == null) {\n                     list = new ArrayList<>();\n                     lockValues.put(lockId, list);\n                 }\n                 \n-                list.add(lock.getValue().get());\n+                list.add(lc.getValue().get());\n             }\n         }\n         "}, {"sha": "4fa15c28d701a3717b7c9ba64f2a71e97e8963c1", "filename": "src/net/server/channel/handlers/AutoAssignHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/AutoAssignHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/AutoAssignHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AutoAssignHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -58,6 +58,8 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         statGain[0] = 0; statGain[1] = 0; statGain[2] = 0; statGain[3] = 0;\n         \n         slea.skip(8);\n+        byte opt = slea.readByte();     // useful for pirate autoassigning\n+        \n         if (chr.getRemainingAp() < 1) return;\n         \n         if(ServerConstants.USE_SERVER_AUTOASSIGNER) {\n@@ -106,7 +108,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             //c.getPlayer().message(\"SDL: s\" + eqpStr + \" d\" + eqpDex + \" l\" + eqpLuk + \" BASE STATS --> STR: \" + chr.getStr() + \" DEX: \" + chr.getDex() + \" INT: \" + chr.getInt() + \" LUK: \" + chr.getLuk());\n             //c.getPlayer().message(\"SUM EQUIP STATS -> STR: \" + str + \" DEX: \" + dex + \" LUK: \" + luk + \" INT: \" + int_);\n             \n-            MapleJob stance = c.getPlayer().getJobStyle();\n+            MapleJob stance = c.getPlayer().getJobStyle(opt);\n             int prStat = 0, scStat = 0, trStat = 0, temp, tempAp = chr.getRemainingAp(), CAP;\n             \n             MapleStat primary, secondary, tertiary = MapleStat.LUK;"}, {"sha": "2c35567bc57516b8017e8f8322a995a7198bacdf", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -233,10 +233,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n            // if (checkBirthday(c, birthday)) { //We're using a default birthday, so why restrict rings to only people who know of it? \n                 int toCharge = slea.readInt();\n                 int SN = slea.readInt();\n-                String recipient = slea.readMapleAsciiString();\n+                String recipientName = slea.readMapleAsciiString();\n                 String text = slea.readMapleAsciiString();\n-                CashItem ring = CashItemFactory.getItem(SN);\n-                MapleCharacter partner = c.getChannelServer().getPlayerStorage().getCharacterByName(recipient);\n+                CashItem itemRing = CashItemFactory.getItem(SN);\n+                MapleCharacter partner = c.getChannelServer().getPlayerStorage().getCharacterByName(recipientName);\n                 if (partner == null) {\n                     chr.getClient().announce(MaplePacketCreator.serverNotice(1, \"The partner you specified cannot be found.\\r\\nPlease make sure your partner is online and in the same channel.\"));\n                 } else {\n@@ -247,14 +247,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         return;\n                     }*/ //Gotta let them faggots marry too, hence why this is commented out <3 \n                 \t\n-                    if(ring.toItem() instanceof Equip) {\n-                        Equip item = (Equip) ring.toItem();\n-                        int ringid = MapleRing.createRing(ring.getItemId(), chr, partner);\n-                        item.setRingId(ringid);\n-                        cs.addToInventory(item);\n-                        c.announce(MaplePacketCreator.showBoughtCashItem(item, c.getAccID()));\n-                        cs.gift(partner.getId(), chr.getName(), text, item.getSN(), (ringid + 1));\n-                        cs.gainCash(toCharge, -ring.getPrice());\n+                    if(itemRing.toItem() instanceof Equip) {\n+                        Equip eqp = (Equip) itemRing.toItem();\n+                        int ringid = MapleRing.createRing(itemRing.getItemId(), chr, partner);\n+                        eqp.setRingId(ringid);\n+                        cs.addToInventory(eqp);\n+                        c.announce(MaplePacketCreator.showBoughtCashItem(eqp, c.getAccID()));\n+                        cs.gift(partner.getId(), chr.getName(), text, eqp.getSN(), (ringid + 1));\n+                        cs.gainCash(toCharge, -itemRing.getPrice());\n                         chr.addCrushRing(MapleRing.loadFromDb(ringid));\n                         try {\n                             chr.sendNote(partner.getName(), text, (byte) 1);\n@@ -286,7 +286,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 int payment = slea.readByte();\n                 slea.skip(3); //0s\n                 int snID = slea.readInt();\n-                CashItem ring = CashItemFactory.getItem(snID);\n+                CashItem itemRing = CashItemFactory.getItem(snID);\n                 String sentTo = slea.readMapleAsciiString();\n                 int available = slea.readShort() - 1;\n                 String text = slea.readAsciiString(available);\n@@ -296,14 +296,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     chr.dropMessage(\"The partner you specified cannot be found.\\r\\nPlease make sure your partner is online and in the same channel.\");\n                 } else {\n                     // Need to check to make sure its actually an equip and the right SN...\n-                    if(ring.toItem() instanceof Equip) {\n-                        Equip item = (Equip) ring.toItem();\n-                        int ringid = MapleRing.createRing(ring.getItemId(), chr, partner);\n-                        item.setRingId(ringid);\n-                        cs.addToInventory(item);\n-                        c.announce(MaplePacketCreator.showBoughtCashItem(item, c.getAccID()));\n-                        cs.gift(partner.getId(), chr.getName(), text, item.getSN(), (ringid + 1));\n-                        cs.gainCash(payment, -ring.getPrice());\n+                    if(itemRing.toItem() instanceof Equip) {\n+                        Equip eqp = (Equip) itemRing.toItem();\n+                        int ringid = MapleRing.createRing(itemRing.getItemId(), chr, partner);\n+                        eqp.setRingId(ringid);\n+                        cs.addToInventory(eqp);\n+                        c.announce(MaplePacketCreator.showBoughtCashItem(eqp, c.getAccID()));\n+                        cs.gift(partner.getId(), chr.getName(), text, eqp.getSN(), (ringid + 1));\n+                        cs.gainCash(payment, -itemRing.getPrice());\n                         chr.addFriendshipRing(MapleRing.loadFromDb(ringid));\n                         try {\n                             chr.sendNote(partner.getName(), text, (byte) 1);"}, {"sha": "3104dde80c3ad93fdc2d50c890ceddebd247775e", "filename": "src/net/server/channel/handlers/MTSHandler.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/MTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/MTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MTSHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -99,8 +99,8 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if (quantity < 0 || price < 110 || c.getPlayer().getItemQuantity(itemid, false) < quantity) {\n                     return;\n                 }\n-                MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n-                Item i = c.getPlayer().getInventory(type).getItem(slot).copy();\n+                MapleInventoryType invType = ItemConstants.getInventoryType(itemid);\n+                Item i = c.getPlayer().getInventory(invType).getItem(slot).copy();\n                 if (i != null && c.getPlayer().getMeso() >= 5000) {\n                     Connection con = null;\n                     try {\n@@ -160,7 +160,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             Item item = (Item) i;\n                             ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, seller, price, owner, sellername, sell_ends) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             ps.setInt(1, 1);\n-                            ps.setInt(2, (int) type.getType());\n+                            ps.setInt(2, (int) invType.getType());\n                             ps.setInt(3, item.getItemId());\n                             ps.setInt(4, quantity);\n                             ps.setInt(5, c.getPlayer().getId());\n@@ -172,7 +172,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             Equip equip = (Equip) i;\n                             ps = con.prepareStatement(\"INSERT INTO mts_items (tab, type, itemid, quantity, seller, price, upgradeslots, level, str, dex, `int`, luk, hp, mp, watk, matk, wdef, mdef, acc, avoid, hands, speed, jump, locked, owner, sellername, sell_ends, vicious, flag) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\");\n                             ps.setInt(1, 1);\n-                            ps.setInt(2, (int) type.getType());\n+                            ps.setInt(2, (int) invType.getType());\n                             ps.setInt(3, equip.getItemId());\n                             ps.setInt(4, quantity);\n                             ps.setInt(5, c.getPlayer().getId());\n@@ -203,7 +203,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         }\n                         ps.executeUpdate();\n                         ps.close();\n-                        MapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false);\n+                        MapleInventoryManipulator.removeFromSlot(c, invType, slot, quantity, false);\n                         \n                         con.close();\n                     } catch (SQLException e) {"}, {"sha": "15826ec0a1888d4b011f2c1311afd63ee7a01cd6", "filename": "src/net/server/channel/handlers/MakerSkillHandler.java", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/MakerSkillHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/MakerSkillHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MakerSkillHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -106,11 +106,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 for(int i = 0; i < reagents; i++) {  // crystals\n                     int reagentid = slea.readInt();\n                     if(ItemConstants.isMakerReagent(reagentid)) {\n-                        Short r = reagentids.get(reagentid);\n-                        if(r == null) {\n+                        Short rs = reagentids.get(reagentid);\n+                        if(rs == null) {\n                             reagentids.put(reagentid, (short) 1);\n                         } else {\n-                            reagentids.put(reagentid, (short) (r + 1));\n+                            reagentids.put(reagentid, (short) (rs + 1));\n                         }\n                     }\n                 }\n@@ -126,11 +126,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \n                 // remove those not present on player inventory\n                 if(!toUpdate.isEmpty()) {\n-                    for(Pair<Integer, Short> r : toUpdate) {\n-                        if(r.getRight() > 0) {\n-                            reagentids.put(r.getLeft(), r.getRight());\n+                    for(Pair<Integer, Short> rp : toUpdate) {\n+                        if(rp.getRight() > 0) {\n+                            reagentids.put(rp.getLeft(), rp.getRight());\n                         } else {\n-                            reagentids.remove(r.getLeft());\n+                            reagentids.remove(rp.getLeft());\n                         }\n                     }\n                 }\n@@ -453,12 +453,12 @@ private static boolean addBoostedMakerItem(MapleClient c, int itemid, int stimul\n             \n             ii.improveEquipStats(eqp, stats);\n             \n-            for(Short s : randStat) {\n-                ii.scrollOptionEquipWithChaos(eqp, s, false);\n+            for(Short sh : randStat) {\n+                ii.scrollOptionEquipWithChaos(eqp, sh, false);\n             }\n             \n-            for(Short s : randOption) {\n-                ii.scrollOptionEquipWithChaos(eqp, s, true);\n+            for(Short sh : randOption) {\n+                ii.scrollOptionEquipWithChaos(eqp, sh, true);\n             }\n         }\n         "}, {"sha": "0e13420c7d4bd1e2aa3bbfaf31b8f87c0e384d0a", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -407,10 +407,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         } else if (mode == Action.CONFIRM.getCode()) {\n             MapleTrade.completeTrade(c.getPlayer());\n         } else if (mode == Action.ADD_ITEM.getCode() || mode == Action.PUT_ITEM.getCode()) {\n-            MapleInventoryType type = MapleInventoryType.getByType(slea.readByte());\n+            MapleInventoryType ivType = MapleInventoryType.getByType(slea.readByte());\n             short slot = slea.readShort();\n             short bundles = slea.readShort();\n-            if (chr.getInventory(type).getItem(slot) == null || chr.getItemQuantity(chr.getInventory(type).getItem(slot).getItemId(), false) < bundles || chr.getInventory(type).getItem(slot).getFlag() == ItemConstants.UNTRADEABLE) {\n+            if (chr.getInventory(ivType).getItem(slot) == null || chr.getItemQuantity(chr.getInventory(ivType).getItem(slot).getItemId(), false) < bundles || chr.getInventory(ivType).getItem(slot).getFlag() == ItemConstants.UNTRADEABLE) {\n                 return;\n             }\n             short perBundle = slea.readShort();\n@@ -420,7 +420,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             \tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" might of possibly packet edited Hired Merchants\\nperBundle: \" + perBundle + \"\\nperBundle * bundles (This multiplied cannot be greater than 2000): \" + perBundle * bundles + \"\\nbundles: \" + bundles + \"\\nprice: \" + price);\n                 return;\n             }\n-            Item ivItem = chr.getInventory(type).getItem(slot);\n+            Item ivItem = chr.getInventory(ivType).getItem(slot);\n             Item sellItem = ivItem.copy();\n             if (chr.getItemQuantity(ivItem.getItemId(), false) < perBundle * bundles) {\n                 return;\n@@ -429,22 +429,22 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 return;\n             }\n             sellItem.setQuantity(perBundle);\n-            MaplePlayerShopItem item = new MaplePlayerShopItem(sellItem, bundles, price);\n+            MaplePlayerShopItem shopItem = new MaplePlayerShopItem(sellItem, bundles, price);\n             MaplePlayerShop shop = chr.getPlayerShop();\n             MapleHiredMerchant merchant = chr.getHiredMerchant();\n             if (shop != null && shop.isOwner(c.getPlayer())) {\n                 if (ivItem != null && ivItem.getQuantity() >= bundles * perBundle) {\n-                    shop.addItem(item);\n+                    shop.addItem(shopItem);\n                     c.announce(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n                 }\n             } else if (merchant != null && merchant.isOwner(c.getPlayer())) {\n-                merchant.addItem(item);\n+                merchant.addItem(shopItem);\n                 c.announce(MaplePacketCreator.updateHiredMerchant(merchant, c.getPlayer()));\n             }\n             if (ItemConstants.isRechargable(ivItem.getItemId())) {\n-                MapleInventoryManipulator.removeFromSlot(c, type, slot, ivItem.getQuantity(), true);\n+                MapleInventoryManipulator.removeFromSlot(c, ivType, slot, ivItem.getQuantity(), true);\n             } else {\n-                MapleInventoryManipulator.removeFromSlot(c, type, slot, (short) (bundles * perBundle), true);\n+                MapleInventoryManipulator.removeFromSlot(c, ivType, slot, (short) (bundles * perBundle), true);\n             }\n         } else if (mode == Action.REMOVE_ITEM.getCode()) {\n             MaplePlayerShop shop = chr.getPlayerShop();\n@@ -456,10 +456,10 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 \tc.disconnect(true, false);\n                 \treturn;\n                 }\n-                MaplePlayerShopItem item = shop.getItems().get(slot);\n-                Item ivItem = item.getItem().copy();\n+                MaplePlayerShopItem shopItem = shop.getItems().get(slot);\n+                Item ivItem = shopItem.getItem().copy();\n                 shop.removeItem(slot);\n-                ivItem.setQuantity(item.getBundles());\n+                ivItem.setQuantity(shopItem.getBundles());\n                 MapleInventoryManipulator.addFromDrop(c, ivItem, false);\n                 c.announce(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n             }\n@@ -505,35 +505,35 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             c.announce(MaplePacketCreator.updateHiredMerchant(merchant, chr));\n \n         } else if (mode == Action.BUY.getCode() || mode == Action.MERCHANT_BUY.getCode()) {\n-            int item = slea.readByte();\n+            int itemid = slea.readByte();\n             short quantity = slea.readShort();\n             if (quantity < 1) {\n             \tAutobanFactory.PACKET_EDIT.alert(c.getPlayer(), c.getPlayer().getName() + \" tried to packet edit with a hired merchant and or player shop.\");\n-            \tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to buy item \" + item + \" with quantity \" + quantity + \"\\r\\n\");\n+            \tFilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to buy item \" + itemid + \" with quantity \" + quantity + \"\\r\\n\");\n             \tc.disconnect(true, false);\n             \treturn;\n             }\n             MaplePlayerShop shop = chr.getPlayerShop();\n             MapleHiredMerchant merchant = chr.getHiredMerchant();\n             if (shop != null && shop.isVisitor(c.getPlayer())) {\n-                shop.buy(c, item, quantity);\n+                shop.buy(c, itemid, quantity);\n                 shop.broadcast(MaplePacketCreator.getPlayerShopItemUpdate(shop));\n             } else if (merchant != null && !merchant.isOwner(chr)) {\n-                merchant.buy(c, item, quantity);\n+                merchant.buy(c, itemid, quantity);\n                 merchant.broadcastToVisitorsThreadsafe(MaplePacketCreator.updateHiredMerchant(merchant, c.getPlayer()));\n             }\n         } else if (mode == Action.TAKE_ITEM_BACK.getCode()) {\n             MapleHiredMerchant merchant = chr.getHiredMerchant();\n             if (merchant != null && merchant.isOwner(c.getPlayer())) {\n                 int slot = slea.readShort();\n-                MaplePlayerShopItem item = merchant.getItems().get(slot);\n-                if (!MapleInventory.checkSpot(chr, item.getItem())) {\n+                MaplePlayerShopItem shopItem = merchant.getItems().get(slot);\n+                if (!MapleInventory.checkSpot(chr, shopItem.getItem())) {\n                 \tc.announce(MaplePacketCreator.enableActions());\n                 \treturn;\n                 }\n-                if (item.getBundles() > 0) {\n-                    Item iitem = item.getItem();\n-                    iitem.setQuantity((short) (item.getItem().getQuantity() * item.getBundles()));                    \n+                if (shopItem.getBundles() > 0) {\n+                    Item iitem = shopItem.getItem();\n+                    iitem.setQuantity((short) (shopItem.getItem().getQuantity() * shopItem.getBundles()));                    \n                     MapleInventoryManipulator.addFromDrop(c, iitem, true);\n                 }\n                 merchant.removeFromSlot(slot);"}, {"sha": "593907bec504d4ae4d43368840d47e2a0ba4f6c6", "filename": "src/net/server/channel/handlers/StorageHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/StorageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/StorageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/StorageHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -114,14 +114,14 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tif (chr.getMeso() < meso) {\n \t\t\t\tc.announce(MaplePacketCreator.getStorageError((byte) 0x0B));\n \t\t\t} else {\n-\t\t\t\tMapleInventoryType type = ItemConstants.getInventoryType(itemId);\n-\t\t\t\tItem item = chr.getInventory(type).getItem(slot).copy();\n+\t\t\t\tMapleInventoryType invType = ItemConstants.getInventoryType(itemId);\n+\t\t\t\tItem item = chr.getInventory(invType).getItem(slot).copy();\n \t\t\t\tif (item.getItemId() == itemId && (item.getQuantity() >= quantity || ItemConstants.isRechargable(itemId))) {\n \t\t\t\t\tif (ItemConstants.isRechargable(itemId)) {\n \t\t\t\t\t\tquantity = item.getQuantity();\n \t\t\t\t\t}\n \t\t\t\t\tchr.gainMeso(meso, false, true, false);\n-\t\t\t\t\tMapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false);\n+\t\t\t\t\tMapleInventoryManipulator.removeFromSlot(c, invType, slot, quantity, false);\n \t\t\t\t\titem.setQuantity(quantity);\n \t\t\t\t\tstorage.store(item);\n \t\t\t\t\tstorage.sendStored(c, ItemConstants.getInventoryType(itemId));"}, {"sha": "eee44f5703351ea2c28cea7f413a3d27a1e18862", "filename": "src/net/server/channel/handlers/TakeDamageHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/TakeDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/TakeDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TakeDamageHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -144,9 +144,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         is_deadly = true;\n \t            }\n \t            mpattack += attackInfo.getMpBurn();\n-\t            MobSkill skill = MobSkillFactory.getMobSkill(attackInfo.getDiseaseSkill(), attackInfo.getDiseaseLevel());\n-\t            if (skill != null && damage > 0) {\n-\t                skill.applyEffect(chr, attacker, false, banishPlayers);\n+\t            MobSkill mobSkill = MobSkillFactory.getMobSkill(attackInfo.getDiseaseSkill(), attackInfo.getDiseaseLevel());\n+\t            if (mobSkill != null && damage > 0) {\n+\t                mobSkill.applyEffect(chr, attacker, false, banishPlayers);\n \t            }\n \t            \n                     attacker.setMp(attacker.getMp() - attackInfo.getMpCon());"}, {"sha": "fc286b62cfeb9e3fa3d67d20730b0b57d1aeae7a", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -489,13 +489,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             player.getMap().broadcastMessage(MaplePacketCreator.useChalkboard(player, false));\n             player.getClient().announce(MaplePacketCreator.enableActions());\n         } else if (itemType == 539) {\n-            List<String> lines = new LinkedList<>();\n+            List<String> strLines = new LinkedList<>();\n             for (int i = 0; i < 4; i++) {\n-                lines.add(slea.readMapleAsciiString());\n+                strLines.add(slea.readMapleAsciiString());\n             }\n             \n             final int world = c.getWorld();\n-            Server.getInstance().broadcastMessage(world, MaplePacketCreator.getAvatarMega(c.getPlayer(), medal, c.getChannel(), itemId, lines, (slea.readByte() != 0)));\n+            Server.getInstance().broadcastMessage(world, MaplePacketCreator.getAvatarMega(c.getPlayer(), medal, c.getChannel(), itemId, strLines, (slea.readByte() != 0)));\n             TimerManager.getInstance().schedule(new Runnable() {\n             \t@Override\n             \tpublic void run() {"}, {"sha": "67cccda656b4bccb5668ad13d4714f7e6738c2e9", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -136,8 +136,8 @@ public void buildNotifications() {\n                 if (!mgc.isOnline()) {\n                     continue;\n                 }\n-                List<Integer> ch = notifications.get(mgc.getChannel());\n-                if (ch != null) ch.add(mgc.getId());\n+                List<Integer> chl = notifications.get(mgc.getChannel());\n+                if (chl != null) chl.add(mgc.getId());\n                 //Unable to connect to Channel... error was here\n             }\n         } finally {"}, {"sha": "f6bd4ccae261324c4b0c67b263738608964facfb", "filename": "src/net/server/handlers/login/DeleteCharHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/handlers/login/DeleteCharHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/net/server/handlers/login/DeleteCharHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/DeleteCharHandler.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -34,7 +34,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         String pic = slea.readMapleAsciiString();\n         int cid = slea.readInt();\n         if (c.checkPic(pic)) {\n-            if(c.deleteCharacter(cid)) {\n+            if(c.deleteCharacter(cid, c.getAccID())) {\n                 FilePrinter.printError(FilePrinter.DELETED_CHARACTERS + c.getAccountName() + \".txt\", c.getAccountName() + \" deleted CID: \" + cid + \"\\r\\n\");\t\t\t\n                 c.announce(MaplePacketCreator.deleteCharResponse(cid, 0));\n             } else {"}, {"sha": "aede92f33f4a851675d1482ae57b39d7f57032fa", "filename": "src/server/MapleTrade.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/MapleTrade.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/MapleTrade.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleTrade.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -194,7 +194,7 @@ public int getExchangeMesos(){\n     private boolean fitsInInventory() {\n         List<Pair<Item, MapleInventoryType>> tradeItems = new LinkedList<>();\n         for (Item item : exchangeItems) {\n-            tradeItems.add(new Pair(item, item.getInventoryType()));\n+            tradeItems.add(new Pair<>(item, item.getInventoryType()));\n         }\n         \n         return MapleInventory.checkSpotsAndOwnership(chr, tradeItems);"}, {"sha": "62af843063253a4ad50e4cd08ea63536ea0ad965", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -869,12 +869,12 @@ public void run() {\n         } else if (venom) {\n             if (from.getJob() == MapleJob.NIGHTLORD || from.getJob() == MapleJob.SHADOWER || from.getJob().isA(MapleJob.NIGHTWALKER3)) {\n                 int poisonLevel, matk, jobid = from.getJob().getId();\n-                int skill = (jobid == 412 ? NightLord.VENOMOUS_STAR : (jobid == 422 ? Shadower.VENOMOUS_STAB : NightWalker.VENOM));\n-                poisonLevel = from.getSkillLevel(SkillFactory.getSkill(skill));\n+                int skillid = (jobid == 412 ? NightLord.VENOMOUS_STAR : (jobid == 422 ? Shadower.VENOMOUS_STAB : NightWalker.VENOM));\n+                poisonLevel = from.getSkillLevel(SkillFactory.getSkill(skillid));\n                 if (poisonLevel <= 0) {\n                     return false;\n                 }\n-                matk = SkillFactory.getSkill(skill).getEffect(poisonLevel).getMatk();\n+                matk = SkillFactory.getSkill(skillid).getEffect(poisonLevel).getMatk();\n                 int luk = from.getLuk();\n                 int maxDmg = (int) Math.ceil(Math.min(Short.MAX_VALUE, 0.2 * luk * matk));\n                 int minDmg = (int) Math.ceil(Math.min(Short.MAX_VALUE, 0.1 * luk * matk));"}, {"sha": "b24a3679f43888a4025c23ae0c04ef7ef79a8bd3", "filename": "src/server/life/MapleMonsterInformationProvider.java", "status": "modified", "additions": 50, "deletions": 1, "changes": 51, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/life/MapleMonsterInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/life/MapleMonsterInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonsterInformationProvider.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -20,32 +20,39 @@\n  */\n package server.life;\n \n+import constants.ItemConstants;\n+import constants.ServerConstants;\n import java.io.File;\n import java.sql.Connection;\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import provider.MapleData;\n import provider.MapleDataProvider;\n import provider.MapleDataProviderFactory;\n import provider.MapleDataTool;\n import server.MapleItemInformationProvider;\n import tools.DatabaseConnection;\n import tools.Pair;\n+import tools.Randomizer;\n \n public class MapleMonsterInformationProvider {\n \t// Author : LightPepsi\n \n \tprivate static final MapleMonsterInformationProvider instance = new MapleMonsterInformationProvider();\n-\tprivate final Map<Integer, List<MonsterDropEntry>> drops = new HashMap<>();\n+        private final Map<Integer, List<MonsterDropEntry>> drops = new HashMap<>();        \n \tprivate final List<MonsterGlobalDropEntry> globaldrops = new ArrayList<>();\n         \n         private final Map<Integer, List<Integer>> dropsChancePool = new HashMap<>();    // thanks to ronan\n+        private final Set<Integer> hasNoMultiEquipDrops = new HashSet<>();\n+        private final Map<Integer, List<MonsterDropEntry>> extraMultiEquipDrops = new HashMap<>();\n \n \tprotected MapleMonsterInformationProvider() {\n \t\tretrieveGlobal();\n@@ -103,6 +110,46 @@ private void retrieveGlobal() {\n \t\t}\n \t}\n \n+        public List<MonsterDropEntry> retrieveEffectiveDrop(final int monsterId) {\n+                // this reads the drop entries searching for multi-equip, properly processing them\n+            \n+                List<MonsterDropEntry> list = retrieveDrop(monsterId);\n+                if (hasNoMultiEquipDrops.contains(monsterId) || !ServerConstants.USE_MULTIPLE_SAME_EQUIP_DROP) {\n+\t\t\treturn list;\n+\t\t}\n+                \n+                List<MonsterDropEntry> multiDrops = extraMultiEquipDrops.get(monsterId), extra = new LinkedList<>();\n+                if(multiDrops == null) {\n+                        multiDrops = new LinkedList<>();\n+                        \n+                        for(MonsterDropEntry mde : list) {\n+                                if(ItemConstants.isEquipment(mde.itemId) && mde.Maximum > 1) {\n+                                        multiDrops.add(mde);\n+                                    \n+                                        int rnd = Randomizer.rand(mde.Minimum, mde.Maximum);\n+                                        for(int i = 0; i < rnd - 1; i++) {\n+                                                extra.add(mde);   // this passes copies of the equips' MDE with min/max quantity > 1, but idc it'll be unused anyways\n+                                        }\n+                                }\n+                        }\n+                        \n+                        if(!multiDrops.isEmpty()) extraMultiEquipDrops.put(monsterId, multiDrops);\n+                        else hasNoMultiEquipDrops.add(monsterId);\n+                } else {\n+                        for(MonsterDropEntry mde : multiDrops) {\n+                                int rnd = Randomizer.rand(mde.Minimum, mde.Maximum);\n+                                for(int i = 0; i < rnd - 1; i++) {\n+                                        extra.add(mde);\n+                                }\n+                        }\n+                }\n+                \n+                List<MonsterDropEntry> ret = new LinkedList<>(list);\n+                ret.addAll(extra);\n+                \n+                return ret;\n+        }\n+        \n \tpublic final List<MonsterDropEntry> retrieveDrop(final int monsterId) {\n \t\tif (drops.containsKey(monsterId)) {\n \t\t\treturn drops.get(monsterId);\n@@ -234,6 +281,8 @@ public static String getMobNameFromID(int id)\n \n \tpublic final void clearDrops() {\n \t\tdrops.clear();\n+                hasNoMultiEquipDrops.clear();\n+                extraMultiEquipDrops.clear();\n                 dropsChancePool.clear();\n \t\tglobaldrops.clear();\n \t\tretrieveGlobal();"}, {"sha": "701e540cbcfae1527e89d1b56e2d91e2546dcb0e", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -559,7 +559,7 @@ public static String getRoundedCoordinate(double angle) {\n         }\n         \n         distn = Math.sqrt(distn);\n-        return new Pair(getRoundedCoordinate(angle), Integer.valueOf((int)distn));\n+        return new Pair<>(getRoundedCoordinate(angle), Integer.valueOf((int)distn));\n     }\n \n     private static void sortDropEntries(List<MonsterDropEntry> from, List<MonsterDropEntry> item, List<MonsterDropEntry> quest) {\n@@ -667,7 +667,7 @@ private void dropFromMonster(final MapleCharacter chr, final MapleMonster mob, f\n         \n         final List<MonsterDropEntry>  dropEntry = new ArrayList<>();\n         final List<MonsterDropEntry> questEntry = new ArrayList<>();\n-        sortDropEntries(mi.retrieveDrop(mob.getId()), dropEntry, questEntry);\n+        sortDropEntries(mi.retrieveEffectiveDrop(mob.getId()), dropEntry, questEntry);\n         \n         // Normal Drops\n         d = dropItemsFromMonsterOnMap(dropEntry, pos, d, chRate, droptype, mobpos, chr, mob);\n@@ -1347,9 +1347,9 @@ public final void shuffleReactors(List<Object> list) {\n         \n         objectRLock.lock();\n         try {\n-            for (Object obj : list) {\n-                if(obj instanceof MapleMapObject) {\n-                    MapleMapObject mmo = (MapleMapObject) obj;\n+            for (Object ob : list) {\n+                if(ob instanceof MapleMapObject) {\n+                    MapleMapObject mmo = (MapleMapObject) ob;\n                     \n                     if(mapobjects.containsValue(mmo) && mmo.getType() == MapleMapObjectType.REACTOR) {\n                         listObjects.add(mmo);"}, {"sha": "8bebb849a2ca7a07d2b5492b4e84e6f284870222", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -272,9 +272,9 @@ private synchronized MapleMap loadMapFromWz(int mapid, Integer omapid) {\n         try {\n             for (MapleData layer : mapData.getChildByPath(\"back\")) { // yolo\n                 int layerNum = Integer.parseInt(layer.getName());\n-                int type = MapleDataTool.getInt(layer.getChildByPath(\"type\"), 0);\n+                int btype = MapleDataTool.getInt(layer.getChildByPath(\"type\"), 0);\n \n-                backTypes.put(layerNum, type);\n+                backTypes.put(layerNum, btype);\n             }\n         } catch (Exception e) {\n             e.printStackTrace();"}, {"sha": "51704ccaeefb0af5259baf5f6e9a0ee71a0af561", "filename": "src/server/maps/MapleMist.java", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMist.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/maps/MapleMist.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMist.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -71,12 +71,14 @@ public MapleMist(Rectangle mistPosition, MapleCharacter owner, MapleStatEffect s\n         this.isRecoveryMist = false;\n         this.isPoisonMist = false;\n         switch (source.getSourceId()) {\n-        \tcase Evan.RECOVERY_AURA:\n-        \t\tisRecoveryMist = true;\n-        \t\tbreak;\n+            case Evan.RECOVERY_AURA:\n+                isRecoveryMist = true;\n+                break;\n+                \n             case Shadower.SMOKE_SCREEN: // Smoke Screen\n                 isPoisonMist = false;\n                 break;\n+                \n             case FPMage.POISON_MIST: // FP mist\n             case BlazeWizard.FLAME_GEAR: // Flame Gear\n             case NightWalker.POISON_BOMB: // Poison Bomb"}, {"sha": "e06c16c40def7cb5f0737994f5445857c679d73a", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -131,26 +131,26 @@ public void run(MapleCharacter chr, Integer extSelection) {\n                 \n                 // must take all needed items before giving others\n                 \n-                for(Pair<Integer, Integer> iEntry: takeItem) {\n-                        MapleInventoryType type = ItemConstants.getInventoryType(iEntry.getLeft());\n-                        int quantity = iEntry.getRight() * -1; // Invert\n+                for(Pair<Integer, Integer> iPair: takeItem) {\n+                        MapleInventoryType type = ItemConstants.getInventoryType(iPair.getLeft());\n+                        int quantity = iPair.getRight() * -1; // Invert\n                         if(type.equals(MapleInventoryType.EQUIP)) {\n-                                if(chr.getInventory(type).countById(iEntry.getLeft()) < quantity) {\n+                                if(chr.getInventory(type).countById(iPair.getLeft()) < quantity) {\n                                         // Not enough in the equip inventoty, so check Equipped...\n-                                        if(chr.getInventory(MapleInventoryType.EQUIPPED).countById(iEntry.getLeft()) > quantity) {\n+                                        if(chr.getInventory(MapleInventoryType.EQUIPPED).countById(iPair.getLeft()) > quantity) {\n                                                 // Found it equipped, so change the type to equipped.\n                                                 type = MapleInventoryType.EQUIPPED;\n                                         }\n                                 }\n                         }\n \n-                        MapleInventoryManipulator.removeById(chr.getClient(), type, iEntry.getLeft(), quantity, true, false);\n-                        chr.announce(MaplePacketCreator.getShowItemGain(iEntry.getLeft(), (short) iEntry.getRight().shortValue(), true));\n+                        MapleInventoryManipulator.removeById(chr.getClient(), type, iPair.getLeft(), quantity, true, false);\n+                        chr.announce(MaplePacketCreator.getShowItemGain(iPair.getLeft(), (short) iPair.getRight().shortValue(), true));\n                 }\n                 \n-                for(Pair<Integer, Integer> iEntry: giveItem) {\n-                        MapleInventoryManipulator.addById(chr.getClient(), iEntry.getLeft(), (short) iEntry.getRight().shortValue());\n-                        chr.announce(MaplePacketCreator.getShowItemGain(iEntry.getLeft(), (short) iEntry.getRight().shortValue(), true));\n+                for(Pair<Integer, Integer> iPair: giveItem) {\n+                        MapleInventoryManipulator.addById(chr.getClient(), iPair.getLeft(), (short) iPair.getRight().shortValue());\n+                        chr.announce(MaplePacketCreator.getShowItemGain(iPair.getLeft(), (short) iPair.getRight().shortValue(), true));\n                 }\n \t}\n \t"}, {"sha": "fdd0f27497e2f839b907f8a41ce932b205145d52", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -1394,6 +1394,18 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 return spawnMonsterInternal(life, true, false, false, 0, true);\n         }\n \n+        private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter mplew, boolean newSpawn, int effect) {\n+                if (effect > 0) {\n+                        mplew.write(effect);\n+                        mplew.write(0);\n+                        mplew.writeShort(0);\n+                        if (effect == 15) {\n+                                mplew.write(0);\n+                        }\n+                }\n+                mplew.write(newSpawn ? -2 : -1);\n+        }\n+        \n         /**\n          * Internal function to handler monster spawning and controlling.\n          *\n@@ -1455,10 +1467,10 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                                 mplew.write(effect != 0 ? effect : -3);\n                                 mplew.writeInt(life.getParentMobOid());\n                         } else {\n-                                mplew.write(newSpawn ? -2 : -1);\n+                                encodeParentlessMobSpawnEffect(mplew, newSpawn, effect);\n                         }\n                 } else {\n-                \tmplew.write(newSpawn ? -2 : -1);\n+                \tencodeParentlessMobSpawnEffect(mplew, newSpawn, effect);\n                 }\n                 \n                 mplew.write(life.getTeam());"}, {"sha": "1d2c8b3f82371e6d178cffa216d32cb821db56c3", "filename": "wz/Quest.wz/Act.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/cd16117553ca1fe3c153d13bfcbd913f4be397aa/wz/Quest.wz/Act.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/cd16117553ca1fe3c153d13bfcbd913f4be397aa/wz/Quest.wz/Act.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Act.img.xml?ref=cd16117553ca1fe3c153d13bfcbd913f4be397aa", "patch": "@@ -12062,6 +12062,7 @@\n       <imgdir name=\"item\">\n         <imgdir name=\"0\">\n           <int name=\"id\" value=\"4031852\"/>\n+          <int name=\"count\" value=\"-1\"/>\n         </imgdir>\n       </imgdir>\n     </imgdir>"}]}]},
