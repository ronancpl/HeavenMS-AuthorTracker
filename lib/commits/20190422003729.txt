{"fetchDate": "2019-12-19", "content": [{"sha": "bad69dc66f0c3aad749b722d02f20339645ed941", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YmFkNjlkYzY2ZjBjM2FhZDc0OWI3MjJkMDJmMjAzMzk2NDVlZDk0MQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-22T00:37:29Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-04-22T00:37:29Z"}, "message": "Stat update & Mob skill animation & Yellow EXP patch + Packet logging\n\nSolved a deadlock case within character stat locks that would sometimes tangle up during stat update dispatch operations.\nFixed skill animation being unproperly casted when a mob tries to use a skill even though it couldn't possibly use from its current skillset.\nFixed a bug with EXP gain (on where the solo player is on a party) where the EXP would appear in yellow even after soloing a mob.\nAdded packet logging.\n\nHappy Easter, folks!", "tree": {"sha": "71c60a23581b9ca13bc769a9e46e6947dd660a7e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/71c60a23581b9ca13bc769a9e46e6947dd660a7e"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/bad69dc66f0c3aad749b722d02f20339645ed941", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bad69dc66f0c3aad749b722d02f20339645ed941", "html_url": "https://github.com/ronancpl/HeavenMS/commit/bad69dc66f0c3aad749b722d02f20339645ed941", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bad69dc66f0c3aad749b722d02f20339645ed941/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d121ba7d2a755479f4e93bea5fe516e0e9e59b78", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/d121ba7d2a755479f4e93bea5fe516e0e9e59b78", "html_url": "https://github.com/ronancpl/HeavenMS/commit/d121ba7d2a755479f4e93bea5fe516e0e9e59b78"}], "stats": {"total": 203, "additions": 186, "deletions": 17}, "files": [{"sha": "319875a734763e1373bf1c58d821132c8da7b38c", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -1796,6 +1796,13 @@ Corrigido loot de party n\u00e3o funcionando adequadamente ap\u00f3s updates recentes.\n Implementado loot de party agora atualizando tamb\u00e9m loots de jogadores ao entrar numa party (pronta permiss\u00e3o de coleta de loots de outros membros da party).\n Corrigido cooldown de skills de mob n\u00e3o atuando adequadamente.\n \n+08 - 09 Abril 2019,\n+Resolvido problema de deadlock envolvendo acesso a valores de stats de jogadores e diversas opera\u00e7\u00f5es de despacho de update de stats.\n+Corrigido mob skills que n\u00e3o se encontram dispon\u00edveis sendo passados para o cliente para serem usados. Resultado disso era efeito visual de skill sendo mostrado ao usu\u00e1rio, habilidade sem ser aplicada em sequ\u00eancia.\n+\n+12 Abril 2019,\n+Corrigido ganho visual do EXP de party ocasionalmente mostrando EXP em amarelo ao jogador em party solo.\n+\n 15 Abril 2019,\n Iniciado opera\u00e7\u00e3o de introdu\u00e7\u00e3o da AriantPQ no fonte, a partir do pull request feito pelo Dragohe4rt.\n Ajustado Dimensional Door, agora permitindo jogadores a entrar no sagu\u00e3o de entrada da AriantPQ.\n@@ -1807,4 +1814,7 @@ Adicionado mec\u00e2nica de n\u00famero de jogadores requerido pelo l\u00edder de um lobby n\n Corrigido jogadores podendo criar/entrar em party dentro de inst\u00e2ncias da AriantPQ.\n Ajustado inst\u00e2ncia da AriantPQ para perdurar ap\u00f3s o fim das batalhas (acesso a King's room ainda faz parte da inst\u00e2ncia, para adquirir os valores dos resultados do evento).\n Ajustado drops de mobs, agora sendo buscado na DB.\n-Ajustado diversas mec\u00e2nicas da AriantPQ, tais como update visual da pontua\u00e7\u00e3o de jogadores (ao dropar itens, ganhar itens, acessar mapa de evento), pontos de batalha persistindo na DB, etc.\n\\ No newline at end of file\n+Ajustado diversas mec\u00e2nicas da AriantPQ, tais como update visual da pontua\u00e7\u00e3o de jogadores (ao dropar itens, ganhar itens, acessar mapa de evento), pontos de batalha persistindo na DB, etc.\n+\n+21 Abril 2019,\n+Adicionado debug de packets descrito pelo Atoot.\n\\ No newline at end of file"}, {"sha": "6da750484ece26fd04a1bfe0f4d5960ffa60a01d", "filename": "src/client/AbstractMapleCharacterObject.java", "status": "modified", "additions": 35, "deletions": 4, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/client/AbstractMapleCharacterObject.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/client/AbstractMapleCharacterObject.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/AbstractMapleCharacterObject.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -32,12 +32,14 @@\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n import server.maps.AbstractAnimatedMapleMapObject;\n+import server.maps.MapleMap;\n \n /**\n  *\n  * @author RonanLana\n  */\n public abstract class AbstractMapleCharacterObject extends AbstractAnimatedMapleMapObject {\n+    protected MapleMap map;\n     protected int str, dex, luk, int_, hp, maxhp, mp, maxmp;\n     protected int hpMpApUsed, remainingAp;\n     protected int[] remainingSp = new int[10];\n@@ -65,6 +67,14 @@ protected void setListener(AbstractCharacterListener listener) {\n         this.listener = listener;\n     }\n     \n+    public void setMap(MapleMap map) {\n+        this.map = map;\n+    }\n+    \n+    public MapleMap getMap() {\n+        return map;\n+    }\n+    \n     public int getStr() {\n         statRlock.lock();\n         try {\n@@ -202,16 +212,37 @@ private void setHpMpApUsed(int mpApUsed) {\n         this.hpMpApUsed = mpApUsed;\n     }\n     \n-    private void dispatchHpChanged(int oldHp) {\n-        listener.onHpChanged(oldHp);\n+    private void dispatchHpChanged(final int oldHp) {\n+        Runnable r = new Runnable() {   // thanks BHB (BHB88) for detecting a deadlock case within player stats.\n+            @Override\n+            public void run() {\n+                listener.onHpChanged(oldHp);\n+            }\n+        };\n+        \n+        map.registerCharacterStatUpdate(r);\n     }\n     \n     private void dispatchHpmpPoolUpdated() {\n-        listener.onHpmpPoolUpdate();\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                listener.onHpmpPoolUpdate();\n+            }\n+        };\n+        \n+        map.registerCharacterStatUpdate(r);\n     }\n     \n     private void dispatchStatPoolUpdateAnnounced() {\n-        listener.onAnnounceStatPoolUpdate();\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                listener.onAnnounceStatPoolUpdate();\n+            }\n+        };\n+        \n+        map.registerCharacterStatUpdate(r);\n     }\n     \n     protected void setHp(int newHp) {"}, {"sha": "2f7dfab3fa7ba14da0b9863b51916abcde5c1926", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -229,7 +229,6 @@\n     private MaplePartyCharacter mpc = null;\n     private MapleInventory[] inventory;\n     private MapleJob job = MapleJob.BEGINNER;\n-    private MapleMap map;\n     private MapleMessenger messenger = null;\n     private MapleMiniGame miniGame;\n     private MapleMount maplemount;\n@@ -4847,10 +4846,6 @@ public int getFh() {\n         }\n     }\n \n-    public MapleMap getMap() {\n-        return map;\n-    }\n-\n     public int getMapId() {\n         if (map != null) {\n             return map.getId();\n@@ -8713,10 +8708,6 @@ public void setLevel(int level) {\n     public void setMap(int PmapId) {\n         this.mapid = PmapId;\n     }\n-\n-    public void setMap(MapleMap newmap) {\n-        this.map = newmap;\n-    }\n     \n     public void setMessenger(MapleMessenger messenger) {\n         this.messenger = messenger;"}, {"sha": "a00bc90bd2ef594dd5107eee1c782f7085a39771", "filename": "src/constants/CharsetConstants.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/CharsetConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/CharsetConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/CharsetConstants.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -15,7 +15,7 @@\n  \n public class CharsetConstants {\n    \n-    public static MapleLanguageType MAPLE_TYPE = MapleLanguageType.LANGUAGE_PT_BR;\n+    public static MapleLanguageType MAPLE_TYPE = MapleLanguageType.LANGUAGE_US;\n    \n     public enum MapleLanguageType {\n         LANGUAGE_PT_BR(1, \"ISO-8859-1\"),"}, {"sha": "970be0c247a404790ce960bd0771c488e7fc5e8e", "filename": "src/constants/OpcodeConstants.java", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/OpcodeConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/OpcodeConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/OpcodeConstants.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -0,0 +1,45 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server, commands OdinMS-based\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package constants;\n+\n+import java.util.Map;\n+import java.util.HashMap;\n+import net.opcodes.RecvOpcode;\n+import net.opcodes.SendOpcode;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class OpcodeConstants {\n+    public static Map<Integer, String> sendOpcodeNames = new HashMap<>();\n+    public static Map<Integer, String> recvOpcodeNames = new HashMap<>();\n+    \n+    public static void generateOpcodeNames() {\n+        for (SendOpcode op : SendOpcode.values()) {\n+            sendOpcodeNames.put(op.getValue(), op.name());\n+        }\n+        \n+        for (RecvOpcode op : RecvOpcode.values()) {\n+            recvOpcodeNames.put(op.getValue(), op.name());\n+        }\n+    }\n+    \n+}"}, {"sha": "d509bedd4265891bfbb26254bc91ff48035df577", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -62,6 +62,7 @@\n     public static final boolean USE_DEBUG_SHOW_INFO_EQPEXP = false; //Prints on the cmd all equip exp gain info.\n     public static       boolean USE_DEBUG_SHOW_RCVD_PACKET = false; //Prints on the cmd all received packet ids.\n     public static       boolean USE_DEBUG_SHOW_RCVD_MVLIFE = false; //Prints on the cmd all received move life content.\n+    public static final boolean USE_DEBUG_SHOW_PACKET = false;\n     public static       boolean USE_SUPPLY_RATE_COUPONS = true;     //Allows rate coupons to be sold through the Cash Shop.\n     \n     public static final boolean USE_MAXRANGE = true;                //Will send and receive packets from all events on a map, rather than those of only view range."}, {"sha": "0acffa288139e39cdb0e10ab87b1e89a5e81c62f", "filename": "src/net/mina/MaplePacketDecoder.java", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/mina/MaplePacketDecoder.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/mina/MaplePacketDecoder.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/mina/MaplePacketDecoder.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -21,13 +21,20 @@\n */\n package net.mina;\n \n+import constants.ServerConstants;\n import client.MapleClient;\n+import constants.OpcodeConstants;\n import net.server.coordinator.MapleSessionCoordinator;\n import org.apache.mina.core.buffer.IoBuffer;\n import org.apache.mina.core.session.IoSession;\n import org.apache.mina.filter.codec.CumulativeProtocolDecoder;\n import org.apache.mina.filter.codec.ProtocolDecoderOutput;\n+import tools.HexTool;\n import tools.MapleAESOFB;\n+import tools.data.input.ByteArrayByteStream;\n+import tools.data.input.GenericLittleEndianAccessor;\n+import net.opcodes.RecvOpcode;\n+import tools.FilePrinter;\n \n public class MaplePacketDecoder extends CumulativeProtocolDecoder {\n     private static final String DECODER_STATE_KEY = MaplePacketDecoder.class.getName() + \".STATE\";\n@@ -68,8 +75,32 @@ protected boolean doDecode(IoSession session, IoBuffer in, ProtocolDecoderOutput\n             rcvdCrypto.crypt(decryptedPacket);\n             MapleCustomEncryption.decryptData(decryptedPacket);\n             out.write(decryptedPacket);\n+            if (ServerConstants.USE_DEBUG_SHOW_PACKET){ // packet traffic log: Atoot's idea, applied using auto-identation thanks to lrenex\n+                int packetLen = decryptedPacket.length;\n+                int pHeader = readFirstShort(decryptedPacket);\n+                String pHeaderStr = Integer.toHexString(pHeader).toUpperCase();\n+                String op = lookupSend(pHeader);\n+                String Send = \"ClientSend:\" + op + \" [\" + pHeaderStr + \"] (\" + packetLen + \")\\r\\n\";\n+                if (packetLen <= 3000) {\n+                    String SendTo = Send + HexTool.toString(decryptedPacket) + \"\\r\\n\" + HexTool.toStringFromAscii(decryptedPacket);\n+                    System.out.println(SendTo);\n+                    if (op == null) {\n+                        System.out.println(\"UnknownPacket:\" + SendTo);\n+                    }\n+                } else {\n+                    FilePrinter.print(FilePrinter.PACKET_STREAM + MapleSessionCoordinator.getSessionRemoteAddress(session) + \".txt\", HexTool.toString(new byte[]{decryptedPacket[0], decryptedPacket[1]}) + \"...\");\n+                }\n+            }\n             return true;\n         }\n         return false;\n     }\n+    \n+    private String lookupSend(int val) {\n+        return OpcodeConstants.recvOpcodeNames.get(val);\n+    }\n+\n+    private int readFirstShort(byte[] arr) {\n+        return new GenericLittleEndianAccessor(new ByteArrayByteStream(arr)).readShort();\n+    }\n }"}, {"sha": "9887244c1dcf1973872e9182c86041bc012b1c31", "filename": "src/net/mina/MaplePacketEncoder.java", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/mina/MaplePacketEncoder.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/mina/MaplePacketEncoder.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/mina/MaplePacketEncoder.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -21,12 +21,20 @@\n  */\n package net.mina;\n \n+import constants.ServerConstants;\n import client.MapleClient;\n+import constants.OpcodeConstants;\n+import net.opcodes.SendOpcode;\n+import net.server.coordinator.MapleSessionCoordinator;\n import org.apache.mina.core.buffer.IoBuffer;\n import org.apache.mina.core.session.IoSession;\n import org.apache.mina.filter.codec.ProtocolEncoder;\n import org.apache.mina.filter.codec.ProtocolEncoderOutput;\n import tools.MapleAESOFB;\n+import tools.HexTool;\n+import tools.data.input.ByteArrayByteStream;\n+import tools.data.input.GenericLittleEndianAccessor;\n+import tools.FilePrinter;\n \n public class MaplePacketEncoder implements ProtocolEncoder {\n \n@@ -39,6 +47,23 @@ public void encode(final IoSession session, final Object message, final Protocol\n             try {\n                 final MapleAESOFB send_crypto = client.getSendCrypto();\n                 final byte[] input = (byte[]) message;\n+                if (ServerConstants.USE_DEBUG_SHOW_PACKET) {\n+                    int packetLen = input.length;\n+                    int pHeader = readFirstShort(input);\n+                    String pHeaderStr = Integer.toHexString(pHeader).toUpperCase();\n+                    String op = lookupRecv(pHeader);\n+                    String Recv = \"ServerSend:\" + op + \" [\" + pHeaderStr + \"] (\" + packetLen + \")\\r\\n\";\n+                    if (packetLen <= 50000) {\n+                        String RecvTo = Recv + HexTool.toString(input) + \"\\r\\n\" + HexTool.toStringFromAscii(input);\n+                        System.out.println(RecvTo);\n+                        if (op == null) {\n+                            System.out.println(\"UnknownPacket:\" + RecvTo);\n+                        }\n+                    } else {\n+                        FilePrinter.print(FilePrinter.PACKET_STREAM + MapleSessionCoordinator.getSessionRemoteAddress(session) + \".txt\", HexTool.toString(new byte[]{input[0], input[1]}) + \" ...\");\n+                    }\n+                }\n+                \n                 final byte[] unencrypted = new byte[input.length];\n                 System.arraycopy(input, 0, unencrypted, 0, input.length);\n                 final byte[] ret = new byte[unencrypted.length + 4];\n@@ -59,6 +84,14 @@ public void encode(final IoSession session, final Object message, final Protocol\n             out.write(IoBuffer.wrap(((byte[]) message)));\n         }\n     }\n+    \n+    private String lookupRecv(int val) {\n+        return OpcodeConstants.sendOpcodeNames.get(val);\n+    }\n+\n+    private int readFirstShort(byte[] arr) {\n+        return new GenericLittleEndianAccessor(new ByteArrayByteStream(arr)).readShort();\n+    }\n \n     @Override\n     public void dispose(IoSession session) throws Exception {}"}, {"sha": "25ab73af6dab990f5877df875f385e1f746586dd", "filename": "src/net/server/Server.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -86,6 +86,7 @@\n import client.newyear.NewYearCardRecord;\n import constants.ItemConstants;\n import constants.GameConstants;\n+import constants.OpcodeConstants;\n import constants.ServerConstants;\n import java.util.TimeZone;\n import net.server.coordinator.MapleSessionCoordinator;\n@@ -969,6 +970,7 @@ public void init() {\n         online = true;\n         \n         MapleSkillbookInformationProvider.getInstance();\n+        OpcodeConstants.generateOpcodeNames();\n     }\n \n     public static void main(String args[]) {"}, {"sha": "29822708c59a0b84706c9916e1c5f2fc6400d04c", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -126,7 +126,9 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 nextSkillLevel = skillToUse.getRight();\n                                 nextUse = MobSkillFactory.getMobSkill(nextSkillId, nextSkillLevel);\n                                 \n-                                if (!(nextUse != null && nextUse.getHP() >= (int) (((float) monster.getHp() / monster.getMaxHp()) * 100) && mobMp >= nextUse.getMpCon())) {\n+                                if (!(nextUse != null && monster.canUseSkill(nextUse) && nextUse.getHP() >= (int) (((float) monster.getHp() / monster.getMaxHp()) * 100) && mobMp >= nextUse.getMpCon())) {\n+                                        // thanks OishiiKawaiiDesu for noticing mobs trying to cast skills they are not supposed to be able\n+                                        \n                                         nextSkillId = 0;\n                                         nextSkillLevel = 0;\n                                         nextUse = null;"}, {"sha": "ed7a46af656602ba50e778cce81670c49c9ef6be", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -541,12 +541,14 @@ private static double calcExperienceStandDevThreshold(Map<MapleCharacter, Float>\n             avgExpReward += exp;\n         }\n         \n+        // thanks Simon for finding an issue with solo party player gaining yellow EXP when soloing mobs\n+        float realAvgExpReward = avgExpReward;\n         avgExpReward -= exp2;   // clear out the 20% raw exp from last hitting\n         avgExpReward /= personalExpReward.size();\n         \n         float varExpReward = 0.0f;\n         for (Float exp : personalExpReward.values()) {\n-            varExpReward += Math.pow(exp - avgExpReward, 2);\n+            varExpReward += Math.pow(exp - realAvgExpReward, 2);\n         }\n         varExpReward /= personalExpReward.size();\n         "}, {"sha": "72ac10b490994715edb6568d35290b402e187505", "filename": "src/tools/FilePrinter.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/tools/FilePrinter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/tools/FilePrinter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/FilePrinter.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -52,6 +52,7 @@\n             EXPLOITS = \"game/exploits/\",\n             STORAGE = \"game/storage/\",\n             PACKET_LOGS = \"game/packetlogs/\",\n+            PACKET_STREAM = \"game/packetstream/\",\n             FREDRICK = \"game/npcs/fredrick/\",\n             NPC_UNCODED = \"game/npcs/UncodedNPCs.txt\",\n             QUEST_UNCODED = \"game/quests/UncodedQuests.txt\","}, {"sha": "d1853edfcc8bc68db96ed1c4082af47605335c56", "filename": "src/tools/HexTool.java", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/bad69dc66f0c3aad749b722d02f20339645ed941/src/tools/HexTool.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/bad69dc66f0c3aad749b722d02f20339645ed941/src/tools/HexTool.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/HexTool.java?ref=bad69dc66f0c3aad749b722d02f20339645ed941", "patch": "@@ -21,6 +21,7 @@\n */\n package tools;\n \n+import constants.CharsetConstants;\n import java.io.ByteArrayOutputStream;\n \n public class HexTool {\n@@ -84,4 +85,23 @@ public static String toCompressedString(byte[] bytes) {\n         }\n         return baos.toByteArray();\n     }\n+    \n+    public static final String toStringFromAscii(final byte[] bytes) {\n+        byte[] ret = new byte[bytes.length];\n+        for (int x = 0; x < bytes.length; x++) {\n+            if (bytes[x] < 32 && bytes[x] >= 0) {\n+                ret[x] = '.';\n+            } else {\n+                int chr = ((short) bytes[x]) & 0xFF;\n+                ret[x] = (byte) chr;\n+            }\n+        }\n+        String encode = CharsetConstants.MAPLE_TYPE.getAscii();\n+        try {\n+            String str = new String(ret, encode);\n+            return str;\n+        } catch (Exception e) {}\n+        return \"\";\n+    }\n+\n }"}]}]},
