{"fetchDate": "2019-12-19", "content": [{"sha": "0b8d3a0b2b09938713c283eb626c92cdd424de63", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6MGI4ZDNhMGIyYjA5OTM4NzEzYzI4M2ViNjI2YzkyY2RkNDI0ZGU2Mw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-06-08T16:21:03Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-06-08T16:21:03Z"}, "message": "Return map & MaplePacketEncoder & Quest status patch\n\nFixed null pointer issue when trying to use return scroll on maps such as Mu Lung.\nFixed a critical deadlock issue with MaplePacketEncoder.\nFixed a critical DB leak regarding player's quest status.", "tree": {"sha": "67a9fd8b44c2c45698549c534ea426cf7b2cdb96", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/67a9fd8b44c2c45698549c534ea426cf7b2cdb96"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/0b8d3a0b2b09938713c283eb626c92cdd424de63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0b8d3a0b2b09938713c283eb626c92cdd424de63", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0b8d3a0b2b09938713c283eb626c92cdd424de63", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0b8d3a0b2b09938713c283eb626c92cdd424de63/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cdac59326a8da9e8c0b5189540af65afdbedbef6", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/cdac59326a8da9e8c0b5189540af65afdbedbef6", "html_url": "https://github.com/ronancpl/HeavenMS/commit/cdac59326a8da9e8c0b5189540af65afdbedbef6"}], "stats": {"total": 253, "additions": 218, "deletions": 35}, "files": [{"sha": "28e6649bdcaa16226862ac2042aa50e32aa8c762", "filename": "docs/feature_list.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -185,7 +185,7 @@ Exploits patched:\n * Player being given free access to any character of any account once they have authenticated their account on login phase.\n * Player being given permission to delete any character of any account once they have authenticated their account on login phase.\n * Player being able to start/complete any quest freely.\n-* Several assynchronous-oriented explots patched, highlights on those involving Fredrick & Duey.\n+* Several assynchronous-oriented exploits patched, highlights on those involving Fredrick & Duey.\n \n Localhost:\n "}, {"sha": "f609ae292528eb6f7fb1c2354ab70a1546734c3a", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -1019,4 +1019,10 @@ Corrigido hired merchants agora removendo visitantes e dono quando expira.\n Item maker agora puxa itemid de catalisadores do WZ.\n Corrigido sistema de evolu\u00e7\u00e3o de pets passando valor de expira\u00e7\u00e3o com overflow pro novo pet, que resultava em pet inativo.\n Melhorado prote\u00e7\u00e3o contra acesso concorrente em mais algumas se\u00e7\u00f5es de c\u00f3digo de player shop e hired merchants.\n-Adicionado comportamento de substitui\u00e7\u00e3o de itens ao expirar, cortesia do GabrielSin.\n\\ No newline at end of file\n+Adicionado comportamento de substitui\u00e7\u00e3o de itens ao expirar, cortesia do GabrielSin.\n+\n+07 Junho 2018,\n+Corrigido ponteiro nulo ao tentar usar return scroll em mapas como Mu Lung.\n+Corrigido um cr\u00edtico problema de deadlock com o MaplePacketEncoder.\n+Corrigido um cr\u00edtico problema de vazamento de dados na DB referente ao quest status.\n+4th job Aran agora usa script de evento, evitando m\u00faltiplos jogadores lutando contra m\u00faltiplas Mahas.\n\\ No newline at end of file"}, {"sha": "08698a39946d93de1df98bf8abbcbd67358bbd2d", "filename": "scripts/event/MahaBattle.js", "status": "added", "additions": 155, "deletions": 0, "changes": 155, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/event/MahaBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/event/MahaBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/MahaBattle.js?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -0,0 +1,155 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/**\n+ * @author: Ronan\n+ * @event: Vs Uncontrollable Maha\n+*/\n+\n+var entryMap = 914020000;\n+var exitMap = 140000000;\n+var recruitMap = 140000000;\n+var clearMap = 140000000;\n+\n+var minMapId = 914020000;\n+var maxMapId = 914020000;\n+\n+var eventTime = 10;     // 10 minutes\n+\n+var lobbyRange = [0, 0];\n+\n+function init() {}\n+\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Maha\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        eim.setProperty(\"boss\", \"0\");\n+        \n+        var mapObj = eim.getInstanceMap(entryMap);\n+        mapObj.resetPQ(level);\n+        mapObj.instanceMapForceRespawn();\n+        \n+        respawnStages(eim);\n+        eim.startEventTimer(eventTime * 60000);\n+        return eim;\n+}\n+\n+function afterSetup(eim) {}\n+\n+function respawnStages(eim) {}\n+\n+function playerEntry(eim, player) {\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+}\n+\n+function scheduledTimeout(eim) {\n+        end(eim);\n+}\n+\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n+}\n+\n+function playerLeft(eim, player) {\n+        if(!eim.isEventCleared()) {\n+                playerExit(eim, player);\n+        }\n+}\n+\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n+        }\n+}\n+\n+function changedLeader(eim, leader) {}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n+}\n+\n+function leftParty(eim, player) {}\n+\n+function disbandParty(eim) {}\n+\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n+\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        \n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n+}\n+\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n+}\n+\n+function clearPQ(eim) {\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n+}\n+\n+function isMaha(mob) {\n+        var mobid = mob.getId();\n+        return mobid == 9001014;\n+}\n+\n+function monsterKilled(mob, eim) {\n+        if(isMaha(mob)) {\n+                eim.clearPQ();\n+        }\n+}\n+\n+function allMonstersDead(eim) {}\n+\n+function cancelSchedule() {}\n+\n+function dispose(eim) {}\n+"}, {"sha": "8608e7552c05e8e08dc3a68de2feea434f63df71", "filename": "scripts/npc/2060100.js", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/npc/2060100.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/npc/2060100.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2060100.js?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -22,11 +22,15 @@\n //carta\n function start(){\n     if(cm.isQuestStarted(6301)) {\n-        if (cm.haveItem(4000175))\n+        if (cm.haveItem(4000175)) {\n+            cm.gainItem(4000175, -1);\n             cm.warp(923000000, 0);\n-        else\n+        } else {\n             cm.sendOk(\"In order to open the crack of dimension you will have to posess one piece of Miniature Pianus. Those could be gained by defeating a Pianus.\");\n-    } else\n+        }\n+    } else {\n         cm.sendOk(\"I'm #bCarta the sea-witch.#k Don't fool around with me, as I'm known for my habit of turning people into worms.\");\n+    }\n+    \n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "a096199942abefb9d4a67e4941d9a27823bcd900", "filename": "scripts/quest/21401.js", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/quest/21401.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/scripts/quest/21401.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21401.js?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -24,9 +24,11 @@ function start(mode, type, selection) {\n \t} else if (status == 4) {\n \t\tqm.startQuest();\n \t\t\n-\t\tvar map = qm.getClient().getChannelServer().getMapFactory().getMap(914020000);\n-\t\tspawnMob(-365, 86, 9001014, map);\n-\t\tqm.warp(914020000, 0);\n+                var mb = qm.getEventManager(\"MahaBattle\");\n+                mb.newInstance(\"MahaBattle\");\n+                mb.setProperty(\"player\", qm.getPlayer().getName());\n+                mb.startInstance(qm.getPlayer());\n+\t\t\n \t\tqm.dispose();\n \t}\n }"}, {"sha": "eb1d85ce89d29e0b68d799953fec9f0d7fd46028", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -2032,6 +2032,11 @@ private static void deleteQuestProgressWhereCharacterId(Connection con, int cid)\n             ps.setInt(1, cid);\n             ps.executeUpdate();\n         }\n+        \n+        try (PreparedStatement ps = con.prepareStatement(\"DELETE FROM queststatus WHERE characterid = ?\")) {\n+            ps.setInt(1, cid);\n+            ps.executeUpdate();\n+        }\n     }\n \n     private void deleteWhereCharacterId(Connection con, String sql) throws SQLException {\n@@ -3717,7 +3722,7 @@ public void run() {\n                     MapleBuffStatValueHolder mbsvh = effects.get(statup.getKey());\n                     MapleBuffStatValueHolder statMbsvh = statup.getValue();\n                     \n-                    if(mbsvh == null || mbsvh.value < statMbsvh.value || (mbsvh.value == statMbsvh.value && mbsvh.effect.getStatups().size() < statMbsvh.effect.getStatups().size())) {\n+                    if(mbsvh == null || mbsvh.value < statMbsvh.value || (mbsvh.value == statMbsvh.value && mbsvh.effect.getStatups().size() <= statMbsvh.effect.getStatups().size())) {\n                         toDeploy.put(statup.getKey(), statMbsvh);\n                     } else {\n                         if(!isSingletonStatup(statup.getKey())) {\n@@ -5969,7 +5974,6 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n                 rs = ps.executeQuery();\n                 \n                 Map<Integer, MapleQuestStatus> loadedQuestStatus = new LinkedHashMap<>();\n-                \n                 while (rs.next()) {\n                     MapleQuest q = MapleQuest.getInstance(rs.getShort(\"quest\"));\n                     MapleQuestStatus status = new MapleQuestStatus(q, MapleQuestStatus.Status.getById(rs.getInt(\"status\")));\n@@ -6011,9 +6015,11 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n                     }\n                 }\n                 \n+                /*\n                 for(MapleQuestStatus mqs : loadedQuestStatus.values()) {\n                     mqs.resetUpdated();\n                 }\n+                */\n                 \n                 loadedQuestStatus.clear();\n                 \n@@ -7071,8 +7077,6 @@ public synchronized void saveToDB(boolean notAutosave) {\n                 \n                 synchronized (quests) {\n                     for (MapleQuestStatus q : quests.values()) {\n-                        if(!q.wasUpdated()) continue;\n-                        \n                         ps.setInt(2, q.getQuest().getId());\n                         ps.setInt(3, q.getStatus().getId());\n                         ps.setInt(4, (int) (q.getCompletionTime() / 1000));"}, {"sha": "9b61629e0162c156d159af50cc5f49a7e79aa452", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -106,6 +106,7 @@\n \tprivate byte gender = -1;\n \tprivate boolean disconnecting = false;\n \tprivate final Lock lock = new MonitoredReentrantLock(MonitoredLockType.CLIENT, true);\n+        private final Lock encoderLock = new MonitoredReentrantLock(MonitoredLockType.CLIENT, true);\n         private static final Lock loginLock = new MonitoredReentrantLock(MonitoredLockType.CLIENT, true);\n \tprivate int votePoints;\n \tprivate int voteTime = -1;\n@@ -1142,6 +1143,14 @@ public void lockClient() {\n         public void unlockClient() {\n                 lock.unlock();\n \t}\n+        \n+        public void lockEncoder() {\n+                encoderLock.lock();\n+\t}\n+        \n+        public void unlockEncoder() {\n+                encoderLock.unlock();\n+\t}\n \n \tprivate static class CharNameAndId {\n "}, {"sha": "4eb31ce1fc200cf88b00d9e4dc24b1e6259ffaed", "filename": "src/client/MapleQuestStatus.java", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleQuestStatus.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/client/MapleQuestStatus.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleQuestStatus.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -60,7 +60,7 @@ public static Status getById(int id) {\n     }\n     private short questID;\n     private Status status;\n-    private boolean updated;\n+    //private boolean updated;   //maybe this can be of use for someone?\n     private final Map<Integer, String> progress = new LinkedHashMap<Integer, String>();\n     private final List<Integer> medalProgress = new LinkedList<Integer>();\n     private int npc;\n@@ -73,7 +73,7 @@ public MapleQuestStatus(MapleQuest quest, Status status) {\n         this.setStatus(status);\n         this.completionTime = System.currentTimeMillis();\n         this.expirationTime = 0;\n-        this.updated = true;\n+        //this.updated = true;\n         if (status == Status.STARTED) \n             registerMobs();      \n     }\n@@ -84,7 +84,7 @@ public MapleQuestStatus(MapleQuest quest, Status status, int npc) {\n         this.setNpc(npc);\n         this.completionTime = System.currentTimeMillis();\n         this.expirationTime = 0;\n-        this.updated = true;\n+        //this.updated = true;\n         if (status == Status.STARTED) {\n             registerMobs();\n         }\n@@ -106,17 +106,19 @@ public final void setStatus(Status status) {\n         this.status = status;\n     }\n     \n+    /*\n     public boolean wasUpdated() {\n         return updated;\n     }\n     \n-    public void setUpdated() {\n+    private void setUpdated() {\n         this.updated = true;\n     }\n     \n     public void resetUpdated() {\n         this.updated = false;\n     }\n+    */\n \n     public int getNpc() {\n         return npc;\n@@ -130,13 +132,13 @@ private void registerMobs() {\n         for (int i : MapleQuest.getInstance(questID).getRelevantMobs()) {\n             progress.put(i, \"000\");\n         }\n-        this.setUpdated();\n+        //this.setUpdated();\n     }\n \n     public boolean addMedalMap(int mapid) {\n         if (medalProgress.contains(mapid)) return false;\n         medalProgress.add(mapid);\n-        this.setUpdated();\n+        //this.setUpdated();\n         return true;\n     }\n \n@@ -153,15 +155,15 @@ public boolean progress(int id) {\n             int current = Integer.parseInt(progress.get(id));\n             String str = StringUtil.getLeftPaddedStr(Integer.toString(current + 1), '0', 3);\n             progress.put(id, str);\n-            this.setUpdated();\n+            //this.setUpdated();\n             return true;\n         }\n         return false;\n     }\n \n     public void setProgress(int id, String pr) {\n         progress.put(id, pr);\n-        this.setUpdated();\n+        //this.setUpdated();\n     }\n \n     public boolean madeProgress() {\n@@ -221,7 +223,7 @@ public String getInfo() {\n     \n     public void setInfo(String newInfo) {\n         progress.put(0, newInfo);\n-        this.setUpdated();\n+        //this.setUpdated();\n     }\n \n     public void setForfeited(int forfeited) {"}, {"sha": "3e4704406ae8fb37039c20f6d17385920c4f50e2", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -110,7 +110,7 @@\n     public static final int MAX_EVENT_LEVELS = 8;                       //Event has different levels of rewarding system.\n     public static final long BLOCK_NPC_RACE_CONDT = (long)(0.5 * 1000); //Time the player client must wait before reopening a conversation with an NPC.\n     public static final long PET_LOOT_UPON_ATTACK = (long)(0.7 * 1000); //Time the pet must wait before trying to pick items up.\n-    public static final int TOT_MOB_QUEST_REQUIREMENT = 0;              //Overwrites old 999-mobs requirement for the ToT questline with new requirement value, set 0 for default.\n+    public static final int TOT_MOB_QUEST_REQUIREMENT = 77;              //Overwrites old 999-mobs requirement for the ToT questline with new requirement value, set 0 for default.\n     public static final int MOB_REACTOR_REFRESH_TIME = 30 * 1000;       //Overwrites refresh time for those reactors oriented to inflict damage to bosses (Ice Queen, Riche), set 0 for default.\n     \n     //Dangling Items/Locks Configuration"}, {"sha": "2086bca1d9a287d62570a5b418dd1d5faccbf94d", "filename": "src/net/mina/MaplePacketEncoder.java", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/net/mina/MaplePacketEncoder.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/net/mina/MaplePacketEncoder.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/mina/MaplePacketEncoder.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -22,7 +22,6 @@\n package net.mina;\n \n import client.MapleClient;\n-import java.util.concurrent.locks.Lock;\n import org.apache.mina.core.buffer.IoBuffer;\n import org.apache.mina.core.session.IoSession;\n import org.apache.mina.filter.codec.ProtocolEncoder;\n@@ -36,7 +35,7 @@ public void encode(final IoSession session, final Object message, final Protocol\n         final MapleClient client = (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n \n         try {\n-            client.lockClient();\n+            client.lockEncoder();\n             try {\n                 final MapleAESOFB send_crypto = client.getSendCrypto();\n                 final byte[] input = (byte[]) message;\n@@ -52,7 +51,7 @@ public void encode(final IoSession session, final Object message, final Protocol\n                 \n                 out.write(IoBuffer.wrap(ret));\n             } finally {\n-                client.unlockClient();\n+                client.unlockEncoder();\n             }\n //            System.arraycopy(unencrypted, 0, ret, 4, unencrypted.length);\n //            out.write(ByteBuffer.wrap(ret));"}, {"sha": "988d2fc0ca070c00d4482e700fe5d0816e6b1d35", "filename": "src/net/server/channel/handlers/ItemPickupHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/net/server/channel/handlers/ItemPickupHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/net/server/channel/handlers/ItemPickupHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ItemPickupHandler.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -44,6 +44,7 @@ public final void handlePacket(final SeekableLittleEndianAccessor slea, final Ma\n         int oid = slea.readInt();\n         MapleCharacter chr = c.getPlayer();\n         MapleMapObject ob = chr.getMap().getMapObject(oid);\n+        if(ob == null) return;\n         \n         Point charPos = chr.getPosition();\n         Point obPos = ob.getPosition();"}, {"sha": "cc5a08d3ab89f8efc9f6c673aab8b8dea85befa0", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -1037,26 +1037,26 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n         int seconds = localDuration / 1000;\n         MapleMount givemount = null;\n         if (isMonsterRiding()) {\n-            int ridingLevel = 0;\n+            int ridingMountId = 0;\n             Item mount = applyfrom.getInventory(MapleInventoryType.EQUIPPED).getItem((short) -18);\n             if (mount != null) {\n-                ridingLevel = mount.getItemId();\n+                ridingMountId = mount.getItemId();\n             }\n             if (sourceid == Corsair.BATTLE_SHIP) {\n-                ridingLevel = 1932000;\n+                ridingMountId = 1932000;\n             } else if (sourceid == Beginner.SPACESHIP || sourceid == Noblesse.SPACESHIP) {\n-                ridingLevel = 1932000 + applyto.getSkillLevel(sourceid);\n+                ridingMountId = 1932000 + applyto.getSkillLevel(sourceid);\n             } else if (sourceid == Beginner.YETI_MOUNT1 || sourceid == Noblesse.YETI_MOUNT1 || sourceid == Legend.YETI_MOUNT1) {\n-                ridingLevel = 1932003;\n+                ridingMountId = 1932003;\n             } else if (sourceid == Beginner.YETI_MOUNT2 || sourceid == Noblesse.YETI_MOUNT2 || sourceid == Legend.YETI_MOUNT2) {\n-                ridingLevel = 1932004;\n+                ridingMountId = 1932004;\n             } else if (sourceid == Beginner.WITCH_BROOMSTICK || sourceid == Noblesse.WITCH_BROOMSTICK || sourceid == Legend.WITCH_BROOMSTICK) {\n-                ridingLevel = 1932005;\n+                ridingMountId = 1932005;\n             } else if (sourceid == Beginner.BALROG_MOUNT || sourceid == Noblesse.BALROG_MOUNT || sourceid == Legend.BALROG_MOUNT) {\n-                ridingLevel = 1932010;\n+                ridingMountId = 1932010;\n             } else {\n                 if (applyto.getMount() == null) {\n-                    applyto.mount(ridingLevel, sourceid);\n+                    applyto.mount(ridingMountId, sourceid);\n                 }\n                 \n                 applyto.getClient().getWorldServer().registerMountHunger(applyto);\n@@ -1077,7 +1077,7 @@ private void applyBuffEffect(MapleCharacter applyfrom, MapleCharacter applyto, b\n                 givemount = applyto.getMount();\n             }\n             localDuration = sourceid;\n-            localsourceid = ridingLevel;\n+            localsourceid = ridingMountId;\n             localstatups = Collections.singletonList(new Pair<>(MapleBuffStat.MONSTER_RIDING, 0));\n         } else if (isSkillMorph()) {\n             localstatups = Collections.singletonList(new Pair<>(MapleBuffStat.MORPH, getMorph(applyto)));"}, {"sha": "b170adce368ab54ef682d0ee979b0448b4c5d7b6", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/0b8d3a0b2b09938713c283eb626c92cdd424de63/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=0b8d3a0b2b09938713c283eb626c92cdd424de63", "patch": "@@ -257,6 +257,7 @@ public int getId() {\n     }\n \n     public MapleMap getReturnMap() {\n+        if(returnMapId == 999999999) return this;\n         return Server.getInstance().getWorld(world).getChannel(channel).getMapFactory().getMap(returnMapId);\n     }\n "}]}]},
