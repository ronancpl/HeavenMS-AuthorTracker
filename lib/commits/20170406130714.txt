{"fetchDate": "2019-12-19", "content": [{"sha": "67af338f8a0577f613e11ceeee163e70f58dfaa9", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NjdhZjMzOGY4YTA1NzdmNjEzZTExY2VlZWUxNjNlNzBmNThkZmFhOQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-04-06T13:07:14Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-04-06T13:07:14Z"}, "message": "Fix map spawn\n\nFix map failing to spawn in some cases.", "tree": {"sha": "bb4624ce1366ab0403cd19dd178941ed77623881", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/bb4624ce1366ab0403cd19dd178941ed77623881"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/67af338f8a0577f613e11ceeee163e70f58dfaa9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/67af338f8a0577f613e11ceeee163e70f58dfaa9", "html_url": "https://github.com/ronancpl/HeavenMS/commit/67af338f8a0577f613e11ceeee163e70f58dfaa9", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/67af338f8a0577f613e11ceeee163e70f58dfaa9/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7863994a13cb77f2065ebd2945305292234b266f", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7863994a13cb77f2065ebd2945305292234b266f", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7863994a13cb77f2065ebd2945305292234b266f"}], "stats": {"total": 205, "additions": 155, "deletions": 50}, "files": [{"sha": "950824373ad2ea50ec2955b795eb0114659cbcca", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -127,4 +127,8 @@ Sparta lv100 n\n Diversas altera\ufffd\ufffdes corretivas em itens das tabelas drop_data e reactordrops no BD.\n \n 04 Abril 2017,\n-Corre\ufffd\ufffdo na API sobre progresso das quests.\n\\ No newline at end of file\n+Corre\ufffd\ufffdo na API sobre progresso das quests.\n+\n+06 Abril 2017,\n+Tentativa de corre\ufffd\ufffdo em casos de falta de respawn em certas areas do jogo.\n+Otimiza\ufffd\ufffdo de fun\ufffd\ufffdes que lidam com popular ou despopular areas.\n\\ No newline at end of file"}, {"sha": "43285ef1ba37a7296eb63188c2ed1091406d2e11", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -3,17 +3,15 @@\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/server/CashShop.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/client/MapleQuestStatus.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/scripting/map/MapScriptMethods.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/scripting/AbstractPlayerInteraction.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/scripting/npc/NPCConversationManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/client/MapleClient.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/scripts/npc/world0/9201134.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/scripts/npc/world0/2030010.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/scripts/npc/world0/2091005.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/server/life/SpawnPoint.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/scripts/npc/world0/2012002.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/server/maps/MapleMapFactory.java</file>\n             <file>file:/C:/Nexon/MapleSolaxia/src/server/life/MapleMonster.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/client/MapleCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/client/MonsterBook.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/tools/MaplePacketCreator.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/src/scripting/event/EventInstanceManager.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/scripts/event/Boats.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/src/server/maps/MapleMap.java</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "scripts/map/onUserEnter/921100300.txt", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/map/onUserEnter/921100300.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/map/onUserEnter/921100300.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/921100300.txt?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "scripts/map/onUserEnter/923010000.txt", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/map/onUserEnter/923010000.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/map/onUserEnter/923010000.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/923010000.txt?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9"}, {"sha": "d8daf418522ff5eee62846ab44a9ba7bd7bd778a", "filename": "scripts/npc/world0/2012002.js", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2012002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2012002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2012002.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -41,9 +41,12 @@ if (mode == 0 && status == 1) {\n         status++;\n     else\n         cm.dispose();\n-    if (status == 1)\n+    \n+    if (status == 1) {\n         cm.sendNext (\"Alright, see you next time. Take care.\");\n-    else if (status == 2)\n+    }\n+    else if (status == 2) {\n         cm.warp(200000111, 0);// back to Orbis jetty\n-    cm.dispose();\n+        cm.dispose();\n+    }\n }"}, {"sha": "6c66f5a3d73e06380436a7de67b321853c2ec908", "filename": "scripts/npc/world0/2020008.js", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2020008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2020008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2020008.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -26,6 +26,18 @@ var sel;\n actionx = {\"Mental\" : false, \"Physical\" : false};\n \n function start() {\n+    if(cm.isQuestStarted(6192)) {\n+        if(cm.getWarpMap(921100300).getCharacters().size() > 0)\n+            cm.sendOk(\"There is someone currently in this map, come back later.\");\n+        else {\n+            cm.resetMapObjects(921100300);\n+            cm.warp(921100300);\n+        }\n+            \n+        cm.dispose();\n+        return;\n+    }\n+    \n     if (!(cm.getPlayer().getLevel() >= 70 && parseInt(cm.getJobId() / 100) == 1)){\n         cm.sendNext(\"Hi there.\");\n         cm.dispose();"}, {"sha": "56ad023df8ed337899d8b758427d4d7502c0a833", "filename": "scripts/npc/world0/2022004.js", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2022004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2022004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2022004.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -0,0 +1,12 @@\n+function start() {\n+    cm.sendNext(\"You did a great job back there, \" + cm.getPlayer().getName() + \", well done. Now I will transport you back to El Nath. Have the pendant in your possession and talk to me when you feel ready to receive the new skill.\");\n+}\n+\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        cm.warp(211000000,\"in01\");\n+        cm.dispose();\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "99d5393c4ccbf98fd90980a4783def99481230db", "filename": "scripts/npc/world0/2060005.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2060005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2060005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2060005.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -22,10 +22,13 @@\n function start() {\n     if(cm.isQuestCompleted(6002))\n         cm.sendOk(\"Thanks for saving the pork.\");\n-    else if(cm.getClient().getChannelServer().getMapFactory().getMap(923010000).getCharacters().size() > 0)\n+    else if(cm.getWarpMap(923010000).getCharacters().size() > 0)\n         cm.sendOk(\"There is currently someone in this map, come back later.\");\n-    else if(cm.isQuestStarted(6002))\n+    else if(cm.isQuestStarted(6002)) {\n+        cm.resetMapObjects(923010000);\n         cm.warp(923010000);\n+    }\n+        \n     else cm.sendSimple(\"Only few adventurers, from a selected public, are eligible to protect the Watch Hog.\");\n     cm.dispose();\n }\n\\ No newline at end of file"}, {"sha": "f306439748bf8c04811b0c66825445f1292155d5", "filename": "scripts/npc/world0/2091005.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2091005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/npc/world0/2091005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2091005.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -32,7 +32,7 @@ var belts = Array(1132000, 1132001, 1132002, 1132003, 1132004);\n var belt_level = Array(25, 35, 45, 60, 75);\n \n /* var belt_points = Array(200, 1800, 4000, 9200, 17000); */\n-var belt_points = Array(5, 45, 100, 230, 425); /* Watered down version */\n+var belt_points = Array(10, 90, 200, 460, 850); /* Watered down version */\n \n var status = -1;\n var selectedMenu = -1;"}, {"sha": "8a4e810e9190e57a64ab2f288a870372220b2a72", "filename": "scripts/portal/s4common1_exit.js", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/portal/s4common1_exit.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/portal/s4common1_exit.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/s4common1_exit.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -0,0 +1,9 @@\n+//Author: Ronan\n+\n+function enter(pi) {  \n+\tif(pi.hasItem(4031495)) pi.warp(921100301);\n+        else pi.warp(211040100);\n+        \n+        pi.getWarpMap(921100300).clearMapObjects();\n+\treturn true;\n+}\n\\ No newline at end of file"}, {"sha": "dcb138217c903aff1e73e5a6ed8e43e58d04406b", "filename": "scripts/portal/tamepig_out2.js", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/portal/tamepig_out2.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/scripts/portal/tamepig_out2.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/tamepig_out2.js?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -25,8 +25,10 @@ function enter(pi) {\n         pi.removeAll(4031508);\n     }\n     \n-    if (pi.getClient().getChannelServer().getMapFactory().getMap(923010000).getCharacters().size() < 1)\n-        pi.getClient().getChannelServer().getMapFactory().getMap(923010000).killAllMonsters();\n     pi.warp(230000003, \"out00\");\n+    if (pi.getClient().getChannelServer().getMapFactory().getMap(923010000).getCharacters().size() == 0) {\n+        pi.getClient().getChannelServer().getMapFactory().getMap(923010000).clearMapObjects();\n+    }\n+    \n     return true;\n }\n\\ No newline at end of file"}, {"sha": "db346cf8afe52e6072105febe8157ac4062aa0c4", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -124,7 +124,7 @@ public void warpParty(int id) {\n \t\treturn chars;\n \t}\n \n-\tprotected MapleMap getWarpMap(int map) {\n+\tpublic MapleMap getWarpMap(int map) {\n \t\tMapleMap target;\n \t\tif (getPlayer().getEventInstance() == null) {\n \t\t\ttarget = c.getChannelServer().getMapFactory().getMap(map);\n@@ -137,6 +137,10 @@ protected MapleMap getWarpMap(int map) {\n \tpublic MapleMap getMap(int map) {\n \t\treturn getWarpMap(map);\n \t}\n+        \n+        public void resetMapObjects(int mapid) {\n+                getWarpMap(mapid).resetMapObjects();\n+        }\n \n \tpublic EventManager getEventManager(String event) {\n \t\treturn getClient().getEventManager(event);"}, {"sha": "41290adcfad1b2758b3791b29edd390f84848147", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -439,14 +439,15 @@ public void run() {\n                 eventInstance.monsterKilled(this);\n             }\n         }\n-        // idk V just a troll\n+        \n+        MapleCharacter looter = map.getCharacterById(getHighestDamagerId());\n+        return looter != null ? looter : killer;\n+    }\n+    \n+    public void dispatchMonsterKilled() {\n         for (MonsterListener listener : listeners.toArray(new MonsterListener[listeners.size()])) {\n             listener.monsterKilled(getAnimationTime(\"die1\"));\n         }\n-\n-        MapleCharacter looter = map.getCharacterById(getHighestDamagerId());\n-\n-        return looter != null ? looter : killer;\n     }\n \n     // should only really be used to determine drop owner"}, {"sha": "84275bdad2a4416639e612de91f4629ec9955316", "filename": "src/server/life/SpawnPoint.java", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/life/SpawnPoint.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/life/SpawnPoint.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/SpawnPoint.java?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -26,7 +26,6 @@\n import java.util.concurrent.atomic.AtomicInteger;\n \n public class SpawnPoint {\n-\n     private int monster, mobTime, team, fh, f;\n     private Point pos;\n     private long nextPossibleSpawn;\n@@ -45,17 +44,25 @@ public SpawnPoint(final MapleMonster monster, Point pos, boolean immobile, int m\n         this.mobInterval = mobInterval;\n         this.nextPossibleSpawn = System.currentTimeMillis();\n     }\n+    \n+    public int getSpawned() {\n+        return spawnedMonsters.intValue();\n+    }\n+    \n+    public void denySpawn(boolean val) {\n+        spawnedMonsters.set((val == false) ? 0 : 1);\n+    }\n \n     public boolean shouldSpawn() {\n-    \tif (mobTime < 0 || ((mobTime != 0 || immobile) && spawnedMonsters.get() > 0) || spawnedMonsters.get() > 2) {//lol\n+    \tif (mobTime < 0 || spawnedMonsters.get() > 0) {\n             return false;\n         }\n        \n         return nextPossibleSpawn <= System.currentTimeMillis();\n     }\n \n     public boolean shouldForceSpawn() {\n-    \tif (mobTime < 0 || ((mobTime != 0 || immobile) && spawnedMonsters.get() > 0) || spawnedMonsters.get() > 2) {//lol\n+    \tif (mobTime < 0 || spawnedMonsters.get() > 0) {\n             return false;\n         }\n        \n@@ -98,4 +105,12 @@ public final int getF() {\n     public final int getFh() {\n         return fh;\n     }\n+    \n+    public int getMobTime() {\n+        return mobTime;\n+    }\n+    \n+    public int getTeam() {\n+        return team;\n+    }\n }"}, {"sha": "5a07d69f7fec2d66f609d3558e7e1083893d504d", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 52, "deletions": 13, "changes": 65, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -85,6 +85,7 @@\n     private static final List<MapleMapObjectType> rangedMapobjectTypes = Arrays.asList(MapleMapObjectType.SHOP, MapleMapObjectType.ITEM, MapleMapObjectType.NPC, MapleMapObjectType.MONSTER, MapleMapObjectType.DOOR, MapleMapObjectType.SUMMON, MapleMapObjectType.REACTOR);\n     private Map<Integer, MapleMapObject> mapobjects = new LinkedHashMap<>();\n     private Collection<SpawnPoint> monsterSpawn = Collections.synchronizedList(new LinkedList<SpawnPoint>());\n+    private Collection<SpawnPoint> allMonsterSpawn = Collections.synchronizedList(new LinkedList<SpawnPoint>());\n     private AtomicInteger spawnedMonstersOnMap = new AtomicInteger(0);\n     private Collection<MapleCharacter> characters = new LinkedHashSet<>();\n     private Map<Integer, MaplePortal> portals = new HashMap<>();\n@@ -672,6 +673,8 @@ public void run() {\n             }\n             dropFromMonster(dropOwner, monster);\n         }\n+        \n+        monster.dispatchMonsterKilled();\n     }\n \n     public void killFriendlies(MapleMonster mob) {\n@@ -713,20 +716,20 @@ public void killAllMonstersNotFriendly() {\n             if (monster.getStats().isFriendly()) {\n                 continue;\n             }\n-            spawnedMonstersOnMap.decrementAndGet();\n-            monster.setHp(0);\n-            broadcastMessage(MaplePacketCreator.killMonster(monster.getObjectId(), true), monster.getPosition());\n-            removeMapObject(monster);\n+            \n+            killMonster(monster, null, false, false, 1);\n         }\n     }\n \n     public void killAllMonsters() {\n+        for (SpawnPoint spawnPoint : monsterSpawn) {\n+            spawnPoint.denySpawn(true);\n+        }\n+        \n         for (MapleMapObject monstermo : getMapObjectsInRange(new Point(0, 0), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.MONSTER))) {\n             MapleMonster monster = (MapleMonster) monstermo;\n-            spawnedMonstersOnMap.decrementAndGet();\n-            monster.setHp(0);\n-            broadcastMessage(MaplePacketCreator.killMonster(monster.getObjectId(), true), monster.getPosition());\n-            removeMapObject(monster);\n+            \n+            killMonster(monster, null, false, false, 1);\n         }\n     }\n \n@@ -1032,6 +1035,7 @@ public void sendPackets(MapleClient c) {\n \n     public void spawnMonster(final MapleMonster monster) {\n         if (mobCapacity != -1 && mobCapacity == spawnedMonstersOnMap.get()) {\n+            System.out.println(\"got here\");\n             return;//PyPQ\n         }\n         monster.setMap(this);\n@@ -1050,11 +1054,13 @@ public void sendPackets(MapleClient c) {\n         }, null);\n         updateMonsterController(monster);\n \n-        if (monster.getDropPeriodTime() > 0) { //9300102 - Watchhog, 9300061 - Moon Bunny (HPQ)\n+        if (monster.getDropPeriodTime() > 0) { //9300102 - Watchhog, 9300061 - Moon Bunny (HPQ), 9300093 - Tylus\n             if (monster.getId() == 9300102) {\n                 monsterItemDrop(monster, new Item(4031507, (short) 0, (short) 1), monster.getDropPeriodTime());\n             } else if (monster.getId() == 9300061) {\n                 monsterItemDrop(monster, new Item(4001101, (short) 0, (short) 1), monster.getDropPeriodTime() / 3);\n+            } else if (monster.getId() == 9300093) {\n+                monsterItemDrop(monster, new Item(4031495, (short) 0, (short) 1), monster.getDropPeriodTime());\n             } else {\n                 FilePrinter.printError(FilePrinter.UNHANDLED_EVENT, \"UNCODED TIMED MOB DETECTED: \" + monster.getId());\n             }\n@@ -1782,7 +1788,13 @@ public void addMonsterSpawn(MapleMonster monster, int mobTime, int team) {\n         if (sp.shouldSpawn() || mobTime == -1) {// -1 does not respawn and should not either but force ONE spawn\n             spawnMonster(sp.getMonster());\n         }\n-\n+    }\n+    \n+    public void addAllMonsterSpawn(MapleMonster monster, int mobTime, int team) {\n+        Point newpos = calcPointBelow(monster.getPosition());\n+        newpos.y -= 1;\n+        SpawnPoint sp = new SpawnPoint(monster, newpos, !monster.isMobile(), mobTime, mobInterval, team);\n+        allMonsterSpawn.add(sp);\n     }\n \n     public Collection<MapleCharacter> getCharacters() {\n@@ -2029,6 +2041,13 @@ public void run() {\n             }\n         }\n     }\n+    \n+    public void instanceMapFirstSpawn() {\n+        for(SpawnPoint spawnPoint: allMonsterSpawn) {\n+            if(spawnPoint.getMobTime() == -1)   //just those allowed to be spawned only once\n+                spawnMonster(spawnPoint.getMonster());\n+        }\n+    }\n \n     public void instanceMapRespawn() {\n         final int numShouldSpawn = (short) ((monsterSpawn.size() - spawnedMonstersOnMap.get()));//Fking lol'd\n@@ -2045,6 +2064,12 @@ public void instanceMapRespawn() {\n             }\n         }\n     }\n+    \n+    public void restoreMapSpawnPoints() {\n+        for (SpawnPoint spawnPoint : monsterSpawn) {\n+            spawnPoint.denySpawn(false);\n+        }\n+    }\n \n     public void respawn() {\n         if (characters.isEmpty()) {\n@@ -2059,9 +2084,10 @@ public void respawn() {\n                 if (spawnPoint.shouldSpawn()) {\n                     spawnMonster(spawnPoint.getMonster());\n                     spawned++;\n-                }\n-                if (spawned >= numShouldSpawn) {\n-                    break;\n+                    \n+                    if (spawned >= numShouldSpawn) {\n+                        break;\n+                    }\n                 }\n             }\n         }\n@@ -2395,4 +2421,17 @@ public void setMobInterval(short interval) {\n     public short getMobInterval() {\n         return mobInterval;\n     }\n+    \n+    public void clearMapObjects() {\n+        clearDrops();\n+        killAllMonsters();\n+        resetReactors();\n+    }\n+    \n+    public void resetMapObjects() {\n+        clearMapObjects();\n+        \n+        restoreMapSpawnPoints();\n+        instanceMapFirstSpawn();\n+    }\n }"}, {"sha": "2a9ad2901c362f2e03a56a6116aa901ed95adca4", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -52,7 +52,7 @@ public MapleMapFactory(MapleDataProvider source, MapleDataProvider stringSource,\n         this.world = world;\n         this.channel = channel;\n     }\n-\n+    \n     public MapleMap getMap(int mapid) {\n         Integer omapid = Integer.valueOf(mapid);\n         MapleMap map = maps.get(omapid);\n@@ -148,6 +148,7 @@ public MapleMap getMap(int mapid) {\n                 } catch (Exception e) {\n                     e.printStackTrace();\n                 }\n+                \n                 for (MapleData life : mapData.getChildByPath(\"life\")) {\n                     String id = MapleDataTool.getString(life.getChildByPath(\"id\"));\n                     String type = MapleDataTool.getString(life.getChildByPath(\"type\"));\n@@ -164,10 +165,14 @@ public MapleMap getMap(int mapid) {\n                         } else {\n                             map.addMonsterSpawn(monster, mobTime, team);\n                         }\n+                        \n+                        //should the map be reseted, use allMonsterSpawn list of monsters to spawn them again\n+                        map.addAllMonsterSpawn(monster, mobTime, team);\n                     } else {\n                         map.addMapObject(myLife);\n                     }\n                 }\n+                \n                 if (mapData.getChildByPath(\"reactor\") != null) {\n                     for (MapleData reactor : mapData.getChildByPath(\"reactor\")) {\n                         String id = MapleDataTool.getString(reactor.getChildByPath(\"id\"));"}, {"sha": "5603973ae52d0a797757bb26f205a65335920cde", "filename": "wz/Map.wz/Map/Map9/921100300.img.xml", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/wz/Map.wz/Map/Map9/921100300.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/wz/Map.wz/Map/Map9/921100300.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map9/921100300.img.xml?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -4253,15 +4253,12 @@\n       <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"2\">\n-      <string name=\"pn\" value=\"out00\"/>\n-      <int name=\"pt\" value=\"2\"/>\n+      <string name=\"pn\" value=\"sp\"/>\n+      <int name=\"pt\" value=\"0\"/>\n       <int name=\"x\" value=\"-364\"/>\n       <int name=\"y\" value=\"-508\"/>\n-      <int name=\"tm\" value=\"211000000\"/>\n-      <string name=\"tn\" value=\"in01\"/>\n-      <string name=\"script\" value=\"\"/>\n-      <int name=\"hideTooltip\" value=\"0\"/>\n-      <int name=\"delay\" value=\"0\"/>\n+      <int name=\"tm\" value=\"999999999\"/>\n+      <string name=\"tn\" value=\"\"/>\n     </imgdir>\n     <imgdir name=\"3\">\n       <string name=\"pn\" value=\"out01\"/>\n@@ -4270,7 +4267,7 @@\n       <int name=\"y\" value=\"-207\"/>\n       <int name=\"tm\" value=\"999999999\"/>\n       <string name=\"tn\" value=\"\"/>\n-      <string name=\"script\" value=\"s4common1_clear\"/>\n+      <string name=\"script\" value=\"s4common1_exit\"/>\n       <int name=\"hideTooltip\" value=\"0\"/>\n       <int name=\"delay\" value=\"0\"/>\n     </imgdir>"}, {"sha": "a30e490e81cbd7d27b6e02b447b1bc2274560932", "filename": "wz/Mob.wz/9300093.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/67af338f8a0577f613e11ceeee163e70f58dfaa9/wz/Mob.wz/9300093.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/67af338f8a0577f613e11ceeee163e70f58dfaa9/wz/Mob.wz/9300093.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300093.img.xml?ref=67af338f8a0577f613e11ceeee163e70f58dfaa9", "patch": "@@ -17,6 +17,7 @@\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"1\"/>\n     <int name=\"damagedByMob\" value=\"1\"/>\n+    <int name=\"dropItemPeriod\" value=\"10\"/>\n   </imgdir>\n   <imgdir name=\"stand\">\n     <canvas name=\"0\" width=\"68\" height=\"81\">"}]}]},
