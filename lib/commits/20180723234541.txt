{"fetchDate": "2019-12-19", "content": [{"sha": "8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6OGFhZGY3YzM2OTM0MGY1Y2RjZmQxYTEzYmFjZmI0ZDU1N2EwODRjNg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-07-23T23:45:41Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-07-23T23:45:41Z"}, "message": "Dynamic World/Channel deployment + Channel scheduler update\n\nAdded \"8-slot SETUP expand\" item on the CashShop.\nSolved a concurrency issue on the fameGainByQuest method.\nRefactored many resource freeing modules throughout the source code.\nImplemented dynamic deployment of worlds and channels on the server system. Only creation of channels and worlds are available on this feature.\nAdded a dedicated worker for schedules requested on EventManager.\nFixed a potential cause for deadlocks on the channel schedulers' system.\nRefactored many schedules used by the EventManager and Channel, futher improving overall scheduling performance on the server.", "tree": {"sha": "1b251805b17e4827ca037fda20b5e071cca7e3e3", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/1b251805b17e4827ca037fda20b5e071cca7e3e3"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "html_url": "https://github.com/ronancpl/HeavenMS/commit/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/bee8b5259b683037cfcd159a9f297bbf90e6d2fd", "html_url": "https://github.com/ronancpl/HeavenMS/commit/bee8b5259b683037cfcd159a9f297bbf90e6d2fd"}], "stats": {"total": 1410, "additions": 1151, "deletions": 259}, "files": [{"sha": "4c48aa4152d63a398ff35bd2cd67370f630bbe2e", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -3,7 +3,7 @@\n \n ## Head developer: Ronan C. P. Lana\n \n-Credits are to be given too to Nexon(Duh!), the original MapleSolaxia staff and other colaborators, as just some changes/patches on the game were applied by myself, in which some of them diverged from the original v83 patch contents.\n+Besides myself for maintaining this repository, credits are to be given to Nexon(Duh!), the original MapleSolaxia staff and other colaborators, as just some changes/patches on the game were applied by myself, in which some of them diverged from the original v83 patch contents.\n \n Regarding distributability and usage of the code presented here: like it was before, this MapleStory server is open-source. By that, it is meant that anyone is **free to install, use, modify and redistribute the contents**, as long as there is **no kind of commercial trading involved** and the **credits to the original creators are maintained** within the codes.\n "}, {"sha": "c926beab922d5e71301d28b1d441090aebdaf398", "filename": "docs/feature_list.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/docs/feature_list.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/docs/feature_list.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/feature_list.md?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -132,6 +132,7 @@ Player potentials:\n Server potentials:\n \n * Multi-worlds.\n+* Dynamic World/Channel deployment.\n * Inventory auto-gather and auto-sorting feature.\n * Enhanced auto-pot system: pet uses as many potions as necessary to reach the desired threshold.\n * Enhanced buff system: smartly checks for the best available buff effects to be active on the player."}, {"sha": "0e94fe5bf8f8793fc1208d343a57a55f92ad50b3", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -1163,4 +1163,13 @@ Implementado um sistema adicional de checagem de slots dispon\u00edveis no invent\u00e1r\n Corrigido tooltip de player shops e hired merchants, agora com \u00edcone mostrando se h\u00e1 como visitar uma loja ou est\u00e1 ocupada.\n Corrigido player shop permits diferentes do comum n\u00e3o sendo consumidos ao usar.\n Corrigido player shop sempre aparecendo como o tipo b\u00e1sico (sem estandes), para qualquer permit itemid.\n-Corrigido cash pet food ignorando certos petids ao ler dados do WZ.\n\\ No newline at end of file\n+Corrigido cash pet food ignorando certos petids ao ler dados do WZ.\n+\n+21 - 23 Julho 2018,\n+Adicionado \"Add SETUP slot\" na lista de itens do cash shop.\n+Corrigido problema de acesso concorrente no m\u00e9todo fameGainByQuest.\n+Refatorado v\u00e1rios m\u00e9todos de liberamento de recursos do server, tais como em: Channel, MapleMap, MapleMapFactory e EventManager.\n+Implementado c\u00f3digo que ofere\u00e7e suporte para abrir novos worlds e channels sob demanda.\n+Adicionado scheduler dedicado para a\u00e7\u00f5es de event managers.\n+Corrigido potencial de deadlock em alguns pontos do sistema de schedulers de canais.\n+Refatorado v\u00e1rios temporizadores utilizados pelo EventManager e Channel, como o respawn de mobs e o disposeInstance.\n\\ No newline at end of file"}, {"sha": "029c588ed740545f43cd59e3bcb9c7fac0a00514", "filename": "scripts/event/4jberserk.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/4jberserk.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/4jberserk.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jberserk.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -164,8 +164,7 @@ function allMonstersDead(eim) {\n     eim.setProperty(\"canWarp\",\"true\");\n }\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}\n \n function timeOut() {\n     var iter = em.getInstances().iterator();"}, {"sha": "0388ba7b5f4312cd4ea313569f35a3df073afc5f", "filename": "scripts/event/4jrush.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/4jrush.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/4jrush.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jrush.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -130,8 +130,7 @@ function monsterKilled(mob, eim) {}\n \n function allMonstersDead(eim) {}\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}\n \n function timeOut() {\n     var iter = em.getInstances().iterator();"}, {"sha": "57074fbdfe0fb3ceb5ff0feaf83b316da2ea45e8", "filename": "scripts/event/AirPlane.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/AirPlane.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/AirPlane.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/AirPlane.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -51,5 +51,4 @@ function arrived() {\n     scheduleNew();\n }\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}"}, {"sha": "056492be395d8eace771e32a189f90c2d1c03a2a", "filename": "scripts/event/Boats.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Boats.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Boats.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Boats.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -107,5 +107,4 @@ function invasion() {\n     map2.spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(8150000), pos2);\n }\n \n-function cancelSchedule() {\n-}\n\\ No newline at end of file\n+function cancelSchedule() {}\n\\ No newline at end of file"}, {"sha": "68d8cd4416a1b39378eb95e7bbdd024787e1d860", "filename": "scripts/event/Cabin.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Cabin.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Cabin.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Cabin.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -108,5 +108,4 @@ function arrived() {\n     scheduleNew();\n }\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}"}, {"sha": "4407116cba4c31df92299e4d9a858a7adfd525cf", "filename": "scripts/event/Elevator.js", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Elevator.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Elevator.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Elevator.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -83,6 +83,4 @@ function isDownNow() {\n     goUp();\n }\n \n-function cancelSchedule() {\n-    \n-}\n\\ No newline at end of file\n+function cancelSchedule() {}\n\\ No newline at end of file"}, {"sha": "d4922c172a354154bf08ebafd38d44da73b9f1d5", "filename": "scripts/event/Genie.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Genie.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Genie.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Genie.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -85,5 +85,4 @@ function arrived() {\n     scheduleNew();\n }\n \n-function cancelSchedule() {\n-}\n\\ No newline at end of file\n+function cancelSchedule() {}\n\\ No newline at end of file"}, {"sha": "739fd5aabf68b3b88e9858a56be6cce7251e6964", "filename": "scripts/event/Subway.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Subway.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Subway.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Subway.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -57,5 +57,4 @@ function arrived() {\n     NLC_docked.broadcastMessage(MaplePacketCreator.playSound(\"subway/whistle\"));\n }\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}"}, {"sha": "c47996379681a4960143cef162c3886bb4795b23", "filename": "scripts/event/Trains.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Trains.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/event/Trains.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Trains.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -66,5 +66,4 @@ function arrived() {\n     scheduleNew();\n }\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}"}, {"sha": "66497492dce456b02a3f2ccc792230e924825dcc", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -147,6 +147,7 @@ function writeFeatureTab_Playerpotentials() {\n \n function writeFeatureTab_Serverpotentials() {\n         addFeature(\"Multi-worlds.\");\n+        addFeature(\"Dynamic World/Channel deployment.\");\n         addFeature(\"Inventory auto-gather and auto-sorting feature.\");\n         addFeature(\"Enhanced auto-pot system: smart pet potion handle.\");\n         addFeature(\"Enhanced buff system: best buffs effects takes place.\");"}, {"sha": "ccab6953cbb035cb8f357637f5eee26d91c45159", "filename": "scripts/npc/commands.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/npc/commands.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/scripts/npc/commands.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/commands.js?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -51,6 +51,10 @@ function writeHeavenMSCommandsLv6() {    //Admin\n         addCommand(\"dcall\", \"\");\n         addCommand(\"mapplayers\", \"\");\n         addCommand(\"getacc\", \"\");\n+        addCommand(\"addchannel\", \"\");\n+        addCommand(\"addworld\", \"\");\n+        //addCommand(\"removechannel\", \"\");\n+        //addCommand(\"removeworld\", \"\");\n         addCommand(\"shutdown\", \"\");\n         addCommand(\"shutdownnow\", \"\");\n         addCommand(\"clearquestcache\", \"\");"}, {"sha": "3d28f15d1029ee981ebb501d9a0194a161207dc1", "filename": "sql/db_drops.sql", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -2063,8 +2063,16 @@ USE `heavenms`;\n (9300221, 1061054, 1, 1, 0, 700), \n (2100103, 1072291, 1, 1, 0, 700), \n (9300221, 1072291, 1, 1, 0, 700), \n-(9400623, 2000002, 1, 4, 0, 40000), \n+(9400623, 2000002, 1, 1, 0, 40000),\n+(9400623, 2000003, 1, 1, 0, 40000),\n+(9400623, 2000004, 1, 1, 0, 10000),\n+(9400623, 4010000, 1, 1, 0, 7000),\n (9400623, 4010002, 1, 1, 0, 7000), \n+(9400623, 4010006, 1, 1, 0, 7000),\n+(9400623, 4020004, 1, 1, 0, 7000),\n+(9400623, 4020008, 1, 1, 0, 7000),\n+(9400623, 1082259, 1, 1, 0, 5000),\n+(9400623, 1072422, 1, 1, 0, 5000),\n (2230112, 4000020, 1, 1, 0, 200000), \n (2230112, 4003004, 1, 1, 0, 7000), \n (2230112, 4000021, 1, 1, 0, 200000),\n@@ -20030,6 +20038,7 @@ USE `heavenms`;\n (9400610, 2000003, 1, 1, 0, 40000),\n (9400610, 2000004, 1, 1, 0, 10000),\n (9400610, 4010000, 1, 1, 0, 7000),\n+(9400610, 4010002, 1, 1, 0, 7000), \n (9400610, 4010006, 1, 1, 0, 7000),\n (9400610, 4020004, 1, 1, 0, 7000),\n (9400610, 4020008, 1, 1, 0, 7000),\n@@ -22657,6 +22666,7 @@ USE `heavenms`;\n (9400611, 0, 204, 1010, 0, 400000),\n (9400612, 0, 204, 1010, 0, 400000),\n (9400613, 0, 204, 1010, 0, 400000),\n+(9400623, 0, 204, 1010, 0, 400000),\n (9400633, 0, 258, 1270, 0, 400000),\n (9400644, 0, 42, 61, 0, 400000),\n (9410014, 0, 493, 728, 0, 400000),"}, {"sha": "f87d2d82fb5f0ee59e32f8892a809b18112234cf", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -2198,12 +2198,15 @@ public void run() {\n \n     public void disableDoorSpawn() {\n         canDoor = false;\n-        TimerManager.getInstance().schedule(new Runnable() {\n+        \n+        Runnable r = new Runnable() {\n             @Override\n             public void run() {\n                 canDoor = true;\n             }\n-        }, 5000);\n+        };\n+        \n+        client.getChannelServer().registerOverallAction(mapid, r, 5000);\n     }\n \n     public void disbandGuild() {\n@@ -8195,13 +8198,17 @@ public void updateQuestInfo(int quest, String info) {\n     }\n \n     private void fameGainByQuest() {\n-        int delta = quest_fame / ServerConstants.FAME_GAIN_BY_QUEST;\n-        if(delta > 0) {\n-            gainFame(delta);\n-            client.announce(MaplePacketCreator.getShowFameGain(delta));\n+        synchronized (quests) {\n+            quest_fame += 1;\n+            \n+            int delta = quest_fame / ServerConstants.FAME_GAIN_BY_QUEST;\n+            if(delta > 0) {\n+                gainFame(delta);\n+                client.announce(MaplePacketCreator.getShowFameGain(delta));\n+            }\n+\n+            quest_fame %= ServerConstants.FAME_GAIN_BY_QUEST;\n         }\n-        \n-        quest_fame %= ServerConstants.FAME_GAIN_BY_QUEST;\n     }\n     \n     public void updateQuest(MapleQuestStatus quest) {\n@@ -8218,7 +8225,6 @@ public void updateQuest(MapleQuestStatus quest) {\n             MapleQuest mquest = quest.getQuest();\n             short questid = mquest.getId();\n             if(!mquest.isSameDayRepeatable() && !MapleQuest.isExploitableQuest(questid)) {\n-                quest_fame += 1;\n                 if(ServerConstants.FAME_GAIN_BY_QUEST > 0)\n                     fameGainByQuest();\n             }\n@@ -8388,8 +8394,7 @@ public void sendSpawnData(MapleClient client) {\n     }\n \n     @Override\n-    public void setObjectId(int id) {\n-    }\n+    public void setObjectId(int id) {}\n \n     @Override\n     public String toString() {"}, {"sha": "ce9e8453b3364dd316b45015b76e2489f2aa5095", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 78, "deletions": 2, "changes": 80, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -2784,7 +2784,7 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n                     \n \t\t\tServer server = Server.getInstance();\n \t\t\tbyte worldb = Byte.parseByte(sub[1]);\n-\t\t\tif (worldb <= (server.getWorlds().size() - 1)) {\n+\t\t\tif (worldb <= (server.getWorldsSize() - 1)) {\n \t\t\t\ttry {\n \t\t\t\t\tString[] socket = server.getIP(worldb, c.getChannel()).split(\":\");\n \t\t\t\t\tc.getWorldServer().removePlayer(player);\n@@ -2799,7 +2799,7 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n \t\t\t\t}\n \n \t\t\t} else {\n-\t\t\t\tplayer.message(\"Invalid world; highest number available: \" + (server.getWorlds().size() - 1));\n+\t\t\t\tplayer.message(\"Invalid world; highest number available: \" + (server.getWorldsSize() - 1));\n \t\t\t}\n \t\t\tbreak;\n                     \n@@ -2855,6 +2855,82 @@ public static boolean executeHeavenMsCommandLv6(Channel cserv, Server srv, Maple\n                         }\n \t\t\tbreak;\n \n+                    case \"addchannel\":\n+                        if (sub.length < 2) {\n+\t\t\t\tplayer.dropMessage(5, \"Syntax: @addchannel <worldid>\");\n+                                break;\n+\t\t\t}\n+                        \n+                        int worldid = Integer.parseInt(sub[1]);\n+                        \n+                        int chid = Server.getInstance().addChannel(worldid);\n+                        if(chid >= 0) {\n+                            player.dropMessage(5, \"NEW Channel \" + chid + \" successfully deployed on world \" + worldid + \".\");\n+                        } else {\n+                            if(chid == -3) {\n+                                player.dropMessage(5, \"Invalid worldid detected. Channel creation aborted.\");\n+                            } else if(chid == -2) {\n+                                player.dropMessage(5, \"Reached channel limit on worldid \" + worldid + \". Channel creation aborted.\");\n+                            } else if(chid == -1) {\n+                                player.dropMessage(5, \"Error detected when loading the 'world.ini' file. Channel creation aborted.\");\n+                            } else {\n+                                player.dropMessage(5, \"NEW Channel failed to be deployed. Check if the needed port is already in use or other limitations are taking place.\");\n+                            }\n+                        }\n+                        \n+                        break;\n+                        \n+                    case \"addworld\":\n+                        int wid = Server.getInstance().addWorld();\n+                        \n+                        if(wid >= 0) {\n+                            player.dropMessage(5, \"NEW World \" + wid + \" successfully deployed.\");\n+                        } else {\n+                            if(wid == -2) {\n+                                player.dropMessage(5, \"Error detected when loading the 'world.ini' file. World creation aborted.\");\n+                            } else {\n+                                player.dropMessage(5, \"NEW World failed to be deployed. Check if needed ports are already in use or maximum world count has been reached.\");\n+                            }\n+                        }\n+                        \n+                        break;\n+                    \n+                        /*\n+                    case \"removechannel\":\n+                        if (sub.length < 2) {\n+                            player.dropMessage(5, \"Syntax: @removechannel <worldid>\");\n+                            break;\n+\t\t\t}\n+                        \n+                        int worldId = Integer.parseInt(sub[1]);\n+                        if(Server.getInstance().removeChannel(worldId)) {\n+                            player.dropMessage(5, \"Successfully removed a channel on World \" + worldId + \". Current channel count: \" + Server.getInstance().getWorld(worldId).getChannelsSize() + \".\");\n+                        } else {\n+                            player.dropMessage(5, \"Failed to remove last Channel on world \" + worldId + \". Check if either that world exists or there are people currently playing there.\");\n+                        }\n+                        \n+                        break;\n+                        \n+                    case \"removeworld\":\n+                        int rwid = Server.getInstance().getWorldsSize() - 1;\n+                        if(rwid <= 0) {\n+                            player.dropMessage(5, \"Unable to remove world 0.\");\n+                            break;\n+                        }\n+                        \n+                        if(Server.getInstance().removeWorld()) {\n+                            player.dropMessage(5, \"Successfully removed a world. Current world count: \" + Server.getInstance().getWorldsSize() + \".\");\n+                        } else {\n+                            if(rwid < 0) {\n+                                player.dropMessage(5, \"No registered worlds to remove.\");\n+                            } else {\n+                                player.dropMessage(5, \"Failed to remove world \" + rwid + \". Check if there are people currently playing there.\");\n+                            }\n+                        }\n+                        \n+                        break;\n+                                */\n+                        \n                     case \"shutdown\":\n                     case \"shutdownnow\":\n \t\t\tint time = 60000;"}, {"sha": "cc2ab8494983e383571a9009ae077b5ea4bc0165", "filename": "src/client/inventory/MapleInventoryProof.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/inventory/MapleInventoryProof.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/client/inventory/MapleInventoryProof.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MapleInventoryProof.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -33,7 +33,7 @@ public MapleInventoryProof(MapleCharacter mc) {\n     \n     public void cloneContents(MapleInventory inv) {\n         inv.lockInventory();\n-\tlock.lock();\n+        lock.lock();\n         try {\n             inventory.clear();\n             this.setSlotLimit(inv.getSlotLimit());"}, {"sha": "1a952fe7d35357b76b4f3462d9cf48c21f9209cf", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -17,6 +17,8 @@\n     public static short VERSION = 83;\n \n     //Login Configuration\n+    public static final int WLDLIST_SIZE = 21;                  //Max possible worlds on the server.\n+    public static final int CHANNEL_SIZE = 20;                  //Max possible channels per world (which is 20, based on the channel list on login phase).\n     public static final int CHANNEL_LOAD = 100;                 //Max players per channel (limit actually used to calculate the World server capacity).\n     \n     public static final long RESPAWN_INTERVAL = 10 * 1000;\t//10 seconds, 10000.\n@@ -120,7 +122,7 @@\n     public static final int ITEM_EXPIRE_TIME  = 3 * 60 * 1000;  //Time before items start disappearing. Recommended to be set up to 3 minutes.\n     public static final int KITE_EXPIRE_TIME  = 60 * 60 * 1000; //Time before kites (cash item) disappears.\n     public static final int ITEM_MONITOR_TIME = 5 * 60 * 1000;  //Interval between item monitoring tasks on maps, which checks for dangling (null) item objects on the map item history.\n-    public static final int LOCK_MONITOR_TIME = 30 * 1000;      //Waiting time for a lock to be released. If it reaches timeout, a critical server deadlock has made present.\n+    public static final int LOCK_MONITOR_TIME = 3 * 60 * 1000;      //Waiting time for a lock to be released. If it reaches timeout, a critical server deadlock has made present.\n     public static final int ITEM_EXPIRE_CHECK = 10 * 1000;      //Interval between item expiring tasks on maps, which checks and makes disappear expired items.\n     public static final int ITEM_LIMIT_ON_MAP = 200;            //Max number of items allowed on a map.\n     public static final int MAP_VISITED_SIZE = 5;               //Max length for last mapids visited by a player. This is used to recover and update drops on these maps accordingly with player actions."}, {"sha": "088761dffd6c3d657e4cd897da7946a7df81744d", "filename": "src/net/server/Server.java", "status": "modified", "additions": 303, "deletions": 110, "changes": 413, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -31,8 +31,8 @@\n import java.sql.SQLException;\n import java.util.ArrayList;\n import java.util.Calendar;\n+import java.util.Collections;\n import java.util.HashSet;\n-import java.util.Iterator;\n import java.util.HashMap;\n import java.util.LinkedList;\n import java.util.List;\n@@ -104,17 +104,24 @@\n     private List<Pair<Integer, String>> worldRecommendedList = new LinkedList<>();\n     private final Map<Integer, MapleGuild> guilds = new HashMap<>(100);\n     private final Map<MapleClient, Long> inLoginState = new HashMap<>(100);\n-    private final Lock srvLock = new MonitoredReentrantLock(MonitoredLockType.SERVER);\n-    private final Lock disLock = new MonitoredReentrantLock(MonitoredLockType.SERVER_DISEASES);\n-    private final ReentrantReadWriteLock lgnLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.SERVER_LOGIN, true);\n-    private final ReadLock lgnRLock = lgnLock.readLock();\n-    private final WriteLock lgnWLock = lgnLock.writeLock();\n+    \n     private final PlayerBuffStorage buffStorage = new PlayerBuffStorage();\n     private final Map<Integer, MapleAlliance> alliances = new HashMap<>(100);\n     private final Map<Integer, NewYearCardRecord> newyears = new HashMap<>();\n     private final List<MapleClient> processDiseaseAnnouncePlayers = new LinkedList<>();\n     private final List<MapleClient> registeredDiseaseAnnouncePlayers = new LinkedList<>();\n     \n+    private final Lock srvLock = new MonitoredReentrantLock(MonitoredLockType.SERVER);\n+    private final Lock disLock = new MonitoredReentrantLock(MonitoredLockType.SERVER_DISEASES);\n+    \n+    private final ReentrantReadWriteLock wldLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.SERVER_WORLDS, true);\n+    private final ReadLock wldRLock = wldLock.readLock();\n+    private final WriteLock wldWLock = wldLock.writeLock();\n+    \n+    private final ReentrantReadWriteLock lgnLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.SERVER_LOGIN, true);\n+    private final ReadLock lgnRLock = lgnLock.readLock();\n+    private final WriteLock lgnWLock = lgnLock.writeLock();\n+    \n     private final AtomicLong currentTime = new AtomicLong(0);\n     private long serverCurrentTime = 0;\n     \n@@ -175,13 +182,17 @@ public boolean canEnterDeveloperRoom() {\n \n     private void loadPlayerNpcMapStepFromDb() {\n         try {\n+            List<World> wlist = this.getWorlds();\n+            \n             Connection con = DatabaseConnection.getConnection();\n             PreparedStatement ps = con.prepareStatement(\"SELECT * FROM playernpcs_field\");\n                         \n             ResultSet rs = ps.executeQuery();\n             while(rs.next()) {\n                 int world = rs.getInt(\"world\"), map = rs.getInt(\"map\"), step = rs.getInt(\"step\"), podium = rs.getInt(\"podium\");\n-                worlds.get(world).setPlayerNpcMapData(map, step, podium);\n+                \n+                World w = wlist.get(world);\n+                if(w != null) w.setPlayerNpcMapData(map, step, podium);\n             }\n             \n             rs.close();\n@@ -192,40 +203,264 @@ private void loadPlayerNpcMapStepFromDb() {\n         }\n     }\n     \n-    /*\n-    public void removeChannel(int worldid, int channel) {   //lol don't!\n-        channels.remove(channel);\n-\n-        World world = worlds.get(worldid);\n-        if (world != null) {\n-            world.removeChannel(channel);\n+    public World getWorld(int id) {\n+        wldRLock.lock();\n+        try {\n+            return worlds.get(id);\n+        } finally {\n+            wldRLock.unlock();\n         }\n     }\n-    */\n \n+    public List<World> getWorlds() {\n+        wldRLock.lock();\n+        try {\n+            return Collections.unmodifiableList(worlds);\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+    }\n+    \n+    public int getWorldsSize() {\n+        wldRLock.lock();\n+        try {\n+            return worlds.size();\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+    }\n+    \n     public Channel getChannel(int world, int channel) {\n-        return worlds.get(world).getChannel(channel);\n+        return this.getWorld(world).getChannel(channel);\n     }\n \n     public List<Channel> getChannelsFromWorld(int world) {\n-        return worlds.get(world).getChannels();\n+        return this.getWorld(world).getChannels();\n     }\n-\n+    \n     public List<Channel> getAllChannels() {\n         List<Channel> channelz = new ArrayList<>();\n-        for (World world : worlds) {\n+        for (World world : this.getWorlds()) {\n             for (Channel ch : world.getChannels()) {\n                 channelz.add(ch);\n             }\n         }\n         return channelz;\n     }\n-\n+    \n+    public Set<Integer> getOpenChannels(int world) {\n+        wldRLock.lock();\n+        try {\n+            return new HashSet<>(channels.get(world).keySet());\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+    }\n+    \n     public String getIP(int world, int channel) {\n-        return channels.get(world).get(channel);\n+        wldRLock.lock();\n+        try {\n+            return channels.get(world).get(channel);\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+    }\n+    \n+    private void dumpData() {\n+        wldWLock.lock();\n+        try {\n+            System.out.println(worlds);\n+            System.out.println(channels);\n+            System.out.println(worldRecommendedList);\n+            System.out.println();\n+            System.out.println(\"---------------------\");\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+    }\n+    \n+    public int addChannel(int worldid) {\n+        wldWLock.lock();\n+        try {\n+            if(worldid >= worlds.size()) return -3;\n+            \n+            Map<Integer, String> worldChannels = channels.get(worldid);\n+            if(worldChannels == null) return -3;\n+            \n+            int channelid = worldChannels.size();\n+            if(channelid >= ServerConstants.CHANNEL_SIZE) return -2;\n+            \n+            Properties p = loadWorldINI();\n+            if(p == null) {\n+                return -1;\n+            }\n+\n+            channelid++;\n+            World world = this.getWorld(worldid);\n+            Channel channel = new Channel(worldid, channelid, getCurrentTime());\n+            \n+            channel.setServerMessage(p.getProperty(\"whyamirecommended\" + worldid));\n+            \n+            world.addChannel(channel);\n+            worldChannels.put(channelid, channel.getIP());\n+            \n+            return channelid;\n+        } finally {\n+            wldWLock.unlock();\n+        }\n     }\n     \n-    private long getTimeLeftForNextHour() {\n+    public int addWorld() {\n+        Properties p = loadWorldINI();\n+        if(p == null) return -2;\n+        \n+        int newWorld = initWorld(p);\n+        if(newWorld > -1) {\n+            Set<Integer> accounts;\n+            \n+            lgnRLock.lock();\n+            try {\n+                accounts = new HashSet<>(accountChars.keySet());\n+            } finally {\n+                lgnRLock.unlock();\n+            }\n+            \n+            for(Integer accId : accounts) {\n+                loadAccountCharactersView(accId, 0, newWorld);\n+            }\n+        }\n+        \n+        return newWorld;\n+    }\n+    \n+    private int initWorld(Properties p) {\n+        wldWLock.lock();\n+        try {\n+            int i = worlds.size();\n+            \n+            if(i >= ServerConstants.WLDLIST_SIZE) {\n+                return -1;\n+            }\n+            \n+            System.out.println(\"Starting world \" + i);\n+            World world = new World(i,\n+                    Integer.parseInt(p.getProperty(\"flag\" + i)),\n+                    p.getProperty(\"eventmessage\" + i),\n+                    ServerConstants.EXP_RATE,\n+                    ServerConstants.DROP_RATE,\n+                    ServerConstants.MESO_RATE,\n+                    ServerConstants.QUEST_RATE);\n+\n+            worldRecommendedList.add(new Pair<>(i, p.getProperty(\"whyamirecommended\" + i)));\n+            worlds.add(world);\n+\n+            Map<Integer, String> channelInfo = new HashMap<>();\n+            long bootTime = System.currentTimeMillis();\n+            for (int j = 1; j <= Integer.parseInt(p.getProperty(\"channels\" + i)); j++) {\n+                int channelid = j;\n+                Channel channel = new Channel(i, channelid, bootTime);\n+\n+                world.addChannel(channel);\n+                channelInfo.put(channelid, channel.getIP());\n+            }\n+\n+            channels.add(i, channelInfo);\n+\n+            world.setServerMessage(p.getProperty(\"servermessage\" + i));\n+            System.out.println(\"Finished loading world \" + i + \"\\r\\n\");\n+            \n+            return i;\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+    }\n+    \n+    public boolean removeChannel(int worldid) {   //lol don't!\n+        wldWLock.lock();\n+        try {\n+            if(worldid >= worlds.size()) return false;\n+            \n+            World world = worlds.get(worldid);\n+            if (world != null) {\n+                int channel = world.removeChannel();\n+\n+                Map<Integer, String> m = channels.get(worldid);\n+                if(m != null) m.remove(channel);\n+                \n+                return channel > -1;\n+            }\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+        \n+        return false;\n+    }\n+    \n+    public boolean removeWorld() {   //lol don't!\n+        World w;\n+        int worldid;\n+        \n+        wldRLock.lock();\n+        try {\n+            worldid = worlds.size() - 1;\n+            if(worldid < 0) {\n+                return false;\n+            }\n+            \n+            w = worlds.get(worldid);\n+        } finally {\n+            wldRLock.unlock();\n+        }\n+        \n+        if(w == null || w.getPlayerStorage().getSize() > 0) {\n+            return false;\n+        }\n+        \n+        wldWLock.lock();\n+        try {\n+            if(worldid == worlds.size() - 1) {\n+                w.shutdown();\n+                \n+                worlds.remove(worldid);\n+                channels.remove(worldid);\n+                worldRecommendedList.remove(worldid);\n+            } else {\n+                return false;\n+            }\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+        \n+        return true;\n+    }\n+    \n+    private void resetServerWorlds() {\n+        wldWLock.lock();\n+        try {\n+            worlds.clear();\n+            worlds = null;\n+            channels.clear();\n+            channels = null;\n+            worldRecommendedList.clear();\n+            worldRecommendedList = null;\n+        } finally {\n+            wldWLock.unlock();\n+        }\n+    }\n+    \n+    public static Properties loadWorldINI() {\n+        Properties p = new Properties();\n+        try {\n+            p.load(new FileInputStream(\"world.ini\"));\n+            return p;\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            System.out.println(\"[SEVERE] Could not find/open 'world.ini'.\");\n+            return null;\n+        }\n+    }\n+    \n+    private static long getTimeLeftForNextHour() {\n         Calendar nextHour = Calendar.getInstance();\n         nextHour.add(Calendar.HOUR, 1);\n         nextHour.set(Calendar.MINUTE, 0);\n@@ -368,12 +603,8 @@ public void registerAnnouncePlayerDiseases(MapleClient c) {\n     }\n     \n     public void init() {\n-        Properties p = new Properties();\n-        try {\n-            p.load(new FileInputStream(\"world.ini\"));\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-            System.out.println(\"[SEVERE] Could not find/open 'world.ini'.\");\n+        Properties p = loadWorldINI();\n+        if(p == null) {\n             System.exit(0);\n         }\n \n@@ -437,27 +668,7 @@ public void init() {\n             Integer worldCount = Math.min(GameConstants.WORLD_NAMES.length, Integer.parseInt(p.getProperty(\"worlds\")));\n             \n             for (int i = 0; i < worldCount; i++) {\n-                System.out.println(\"Starting world \" + i);\n-                World world = new World(i,\n-                        Integer.parseInt(p.getProperty(\"flag\" + i)),\n-                        p.getProperty(\"eventmessage\" + i),\n-                        ServerConstants.EXP_RATE,\n-                        ServerConstants.DROP_RATE,\n-                        ServerConstants.MESO_RATE,\n-                        ServerConstants.QUEST_RATE);\n-\n-                worldRecommendedList.add(new Pair<>(i, p.getProperty(\"whyamirecommended\" + i)));\n-                worlds.add(world);\n-                channels.add(new HashMap<Integer, String>());\n-                long bootTime = System.currentTimeMillis();\n-                for (int j = 0; j < Integer.parseInt(p.getProperty(\"channels\" + i)); j++) {\n-                    int channelid = j + 1;\n-                    Channel channel = new Channel(i, channelid, bootTime);\n-                    world.addChannel(channel);\n-                    channels.get(i).put(channelid, channel.getIP());\n-                }\n-                world.setServerMessage(p.getProperty(\"servermessage\" + i));\n-                System.out.println(\"Finished loading world \" + i + \"\\r\\n\");\n+                initWorld(p);\n             }\n             \n             MaplePlayerNPCFactory.loadFactoryMetadata();\n@@ -594,22 +805,7 @@ public boolean increaseAllianceCapacity(int aId, int inc) {\n         }\n         return false;\n     }\n-\n-    public Set<Integer> getChannelServer(int world) {\n-        return new HashSet<>(channels.get(world).keySet());\n-    }\n-\n-    public byte getHighestChannelId() {\n-        byte highest = 0;\n-        for (Iterator<Integer> it = channels.get(0).keySet().iterator(); it.hasNext();) {\n-            Integer channel = it.next();\n-            if (channel != null && channel.intValue() > highest) {\n-                highest = channel.byteValue();\n-            }\n-        }\n-        return highest;\n-    }\n-\n+    \n     public int createGuild(int leaderId, String name) {\n         return MapleGuild.createGuild(leaderId, name);\n     }\n@@ -661,15 +857,7 @@ public MapleGuild getGuild(int id, int world, MapleCharacter mc) {\n             return g;\n         }\n     }\n-\n-    public void clearGuilds() {//remake\n-        synchronized (guilds) {\n-            guilds.clear();\n-        }\n-        //for (List<Channel> world : worlds.values()) {\n-        //reloadGuildCharacters();\n-    }\n-\n+    \n     public void setGuildMemberOnline(MapleCharacter mc, boolean bOnline, int channel) {\n         MapleGuild g = getGuild(mc.getGuildId(), mc.getWorld(), mc);\n         g.setOnline(mc.getId(), bOnline, channel);\n@@ -854,14 +1042,6 @@ public boolean canFly(Integer accountid) {\n         return activeFly.contains(accountid);\n     }\n     \n-    public World getWorld(int id) {\n-        return worlds.get(id);\n-    }\n-\n-    public List<World> getWorlds() {\n-        return worlds;\n-    }\n-    \n     public int getCharacterWorld(Integer chrid) {\n         lgnRLock.lock();\n         try {\n@@ -893,11 +1073,11 @@ public boolean haveCharacterEntry(Integer accountid, Integer chrid) {\n     \n     public void updateCharacterEntry(MapleCharacter chr) {\n         MapleCharacter chrView = chr.generateCharacterEntry();\n-        World wserv = worlds.get(chrView.getWorld());\n         \n         lgnWLock.lock();\n         try {\n-            wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n+            World wserv = this.getWorld(chrView.getWorld());\n+            if(wserv != null) wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n         } finally {\n             lgnWLock.unlock();\n         }\n@@ -914,8 +1094,9 @@ public void createCharacterEntry(MapleCharacter chr) {\n             worldChars.put(chrid, world);\n             \n             MapleCharacter chrView = chr.generateCharacterEntry();\n-            World wserv = worlds.get(chrView.getWorld());\n-            wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n+            \n+            World wserv = this.getWorld(chrView.getWorld());\n+            if(wserv != null) wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n         } finally {\n             lgnWLock.unlock();\n         }\n@@ -929,8 +1110,8 @@ public void deleteCharacterEntry(Integer accountid, Integer chrid) {\n             \n             Integer world = worldChars.remove(chrid);\n             if(world != null) {\n-                World wserv = worlds.get(world);\n-                wserv.unregisterAccountCharacterView(accountid, chrid);\n+                World wserv = this.getWorld(world);\n+                if(wserv != null) wserv.unregisterAccountCharacterView(accountid, chrid);\n             }\n         } finally {\n             lgnWLock.unlock();\n@@ -942,15 +1123,16 @@ public void transferWorldCharacterEntry(MapleCharacter chr, Integer toWorld) { /\n         try {\n             Integer chrid = chr.getId(), accountid = chr.getAccountID(), world = worldChars.get(chr.getId());\n             if(world != null) {\n-                World wserv = worlds.get(world);\n-                wserv.unregisterAccountCharacterView(accountid, chrid);\n+                World wserv = this.getWorld(world);\n+                if(wserv != null) wserv.unregisterAccountCharacterView(accountid, chrid);\n             }\n             \n             worldChars.put(chrid, toWorld);\n             \n             MapleCharacter chrView = chr.generateCharacterEntry();\n-            World wserv = worlds.get(toWorld);\n-            wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n+            \n+            World wserv = this.getWorld(toWorld);\n+            if(wserv != null) wserv.registerAccountCharacterView(chrView.getAccountID(), chrView);\n         } finally {\n             lgnWLock.unlock();\n         }\n@@ -968,7 +1150,7 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n     */\n     \n     public Pair<Pair<Integer, List<MapleCharacter>>, List<Pair<Integer, List<MapleCharacter>>>> loadAccountCharlist(Integer accountId) {\n-        List<World> wlist = worlds;\n+        List<World> wlist = this.getWorlds();\n         List<Pair<Integer, List<MapleCharacter>>> accChars = new ArrayList<>(wlist.size() + 1);\n         int chrTotal = 0;\n         List<MapleCharacter> lastwchars = null;\n@@ -995,14 +1177,14 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n         return new Pair<>(new Pair<>(chrTotal, lastwchars), accChars);\n     }\n     \n-    private static List<List<MapleCharacter>> loadAccountCharactersViewFromDb(MapleClient c, int wlen) {\n+    private static List<List<MapleCharacter>> loadAccountCharactersViewFromDb(int accId, int wlen) {\n         List<List<MapleCharacter>> wchars = new ArrayList<>(wlen);\n         for(int i = 0; i < wlen; i++) wchars.add(i, new LinkedList<MapleCharacter>());\n         \n         List<MapleCharacter> chars = new LinkedList<>();\n         int curWorld = 0;\n         try {\n-            List<Pair<Item, Integer>> accEquips = ItemFactory.loadEquippedItems(c.getAccID(), true, true);\n+            List<Pair<Item, Integer>> accEquips = ItemFactory.loadEquippedItems(accId, true, true);\n             Map<Integer, List<Item>> accPlayerEquips = new HashMap<>();\n             \n             for(Pair<Item, Integer> ae : accEquips) {\n@@ -1017,7 +1199,7 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n             \n             Connection con = DatabaseConnection.getConnection();\n             try (PreparedStatement ps = con.prepareStatement(\"SELECT * FROM characters WHERE accountid = ? ORDER BY world, id\")) {\n-                ps.setInt(1, c.getAccID());\n+                ps.setInt(1, accId);\n                 try (ResultSet rs = ps.executeQuery()) {\n                     while (rs.next()) {\n                         int cworld = rs.getByte(\"world\");\n@@ -1047,7 +1229,6 @@ public void deleteAccountEntry(Integer accountid) { is this even a thing?\n     \n     public void loadAccountCharacters(MapleClient c) {\n         Integer accId = c.getAccID();\n-        int gmLevel = 0;\n         boolean firstAccountLogin;\n         \n         lgnRLock.lock();\n@@ -1069,23 +1250,38 @@ public void loadAccountCharacters(MapleClient c) {\n                 lgnRLock.unlock();\n             }\n             \n+            int gmLevel = 0;\n             for(Integer aw : accWorlds) {\n-                for(MapleCharacter chr : worlds.get(aw).getAllCharactersView()) {\n-                    if(gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n+                World wserv = this.getWorld(aw);\n+                \n+                if (wserv != null) {\n+                    for(MapleCharacter chr : wserv.getAllCharactersView()) {\n+                        if(gmLevel < chr.gmLevel()) gmLevel = chr.gmLevel();\n+                    }\n                 }\n             }\n             \n             c.setGMLevel(gmLevel);\n             return;\n         }\n         \n-        List<List<MapleCharacter>> accChars = loadAccountCharactersViewFromDb(c, worlds.size());\n+        int gmLevel = loadAccountCharactersView(c.getAccID(), 0, 0);\n+        c.setGMLevel(gmLevel);\n+    }\n+    \n+    private int loadAccountCharactersView(Integer accId, int gmLevel, int fromWorldid) {    // returns the maximum gmLevel found\n+        List<World> wlist = this.getWorlds();\n+        List<List<MapleCharacter>> accChars = loadAccountCharactersViewFromDb(accId, wlist.size());\n         \n         lgnWLock.lock();\n         try {\n-            Set<Integer> chars = new HashSet<>(5);\n-            for(int wid = 0; wid < worlds.size(); wid++) {\n-                World w = worlds.get(wid);\n+            Set<Integer> chars = accountChars.get(accId);\n+            if(chars == null) {\n+                chars = new HashSet<>(5);\n+            }\n+            \n+            for(int wid = fromWorldid; wid < wlist.size(); wid++) {\n+                World w = wlist.get(wid);\n                 List<MapleCharacter> wchars = accChars.get(wid);\n                 w.loadAccountCharactersView(accId, wchars);\n                 \n@@ -1103,7 +1299,7 @@ public void loadAccountCharacters(MapleClient c) {\n             lgnWLock.unlock();\n         }\n         \n-        c.setGMLevel(gmLevel);\n+        return gmLevel;\n     }\n     \n     private static String getRemoteIp(InetSocketAddress isa) {\n@@ -1198,6 +1394,7 @@ public void run() {\n                     for (World w : getWorlds()) {\n                         w.shutdown();\n                     }\n+                    \n                     /*for (World w : getWorlds()) {\n                         while (w.getPlayerStorage().getAllCharacters().size() > 0) {\n                             try {\n@@ -1232,12 +1429,8 @@ public void run() {\n                             }\n                         }\n                     }\n-                    worlds.clear();\n-                    worlds = null;\n-                    channels.clear();\n-                    channels = null;\n-                    worldRecommendedList.clear();\n-                    worldRecommendedList = null;\n+                    \n+                    resetServerWorlds();\n \n                     System.out.println(\"Worlds + Channels are offline.\");\n                     acceptor.unbind();"}, {"sha": "5397fadfee704e503982123fe1bc63d11db177f4", "filename": "src/net/server/audit/locks/MonitoredLockType.java", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredLockType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredLockType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredLockType.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -41,10 +41,12 @@\n     BUFF_STORAGE,\n     PLAYER_STORAGE,\n     SERVER,\n-    SERVER_LOGIN,\n     SERVER_DISEASES,\n+    SERVER_LOGIN,\n+    SERVER_WORLDS,\n     MERCHANT,\n     CHANNEL,\n+    CHANNEL_EVENTS,\n     CHANNEL_FACEEXPRS,\n     CHANNEL_FACESCHDL,\n     CHANNEL_MOBACTION,\n@@ -60,6 +62,7 @@\n     WORLD_OWL,\n     WORLD_PETS,\n     WORLD_CHARS,\n+    WORLD_CHANNELS,\n     WORLD_MOUNTS,\n     WORLD_PSHOPS,\n     WORLD_MERCHS,\n@@ -69,6 +72,7 @@\n     EIM_SCRIPT,\n     EM_LOBBY,\n     EM_QUEUE,\n+    EM_SCHDL,\n     CASHSHOP,\n     VISITOR_PSHOP,\n     STORAGE,"}, {"sha": "dafe2286c5db2c3b5f52f39e334dc6ee853010ac", "filename": "src/net/server/audit/locks/MonitoredReadLock.java", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredReadLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredReadLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredReadLock.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -146,4 +146,16 @@ private static String printStackTrace(StackTraceElement[] list) {\n         \n         return s;\n     }\n+    \n+    public void dispose() {\n+        state.lock();\n+        try {\n+            if(timeoutSchedule != null) {\n+                timeoutSchedule.cancel(false);\n+                timeoutSchedule = null;\n+            }\n+        } finally {\n+            state.unlock();\n+        }\n+    }\n }"}, {"sha": "a0ae846af42204bf9bec08d555ef86010cfe11f5", "filename": "src/net/server/audit/locks/MonitoredReentrantLock.java", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredReentrantLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredReentrantLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredReentrantLock.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -150,4 +150,16 @@ private static String printStackTrace(StackTraceElement[] list) {\n         \n         return s;\n     }\n+    \n+    public void dispose() {\n+        state.lock();\n+        try {\n+            if(timeoutSchedule != null) {\n+                timeoutSchedule.cancel(false);\n+                timeoutSchedule = null;\n+            }\n+        } finally {\n+            state.unlock();\n+        }\n+    }\n }"}, {"sha": "e79db659bde7f08bb0793762bbf551192575fd15", "filename": "src/net/server/audit/locks/MonitoredWriteLock.java", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredWriteLock.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/audit/locks/MonitoredWriteLock.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/audit/locks/MonitoredWriteLock.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -145,4 +145,16 @@ private static String printStackTrace(StackTraceElement[] list) {\n         \n         return s;\n     }\n+    \n+    public void dispose() {\n+        state.lock();\n+        try {\n+            if(timeoutSchedule != null) {\n+                timeoutSchedule.cancel(false);\n+                timeoutSchedule = null;\n+            }\n+        } finally {\n+            state.unlock();\n+        }\n+    }\n }"}, {"sha": "a425bbf4f3318158b4c8543db4e7f88bca0c6ba9", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 85, "deletions": 10, "changes": 95, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -33,7 +33,6 @@\n import java.util.Map.Entry;\n import java.util.Set;\n import java.util.concurrent.ScheduledFuture;\n-import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n@@ -92,6 +91,7 @@\n     private MobClearSkillScheduler mobClearSkillSchedulers[] = new MobClearSkillScheduler[4];\n     private MobMistScheduler mobMistSchedulers[] = new MobMistScheduler[4];\n     private FaceExpressionScheduler faceExpressionSchedulers[] = new FaceExpressionScheduler[4];\n+    private EventScheduler eventSchedulers[] = new EventScheduler[4];\n     private OverallScheduler channelSchedulers[] = new OverallScheduler[4];\n     private Map<Integer, MapleHiredMerchant> hiredMerchants = new HashMap<>();\n     private final Map<Integer, Integer> storedVars = new HashMap<>();\n@@ -100,6 +100,9 @@\n     private MapleEvent event;\n     private boolean finishedShutdown = false;\n     private int usedDojo = 0;\n+    \n+    private ScheduledFuture<?> respawnTask;\n+    \n     private int[] dojoStage;\n     private long[] dojoFinishTime;\n     private ScheduledFuture<?>[] dojoTask;\n@@ -123,9 +126,9 @@\n     private ReadLock merchRlock = merchantLock.readLock();\n     private WriteLock merchWlock = merchantLock.writeLock();\n     \n-    private Lock faceLock[] = new MonitoredReentrantLock[4];\n+    private MonitoredReentrantLock faceLock[] = new MonitoredReentrantLock[4];\n     \n-    private Lock lock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL, true);\n+    private MonitoredReentrantLock lock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL, true);\n     \n     public Channel(final int world, final int channel, long startTime) {\n         this.world = world;\n@@ -141,7 +144,7 @@ public Channel(final int world, final int channel, long startTime) {\n             IoBuffer.setUseDirectBuffer(false);\n             IoBuffer.setAllocator(new SimpleBufferAllocator());\n             acceptor = new NioSocketAcceptor();\n-            TimerManager.getInstance().register(new respawnMaps(), ServerConstants.RESPAWN_INTERVAL);\n+            respawnTask = TimerManager.getInstance().register(new respawnMaps(), ServerConstants.RESPAWN_INTERVAL);\n             acceptor.setHandler(new MapleServerHandler(world, channel));\n             acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE, 30);\n             acceptor.getFilterChain().addLast(\"codec\", (IoFilter) new ProtocolCodecFilter(new MapleCodecFactory()));\n@@ -169,6 +172,7 @@ public Channel(final int world, final int channel, long startTime) {\n                 mobClearSkillSchedulers[i] = new MobClearSkillScheduler();\n                 mobMistSchedulers[i] = new MobMistScheduler();\n                 faceExpressionSchedulers[i] = new FaceExpressionScheduler(faceLock[i]);\n+                eventSchedulers[i] = new EventScheduler();\n                 channelSchedulers[i] = new OverallScheduler();\n             }\n             \n@@ -191,6 +195,20 @@ public final void shutdown() {\n             \n             closeAllMerchants();\n             players.disconnectAll();\n+            \n+            if(respawnTask != null) {\n+                respawnTask.cancel(false);\n+                respawnTask = null;\n+            }\n+            \n+            mapFactory.dispose();\n+            mapFactory = null;\n+            \n+            eventSM.cancel();\n+            eventSM = null;\n+            \n+            closeChannelSchedules();\n+            \n             acceptor.unbind();\n             \n             finishedShutdown = true;\n@@ -200,8 +218,58 @@ public final void shutdown() {\n             System.err.println(\"Error while shutting down Channel \" + channel + \" on World \" + world + \"\\r\\n\" + e);\n         }\n     }\n+    \n+    private void closeChannelSchedules() {\n+        for(int i = 0; i < 20; i++) {\n+            if(dojoTask[i] != null) {\n+                dojoTask[i].cancel(false);\n+                dojoTask[i] = null;\n+            }\n+        }\n \n-    public void closeAllMerchants() {\n+        for(int i = 0; i < 4; i++) {\n+            if(mobStatusSchedulers[i] != null) {\n+                mobStatusSchedulers[i].dispose();\n+                mobStatusSchedulers[i] = null;\n+            }\n+            \n+            if(mobAnimationSchedulers[i] != null) {\n+                mobAnimationSchedulers[i].dispose();\n+                mobAnimationSchedulers[i] = null;\n+            }\n+            \n+            if(mobClearSkillSchedulers[i] != null) {\n+                mobClearSkillSchedulers[i].dispose();\n+                mobClearSkillSchedulers[i] = null;\n+            }\n+            \n+            if(mobMistSchedulers[i] != null) {\n+                mobMistSchedulers[i].dispose();\n+                mobMistSchedulers[i] = null;\n+            }\n+            \n+            if(faceExpressionSchedulers[i] != null) {\n+                faceExpressionSchedulers[i].dispose();\n+                faceExpressionSchedulers[i] = null;\n+            }\n+            \n+            if(eventSchedulers[i] != null) {\n+                eventSchedulers[i].dispose();\n+                eventSchedulers[i] = null;\n+            }\n+            \n+            if(channelSchedulers[i] != null) {\n+                channelSchedulers[i].dispose();\n+                channelSchedulers[i] = null;\n+            }\n+            \n+            faceLock[i].dispose();\n+        }\n+        \n+        lock.dispose();\n+    }\n+    \n+    private void closeAllMerchants() {\n         merchWlock.lock();\n         try {\n             final Iterator<MapleHiredMerchant> hmit = hiredMerchants.values().iterator();\n@@ -442,7 +510,7 @@ private void freeDojoSlot(int slot, MapleParty party) {\n         }\n     }\n     \n-    private int getDojoSlot(int dojoMapId) {\n+    private static int getDojoSlot(int dojoMapId) {\n         return (dojoMapId % 100) + ((dojoMapId / 10000 == 92502) ? 5 : 0);\n     }\n     \n@@ -456,7 +524,7 @@ public void resetDojo(int dojoMapId) {\n         resetDojo(dojoMapId, 0);\n     }\n     \n-    public void resetDojo(int dojoMapId, int thisStg) {\n+    private void resetDojo(int dojoMapId, int thisStg) {\n         int slot = getDojoSlot(dojoMapId);\n         this.dojoStage[slot] = thisStg;\n         \n@@ -880,6 +948,10 @@ public void registerMobMistCancelAction(int mapid, Runnable runAction, long dela\n         mobMistSchedulers[getChannelSchedulerIndex(mapid)].registerMistCancelAction(runAction, delay);\n     }\n     \n+    public void registerEventAction(int mapid, Runnable runAction, long delay) {\n+        eventSchedulers[getChannelSchedulerIndex(mapid)].registerDelayedAction(runAction, delay);\n+    }\n+    \n     public void registerOverallAction(int mapid, Runnable runAction, long delay) {\n         channelSchedulers[getChannelSchedulerIndex(mapid)].registerDelayedAction(runAction, delay);\n     }\n@@ -902,13 +974,16 @@ public void run() {\n         \n         faceLock[lockid].lock();\n         try {\n-            if(chr.isLoggedinWorld()) {\n-                faceExpressionSchedulers[lockid].registerFaceExpression(chr.getId(), cancelAction);\n-                map.broadcastMessage(chr, MaplePacketCreator.facialExpression(chr, emote), false);\n+            if(!chr.isLoggedinWorld()) {\n+                return;\n             }\n+            \n+            faceExpressionSchedulers[lockid].registerFaceExpression(chr.getId(), cancelAction);\n         } finally {\n             faceLock[lockid].unlock();\n         }\n+        \n+        map.broadcastMessage(chr, MaplePacketCreator.facialExpression(chr, emote), false);\n     }\n     \n     public void unregisterFaceExpression(int mapid, MapleCharacter chr) {"}, {"sha": "5792efbb249afd5c2ee32e6dc77b8039256685af", "filename": "src/net/server/channel/handlers/GiveFameHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/handlers/GiveFameHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/handlers/GiveFameHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/GiveFameHandler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -32,6 +32,8 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class GiveFameHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter target = (MapleCharacter) c.getPlayer().getMap().getMapObject(slea.readInt());\n         int mode = slea.readByte();"}, {"sha": "e4cec03f585534d7ecfe927e98ea368dfe0bdb77", "filename": "src/net/server/channel/worker/BaseScheduler.java", "status": "modified", "additions": 40, "deletions": 10, "changes": 50, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/BaseScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/BaseScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/BaseScheduler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -28,10 +28,12 @@\n import java.util.Map.Entry;\n import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.Lock;\n-import server.TimerManager;\n-import tools.Pair;\n+\n+import net.server.Server;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n+import server.TimerManager;\n+import tools.Pair;\n \n /**\n  *\n@@ -40,11 +42,11 @@\n public abstract class BaseScheduler {\n     private int idleProcs = 0;\n     private List<SchedulerListener> listeners = new LinkedList<>();\n-    private final List<Lock> externalLocks;\n+    private final List<Lock> externalLocks = new LinkedList<>();\n     private Map<Object, Pair<Runnable, Long>> registeredEntries = new HashMap<>();\n     \n     private ScheduledFuture<?> schedulerTask = null;\n-    private Lock schedulerLock;\n+    private MonitoredReentrantLock schedulerLock;\n     private Runnable monitorTask = new Runnable() {\n                                         @Override\n                                         public void run() {\n@@ -54,13 +56,15 @@ public void run() {\n     \n     protected BaseScheduler(MonitoredLockType lockType) {\n         schedulerLock = new MonitoredReentrantLock(lockType, true);\n-        externalLocks = new LinkedList<>();\n     }\n     \n     // NOTE: practice EXTREME caution when adding external locks to the scheduler system, if you don't know what you're doing DON'T USE THIS.\n     protected BaseScheduler(MonitoredLockType lockType, List<Lock> extLocks) {\n         schedulerLock = new MonitoredReentrantLock(lockType, true);\n-        externalLocks = extLocks;\n+        \n+        for(Lock lock : extLocks) {\n+            externalLocks.add(lock);\n+        }\n     }\n     \n     protected void addListener(SchedulerListener listener) {\n@@ -112,13 +116,13 @@ private void runBaseSchedule() {\n             unlockScheduler();\n         }\n         \n-        long timeNow = System.currentTimeMillis();\n+        long timeNow = Server.getInstance().getCurrentTime();\n         toRemove = new LinkedList<>();\n         for(Entry<Object, Pair<Runnable, Long>> rmd : registeredEntriesCopy.entrySet()) {\n             Pair<Runnable, Long> r = rmd.getValue();\n \n             if(r.getRight() < timeNow) {\n-                r.getLeft().run();  // runs the cancel action\n+                r.getLeft().run();  // runs the scheduled action\n                 toRemove.add(rmd.getKey());\n             }\n         }\n@@ -145,21 +149,29 @@ protected void registerEntry(Object key, Runnable removalAction, long duration)\n                 schedulerTask = TimerManager.getInstance().register(monitorTask, ServerConstants.MOB_STATUS_MONITOR_PROC, ServerConstants.MOB_STATUS_MONITOR_PROC);\n             }\n             \n-            registeredEntries.put(key, new Pair<>(removalAction, System.currentTimeMillis() + duration));\n+            registeredEntries.put(key, new Pair<>(removalAction, Server.getInstance().getCurrentTime() + duration));\n         } finally {\n             unlockScheduler();\n         }\n     }\n     \n     protected void interruptEntry(Object key) {\n+        Runnable toRun = null;\n+        \n         lockScheduler();\n         try {\n             Pair<Runnable, Long> rm = registeredEntries.remove(key);\n-            if(rm != null) rm.getLeft().run();\n+            if(rm != null) {\n+                toRun = rm.getLeft();\n+            }\n         } finally {\n             unlockScheduler();\n         }\n         \n+        if(toRun != null) {\n+            toRun.run();\n+        }\n+        \n         dispatchRemovedEntries(Collections.singletonList(key), false);\n     }\n     \n@@ -168,4 +180,22 @@ private void dispatchRemovedEntries(List<Object> toRemove, boolean fromUpdate) {\n             listener.removedScheduledEntries(toRemove, fromUpdate);\n         }\n     }\n+    \n+    public void dispose() {\n+        lockScheduler();\n+        try {\n+            if(schedulerTask != null) {\n+                schedulerTask.cancel(false);\n+                schedulerTask = null;\n+            }\n+            \n+            listeners.clear();\n+            externalLocks.clear();\n+            registeredEntries.clear();\n+        } finally {\n+            unlockScheduler();\n+        }\n+        \n+        schedulerLock.dispose();\n+    }\n }"}, {"sha": "c5eba72bd75c374d2b7becf46474e2b20c4ab201", "filename": "src/net/server/channel/worker/EventScheduler.java", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/EventScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/EventScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/EventScheduler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -0,0 +1,36 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package net.server.channel.worker;\n+\n+import net.server.audit.locks.MonitoredLockType;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class EventScheduler extends BaseScheduler {\n+    public EventScheduler() {\n+        super(MonitoredLockType.CHANNEL_EVENTS);\n+    }\n+    \n+    public void registerDelayedAction(Runnable runAction, long delay) {\n+        registerEntry(runAction, runAction, delay);\n+    }\n+}"}, {"sha": "e615fcf9d950f03ec02ed53fd363c9c484f921bc", "filename": "src/net/server/channel/worker/MobAnimationScheduler.java", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/MobAnimationScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/MobAnimationScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobAnimationScheduler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -24,7 +24,6 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredReentrantLock;\n \n /**\n@@ -33,7 +32,7 @@\n  */\n public class MobAnimationScheduler extends BaseScheduler {\n     Set<Integer> onAnimationMobs = new HashSet<>(1000);\n-    private Lock animationLock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL_MOBANIMAT, true);\n+    private MonitoredReentrantLock animationLock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL_MOBANIMAT, true);\n     \n     private static Runnable r = new Runnable() {\n         @Override\n@@ -73,4 +72,10 @@ public boolean registerAnimationMode(Integer mobHash, long animationTime) {\n             animationLock.unlock();\n         }\n     }\n+    \n+    @Override\n+    public void dispose() {\n+        animationLock.dispose();\n+        super.dispose();\n+    }\n }"}, {"sha": "041079c87b1de70c2f0ffb395ef44de1bdbdef9e", "filename": "src/net/server/channel/worker/MobStatusScheduler.java", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/MobStatusScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/channel/worker/MobStatusScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/worker/MobStatusScheduler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -25,7 +25,6 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n \n@@ -35,7 +34,7 @@\n  */\n public class MobStatusScheduler extends BaseScheduler {\n     private Map<MonsterStatusEffect, MobStatusOvertimeEntry> registeredMobStatusOvertime = new HashMap<>();\n-    private Lock overtimeStatusLock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL_OVTSTATUS, true);\n+    private MonitoredReentrantLock overtimeStatusLock = new MonitoredReentrantLock(MonitoredLockType.CHANNEL_OVTSTATUS, true);\n     \n     private class MobStatusOvertimeEntry {\n         private int procCount;\n@@ -48,11 +47,11 @@ protected MobStatusOvertimeEntry(int delay, Runnable run) {\n             r = run;\n         }\n         \n-        protected void update() {\n+        protected void update(List<Runnable> toRun) {\n             procCount++;\n             if(procCount >= procLimit) {\n                 procCount = 0;\n-                r.run();\n+                toRun.add(r);\n             }\n         }\n     }\n@@ -63,6 +62,8 @@ public MobStatusScheduler() {\n         super.addListener(new SchedulerListener() {\n             @Override\n             public void removedScheduledEntries(List<Object> toRemove, boolean update) {\n+                List<Runnable> toRun = new ArrayList<>();\n+                \n                 overtimeStatusLock.lock();\n                 try {\n                     for(Object mseo : toRemove) {\n@@ -74,12 +75,16 @@ public void removedScheduledEntries(List<Object> toRemove, boolean update) {\n                         // it's probably ok to use one thread for both management & overtime actions\n                         List<MobStatusOvertimeEntry> mdoeList = new ArrayList<>(registeredMobStatusOvertime.values());\n                         for(MobStatusOvertimeEntry mdoe : mdoeList) {\n-                            mdoe.update();\n+                            mdoe.update(toRun);\n                         }\n                     }\n                 } finally {\n                     overtimeStatusLock.unlock();\n                 }\n+                \n+                for(Runnable r : toRun) {\n+                    r.run();\n+                }\n             }\n         });\n     }\n@@ -102,4 +107,10 @@ public void registerMobStatus(MonsterStatusEffect mse, Runnable cancelStatus, lo\n     public void interruptMobStatus(MonsterStatusEffect mse) {\n         interruptEntry(mse);\n     }\n+    \n+    @Override\n+    public void dispose() {\n+        overtimeStatusLock.dispose();\n+        super.dispose();\n+    }\n }"}, {"sha": "90709b8df9085f92cd8f2e3416304fd64a2c4d1b", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -116,7 +116,7 @@ public void buildNotifications() {\n         if (!bDirty) {\n             return;\n         }\n-        Set<Integer> chs = Server.getInstance().getChannelServer(world);\n+        Set<Integer> chs = Server.getInstance().getOpenChannels(world);\n         if (notifications.keySet().size() != chs.size()) {\n             notifications.clear();\n             for (Integer ch : chs) {\n@@ -284,7 +284,7 @@ public void broadcast(final byte[] packet, int exceptionId, BCOp bcop) {\n                 buildNotifications();\n             }\n             try {\n-                for (Integer b : Server.getInstance().getChannelServer(world)) {\n+                for (Integer b : Server.getInstance().getOpenChannels(world)) {\n                     if (notifications.get(b).size() > 0) {\n                         if (bcop == BCOp.DISBAND) {\n                             Server.getInstance().getWorld(world).setGuildAndRank(notifications.get(b), 0, 5, exceptionId);"}, {"sha": "c959937693820727313531227755fe22a3d4c4ed", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -31,7 +31,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n-        int channel = Randomizer.rand(1, server.getWorld(c.getWorld()).getChannels().size());\n+        int channel = Randomizer.rand(1, server.getWorld(c.getWorld()).getChannelsSize());\n         c.setChannel(channel);\n         \n         String mac = slea.readMapleAsciiString();"}, {"sha": "59d8d31ee2e97f16767038d0f8a8fd92ce2f457f", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -58,7 +58,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         try {\n-            int channel = Randomizer.rand(1, c.getWorldServer().getChannels().size());\n+            int channel = Randomizer.rand(1, c.getWorldServer().getChannelsSize());\n             c.setChannel(channel);\n         } catch (Exception e) {\n             e.printStackTrace();"}, {"sha": "a5f13bad6b8531dec47d45ec0e99223ef8e94492", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -27,7 +27,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         c.setWorld(server.getCharacterWorld(charId));\n-        int channel = Randomizer.rand(1, c.getWorldServer().getChannels().size());\n+        int channel = Randomizer.rand(1, c.getWorldServer().getChannelsSize());\n         c.setChannel(channel);\n         \n         String macs = slea.readMapleAsciiString();"}, {"sha": "0ac0e4f89536627d85234db04115363082be8464", "filename": "src/net/server/worker/RankingWorker.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/worker/RankingWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/worker/RankingWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/RankingWorker.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -90,7 +90,7 @@ public void run() {\n                 resetMoveRank(false);\n             }\n             \n-            for(int j = 0; j < Server.getInstance().getWorlds().size(); j++) {\n+            for(int j = 0; j < Server.getInstance().getWorldsSize(); j++) {\n                 updateRanking(-1, j);    //overall ranking\n                 for (int i = 0; i <= MapleJob.getMax(); i++) {\n                     updateRanking(i, j);"}, {"sha": "f5dd1467dcb584b54cccdf536ed046f7dd17be1d", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -31,7 +31,6 @@\n import java.util.Map;\n import java.util.Comparator;\n import net.server.audit.locks.MonitoredReentrantLock;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredLockType;\n \n public class MapleParty {\n@@ -44,7 +43,7 @@\n     private Map<Integer, Integer> histMembers = new HashMap<>();\n     private int nextEntry = 0;\n     \n-    private Lock lock = new MonitoredReentrantLock(MonitoredLockType.PARTY, true);\n+    private MonitoredReentrantLock lock = new MonitoredReentrantLock(MonitoredLockType.PARTY, true);\n     \n     public MapleParty(int id, MaplePartyCharacter chrfor) {\n         this.leaderId = chrfor.getId();\n@@ -215,6 +214,10 @@ public void assignNewLeader(MapleClient c) {\n         if(newLeadr != null) world.updateParty(this.getId(), PartyOperation.CHANGE_LEADER, newLeadr);\n     }\n     \n+    public void disposeLocks() {\n+        lock.dispose();\n+    }\n+    \n     @Override\n     public int hashCode() {\n         final int prime = 31;"}, {"sha": "4fba8756ed3ff9af44d2bbde02d922e248b709a5", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 114, "deletions": 20, "changes": 134, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -47,11 +47,11 @@\n import java.util.SortedMap;\n import java.util.TreeMap;\n import java.util.concurrent.atomic.AtomicInteger;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredReentrantLock;\n import java.util.Set;\n import java.util.HashSet;\n import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.locks.ReentrantReadWriteLock;\n \n import scripting.event.EventInstanceManager;\n import server.TimerManager;\n@@ -76,6 +76,7 @@\n import tools.MaplePacketCreator;\n import tools.Pair;\n import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n \n /**\n  *\n@@ -97,8 +98,12 @@\n     private Map<Integer, MapleGuildSummary> gsStore = new HashMap<>();\n     private PlayerStorage players = new PlayerStorage();\n     \n+    private final ReentrantReadWriteLock chnLock = new MonitoredReentrantReadWriteLock(MonitoredLockType.WORLD_CHANNELS, true);\n+    private final ReentrantReadWriteLock.ReadLock chnRLock = chnLock.readLock();\n+    private final ReentrantReadWriteLock.WriteLock chnWLock = chnLock.writeLock();\n+    \n     private Map<Integer, SortedMap<Integer, MapleCharacter>> accountChars = new HashMap<>();\n-    private Lock accountCharsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_CHARS, true);\n+    private MonitoredReentrantLock accountCharsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_CHARS, true);\n     \n     private Set<Integer> queuedGuilds = new HashSet<>();\n     private Map<Integer, Pair<Pair<Boolean, Boolean>, Pair<Integer, Integer>>> queuedMarriages = new HashMap<>();\n@@ -107,31 +112,31 @@\n     private Map<Integer, Integer> partyChars = new HashMap<>();\n     private Map<Integer, MapleParty> parties = new HashMap<>();\n     private AtomicInteger runningPartyId = new AtomicInteger();\n-    private Lock partyLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PARTY, true);\n+    private MonitoredReentrantLock partyLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PARTY, true);\n     \n     private Map<Integer, Integer> owlSearched = new LinkedHashMap<>();\n-    private Lock owlLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_OWL);\n+    private MonitoredReentrantLock owlLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_OWL);\n     \n-    private Lock activePetsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PETS, true);\n+    private MonitoredReentrantLock activePetsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PETS, true);\n     private Map<Integer, Byte> activePets = new LinkedHashMap<>();\n     private ScheduledFuture<?> petsSchedule;\n     private long petUpdate;\n     \n-    private Lock activeMountsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MOUNTS, true);\n+    private MonitoredReentrantLock activeMountsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MOUNTS, true);\n     private Map<Integer, Byte> activeMounts = new LinkedHashMap<>();\n     private ScheduledFuture<?> mountsSchedule;\n     private long mountUpdate;\n     \n-    private Lock activePlayerShopsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PSHOPS, true);\n+    private MonitoredReentrantLock activePlayerShopsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_PSHOPS, true);\n     private Map<Integer, MaplePlayerShop> activePlayerShops = new LinkedHashMap<>();\n     \n-    private Lock activeMerchantsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MERCHS, true);\n+    private MonitoredReentrantLock activeMerchantsLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MERCHS, true);\n     private Map<Integer, Pair<MapleHiredMerchant, Byte>> activeMerchants = new LinkedHashMap<>();\n     private long merchantUpdate;\n     \n     private Map<Runnable, Long> registeredTimedMapObjects = new LinkedHashMap<>();\n     private ScheduledFuture<?> timedMapObjectsSchedule;\n-    private Lock timedMapObjectLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MAPOBJS, true);\n+    private MonitoredReentrantLock timedMapObjectLock = new MonitoredReentrantLock(MonitoredLockType.WORLD_MAPOBJS, true);\n     \n     private ScheduledFuture<?> charactersSchedule;\n     private ScheduledFuture<?> marriagesSchedule;\n@@ -159,20 +164,75 @@ public World(int world, int flag, String eventmsg, int exprate, int droprate, in\n         \n     }\n \n+    public int getChannelsSize() {\n+        chnRLock.lock();\n+        try {\n+            return channels.size();\n+        } finally {\n+            chnRLock.unlock();\n+        }\n+    }\n+    \n     public List<Channel> getChannels() {\n-        return channels;\n+        chnRLock.lock();\n+        try {\n+            return new ArrayList<>(channels);\n+        } finally {\n+            chnRLock.unlock();\n+        }\n     }\n \n     public Channel getChannel(int channel) {\n-        return channels.get(channel - 1);\n+        chnRLock.lock();\n+        try {\n+            return channels.get(channel - 1);\n+        } finally {\n+            chnRLock.unlock();\n+        }\n     }\n \n     public void addChannel(Channel channel) {\n-        channels.add(channel);\n+        chnWLock.lock();\n+        try {\n+            channels.add(channel);\n+        } finally {\n+            chnWLock.unlock();\n+        }\n     }\n \n-    public void removeChannel(int channel) {\n-        channels.remove(channel);\n+    public int removeChannel() {\n+        Channel ch;\n+        int chIdx;\n+        \n+        chnRLock.lock();\n+        try {\n+            chIdx = channels.size() - 1;\n+            if(chIdx < 0) {\n+                return -1;\n+            }\n+            \n+            ch = channels.get(chIdx);\n+        } finally {\n+            chnRLock.unlock();\n+        }\n+        \n+        if(ch == null || ch.getPlayerStorage().getSize() > 0) {\n+            return -1;\n+        }\n+        \n+        chnWLock.lock();\n+        try {\n+            if(chIdx == channels.size() - 1) {\n+                channels.remove(chIdx);\n+            } else {\n+                return -1;\n+            }\n+        } finally {\n+            chnWLock.unlock();\n+        }\n+        \n+        ch.shutdown();\n+        return ch.getId();\n     }\n \n     public void setFlag(byte b) {\n@@ -342,11 +402,11 @@ public PlayerStorage getPlayerStorage() {\n     }\n \n     public void removePlayer(MapleCharacter chr) {\n-        if(!channels.get(chr.getClient().getChannel() - 1).removePlayer(chr)) {\n+        if(!getChannel(chr.getClient().getChannel()).removePlayer(chr)) {\n             if(!chr.getClient().getChannelServer().removePlayer(chr)) {\n                 // oy the player is not where it should be, find this mf\n                 \n-                for(Channel ch : channels) {\n+                for(Channel ch : getChannels()) {\n                     if(ch.removePlayer(chr)) {\n                         break;\n                     }\n@@ -394,7 +454,7 @@ public boolean isWorldCapacityFull() {\n     }\n     \n     public int getWorldCapacityStatus() {\n-        int worldCap = channels.size() * ServerConstants.CHANNEL_LOAD;\n+        int worldCap = getChannelsSize() * ServerConstants.CHANNEL_LOAD;\n         int num = players.getSize();\n         \n         int status;\n@@ -555,7 +615,7 @@ public synchronized boolean addMarriageGuest(int marriageId, int playerId) {\n     }\n     \n     public Pair<Integer, Integer> getWeddingCoupleForGuest(int guestId, Boolean cathedral) {\n-        for(Channel ch : channels) {\n+        for(Channel ch : getChannels()) {\n             Pair<Integer, Integer> p = ch.getWeddingCoupleForGuest(guestId, cathedral);\n             if(p != null) {\n                 return p;\n@@ -580,7 +640,7 @@ public synchronized boolean addMarriageGuest(int marriageId, int playerId) {\n             int selectedPos = Integer.MAX_VALUE;\n             \n             for(Integer pw : possibleWeddings) {\n-                for(Channel ch : channels) {\n+                for(Channel ch : getChannels()) {\n                     int pos = ch.getWeddingReservationStatus(pw, cathedral);\n                     if(pos != -1) {\n                         if(pos < selectedPos) {\n@@ -1420,7 +1480,7 @@ public void resetPlayerNpcMapData() {\n     }\n     \n     public void setServerMessage(String msg) {\n-        for (Channel ch : channels) {\n+        for (Channel ch : getChannels()) {\n             ch.setServerMessage(msg);\n         }\n     }\n@@ -1588,6 +1648,29 @@ public void dropMessage(int type, String message) {\n         }\n     }\n     \n+    private void disposeLocks() {\n+        List<MapleParty> pList;\n+        partyLock.lock();\n+        try {\n+            pList = new ArrayList<>(parties.values());\n+        } finally {\n+            partyLock.unlock();\n+        }\n+        \n+        for(MapleParty p : pList) {\n+            p.disposeLocks();\n+        }\n+        \n+        accountCharsLock.dispose();\n+        partyLock.dispose();\n+        owlLock.dispose();\n+        activePetsLock.dispose();\n+        activeMountsLock.dispose();\n+        activePlayerShopsLock.dispose();\n+        activeMerchantsLock.dispose();\n+        timedMapObjectLock.dispose();\n+    }\n+    \n     public final void shutdown() {\n         for (Channel ch : getChannels()) {\n             ch.shutdown();\n@@ -1608,6 +1691,17 @@ public final void shutdown() {\n             timedMapObjectsSchedule = null;\n         }\n         \n+        if(charactersSchedule != null) {\n+            charactersSchedule.cancel(false);\n+            charactersSchedule = null;\n+        }\n+        \n+        if(marriagesSchedule != null) {\n+            marriagesSchedule.cancel(false);\n+            marriagesSchedule = null;\n+        }\n+        \n         players.disconnectAll();\n+        disposeLocks();\n     }\n }"}, {"sha": "422ffe5164dc350db6d23499cb7a3ccb4c37bf67", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 22, "deletions": 13, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -34,7 +34,6 @@\n import java.util.Set;\n import java.util.Iterator;\n import java.util.Properties;\n-import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n@@ -93,8 +92,8 @@\n         private final ReadLock rL = lock.readLock();\n         private final WriteLock wL = lock.writeLock();\n         \n-        private final Lock pL = new MonitoredReentrantLock(MonitoredLockType.EIM_PARTY, true);\n-        private final Lock sL = new MonitoredReentrantLock(MonitoredLockType.EIM_SCRIPT, true);\n+        private final MonitoredReentrantLock pL = new MonitoredReentrantLock(MonitoredLockType.EIM_PARTY, true);\n+        private final MonitoredReentrantLock sL = new MonitoredReentrantLock(MonitoredLockType.EIM_SCRIPT, true);\n         \n         private ScheduledFuture<?> event_schedule = null;\n         private boolean disposed = false;\n@@ -638,13 +637,6 @@ public int getKillCount(MapleCharacter chr) {\n \t\treturn (kc == null) ? 0 : kc;\n \t}\n         \n-        public void cancelSchedule() {\n-            if(event_schedule != null) {\n-                    event_schedule.cancel(false);\n-                    event_schedule = null;\n-            }\n-        }\n-\n \tpublic synchronized void dispose() {\n                 if(disposed) return;\n                 \n@@ -673,9 +665,14 @@ public synchronized void dispose() {\n                         wL.unlock();\n                 }\n                 \n-                cancelSchedule();\n+                if(event_schedule != null) {\n+                        event_schedule.cancel(false);\n+                        event_schedule = null;\n+                }\n+                \n                 killCount.clear();\n                 mapIds.clear();\n+                props.clear();\n                 \n                 disposeExpedition();\n                 \n@@ -686,14 +683,24 @@ public synchronized void dispose() {\n                 } finally {\n                         sL.unlock();\n                 }\n+                \n+                disposeLocks();\n \t}\n+        \n+        private void disposeLocks() {\n+                pL.dispose();\n+                sL.dispose();\n+        }\n \n \tpublic MapleMapFactory getMapFactory() {\n \t\treturn mapFactory;\n \t}\n \n \tpublic void schedule(final String methodName, long delay) {\n-\t\tTimerManager.getInstance().schedule(new Runnable() {\n+                List<MapleCharacter> chrList = this.getPlayerList();\n+                int mapid = !chrList.isEmpty() ? chrList.get(0).getMapId() : 0;\n+                \n+                Runnable r = new Runnable() {\n \t\t\t@Override\n \t\t\tpublic void run() {\n \t\t\t\ttry {\n@@ -708,7 +715,9 @@ public void run() {\n \t\t\t\t\tex.printStackTrace();\n \t\t\t\t}\n \t\t\t}\n-\t\t}, delay);\n+\t\t};\n+                \n+                getEm().getChannelServer().registerEventAction(mapid, r, delay);\n \t}\n \n \tpublic String getName() {"}, {"sha": "7e7ac7157eeaa6d270114e3d4c264af311c4f68e", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 56, "deletions": 14, "changes": 70, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -26,7 +26,6 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Properties;\n-import java.util.concurrent.ScheduledFuture;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n \n@@ -42,7 +41,7 @@\n import net.server.guild.MapleGuild;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n-import server.TimerManager;\n+import scripting.event.worker.EventScriptScheduler;\n import server.expeditions.MapleExpedition;\n import server.maps.MapleMap;\n import server.life.MapleMonster;\n@@ -53,7 +52,6 @@\n import java.util.ArrayList;\n import java.util.LinkedList;\n import java.util.Queue;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantLock;\n \n@@ -67,6 +65,7 @@\n     private Channel cserv;\n     private World wserv;\n     private Server server;\n+    private EventScriptScheduler ess = new EventScriptScheduler();\n     private Map<String, EventInstanceManager> instances = new HashMap<String, EventInstanceManager>();\n     private Map<String, Integer> instanceLocks = new HashMap<String, Integer>();\n     private final Queue<Integer> queuedGuilds = new LinkedList<>();\n@@ -76,8 +75,8 @@\n     private Integer readyId = 0;\n     private Properties props = new Properties();\n     private String name;\n-    private Lock lobbyLock = new MonitoredReentrantLock(MonitoredLockType.EM_LOBBY);\n-    private Lock queueLock = new MonitoredReentrantLock(MonitoredLockType.EM_QUEUE);\n+    private MonitoredReentrantLock lobbyLock = new MonitoredReentrantLock(MonitoredLockType.EM_LOBBY);\n+    private MonitoredReentrantLock queueLock = new MonitoredReentrantLock(MonitoredLockType.EM_QUEUE);\n \n     private static final int maxLobbys = 8;     // an event manager holds up to this amount of concurrent lobbys\n     \n@@ -92,12 +91,47 @@ public EventManager(Channel cserv, Invocable iv, String name) {\n         for(int i = 0; i < maxLobbys; i++) this.openedLobbys.add(false);\n     }\n \n-    public void cancel() {\n+    public void cancel() {  // make sure to only call this when there are NO PLAYERS ONLINE to mess around with the event manager!\n+        ess.dispose();\n+        \n         try {\n             iv.invokeFunction(\"cancelSchedule\", (Object) null);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             ex.printStackTrace();\n         }\n+        \n+        synchronized(instances) {\n+            for(EventInstanceManager eim : instances.values()) {\n+                eim.dispose();\n+            }\n+            instances.clear();\n+        }\n+        \n+        List<EventInstanceManager> readyEims;\n+        queueLock.lock();\n+        try {\n+            readyEims = new ArrayList<>(readyInstances);\n+            readyInstances.clear();\n+        } finally {\n+            queueLock.unlock();\n+        }\n+        \n+        for(EventInstanceManager eim : readyEims) {\n+            eim.dispose();\n+        }\n+        \n+        props.clear();\n+        cserv = null;\n+        wserv = null;\n+        server = null;\n+        iv = null;\n+        \n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n+        lobbyLock.dispose();\n+        queueLock.dispose();\n     }\n     \n     private static List<Integer> convertToIntegerArray(List<Double> list) {\n@@ -123,12 +157,12 @@ public static long getLobbyDelay() {\n         }\n     }\n \n-    public ScheduledFuture<?> schedule(String methodName, long delay) {\n+    public EventScheduledFuture schedule(String methodName, long delay) {\n         return schedule(methodName, null, delay);\n     }\n \n-    public ScheduledFuture<?> schedule(final String methodName, final EventInstanceManager eim, long delay) {\n-        return TimerManager.getInstance().schedule(new Runnable() {\n+    public EventScheduledFuture schedule(final String methodName, final EventInstanceManager eim, long delay) {\n+        Runnable r = new Runnable() {\n             @Override\n             public void run() {\n                 try {\n@@ -137,11 +171,16 @@ public void run() {\n                     Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n                 }\n             }\n-        }, delay);\n+        };\n+        \n+        ess.registerEntry(r, delay);\n+        \n+        // hate to do that, but those schedules can still be cancelled, so well... Let GC do it's job\n+        return new EventScheduledFuture(r, ess);\n     }\n \n-    public ScheduledFuture<?> scheduleAtTimestamp(final String methodName, long timestamp) {\n-        return TimerManager.getInstance().scheduleAtTimestamp(new Runnable() {\n+    public EventScheduledFuture scheduleAtTimestamp(final String methodName, long timestamp) {\n+        Runnable r = new Runnable() {\n             @Override\n             public void run() {\n                 try {\n@@ -150,7 +189,10 @@ public void run() {\n                     Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n                 }\n             }\n-        }, timestamp);\n+        };\n+        \n+        ess.registerEntry(r, timestamp - server.getCurrentTime());\n+        return new EventScheduledFuture(r, ess);\n     }\n \n     public World getWorldServer() {\n@@ -187,7 +229,7 @@ public EventInstanceManager newInstance(String name) {\n     }\n \n     public void disposeInstance(final String name) {\n-        TimerManager.getInstance().schedule(new Runnable() {\n+        ess.registerEntry(new Runnable() {\n             @Override\n             public void run() {\n                 freeLobbyInstance(name);"}, {"sha": "afb35c470d8ec46bbb78d5bb023f6facf80f86be", "filename": "src/scripting/event/EventScheduledFuture.java", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventScheduledFuture.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/EventScheduledFuture.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventScheduledFuture.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -0,0 +1,40 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package scripting.event;\n+\n+import scripting.event.worker.EventScriptScheduler;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class EventScheduledFuture {\n+    Runnable r;\n+    EventScriptScheduler ess;\n+    \n+    public EventScheduledFuture(Runnable r, EventScriptScheduler ess) {\n+        this.r = r;\n+        this.ess = ess;\n+    }\n+    \n+    public void cancel(boolean dummy) {   // will always implement \"non-interrupt if running\" regardless of boolean value\n+        ess.cancelEntry(r);\n+    }\n+}"}, {"sha": "c26cd24091601ee01e73eb1d1cc0307ead2df5d1", "filename": "src/scripting/event/worker/EventScriptScheduler.java", "status": "added", "additions": 169, "deletions": 0, "changes": 169, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/worker/EventScriptScheduler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/scripting/event/worker/EventScriptScheduler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/worker/EventScriptScheduler.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -0,0 +1,169 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package scripting.event.worker;\n+\n+import constants.ServerConstants;\n+import java.util.HashMap;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.concurrent.ScheduledFuture;\n+import server.TimerManager;\n+import net.server.Server;\n+import net.server.audit.locks.MonitoredLockType;\n+import net.server.audit.locks.MonitoredReentrantLock;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class EventScriptScheduler {\n+    private boolean disposed = false;\n+    private int idleProcs = 0;\n+    private Map<Runnable, Long> registeredEntries = new HashMap<>();\n+    \n+    private ScheduledFuture<?> schedulerTask = null;\n+    private MonitoredReentrantLock schedulerLock;\n+    private Runnable monitorTask = new Runnable() {\n+                                        @Override\n+                                        public void run() {\n+                                            runBaseSchedule();\n+                                        }\n+                                    };\n+    \n+    public EventScriptScheduler() {\n+        schedulerLock = new MonitoredReentrantLock(MonitoredLockType.EM_SCHDL, true);\n+    }\n+    \n+    private void runBaseSchedule() {\n+        List<Runnable> toRemove;\n+        Map<Runnable, Long> registeredEntriesCopy;\n+        \n+        schedulerLock.lock();\n+        try {\n+            if(registeredEntries.isEmpty()) {\n+                idleProcs++;\n+                \n+                if(idleProcs >= ServerConstants.MOB_STATUS_MONITOR_LIFE) {\n+                    if(schedulerTask != null) {\n+                        schedulerTask.cancel(false);\n+                        schedulerTask = null;\n+                    }\n+                }\n+                \n+                return;\n+            }\n+            \n+            idleProcs = 0;\n+            registeredEntriesCopy = new HashMap<>(registeredEntries);\n+        } finally {\n+            schedulerLock.unlock();\n+        }\n+        \n+        long timeNow = Server.getInstance().getCurrentTime();\n+        toRemove = new LinkedList<>();\n+        for(Entry<Runnable, Long> rmd : registeredEntriesCopy.entrySet()) {\n+            if(rmd.getValue() < timeNow) {\n+                Runnable r = rmd.getKey();\n+                \n+                r.run();  // runs the scheduled action\n+                toRemove.add(r);\n+            }\n+        }\n+        \n+        if(!toRemove.isEmpty()) {\n+            schedulerLock.lock();\n+            try {\n+                for(Runnable r : toRemove) {\n+                    registeredEntries.remove(r);\n+                }\n+            } finally {\n+                schedulerLock.unlock();\n+            }\n+        }\n+    }\n+    \n+    public void registerEntry(final Runnable scheduledAction, final long duration) {\n+        \n+        Thread t = new Thread(new Runnable() {\n+                        @Override\n+                        public void run() {\n+                            schedulerLock.lock();\n+                            try {\n+                                idleProcs = 0;\n+                                if(schedulerTask == null) {\n+                                    if(disposed) return;\n+\n+                                    schedulerTask = TimerManager.getInstance().register(monitorTask, ServerConstants.MOB_STATUS_MONITOR_PROC, ServerConstants.MOB_STATUS_MONITOR_PROC);\n+                                }\n+\n+                                registeredEntries.put(scheduledAction, Server.getInstance().getCurrentTime() + duration);\n+                            } finally {\n+                                schedulerLock.unlock();\n+                            }\n+                        }\n+                    });\n+        \n+        t.start();\n+    }\n+    \n+    public void cancelEntry(final Runnable scheduledAction) {\n+        \n+        Thread t = new Thread(new Runnable() {\n+                        @Override\n+                        public void run() {\n+                            schedulerLock.lock();\n+                            try {\n+                                registeredEntries.remove(scheduledAction);\n+                            } finally {\n+                                schedulerLock.unlock();\n+                            }\n+                        }\n+                    });\n+        \n+        t.start();\n+    }\n+    \n+    public void dispose() {\n+        \n+        Thread t = new Thread(new Runnable() {\n+                        @Override\n+                        public void run() {\n+                            schedulerLock.lock();\n+                            try {\n+                                if(schedulerTask != null) {\n+                                    schedulerTask.cancel(false);\n+                                    schedulerTask = null;\n+                                }\n+\n+                                registeredEntries.clear();\n+                                disposed = true;\n+                            } finally {\n+                                schedulerLock.unlock();\n+                            }\n+                            \n+                            schedulerLock.dispose();\n+                        }\n+                    });\n+        \n+        t.start();\n+    }\n+}"}, {"sha": "b2e80337e94c4fe2a92ea6670751f2baf5c7e0a4", "filename": "src/server/MapleStorage.java", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/MapleStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/MapleStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStorage.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -119,7 +119,7 @@ public byte getSlots() {\n         return slots;\n     }\n \n-    public boolean gainSlots(int slots) {\n+    public synchronized boolean gainSlots(int slots) {\n         slots += this.slots;\n \n         if (slots <= 48) {\n@@ -129,11 +129,7 @@ public boolean gainSlots(int slots) {\n \n         return false;\n     }\n-\n-    public void setSlots(byte set) {\n-        this.slots = set;\n-    }\n-\n+    \n     public void saveToDB(Connection con) {\n         try {\n             try (PreparedStatement ps = con.prepareStatement(\"UPDATE storages SET slots = ?, meso = ? WHERE storageid = ?\")) {"}, {"sha": "9601cc9b415a93f22fd48c26db932fc9094515c1", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -54,7 +54,6 @@\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicLong;\n-import java.util.concurrent.locks.Lock;\n import net.server.audit.locks.MonitoredReentrantLock;\n import net.server.Server;\n import net.server.channel.Channel;\n@@ -95,10 +94,10 @@\n     private int parentMobOid = 0;\n     private final HashMap<Integer, AtomicInteger> takenDamage = new HashMap<>();\n \n-    private Lock externalLock = new MonitoredReentrantLock(MonitoredLockType.MOB_EXT);\n-    private Lock monsterLock = new MonitoredReentrantLock(MonitoredLockType.MOB, true);\n-    private Lock statiLock = new MonitoredReentrantLock(MonitoredLockType.MOB_STATI);\n-    private Lock animationLock = new MonitoredReentrantLock(MonitoredLockType.MOB_ANI);\n+    private MonitoredReentrantLock externalLock = new MonitoredReentrantLock(MonitoredLockType.MOB_EXT);\n+    private MonitoredReentrantLock monsterLock = new MonitoredReentrantLock(MonitoredLockType.MOB, true);\n+    private MonitoredReentrantLock statiLock = new MonitoredReentrantLock(MonitoredLockType.MOB_STATI);\n+    private MonitoredReentrantLock animationLock = new MonitoredReentrantLock(MonitoredLockType.MOB_ANI);\n \n     public MapleMonster(int id, MapleMonsterStats stats) {\n         super(id);\n@@ -1476,4 +1475,11 @@ private void changeLevelByDifficulty(final int difficulty, boolean pqMob) {\n     public final void changeDifficulty(final int difficulty, boolean pqMob) {\n         changeLevelByDifficulty(difficulty, pqMob);\n     }\n+    \n+    public final void disposeLocks() {\n+        externalLock.dispose();\n+        monsterLock.dispose();\n+        statiLock.dispose();\n+        animationLock.dispose();\n+    }\n }"}, {"sha": "42cb4102f092ea0223339615a1e2a0e9c439e65f", "filename": "src/server/life/MaplePlayerNPC.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/life/MaplePlayerNPC.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/life/MaplePlayerNPC.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MaplePlayerNPC.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -248,7 +248,7 @@ private static void getRunningOverallRanks(Connection con) throws SQLException {\n     }\n \n     private static void getRunningWorldRanks(Connection con) throws SQLException {\n-        int numWorlds = Server.getInstance().getWorlds().size();\n+        int numWorlds = Server.getInstance().getWorldsSize();\n         for(int i = 0; i < numWorlds; i++) {\n             runningWorldRank.add(new AtomicInteger(1));\n         }\n@@ -625,7 +625,7 @@ public static void removeAllPlayerNPC() {\n             PreparedStatement ps = con.prepareStatement(\"SELECT DISTINCT world, map FROM playernpcs\");\n             ResultSet rs = ps.executeQuery();\n             \n-            int wsize = Server.getInstance().getWorlds().size();\n+            int wsize = Server.getInstance().getWorldsSize();\n             while(rs.next()) {\n                 int world = rs.getInt(\"world\"), map = rs.getInt(\"map\");\n                 if(world >= wsize) continue;"}, {"sha": "54bc8fd6ddec05384114c260512473eab7c9c128", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 44, "deletions": 4, "changes": 48, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -2103,6 +2103,10 @@ public final void spawnItemDropList(List<Integer> list, int minCopies, int maxCo\n         }\n     }\n \n+    private void registerMapSchedule(Runnable r, long delay) {\n+        this.getChannelServer().registerOverallAction(mapid, r, delay);\n+    }\n+    \n     private void activateItemReactors(final MapleMapItem drop, final MapleClient c) {\n         final Item item = drop.getItem();\n \n@@ -2113,7 +2117,7 @@ private void activateItemReactors(final MapleMapItem drop, final MapleClient c)\n                 if (react.getReactItem(react.getEventState()).getLeft() == item.getItemId() && react.getReactItem(react.getEventState()).getRight() == item.getQuantity()) {\n \n                     if (react.getArea().contains(drop.getPosition())) {\n-                        TimerManager.getInstance().schedule(new ActivateItemReactor(drop, react, c), 5000);\n+                        registerMapSchedule(new ActivateItemReactor(drop, react, c), 5000);\n                         break;\n                     }\n                 }\n@@ -2151,7 +2155,7 @@ public void searchItemReactors(final MapleReactor react) {\n                     if (reactArea.contains(drop.getPosition())) {\n                         MapleClient owner = drop.getOwnerClient();\n                         if(owner != null) {\n-                            TimerManager.getInstance().schedule(new ActivateItemReactor(drop, react, owner), 5000);\n+                            registerMapSchedule(new ActivateItemReactor(drop, react, owner), 5000);\n                         }\n                     }\n                 }\n@@ -2173,13 +2177,16 @@ public void startMapEffect(String msg, int itemId, long time) {\n         }\n         mapEffect = new MapleMapEffect(msg, itemId);\n         broadcastMessage(mapEffect.makeStartData());\n-        TimerManager.getInstance().schedule(new Runnable() {\n+        \n+        Runnable r = new Runnable() {\n             @Override\n             public void run() {\n                 broadcastMessage(mapEffect.makeDestroyData());\n                 mapEffect = null;\n             }\n-        }, time);\n+        };\n+        \n+        registerMapSchedule(r, time);\n     }\n     \n     public MapleCharacter getAnyCharacterFromParty(int partyid) {\n@@ -3807,4 +3814,37 @@ public void monsterHealed(int trueHeal) {\n             spawnMonsterOnGroundBelow(m, targetPoint);\n         }\n     }\n+    \n+    public void dispose() {\n+        for(MapleMonster mm : this.getMonsters()) {\n+            mm.disposeLocks();\n+        }\n+        \n+        clearMapObjects();\n+        \n+        event = null;\n+        footholds = null;\n+        portals.clear();\n+        mapEffect = null;\n+        \n+        if(mapMonitor != null) {\n+            mapMonitor.cancel(false);\n+            mapMonitor = null;\n+        }\n+        \n+        chrWLock.lock();\n+        try {\n+            if(itemMonitor != null) {\n+                itemMonitor.cancel(false);\n+                itemMonitor = null;\n+            }\n+\n+            if(expireItemsTask != null) {\n+                expireItemsTask.cancel(false);\n+                expireItemsTask = null;\n+            }\n+        } finally {\n+            chrWLock.unlock();\n+        }\n+    }\n }"}, {"sha": "072e1e377907166a9b737474bc361a86e4faa124", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -437,7 +437,10 @@ public void dispose() {\n             mapsRLock.unlock();\n         }\n         \n-        for(MapleMap map: mapValues) map.setEventInstance(null);\n+        for(MapleMap map: mapValues) {\n+            map.dispose();\n+        }\n+        \n         this.event = null;\n     }\n }"}, {"sha": "4868f0a78372a829a75c73da4f09537daebb36b7", "filename": "src/server/maps/MapleTVEffect.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleTVEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/src/server/maps/MapleTVEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleTVEffect.java?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -34,7 +34,7 @@\n  */\n public class MapleTVEffect {\n \t\n-\tprivate final static boolean ACTIVE[] = new boolean[Server.getInstance().getWorlds().size()];\n+\tprivate final static boolean ACTIVE[] = new boolean[Server.getInstance().getWorldsSize()];\n \t\n \tpublic static synchronized boolean broadcastMapleTVIfNotActive(MapleCharacter player, MapleCharacter victim, List<String> messages, int tvType){\n                 int w = player.getWorld();"}, {"sha": "e8113c9b7cf744700c0f478e850ddf57fbc4343f", "filename": "wz/Etc.wz/Commodity.img.xml", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/wz/Etc.wz/Commodity.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/8aadf7c369340f5cdcfd1a13bacfb4d557a084c6/wz/Etc.wz/Commodity.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Etc.wz/Commodity.img.xml?ref=8aadf7c369340f5cdcfd1a13bacfb4d557a084c6", "patch": "@@ -81697,23 +81697,23 @@\n   </imgdir>\n   <imgdir name=\"7970\">\n     <int name=\"SN\" value=\"50200099\"/>\n-    <int name=\"ItemId\" value=\"5130000\"/>\n-    <int name=\"Count\" value=\"11\"/>\n-    <int name=\"Price\" value=\"6000\"/>\n+    <int name=\"ItemId\" value=\"9113000\"/>\n+    <int name=\"Count\" value=\"1\"/>\n+    <int name=\"Price\" value=\"6800\"/>\n     <int name=\"Period\" value=\"90\"/>\n-    <int name=\"Priority\" value=\"13\"/>\n+    <int name=\"Priority\" value=\"6\"/>\n     <int name=\"Gender\" value=\"2\"/>\n-    <int name=\"OnSale\" value=\"0\"/>\n+    <int name=\"OnSale\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"7971\">\n     <int name=\"SN\" value=\"50200100\"/>\n-    <int name=\"ItemId\" value=\"5490001\"/>\n-    <int name=\"Count\" value=\"1\"/>\n-    <int name=\"Price\" value=\"1200\"/>\n+    <int name=\"ItemId\" value=\"5520000\"/>\n+    <int name=\"Count\" value=\"4\"/>\n+    <int name=\"Price\" value=\"10500\"/>\n     <int name=\"Period\" value=\"90\"/>\n-    <int name=\"Priority\" value=\"14\"/>\n+    <int name=\"Priority\" value=\"10\"/>\n     <int name=\"Gender\" value=\"2\"/>\n-    <int name=\"OnSale\" value=\"0\"/>\n+    <int name=\"OnSale\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"7972\">\n     <int name=\"SN\" value=\"50200101\"/>"}]}]},
