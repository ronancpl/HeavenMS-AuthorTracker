{"fetchDate": "2019-12-19", "content": [{"sha": "a636f63114d5a30c94b92963e6a2e2cb83f47563", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YTYzNmY2MzExNGQ1YTMwYzk0YjkyOTYzZTZhMmUyY2I4M2Y0NzU2Mw==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-24T22:52:00Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-24T22:52:00Z"}, "message": "Partial solution on Guild Alliances\n\nRevamped DB tables and enabled some functionalities on Guild Alliances,\nsuch as create one, expel/quit one and rank players.", "tree": {"sha": "d1839cfa44b44041cb5278848dfc2dc9ea586b2c", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/d1839cfa44b44041cb5278848dfc2dc9ea586b2c"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/a636f63114d5a30c94b92963e6a2e2cb83f47563", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a636f63114d5a30c94b92963e6a2e2cb83f47563", "html_url": "https://github.com/ronancpl/HeavenMS/commit/a636f63114d5a30c94b92963e6a2e2cb83f47563", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/a636f63114d5a30c94b92963e6a2e2cb83f47563/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "53927576e757571be899ef0f34d4d6bbb64a0aeb", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/53927576e757571be899ef0f34d4d6bbb64a0aeb", "html_url": "https://github.com/ronancpl/HeavenMS/commit/53927576e757571be899ef0f34d4d6bbb64a0aeb"}], "stats": {"total": 822, "additions": 551, "deletions": 271}, "files": [{"sha": "96280cc0c1ff200a6e38ed17d6f3e3489224dda7", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -242,4 +242,8 @@ Retiradas inconsist\n Foi retirado o gargalo no sistema sempre que jogador incorpora um novo card ao mobbook.\n Consertado bug em potencial ao tentar completar quest que requer item equipado.\n Adi\ufffd\ufffdo de scrolls: Scroll for cold protection, Scroll for spike for shoes.\n-Consertado quest-evento Dollhouse.\n\\ No newline at end of file\n+Consertado quest-evento Dollhouse.\n+\n+23 - 24 Maio 2017,\n+Revamp na DB referente \ufffds Alliances.\n+Solu\ufffd\ufffdo parcial ao problema das Guild Alliances. Pode-se criar uma, sair, expulsar e trocar ranks de jogadores.\n\\ No newline at end of file"}, {"sha": "1252af1b6bed5b777e3dfce6ab4ed2362ac8a895", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 9, "deletions": 30, "changes": 39, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -3,37 +3,16 @@\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/command/Commands.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/HiredMerchant.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleStatEffect.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/AbstractPlayerInteraction.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2040020.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2040002.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/PlayerInteractionHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleItemInformationProvider.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/StorageHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/UseCashItemHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/inventory/Equip.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/event/EventInstanceManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleBuffStat.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleMap.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2040028.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/PlayerLoggedinHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/EllinPQ.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/constants/ItemConstants.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleReactor.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/MapleDragon.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2133000.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/inventory/MapleInventory.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/DollHouse.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/ScrollHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/maps/AbstractMapleMapObject.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/MapleQuestRequirementType.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/handlers/AllianceOperationHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleGuild.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleAlliance.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/guild/MapleGuildCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/Server.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/world/World.java</file>\n             <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/npc/NPCConversationManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/MapleInventoryManipulator.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/actions/PetSkillAction.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/server/quest/MapleQuest.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/handlers/login/GuestLoginHandler.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/tools/MaplePacketCreator.java</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "de3d35842443c288e789ad1b2f1f55b3ab08edcf", "filename": "scripts/npc/world0/2010009.js", "status": "modified", "additions": 55, "deletions": 14, "changes": 69, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/scripts/npc/world0/2010009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/scripts/npc/world0/2010009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2010009.js?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -24,6 +24,10 @@ var choice;\n var guildName;\n var partymembers;\n \n+var allianceCost = 2000000;\n+var increaseCost = 1000000;\n+var allianceLimit = 5;\n+\n function start() {\n     partymembers = cm.getPartyMembers();\n     status = -1;\n@@ -37,22 +41,40 @@ function action(mode, type, selection) {\n         cm.dispose();\n         return;\n     }\n-    if (status == 0)\n-        cm.sendSimple(\"Hello there! I'm #bLenario#k\\r\\n#b#L0#Can you please tell me what Guild Union is all about?#l\\r\\n#L1#How do I make a Guild Union?#l\\r\\n#L2#I want to make a Guild Union.#l\\r\\n#L3#I want to add more guilds for the Guild Union.#l\\r\\n#L4#I want to break up the Guild Union.#l\");\n+    if (status == 0) {\n+        if(cm.getPlayer().getGuildId() < 1 || cm.getPlayer().getGuildRank() != 1) {\n+            cm.sendNext(\"Hello there! I'm #bLenario#k. Just guild masters can attempt to form guild unions.\");\n+            cm.dispose();\n+            return;\n+        }\n+        if(!cm.isLeader()) {\n+            cm.sendNext(\"Hello there! I'm #bLenario#k. If you want to form a guild, please tell your party leader to talk to me. He/She will be assigned as the Leader of the Guild Union.\");\n+            cm.dispose();\n+            return;\n+        }\n+        \n+        cm.sendSimple(\"Hello there! I'm #bLenario#k.\\r\\n#b#L0#Can you please tell me what Guild Union is all about?#l\\r\\n#L1#How do I make a Guild Union?#l\\r\\n#L2#I want to make a Guild Union.#l\\r\\n#L3#I want to add more guilds for the Guild Union.#l\\r\\n#L4#I want to break up the Guild Union.#l\");\n+    }\n     else if (status == 1) {\n         choice = selection;\n         if (selection == 0) {\n             cm.sendNext(\"Guild Union is just as it says, a union of a number of guilds to form a super group. I am in charge of managing these Guild Unions.\");\n             cm.dispose();\n         } else if (selection == 1) {\n-            cm.sendNext(\"To make a Guild Union, 2 Guild Masters need to be in a party. The leader of this party will be assigned as the Guild Union Master.\");\n+            cm.sendNext(\"To make a Guild Union, two and only two Guild Masters need to be in a party and both must be present on this room on the same channel. The leader of this party will be assigned as the Guild Union Master.\");\n             cm.dispose();\n         } else if(selection == 2) {\n-                cm.sendYesNo(\"Oh, are you interested in forming a Guild Union?\");\n+            if(cm.getPlayer().getGuild().getAllianceId() > 0) {\n+                cm.sendOk(\"You can not create a Guild Union while your guild is already registered in another.\");\n+                cm.dispose();\n+                return;\n+            }\n+            \n+            cm.sendYesNo(\"Oh, are you interested in forming a Guild Union? The current fee for this operation is #b\" + allianceCost + \" mesos#k.\");\n         } else if (selection == 3) {\n             var rank = cm.getPlayer().getMGC().getAllianceRank();\n             if (rank == 1)\n-                cm.sendOk(\"Not done yet\"); //ExpandGuild Text\n+                cm.sendYesNo(\"Do you want to increase your Alliance by one guild slot? The fee for this procedure is #b\" + increaseCost + \" mesos#k.\");\n             else {\n                 cm.sendNext(\"Only the Guild Union Master can expand the number of guilds in the Union.\");\n                 cm.dispose();\n@@ -68,12 +90,29 @@ function action(mode, type, selection) {\n         }\n     } else if(status == 2) {\n         if (choice == 2) {\n+            if(cm.getMeso() < allianceCost) {\n+                cm.sendOk(\"You don't have enough mesos for this request.\");\n+                cm.dispose();\n+                return;\n+            }\n             cm.sendGetText(\"Now please enter the name of your new Guild Union. (max. 12 letters)\");\n-        } else if (choice == 4) {\n-            if (cm.getPlayer().getGuild() == null) {\n-                cm.sendNext(\"You cannot disband a non-existant Guild Union.\");\n+        } else if (choice == 3) {\n+            if(cm.getAllianceCapacity() == allianceLimit) {\n+                cm.sendOk(\"Your alliance already reached the maximum capacity for guilds.\");\n+                cm.dispose();\n+                return;\n+            }\n+            if(cm.getMeso() < increaseCost) {\n+                cm.sendOk(\"You don't have enough mesos for this request.\");\n                 cm.dispose();\n-            } else if (cm.getPlayer().getGuild().getAllianceId() <= 0) {\n+                return;\n+            }\n+            \n+            cm.upgradeAlliance();\n+            cm.gainMeso(-increaseCost);\n+            cm.sendOk(\"Your alliance can now accept one more guild.\");\n+        } else if (choice == 4) {\n+            if (cm.getPlayer().getGuild() == null || cm.getPlayer().getGuild().getAllianceId() <= 0) {\n                 cm.sendNext(\"You cannot disband a non-existant Guild Union.\");\n                 cm.dispose();\n             } else {\n@@ -84,17 +123,19 @@ function action(mode, type, selection) {\n         }\n     } else if (status == 3) {\n         guildName = cm.getText();\n-        cm.sendYesNo(\"Will \"+ guildName + \" be the name of your Guild Union?\");\n+        cm.sendYesNo(\"Will '\"+ guildName + \"' be the name of your Guild Union?\");\n     } else if (status == 4) {\n         if (!cm.canBeUsedAllianceName(guildName)) {\n-            cm.sendNext(\"This name is unavailable, please choose another one\"); //Not real text\n+            cm.sendNext(\"This name is unavailable, please choose another one.\"); //Not real text\n             status = 1;\n             choice = 2;\n         } else {\n-            if (cm.createAlliance(partymembers.get(0), partymembers.get(1), guildName) == null)\n-                cm.sendOk(\"An unknown system error has occured.\");\n-            else\n+            if (cm.createAlliance(guildName) == null)\n+                cm.sendOk(\"Please check if you and the other one guild leader in your party are both here on this room right now. No other guild leaders should be present with you 2 on this process.\");\n+            else {\n+                cm.gainMeso(-allianceCost);\n                 cm.sendOk(\"You have successfully formed a Guild Union.\");\n+            }\n             cm.dispose();\n         }\n     }"}, {"sha": "bd8b8e4e70c27d2604f6cd02938313d9a642cdd5", "filename": "sql/db_database.sql", "status": "modified", "additions": 7, "deletions": 10, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -52,16 +52,13 @@ CREATE TABLE IF NOT EXISTS `alliance` (\n   `name` varchar(13) NOT NULL,\n   `notice` varchar(128) NOT NULL DEFAULT '',\n   `capacity` int(10) unsigned NOT NULL DEFAULT '2',\n-  `rank_title1` varchar(45) NOT NULL DEFAULT 'Master',\n-  `rank_title2` varchar(45) NOT NULL DEFAULT 'Jr.Master',\n-  `rank_title3` varchar(45) NOT NULL DEFAULT 'Member',\n-  `rank_title4` varchar(45) NOT NULL DEFAULT 'Member',\n-  `rank_title5` varchar(45) NOT NULL DEFAULT 'Member',\n-  `guild1` int(10) NOT NULL DEFAULT '-1',\n-  `guild2` int(10) NOT NULL DEFAULT '-1',\n-  `guild3` int(10) NOT NULL DEFAULT '-1',\n-  `guild4` int(10) NOT NULL DEFAULT '-1',\n-  `guild5` int(10) NOT NULL DEFAULT '-1',\n+  PRIMARY KEY (`id`)\n+) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n+\n+CREATE TABLE IF NOT EXISTS `allianceguilds` (\n+  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n+  `allianceid` int(10) NOT NULL DEFAULT '-1',\n+  `guildid` int(10) NOT NULL DEFAULT '-1',\n   PRIMARY KEY (`id`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n "}, {"sha": "4b7092fd4cf811ebd21347e45901dfef14863d3b", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -55,6 +55,7 @@\n import net.server.PlayerDiseaseValueHolder;\n import net.server.Server;\n import net.server.channel.Channel;\n+import net.server.guild.MapleAlliance;\n import net.server.guild.MapleGuild;\n import net.server.guild.MapleGuildCharacter;\n import net.server.world.MapleMessenger;\n@@ -2205,6 +2206,18 @@ public MapleGuild getGuild() {\n             return null;\n         }\n     }\n+    \n+    public MapleAlliance getAlliance() {\n+        if(mgc != null) {\n+            try {\n+                return Server.getInstance().getAlliance(getGuild().getAllianceId());\n+            } catch (Exception ex) {\n+                ex.printStackTrace();\n+            }\n+        }\n+        \n+        return null;\n+    }\n \n     public int getGuildId() {\n         return guildid;\n@@ -3351,7 +3364,7 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             ret.dojoStage = rs.getInt(\"lastDojoStage\");\n             ret.dataString = rs.getString(\"dataString\");\n             if (ret.guildid > 0) {\n-                ret.mgc = new MapleGuildCharacter(ret);\n+                ret.mgc = new MapleGuildCharacter(ret); // oh boy, that's quite funny\n             }\n             int buddyCapacity = rs.getInt(\"buddyCapacity\");\n             ret.buddylist = new BuddyList(buddyCapacity);\n@@ -4147,8 +4160,8 @@ public void resetEnteredScript(String script) {\n         }\n     }\n \n-    public void resetMGC() {\n-        this.mgc = null;\n+    public void resetMGC(MapleGuildCharacter mgc) {\n+        this.mgc = mgc;\n     }\n \n     public synchronized void saveCooldowns() {\n@@ -4179,7 +4192,7 @@ public void saveGuildStatus() {\n                 ps.setInt(2, guildrank);\n                 ps.setInt(3, allianceRank);\n                 ps.setInt(4, id);\n-                ps.execute();\n+                ps.executeUpdate();\n             }\n         } catch (SQLException se) {\n             se.printStackTrace();"}, {"sha": "4b7187819673ee01407771be1373ea941c2959e4", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -786,6 +786,8 @@ public final void disconnect(boolean shutdown, boolean cashshop) {//once per Map\n \t\t\tfinal MapleGuild guild = player.getGuild();\n \n \t\t\tif (channel == -1 || shutdown) {\n+                                chrg.setCharacter(null);\n+                            \n                                 removePlayer();\n                                 player.saveCooldowns();\n                                 player.saveToDB();\n@@ -944,7 +946,7 @@ public boolean deleteCharacter(int cid) {\n \t\t\t\t\t}\n \t\t\t\t\tif (rs.getInt(\"guildid\") > 0) {\n \t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\tServer.getInstance().deleteGuildCharacter(new MapleGuildCharacter(cid, 0, rs.getString(\"name\"), (byte) -1, (byte) -1, 0, rs.getInt(\"guildrank\"), rs.getInt(\"guildid\"), false, rs.getInt(\"allianceRank\")));\n+\t\t\t\t\t\t\tServer.getInstance().deleteGuildCharacter(new MapleGuildCharacter(player, cid, 0, rs.getString(\"name\"), (byte) -1, (byte) -1, 0, rs.getInt(\"guildrank\"), rs.getInt(\"guildid\"), false, rs.getInt(\"allianceRank\")));\n \t\t\t\t\t\t} catch (Exception re) {\n                                                         re.printStackTrace();\n \t\t\t\t\t\t\treturn false;"}, {"sha": "cf68806c6d1e736067f2b0da27a5c7c6017b5def", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 53, "deletions": 11, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -316,7 +316,12 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n \t\tswitch (sub[0]) {\n                 case \"help\":\n \t\tcase \"commands\":\n-\t\t\tplayer.yellowMessage(\"After you vote, talk to Rooney to get a leaf and redeem it for prizes!\");\n+                    \n+                                    \n+                case \"playercommands\": \n+                       player.message(\"============================================================\");\n+                       player.message(\"MapleSolaxiaV2 Player Commands\");\n+                       player.message(\"============================================================\");\n \t\t\tplayer.message(\"@dispose: Fixes your character if it is stuck.\");\n \t\t\tplayer.message(\"@online: Displays a list of all online players.\");\n \t\t\tplayer.message(\"@time: Displays the current server time.\");\n@@ -368,10 +373,6 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n  \t\t\tplayer.yellowMessage(\"Solaxia has been online for \" + days + \" days \" + hours + \" hours \" + minutes + \" minutes and \" + seconds + \" seconds.\");\n \t\t\tbreak;\n \t\tcase \"gacha\":\n-\t\t\tif (player.gmLevel() == 0) { // Sigh, need it for now...\n-\t\t\t\tplayer.yellowMessage(\"Player Command \" + heading + sub[0] + \" does not exist, see @help for a list of commands.\");\n-\t\t\t\treturn false;\n-\t\t\t}\n \t\t\tGachapon gacha = null;\n \t\t\tString search = joinStringFrom(sub, 1);\n \t\t\tString gachaName = \"\";\n@@ -478,7 +479,11 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n \t\t\tplayer.message(\"You've been disposed.\");\n \t\t\tbreak;\n \t\tcase \"rates\":\n-\t\t\tc.resetVoteTime(); \n+\t\t\t//c.resetVoteTime();\n+\t\t\tplayer.yellowMessage(\"BOSSDROP RATE\");\n+\t\t\tplayer.message(\">>Total BOSSDROP Rate: \" + c.getWorldServer().getBossDropRate() + \"x\");\n+                        player.message(\">>------------------------------------------------\");\n+                        \n \t\t\tplayer.yellowMessage(\"DROP RATE\");\n                         player.message(\">>Base DROP Rate: \" + c.getWorldServer().getDropRate() + \"x\");\n                         player.message(\">>Your DROP Rate: \" + player.getDropRate() / c.getWorldServer().getDropRate() + \"x\");\n@@ -671,7 +676,7 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n                             \n \t\tdefault:\n \t\t\tif (player.gmLevel() == 0) {\n-\t\t\t\tplayer.yellowMessage(\"Player Command \" + heading + sub[0] + \" does not exist, see @help for a list of commands.\");\n+\t\t\t\tplayer.yellowMessage(\"Player Command \" + heading + sub[0] + \" does not exist, see @playercommands for a list of commands.\");\n \t\t\t}\n \t\t\treturn false;\n \t\t}\n@@ -683,7 +688,12 @@ public static boolean executeGMCommand(MapleClient c, String[] sub, char heading\n \t\tChannel cserv = c.getChannelServer();\n \t\tServer srv = Server.getInstance();\n                 \n-                if (sub[0].equals(\"sp\")) {\n+                if (sub[0].equals(\"commands\")) {\n+                        player.message(\"============================================================\");\n+                        player.message(\"MapleSolaxiaV2 GM/Admin Commands Available\");\n+                        player.message(\"============================================================\");\n+                }\n+                else if (sub[0].equals(\"sp\")) {\n                         if (sub.length < 2){\n \t\t\t\tplayer.yellowMessage(\"Syntax: !sp [<playername>] <newsp>\");\n \t\t\t\treturn true;\n@@ -1571,7 +1581,6 @@ else if (type.equals(\"cash\")) {\n                         SkillFactory.getSkill(9101004).getEffect(SkillFactory.getSkill(9101004).getMaxLevel()).applyTo(player);\n                 } else if (sub[0].equals(\"unhide\")) {\n                         SkillFactory.getSkill(9101004).getEffect(SkillFactory.getSkill(9101004).getMaxLevel()).applyTo(player);\n-                        \n                 } else if (sub[0].equals(\"healmap\")) {\n                         for (MapleCharacter mch : player.getMap().getCharacters()) {\n                                 if (mch != null) {\n@@ -1581,6 +1590,39 @@ else if (type.equals(\"cash\")) {\n                                         mch.updateSingleStat(MapleStat.MP, mch.getMaxMp());\n                                 }\n                         }\n+                } else if (sub[0].equals(\"healperson\")) {\n+                                MapleCharacter victim = cserv.getPlayerStorage().getCharacterByName(sub[1]);\n+                                victim.setHp(victim.getMaxHp());\n+                                victim.updateSingleStat(MapleStat.HP, victim.getMaxHp());\n+                                victim.setMp(victim.getMaxMp());\n+                                victim.updateSingleStat(MapleStat.MP, victim.getMaxMp());\n+                } else if (sub[0].equals(\"hurt\")) {\n+                                MapleCharacter victim = cserv.getPlayerStorage().getCharacterByName(sub[1]);\n+                                victim.setHp(1);\n+                                victim.updateSingleStat(MapleStat.HP, 1);\n+                } else if (sub[0].equals(\"killmap\")) {\n+                        for (MapleCharacter mch : player.getMap().getCharacters()) {\n+                                mch.setHp(0);\n+                                mch.updateSingleStat(MapleStat.HP, 0);\n+                        }\n+                } else if (sub[0].equals(\"mesorate\")) {\n+                        if (sub.length < 2){\n+                                player.yellowMessage(\"Syntax: !mesorate <newrate>\");\n+                                return true;\n+                        }\n+                        c.getWorldServer().setMesoRate(Integer.parseInt(sub[1]));\n+                } else if (sub[0].equals(\"droprate\")) {\n+                        if (sub.length < 2){\n+                                player.yellowMessage(\"Syntax: !droprate <newrate>\");\n+                                return true;\n+                        }\t\t\n+                        c.getWorldServer().setDropRate(Integer.parseInt(sub[1]));\n+                } else if (sub[0].equals(\"bossdroprate\")) {\n+                        if (sub.length < 2){\n+                                player.yellowMessage(\"Syntax: !bossdroprate <newrate>\");\n+                                return true;\n+                        }\n+                                c.getWorldServer().setBossDropRate(Integer.parseInt(sub[1]));\n                 } else if (sub[0].equalsIgnoreCase(\"night\")) {\n                         player.getMap().broadcastNightEffect();\n                         player.yellowMessage(\"Done.\");\n@@ -1806,14 +1848,14 @@ public static void executeAdminCommand(MapleClient c, String[] sub, char heading\n \t\t\tbreak;\n \t\tcase \"clearquest\":\n \t\t\tif(sub.length < 1) {\n-\t\t\t\tplayer.dropMessage(5, \"Plese include a quest ID.\");\n+\t\t\t\tplayer.dropMessage(5, \"Please include a quest ID.\");\n \t\t\t\treturn;\n \t\t\t}\n \t\t\tMapleQuest.clearCache(Integer.parseInt(sub[1]));\n \t\t\tplayer.dropMessage(5, \"Quest Cache for quest \" + sub[1] + \" cleared.\");\n \t\t\tbreak;\n \t\tdefault:\n-\t\t\tplayer.yellowMessage(\"Command \" + heading + sub[0] + \" does not exist.\");\n+\t\t\tplayer.yellowMessage(\"Command \" + heading + sub[0] + \" does not exist. See !commands for a list of available commands.\");\n \t\t\tbreak;\n \t\t}\n \t}"}, {"sha": "83ef54705f2f05108caba8c30a2d6433be9c5464", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -130,6 +130,8 @@ public void messageReceived(IoSession session, Object message) {\n         SeekableLittleEndianAccessor slea = new GenericSeekableLittleEndianAccessor(new ByteArrayByteStream(content));\n         short packetId = slea.readShort();\n         MapleClient client = (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n+        \n+        //System.out.println(\"Received packet id \" + packetId);\n         final MaplePacketHandler packetHandler = processor.getHandler(packetId);\n         if (packetHandler != null && packetHandler.validateState(client)) {\n             try {"}, {"sha": "97311eb842b45332eef869e8ec9c9e2dffc178fd", "filename": "src/net/RecvOpcode.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/RecvOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/RecvOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/RecvOpcode.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -134,11 +134,11 @@\n     RPS_ACTION(0x88),\n     RING_ACTION(0x89),\n     WEDDING_ACTION(0x8A),\n+    ALLIANCE_OPERATION(0x8F),\n     OPEN_FAMILY(0x92),\n     ADD_FAMILY(0x93),\n     ACCEPT_FAMILY(0x96),\n     USE_FAMILY(0x97),\n-    ALLIANCE_OPERATION(0x98),\n     BBS_OPERATION(0x9B),\n     ENTER_MTS(0x9C),\n     USE_SOLOMON_ITEM(0x9D),"}, {"sha": "fa24e67c88a9a491e2737b2f9133258045bcf542", "filename": "src/net/server/Server.java", "status": "modified", "additions": 25, "deletions": 9, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -287,6 +287,7 @@ public boolean addGuildtoAlliance(int aId, int guildId) {\n         MapleAlliance alliance = alliances.get(aId);\n         if (alliance != null) {\n             alliance.addGuild(guildId);\n+            guilds.get(guildId).setAllianceId(aId);\n             return true;\n         }\n         return false;\n@@ -296,6 +297,7 @@ public boolean removeGuildFromAlliance(int aId, int guildId) {\n         MapleAlliance alliance = alliances.get(aId);\n         if (alliance != null) {\n             alliance.removeGuild(guildId);\n+            guilds.get(guildId).setAllianceId(0);\n             return true;\n         }\n         return false;\n@@ -346,6 +348,16 @@ public byte getHighestChannelId() {\n     public int createGuild(int leaderId, String name) {\n         return MapleGuild.createGuild(leaderId, name);\n     }\n+    \n+    public MapleGuild getGuild(int id) {\n+        synchronized (guilds) {\n+            if (guilds.get(id) != null) {\n+                return guilds.get(id);\n+            }\n+            \n+            return null;\n+        }\n+    }\n \n     public MapleGuild getGuild(int id, int world, MapleGuildCharacter mgc) {\n         synchronized (guilds) {\n@@ -393,6 +405,10 @@ public boolean setGuildAllianceId(int gId, int aId) {\n         }\n         return false;\n     }\n+    \n+    public void resetAllianceGuildPlayersRank(int gId) {\n+        guilds.get(gId).resetAllianceGuildPlayersRank();\n+    }\n \n     public void leaveGuild(MapleGuildCharacter mgc) {\n         MapleGuild g = guilds.get(mgc.getGuildId());\n@@ -473,16 +489,16 @@ public void gainGP(int gid, int amount) {\n         }\n     }\n \t\n-\tpublic void guildMessage(int gid, byte[] packet) {\n-\t\tguildMessage(gid, packet, -1);\n-\t}\n+    public void guildMessage(int gid, byte[] packet) {\n+        guildMessage(gid, packet, -1);\n+    }\n \t\n-\tpublic void guildMessage(int gid, byte[] packet, int exception) {\n-\t\tMapleGuild g = guilds.get(gid);\n-\t\tif(g != null) {\n-\t\t\tg.broadcast(packet, exception);\n-\t\t}\n-\t}\n+    public void guildMessage(int gid, byte[] packet, int exception) {\n+        MapleGuild g = guilds.get(gid);\n+        if(g != null) {\n+            g.broadcast(packet, exception);\n+        }\n+    }\n \n     public PlayerBuffStorage getPlayerBuffStorage() {\n         return buffStorage;"}, {"sha": "9e18c3d25d7492efacc3c12f4da27ec65f7dbf46", "filename": "src/net/server/channel/handlers/AllianceOperationHandler.java", "status": "modified", "additions": 83, "deletions": 17, "changes": 100, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/channel/handlers/AllianceOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/channel/handlers/AllianceOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AllianceOperationHandler.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -26,6 +26,7 @@\n import net.AbstractMaplePacketHandler;\n import net.SendOpcode;\n import net.server.Server;\n+import net.server.guild.MapleGuildCharacter;\n import net.server.guild.MapleAlliance;\n import tools.MaplePacketCreator;\n import tools.data.input.SeekableLittleEndianAccessor;\n@@ -39,47 +40,67 @@\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        System.out.print(\"aop \");\n+        \n         MapleAlliance alliance = null;\n         if (c.getPlayer().getGuild() != null && c.getPlayer().getGuild().getAllianceId() > 0) {\n-            alliance = Server.getInstance().getAlliance(c.getPlayer().getGuild().getAllianceId());\n+            alliance = c.getPlayer().getAlliance();\n         }\n         if (alliance == null) {\n-            c.getPlayer().dropMessage(\"You are not in an alliance.\");\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         } else if (c.getPlayer().getMGC().getAllianceRank() > 2 || !alliance.getGuilds().contains(c.getPlayer().getGuildId())) {\n             c.announce(MaplePacketCreator.enableActions());\n             return;\n         }\n-        switch (slea.readByte()) {\n+        \n+        byte b = slea.readByte();\n+        System.out.print(b);\n+        switch (b) {\n             case 0x01:\n+                System.out.print(\" case 1\");\n                 Server.getInstance().allianceMessage(alliance.getId(), sendShowInfo(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId()), -1, -1);\n                 break;\n             case 0x02: { // Leave Alliance\n+                System.out.print(\" case 2\");\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuildId() < 1 || c.getPlayer().getGuildRank() != 1) {\n                     return;\n                 }\n-                Server.getInstance().allianceMessage(alliance.getId(), sendChangeGuild(c.getPlayer().getGuildId(), c.getPlayer().getId(), c.getPlayer().getGuildId(), 2), -1, -1);\n+                int guildid = c.getPlayer().getGuildId();\n+                \n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.removeGuildFromAlliance(alliance, guildid, c), -1, -1);\n+                Server.getInstance().removeGuildFromAlliance(alliance.getId(), guildid);\n+                \n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, c), -1, -1);\n+                Server.getInstance().guildMessage(guildid, MaplePacketCreator.disbandAlliance(alliance.getId()));\n                 break;\n             }\n             case 0x03: // send alliance invite\n+                System.out.print(\" case 3 avail is \" + slea.available());\n                 String charName = slea.readMapleAsciiString();\n-                int channel;\n-                channel = c.getWorldServer().find(charName);\n-                if (channel == -1) {\n-                    c.getPlayer().dropMessage(\"The player is not online.\");\n+                \n+                if(alliance.getGuilds().size() == alliance.getCapacity()) {\n+                    c.getPlayer().dropMessage(\"Your alliance can not comport any more guild at the moment.\");\n                 } else {\n-                    MapleCharacter victim = Server.getInstance().getChannel(c.getWorld(), channel).getPlayerStorage().getCharacterByName(charName);\n-                    if (victim.getGuildId() == 0) {\n-                        c.getPlayer().dropMessage(\"The person you are trying to invite does not have a guild.\");\n-                    } else if (victim.getGuildRank() != 1) {\n-                        c.getPlayer().dropMessage(\"The player is not the leader of his/her guild.\");\n+                    int channel;\n+                    channel = c.getWorldServer().find(charName);\n+                    if (channel == -1) {\n+                        c.getPlayer().dropMessage(\"The player is not online.\");\n                     } else {\n-                        Server.getInstance().allianceMessage(alliance.getId(), sendInvitation(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), slea.readMapleAsciiString()), -1, -1);\n+                        MapleCharacter victim = Server.getInstance().getChannel(c.getWorld(), channel).getPlayerStorage().getCharacterByName(charName);\n+                        if (victim.getGuildId() == 0) {\n+                            c.getPlayer().dropMessage(\"The person you are trying to invite does not have a guild.\");\n+                        } else if (victim.getGuildRank() != 1) {\n+                            c.getPlayer().dropMessage(\"The player is not the leader of his/her guild.\");\n+                        } else {\n+                            Server.getInstance().allianceMessage(alliance.getId(), sendInvitation(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), charName), -1, -1);\n+                        }\n                     }\n                 }\n+                \n                 break;\n             case 0x04: {\n+                System.out.print(\" case 4\");\n                 int guildid = slea.readInt();\n //                    slea.readMapleAsciiString();//guild name\n                 if (c.getPlayer().getGuild().getAllianceId() != 0 || c.getPlayer().getGuildRank() != 1 || c.getPlayer().getGuildId() < 1) {\n@@ -89,22 +110,36 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 break;\n             }\n             case 0x06: { // Expel Guild\n+                System.out.print(\" case 6\");\n                 int guildid = slea.readInt();\n                 int allianceid = slea.readInt();\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuild().getAllianceId() != allianceid) {\n                     return;\n                 }\n-                Server.getInstance().allianceMessage(alliance.getId(), sendChangeGuild(allianceid, c.getPlayer().getId(), guildid, 1), -1, -1);\n+                \n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.removeGuildFromAlliance(alliance, guildid, c), -1, -1);\n+                Server.getInstance().removeGuildFromAlliance(alliance.getId(), guildid);\n+                \n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, c), -1, -1);\n+                Server.getInstance().guildMessage(guildid, MaplePacketCreator.disbandAlliance(allianceid));\n+                \n+                \n                 break;\n             }\n             case 0x07: { // Change Alliance Leader\n+                System.out.print(\" case 7\");\n                 if (c.getPlayer().getGuild().getAllianceId() == 0 || c.getPlayer().getGuildId() < 1) {\n                     return;\n                 }\n-                Server.getInstance().allianceMessage(alliance.getId(), sendChangeLeader(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), slea.readInt()), -1, -1);\n+                int victimid = slea.readInt();\n+                MapleCharacter player = Server.getInstance().getWorld(c.getWorld()).getPlayerStorage().getCharacterById(victimid);\n+                \n+                //Server.getInstance().allianceMessage(alliance.getId(), sendChangeLeader(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), slea.readInt()), -1, -1);\n+                changeLeaderAllianceRank(alliance, player);\n                 break;\n             }\n             case 0x08:\n+                System.out.print(\" case 8\");\n                 String ranks[] = new String[5];\n                 for (int i = 0; i < 5; i++) {\n                     ranks[i] = slea.readMapleAsciiString();\n@@ -113,22 +148,53 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.changeAllianceRankTitle(alliance.getId(), ranks), -1, -1);\n                 break;\n             case 0x09: {\n+                System.out.print(\" case 9\");\n                 int int1 = slea.readInt();\n                 byte byte1 = slea.readByte();\n-                Server.getInstance().allianceMessage(alliance.getId(), sendChangeRank(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), int1, byte1), -1, -1);\n+                \n+                //Server.getInstance().allianceMessage(alliance.getId(), sendChangeRank(c.getPlayer().getGuild().getAllianceId(), c.getPlayer().getId(), int1, byte1), -1, -1);\n+                MapleCharacter player = Server.getInstance().getWorld(c.getWorld()).getPlayerStorage().getCharacterById(int1);\n+                changePlayerAllianceRank(alliance, player, (byte1 > 0));\n+                \n                 break;\n             }\n             case 0x0A:\n+                System.out.print(\" case A\");\n                 String notice = slea.readMapleAsciiString();\n                 Server.getInstance().setAllianceNotice(alliance.getId(), notice);\n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), notice), -1, -1);\n                 break;\n             default:\n                 c.getPlayer().dropMessage(\"Feature not available\");\n         }\n+        System.out.println(\"end\");\n         \n         alliance.saveToDB();\n     }\n+    \n+    private void changeLeaderAllianceRank(MapleAlliance alliance, MapleCharacter newLeader) {\n+        MapleGuildCharacter lmgc = alliance.getLeader();\n+        MapleCharacter leader = Server.getInstance().getWorld(newLeader.getWorld()).getPlayerStorage().getCharacterById(lmgc.getId());\n+        leader.setAllianceRank(2);\n+        leader.saveGuildStatus();\n+        \n+        newLeader.setAllianceRank(1);\n+        newLeader.saveGuildStatus();\n+        \n+        Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, newLeader.getClient()), -1, -1);\n+        alliance.dropAllianceMessage(\"'\" + newLeader.getName() + \"' has been appointed as the new head of this Alliance.\");\n+    }\n+    \n+    private void changePlayerAllianceRank(MapleAlliance alliance, MapleCharacter chr, boolean raise) {\n+        int newRank = chr.getAllianceRank() + (raise ? -1 : 1);\n+        if(newRank < 2 || newRank > 5) return;\n+        \n+        chr.setAllianceRank(newRank);\n+        chr.saveGuildStatus();\n+        \n+        Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.getGuildAlliances(alliance, chr.getClient()), -1, -1);\n+        alliance.dropAllianceMessage(\"'\" + chr.getName() + \"' has moved ranks to '\" + alliance.getRankTitle(newRank) + \"' in this Alliance.\");\n+    }\n \n     private static byte[] sendShowInfo(int allianceid, int playerid) {\n         MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();"}, {"sha": "6236aa2a2826966333161801567b83a1ddd68946", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -186,9 +186,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             MapleGuild playerGuild = server.getGuild(player.getGuildId(), player.getWorld(), player.getMGC());\n             if (playerGuild == null) {\n                 player.deleteGuild(player.getGuildId());\n-                player.resetMGC();\n+                player.resetMGC(null);\n                 player.setGuildId(0);\n             } else {\n+                playerGuild.getMGC(player.getId()).setCharacter(player);\n+                player.resetMGC(playerGuild.getMGC(player.getId()));\n                 server.setGuildMemberOnline(player.getMGC(), true, c.getChannel());\n                 c.announce(MaplePacketCreator.showGuildInfo(player));\n                 int allianceId = player.getGuild().getAllianceId();"}, {"sha": "bdcbe9362e49b69e858ff76ecca9fed617cca43e", "filename": "src/net/server/guild/MapleAlliance.java", "status": "modified", "additions": 219, "deletions": 105, "changes": 324, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleAlliance.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleAlliance.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleAlliance.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -27,207 +27,321 @@\n import java.sql.ResultSet;\n import java.util.LinkedList;\n import java.util.List;\n+\n+import client.MapleCharacter;\n+import net.server.Server;\n+import net.server.world.MapleParty;\n+import net.server.world.MaplePartyCharacter;\n+import net.server.guild.MapleGuild;\n+import net.server.guild.MapleGuildCharacter;\n import tools.DatabaseConnection;\n+import tools.MaplePacketCreator;\n \n /**\n  *\n- * @author XoticStory.\n+ * @author XoticStory, Ronan.\n  */\n public class MapleAlliance {\n-    private int[] guilds = new int[5];\n+    final private List<Integer> guilds = new LinkedList<>();\n+    \n     private int allianceId = -1;\n     private int capacity;\n     private String name;\n     private String notice = \"\";\n     private String rankTitles[] = new String[5];\n \n-    public MapleAlliance(String name, int id, int guild1, int guild2) {\n+    public MapleAlliance(String name, int id) {\n         this.name = name;\n         allianceId = id;\n-        int[] guild = {guild1, guild2, -1, -1, -1};\n         String[] ranks = {\"Master\", \"Jr.Master\", \"Member\", \"Member\", \"Member\"};\n         for (int i = 0; i < 5; i++) {\n-            guilds[i] = guild[i];\n             rankTitles[i] = ranks[i];\n         }\n     }\n+    \n+    public static boolean canBeUsedAllianceName(String name) {\n+        if (name.contains(\" \") || name.length() > 12) {\n+            return false;\n+        }\n+        try {\n+            ResultSet rs;\n+            try (PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"SELECT name FROM alliance WHERE name = ?\")) {\n+                ps.setString(1, name);\n+                rs = ps.executeQuery();\n+                if (rs.next()) {\n+                    ps.close();\n+                    rs.close();\n+                    return false;\n+                }\n+            }\n+            rs.close();\n+            return true;\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+            return false;\n+        }\n+    }\n+    \n+    private static List<MapleCharacter> getPartyGuildMasters(MapleParty party) {\n+        List<MapleCharacter> mcl = new LinkedList<>();\n+\n+        for(MaplePartyCharacter mpc: party.getMembers()) {\n+            if(mpc.getPlayer().getGuildRank() == 1 && mpc.getPlayer().getMapId() == party.getLeader().getPlayer().getMapId())\n+                mcl.add(mpc.getPlayer());\n+        }\n+\n+        if(!mcl.isEmpty() && !mcl.get(0).isPartyLeader()) {\n+            for(int i = 1; i < mcl.size(); i++) {\n+                if(mcl.get(i).isPartyLeader()) {\n+                    MapleCharacter temp = mcl.get(0);\n+                    mcl.set(0, mcl.get(i));\n+                    mcl.set(i, temp);\n+                }\n+            }\n+        }\n+\n+        return mcl;\n+    }\n+\n+    public static MapleAlliance createAlliance(MapleParty party, String name) {\n+        List<MapleCharacter> guildMasters = getPartyGuildMasters(party);\n+        if(guildMasters.size() != 2) return null;\n+\n+        List<Integer> guilds = new LinkedList<>();\n+        for(MapleCharacter mc: guildMasters) guilds.add(mc.getGuildId());\n+        MapleAlliance alliance = MapleAlliance.createAllianceOnDb(guilds, name);\n+        if(alliance != null) {\n+            alliance.setCapacity(guilds.size());\n+            for(Integer g: guilds)\n+                alliance.addGuild(g);\n+            \n+            int id = alliance.getId();\n+            try {\n+                for(int i = 0; i < guildMasters.size(); i++) {\n+                    Server.getInstance().setGuildAllianceId(guilds.get(i), id);\n+                    Server.getInstance().resetAllianceGuildPlayersRank(guilds.get(i));\n+\n+                    MapleCharacter chr = guildMasters.get(i);\n+                    chr.setAllianceRank((i == 0) ? 1 : 2);\n+                    chr.saveGuildStatus();\n+                }\n+\n+                Server.getInstance().addAlliance(id, alliance);\n+                Server.getInstance().allianceMessage(id, MaplePacketCreator.makeNewAlliance(alliance, guildMasters.get(0).getClient()), -1, -1);\n+            } catch (Exception e) {\n+                e.printStackTrace();\n+                return null;\n+            }\n+        }\n+\n+        return alliance;\n+    }\n+    \n+    public static MapleAlliance createAllianceOnDb(List<Integer> guilds, String name) {\n+        // will create an alliance, where the first guild listed is the leader and the alliance name MUST BE already checked for unicity.\n+        \n+        int id = -1;\n+        try {\n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"INSERT INTO `alliance` (`name`) VALUES (?)\", PreparedStatement.RETURN_GENERATED_KEYS);\n+            \n+            ps.setString(1, name);\n+            ps.executeUpdate();\n+            try (ResultSet rs = ps.getGeneratedKeys()) {\n+                rs.next();\n+                id = rs.getInt(1);\n+            }\n+            \n+            for(int i = 0; i < guilds.size(); i++) {\n+                int guild = guilds.get(i);\n+                \n+                ps = con.prepareStatement(\"INSERT INTO `allianceguilds` (`allianceid`, `guildid`) VALUES (?, ?)\");\n+                ps.setInt(1, id);\n+                ps.setInt(2, guild);\n+                ps.executeUpdate();\n+                ps.close();\n+            }\n+            \n+            ps.close();\n+            con.close();\n+            \n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+            return null;\n+        }\n+        \n+        return (new MapleAlliance(name, id));\n+    }\n \n     public static MapleAlliance loadAlliance(int id) {\n         if (id <= 0) {\n             return null;\n         }\n-        MapleAlliance alliance = new MapleAlliance(null, -1, -1, -1);\n+        MapleAlliance alliance = new MapleAlliance(null, -1);\n         try {\n-            PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"SELECT * FROM alliance WHERE id = ?\");\n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"SELECT * FROM alliance WHERE id = ?\");\n             ps.setInt(1, id);\n             ResultSet rs = ps.executeQuery();\n             if (!rs.next()) {\n                 rs.close();\n                 ps.close();\n+                con.close();\n                 return null;\n             }\n             alliance.allianceId = id;\n             alliance.capacity = rs.getInt(\"capacity\");\n             alliance.name = rs.getString(\"name\");\n             alliance.notice = rs.getString(\"notice\");\n-            for (int i = 1; i <= 5; i++) {\n-                alliance.rankTitles[i - 1] = rs.getString(\"rank_title\" + i);\n-            }\n-            for (int i = 1; i <= 5; i++) {\n-                alliance.guilds[i - 1] = rs.getInt(\"guild\" + i);\n+            \n+            ps.close();\n+            rs.close();\n+            \n+            ps = con.prepareStatement(\"SELECT * FROM allianceguilds WHERE allianceid = ?\");\n+            ps.setInt(1, id);\n+            rs = ps.executeQuery();\n+            \n+            while(rs.next()) {\n+                alliance.addGuild(rs.getInt(\"guildid\"));\n             }\n+            \n             ps.close();\n             rs.close();\n+            \n+            con.close();\n         } catch (SQLException e) {\n             e.printStackTrace();\n         }\n         return alliance;\n     }\n \n     public void saveToDB() {\n-        StringBuilder sb = new StringBuilder();\n-        sb.append(\"capacity = ?, \");\n-        sb.append(\"notice = ?, \");\n-        for (int i = 1; i <= 5; i++) {\n-            sb.append(\"rank_title\").append(i).append(\" = ?, \");\n-        }\n-        for (int i = 1; i <= 5; i++) {\n-            sb.append(\"guild\").append(i).append(\" = ?, \");\n-        }\n         try {\n-            PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"UPDATE `alliance` SET \" + sb.toString() + \" WHERE id = ?\");\n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"UPDATE `alliance` SET capacity = ?, notice = ? WHERE id = ?\");\n             ps.setInt(1, this.capacity);\n             ps.setString(2, this.notice);\n-            for (int i = 0; i < rankTitles.length; i++) {\n-                ps.setString(i + 3, rankTitles[i]);\n-            }\n-            for (int i = 0; i < guilds.length; i++) {\n-                ps.setInt(i + 8, guilds[i]);\n-            }\n-            ps.setInt(13, this.allianceId);\n-            ps.executeQuery();\n+            ps.setInt(3, this.allianceId);\n+            ps.executeUpdate();\n             ps.close();\n-        } catch (SQLException e) {\n-            e.printStackTrace();\n-        }\n-    }\n-\n-    public boolean addRemGuildFromDB(int gid, boolean add) {\n-        Connection con = DatabaseConnection.getConnection();\n-        boolean ret = false;\n-        try {\n-            PreparedStatement ps = con.prepareStatement(\"SELECT * FROM alliance WHERE id = ?\");\n+            \n+            ps = con.prepareStatement(\"DELETE FROM `allianceguilds` WHERE allianceid = ?\");\n             ps.setInt(1, this.allianceId);\n-            ResultSet rs = ps.executeQuery();\n-            if (rs.next()) {\n-                int avail = -1;\n-                for (int i = 1; i <= 5; i++) {\n-                    int guildId = rs.getInt(\"guild\" + i);\n-                    if (add) {\n-                        if (guildId == -1) {\n-                            avail = i;\n-                            break;\n-                        }\n-                    } else if (guildId == gid) {\n-                        avail = i;\n-                        break;\n-                    }\n-                }\n-                rs.close();\n-                if (avail != -1) { // empty slot\n-                    ps = con.prepareStatement(\"UPDATE alliance SET guild\" + avail + \" = ? WHERE id = ?\");\n-                    if (add) {\n-                        ps.setInt(1, gid);\n-                    } else {\n-                        ps.setInt(1, -1);\n-                    }\n-                    ps.setInt(2, this.allianceId);\n-                    ps.executeUpdate();\n-                    ret = true;\n-                }\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            for(int i = 0; i < guilds.size(); i++) {\n+                int guild = guilds.get(i);\n+                \n+                ps = con.prepareStatement(\"INSERT INTO `allianceguilds` (`allianceid`, `guildid`) VALUES (?, ?)\");\n+                ps.setInt(1, this.allianceId);\n+                ps.setInt(2, guild);\n+                ps.executeUpdate();\n                 ps.close();\n             }\n+            \n+            con.close();\n         } catch (SQLException e) {\n             e.printStackTrace();\n         }\n-        return ret;\n     }\n-\n+    \n     public boolean removeGuild(int gid) {\n         synchronized (guilds) {\n-            int gIndex = getGuildIndex(gid);\n-            if (gIndex != -1) {\n-                guilds[gIndex] = -1;\n-            }\n-            return addRemGuildFromDB(gid, false);\n+            int index = getGuildIndex(gid);\n+            if(index == -1) return false;\n+            \n+            guilds.remove(index);\n+            return true;\n         }\n     }\n \n     public boolean addGuild(int gid) {\n         synchronized (guilds) {\n-            if (getGuildIndex(gid) == -1) {\n-                int emptyIndex = getGuildIndex(-1);\n-                if (emptyIndex != -1) {\n-                    guilds[emptyIndex] = gid;\n-                    return addRemGuildFromDB(gid, true);\n-                }\n-            }\n+            if(guilds.size() == capacity || getGuildIndex(gid) > -1) return false;\n+            guilds.add(gid);\n         }\n-        return false;\n+        return true;\n     }\n \n     private int getGuildIndex(int gid) {\n-        for (int i = 0; i < guilds.length; i++) {\n-            if (guilds[i] == gid) {\n+        for (int i = 0; i < guilds.size(); i++) {\n+            if (guilds.get(i) == gid) {\n                 return i;\n             }\n         }\n         return -1;\n     }\n-\n+    \n     public void setRankTitle(String[] ranks) {\n         rankTitles = ranks;\n     }\n \n-    public void setNotice(String notice) {\n-        this.notice = notice;\n-    }\n-\n-    public int getId() {\n-        return allianceId;\n-    }\n-\n-    public String getName() {\n-        return name;\n-    }\n-\n     public String getRankTitle(int rank) {\n         return rankTitles[rank - 1];\n     }\n-\n-    public String getAllianceNotice() {\n-        return notice;\n-    }\n-\n+    \n     public List<Integer> getGuilds() {\n-        List<Integer> guilds_ = new LinkedList<Integer>();\n+        List<Integer> guilds_ = new LinkedList<>();\n         for (int guild : guilds) {\n             if (guild != -1) {\n                 guilds_.add(guild);\n             }\n         }\n         return guilds_;\n     }\n+    \n+    public String getAllianceNotice() {\n+        return notice;\n+    }\n \n     public String getNotice() {\n         return notice;\n     }\n+    \n+    public void setNotice(String notice) {\n+        this.notice = notice;\n+    }\n \n     public void increaseCapacity(int inc) {\n-        capacity += inc;\n+        this.capacity += inc;\n     }\n \n+    public void setCapacity(int newCapacity) {\n+        this.capacity = newCapacity;\n+    }\n+    \n     public int getCapacity() {\n-        return capacity;\n+        return this.capacity;\n+    }\n+    \n+    public int getId() {\n+        return allianceId;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+    \n+    public MapleGuildCharacter getLeader() {\n+        for(Integer gId: guilds) {\n+            MapleGuild guild = Server.getInstance().getGuild(gId);\n+            MapleGuildCharacter mgc = guild.getMGC(guild.getLeaderId());\n+            \n+            if(mgc.getAllianceRank() == 1) return mgc;\n+        }\n+        \n+        return null;\n+    }\n+    \n+    public void dropAllianceMessage(String message) {\n+        dropAllianceMessage(5, message);\n+    }\n+    \n+    public void dropAllianceMessage(int type, String message) {\n+        for(Integer gId: guilds) {\n+            MapleGuild guild = Server.getInstance().getGuild(gId);\n+            guild.dropGuildMessage(type, message);\n+        }\n     }\n }"}, {"sha": "6cd04b04d6696e38c9d0b0b49e7146ab3d056e25", "filename": "src/net/server/guild/MapleGuild.java", "status": "modified", "additions": 29, "deletions": 8, "changes": 37, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleGuild.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleGuild.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuild.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -37,7 +37,6 @@\n \n import net.server.Server;\n import net.server.channel.Channel;\n-import tools.LogHelper;\n import tools.DatabaseConnection;\n import tools.MaplePacketCreator;\n \n@@ -46,7 +45,7 @@\n     public final static int CHANGE_EMBLEM_COST = 5000000;\n \n     private enum BCOp {\n-        NONE, DISBAND, EMBELMCHANGE\n+        NONE, DISBAND, EMBLEMCHANGE\n     }\n     private List<MapleGuildCharacter> members;\n     private String rankTitles[] = new String[5]; // 1 = master, 2 = jr, 5 = lowest member\n@@ -56,8 +55,6 @@\n     private Map<Integer, List<Integer>> notifications = new LinkedHashMap<>();\n     private boolean bDirty = true;\n \n-\n-\t\n     public MapleGuild(int guildid, int world) {\n         this.world = world;\n         members = new ArrayList<>();\n@@ -97,14 +94,14 @@ public MapleGuild(int guildid, int world) {\n                 return;\n             }\n             do {\n-                members.add(new MapleGuildCharacter(rs.getInt(\"id\"), rs.getInt(\"level\"), rs.getString(\"name\"), (byte) -1, world, rs.getInt(\"job\"), rs.getInt(\"guildrank\"), guildid, false, rs.getInt(\"allianceRank\")));\n+                members.add(new MapleGuildCharacter(null, rs.getInt(\"id\"), rs.getInt(\"level\"), rs.getString(\"name\"), (byte) -1, world, rs.getInt(\"job\"), rs.getInt(\"guildrank\"), guildid, false, rs.getInt(\"allianceRank\")));\n             } while (rs.next());\n             \n             ps.close();\n             rs.close();\n         } catch (SQLException se) {\n             se.printStackTrace();\n-            System.out.println(\"unable to read guild information from sql\" + se);\n+            System.out.println(\"Unable to read guild information from sql\" + se);\n         }\n     }\n \n@@ -261,7 +258,7 @@ public void broadcast(final byte[] packet, int exceptionId, BCOp bcop) {\n                     if (notifications.get(b).size() > 0) {\n                         if (bcop == BCOp.DISBAND) {\n                             Server.getInstance().getWorld(world).setGuildAndRank(notifications.get(b), 0, 5, exceptionId);\n-                        } else if (bcop == BCOp.EMBELMCHANGE) {\n+                        } else if (bcop == BCOp.EMBLEMCHANGE) {\n                             Server.getInstance().getWorld(world).changeEmblem(this.id, notifications.get(b), new MapleGuildSummary(this));\n                         } else {\n                             Server.getInstance().getWorld(world).sendPacket(notifications.get(b), packet, exceptionId);\n@@ -285,6 +282,16 @@ public void guildMessage(final byte[] serverNotice) {\n             }\n         }\n     }\n+    \n+    public void dropGuildMessage(String message) {\n+        dropGuildMessage(5, message);\n+    }\n+    \n+    public void dropGuildMessage(int type, String message) {\n+        for (MapleGuildCharacter mgc : members) {\n+            mgc.getCharacter().dropMessage(type, message);\n+        }\n+    }\n \n     public final void setOnline(int cid, boolean online, int channel) {\n         boolean bBroadcast = true;\n@@ -480,7 +487,7 @@ public void setGuildEmblem(short bg, byte bgcolor, short logo, byte logocolor) {\n         this.logo = logo;\n         this.logoColor = logocolor;\n         this.writeToDB(false);\n-        this.broadcast(null, -1, BCOp.EMBELMCHANGE);\n+        this.broadcast(null, -1, BCOp.EMBLEMCHANGE);\n     }\n \n     public MapleGuildCharacter getMGC(int cid) {\n@@ -557,6 +564,20 @@ public void setAllianceId(int aid) {\n             e.printStackTrace();\n         }\n     }\n+    \n+    public void resetAllianceGuildPlayersRank() {\n+        try {\n+            for(MapleGuildCharacter mgc: members) mgc.setAllianceRank(5);\n+            \n+            try (PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"UPDATE characters SET allianceRank = ? WHERE guildid = ?\")) {\n+                ps.setInt(1, 5);\n+                ps.setInt(2, id);\n+                ps.executeUpdate();\n+            }\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+        }\n+    }\n \n     public int getIncreaseGuildCost(int size) {\n         return 500000 * (size - 6) / 6;"}, {"sha": "e38e04eae502d19a2491cb99acf472ba7b68f7ea", "filename": "src/net/server/guild/MapleGuildCharacter.java", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleGuildCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/guild/MapleGuildCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleGuildCharacter.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -24,6 +24,7 @@\n import client.MapleCharacter;\n \n public class MapleGuildCharacter {\n+    private MapleCharacter character;\n     private int level;\n     private int id;\n     private int world, channel;\n@@ -35,6 +36,7 @@\n     private String name;\n \n     public MapleGuildCharacter(MapleCharacter c) {\n+        this.character = c;\n         this.name = c.getName();\n         this.level = c.getLevel();\n         this.id = c.getId();\n@@ -47,7 +49,8 @@ public MapleGuildCharacter(MapleCharacter c) {\n         this.allianceRank = c.getAllianceRank();\n     }\n \n-    public MapleGuildCharacter(int _id, int _lv, String _name, int _channel, int _world, int _job, int _rank, int _gid, boolean _on, int _allianceRank) {\n+    public MapleGuildCharacter(MapleCharacter c, int _id, int _lv, String _name, int _channel, int _world, int _job, int _rank, int _gid, boolean _on, int _allianceRank) {\n+        this.character = c;\n         this.level = _lv;\n         this.id = _id;\n         this.name = _name;\n@@ -61,6 +64,14 @@ public MapleGuildCharacter(int _id, int _lv, String _name, int _channel, int _wo\n         this.guildid = _gid;\n         this.allianceRank = _allianceRank;\n     }\n+    \n+    public void setCharacter(MapleCharacter ch) {\n+        this.character = ch;\n+    }\n+    \n+    public MapleCharacter getCharacter() {\n+        return character;\n+    }\n \n     public int getLevel() {\n         return level;"}, {"sha": "5b21549a7751e802e2341f05daabecc4bb54c33b", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -152,6 +152,16 @@ public void setMesoRate(int meso) {\n     public int getBossDropRate() {\n         return bossdroprate;\n     }\n+    \n+    public void setBossDropRate(int bossdrop) {\n+        for(MapleCharacter chr : getPlayerStorage().getAllCharacters()) {\n+            chr.revertRates(false);\n+\t}\n+        this.bossdroprate = bossdrop;\n+        for(MapleCharacter chr : getPlayerStorage().getAllCharacters()) {\n+            chr.setRates();\n+        }\n+    }\n \n     public PlayerStorage getPlayerStorage() {\n         return players;"}, {"sha": "26a1979b8e366e0dfe0aaa7ffb76c2d7c4f308ef", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 16, "deletions": 56, "changes": 72, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -25,6 +25,8 @@\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n+import java.util.List;\n+import java.util.LinkedList;\n \n import net.server.Server;\n import net.server.guild.MapleAlliance;\n@@ -344,6 +346,11 @@ public void doGachapon() {\n \t\t\tServer.getInstance().broadcastMessage(MaplePacketCreator.gachaponMessage(itemGained, map, getPlayer()));\n \t\t}\n \t}\n+        \n+        public void upgradeAlliance() {\n+                MapleAlliance alliance = Server.getInstance().getAlliance(c.getPlayer().getGuild().getAllianceId());\n+                alliance.increaseCapacity(1);\n+        }\n \n \tpublic void disbandAlliance(MapleClient c, int allianceId) {\n \t\tPreparedStatement ps = null;\n@@ -368,63 +375,16 @@ public void disbandAlliance(MapleClient c, int allianceId) {\n \t}\n \n \tpublic boolean canBeUsedAllianceName(String name) {\n-\t\tif (name.contains(\" \") || name.length() > 12) {\n-\t\t\treturn false;\n-\t\t}\n-\t\ttry {\n-\t\t\tResultSet rs;\n-\t\t\ttry (PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"SELECT name FROM alliance WHERE name = ?\")) {\n-\t\t\t\tps.setString(1, name);\n-\t\t\t\trs = ps.executeQuery();\n-\t\t\t\tif (rs.next()) {\n-\t\t\t\t\tps.close();\n-\t\t\t\t\trs.close();\n-\t\t\t\t\treturn false;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\trs.close();\n-\t\t\treturn true;\n-\t\t} catch (SQLException e) {\n-\t\t\te.printStackTrace();\n-\t\t\treturn false;\n-\t\t}\n-\t}\n-\n-\tpublic static MapleAlliance createAlliance(MapleCharacter chr1, MapleCharacter chr2, String name) {\n-\t\tint id;\n-\t\tint guild1 = chr1.getGuildId();\n-\t\tint guild2 = chr2.getGuildId();\n-\t\ttry {\n-\t\t\ttry (PreparedStatement ps = DatabaseConnection.getConnection().prepareStatement(\"INSERT INTO `alliance` (`name`, `guild1`, `guild2`) VALUES (?, ?, ?)\", PreparedStatement.RETURN_GENERATED_KEYS)) {\n-\t\t\t\tps.setString(1, name);\n-\t\t\t\tps.setInt(2, guild1);\n-\t\t\t\tps.setInt(3, guild2);\n-\t\t\t\tps.executeUpdate();\n-\t\t\t\ttry (ResultSet rs = ps.getGeneratedKeys()) {\n-\t\t\t\t\trs.next();\n-\t\t\t\t\tid = rs.getInt(1);\n-\t\t\t\t}\n-\t\t\t}\n-\t\t} catch (SQLException e) {\n-\t\t\te.printStackTrace();\n-\t\t\treturn null;\n-\t\t}\n-\t\tMapleAlliance alliance = new MapleAlliance(name, id, guild1, guild2);\n-\t\ttry {\n-\t\t\tServer.getInstance().setGuildAllianceId(guild1, id);\n-\t\t\tServer.getInstance().setGuildAllianceId(guild2, id);\n-\t\t\tchr1.setAllianceRank(1);\n-\t\t\tchr1.saveGuildStatus();\n-\t\t\tchr2.setAllianceRank(2);\n-\t\t\tchr2.saveGuildStatus();\n-\t\t\tServer.getInstance().addAlliance(id, alliance);\n-\t\t\tServer.getInstance().allianceMessage(id, MaplePacketCreator.makeNewAlliance(alliance, chr1.getClient()), -1, -1);\n-\t\t} catch (Exception e) {\n-                        e.printStackTrace();\n-\t\t\treturn null;\n-\t\t}\n-\t\treturn alliance;\n+                return MapleAlliance.canBeUsedAllianceName(name);\n \t}\n+        \n+        public MapleAlliance createAlliance(String name) {\n+            return MapleAlliance.createAlliance(getParty(), name);\n+        }\n+        \n+        public int getAllianceCapacity() {\n+                return Server.getInstance().getAlliance(getPlayer().getGuild().getAllianceId()).getCapacity();\n+        }\n \n \tpublic boolean hasMerchant() {\n \t\treturn getPlayer().hasMerchant();"}, {"sha": "70b54af6109ef22154c814ba9ddd1163e6a1e60a", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -5891,6 +5891,7 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                         mplew.writeInt(mgc.isOnline() ? 1 : 0);\n                         mplew.writeInt(guild.getSignature());\n                         mplew.writeInt(mgc.getAllianceRank());\n+                        System.out.println(\"alliance rank found \" + mgc.getAllianceRank());\n                 }\n                 mplew.writeInt(guild.getCapacity());\n                 mplew.writeShort(guild.getLogoBG());"}, {"sha": "32654769508e69d91fd3234747ed118db5908cef", "filename": "todo.txt", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/a636f63114d5a30c94b92963e6a2e2cb83f47563/todo.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/a636f63114d5a30c94b92963e6a2e2cb83f47563/todo.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/todo.txt?ref=a636f63114d5a30c94b92963e6a2e2cb83f47563", "patch": "@@ -1,3 +1,2 @@\n guild npc\n-PQs\n-scrolls for weather resistance\n\\ No newline at end of file\n+PQs\n\\ No newline at end of file"}]}]},
