{"fetchDate": "2019-12-19", "content": [{"sha": "73557f0d61364d4ac85e02f9ff5d945b321f10c2", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NzM1NTdmMGQ2MTM2NGQ0YWM4NWUwMmY5ZmY1ZDk0NWIzMjFmMTBjMg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-09T23:02:10Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-05-09T23:02:10Z"}, "message": "More PQ-esque script modules + HP Bar on some bosses\n\nCompleted (hopefully, now!) implementation of automated modules for PQ\nscripting. Added HP bar for some bosses that wouldn't display it before\n(like King Slime, Alishar and CRog).", "tree": {"sha": "df0ba243d2c6d932bddf4036a0e907dcc19795da", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/df0ba243d2c6d932bddf4036a0e907dcc19795da"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/73557f0d61364d4ac85e02f9ff5d945b321f10c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/73557f0d61364d4ac85e02f9ff5d945b321f10c2", "html_url": "https://github.com/ronancpl/HeavenMS/commit/73557f0d61364d4ac85e02f9ff5d945b321f10c2", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/73557f0d61364d4ac85e02f9ff5d945b321f10c2/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da00345aec775bb2a58ef8b9757b89d21e938044", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/da00345aec775bb2a58ef8b9757b89d21e938044", "html_url": "https://github.com/ronancpl/HeavenMS/commit/da00345aec775bb2a58ef8b9757b89d21e938044"}], "stats": {"total": 1529, "additions": 932, "deletions": 597}, "files": [{"sha": "1d0962566ae07c4548d52fbd8f99a06a92152684", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -200,4 +200,11 @@ Reimplementa\n Para quests que podem ser repetidas, adi\ufffd\ufffdo de mensagem mencionando o tempo restante para recome\ufffd\ufffd-la.\n \n 04 - 05 Maio 2017,\n-Finaliza\ufffd\ufffdo da reimplementa\ufffd\ufffdo da Kerning PQ, com adi\ufffd\ufffdo de novos mecanismos esperados em eventos/PQs.\n\\ No newline at end of file\n+Corre\ufffd\ufffdo de bug no sistema de keybinding em casos onde certas mecanicas de jogo e itens n\ufffdo eram salvos devido a ids conflituosos com certas skills.\n+Finaliza\ufffd\ufffdo da reimplementa\ufffd\ufffdo da Kerning PQ, com adi\ufffd\ufffdo de novos mecanismos esperados em eventos/PQs.\n+Adi\ufffd\ufffdo de barra de HP para bosses King Slime, Alishar e Snack Bar.\n+\n+08 Maio 2017,\n+Adi\ufffd\ufffdo de funcionalidade para PQs/eventos: ao sair de evento, remove-se todos os itens listados como exclusivo para evento.\n+Diversas corre\ufffd\ufffdes em mec\ufffdnicas das PQs/eventos.\n+Sistema de lobbys para PQs agora. \ufffd poss\ufffdvel instanciar mais de uma PQ em um mesmo channel.\n\\ No newline at end of file"}, {"sha": "5d37a0d8aec230df7106d285294df7cd53092ce0", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -3,14 +3,15 @@\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"0\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq3.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq4.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq1.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9020001.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/Ellin.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2094000.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/BossRushPQ.js</file>\n             <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/event/EventInstanceManager.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq2.js</file>\n             <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/KerningPQ.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/portal/kpq0.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9000037.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/9020000.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/PiratePQ.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/world0/2133000.js</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "9c949b2b23a9c6816161acbdf56338b6703f9d48", "filename": "scripts/event/BossRushPQ.js", "status": "modified", "additions": 53, "deletions": 32, "changes": 85, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/BossRushPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/BossRushPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BossRushPQ.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6,32 +6,56 @@ var exitMap = 970030000;\n var recruitMap = 970030000;\n var clearMap = 970030000;\n \n+var minMapId = 970030001;\n+var maxMapId = 970042711;\n+\n+var lobbyRange = [0, 7];\n+\n function init() {\n-        em.setProperty(\"state\", \"0\");\n-\tem.setProperty(\"leader\", \"true\");\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n }\n \n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {}\n+\n function setEventRewards(eim) {\n         var itemSet, itemQty, evLevel;\n \n         evLevel = 6;    //Rewards at event completion\n-        itemSet = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046, 2330004, 2041013, 2041016, 2041019, 2041022, 2049100, 2049003, 2020012, 2020013, 2020014, 2020015, 2022029, 2022045, 2022068, 2022069, 2022179, 2022180, 4004000, 4004001, 4004002, 4004003, 4004004, 4003000];\n+        itemSet = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046, 2330004, 2041013, 2041016, 2041019, 2041022, 2049100, 2049003, 2020012, 2020013, 2020014, 2020015, 2022029, 2022045, 2022068, 2022069, 2022180, 2022179, 4004000, 4004001, 4004002, 4004003, 4004004, 4003000];\n         itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 25, 25, 25, 25, 25, 25, 25, 25, 4, 4, 12, 12, 12, 12, 12, 25];\n         eim.setEventRewards(evLevel, itemSet, itemQty);\n \n         evLevel = 5;    //Rewards at Rest Spot V\n-        itemSet = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046, 2330004, 2041013, 2041016, 2041019, 2041022, 2049100, 2049003, 2020012, 2020013, 2020014, 2020015, 2022029, 2022045, 2022068, 2022069, 2022179, 2022180, 4004000, 4004001, 4004002, 4004003, 4004004, 4003000];\n-        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 15, 15, 15, 15, 15, 15, 15, 15, 15, 2, 8, 8, 8, 8, 8, 12];\n+        itemSet = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046, 2330004, 2041013, 2041016, 2041019, 2041022, 2049100, 2049003, 2020012, 2020013, 2020014, 2020015, 2022029, 2022045, 2022068, 2022069, 2022180, 2022179, 4004000, 4004001, 4004002, 4004003, 4004004, 4003000];\n+        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 15, 15, 15, 15, 15, 15, 15, 15, 2, 2, 8, 8, 8, 8, 8, 12];\n         eim.setEventRewards(evLevel, itemSet, itemQty);\n         \n         evLevel = 4;    //Rewards at Rest Spot IV\n         itemSet = [1122001, 1122006, 1022103, 1442065, 1032042, 1032021, 1102168, 2070005, 2040025, 2040029, 2040301, 2040413, 2040701, 2040817, 2002028, 2020009, 2020010, 2020011, 2022004, 2022005, 2022025, 2022027, 2022048, 2022049, 4020000, 4020001, 4020002, 4020003, 4020004, 4020005, 4020006, 4020007, 4020008, 4003000];\n-        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8];\n+        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 45, 45, 45, 45, 45, 45, 45, 45, 45, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8];\n         eim.setEventRewards(evLevel, itemSet, itemQty);\n         \n         evLevel = 3;    //Rewards at Rest Spot III\n         itemSet = [1122002, 1022088, 1012076, 1402029, 1032041, 1032044, 1102167, 2070011, 2040026, 2040030, 2040302, 2040412, 2040702, 2040818, 2002028, 2020009, 2020010, 2020011, 2022004, 2022005, 2022025, 2022027, 2022048, 2022049, 4010000, 4010001, 4010002, 4010003, 4010004, 4010005, 4010006, 4010007, 4003000];\n-        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 5, 5, 5, 5, 5, 5, 5, 5, 5];\n+        itemQty = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 20, 20, 20, 20, 20, 20, 20, 20, 20, 5, 5, 5, 5, 5, 5, 5, 5, 5];\n         eim.setEventRewards(evLevel, itemSet, itemQty);\n         \n         evLevel = 2;    //Rewards at Rest Spot II\n@@ -50,36 +74,35 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n         var hasLeader = false;\n         \n         if(party.size() > 0) {\n-            var partyList = party.toArray();\n-            \n-            for(var i = 0; i < party.size(); i++) {\n-                var ch = partyList[i];\n-            \n-                if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n-                        if(ch.isLeader()) hasLeader = true;\n-                        eligible.push(ch);\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n                 }\n-            }\n         }\n         \n         if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n         return eligible;\n }\n \n-function setup(level, leaderid) {\n-        em.setProperty(\"state\", \"1\");\n-\tem.setProperty(\"leader\", \"true\");\n-        \n-        var eim = em.newInstance(\"BossRush\" + leaderid);\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"BossRush\" + lobbyid);\n         eim.setProperty(\"level\", level);\n+        eim.setProperty(\"lobby\", lobbyid);\n         \n         eim.startEventTimer(45 * 60000); //45 mins\n         setEventRewards(eim);\n+        setEventExclusives(eim);\n         return eim;\n }\n \n function playerEntry(eim, player) {\n-        var map = eim.getMapInstance(entryMap);\n+        var map = eim.getMapInstance(entryMap + eim.getIntProperty(\"lobby\"));\n         player.changeMap(map, map.getPortal(0));\n }\n \n@@ -93,7 +116,7 @@ function playerExit(eim, player) {\n }\n \n function changedMap(eim, player, mapid) {\n-        if (mapid < 970030001 || mapid > 970042711) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n@@ -103,6 +126,13 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n@@ -143,26 +173,17 @@ function end(eim) {\n                 playerExit(eim, party.get(i));\n         }\n         eim.dispose();\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n function clearPQ(eim) {\n         eim.stopEventTimer();\n         eim.setEventCleared();      // from now on event just finishes when ALL players gets out of the range defined inside changedMap function.\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n function giveRandomEventReward(eim, player) {\n         eim.giveEventReward(player);\n }\n \n-function reopenEvent() {\n-        em.setProperty(\"state\", \"0\");\n-        em.setProperty(\"leader\", \"true\");\n-}\n-\n function monsterKilled(mob, eim) {}\n \n function allMonstersDead(eim) {}"}, {"sha": "b1610d5605a80800cd6e203196d75a33fe5c7bb5", "filename": "scripts/event/Ellin.js", "status": "modified", "additions": 58, "deletions": 28, "changes": 86, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/Ellin.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/Ellin.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Ellin.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,42 +1,70 @@\n var isPq = true;\n-var minPlayers = 1, maxPlayers = 6;\n-var minLevel = 1, maxLevel = 200;\n+var minPlayers = 4, maxPlayers = 6;\n+var minLevel = 44, maxLevel = 55;\n var entryMap = 930000000;\n var exitMap = 930000800;\n var recruitMap = 300030100;\n var clearMap = 930000800;\n \n+var minMapId = 930000000;\n+var maxMapId = 930000800;\n+\n+var lobbyRange = [0, 0];\n+\n function init() {\n-        em.setProperty(\"state\", \"0\");\n-\tem.setProperty(\"leader\", \"true\");\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    For #radventurers only#k.\";\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [4001162, 4001163, 4001169, 2270004];\n+        eim.setExclusiveItems(itemSet);\n }\n \n+function setEventRewards(eim) {}\n+\n function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n         var eligible = [];\n         var hasLeader = false;\n         \n         if(party.size() > 0) {\n-            var partyList = party.toArray();\n-            \n-            for(var i = 0; i < party.size(); i++) {\n-                var ch = partyList[i];\n-            \n-                if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel && ch.getJob().getId() / 1000 == 0) {  //only adventurers\n-                        if(ch.isLeader()) hasLeader = true;\n-                        eligible.push(ch);\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel && Math.floor(ch.getJob().getId() / 1000) == 0) {  //only adventurers\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n                 }\n-            }\n         }\n         \n         if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n         return eligible;\n }\n \n-function setup(level, leaderid) {\n-        em.setProperty(\"state\", \"1\");\n-\tem.setProperty(\"leader\", \"true\");\n-        \n-        var eim = em.newInstance(\"Ellin\" + leaderid);\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Ellin\" + lobbyid);\n         eim.setProperty(\"level\", level);\n         \n         eim.setInstanceMap(930000000).resetPQ(level);\n@@ -51,7 +79,10 @@ function setup(level, leaderid) {\n \teim.setInstanceMap(930000700).resetPQ(level);\n \n         respawnStg2(eim);\n+        \n         eim.startEventTimer(30 * 60000); //30 mins\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n         return eim;\n }\n \n@@ -61,7 +92,7 @@ function respawnStg2(eim) {\n }\n \n function changedMap(eim, player, mapid) {\n-        if (mapid < 930000000 || mapid > 930000800) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n@@ -71,6 +102,13 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n function playerEntry(eim, player) {\n         var map = eim.getMapInstance(entryMap);\n         player.changeMap(map, map.getPortal(0));\n@@ -125,21 +163,13 @@ function end(eim) {\n                 playerExit(eim, party.get(i));\n         }\n         eim.dispose();\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n function clearPQ(eim) {\n         eim.stopEventTimer();\n         eim.setEventCleared();\n-        eim.warpEventTeam(toMap);\n         \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n-}\n-\n-function reopenEvent() {\n-        em.setProperty(\"state\", \"0\");\n-        em.setProperty(\"leader\", \"true\");\n+        eim.warpEventTeam(930000800);\n }\n \n function monsterKilled(mob, eim) {}"}, {"sha": "4fba2f5dca58c35b2ea9b34bce9a250dd1f91ecc", "filename": "scripts/event/KerningPQ.js", "status": "modified", "additions": 55, "deletions": 31, "changes": 86, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/KerningPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/KerningPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KerningPQ.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,14 +1,41 @@\n var isPq = true;\n-var minPlayers = 1, maxPlayers = 6;\n-var minLevel = 1, maxLevel = 200;\n+var minPlayers = 4, maxPlayers = 6;\n+var minLevel = 21, maxLevel = 30;\n var entryMap = 103000800;\n var exitMap = 103000890;\n var recruitMap = 103000000;\n var clearMap = 103000805;\n \n+var minMapId = 103000800;\n+var maxMapId = 103000805;\n+\n+var lobbyRange = [0, 0];\n+\n function init() {\n-        em.setProperty(\"state\", \"0\");\n-\tem.setProperty(\"leader\", \"true\");\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        em.setProperty(\"party\", reqStr);\n+}\n+\n+function setEventExclusives(eim) {\n+        var itemSet = [4001007, 4001008];\n+        eim.setExclusiveItems(itemSet);\n }\n \n function setEventRewards(eim) {\n@@ -28,38 +55,37 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n         var hasLeader = false;\n         \n         if(party.size() > 0) {\n-            var partyList = party.toArray();\n-            \n-            for(var i = 0; i < party.size(); i++) {\n-                var ch = partyList[i];\n-            \n-                if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n-                        if(ch.isLeader()) hasLeader = true;\n-                        eligible.push(ch);\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n                 }\n-            }\n         }\n         \n         if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n         return eligible;\n }\n \n-function setup(level, leaderid) {\n-        em.setProperty(\"state\", \"1\");\n-\tem.setProperty(\"leader\", \"true\");\n-        \n-        var eim = em.newInstance(\"Kerning\" + leaderid);\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Kerning\" + lobbyid);\n         eim.setProperty(\"level\", level);\n         \n-        respawnStg1(eim);\n+        respawnStages(eim);\n         eim.startEventTimer(30 * 60000); //30 mins\n         setEventRewards(eim);\n+        setEventExclusives(eim);\n         return eim;\n }\n \n-function respawnStg1(eim) {    \n+function respawnStages(eim) {    \n         eim.getMapInstance(103000800).instanceMapRespawn();\n-        eim.schedule(\"respawnStg1\", 10 * 1000);\n+        eim.getMapInstance(103000805).instanceMapRespawn();\n+        eim.schedule(\"respawnStages\", 10 * 1000);\n }\n \n function playerEntry(eim, player) {\n@@ -77,7 +103,7 @@ function playerExit(eim, player) {\n }\n \n function changedMap(eim, player, mapid) {\n-        if (mapid < 103000800 || mapid > 103000805) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n@@ -87,6 +113,13 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n@@ -130,8 +163,6 @@ function end(eim) {\n                 playerExit(eim, party.get(i));\n         }\n         eim.dispose();\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n function giveRandomEventReward(eim, player) {\n@@ -141,13 +172,6 @@ function giveRandomEventReward(eim, player) {\n function clearPQ(eim) {\n         eim.stopEventTimer();\n         eim.setEventCleared();\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n-}\n-\n-function reopenEvent() {\n-        em.setProperty(\"state\", \"0\");\n-        em.setProperty(\"leader\", \"true\");\n }\n \n function monsterKilled(mob, eim) {}"}, {"sha": "de515b02fd501c75c3030dae7f813979b48864d1", "filename": "scripts/event/PiratePQ.js", "status": "modified", "additions": 70, "deletions": 37, "changes": 107, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/PiratePQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/event/PiratePQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PiratePQ.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,53 +1,79 @@\n var isPq = true;\n-var minPlayers = 1, maxPlayers = 6;\n-var minLevel = 1, maxLevel = 200;\n+var minPlayers = 3, maxPlayers = 6;\n+var minLevel = 55, maxLevel = 100;\n var entryMap = 925100000;\n var exitMap = 925100700;\n var recruitMap = 251010404;\n var clearMap = 925100600;\n \n+var minMapId = 925100000;\n+var maxMapId = 925100500;\n+\n+var lobbyRange = [0, 0];\n+\n function init() {\n-        em.setProperty(\"state\", \"0\");\n-\tem.setProperty(\"leader\", \"true\");\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n+}\n+\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        em.setProperty(\"party\", reqStr);\n }\n \n+function setEventExclusives(eim) {\n+        var itemSet = [4001117, 4001120, 4001121, 4001122];\n+        eim.setExclusiveItems(itemSet);\n+}\n+\n+function setEventRewards(eim) {}\n+\n function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n         var eligible = [];\n         var hasLeader = false;\n         \n         if(party.size() > 0) {\n-            var partyList = party.toArray();\n-            \n-            for(var i = 0; i < party.size(); i++) {\n-                var ch = partyList[i];\n-            \n-                if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n-                        if(ch.isLeader()) hasLeader = true;\n-                        eligible.push(ch);\n+                var partyList = party.toArray();\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n                 }\n-            }\n         }\n         \n         if(!(hasLeader && eligible.length >= minPlayers && eligible.length <= maxPlayers)) eligible = [];\n         return eligible;\n }\n \n-function setup(level, leaderid) {\n-        em.setProperty(\"state\", \"1\");\n-\tem.setProperty(\"leader\", \"true\");\n-        \n-        var eim = em.newInstance(\"Pirate\" + leaderid);\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Pirate\" + lobbyid);\n         eim.setProperty(\"level\", level);\n         \n-\tem.setProperty(\"stage2\", \"0\");\n-        em.setProperty(\"stage2a\", \"0\");\n-\tem.setProperty(\"stage3a\", \"0\");\n-        em.setProperty(\"stage2b\", \"0\");\n-\tem.setProperty(\"stage3b\", \"0\");\n-\tem.setProperty(\"stage4\", \"0\");\n-\tem.setProperty(\"stage5\", \"0\");\n+\teim.setProperty(\"stage2\", \"0\");\n+        eim.setProperty(\"stage2a\", \"0\");\n+\teim.setProperty(\"stage3a\", \"0\");\n+        eim.setProperty(\"stage2b\", \"0\");\n+\teim.setProperty(\"stage3b\", \"0\");\n+\teim.setProperty(\"stage4\", \"0\");\n+\teim.setProperty(\"stage5\", \"0\");\n         \n-        em.setProperty(\"openedChests\", \"0\");\n+        eim.setProperty(\"openedChests\", \"0\");\n         eim.setInstanceMap(925100000).resetPQ(level);\n         eim.setInstanceMap(925100000).shuffleReactors();\n         \n@@ -124,11 +150,14 @@ function setup(level, leaderid) {\n \teim.setInstanceMap(925100500).resetPQ(level);\n         \n         respawnStg4(eim);\n+        \n         eim.startEventTimer(20 * 60000); //20 mins\n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n         return eim;\n }\n \n-function respawnStg4(eim) {    \n+function respawnStg4(eim) {\n         eim.getMapInstance(925100400).instanceMapRespawn();\n         eim.schedule(\"respawnStg4\", 10 * 1000);\n }\n@@ -148,7 +177,7 @@ function playerExit(eim, player) {\n }\n \n function changedMap(eim, player, mapid) {\n-        if (mapid < 925100000 || mapid > 925100500) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n                 if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n@@ -158,6 +187,13 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n+function changedLeader(eim, leader) {\n+        var mapid = leader.getMapId();\n+        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n+                end(eim);\n+        }\n+}\n+\n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n@@ -198,25 +234,22 @@ function end(eim) {\n                 playerExit(eim, party.get(i));\n         }\n         eim.dispose();\n-        \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n }\n \n function clearPQ(eim) {\n         eim.stopEventTimer();\n         eim.setEventCleared();\n-        eim.warpEventTeam(toMap);\n         \n-        em.schedule(\"reopenEvent\", 10 * 1000);     // leaders have 10 seconds cooldown to reach recruit map and retry for a new PQ.\n+        eim.warpEventTeam(925100600);\n }\n \n-function reopenEvent() {\n-        em.setProperty(\"state\", \"0\");\n-        em.setProperty(\"leader\", \"true\");\n+function monsterKilled(mob, eim) {\n+        if(mob.isBoss()) {  // lord pirate defeated, spawn the little fella!\n+            mob.getMap().broadcastStringMessage(5, \"As Lord Pirate dies, Wu Yang is released!\");\n+            eim.spawnNpc(2094001, new java.awt.Point(777, 140), mob.getMap());\n+        }\n }\n \n-function monsterKilled(mob, eim) {}\n-\n function allMonstersDead(eim) {}\n \n function cancelSchedule() {}"}, {"sha": "69c28c3089e6a1abe33e8bccdeb8ac22bde04ddd", "filename": "scripts/npc/world0/2094000.js", "status": "modified", "additions": 15, "deletions": 25, "changes": 40, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2094000.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6,10 +6,7 @@\n */\n \n var status = 0;\n-var minLevel = 1;\n-var maxLevel = 200;\n-var minPartySize = 1;\n-var maxPartySize = 6;\n+var em = null;\n \n function start() {\n \tstatus = -1;\n@@ -28,9 +25,16 @@ function action(mode, type, selection) {\n                         status++;\n                 else\n                         status--;\n-\n+                \n                 if (status == 0) {\n-                        cm.sendSimple(\"#b<Party Quest: Pirate PQ>#k\\r\\n\\r\\nHelp! My son has been kidnapped and is bound on the hands of the fearful #rLord Pirate#k. I need your help... Would you please assemble or join a team to save him? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+                        em = cm.getEventManager(\"PiratePQ\");\n+                        if(em == null) {\n+                                cm.sendOk(\"The Pirate PQ has encountered an error.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+                    \n+                        cm.sendSimple(\"#b<Party Quest: Pirate Ship>\\r\\n#k\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nHelp! My son has been kidnapped and is bound on the hands of the fearful #rLord Pirate#k. I need your help... Would you please assemble or join a team to save him? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n                 } else if (status == 1) {\n                         if (selection == 0) {\n                                 if (cm.getParty() == null) {\n@@ -40,37 +44,23 @@ function action(mode, type, selection) {\n                                         cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                         cm.dispose();\n                                 } else {\n-                                        var em = cm.getEventManager(\"PiratePQ\");\n-                                        if(em == null) {\n-                                                cm.sendOk(\"The Pirate PQ has encountered an error.\");\n-                                                cm.dispose();\n-                                        }\n-\n                                         var eli = em.getEligibleParty(cm.getParty());\n                                         if(eli.size() > 0) {\n-                                                var prop = em.getProperty(\"state\");\n-                                                if (prop != null && prop.equals(\"0\")) { \n-                                                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n-                                                            cm.sendOk(\"A party in your name is already registered in this event.\");\n-                                                            cm.dispose();\n-                                                            return;\n-                                                        }\n-                                                        cm.dispose();\n-                                                } else {\n-                                                        cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n-                                                        cm.dispose();\n+                                                if(!em.startInstance(0, cm.getParty(), cm.getPlayer().getMap(), 1)) {\n+                                                        cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");                            \n                                                 }\n                                         }\n                                         else {\n                                                 cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n-                                                cm.dispose();\n                                         }\n+                                        \n+                                        cm.dispose();\n                                 }\n                         } else if (selection == 1) {\n                                 cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n                                 cm.dispose();\n                         } else {\n-                                cm.sendOk(\"#b<Party Quest: Pirate PQ>#k\\r\\nIn this PQ, your mission is to progressively make your way through the ship, taking on all pirates and baddies in your path. Reaching the #rLord Pirate#k, depending on how many great chests you opened on the stages before, the boss will reveal himself even more powerful, so stay alert. Said chests, if opened, gives many extra rewards to your crew, it's worth a shot! Good luck.\");\n+                                cm.sendOk(\"#b<Party Quest: Pirate Ship>#k\\r\\nIn this PQ, your mission is to progressively make your way through the ship, taking on all pirates and baddies in your path. Reaching the #rLord Pirate#k, depending on how many great chests you opened on the stages before, the boss will reveal himself even more powerful, so stay alert. Said chests, if opened, gives many extra rewards to your crew, it's worth a shot! Good luck.\");\n                                 cm.dispose();\n                         }\n                 }"}, {"sha": "9a436438b649fcab32fa1d156d913bde185ea8b6", "filename": "scripts/npc/world0/2094001.js", "status": "modified", "additions": 63, "deletions": 48, "changes": 111, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2094001.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -40,66 +40,81 @@ function action(mode, type, selection) {\n                         status++;\n                 else\n                         status--;\n-                if (status == 0) {\n-                        cm.removeAll(4001117);\n-                        cm.removeAll(4001120);\n-                        cm.removeAll(4001121);\n-                        cm.removeAll(4001122);\n-                        cm.sendSimple(\"Thank you for saving me! How can I help you?\\r\\n#b#L0#Get me out of here.\\r\\n#L1#Give me Pirate Hat.\");\n-                } else if (status == 1) {\n-                        if (selection == 0) {\n-                                if (!cm.canHold(4001129, 1)) {\n-                                        cm.sendOk(\"Please make room in ETC.\");\n+                    \n+                if(cm.getMapId() == 925100500) {\n+                        if (status == 0) {\n+                                if(cm.isLeader()) {\n+                                        cm.sendOk(\"I have been saved thanks to your efforts! Thank you, guys!\");\n+                                }\n+                                else {\n+                                        cm.sendOk(\"I have been saved thanks to your efforts! Thank you, guys! Let your party leader talk to me first before I give you your rewards...\");\n                                         cm.dispose();\n-                                        return;\n                                 }\n-                                cm.gainItem(4001129, 1);\n-                                cm.warp(251010404,0);\n-                        } else {\n-                                if (cm.haveItem(1003267, 1)) {\n-                                        cm.sendOk(\"You have the best hat.\");\n-                                } else if (cm.haveItem(1002573, 1)) {\n-                                        if (cm.haveItem(4001129, 20)) {\t\n-                                                if (cm.canHold(1003267,1)) {\n-                                                        cm.gainItem(1002573, -1);\n-                                                        cm.gainItem(4001129, -20);\n-                                                        cm.gainItem(1003267,1);\n-                                                        cm.sendOk(\"I have given you the hat.\");\n+                        }\n+                        else {\n+                                cm.getEventInstance().clearPQ();\n+                                cm.dispose();\n+                        }\n+                }\n+                else {\n+                        if (status == 0) {\n+                                cm.sendSimple(\"Thank you for saving me! How can I help you?\\r\\n#b#L0#Get me out of here.\\r\\n#L1#Give me Pirate Hat.\");\n+                        } else if (status == 1) {\n+                                if (selection == 0) {\n+                                        if (!cm.canHold(4001129, 1)) {\n+                                                cm.sendOk(\"Please make room in ETC.\");\n+                                                cm.dispose();\n+                                                return;\n+                                        }\n+                                        cm.gainItem(4001129, 1);\n+                                        cm.warp(251010404,0);\n+                                } else {\n+                                        if (cm.haveItem(1003267, 1)) {\n+                                                cm.sendOk(\"You have the best hat.\");\n+                                        } else if (cm.haveItem(1002573, 1)) {\n+                                                if (cm.haveItem(4001129, 20)) {\t\n+                                                        if (cm.canHold(1003267,1)) {\n+                                                                cm.gainItem(1002573, -1);\n+                                                                cm.gainItem(4001129, -20);\n+                                                                cm.gainItem(1003267,1);\n+                                                                cm.sendOk(\"I have given you the hat.\");\n+                                                        } else {\n+                                                                cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        }\n                                                 } else {\n-                                                        cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n                                                 }\n-                                        } else {\n-                                                cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n-                                        }\n-                                } else if (cm.haveItem(1002572, 1)) {\n-                                        if (cm.haveItem(4001129, 20)) {\n-                                                if (cm.canHold(1002573,1)) {\n-                                                        cm.gainItem(1002572, -1);\n-                                                        cm.gainItem(4001129, -20);\n-                                                        cm.gainItem(1002573,1);\n-                                                        cm.sendOk(\"I have given you the hat.\");\n+                                        } else if (cm.haveItem(1002572, 1)) {\n+                                                if (cm.haveItem(4001129, 20)) {\n+                                                        if (cm.canHold(1002573,1)) {\n+                                                                cm.gainItem(1002572, -1);\n+                                                                cm.gainItem(4001129, -20);\n+                                                                cm.gainItem(1002573,1);\n+                                                                cm.sendOk(\"I have given you the hat.\");\n+                                                        } else {\n+                                                                cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        }\n                                                 } else {\n-                                                        cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n                                                 }\n                                         } else {\n-                                                cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n-                                        }\n-                                } else {\n-                                        if (cm.haveItem(4001129, 20)) {\t\n-                                                if (cm.canHold(1002572,1)) {\n-                                                        cm.gainItem(4001129, -20);\n-                                                        cm.gainItem(1002572,1);\n-                                                        cm.sendOk(\"I have given you the hat.\");\n+                                                if (cm.haveItem(4001129, 20)) {\t\n+                                                        if (cm.canHold(1002572,1)) {\n+                                                                cm.gainItem(4001129, -20);\n+                                                                cm.gainItem(1002572,1);\n+                                                                cm.sendOk(\"I have given you the hat.\");\n+                                                        } else {\n+                                                                cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        }\n                                                 } else {\n-                                                        cm.sendOk(\"Please make room in your EQUIP inventory before receiving the hat.\");\n+                                                        cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n                                                 }\n-                                        } else {\n-                                                cm.sendOk(\"You need 20 #t4001129# to get the next hat.\");\n                                         }\n                                 }\n-                        }\n \n-                        cm.dispose();\n+                                cm.dispose();\n+                        }\n                 }\n+                \n         }\n }"}, {"sha": "4bc21569a5f63c752f9a71b65468e9a54cc1a3e9", "filename": "scripts/npc/world0/2094002.js", "status": "modified", "additions": 110, "deletions": 109, "changes": 219, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2094002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2094002.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -12,123 +12,124 @@ function action(mode, type, selection) {\n \tstatus--;\n     }\n     if (cm.getPlayer().getMapId() == 925100700) {\n-\tcm.removeAll(4001117);\n-\tcm.removeAll(4001120);\n-\tcm.removeAll(4001121);\n-\tcm.removeAll(4001122);\n \tcm.warp(251010404,0);\n \tcm.dispose();\n \treturn;\n     }\n     \n-    if (!cm.isLeader()) {\n-\tcm.sendNext(\"I wish for your leader to talk to me.\");\n-\tcm.dispose();\n-\treturn;\n+    if(status == 1) {   // leaders cant withdraw\n+        cm.warp(251010404,0);\n+        return;\n     }\n     \n-    var eim = cm.getEventInstance();\n-    if (eim == null) {\n-        cm.warp(251010404,0);\n-\tcm.sendNext(\"How are you even here without being registered on an event?\");\n-\tcm.dispose();\n-\treturn;\n+    if (!cm.isLeader()) {\n+\tcm.sendYesNo(\"I wish for your leader to talk to me. Alternatively, you may be wanting to quit. Are you going to abandon this campaign?\");\n+    }\n+    else {\n+        var eim = cm.getEventInstance();\n+        if (eim == null) {\n+            cm.warp(251010404,0);\n+            cm.sendNext(\"How are you even here without being registered on an event?\");\n+            cm.dispose();\n+            return;\n+        }\n+\n+        level = eim.getProperty(\"level\");\n+\n+        switch(cm.getPlayer().getMapId()) {\n+            case 925100000:\n+                cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must destroy all the monsters guarding it.\");\n+                cm.dispose();\n+                break;\n+            case 925100100:\n+                var emp = eim.getProperty(\"stage2\");\n+                if (emp == null) {\n+                    eim.setProperty(\"stage2\", \"0\");\n+                    emp = \"0\";\n+                }\n+                if (emp.equals(\"0\")) {\n+                    if (cm.haveItem(4001120,20)) {\n+                        cm.sendNext(\"Excellent! Now hunt me 20 Rising Medals.\");\n+                        cm.gainItem(4001120,-20);\n+                        cm.getMap().killAllMonsters();\n+                        eim.setProperty(\"stage2\", \"1\");\n+                    } else {\n+                        cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rookie Medals.\");\n+                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300114, level, true);\n+                    }\n+                } else if (emp.equals(\"1\")) {\n+                    if (cm.haveItem(4001121,20)) {\n+                        cm.sendNext(\"Excellent! Now hunt me 20 Veteran Medals.\");\n+                        cm.gainItem(4001121,-20);\n+                        cm.getMap().killAllMonsters();\n+                        eim.setProperty(\"stage2\", \"2\");\n+                    } else {\n+                        cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rising Medals.\");\n+                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300115, level, true);\n+                    }\n+                } else if (emp.equals(\"2\")) {\n+                    if (cm.haveItem(4001122,20)) {\n+                        cm.sendNext(\"Excellent! Now let us go.\");\n+                        cm.gainItem(4001122,-20);\n+                        cm.getMap().killAllMonsters();\n+                        eim.setProperty(\"stage2\", \"3\");\n+                    } else {\n+                        cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Veteran Medals.\");\n+                        if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300116, level, true);\n+                    }\n+                } else {\n+                    cm.sendNext(\"The next stage has opened. GO!\");\n+                }\n+                cm.dispose();\n+                break;\n+            case 925100200:\n+            case 925100300:\n+                cm.sendNext(\"To assault the pirate ship, we must destroy the guards first.\");\n+                cm.dispose();\n+                break;\n+            case 925100201:\n+                if (cm.getMap().getMonsters().size() == 0) {\n+                    cm.sendNext(\"The Lord Pirate's chest has appeared! If you happen to have a key, drop it by the chest to reveal it's treasures. That will certainly make him upset.\");\n+                    if (eim.getProperty(\"stage2a\") == \"0\") {\n+                        cm.getMap().setReactorState();\n+                        eim.setProperty(\"stage2a\", \"1\");\n+                    }\n+                } else {\n+                    cm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n+                }\n+                cm.dispose();\n+                break;\n+            case 925100301:\n+                if (cm.getMap().getMonsters().size() == 0) {\n+                    cm.sendNext(\"The Lord Pirate's chest has appeared! If you happen to have a key, drop it by the chest to reveal it's treasures. That will certainly make him upset.\");\n+                    if (eim.getProperty(\"stage3a\").equals(\"0\")) {\n+                        cm.getMap().setReactorState();\n+                        eim.setProperty(\"stage3a\", \"1\");\n+                    }\n+                } else {\n+                    cm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n+                }\n+                cm.dispose();\n+                break;\n+            case 925100202:\n+            case 925100302:\n+                cm.sendNext(\"These are the Captains and Krus which devote their whole life to Lord Pirate. Kill them as you see fit.\");\n+                cm.dispose();\n+                break;\n+            case 925100400:\n+                cm.sendNext(\"These are the sources of the ship's power. We must seal it by using the Old Metal Keys on the doors!\");\n+                cm.dispose();\n+                break;\n+            case 925100500:\n+                if (cm.getMap().getMonsters().size() == 0) {\n+                    cm.sendNext(\"Thanks for saving our leader! We are in your debt.\");\n+                } else {\n+                    cm.sendNext(\"Defeat all monsters! Even Lord Pirate's minions!\");\n+                }\n+                cm.dispose();\n+                break;\n+        }\n     }\n     \n-    level = eim.getProperty(\"level\");\n     \n-    switch(cm.getPlayer().getMapId()) {\n-\tcase 925100000:\n-\t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must destroy all the monsters guarding it.\");\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100100:\n-\t    var emp = eim.getProperty(\"stage2\");\n-\t    if (emp == null) {\n-\t\teim.setProperty(\"stage2\", \"0\");\n-\t\temp = \"0\";\n-\t    }\n-\t    if (emp.equals(\"0\")) {\n-\t\tif (cm.haveItem(4001120,20)) {\n-\t\t    cm.sendNext(\"Excellent! Now hunt me 20 Rising Medals.\");\n-\t\t    cm.gainItem(4001120,-20);\n-                    cm.getMap().killAllMonsters();\n-\t\t    eim.setProperty(\"stage2\", \"1\");\n-\t\t} else {\n-\t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rookie Medals.\");\n-                    if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300114, level, true);\n-\t\t}\n-\t    } else if (emp.equals(\"1\")) {\n-\t\tif (cm.haveItem(4001121,20)) {\n-\t\t    cm.sendNext(\"Excellent! Now hunt me 20 Veteran Medals.\");\n-\t\t    cm.gainItem(4001121,-20);\n-                    cm.getMap().killAllMonsters();\n-\t\t    eim.setProperty(\"stage2\", \"2\");\n-\t\t} else {\n-\t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Rising Medals.\");\n-                    if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300115, level, true);\n-\t\t}\n-\t    } else if (emp.equals(\"2\")) {\n-\t\tif (cm.haveItem(4001122,20)) {\n-\t\t    cm.sendNext(\"Excellent! Now let us go.\");\n-\t\t    cm.gainItem(4001122,-20);\n-                    cm.getMap().killAllMonsters();\n-\t\t    eim.setProperty(\"stage2\", \"3\");\n-\t\t} else {\n-\t   \t    cm.sendNext(\"We are heading into the Pirate Ship now! To get in, we must qualify ourselves as noble pirates. Hunt me 20 Veteran Medals.\");\n-                    if(cm.countMonster() < 1) cm.getPlayer().getMap().spawnAllMonsterIdFromMapSpawnList(9300116, level, true);\n-\t\t}\n-\t    } else {\n-\t\tcm.sendNext(\"The next stage has opened. GO!\");\n-\t    }\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100200:\n-        case 925100300:\n-\t    cm.sendNext(\"To assault the pirate ship, we must destroy the guards first.\");\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100201:\n-\t    if (cm.getMap().getMonsters().size() == 0) {\n-\t\tcm.sendNext(\"Excellent.\");\n-\t\tif (eim.getProperty(\"stage2a\") == \"0\") {\n-\t\t    cm.getMap().setReactorState();\n-\t\t    eim.setProperty(\"stage2a\", \"1\");\n-\t\t}\n-\t    } else {\n-\t   \tcm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n-\t    }\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100301:\n-\t    if (cm.getMap().getMonsters().size() == 0) {\n-\t\tcm.sendNext(\"Excellent.\");\n-\t\tif (eim.getProperty(\"stage3a\").equals(\"0\")) {\n-\t\t    cm.getMap().setReactorState();\n-\t\t    eim.setProperty(\"stage3a\", \"1\");\n-\t\t}\n-\t    } else {\n-\t   \tcm.sendNext(\"These bellflowers are in hiding. We must liberate them.\");\n-\t    }\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100202:\n-\tcase 925100302:\n-\t    cm.sendNext(\"These are the Captains and Krus which devote their whole life to Lord Pirate. Kill them as you see fit.\");\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100400:\n-\t    cm.sendNext(\"These are the sources of the ship's power. We must seal it by using the Old Metal Keys on the doors!\");\n-\t    cm.dispose();\n-\t    break;\n-\tcase 925100500:\n-\t    if (cm.getMap().getMonsters().size() == 0) {\n-\t\tcm.getEventInstance().clearPQ();\n-                cm.getEventInstance().warpEventTeam(925100600);\n-\t    } else {\n-\t   \tcm.sendNext(\"Defeat all monsters! Even Lord Pirate's minions!\");\n-\t    }\n-\t    cm.dispose();\n-\t    break;\n-    }\n }\n\\ No newline at end of file"}, {"sha": "c7a223d8106204eb2f83f9d26f4660d4ee205b8c", "filename": "scripts/npc/world0/2133000.js", "status": "modified", "additions": 13, "deletions": 23, "changes": 36, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2133000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2133000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2133000.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6,10 +6,7 @@\n */\n \n var status = 0;\n-var minLevel = 1;\n-var maxLevel = 200;\n-var minPartySize = 1;\n-var maxPartySize = 6;\n+var em = null;\n \n function start() {\n \tstatus = -1;\n@@ -30,7 +27,14 @@ function action(mode, type, selection) {\n                         status--;\n \n                 if (status == 0) {\n-                        cm.sendSimple(\"#b<Party Quest: Ellin PQ>#k\\r\\n\\r\\nWould you like to assemble or join a team to solve the puzzles of the #bForest of Poison Haze#k? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\\r\\n#L3#I would like to reclaim a prize.\");\n+                        em = cm.getEventManager(\"Ellin\");\n+                        if(em == null) {\n+                                cm.sendOk(\"The Ellin PQ has encountered an error.\");\n+                                cm.dispose();\n+                                return;\n+                        }\n+                    \n+                        cm.sendSimple(\"#b<Party Quest: Forest of Poison Haze>\\r\\n#k\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble or join a team to solve the puzzles of the #bForest of Poison Haze#k? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\\r\\n#L3#I would like to reclaim a prize.\");\n                 } else if (status == 1) {\n                         if (selection == 0) {\n                                 if (cm.getParty() == null) {\n@@ -40,37 +44,23 @@ function action(mode, type, selection) {\n                                         cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                         cm.dispose();\n                                 } else {\n-                                        var em = cm.getEventManager(\"Ellin\");\n-                                        if(em == null) {\n-                                                cm.sendOk(\"The Ellin PQ has encountered an error.\");\n-                                                cm.dispose();\n-                                        }\n-\n                                         var eli = em.getEligibleParty(cm.getParty());\n                                         if(eli.size() > 0) {\n-                                                var prop = em.getProperty(\"state\");\n-                                                if (prop != null && prop.equals(\"0\")) { \n-                                                        if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n-                                                            cm.sendOk(\"A party in your name is already registered in this event.\");\n-                                                            cm.dispose();\n-                                                            return;\n-                                                        }\n-                                                        cm.dispose();\n-                                                } else {\n+                                                if(!em.startInstance(0, cm.getParty(), cm.getPlayer().getMap(), 1)) {\n                                                         cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n-                                                        cm.dispose();\n                                                 }\n                                         }\n                                         else {\n                                                 cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n-                                                cm.dispose();\n                                         }\n+                                        \n+                                        cm.dispose();\n                                 }\n                         } else if (selection == 1) {\n                                 cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n                                 cm.dispose();\n                         } else if (selection == 2) {\n-                                cm.sendOk(\"#b<Party Quest: Ellin PQ>#k\\r\\nIn this PQ, your mission is to progressively make your way through the woods, taking on all baddies in your path, solving many puzzles you encounter and rallying yourselves to take the best of teamwork to overcome time limits and powerful creatures. Clearing the final boss, your team have a chance to obtain a marble that, #bwhen dropped by the fountain at the exit map#k, will guarantee the team extra prizes. Good luck.\");\n+                                cm.sendOk(\"#b<Party Quest: Forest of Poison Haze>#k\\r\\nIn this PQ, your mission is to progressively make your way through the woods, taking on all baddies in your path, solving many puzzles you encounter and rallying yourselves to take the best of teamwork to overcome time limits and powerful creatures. Clearing the final boss, your team have a chance to obtain a marble that, #bwhen dropped by the fountain at the exit map#k, will guarantee the team extra prizes. Good luck.\");\n                                 cm.dispose();\n                         }\n                         else {"}, {"sha": "f7a6505c5d3d394616eff2dceb3ca6fe5daf5df7", "filename": "scripts/npc/world0/2133001.js", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2133001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/2133001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/2133001.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -43,9 +43,6 @@ function action(mode, type, selection) {\n \t    cm.sendNext(\"This is it! Place the Magic Stone on the Altar!\");\n \t    break;\n \tcase 930000700:\n-\t    cm.removeAll(4001163);\n-\t    cm.removeAll(4001169);\n-\t    cm.removeAll(2270004);\n \t    cm.warp(930000800,0);\n \t    break;\n     }"}, {"sha": "b20cce22d62cf808bb3c81895099a01b5b009c6b", "filename": "scripts/npc/world0/9000021.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000021.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000021.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9000021.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -49,6 +49,7 @@ function action(mode, type, selection) {\n         } else if(status == 3) {\n             cm.sendOk(\"Very well. Remember, there you can assemble a team or take on the fightings on your own, it's up to you. Good luck!\");\n         } else if(status == 4) {\n+            cm.getPlayer().saveLocation(\"BOSSPQ\");\n             cm.warp(970030000);\n             cm.dispose();\n         }"}, {"sha": "11c3b969d78067302a8679d49cbaef5bee11d01e", "filename": "scripts/npc/world0/9000037.js", "status": "modified", "additions": 14, "deletions": 24, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000037.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000037.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9000037.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6,11 +6,8 @@\n */\n \n var status = 0;\n-var minLevel = 1;\n-var maxLevel = 200;\n-var minPartySize = 1;\n-var maxPartySize = 6;\n var state;\n+var em = null;\n \n function onRestingSpot() {\n     return cm.getMapId() >= 970030001 && cm.getMapId() <= 970030010;\n@@ -73,7 +70,14 @@ function action(mode, type, selection) {\n                                 cm.sendYesNo(\"Do you wish to abandon this event?\");\n                         }\n                         else {\n-                                cm.sendSimple(\"#b<Party Quest: Boss Rush>#k\\r\\n\\r\\nWould you like to collaborate with party members to complete the expedition, or are you brave enough to take it on all by yourself? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+                                em = cm.getEventManager(\"BossRushPQ\");\n+                                if(em == null) {\n+                                        cm.sendOk(\"The Boss Rush PQ has encountered an error.\");\n+                                        cm.dispose();\n+                                        return;\n+                                }\n+                            \n+                                cm.sendSimple(\"#b<Party Quest: Boss Rush>\\r\\n#k\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to collaborate with party members to complete the expedition, or are you brave enough to take it on all by yourself? Have your #bparty leader#k talk to me or make yourself a party.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n                         }\n                 } else if (status == 1) {\n                         if(state == 3) {\n@@ -87,7 +91,7 @@ function action(mode, type, selection) {\n                                 cm.dispose();\n                         } else if(state == 2) {\n                                 var restSpot = ((cm.getMapId() - 1) % 5) + 1;\n-                                cm.getPlayer().getEventInstance().warpEventTeam(970030100 + (500 * restSpot));     //oh well, other maps won't be used anyway\n+                                cm.getPlayer().getEventInstance().warpEventTeam(970030100 + cm.getEventInstance().getIntProperty(\"lobby\") + (500 * restSpot));\n                                 cm.dispose();\n                         } else if(state == 1) {\n                                 cm.warp(970030000);\n@@ -102,37 +106,23 @@ function action(mode, type, selection) {\n                                                 cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                                 cm.dispose();\n                                         } else {\n-                                                var em = cm.getEventManager(\"BossRushPQ\");\n-                                                if(em == null) {\n-                                                        cm.sendOk(\"The Boss Rush PQ has encountered an error.\");\n-                                                        cm.dispose();\n-                                                }\n-\n                                                 var eli = em.getEligibleParty(cm.getParty());\n                                                 if(eli.size() > 0) {\n-                                                        var prop = em.getProperty(\"state\");\n-                                                        if (prop != null && prop.equals(\"0\")) { \n-                                                                if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n-                                                                    cm.sendOk(\"A party in your name is already registered in this event.\");\n-                                                                    cm.dispose();\n-                                                                    return;\n-                                                                }\n-                                                                cm.dispose();\n-                                                        } else {\n+                                                        if(!em.startInstance(0, cm.getParty(), cm.getPlayer().getMap(), 1)) {\n                                                                 cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n-                                                                cm.dispose();\n                                                         }\n                                                 }\n                                                 else {\n                                                         cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n-                                                        cm.dispose();\n                                                 }\n+                                                \n+                                                cm.dispose();\n                                         }\n                                 } else if (selection == 1) {\n                                         cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");\n                                         cm.dispose();\n                                 } else {\n-                                        cm.sendOk(\"#b<Party Quest: Boss Rush PQ>#k\\r\\nBrave adventurers from all over the places travels here to test their skills and abilities in combat, as they face even more powerful bosses from MapleStory. Join forces with fellow adventurers or face all the burden by yourself and receive all the glory, it is up to you. REWARDS are given accordingly to how far the adventurers reach and extra prizes may are given to a random member of the party, all attributed at the end of an expedition.\");\n+                                        cm.sendOk(\"#b<Party Quest: Boss Rush>#k\\r\\nBrave adventurers from all over the places travels here to test their skills and abilities in combat, as they face even more powerful bosses from MapleStory. Join forces with fellow adventurers or face all the burden by yourself and receive all the glory, it is up to you. REWARDS are given accordingly to how far the adventurers reach and extra prizes may are given to a random member of the party, all attributed at the end of an expedition.\");\n                                         cm.dispose();\n                                 }\n                         }"}, {"sha": "c73915332d82cbb5d5038c57cfc48812bcc42f0b", "filename": "scripts/npc/world0/9000038.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000038.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9000038.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9000038.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -11,13 +11,13 @@ var itemSet_lv6 = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046\n var itemQty_lv6 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 25, 25, 25, 25, 25, 25, 25, 25, 4, 4, 12, 12, 12, 12, 12, 25];\n \n var itemSet_lv5 = [1122018, 1122005, 1022088, 1402013, 1032048, 1032070, 1102046, 2330004, 2041013, 2041016, 2041019, 2041022, 2049100, 2049003, 2020012, 2020013, 2020014, 2020015, 2022029, 2022045, 2022068, 2022069, 2022179, 2022180, 4004000, 4004001, 4004002, 4004003, 4004004, 4003000];\n-var itemQty_lv5 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 15, 15, 15, 15, 15, 15, 15, 15, 15, 2, 8, 8, 8, 8, 8, 12];\n+var itemQty_lv5 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 15, 15, 15, 15, 15, 15, 15, 15, 2, 2, 8, 8, 8, 8, 8, 12];\n \n var itemSet_lv4 = [1122001, 1122006, 1022103, 1442065, 1032042, 1032021, 1102168, 2070005, 2040025, 2040029, 2040301, 2040413, 2040701, 2040817, 2002028, 2020009, 2020010, 2020011, 2022004, 2022005, 2022025, 2022027, 2022048, 2022049, 4020000, 4020001, 4020002, 4020003, 4020004, 4020005, 4020006, 4020007, 4020008, 4003000];\n-var itemQty_lv4 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 45, 45, 45, 45, 45, 45, 45, 45, 45, 45, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8];\n+var itemQty_lv4 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 45, 45, 45, 45, 45, 45, 45, 45, 45, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8];\n \n var itemSet_lv3 = [1122002, 1022088, 1012076, 1402029, 1032041, 1032044, 1102167, 2070011, 2040026, 2040030, 2040302, 2040412, 2040702, 2040818, 2002028, 2020009, 2020010, 2020011, 2022004, 2022005, 2022025, 2022027, 2022048, 2022049, 4010000, 4010001, 4010002, 4010003, 4010004, 4010005, 4010006, 4010007, 4003000];\n-var itemQty_lv3 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 5, 5, 5, 5, 5, 5, 5, 5, 5];\n+var itemQty_lv3 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 20, 20, 20, 20, 20, 20, 20, 20, 20, 5, 5, 5, 5, 5, 5, 5, 5, 5];\n \n var itemSet_lv2 = [1122003, 1012077, 1012079, 1432014, 1032059, 1032002, 1102191, 2330002, 2040001, 2040311, 2040401, 2040601, 2040824, 2040901, 2010000, 2010001, 2010002, 2010003, 2010004, 2020001, 2020002, 2020003, 2022020, 2022022, 4020000, 4020001, 4020002, 4020003, 4020004, 4020005, 4020006, 4020007, 4020008, 4003000];\n var itemQty_lv2 = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3];\n@@ -46,7 +46,7 @@ function action(mode, type, selection) {\n                         status--;\n \n                 if (status == 0) {\n-                        var sendStr = \"The #bBoss Rush Party Quest#k rewards players accordingly to how far the team went on the boss huntings. Take note that each player #bcan only claim a reward if they leave through a portal inside a Resting Spot#k. Challenging stronger bosses will require the team to commit to more fightings until the next Resting Spot is reached, or until the final boss is defeated.\\r\\n\\r\\nThe possible rewards for those leaving in the selected Resting Point are depicted here:\\r\\n\\r\\n#b\";\n+                        var sendStr = \"The #bBoss Rush Party Quest#k rewards players accordingly to how far the team went on the boss huntings. Take note that each player #bcan only claim a reward if they leave through a portal inside a Resting Spot#k. Challenging stronger bosses will require the team to commit to more fightings until the next Resting Spot is reached, or until the final boss is defeated.\\r\\n\\r\\nThe possible rewards for those leaving in the selected Resting Spot are depicted here:\\r\\n\\r\\n#b\";\n                         for(var i = 0; i < 6; i++) {\n                             sendStr += \"#L\" + i + \"#\" + levels[i] + \"#l\\r\\n\";\n                         }"}, {"sha": "4a926d9f91a04330d5377a4ebdfed6b291e38840", "filename": "scripts/npc/world0/9020000.js", "status": "modified", "additions": 11, "deletions": 22, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9020000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9020000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9020000.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6,11 +6,8 @@\n */\n \n var status = 0;\n-var minLevel = 1;\n-var maxLevel = 200;\n-var minPartySize = 1;\n-var maxPartySize = 6;\n var state;\n+var em = null;\n \n function start() {\n \tstatus = -1;\n@@ -36,7 +33,13 @@ function action(mode, type, selection) {\n                                 cm.sendYesNo(\"Do you wish to abandon this area?\");\n                         }\n                         else {\n-                                cm.sendSimple(\"#b<Party Quest: 1st Accompaniment>#k\\r\\n\\r\\nHow about you and your party members collectively beating a quest? Here you'll find obstacles and problems where you won't be able to beat it without great teamwork. If you want to try it, please tell the #bleader of your party#k to talk to me.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n+                                em = cm.getEventManager(\"KerningPQ\");\n+                                if(em == null) {\n+                                        cm.sendOk(\"The Kerning PQ has encountered an error.\");\n+                                        cm.dispose();\n+                                }\n+                            \n+                                cm.sendSimple(\"#b<Party Quest: 1st Accompaniment>\\r\\n#k\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nHow about you and your party members collectively beating a quest? Here you'll find obstacles and problems where you won't be able to beat it without great teamwork. If you want to try it, please tell the #bleader of your party#k to talk to me.#b\\r\\n#L0#I want to participate in the party quest.\\r\\n#L1#I want to find party members.\\r\\n#L2#I would like to hear more details.\");\n                         }\n                 } else if (status == 1) {\n                         if(state == 1) {\n@@ -52,31 +55,17 @@ function action(mode, type, selection) {\n                                                 cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                                 cm.dispose();\n                                         } else {\n-                                                var em = cm.getEventManager(\"KerningPQ\");\n-                                                if(em == null) {\n-                                                        cm.sendOk(\"The Kerning PQ has encountered an error.\");\n-                                                        cm.dispose();\n-                                                }\n-\n                                                 var eli = em.getEligibleParty(cm.getParty());\n                                                 if(eli.size() > 0) {\n-                                                        var prop = em.getProperty(\"state\");\n-                                                        if (prop != null && prop.equals(\"0\")) {\n-                                                                if(!em.startInstance(cm.getParty(), cm.getPlayer().getMap(), 1)) {\n-                                                                    cm.sendOk(\"A party in your name is already registered in this event.\");\n-                                                                    cm.dispose();\n-                                                                    return;\n-                                                                }\n-                                                                cm.dispose();\n-                                                        } else {\n+                                                        if(!em.startInstance(0, cm.getParty(), cm.getPlayer().getMap(), 1)) {\n                                                                 cm.sendOk(\"Another party has already entered the #rParty Quest#k in this channel. Please try another channel, or wait for the current party to finish.\");\n-                                                                cm.dispose();\n                                                         }\n                                                 }\n                                                 else {\n                                                         cm.sendOk(\"You cannot start this party quest yet, because either your party is not in the range size, some of your party members are not eligible to attempt it or they are not in this map. If you're having trouble finding party members, try Party Search.\");\n-                                                        cm.dispose();\n                                                 }\n+                                                \n+                                                cm.dispose();\n                                         }\n                                 } else if (selection == 1) {\n                                         cm.sendOk(\"Try using a Super Megaphone or asking your buddies or guild to join!\");"}, {"sha": "fa43ab07d9e5b278d6805a6a39236d5a9a9dea81", "filename": "scripts/npc/world0/9020002.js", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9020002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/npc/world0/9020002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/world0/9020002.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -49,8 +49,6 @@ function action(mode, type, selection){\n             cm.sendNext(\"To return back to the city, follow this way.\");\n         } else {\n             cm.getPlayer().changeMap(103000000, cm.getClient().getChannelServer().getMapFactory().getMap(103000000).getRandomSpawnpoint());\n-            cm.removeAll(4001007);\n-            cm.removeAll(4001008);\n             cm.dispose();\n         }\n     } else {"}, {"sha": "6439fef0cc4f40e3be30ebe89ea714af5a9170f5", "filename": "scripts/portal/davy2_hd1.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy2_hd1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy2_hd1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/davy2_hd1.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,11 +1,11 @@\n var windowTime = 10 * 1000;\n \n function enter(pi) {\n-    var em = pi.getEventManager(\"PiratePQ\");\n-    var level = em.getProperty(\"level\");\n-    if(em.getProperty(\"stage2b\") == \"0\") {\n+    var eim = pi.getEventInstance();\n+    var level = eim.getProperty(\"level\");\n+    if(eim.getProperty(\"stage2b\") == \"0\") {\n         pi.getMap(925100202).spawnAllMonstersFromMapSpawnList(level, true);\n-        em.setProperty(\"stage2b\", \"1\");\n+        eim.setProperty(\"stage2b\", \"1\");\n     }\n     \n     pi.warp(925100202,0);"}, {"sha": "37e50af50e341aed4c088265117754c278458c0a", "filename": "scripts/portal/davy3_hd1.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy3_hd1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy3_hd1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/davy3_hd1.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,11 +1,11 @@\n var windowTime = 10 * 1000;\n \n function enter(pi) {\n-    var em = pi.getEventManager(\"PiratePQ\");\n-    var level = em.getProperty(\"level\");\n-    if(em.getProperty(\"stage3b\") == \"0\") {\n+    var eim = pi.getEventInstance();\n+    var level = eim.getProperty(\"level\");\n+    if(eim.getProperty(\"stage3b\") == \"0\") {\n         pi.getMap(925100302).spawnAllMonstersFromMapSpawnList(level, true);\n-        em.setProperty(\"stage3b\", \"1\");\n+        eim.setProperty(\"stage3b\", \"1\");\n     }\n     \n     pi.warp(925100302,0);"}, {"sha": "96ea6da7db41ca1e3133371abbcb293fac847686", "filename": "scripts/portal/davy_next0.js", "status": "modified", "additions": 7, "deletions": 47, "changes": 54, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next0.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next0.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/davy_next0.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,49 +1,9 @@\n-/*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-/***********\n-@Author Jvlaple\n-***********/\n-\n function enter(pi) {\n-\tvar nextMap = 925100100;\n-\tvar eim = pi.getPlayer().getEventInstance();\n-\tvar party = eim.getPlayers();\n-\tvar target = eim.getMapInstance(nextMap);\n-\tvar targetPortal = target.getPortal(\"sp\");\n-\tvar mobCount = pi.countMonster();\n-\tvar playerS = pi.isLeader();\n-\t// only let people through if the eim is ready\n-\tif (playerS == false) {\n-\t\t// do nothing; send message to player\n-\t\tpi.getPlayer().dropMessage(6, \"Only the party leader may enter this portal.\");\n-\t\treturn false;\n-\t}else if (mobCount < 1) {\n-\t\teim.setProperty(\"entryTimeStamp\", 1000 * 60 * 6);\n-\t\tfor(var g=0; g<party.size(); g++) {\n-\t\t\tparty.get(g).changeMap(target, targetPortal);\n-\t\t}\n-\t\treturn true;\n-\t}else {\n-\t\tpi.getPlayer().dropMessage(6, \"You need to kill all monsters before proceeding.\");\n-\t\treturn false;\n-\t}\n+\tif (pi.getMap().getMonsters().size() == 0) {\n+                pi.warp(925100100,0); //next\n+                return(true);\n+        } else {\n+                pi.playerMessage(5, \"The portal is not opened yet.\");\n+                return(false);\n+        }\n }\n\\ No newline at end of file"}, {"sha": "a5a9c24e9d4d1f03bd823575ca3ee6d2dba5cca9", "filename": "scripts/portal/davy_next1.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next1.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next1.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/davy_next1.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,7 +1,7 @@\n function enter(pi) {\n     try {\n-        var em = pi.getEventManager(\"PiratePQ\");\n-        if (em != null && em.getProperty(\"stage2\").equals(\"3\")) {\n+        var eim = pi.getEventInstance();\n+        if (eim != null && eim.getProperty(\"stage2\").equals(\"3\")) {\n             pi.warp(925100200,0); //next\n             return(true);\n         } else {"}, {"sha": "650b0ad6aeb951add79c30684c1b41340c04d872", "filename": "scripts/portal/davy_next4.js", "status": "modified", "additions": 14, "deletions": 15, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next4.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/davy_next4.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/davy_next4.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,27 +1,26 @@\n importPackage(Packages.server.life);\n \n function enter(pi) {\n-    if (pi.getMap().getReactorByName(\"sMob1\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob2\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob3\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob4\").getState() >= 1) {\n-\tif (pi.isLeader()) {\n-            var em = pi.getEventManager(\"PiratePQ\");\n-            \n-            var level = parseInt(em.getProperty(\"level\"));\n-            var chests = parseInt(em.getProperty(\"openedChests\"));\n+    if (pi.getMap().getReactorByName(\"sMob1\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob2\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob3\").getState() >= 1 && pi.getMap().getReactorByName(\"sMob4\").getState() >= 1 && pi.getMap().getMonsters().size() == 0) {\n+\tvar eim = pi.getEventInstance();\n+        \n+        if(eim.getProperty(\"spawnedBoss\") == null) {\n+            var level = parseInt(eim.getProperty(\"level\"));\n+            var chests = parseInt(eim.getProperty(\"openedChests\"));\n             var boss;                                               \n-            \n+\n             if(chests == 0) boss = MapleLifeFactory.getMonster(9300119);        //lord pirate\n             else if(chests == 1) boss = MapleLifeFactory.getMonster(9300105);   //angry lord pirate\n             else boss = MapleLifeFactory.getMonster(9300106);                   //enraged lord pirate\n-            \n+\n             boss.changeDifficulty(level, true);\n-            \n+\n             pi.getMap(925100500).spawnMonsterOnGroundBelow(boss, new java.awt.Point(777, 140));\n-\t    pi.warpParty(925100500); //next\n-            return(true);\n-\t} else {\n-\t    pi.playerMessage(5, \"The leader must be here.\");\n-            return(false);\n-\t}\n+            eim.setProperty(\"spawnedBoss\", \"true\");\n+        }\n+        \n+        pi.warp(925100500, 0);\n+        return(true);\n     } else {\n \tpi.playerMessage(5, \"The portal is not opened yet.\");\n         return(false);"}, {"sha": "621f329db99e051440b72b832d9fc4d3771bc5ba", "filename": "scripts/portal/party6_out.js", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/party6_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/party6_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/party6_out.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -2,7 +2,6 @@ function enter(pi) {\n         if ((pi.getMap().getMonsters().size() == 0 || pi.getMap().getMonsterById(9300183) != null) && (pi.getMap().getReactorByName(\"\") == null || pi.getMap().getReactorByName(\"\").getState() == 1)) {\n                 if(pi.isLeader()) {\n                         pi.getEventInstance().clearPQ();\n-                        pi.getEventInstance().warpEventTeam(930000800);\n                         return true;\n                 }\n                 else {"}, {"sha": "b8e202c9d4ddf4c541d856fb8b8d95dc028701de", "filename": "scripts/portal/raid_rest.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raid_rest.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raid_rest.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/raid_rest.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -28,7 +28,7 @@ function enter(pi) {\n         var evLevel = ((pi.getMapId() - 1) % 5) + 1;\n         \n         if(pi.getPlayer().getEventInstance().isLeader(pi.getPlayer()) && pi.getPlayer().getEventInstance().getPlayerCount() > 1) {\n-                pi.message(\"Being the party leader, you cannot leave before your teammates leave first.\");\n+                pi.message(\"Being the party leader, you cannot leave before your teammates leave first or you pass leadership.\");\n                 return false;\n         }\n         "}, {"sha": "4fcfb96b5ed50a1c845cd55c970e95cd7d21bd37", "filename": "scripts/portal/raid_stage.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raid_stage.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raid_stage.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/raid_stage.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -28,8 +28,8 @@ function enter(pi) {\n     if(pi.getMap().getMonsters().isEmpty()) {\n         var nextStage;\n         \n-        if(pi.getMapId() % 500 != 0) nextStage = pi.getMapId() + 100;\n-        else nextStage = 970030001 + ((pi.getMapId() - 970030100) / 500);\n+        if(pi.getMapId() % 500 >= 100) nextStage = pi.getMapId() + 100;\n+        else nextStage = 970030001 + (Math.floor((pi.getMapId() - 970030100) / 500));\n         \n         pi.warp(nextStage);\n         return true;"}, {"sha": "3574c4b01fac392711da6718c58a368ff7b61087", "filename": "scripts/portal/raidout.js", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raidout.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/portal/raidout.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/raidout.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1,4 +1,8 @@\n function enter(pi) {\n-\tpi.warp(100000000,0);\n+        var map = pi.getPlayer().getSavedLocation(\"BOSSPQ\");\n+        if (map == -1)\n+                map = 100000000;\n+    \n+\tpi.warp(map,0);\n         return true;\n }\n\\ No newline at end of file"}, {"sha": "d85fdcc0ec553f068ce1c9510b37efacfb5d72b0", "filename": "scripts/reactor/2512001.js", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/reactor/2512001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/scripts/reactor/2512001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/reactor/2512001.js?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -25,9 +25,9 @@\n  */\n  \n function act() {\n-\tvar em = rm.getPlayer().getEventInstance().getEm();\n-\tvar now = parseInt(em.getProperty(\"openedChests\"));\n+\tvar eim = rm.getPlayer().getEventInstance();\n+\tvar now = parseInt(eim.getProperty(\"openedChests\"));\n \tvar nextNum = now + 1;\n-\tem.setProperty(\"openedChests\", nextNum.toString());\n+\teim.setProperty(\"openedChests\", nextNum.toString());\n \trm.dropItems(true, 1, 50, 100, 15);\n }\n\\ No newline at end of file"}, {"sha": "db446a4c29d2327cd52e4271e18f3bd30fb92165", "filename": "sql/db_drops.sql", "status": "modified", "additions": 24, "deletions": 7, "changes": 31, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -18770,17 +18770,34 @@\n (8220002, 2388032, 1, 1, 0, 8000),\n (9300182, 2388039, 1, 1, 0, 8000),\n (6130204, 0, 316, 478, 0, 400000),\n-(9300114, 4001120, 1, 1, 0, 200000),\n-(9300115, 4001121, 1, 1, 0, 200000),\n-(9300116, 4001122, 1, 1, 0, 200000),\n+(9300114, 4001120, 1, 1, 0, 100000),\n+(9300115, 4001121, 1, 1, 0, 100000),\n+(9300116, 4001122, 1, 1, 0, 100000),\n+(9300108, 0, 30, 60, 0, 400000),\n+(9300109, 0, 30, 60, 0, 400000),\n+(9300110, 0, 30, 60, 0, 400000),\n+(9300111, 0, 30, 60, 0, 400000),\n+(9300112, 0, 20, 30, 0, 400000),\n+(9300113, 0, 30, 50, 0, 400000),\n+(9300114, 0, 75, 100, 0, 400000),\n+(9300115, 0, 95, 150, 0, 400000),\n+(9300116, 0, 110, 200, 0, 400000),\n+(9300124, 0, 40, 80, 0, 400000),\n+(9300125, 0, 50, 100, 0, 400000),\n (9300120, 4001117, 1, 1, 0, 80000),\n (9300121, 4001117, 1, 1, 0, 80000),\n (9300122, 4001117, 1, 1, 0, 80000),\n (9300126, 4001117, 1, 1, 0, 80000),\n-(9300124, 2022131, 1, 1, 0, 40000),\n-(9300125, 2022131, 1, 1, 0, 40000),\n-(9300124, 2022132, 1, 1, 0, 40000),\n-(9300125, 2022132, 1, 1, 0, 40000),\n+(9300117, 2022131, 1, 1, 0, 100000),\n+(9300118, 2022131, 1, 1, 0, 100000),\n+(9300117, 2022132, 1, 1, 0, 100000),\n+(9300118, 2022132, 1, 1, 0, 100000),\n+(9300117, 0, 150, 280, 0, 400000),\n+(9300118, 0, 250, 500, 0, 400000),\n+(9300120, 0, 30, 50, 0, 400000),\n+(9300121, 0, 75, 100, 0, 400000),\n+(9300122, 0, 95, 150, 0, 400000),\n+(9300126, 0, 20, 30, 0, 400000),\n (9300105, 4031437, 1, 1, 0, 40000),\n (9300106, 4031437, 1, 1, 0, 40000),\n (9300107, 4031437, 1, 1, 0, 40000),"}, {"sha": "f8b1c573b15cae482a60a226dfc84915f9adef95", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -1118,7 +1118,7 @@ public void warpAhead(int map) {\n     }\n     \n     private void eventChangedMap(int map) {\n-        if (getEventInstance() != null) getEventInstance().changedMap(MapleCharacter.this, map);\n+        if (getEventInstance() != null) getEventInstance().changedMap(this, map);\n     }\n \n     public void changeMap(int map) {"}, {"sha": "19ffdc5960ede38c3f95a6d14bbb7c7a5de373fa", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -335,7 +335,7 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n \t\t\tplayer.message(\"@bosshp: Displays the remaining HP of the bosses on your map.\");\n                         if(ServerConstants.USE_DEBUG) {\n                             player.message(\"@debugpos: Displays the coordinates on the map the player is currently located.\");\n-                            player.message(\"@debugmapcount: Displays the current number of registered players in the map the player is located.\");\n+                            player.message(\"@debugmap: Displays info about the current map the player is located.\");\n                             player.message(\"@debugevent: Displays the name of the event in which the player is currently registered.\");\n                             player.message(\"@debugreactors: Displays current info for all reactors on the map the the player is currently located.\");\n                         }\n@@ -650,9 +650,9 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n                         }\n                         break;\n                     \n-                case \"debugmapcount\":\n+                case \"debugmap\":\n                         if(ServerConstants.USE_DEBUG) {\n-                            player.dropMessage(\"Current map count: (\" + player.getMap().getAllPlayers().size() + \").\");\n+                            player.dropMessage(\"Current map id \" + player.getMap().getId() + \", event: '\" + ((player.getMap().getEventInstance() != null) ? player.getMap().getEventInstance().getName() : \"null\") + \"'; Players: \" + player.getMap().getAllPlayers().size() + \", Mobs: \" + player.getMap().getMonsters().size() + \".\");\n                         }\n                         break;\n                 "}, {"sha": "0dcaaa194ec795414c82de09197fc72ac177e9da", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -84,7 +84,7 @@\n     public Channel(final int world, final int channel) {\n         this.world = world;\n         this.channel = channel;\n-        this.mapFactory = new MapleMapFactory(MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Map.wz\")), MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/String.wz\")), world, channel);\n+        this.mapFactory = new MapleMapFactory(null, MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Map.wz\")), MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/String.wz\")), world, channel);\n         try {\n             eventSM = new EventScriptManager(this, getEvents());\n             port = 7575 + this.channel - 1;"}, {"sha": "bca62edca72c0991719b1553a02e68d4e700c0c4", "filename": "src/net/server/channel/handlers/PartyOperationHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/channel/handlers/PartyOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/channel/handlers/PartyOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PartyOperationHandler.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -142,7 +142,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             case 6: {\n                 int newLeader = slea.readInt();\n                 MaplePartyCharacter newLeadr = party.getMemberById(newLeader);\n-                party.setLeader(newLeadr);\n                 world.updateParty(party.getId(), PartyOperation.CHANGE_LEADER, newLeadr);\n                 break;\n             }"}, {"sha": "f31de9bfbad383324e0493546a7f57e7bca7db98", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -346,6 +346,9 @@ public void updateParty(int partyid, PartyOperation operation, MaplePartyCharact\n                 party.updateMember(target);\n                 break;\n             case CHANGE_LEADER:\n+                if(party.getLeader().getPlayer().getEventInstance() != null) {\n+                    party.getLeader().getPlayer().getEventInstance().changedLeader(target.getPlayer());\n+                }\n                 party.setLeader(target);\n                 break;\n             default:"}, {"sha": "18078c1753d58a20d21d86a98067d7a9ab6fd36d", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -63,6 +63,7 @@\n import client.inventory.PetDataFactory;\n import constants.ItemConstants;\n import constants.ServerConstants;\n+import server.life.MapleNPC;\n \n public class AbstractPlayerInteraction {\n \n@@ -694,6 +695,19 @@ public void gainAndEquip(int itemid, short slot) {\n \t\tc.getPlayer().getInventory(MapleInventoryType.EQUIPPED).addFromDB(newItem);\n \t\tc.announce(MaplePacketCreator.modifyInventory(false, Collections.singletonList(new ModifyInventory(0, newItem))));\n \t}\n+        \n+        public void spawnNpc(int npcId, Point pos, MapleMap map) {\n+                MapleNPC npc = MapleLifeFactory.getNPC(npcId);\n+                if (npc != null) {\n+                        npc.setPosition(pos);\n+                        npc.setCy(pos.y);\n+                        npc.setRx0(pos.x + 50);\n+                        npc.setRx1(pos.x - 50);\n+                        npc.setFh(map.getFootholds().findBelow(pos).getId());\n+                        map.addMapObject(npc);\n+                        map.broadcastMessage(MaplePacketCreator.spawnNPC(npc));\n+                }\n+        }\n \n \tpublic void spawnMonster(int id, int x, int y) {\n \t\tMapleMonster monster = MapleLifeFactory.getMonster(id);"}, {"sha": "1e4eeeca5430fd247667c4448d5d53fb3bc3234c", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 113, "deletions": 46, "changes": 159, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -51,10 +51,13 @@\n import client.MapleCharacter;\n import constants.ItemConstants;\n import constants.ServerConstants;\n+import java.awt.Point;\n import java.util.concurrent.ScheduledFuture;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n import scripting.AbstractPlayerInteraction;\n+import server.life.MapleLifeFactory;\n+import server.life.MapleNPC;\n import tools.MaplePacketCreator;\n \n /**\n@@ -96,10 +99,13 @@\n         // registers all opened gates on the event. Will help late characters to encounter next stages gates already opened\n         private Set<Integer> openedGates = new HashSet<>();\n         \n+        // forces deletion of items not supposed to be holding out of the event, dealt on a player's leave moment.\n+        private Set<Integer> exclusiveItems = new HashSet<>();\n+        \n \tpublic EventInstanceManager(EventManager em, String name) {\n \t\tthis.em = em;\n \t\tthis.name = name;\n-\t\tmapFactory = new MapleMapFactory(MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Map.wz\")), MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/String.wz\")), (byte) 0, (byte) 1);//Fk this\n+\t\tmapFactory = new MapleMapFactory(this, MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/Map.wz\")), MapleDataProviderFactory.getDataProvider(new File(System.getProperty(\"wzpath\") + \"/String.wz\")), (byte) 0, (byte) 1);//Fk this\n \t\tmapFactory.setChannel(em.getChannelServer().getId());\n \t}\n \n@@ -113,21 +119,18 @@ public void giveEventPlayersExp(int gain) {\n         \n         public void giveEventPlayersExp(int gain, int mapId) {\n                 if(gain == 0) return;\n+                \n+                List<MapleCharacter> players = getPlayerList();\n             \n-                rL.lock();\n-                try {\n-                        if(mapId == -1) {\n-                                for(MapleCharacter mc: chars) {\n-                                        mc.gainExp(gain * mc.getExpRate(), true, true);\n-                                }\n+                if(mapId == -1) {\n+                        for(MapleCharacter mc: players) {\n+                                mc.gainExp(gain * mc.getExpRate(), true, true);\n                         }\n-                        else {\n-                                for(MapleCharacter mc: chars) {\n-                                        if(mc.getMapId() == mapId) mc.gainExp(gain * mc.getExpRate(), true, true);\n-                                }\n+                }\n+                else {\n+                        for(MapleCharacter mc: players) {\n+                                if(mc.getMapId() == mapId) mc.gainExp(gain * mc.getExpRate(), true, true);\n                         }\n-                } finally {\n-                        rL.unlock();\n                 }\n \t}\n         \n@@ -137,22 +140,20 @@ public void giveEventPlayersMeso(int gain) {\n         \n         public void giveEventPlayersMeso(int gain, int mapId) {\n                 if(gain == 0) return;\n-            \n-                rL.lock();\n-                try {\n-                        if(mapId == -1) {\n-                                for(MapleCharacter mc: chars) {\n-                                        mc.gainMeso(gain * mc.getMesoRate());\n-                                }\n+                \n+                List<MapleCharacter> players = getPlayerList();\n+                \n+                if(mapId == -1) {\n+                        for(MapleCharacter mc: players) {\n+                                mc.gainMeso(gain * mc.getMesoRate());\n                         }\n-                        else {\n-                                for(MapleCharacter mc: chars) {\n-                                        if(mc.getMapId() == mapId) mc.gainMeso(gain * mc.getMesoRate());\n-                                }\n+                }\n+                else {\n+                        for(MapleCharacter mc: players) {\n+                                if(mc.getMapId() == mapId) mc.gainMeso(gain * mc.getMesoRate());\n                         }\n-                } finally {\n-                        rL.unlock();\n                 }\n+                \n \t}\n \n \tpublic void registerPlayer(MapleCharacter chr) {\n@@ -270,6 +271,7 @@ public void unregisterPlayer(MapleCharacter chr) {\n                 try {\n                         chars.remove(chr);\n                         gridRemove(chr);\n+                        dropExclusiveItems(chr);\n                 } finally {\n                         wL.unlock();\n                 }\n@@ -296,11 +298,19 @@ public int getPlayerCount() {\n                         rL.unlock();\n                 }\n \t}\n-\n+        \n+        private List<MapleCharacter> getPlayerList() {\n+                rL.lock();\n+                try {\n+                    return new LinkedList<>(chars);\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n \tpublic void registerMonster(MapleMonster mob) {\n \t\tif (!mob.getStats().isFriendly()) { //We cannot register moon bunny\n \t\t\tmobs.add(mob);\n-\t\t\tmob.setEventInstance(this);\n \t\t}\n \t}\n \n@@ -319,6 +329,14 @@ public void changedMap(MapleCharacter chr, int mapId) {\n \t\t\tex.printStackTrace();\n \t\t}\n \t}\n+        \n+        public void changedLeader(MapleCharacter ldr) {\n+\t\ttry {\n+\t\t\tem.getIv().invokeFunction(\"changedLeader\", this, ldr);\n+\t\t} catch (ScriptException | NoSuchMethodException ex) {\n+\t\t\tex.printStackTrace();\n+\t\t}\n+\t}\n \t\n \tpublic void monsterKilled(MapleMonster mob) {\n \t\tmobs.remove(mob);\n@@ -408,20 +426,24 @@ public void dispose() {\n \n                 wL.lock();\n                 try {\n+                        for(MapleCharacter chr: chars) chr.setEventInstance(null);\n                         chars.clear();\n+                        \n+                        mobs.clear();\n+                        \n+                        mapFactory.dispose();\n+                        mapFactory = null;\n                 } finally {\n                         wL.unlock();\n                 }\n                 \n                 cancelSchedule();\n-\n-                mobs.clear();\n                 killCount.clear();\n-                mapFactory = null;\n+                \n                 if (expedition != null) {\n                         em.getChannelServer().getExpeditions().remove(expedition);\n                 }\n-                em.disposeInstance(name);\n+                if(!eventCleared) em.disposeInstance(name);\n                 em = null;\n \t}\n \n@@ -464,6 +486,7 @@ public void saveWinner(MapleCharacter chr) {\n \n \tpublic MapleMap getMapInstance(int mapId) {\n \t\tMapleMap map = mapFactory.getMap(mapId);\n+                map.setEventInstance(this);\n \n \t\tif (!mapFactory.isMapLoaded(mapId)) {\n \t\t\tif (em.getProperty(\"shuffleReactors\") != null && em.getProperty(\"shuffleReactors\").equals(\"true\")) {\n@@ -488,6 +511,10 @@ public String getProperty(String key) {\n         public Properties getProperties() {\n                 return props;\n         }\n+        \n+        public int getIntProperty(String key) {\n+                return Integer.parseInt(props.getProperty(key));\n+        }\n \t\n \tpublic void leftParty(MapleCharacter chr) {\n \t\ttry {\n@@ -527,26 +554,31 @@ public boolean isLeader(MapleCharacter chr) {\n         \n         public final MapleMap setInstanceMap(final int mapid) { //gets instance map from the channelserv\n                 if (disposed) {\n-                        return this.getMapFactory().getMap(mapid);\n+                        return getMapFactory().getMap(mapid);\n                 }\n                 mapIds.add(mapid);\n                 isInstanced.add(false);\n-                return this.getMapFactory().getMap(mapid);\n+                return getMapFactory().getMap(mapid);\n         }\n         \n         public final boolean disposeIfPlayerBelow(final byte size, final int towarp) {\n                 if (disposed) {\n                         return true;\n                 }\n+                if(chars == null) {\n+                        return false;\n+                }\n+                \n                 MapleMap map = null;\n                 if (towarp > 0) {\n                         map = this.getMapFactory().getMap(towarp);\n                 }\n+                \n+                List<MapleCharacter> players = getPlayerList();\n \n-                rL.lock();\n                 try {\n-                        if (chars != null && chars.size() < size) {\n-                                for (MapleCharacter chr : chars) {\n+                        if (players.size() < size) {\n+                                for (MapleCharacter chr : players) {\n                                         if (chr == null) {\n                                                 continue;\n                                         }\n@@ -562,12 +594,24 @@ public final boolean disposeIfPlayerBelow(final byte size, final int towarp) {\n                         }\n                 } catch (Exception ex) {\n                         ex.printStackTrace();\n-                } finally {\n-                        rL.unlock();\n                 }\n+                \n                 return false;\n         }\n         \n+        public void spawnNpc(int npcId, Point pos, MapleMap map) {\n+                MapleNPC npc = MapleLifeFactory.getNPC(npcId);\n+                if (npc != null) {\n+                        npc.setPosition(pos);\n+                        npc.setCy(pos.y);\n+                        npc.setRx0(pos.x + 50);\n+                        npc.setRx1(pos.x - 50);\n+                        npc.setFh(map.getFootholds().findBelow(pos).getId());\n+                        map.addMapObject(npc);\n+                        map.broadcastMessage(MaplePacketCreator.spawnNPC(npc));\n+                }\n+        }\n+        \n         private List<Integer> convertToIntegerArray(List<Double> list) {\n                 List<Integer> intList = new ArrayList<>();\n                 for(Double d: list) intList.add(d.intValue());\n@@ -603,6 +647,27 @@ public Integer getClearStageMeso(int stage) {   //stage counts from ONE.\n                 return list;\n         }\n         \n+        private void dropExclusiveItems(MapleCharacter chr) {\n+                AbstractPlayerInteraction api = new AbstractPlayerInteraction(chr.getClient());\n+                \n+                for(Integer item: exclusiveItems) {\n+                        api.removeAll(item);\n+                }\n+        }\n+        \n+        public final void setExclusiveItems(List<Double> items) {\n+                List<Integer> exclusive = convertToIntegerArray(items);\n+                \n+                wL.lock();\n+                try {\n+                        for(Integer item: exclusive) {\n+                                exclusiveItems.add(item);\n+                        }\n+                } finally {\n+                        wL.unlock();\n+                }\n+        }\n+        \n         public final void setEventRewards(List<Double> rwds, List<Double> qtys, int expGiven) {\n                 setEventRewards(1, rwds, qtys, expGiven);\n         }\n@@ -697,6 +762,11 @@ public final boolean giveEventReward(MapleCharacter player, int eventLevel) {\n         \n         public final void setEventCleared() {\n                 eventCleared = true;\n+                em.disposeInstance(name);\n+        }\n+        \n+        public final boolean isEventCleared() {\n+                return eventCleared;\n         }\n         \n         public final boolean isEventTeamLackingNow(boolean testLeader, int minPlayers, MapleCharacter quitter) {\n@@ -725,13 +795,10 @@ public final boolean isEventTeamTogether() {\n         }\n         \n         public final void warpEventTeam(int warpTo) {\n-                rL.lock();\n-                try {\n-                        for (MapleCharacter chr : chars) {\n-                                chr.changeMap(warpTo);\n-                        }\n-                } finally {\n-                        rL.unlock();\n+                List<MapleCharacter> players = getPlayerList();\n+                \n+                for (MapleCharacter chr : players) {\n+                        chr.changeMap(warpTo);\n                 }\n         }\n         "}, {"sha": "932804379bdc38f739e471be5b060ee1125dbe17", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 157, "deletions": 9, "changes": 166, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -47,6 +47,8 @@\n import java.util.List;\n import java.util.ArrayList;\n import java.lang.reflect.Array;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n \n /**\n  *\n@@ -56,14 +58,23 @@\n     private Invocable iv;\n     private Channel cserv;\n     private Map<String, EventInstanceManager> instances = new HashMap<String, EventInstanceManager>();\n+    private Map<String, Integer> instanceLocks = new HashMap<String, Integer>();\n+    private List<Boolean> openedLobbys;\n     private Properties props = new Properties();\n     private String name;\n     private ScheduledFuture<?> schedule = null;\n+    private Lock l = new ReentrantLock();\n+    \n+    private static final int maxLobbys = 8;     // an event manager holds up to this amount of concurrent lobbys\n+    private static final long lobbyDelay = 10;  // 10 seconds cooldown before reopening a lobby\n \n     public EventManager(Channel cserv, Invocable iv, String name) {\n         this.iv = iv;\n         this.cserv = cserv;\n         this.name = name;\n+        \n+        this.openedLobbys = new ArrayList<>();\n+        for(int i = 0; i < maxLobbys; i++) this.openedLobbys.add(false);\n     }\n \n     public void cancel() {\n@@ -73,6 +84,23 @@ public void cancel() {\n             ex.printStackTrace();\n         }\n     }\n+    \n+    private List<Integer> convertToIntegerArray(List<Double> list) {\n+        List<Integer> intList = new ArrayList<>();\n+        for(Double d: list) intList.add(d.intValue());\n+\n+        return intList;\n+    }\n+    \n+    private List<Integer> getLobbyRange() {\n+        try {\n+            return convertToIntegerArray((List<Double>)iv.invokeFunction(\"setLobbyRange\", (Object) null));\n+        } catch (ScriptException | NoSuchMethodException ex) {\n+            ex.printStackTrace();\n+        }\n+        \n+        return new ArrayList<>();\n+    }\n \n     public void schedule(String methodName, long delay) {\n         schedule(methodName, null, delay);\n@@ -125,8 +153,14 @@ public EventInstanceManager newInstance(String name) {\n         return ret;\n     }\n \n-    public void disposeInstance(String name) {\n-        instances.remove(name);\n+    public void disposeInstance(final String name) {\n+        TimerManager.getInstance().schedule(new Runnable() {\n+            @Override\n+            public void run() {\n+                freeLobbyInstance(name);\n+                instances.remove(name);\n+            }\n+        }, lobbyDelay * 1000);\n     }\n \n     public Invocable getIv() {\n@@ -148,16 +182,78 @@ public void setProperty(String key, int value) {\n     public int getIntProperty(String key) {\n         return Integer.parseInt(props.getProperty(key));\n     }\n+    \n+    private void setLockLobby(int lobbyId, boolean lock) {\n+        l.lock();\n+        try {\n+            openedLobbys.set(lobbyId, lock);\n+        } finally {\n+            l.unlock();\n+        }\n+    }\n+    \n+    private boolean startLobbyInstance(int lobbyId) {\n+        l.lock();\n+        try {\n+            if(!openedLobbys.get(lobbyId)) {\n+                openedLobbys.set(lobbyId, true);\n+                return true;\n+            }\n+        } finally {\n+            l.unlock();\n+        }\n+        \n+        return false;\n+    }\n+    \n+    private void freeLobbyInstance(String lobbyName) {\n+        Integer i = instanceLocks.get(lobbyName);\n+        if(i == null) return;\n+        \n+        instanceLocks.remove(lobbyName);\n+        if(i > -1) setLockLobby(i, false);\n+    }\n \n     public String getName() {\n         return name;\n     }\n+    \n+    public int availableLobbyInstance() {\n+            List<Integer> lr = getLobbyRange();\n+            int lb = 0, hb = 0;\n+            \n+            if(lr.size() >= 2) {\n+                lb = Math.max(lr.get(0), 0);\n+                hb = Math.min(lr.get(1), maxLobbys - 1);\n+            }\n+        \n+            for(int i = lb; i <= hb; i++) {\n+                    if(startLobbyInstance(i)) {\n+                            return i;\n+                    }\n+            }\n+            \n+            return -1;\n+    }\n+    \n+    public boolean startInstance(MapleExpedition exped) {\n+        return startInstance(-1, exped);\n+    }\n \n     //Expedition method: starts an expedition\n-    public boolean startInstance(MapleExpedition exped) {\n+    public boolean startInstance(int lobbyId, MapleExpedition exped) {\n         try {\n+            if(lobbyId > -1) {\n+                lobbyId = availableLobbyInstance();\n+                if(lobbyId == -1) return false;\n+            }\n+            \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n-            if(eim == null) return false;\n+            if(eim == null) {\n+                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                return false;\n+            }\n+            instanceLocks.put(eim.getName(), lobbyId);\n             \n             eim.registerExpedition(exped);\n             exped.start();\n@@ -170,9 +266,22 @@ public boolean startInstance(MapleExpedition exped) {\n \n     //Regular method: player \n     public boolean startInstance(MapleCharacter chr) {\n+        return startInstance(-1, chr);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleCharacter chr) {\n         try {\n+            if(lobbyId > -1) {\n+                lobbyId = availableLobbyInstance();\n+                if(lobbyId == -1) return false;\n+            }\n+            \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n-            if(eim == null) return false;\n+            if(eim == null) {\n+                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                return false;\n+            }\n+            instanceLocks.put(eim.getName(), lobbyId);\n             \n             eim.registerPlayer(chr);\n         } catch (ScriptException | NoSuchMethodException ex) {\n@@ -184,9 +293,22 @@ public boolean startInstance(MapleCharacter chr) {\n     \n     //PQ method: starts a PQ\n     public boolean startInstance(MapleParty party, MapleMap map) {\n+        return startInstance(-1, party, map);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleParty party, MapleMap map) {\n         try {\n+            if(lobbyId > -1) {\n+                lobbyId = availableLobbyInstance();\n+                if(lobbyId == -1) return false;\n+            }\n+            \n             EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n-            if(eim == null) return false;\n+            if(eim == null) {\n+                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                return false;\n+            }\n+            instanceLocks.put(eim.getName(), lobbyId);\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n@@ -199,9 +321,22 @@ public boolean startInstance(MapleParty party, MapleMap map) {\n     \n     //PQ method: starts a PQ with a difficulty level, requires function setup(difficulty, leaderid) instead of setup()\n     public boolean startInstance(MapleParty party, MapleMap map, int difficulty) {\n+        return startInstance(-1, party, map, difficulty);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int difficulty) {\n         try {\n-            EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, party.getLeader().getId()));\n-            if(eim == null) return false;\n+            if(lobbyId > -1) {\n+                lobbyId = availableLobbyInstance();\n+                if(lobbyId == -1) return false;\n+            }\n+            \n+            EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId()));\n+            if(eim == null) {\n+                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                return false;\n+            }\n+            instanceLocks.put(eim.getName(), lobbyId);\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n@@ -214,8 +349,21 @@ public boolean startInstance(MapleParty party, MapleMap map, int difficulty) {\n \n     //non-PQ method for starting instance\n     public boolean startInstance(EventInstanceManager eim, String leader) {\n+        return startInstance(-1, eim, leader);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, EventInstanceManager eim, String leader) {\n         try {\n-            if(eim == null) return false;\n+            if(lobbyId > -1) {\n+                lobbyId = availableLobbyInstance();\n+                if(lobbyId == -1) return false;\n+            }\n+            \n+            if(eim == null) {\n+                if(lobbyId > -1) setLockLobby(lobbyId, false);\n+                return false;\n+            }\n+            instanceLocks.put(eim.getName(), lobbyId);\n             \n             iv.invokeFunction(\"setup\", eim);\n             eim.setProperty(\"leader\", leader);"}, {"sha": "ba0d5de67205f8ad53d832d34b630b6f240b47bf", "filename": "src/scripting/reactor/ReactorActionManager.java", "status": "modified", "additions": 3, "deletions": 12, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/reactor/ReactorActionManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/scripting/reactor/ReactorActionManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/reactor/ReactorActionManager.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -138,22 +138,13 @@ public Point getPosition() {\n         pos.y -= 10;\n         return pos;\n     }\n-\n+    \n     public void spawnNpc(int npcId) {\n         spawnNpc(npcId, getPosition());\n     }\n-\n+    \n     public void spawnNpc(int npcId, Point pos) {\n-        MapleNPC npc = MapleLifeFactory.getNPC(npcId);\n-        if (npc != null) {\n-            npc.setPosition(pos);\n-            npc.setCy(pos.y);\n-            npc.setRx0(pos.x + 50);\n-            npc.setRx1(pos.x - 50);\n-            npc.setFh(reactor.getMap().getFootholds().findBelow(pos).getId());\n-            reactor.getMap().addMapObject(npc);\n-            reactor.getMap().broadcastMessage(MaplePacketCreator.spawnNPC(npc));\n-        }\n+        spawnNpc(npcId, pos, reactor.getMap());\n     }\n \n     public MapleReactor getReactor() {"}, {"sha": "47be9bf154c761786740afc532c79d9ca4599f4c", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 8, "deletions": 18, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -52,7 +52,6 @@\n import java.util.concurrent.locks.ReentrantLock;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n-import scripting.event.EventInstanceManager;\n import server.TimerManager;\n import server.life.MapleLifeFactory.BanishInfo;\n import server.maps.MapleMap;\n@@ -68,7 +67,6 @@\n     private int hp, mp;\n     private WeakReference<MapleCharacter> controller = new WeakReference<>(null);\n     private boolean controllerHasAggro, controllerKnowsAboutAggro;\n-    private EventInstanceManager eventInstance = null;\n     private Collection<MonsterListener> listeners = new LinkedList<>();\n     private EnumMap<MonsterStatus, MonsterStatusEffect> stati = new EnumMap<>(MonsterStatus.class);\n     private ArrayList<MonsterStatus> alreadyBuffed = new ArrayList<MonsterStatus>();\n@@ -342,8 +340,8 @@ public void distributeExperience(int killerId) {\n \n     public void giveExpToCharacter(MapleCharacter attacker, int exp, boolean isKiller, int numExpSharers) {\n         if (isKiller) {\n-            if (eventInstance != null) {\n-                eventInstance.monsterKilled(attacker, this);\n+            if (getMap().getEventInstance() != null) {\n+                getMap().getEventInstance().monsterKilled(attacker, this);\n             }\n         }\n         final int partyModifier = numExpSharers > 1 ? (110 + (5 * (numExpSharers - 2))) : 0;\n@@ -434,17 +432,17 @@ public void run() {\n             System.out.println(\"[CRITICAL LOSS] toSpawn is null for \" + this.getName());\n         }\n         \n-        if (eventInstance != null) {\n-            if (!this.getStats().isFriendly()) {\n-                eventInstance.monsterKilled(this);\n-            }\n-        }\n-        \n         MapleCharacter looter = map.getCharacterById(getHighestDamagerId());\n         return looter != null ? looter : killer;\n     }\n     \n     public void dispatchMonsterKilled() {\n+        if (getMap().getEventInstance() != null) {\n+            if (!this.getStats().isFriendly()) {\n+                getMap().getEventInstance().monsterKilled(this);\n+            }\n+        }\n+        \n         for (MonsterListener listener : listeners.toArray(new MonsterListener[listeners.size()])) {\n             listener.monsterKilled(getAnimationTime(\"die1\"));\n         }\n@@ -564,14 +562,6 @@ public MapleMapObjectType getType() {\n         return MapleMapObjectType.MONSTER;\n     }\n \n-    public void setEventInstance(EventInstanceManager eventInstance) {\n-        this.eventInstance = eventInstance;\n-    }\n-\n-    public EventInstanceManager getEventInstance() {\n-        return eventInstance;\n-    }\n-\n     public boolean isMobile() {\n         return stats.isMobile();\n     }"}, {"sha": "2d6c80a1e0cdd5e20e7e49826c0e38c7847729bd", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -76,6 +76,7 @@\n import server.partyquest.MonsterCarnival;\n import server.partyquest.MonsterCarnivalParty;\n import server.partyquest.Pyramid;\n+import scripting.event.EventInstanceManager;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.Pair;\n@@ -100,6 +101,7 @@\n     private boolean clock;\n     private boolean boat;\n     private boolean docked = false;\n+    private EventInstanceManager event = null;\n     private String mapName;\n     private String streetName;\n     private MapleMapEffect mapEffect = null;\n@@ -153,6 +155,14 @@ public MapleMap(int mapid, int world, int channel, int returnMapId, float monste\n         objectWLock = objectLock.writeLock();\n     }\n     \n+    public void setEventInstance(EventInstanceManager eim) {\n+        event = eim;\n+    }\n+    \n+    public EventInstanceManager getEventInstance() {\n+        return event;\n+    }\n+    \n     public void broadcastMessage(MapleCharacter source, final byte[] packet) {\n         chrRLock.lock();\n         try {\n@@ -1114,12 +1124,7 @@ public void spawnMonster(final MapleMonster monster, int difficulty, boolean isP\n         monster.changeDifficulty(difficulty, isPq);\n         \n         monster.setMap(this);\n-        if (!monster.getMap().getAllPlayer().isEmpty()) {\n-            MapleCharacter chr = (MapleCharacter) getAllPlayer().get(0);\n-            if (monster.getEventInstance() == null && chr.getEventInstance() != null) {\n-                chr.getEventInstance().registerMonster(monster);\n-            }\n-        }\n+        if(getEventInstance() != null) getEventInstance().registerMonster(monster);\n \n         spawnAndAddRangedMapObject(monster, new DelayedPacketCreation() {\n             @Override\n@@ -1701,6 +1706,10 @@ public void removePlayer(MapleCharacter chr) {\n             }\n         }\n     }\n+    \n+    public void broadcastStringMessage(int type, String message) {\n+            broadcastMessage(MaplePacketCreator.serverNotice(type, message));\n+    }\n \n     public void broadcastMessage(final byte[] packet) {\n         broadcastMessage(null, packet, Double.POSITIVE_INFINITY, null);"}, {"sha": "3bae17c1adae804535530c395ef788236ae71004", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -36,21 +36,24 @@\n import server.life.AbstractLoadedMapleLife;\n import server.life.MapleLifeFactory;\n import server.life.MapleMonster;\n+import scripting.event.EventInstanceManager;\n import tools.DatabaseConnection;\n import tools.StringUtil;\n \n public class MapleMapFactory {\n \n     private MapleDataProvider source;\n     private MapleData nameData;\n+    private EventInstanceManager event;\n     private Map<Integer, MapleMap> maps = new HashMap<>();\n     private int channel, world;\n \n-    public MapleMapFactory(MapleDataProvider source, MapleDataProvider stringSource, int world, int channel) {\n+    public MapleMapFactory(EventInstanceManager eim, MapleDataProvider source, MapleDataProvider stringSource, int world, int channel) {\n         this.source = source;\n         this.nameData = stringSource.getData(\"Map.img\");\n         this.world = world;\n         this.channel = channel;\n+        this.event = eim;\n     }\n     \n     public MapleMap getMap(int mapid) {\n@@ -75,6 +78,7 @@ public MapleMap getMap(int mapid) {\n                     monsterRate = ((Float) mobRate.getData()).floatValue();\n                 }\n                 map = new MapleMap(mapid, world, channel, MapleDataTool.getInt(\"info/returnMap\", mapData), monsterRate);\n+                map.setEventInstance(event);\n                 \n                 String onFirstEnter = MapleDataTool.getString(mapData.getChildByPath(\"info/onFirstUserEnter\"), String.valueOf(mapid));\n                 map.setOnFirstUserEnter(onFirstEnter.equals(\"\") ? String.valueOf(mapid) : onFirstEnter);\n@@ -314,4 +318,9 @@ public void setWorld(int world) {\n     public Map<Integer, MapleMap> getMaps() {\n         return maps;\n     }\n+    \n+    public void dispose() {\n+        for(MapleMap map: maps.values()) map.setEventInstance(null);\n+        this.event = null;\n+    }\n }"}, {"sha": "11f5f3a73eddff1b69b1d017c402afa2ca298257", "filename": "src/server/maps/SavedLocationType.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/SavedLocationType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/src/server/maps/SavedLocationType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/SavedLocationType.java?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -29,7 +29,7 @@\n     INTRO, \n     SUNDAY_MARKET, \n     MIRROR, \n-    DOJO,\n+    BOSSPQ,\n     HAPPYVILLE;\n \n     public static SavedLocationType fromString(String Str) {"}, {"sha": "f3f27a6945f1809fa9a0ff781a5ff04ee49a4578", "filename": "wz/Item.wz/Etc/0400.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Item.wz/Etc/0400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Item.wz/Etc/0400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Etc/0400.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -6240,6 +6240,7 @@\n         <vector name=\"origin\" x=\"0\" y=\"30\"/>\n       </canvas>\n       <int name=\"price\" value=\"1\"/>\n+      <int name=\"pquest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04001024\">"}, {"sha": "c0e722ace615de142bf15a8714b225a60a767ff5", "filename": "wz/Item.wz/Etc/0403.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Item.wz/Etc/0403.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Item.wz/Etc/0403.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Item.wz/Etc/0403.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -5290,6 +5290,7 @@\n       </canvas>\n       <int name=\"price\" value=\"1\"/>\n       <int name=\"only\" value=\"1\"/>\n+      <int name=\"pquest\" value=\"1\"/>\n     </imgdir>\n   </imgdir>\n   <imgdir name=\"04031438\">"}, {"sha": "f25eaa481139b3fe689f092268abcee81173c1be", "filename": "wz/Mob.wz/8150000.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/8150000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/8150000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/8150000.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -22,6 +22,9 @@\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"0\"/>\n     <int name=\"rareItemDropLevel\" value=\"2\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"fly\">\n     <canvas name=\"0\" width=\"150\" height=\"304\">"}, {"sha": "bda973c2d86ca3f09b93fbf231e2d8f8ddf59810", "filename": "wz/Mob.wz/8220009.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/8220009.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/8220009.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/8220009.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -29,6 +29,9 @@\n       </imgdir>\n       <int name=\"chatBalloon\" value=\"0\"/>\n     </imgdir>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"310\" height=\"254\">"}, {"sha": "c7fd55285203a6a8b1794c3a2570375bab53e9be", "filename": "wz/Mob.wz/9300003.img.xml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300003.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300003.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300003.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -40,6 +40,10 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n+    <int name=\"boss\" value=\"1\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"219\" height=\"153\">"}, {"sha": "005df61a52a6f5c93a76a90e13089342f1957772", "filename": "wz/Mob.wz/9300012.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300012.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300012.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300012.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -58,6 +58,9 @@\n         <int name=\"z\" value=\"0\"/>\n       </canvas>\n     </imgdir>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"226\" height=\"265\">"}, {"sha": "7711a907778719151e1b731fea76e5f913a8389c", "filename": "wz/Mob.wz/9300187.img.xml", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300187.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300187.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300187.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -31,7 +31,10 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n-    <int name=\"boss\" value=\"1\"/>\n     <int name=\"explosiveReward\" value=\"1\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "2bb97039ae5e0c25dae354008d87333187df961e", "filename": "wz/Mob.wz/9300192.img.xml", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300192.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300192.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300192.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -18,7 +18,6 @@\n     <string name=\"elemAttr\" value=\"I2F2L2H2S2\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"1\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <string name=\"link\" value=\"9300012\"/>\n     <int name=\"ignoreFieldOut\" value=\"1\"/>\n     <imgdir name=\"skill\">\n@@ -39,5 +38,9 @@\n       <int name=\"0\" value=\"9300216\"/>\n     </imgdir>\n     <int name=\"explosiveReward\" value=\"1\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "533d6fc684bf8f4d0e84592dbbe06201a92d54d0", "filename": "wz/Mob.wz/9300207.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300207.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300207.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300207.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -34,6 +34,9 @@\n       </imgdir>\n     </imgdir>\n     <int name=\"explosiveReward\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"310\" height=\"254\">"}, {"sha": "d4de9e7ad6c0bd57aa4875e27ade38fa5335b40d", "filename": "wz/Mob.wz/9300210.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300210.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9300210.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9300210.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -35,6 +35,9 @@\n       </imgdir>\n     </imgdir>\n     <int name=\"explosiveReward\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"150\" height=\"304\">"}, {"sha": "d82300ca0ea473c5b2fc440871d44b8ebcfdab76", "filename": "wz/Mob.wz/9303002.img.xml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9303002.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9303002.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9303002.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -17,6 +17,7 @@\n     <int name=\"pushed\" value=\"1\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"0\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"219\" height=\"153\">"}, {"sha": "3bdf530edbe12961e9ba9776552d0ccbba5eab18", "filename": "wz/Mob.wz/9500168.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500168.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500168.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500168.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -18,7 +18,6 @@\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"0\"/>\n     <int name=\"removeAfter\" value=\"600\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <int name=\"firstAttack\" value=\"1\"/>\n     <int name=\"publicReward\" value=\"1\"/>\n     <imgdir name=\"skill\">\n@@ -29,6 +28,7 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"219\" height=\"153\">"}, {"sha": "2fd2f337390f2b5b26d8c8fb1f95a4d27d115b4b", "filename": "wz/Mob.wz/9500172.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500172.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500172.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500172.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -17,7 +17,6 @@\n     <int name=\"pushed\" value=\"500\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"1\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <int name=\"removeAfter\" value=\"600\"/>\n     <int name=\"firstAttack\" value=\"1\"/>\n     <int name=\"publicReward\" value=\"1\"/>\n@@ -29,6 +28,7 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"226\" height=\"265\">"}, {"sha": "2409b4b494637190c2fa8703cb4d723c8dd2119d", "filename": "wz/Mob.wz/9500325.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500325.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500325.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500325.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -15,9 +15,9 @@\n     <int name=\"exp\" value=\"210\"/>\n     <int name=\"undead\" value=\"0\"/>\n     <int name=\"pushed\" value=\"1\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"0\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n   <imgdir name=\"move\">\n     <canvas name=\"0\" width=\"219\" height=\"153\">"}, {"sha": "e2f80c6f2658daf7d91efeb63f2d1907ea0e197a", "filename": "wz/Mob.wz/9500330.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500330.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500330.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500330.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -16,9 +16,9 @@\n     <int name=\"exp\" value=\"675\"/>\n     <int name=\"undead\" value=\"0\"/>\n     <int name=\"pushed\" value=\"50\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"0\"/>\n     <int name=\"mpRecovery\" value=\"10\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "21eaebebb1df393dfbb255bb60df3a4d6f63e2d4", "filename": "wz/Mob.wz/9500340.img.xml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500340.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500340.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500340.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -41,5 +41,9 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "30e1657a75ddca100dc938941e52d315636ad3c2", "filename": "wz/Mob.wz/9500343.img.xml", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500343.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500343.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500343.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -18,7 +18,6 @@\n     <string name=\"elemAttr\" value=\"I2F2L2H2S2\"/>\n     <float name=\"fs\" value=\"10.0\"/>\n     <int name=\"summonType\" value=\"1\"/>\n-    <int name=\"boss\" value=\"1\"/>\n     <string name=\"link\" value=\"9300012\"/>\n     <int name=\"ignoreFieldOut\" value=\"1\"/>\n     <imgdir name=\"skill\">\n@@ -53,11 +52,9 @@\n         <int name=\"effectAfter\" value=\"0\"/>\n       </imgdir>\n     </imgdir>\n-    <imgdir name=\"default\">\n-      <canvas name=\"0\" width=\"197\" height=\"210\">\n-        <vector name=\"origin\" x=\"98\" y=\"105\"/>\n-        <int name=\"z\" value=\"0\"/>\n-      </canvas>\n-    </imgdir>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"boss\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "f82db25649f5e70e3e300b72858d4541656dd914", "filename": "wz/Mob.wz/9500358.img.xml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500358.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/Mob.wz/9500358.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/9500358.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -24,5 +24,8 @@\n     <string name=\"link\" value=\"8150000\"/>\n     <int name=\"firstAttack\" value=\"1\"/>\n     <int name=\"ignoreFieldOut\" value=\"1\"/>\n+    <int name=\"HPgaugeHide\" value=\"1\"/>\n+    <int name=\"hpTagBgcolor\" value=\"5\"/>\n+    <int name=\"hpTagColor\" value=\"1\"/>\n   </imgdir>\n </imgdir>"}, {"sha": "2353611dc652c5e07e2b138066e318431d80b7be", "filename": "wz/UI.wz/UIWindow.img.xml", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/UI.wz/UIWindow.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/73557f0d61364d4ac85e02f9ff5d945b321f10c2/wz/UI.wz/UIWindow.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/UI.wz/UIWindow.img.xml?ref=73557f0d61364d4ac85e02f9ff5d945b321f10c2", "patch": "@@ -9723,11 +9723,10 @@\n       </canvas>\n       <uol name=\"7220004\" value=\"7220003\"/>\n       <uol name=\"7220005\" value=\"7220003\"/>\n-      <canvas name=\"8130100\" width=\"25\" height=\"25\">\n+      <canvas name=\"8150000\" width=\"25\" height=\"25\">\n         <int name=\"delay\" value=\"500\"/>\n         <vector name=\"origin\" x=\"0\" y=\"0\"/>\n       </canvas>\n-      <uol name=\"8150000\" value=\"8130100\"/>\n       <canvas name=\"8180000\" width=\"25\" height=\"25\">\n         <int name=\"delay\" value=\"500\"/>\n         <vector name=\"origin\" x=\"0\" y=\"0\"/>\n@@ -9760,7 +9759,7 @@\n         <int name=\"delay\" value=\"500\"/>\n         <vector name=\"origin\" x=\"0\" y=\"0\"/>\n       </canvas>\n-      <canvas name=\"8220006\" width=\"25\" height=\"25\">\n+      <canvas name=\"8220009\" width=\"25\" height=\"25\">\n         <int name=\"delay\" value=\"500\"/>\n         <vector name=\"origin\" x=\"0\" y=\"0\"/>\n       </canvas>\n@@ -10091,6 +10090,14 @@\n         <vector name=\"origin\" x=\"0\" y=\"0\"/>\n         <int name=\"z\" value=\"0\"/>\n       </canvas>\n+      <canvas name=\"8130100\" width=\"25\" height=\"25\">\n+        <int name=\"delay\" value=\"500\"/>\n+        <vector name=\"origin\" x=\"0\" y=\"0\"/>\n+      </canvas>\n+      <canvas name=\"8220006\" width=\"25\" height=\"25\">\n+        <int name=\"delay\" value=\"500\"/>\n+        <vector name=\"origin\" x=\"0\" y=\"0\"/>\n+      </canvas>\n     </imgdir>\n     <imgdir name=\"Gage\">\n       <imgdir name=\"1\">"}]}]},
