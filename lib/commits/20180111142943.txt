{"fetchDate": "2019-12-19", "content": [{"sha": "c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YzRjM2Y1OGY0MTM5NGY4YTdjNmI3ZmVhMjk3MTFmNGE2NTE0NTBmNQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-01-11T14:29:43Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2018-01-11T14:29:43Z"}, "message": "AutoAggro & MoveLife handler update + minor patches\n\nChanged some handlers to reuse MapleMap variable, preventing some minor inconsistencies.\nApplied minor patches over the source.", "tree": {"sha": "c092c14c6cd58b0137c0858387e294f06cc742d6", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/c092c14c6cd58b0137c0858387e294f06cc742d6"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "html_url": "https://github.com/ronancpl/HeavenMS/commit/c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1190513d0c0ba17f826782b68df502627cb7af15", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/1190513d0c0ba17f826782b68df502627cb7af15", "html_url": "https://github.com/ronancpl/HeavenMS/commit/1190513d0c0ba17f826782b68df502627cb7af15"}], "stats": {"total": 215, "additions": 117, "deletions": 98}, "files": [{"sha": "96ad54208dd0dfe4a635e2c03d1bacd7b9589695", "filename": "README.md", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -111,7 +111,9 @@ The client's set-up is quite straightforward:\n 1. From \"ManagerMsv83.exe\", install MapleStory on your folder of preference (e.g. \"C:\\Nexon\\MapleStory\") and follow their instructions.\n 2. Once done, erase these files: \"HShield\" (folder), \"ASPLauncher.exe\", \"MapleStory.exe\" and \"patcher.exe\".\n 3. Extract into the client folder the \"localhost.exe\" from the provided link.\n-4. Overwrite the original WZ files with the ones provided from \"client_wz\" folder on the Google Drive.\n+4. Overwrite the original WZ files with the ones provided from either one of those folders on the Google Drive:\n+\t- \"rev???_wz\" (last published RELEASE, source update of same number).\n+\t- \"current_wz\" (latest source update).\n \n If you are not using \"localhost\" as the target IP on the server's config file, you will need to HEX-EDIT \"localhost.exe\" to fetch your IP. Track down all IP locations by searching for \"Text String\" \"127.0.0.1\", and applying the changes wherever it fits.\n "}, {"sha": "c14670866c8256ebcd80173cc4be1f98a5cdba30", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -751,4 +751,8 @@ Adicionado Ereve na lista de plataformas de Orbis.\n Corrigido AP reset modificando stats de forma err\ufffdnea.\n \n 03 Janeiro 2018,\n-Corrigido item megafone permitindo o display de equipamentos n\ufffdo-comercializ\ufffdveis, mesmo marcados como Untradeable.\n\\ No newline at end of file\n+Corrigido item megafone permitindo o display de equipamentos n\ufffdo-comercializ\ufffdveis, mesmo marcados como Untradeable.\n+\n+10 - 11 Janeiro 2018,\n+Incrementado portal de MK Castle agora permitindo uso dos 2 itens poss\ufffdveis.\n+Resolvido alguns logs de erros disparados por mapas nulos no c\ufffddigo-fonte.\n\\ No newline at end of file"}, {"sha": "3287222d2649466c0eb42828a5c7b3b74b3426ed", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -2,14 +2,6 @@\n <project-private xmlns=\"http://www.netbeans.org/ns/project-private/1\">\n     <editor-bookmarks xmlns=\"http://www.netbeans.org/ns/editor-bookmarks/2\" lastBookmarkId=\"2\"/>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n-        <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/constants/skills/Legend.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/server/MapleInventoryManipulator.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/net/server/channel/handlers/MessengerHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/net/server/channel/handlers/UseCashItemHandler.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/client/SkillFactory.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/client/MapleCharacter.java</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/HeavenMS/src/server/MapleItemInformationProvider.java</file>\n-        </group>\n+        <group/>\n     </open-files>\n </project-private>"}, {"sha": "7d5225f30246ff8d56c90c640ffbfdb25183de39", "filename": "scripts/portal/enterFirstDH.js", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/scripts/portal/enterFirstDH.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/scripts/portal/enterFirstDH.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterFirstDH.js?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -11,8 +11,7 @@ function enter(pi) {\n     if (map > 0) {\n \tif (pi.getPlayerCount(map) == 0) {\n \t    var mapp = pi.getMap(map);\n-\t    mapp.resetFully();\n-\t    mapp.respawn(true);\n+\t    mapp.resetPQ();\n             \n             pi.playPortalSound();\n \t    pi.warp(map, 0);"}, {"sha": "59b5abfd2618683890412ab9d13ee43fe72f978d", "filename": "scripts/portal/obstacle.js", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/scripts/portal/obstacle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/scripts/portal/obstacle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/obstacle.js?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -1,18 +1,26 @@\n /*\n- \tAuthor: Kevin\n+ \tAuthor: Ronan\n  \tMap: Mushroom Castle - Deep Inside Mushroom Forest (106020300)\n  \tRight Portal\n  */\n  \n  function enter(pi){\n- \tif (pi.isQuestCompleted(2316)){\n- \t\tif (pi.hasItem(2430014)){\n+ \tif (pi.isQuestCompleted(2316)) {\n+ \t\tif (pi.hasItem(2430014)) {\n  \t\t\tpi.gainItem(2430014, -1 * pi.getPlayer().getItemQuantity(2430014, false));\n+                        pi.message(\"You have used the Killer Mushroom Spore to open the way.\");\n  \t\t}\n  \n  \t\tpi.warp(106020400, 2);\n  \t\treturn true;\n- \t}\n- \n+ \t} else if (pi.hasItem(2430015)) {\n+                pi.gainItem(2430015, -1 * pi.getPlayer().getItemQuantity(2430015, false));\n+                pi.message(\"You have used the Thorn Remover to clean the way.\");\n+                \n+                pi.warp(106020400, 2);\n+                return true;\n+        }\n+\n+        pi.message(\"The overgrown vines is blocking the way.\");\n  \treturn false;\n  } \n\\ No newline at end of file"}, {"sha": "aefef35aa44c242af7e26a2a7d0ed1c5b91cfa2a", "filename": "sql/db_drops.sql", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -19958,7 +19958,11 @@ USE `heavenms`;\n (9300154, 4031781, 1, 1, 0, 400000),\n (9300154, 4031782, 1, 1, 0, 400000),\n (9300154, 4031783, 1, 1, 0, 400000),\n-(9300154, 4031784, 1, 1, 0, 400000);\n+(9300154, 4031784, 1, 1, 0, 400000),\n+(1110100, 4032317, 1, 1, 21717, 20000),\n+(1110130, 4032317, 1, 1, 21717, 20000),\n+(1110100, 4032318, 1, 1, 21718, 20000),\n+(1110130, 4032318, 1, 1, 21718, 20000);\n \n # (dropperid, itemid, minqty, maxqty, questid, chance)\n "}, {"sha": "33278fa63f4f775d2f86fcb1c9513baf0c829ebe", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -3858,12 +3858,13 @@ public int getLuk() {\n     }\n \n     public int getFh() {\n-\t\tPoint pos = this.getPosition();\n-\t\tpos.y -= 6;\n-        if (getMap().getFootholds().findBelow(pos) == null) {\n+        Point pos = this.getPosition();\n+        pos.y -= 6;\n+        \n+        if (map.getFootholds().findBelow(pos) == null) {\n             return 0;\n         } else {\n-            return getMap().getFootholds().findBelow(pos).getY1();\n+            return map.getFootholds().findBelow(pos).getY1();\n         }\n     }\n "}, {"sha": "a204cf79538861be901ccadcbbde6bda77837323", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -240,16 +240,16 @@ public void run() {\n                     if(attack.skill == Aran.COMBO_SMASH || attack.skill == Aran.BODY_PRESSURE)\n                         distanceToDetect += 40000;\n                     \n-                    if(attack.skill == Bishop.GENESIS || attack.skill == ILArchMage.BLIZZARD || attack.skill == FPArchMage.METEOR_SHOWER)\n+                    else if(attack.skill == Bishop.GENESIS || attack.skill == ILArchMage.BLIZZARD || attack.skill == FPArchMage.METEOR_SHOWER)\n                         distanceToDetect += 275000;\n                     \n-                    if(attack.skill == Hero.BRANDISH || attack.skill == DragonKnight.SPEAR_CRUSHER || attack.skill == DragonKnight.POLE_ARM_CRUSHER);\n+                    else if(attack.skill == Hero.BRANDISH || attack.skill == DragonKnight.SPEAR_CRUSHER || attack.skill == DragonKnight.POLE_ARM_CRUSHER)\n                         distanceToDetect += 40000;\n                     \n-                    if(attack.skill == DragonKnight.DRAGON_ROAR || attack.skill == SuperGM.SUPER_DRAGON_ROAR)\n+                    else if(attack.skill == DragonKnight.DRAGON_ROAR || attack.skill == SuperGM.SUPER_DRAGON_ROAR)\n                         distanceToDetect += 250000;\n                     \n-                    if(attack.skill == Shadower.BOOMERANG_STEP)\n+                    else if(attack.skill == Shadower.BOOMERANG_STEP)\n                         distanceToDetect += 60000;\n                     \n                     if(distance > distanceToDetect) {"}, {"sha": "085fac30d134e3c640a12580b54d93e7bc1f5b27", "filename": "src/net/server/channel/handlers/AutoAggroHandler.java", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/AutoAggroHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/AutoAggroHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AutoAggroHandler.java?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -24,30 +24,34 @@\n import client.MapleClient;\n import net.AbstractMaplePacketHandler;\n import server.life.MapleMonster;\n+import server.maps.MapleMap;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class AutoAggroHandler extends AbstractMaplePacketHandler {\n \n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n-        int oid = slea.readInt();\n-        MapleMonster monster = c.getPlayer().getMap().getMonsterByOid(oid);\n-        \n         if(c.getPlayer().isHidden())\n             return; // Don't auto aggro GM's in hide...\n         \n-        if (monster != null && monster.getController() != null) {\n-            if (!monster.isControllerHasAggro()) {\n-                if (c.getPlayer().getMap().getCharacterById(monster.getController().getId()) == null) {\n+        MapleMap map = c.getPlayer().getMap();\n+        int oid = slea.readInt();\n+        \n+        try {\n+            MapleMonster monster = map.getMonsterByOid(oid);\n+            if (monster != null && monster.getController() != null) {\n+                if (!monster.isControllerHasAggro()) {\n+                    if (map.getCharacterById(monster.getController().getId()) == null) {\n+                        monster.switchController(c.getPlayer(), true);\n+                    } else {\n+                        monster.switchController(monster.getController(), true);\n+                    }\n+                } else if (map.getCharacterById(monster.getController().getId()) == null) {\n                     monster.switchController(c.getPlayer(), true);\n-                } else {\n-                    monster.switchController(monster.getController(), true);\n                 }\n-            } else if (c.getPlayer().getMap().getCharacterById(monster.getController().getId()) == null) {\n+            } else if (monster != null && monster.getController() == null) {\n                 monster.switchController(c.getPlayer(), true);\n             }\n-        } else if (monster != null && monster.getController() == null) {\n-            monster.switchController(c.getPlayer(), true);\n-        }\n+        } catch(NullPointerException npe) {}\n     }\n }"}, {"sha": "c251de0365002bd899c48caa92e02d1c80cb61c3", "filename": "src/net/server/channel/handlers/MoveLifeHandler.java", "status": "modified", "additions": 64, "deletions": 59, "changes": 123, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/MoveLifeHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/c4c3f58f41394f8a7c6b7fea29711f4a651450f5/src/net/server/channel/handlers/MoveLifeHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MoveLifeHandler.java?ref=c4c3f58f41394f8a7c6b7fea29711f4a651450f5", "patch": "@@ -29,6 +29,7 @@\n import server.life.MapleMonster;\n import server.life.MobSkill;\n import server.life.MobSkillFactory;\n+import server.maps.MapleMap;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n import server.movement.LifeMovementFragment;\n@@ -40,72 +41,76 @@\n public final class MoveLifeHandler extends AbstractMovementPacketHandler {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        MapleMap map = c.getPlayer().getMap();\n         List<MapleCharacter> banishPlayers = new ArrayList<>();\n         \n         int objectid = slea.readInt();\n         short moveid = slea.readShort();\n-        MapleMapObject mmo = c.getPlayer().getMap().getMapObject(objectid);\n-        if (mmo == null || mmo.getType() != MapleMapObjectType.MONSTER) {\n-            return;\n-        }\n-        MapleMonster monster = (MapleMonster) mmo;\n-        List<LifeMovementFragment> res;\n-        byte skillByte = slea.readByte();\n-        byte skill = slea.readByte();\n-        int skill_1 = slea.readByte() & 0xFF;\n-        byte skill_2 = slea.readByte();\n-        byte skill_3 = slea.readByte();\n-        byte skill_4 = slea.readByte();\n-        slea.read(8);\n-        MobSkill toUse = null;\n-        if (skillByte == 1 && monster.getNoSkills() > 0) {\n-            int random = Randomizer.nextInt(monster.getNoSkills());\n-            Pair<Integer, Integer> skillToUse = monster.getSkills().get(random);\n-            toUse = MobSkillFactory.getMobSkill(skillToUse.getLeft(), skillToUse.getRight());\n-            int percHpLeft = (monster.getHp() / monster.getMaxHp()) * 100;\n-            if (toUse.getHP() < percHpLeft || !monster.canUseSkill(toUse)) {\n-                toUse = null;\n+        \n+        try {\n+            MapleMapObject mmo = map.getMapObject(objectid);\n+            if (mmo == null || mmo.getType() != MapleMapObjectType.MONSTER) {\n+                return;\n+            }\n+            MapleMonster monster = (MapleMonster) mmo;\n+            List<LifeMovementFragment> res;\n+            byte skillByte = slea.readByte();\n+            byte skill = slea.readByte();\n+            int skill_1 = slea.readByte() & 0xFF;\n+            byte skill_2 = slea.readByte();\n+            byte skill_3 = slea.readByte();\n+            byte skill_4 = slea.readByte();\n+            slea.read(8);\n+            MobSkill toUse = null;\n+            if (skillByte == 1 && monster.getNoSkills() > 0) {\n+                int random = Randomizer.nextInt(monster.getNoSkills());\n+                Pair<Integer, Integer> skillToUse = monster.getSkills().get(random);\n+                toUse = MobSkillFactory.getMobSkill(skillToUse.getLeft(), skillToUse.getRight());\n+                int percHpLeft = (monster.getHp() / monster.getMaxHp()) * 100;\n+                if (toUse.getHP() < percHpLeft || !monster.canUseSkill(toUse)) {\n+                    toUse = null;\n+                }\n             }\n-        }\n-        if ((skill_1 >= 100 && skill_1 <= 200) && monster.hasSkill(skill_1, skill_2)) {\n-            MobSkill skillData = MobSkillFactory.getMobSkill(skill_1, skill_2);\n-            if (skillData != null && monster.canUseSkill(skillData)) {\n-                skillData.applyEffect(c.getPlayer(), monster, true, banishPlayers);\n+            if ((skill_1 >= 100 && skill_1 <= 200) && monster.hasSkill(skill_1, skill_2)) {\n+                MobSkill skillData = MobSkillFactory.getMobSkill(skill_1, skill_2);\n+                if (skillData != null && monster.canUseSkill(skillData)) {\n+                    skillData.applyEffect(c.getPlayer(), monster, true, banishPlayers);\n+                }\n             }\n-        }\n-        slea.readByte();\n-        slea.readInt(); // whatever\n-        short start_x = slea.readShort(); // hmm.. startpos?\n-        short start_y = slea.readShort(); // hmm...\n-        Point startPos = new Point(start_x, start_y);\n-        res = parseMovement(slea);\n-        if (monster.getController() != c.getPlayer()) {\n-            if (monster.isAttackedBy(c.getPlayer())) {// aggro and controller change\n-                monster.switchController(c.getPlayer(), true);\n+            slea.readByte();\n+            slea.readInt(); // whatever\n+            short start_x = slea.readShort(); // hmm.. startpos?\n+            short start_y = slea.readShort(); // hmm...\n+            Point startPos = new Point(start_x, start_y);\n+            res = parseMovement(slea);\n+            if (monster.getController() != c.getPlayer()) {\n+                if (monster.isAttackedBy(c.getPlayer())) {// aggro and controller change\n+                    monster.switchController(c.getPlayer(), true);\n+                } else {\n+                    return;\n+                }\n+            } else if (skill == -1 && monster.isControllerKnowsAboutAggro() && !monster.isMobile() && !monster.isFirstAttack()) {\n+                monster.setControllerHasAggro(false);\n+                monster.setControllerKnowsAboutAggro(false);\n+            }\n+            boolean aggro = monster.isControllerHasAggro();\n+            if (toUse != null) {\n+                    c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, monster.getMp(), aggro, toUse.getSkillId(), toUse.getSkillLevel()));\n             } else {\n-                return;\n+                c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, monster.getMp(), aggro));\n             }\n-        } else if (skill == -1 && monster.isControllerKnowsAboutAggro() && !monster.isMobile() && !monster.isFirstAttack()) {\n-            monster.setControllerHasAggro(false);\n-            monster.setControllerKnowsAboutAggro(false);\n-        }\n-        boolean aggro = monster.isControllerHasAggro();\n-        if (toUse != null) {\n-        \tc.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, monster.getMp(), aggro, toUse.getSkillId(), toUse.getSkillLevel()));\n-        } else {\n-            c.announce(MaplePacketCreator.moveMonsterResponse(objectid, moveid, monster.getMp(), aggro));\n-        }\n-        if (aggro) {\n-            monster.setControllerKnowsAboutAggro(true);\n-        }\n-        if (res != null) {\n-            c.getPlayer().getMap().broadcastMessage(c.getPlayer(), MaplePacketCreator.moveMonster(skillByte, skill, skill_1, skill_2, skill_3, skill_4, objectid, startPos, res), monster.getPosition());\n-            updatePosition(res, monster, -1);\n-            c.getPlayer().getMap().moveMonster(monster, monster.getPosition());\n-        }\n-        \n-        for (MapleCharacter chr : banishPlayers) {\n-            chr.changeMapBanish(monster.getBanish().getMap(), monster.getBanish().getPortal(), monster.getBanish().getMsg());\n-        }\n+            if (aggro) {\n+                monster.setControllerKnowsAboutAggro(true);\n+            }\n+            if (res != null) {\n+                map.broadcastMessage(c.getPlayer(), MaplePacketCreator.moveMonster(skillByte, skill, skill_1, skill_2, skill_3, skill_4, objectid, startPos, res), monster.getPosition());\n+                updatePosition(res, monster, -1);\n+                map.moveMonster(monster, monster.getPosition());\n+            }\n+\n+            for (MapleCharacter chr : banishPlayers) {\n+                chr.changeMapBanish(monster.getBanish().getMap(), monster.getBanish().getPortal(), monster.getBanish().getMsg());\n+            }\n+        } catch(NullPointerException npe) {}\n     }\n }"}]}]},
