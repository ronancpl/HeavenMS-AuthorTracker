{"fetchDate": "2019-12-19", "content": [{"sha": "ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6YWI1Y2VjN2YzM2MzNjE3ZjQ3NjJiOWIzZDIzODhhZWIyMWM0MDVkZA==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-07-15T23:22:39Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-07-15T23:22:39Z"}, "message": "Quest Item Restore + Packets w/ Timezone + Item/Exp-dec Field Limits\n\nFixed leaders being able to create expeditions even though the already passed the day limit.\nFixed overflow case in calculated max value of skills.\nImplemented item expiration from DB after the due date.\nRefactored item flags using byte-length instead of short.\nAdded FieldLimit checks for disappearing item drops and no EXP deduction in limited areas.\nAdded \"Quest Item Restore\" functionality.\nImplemented item flag auto-instantiation when generating items.\nAdded gate state update in Papulatus lobby area.\nFixed a recent issue regarding bounding box calculation of AoE player skills.\nImplemented minidungeon close, to occur as soon as the party leader leaves the area.\nRefactored HenesysPQ attributed out of the MapleMap object, now they should be available from the respective event script.\nFixed friendly mobs not dropping item periodically, a recent issue after tweaking the loot system.\nFixed Papulatus expedition closing after the exped leader leaves or a minimum of player required to start is no longer there.\nFixed several expeditions closing after performing party operations, such as \"change party leader\".\nReviewed expected max damage calculation for summons, which would not work properly in several occasions.\nNormalized timezone from packets sent to client, now using the same timezone defined from the server flags.\nFixed certain scenarios in CPQ that would happen within the stage between the \"challenge accepted\" and ingress in the battlefield.\nRevised credits script.\nAdded GM checks in the autoban method.", "tree": {"sha": "b5b1b53823877805e881e49039e81106413b1a02", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/b5b1b53823877805e881e49039e81106413b1a02"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "html_url": "https://github.com/ronancpl/HeavenMS/commit/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0228d4e176d95794f299e6a909180f4045ccfa53", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/0228d4e176d95794f299e6a909180f4045ccfa53", "html_url": "https://github.com/ronancpl/HeavenMS/commit/0228d4e176d95794f299e6a909180f4045ccfa53"}], "stats": {"total": 1593, "additions": 1200, "deletions": 393}, "files": [{"sha": "58dfab0bd4d0cda90f88360440e7d79325e6912c", "filename": ".gitignore", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/.gitignore", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/.gitignore", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/.gitignore?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -71,10 +71,18 @@\n /tools/MapleInvalidItemWithNoNameFetcher/dist/\n /tools/MapleInvalidItemWithNoNameFetcher/nbproject/\n \n+/tools/MapleMapFieldLimitChecker/build/\n+/tools/MapleMapFieldLimitChecker/dist/\n+/tools/MapleMapFieldLimitChecker/nbproject/\n+\n /tools/MapleMapInfoRetriever/build/\n /tools/MapleMapInfoRetriever/dist/\n /tools/MapleMapInfoRetriever/nbproject/\n \n+/tools/MapleMapLootLimitChecker/build/\n+/tools/MapleMapLootLimitChecker/dist/\n+/tools/MapleMapLootLimitChecker/nbproject/\n+\n /tools/MapleMesoFetcher/build/\n /tools/MapleMesoFetcher/dist/\n /tools/MapleMesoFetcher/nbproject/"}, {"sha": "a92008c7782068331f991174d3f9e27c338f78f5", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -23,7 +23,7 @@ Java7 SDK: https://www.oracle.com/technetwork/java/javase/downloads/java-archive\n \n **Important note about localhosts**: these executables are red-flagged by antivirus tools as __potentially malicious softwares__, this happens due to the reverse engineering methods that were applied onto these software artifacts. Those depicted here have been put to use for years already and posed no harm so far, so they are soundly assumed to be safe.\n \n-  Latest localhost: https://hostr.co/itrvrHapvtEg\n+  Latest localhost: https://hostr.co/SvnSKrGzXhG0\n \n   The following list, in bottom-up chronological order, holds information regarding all changes that were applied from the starting localhost used in this development. Some lines have a link attached, that will lead you to a snapshot of the localhost at that version of the artifact. Naturally, later versions holds all previous changes along with the proposed changes.\n "}, {"sha": "834b6a68eabf1f7617fb00abc35ba3be4a6e96c3", "filename": "docs/area_bosses/BossEvent.js", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/docs/area_bosses/BossEvent.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/docs/area_bosses/BossEvent.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/area_bosses/BossEvent.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -1,9 +1,12 @@\n // @Author: Resinate\n \n-var towns = new Array(800020120, 251010102, 260010201, 107000300, 200010300, 100040105, 100040106, 261030000, 110040000, 250010504, 240040401, 104000400, 222010310, 230040420, 230040420, 230020100, 105090310, 101030404, 250010304, 220050100, 220050000, 220050200, 221040301);\n-var spawns = new Array(6090002, 5220004, 3220001, 6220000, 8220000, 5220002, 5220002, 8220002, 5220001, 7220002, 8220003, 2220000, 7220001, 8510000, 8520000, 4220001, 8220008, 3220000, 7220000, 5220003, 5220003, 5220003, 6220001);\n-var x = new Array(560, 560, 645, 90, 208, 456, 474, -300, 200, 400, 0, 400, 0, 527, 138, 0, -626, 800, -300, -300, 0, 0, -4224);\n-var y = new Array(50, 50, 275, 119, 83, 278, 278, 180, 140, 540, 1125, 455, 33, -437, 138, 520, -604, 1280, 390, 1030, 1030, 1030, 776);\n+importPackage(Packages.server.life);\n+importPackage(Packages.tools);\n+\n+var towns = new Array(800020120, 251010102, 260010201, 107000300, 200010300, 100040105, 100040106, 261030000, 110040000, 240040401, 104000400, 222010310, 230040420, 230040420, 230020100, 105090310, 101030404, 250010304, 220050100, 220050000, 220050200, 221040301);\n+var spawns = new Array(6090002, 5220004, 3220001, 6220000, 8220000, 5220002, 5220002, 8220002, 5220001, 8220003, 2220000, 7220001, 8510000, 8520000, 4220001, 8220008, 3220000, 7220000, 5220003, 5220003, 5220003, 6220001);\n+var x = new Array(560, 560, 645, 90, 208, 456, 474, -300, 200, 0, 400, 0, 527, 138, 0, -626, 800, -300, -300, 0, 0, -4224);\n+var y = new Array(50, 50, 275, 119, 83, 278, 278, 180, 140, 1125, 455, 33, -437, 138, 520, -604, 1280, 390, 1030, 1030, 1030, 776);\n var mapObj;\n var mobObj;\n \n@@ -21,13 +24,12 @@ function cancelSchedule() {\n }\n \n function start() {\n-\tvar time = (Math.floor(Math.random() * 10) + 10) * (60 * 1000);\n \tfor(var i = 0; i < towns.length; i++) {\n \t\tmapObj = em.getChannelServer().getMapFactory().getMap(towns[i]);\n-\t\tmobObj = Packages.server.life.MapleLifeFactory.getMonster(spawns[i]);\n+\t\tmobObj = MapleLifeFactory.getMonster(spawns[i]);\n \t\tif(mapObj.getMonsterById(spawns[i]) == null) {\n \t\t\tmapObj.spawnMonsterOnGroundBelow(mobObj, new Packages.java.awt.Point(x[i],y[i]));\n \t\t}\n \t}\n-\tem.schedule(\"start\", time);\n-}\n\\ No newline at end of file\n+\tsetupTask = em.schedule(\"start\", 30 * 60 * 1000);\n+}"}, {"sha": "461deea159fb71936ab8a72f59fe8c12ba0e627c", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -1982,4 +1982,36 @@ Ajustado evento de Gaga no espa\u00e7o, evento agora funcional.\n Adicionado minigame RPS de NPC, recursos implementados pelo Arnah.\n \n 27 Junho 2019,\n-Corrigido contabiliza\u00e7\u00e3o de dano de auto-destrui\u00e7\u00e3o de mobs n\u00e3o sendo aplicado corretamente.\n\\ No newline at end of file\n+Corrigido contabiliza\u00e7\u00e3o de dano de auto-destrui\u00e7\u00e3o de mobs n\u00e3o sendo aplicado corretamente.\n+\n+01 Julho 2019,\n+Corrigido contabiliza\u00e7\u00e3o de entrada em bosses n\u00e3o checando cria\u00e7\u00e3o de expedi\u00e7\u00f5es.\n+Corrigido caso de overflow em valor m\u00e1ximo calculado de dano em skills.\n+Implementado retirada de itens mantidos pelo Duey na DB, ap\u00f3s dado a data de expirar.\n+\n+02 Julho 2019,\n+Refatorado flags de itens utilizando tamanho menor que o esperado.\n+Adicionado checagem por FieldLimit ao lan\u00e7ar itens em mapas dados como \"untradeable\".\n+Adicionado funcionalidade \"Quest Item Restore\".\n+\n+11 Julho 2019,\n+Implementado instancia\u00e7\u00e3o de flag \"somente compartilh\u00e1vel dentro de mesma conta\" em itens rec\u00e9m-gerados que possuem essa funcionalidade.\n+Implementado atualiza\u00e7\u00e3o de estados no port\u00e3o de entrada do Papulatus.\n+Corrigido deslize apontado pelo Conrad, na aplica\u00e7\u00e3o de caixas de limites usados pelos buffs em \u00e1rea.\n+Implementado finaliza\u00e7\u00e3o de inst\u00e2ncia de minidungeon assim que o l\u00edder de party sai da \u00e1rea ou h\u00e1 troca de l\u00edderes com algu\u00e9m fora da \u00e1rea.\n+\n+14 Julho 2019,\n+Refatorado atributos de HenesysPQ sendo utilizados em objetos de \u00e1reas do jogo.\n+Corrigido mobs aliados n\u00e3o realizando item drops devidamente ap\u00f3s atualiza\u00e7\u00e3o recente no sistema de loot.\n+Corrigido quest de proteger hog (explorers) \"completando\" mesmo embora o jogador tenha tentado sair da inst\u00e2ncia ao conversar com o NPC.\n+Corrigido poss\u00edvel exploit com quest de proteger hog (explorers), onde o jogador poderia vir a tentar novamente a inst\u00e2ncia ap\u00f3s complet\u00e1-la (resultando em recompensas r\u00e1pidas).\n+Corrigido script de Papulatus n\u00e3o levando os m\u00e9todos de checagem de requisitos atualizados para expedi\u00e7\u00f5es.\n+Corrigido diversos scripts de expedi\u00e7\u00f5es finalizando expedi\u00e7\u00f5es indevidamente ao realizar opera\u00e7\u00f5es de party.\n+Implementado checagem por flag de FieldLimit que evita penalidade de perda de EXP em certas \u00e1reas do jogo.\n+Revisado limite de dano aplic\u00e1vel por alguns summons, cujo valor limite estava muito abaixo do esperado, levando a problemas com aplica\u00e7\u00e3o de ataques dos mesmos.\n+\n+15 Julho 2019,\n+Implementado normaliza\u00e7\u00e3o de fuso hor\u00e1rio em pacotes enviados ao cliente. Agora o sistema utiliza mesmo fuso hor\u00e1rio definido nas flags do servidor.\n+Corrigido certos casos onde grupos dentro de lobby de CPQ n\u00e3o conseguiam ser desafiados, geralmente ocorrendo ao se desconectar ap\u00f3s o desafio ter sido aceito e antes de come\u00e7ar a inst\u00e2ncia.\n+Revisado script de cr\u00e9ditos.\n+Adicionado checagem por GM's no m\u00e9todo de autoban de jogador.\n\\ No newline at end of file"}, {"sha": "ad2122ebe06bb8a9f5c09cde7b2bd1dc09a5addb", "filename": "scripts/event/BalrogBattle.js", "status": "modified", "additions": 3, "deletions": 18, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/BalrogBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/BalrogBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BalrogBattle.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -179,12 +179,7 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n-function changedLeader(eim, leader) {\n-        var mapid = leader.getMapId();\n-        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n-                end(eim);\n-        }\n-}\n+function changedLeader(eim, leader) {}\n \n function playerDead(eim, player) {}\n \n@@ -206,19 +201,9 @@ function playerDisconnected(eim, player) {\n                 eim.unregisterPlayer(player);\n }\n \n-function leftParty(eim, player) {\n-        if (eim.isExpeditionTeamLackingNow(false, minPlayers, player)) {\n-                end(eim);\n-        }\n-        else\n-                playerLeft(eim, player);\n-}\n+function leftParty(eim, player) {}\n \n-function disbandParty(eim) {\n-        if (!eim.isEventCleared()) {\n-                end(eim);\n-        }\n-}\n+function disbandParty(eim) {}\n \n function monsterValue(eim, mobId) {\n         return 1;"}, {"sha": "031c31d859a00945264d7247c008472a842dba1f", "filename": "scripts/event/BalrogBattle_Easy.js", "status": "modified", "additions": 3, "deletions": 18, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/BalrogBattle_Easy.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/BalrogBattle_Easy.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BalrogBattle_Easy.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -179,12 +179,7 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n-function changedLeader(eim, leader) {\n-        var mapid = leader.getMapId();\n-        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n-                end(eim);\n-        }\n-}\n+function changedLeader(eim, leader) {}\n \n function playerDead(eim, player) {}\n \n@@ -206,19 +201,9 @@ function playerDisconnected(eim, player) {\n                 eim.unregisterPlayer(player);\n }\n \n-function leftParty(eim, player) {\n-        if (eim.isExpeditionTeamLackingNow(false, minPlayers, player)) {\n-                end(eim);\n-        }\n-        else\n-                playerLeft(eim, player);\n-}\n+function leftParty(eim, player) {}\n \n-function disbandParty(eim) {\n-        if (!eim.isEventCleared()) {\n-                end(eim);\n-        }\n-}\n+function disbandParty(eim) {}\n \n function monsterValue(eim, mobId) {\n         return 1;"}, {"sha": "cc4ebb506143520329aabfbe40af9301c91e9815", "filename": "scripts/event/HenesysPQ.js", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/HenesysPQ.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/HenesysPQ.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/HenesysPQ.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -105,6 +105,8 @@ function setup(level, lobbyid) {\n         var eim = em.newInstance(\"Henesys\" + lobbyid);\n         eim.setProperty(\"level\", level);\n         eim.setProperty(\"stage\", \"0\");\n+        eim.setProperty(\"bunnyCake\", \"0\");\n+        eim.setProperty(\"bunnyDamage\", \"0\");\n         \n         eim.getInstanceMap(910010000).resetPQ(level);\n         eim.getInstanceMap(910010000).allowSummonState(false);\n@@ -243,6 +245,25 @@ function friendlyKilled(mob, eim) {\n         }\n }\n \n+function friendlyItemDrop(eim, mob) {\n+        if (mob.getId() == 9300061) {\n+                var cakes = eim.getIntProperty(\"bunnyCake\") + 1;\n+                eim.setIntProperty(\"bunnyCake\", cakes);\n+                \n+                mob.getMap().broadcastMessage(Packages.tools.MaplePacketCreator.serverNotice(6, \"The Moon Bunny made rice cake number \" + cakes + \".\"));\n+        }\n+}\n+\n+function friendlyDamaged(eim, mob) {\n+        if (mob.getId() == 9300061) {\n+                var bunnyDamage = eim.getIntProperty(\"bunnyDamaged\") + 1;\n+                if (bunnyDamage > 5) {\n+                        broadcastMessage(Packages.tools.MaplePacketCreator.serverNotice(6, \"The Moon Bunny is feeling sick. Please protect it so it can make delicious rice cakes.\"));\n+                        eim.setIntProperty(\"bunnyDamaged\", 0);\n+                }\n+        }\n+}\n+\n function allMonstersDead(eim) {}\n \n function cancelSchedule() {}"}, {"sha": "af8aba642f60164cd87b1d9c64ef587fe2f16e69", "filename": "scripts/event/PapulatusBattle.js", "status": "modified", "additions": 20, "deletions": 23, "changes": 43, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/PapulatusBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/PapulatusBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/PapulatusBattle.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -115,7 +115,9 @@ function setup(level, lobbyid) {\n         return eim;\n }\n \n-function afterSetup(eim) {}\n+function afterSetup(eim) {\n+        updateGateState(1);\n+}\n \n function respawnStages(eim) {}\n \n@@ -143,7 +145,7 @@ function playerLeft(eim, player) {\n \n function changedMap(eim, player, mapid) {\n         if (mapid < minMapId || mapid > maxMapId) {\n-                if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+                if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n                         eim.unregisterPlayer(player);\n                         end(eim);\n                 }\n@@ -152,17 +154,12 @@ function changedMap(eim, player, mapid) {\n         }\n }\n \n-function changedLeader(eim, leader) {\n-        var mapid = leader.getMapId();\n-        if (!eim.isEventCleared() && (mapid < minMapId || mapid > maxMapId)) {\n-                end(eim);\n-        }\n-}\n+function changedLeader(eim, leader) {}\n \n function playerDead(eim, player) {}\n \n function playerRevive(eim, player) { // player presses ok on the death pop up.\n-        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+        if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n                 eim.unregisterPlayer(player);\n                 end(eim);\n         }\n@@ -171,27 +168,17 @@ function playerRevive(eim, player) { // player presses ok on the death pop up.\n }\n \n function playerDisconnected(eim, player) {\n-        if (eim.isEventTeamLackingNow(true, minPlayers, player)) {\n+        if (eim.isExpeditionTeamLackingNow(true, minPlayers, player)) {\n                 eim.unregisterPlayer(player);\n                 end(eim);\n         }\n         else\n                 eim.unregisterPlayer(player);\n }\n \n-function leftParty(eim, player) {\n-        if (eim.isEventTeamLackingNow(false, minPlayers, player)) {\n-                end(eim);\n-        }\n-        else\n-                playerLeft(eim, player);\n-}\n+function leftParty(eim, player) {}\n \n-function disbandParty(eim) {\n-        if (!eim.isEventCleared()) {\n-                end(eim);\n-        }\n-}\n+function disbandParty(eim) {}\n \n function monsterValue(eim, mobId) {\n         return 1;\n@@ -213,6 +200,7 @@ function giveRandomEventReward(eim, player) {\n function clearPQ(eim) {\n         eim.stopEventTimer();\n         eim.setEventCleared();\n+        updateGateState(0);\n }\n \n function isPapulatus(mob) {\n@@ -231,5 +219,14 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n-function dispose(eim) {}\n+function updateGateState(newState) {    // thanks Conrad for noticing missing gate update\n+        em.getChannelServer().getMapFactory().getMap(220080000).getReactorById(2208001).forceHitReactor(newState);\n+        em.getChannelServer().getMapFactory().getMap(220080000).getReactorById(2208002).forceHitReactor(newState);\n+        em.getChannelServer().getMapFactory().getMap(220080000).getReactorById(2208003).forceHitReactor(newState);\n+}\n \n+function dispose(eim) {\n+        if (!eim.isEventCleared()) {\n+                updateGateState(0);\n+        }\n+}"}, {"sha": "63a3bb92769547e0658ba3e75810330a31f52831", "filename": "scripts/event/ZakumBattle.js", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/ZakumBattle.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/event/ZakumBattle.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/ZakumBattle.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -86,7 +86,7 @@ function setEventRewards(eim) {\n }\n \n function afterSetup(eim) {\n-    em.getChannelServer().getMapFactory().getMap(211042300).getReactorById(2118002).forceHitReactor(1);\n+    updateGateState(1);\n }\n \n function setup(channel) {\n@@ -190,7 +190,7 @@ function giveRandomEventReward(eim, player) {\n function clearPQ(eim) {\n     eim.stopEventTimer();\n     eim.setEventCleared();\n-    em.getChannelServer().getMapFactory().getMap(211042300).getReactorById(2118002).forceHitReactor(0);\n+    updateGateState(0);\n }\n \n function isZakum(mob) {\n@@ -212,8 +212,12 @@ function allMonstersDead(eim) {}\n \n function cancelSchedule() {}\n \n+function updateGateState(newState) {    // thanks Conrad for noticing missing gate update\n+    em.getChannelServer().getMapFactory().getMap(211042300).getReactorById(2118002).forceHitReactor(newState);\n+}\n+\n function dispose(eim) {\n     if (!eim.isEventCleared()) {\n-        em.getChannelServer().getMapFactory().getMap(211042300).getReactorById(2118002).forceHitReactor(0);\n+        updateGateState(0);\n     }\n }"}, {"sha": "d5fb6da0f1bbaec88e1b515d93e3e0671bbfabfb", "filename": "scripts/npc/1061014.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/1061014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/1061014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061014.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -65,8 +65,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\\r\\n\\#L3#I would like to see info about this expedition...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -99,8 +104,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "70b45c490651ffa9debb8d5febfa5fb92f5b203f", "filename": "scripts/npc/2030013.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2030013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2030013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030013.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -66,8 +66,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {    // thanks Conrad for noticing exped leaders being able to still manage in-progress expeds\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -106,8 +111,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "e2ee871223a7b521b1aec3fe0ba0b4520bfc9ef5", "filename": "scripts/npc/2060005.js", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2060005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2060005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2060005.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -32,12 +32,19 @@ function start() {\n         cm.sendOk(\"Thanks for saving the pork.\");\n     }\n     else if(cm.isQuestStarted(6002)) {\n-        var em = cm.getEventManager(\"3rdJob_mount\");\n-        if (em == null)\n-            cm.sendOk(\"Sorry, but 3rd job advancement (mount) is closed.\");\n-        else {\n-            if (!em.startInstance(cm.getPlayer())) {\n-                cm.sendOk(\"There is currently someone in this map, come back later.\");\n+        if (cm.haveItem(4031507, 5) && cm.haveItem(4031508,5)) {\n+            cm.sendOk(\"Thanks for saving the pork.\");\n+        } else {\n+            var em = cm.getEventManager(\"3rdJob_mount\");\n+            if (em == null)\n+                cm.sendOk(\"Sorry, but 3rd job advancement (mount) is closed.\");\n+            else {\n+                if (em.startInstance(cm.getPlayer())) {\n+                    cm.removeAll(4031507);\n+                    cm.removeAll(4031508);\n+                } else {\n+                    cm.sendOk(\"There is currently someone in this map, come back later.\");\n+                }\n             }\n         }\n     }"}, {"sha": "f13fc27bcfad944b99e1093d188b250318e588cb", "filename": "scripts/npc/2083004.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2083004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2083004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2083004.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -64,8 +64,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -98,8 +103,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "3058076035fc1bf4dc84f4297c82c06fbe00214d", "filename": "scripts/npc/2101014.js", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2101014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2101014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2101014.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -134,9 +134,12 @@ function enterArena(arenaPlayers) {\n         return;\n     } else if (expedicao == null) {\n         if (arenaPlayers != -1) {\n-            if (cm.createExpedition(exped, true, 0, arenaPlayers)) {\n+            var res = cm.createExpedition(exped, true, 0, arenaPlayers);\n+            if (res == 0) {\n                 cm.warp(map, 0);\n                 cm.getPlayer().dropMessage(\"Your arena was created successfully. Wait for people to join the battle.\");\n+            } else if (res > 0) {\n+                cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n             } else {\n                 cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n             }"}, {"sha": "1c41cf337ba7cc8c4a6140ae46f9e969c326e5b7", "filename": "scripts/npc/2141001.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2141001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/2141001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2141001.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -67,8 +67,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -101,8 +106,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "4181d1e6eca7547f6079d345f71e09041345f879", "filename": "scripts/npc/9060000.js", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9060000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9060000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9060000.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -20,9 +20,12 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n var status = -1;\n+var completed;\n \n function start() {\n-    if (cm.haveItem(4031508, 5) && cm.haveItem(4031507,5)) {\n+    completed = cm.haveItem(4031508, 5) && cm.haveItem(4031507,5);\n+    \n+    if (completed) {\n         cm.sendNext(\"Wow~ You have succeeded in collecting 5 of each #b#t4031508##k and #b#t4031507##k. Okay then, I will send you to Zoo. Please talk to me again when you get there.\");\n     } else {\n         cm.sendYesNo(\"You haven't completed the requirements. Are you sure you want to leave?\");\n@@ -36,9 +39,15 @@ function action(mode, type, selection){\n         return;\n     }\n     \n-    if(status == 0) cm.sendOk(\"Well okay, I will send you back.\");\n-    else {\n-        cm.getEventInstance().clearPQ();\n+    if(status == 0) {\n+        cm.sendOk(\"Well okay, I will send you back.\");\n+    } else {\n+        if (completed) {\n+            cm.getEventInstance().clearPQ();\n+        } else {\n+            cm.warp(923010100);\n+        }\n+        \n         cm.dispose();\n     }\n }\n\\ No newline at end of file"}, {"sha": "13be378b5a51d5086b7cf511fd937c61b39bb47e", "filename": "scripts/npc/9120201.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9120201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9120201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120201.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -65,8 +65,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -105,8 +110,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "766cae86de2982191684ea0b53d0373363721741", "filename": "scripts/npc/9201113.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9201113.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9201113.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201113.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -61,8 +61,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Party Quest: Crimsonwood Keep>\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to attempt the #rCrimsonwood Keep Party Quest#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -89,8 +94,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(cwkpq)) {\n+                var res = cm.createExpedition(cwkpq);\n+                if (res == 0) {\n                     cm.sendOk(\"The #rCrimsonwood Keep Party Quest Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "b77399be546732a69f58fe17856658a26b290683", "filename": "scripts/npc/9270047.js", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9270047.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9270047.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9270047.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -66,8 +66,13 @@ function action(mode, type, selection) {\n                 cm.sendSimple(\"#e#b<Expedition: \" + expedName + \">\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nWould you like to assemble a team to take on #r\" + expedBoss + \"#k?\\r\\n#b#L1#Lets get this going!#l\\r\\n\\#L2#No, I think I'll wait a bit...#l\");\n                 status = 1;\n             } else if (expedition.isLeader(player)) { //If you're the leader, manage the exped\n-                cm.sendSimple(list);\n-                status = 2;\n+                if (expedition.isInProgress()) {\n+                    cm.sendOk(\"Your expedition is already in progress, for those who remain battling lets pray for those brave souls.\");\n+                    cm.dispose();\n+                } else {\n+                    cm.sendSimple(list);\n+                    status = 2;\n+                }\n             } else if (expedition.isRegistering()) { //If the expedition is registering\n                 if (expedition.contains(player)) { //If you're in it but it hasn't started, be patient\n                     cm.sendOk(\"You have already registered for the expedition. Please wait for #r\" + expedition.getLeader().getName() + \"#k to begin it.\");\n@@ -106,8 +111,11 @@ function action(mode, type, selection) {\n                     return;\n                 }\n                 \n-                if (cm.createExpedition(exped)) {\n+                var res = cm.createExpedition(exped);\n+                if (res == 0) {\n                     cm.sendOk(\"The #r\" + expedBoss + \" Expedition#k has been created.\\r\\n\\r\\nTalk to me again to view the current team, or start the fight!\");\n+                } else if (res > 0) {\n+                    cm.sendOk(\"Sorry, you've already reached the quota of attempts for this expedition! Try again another day...\");\n                 } else {\n                     cm.sendOk(\"An unexpected error has occurred when starting the expedition, please try again later.\");\n                 }"}, {"sha": "6407ca43f57dca977cf9104626f0efe6f451b3a7", "filename": "scripts/npc/9900000.js", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9900000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/9900000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9900000.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -40,6 +40,12 @@ var facenew = Array();\n var colors = Array();\n var price = 100000;\n \n+function pushIfItemExists(array, itemid) {\n+    if ((itemid = cm.getCosmeticItem(itemid)) != -1 && !cm.isCosmeticEquipped(itemid)) {  // thanks Conrad for noticing NPC crashing the player when trying to display inexistent cosmetics\n+        array.push(itemid);\n+    }\n+}\n+\n function start() {\n     if(cm.getPlayer().gmLevel() < 1) {\n         cm.sendOk(\"Hey wassup?\");\n@@ -67,21 +73,21 @@ function action(mode, type, selection) {\n \t\t\t\tcm.sendStyle(\"Pick one?\", skin);\n \t\t\telse if (selection == 1 || selection == 5) {\n \t\t\t\tfor each(var i in selection == 1 ? hair : fhair)\n-\t\t\t\t\thairnew.push(i);\n+\t\t\t\t\tpushIfItemExists(hairnew, i);\n \t\t\t\tcm.sendStyle(\"Pick one?\", hairnew);\n \t\t\t} else if (selection == 2) {\n \t\t\t\tvar baseHair = parseInt(cm.getPlayer().getHair() / 10) * 10;\n \t\t\t\tfor(var k = 0; k < 8; k++)\n-\t\t\t\t\thaircolor.push(baseHair + k);\n+\t\t\t\t\tpushIfItemExists(haircolor, baseHair + k);\n \t\t\t\tcm.sendStyle(\"Pick one?\", haircolor);\n \t\t\t} else if (selection == 3 || selection == 6) {\n \t\t\t\tfor each(var j in selection == 3 ? face : fface)\n-\t\t\t\t\tfacenew.push(j);\n+\t\t\t\t\tpushIfItemExists(facenew, j);\n \t\t\t\tcm.sendStyle(\"Pick one?\", facenew);\n \t\t\t} else if (selection == 4) {\n \t\t\t\tvar baseFace = parseInt(cm.getPlayer().getFace() / 1000) * 1000 + parseInt(cm.getPlayer().getFace() % 100);\n \t\t\t\tfor(var i = 0; i < 9; i++)\n-\t\t\t\t\tcolors.push(baseFace + (i*100));\n+\t\t\t\t\tpushIfItemExists(colors, baseFace + (i*100));\n \t\t\t\tcm.sendStyle(\"Pick one?\", colors);\n \t\t\t}\n \t\t} else {"}, {"sha": "3b2bb137960a09a345ac98589dfe20e86d9d4b39", "filename": "scripts/npc/credits.js", "status": "modified", "additions": 15, "deletions": 12, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/credits.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/scripts/npc/credits.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/credits.js?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -13,7 +13,7 @@ var name_cursor, role_cursor;\n \n // new server names are to be appended at the start of the name stack, building up the chronology.\n // make sure the server names are lexicograffically equivalent to their correspondent function.\n-var servers = [\"HeavenMS\", \"MapleSolaxia\", \"MoopleDEV\", \"MetroMS\", \"BubblesDEV\", \"ThePackII\", \"OdinMS\", \"Contributors\"];\n+var servers = [\"HeavenMS\", \"MapleSolaxia\", \"MoopleDEV\", \"MetroMS\", \"BubblesDEV\", \"OdinMS\", \"Contributors\"];\n var servers_history = [];\n \n function addPerson(name, role) {\n@@ -41,7 +41,7 @@ function writeServerStaff_HeavenMS() {\n         addPerson(\"Masterrulax\", \"Contributor\");\n         addPerson(\"MedicOP\", \"Adjunct Developer\");\n         \n-        setHistory(2015, 2018);\n+        setHistory(2015, 2019);\n }\n \n function writeServerStaff_MapleSolaxia() {\n@@ -58,26 +58,28 @@ function writeServerStaff_MapleSolaxia() {\n }\n \n function writeServerStaff_MoopleDEV() {\n-        addPerson(\"conan513\", \"Administrator\");\n         addPerson(\"kevintjuh93\", \"Developer\");\n+        addPerson(\"hindie93\", \"Contributor\");\n+        addPerson(\"JuniarZ-\", \"Contributor\");\n+        \n         setHistory(2010, 2012);\n }\n \n function writeServerStaff_MetroMS() {\n-        addPerson(\"Moogra\", \"Developer\");\n+        addPerson(\"David!\", \"Developer\");\n+        addPerson(\"XxOsirisxX\", \"Contributor\");\n+        addPerson(\"Generic\", \"Contributor\");\n+        \n         setHistory(2009, 2010);\n }\n \n function writeServerStaff_BubblesDEV() {\n-        addPerson(\"Deagan\", \"Administrator\");\n-        addPerson(\"XxOsirisxX\", \"Developer\");\n-        setHistory(2009, 2009);\n-}\n-\n-function writeServerStaff_ThePackII() {\n-        addPerson(\"Hofer\", \"Developer\");\n+        addPerson(\"David!\", \"Developer\");\n         addPerson(\"Moogra\", \"Developer\");\n-        setHistory(2008, 2009);\n+        addPerson(\"XxOsirisxX\", \"Contributor\");\n+        addPerson(\"MrMysterious\", \"Contributor\");\n+        \n+        setHistory(2009, 2009);\n }\n \n function writeServerStaff_OdinMS() {\n@@ -86,6 +88,7 @@ function writeServerStaff_OdinMS() {\n         addPerson(\"Patrick\", \"Developer\");\n         addPerson(\"Matze\", \"Developer\");\n         addPerson(\"Vimes\", \"Developer\");\n+        \n         setHistory(2007, 2008);\n }\n "}, {"sha": "6bd4014580c3986454efaaae72c1d6d2e17c1b01", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -12827,7 +12827,7 @@ CREATE TABLE IF NOT EXISTS `dueypackages` (\n   `ReceiverId` int(10) unsigned NOT NULL,\n   `SenderName` varchar(13) NOT NULL,\n   `Mesos` int(10) unsigned DEFAULT '0',\n-  `TimeStamp` varchar(10) NOT NULL,\n+  `TimeStamp` timestamp NOT NULL DEFAULT '2015-01-01 05:00:00',\n   `Message` varchar(200) NOT NULL DEFAULT \"\",\n   `Checked` tinyint(1) unsigned DEFAULT '1',\n   `Type` tinyint(1) unsigned DEFAULT '0',"}, {"sha": "764d5695ea2b36cef296300977d0198899c02dc5", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 32, "deletions": 25, "changes": 57, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -168,6 +168,7 @@\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n import org.apache.mina.util.ConcurrentHashSet;\n+import server.maps.FieldLimit;\n \n public class MapleCharacter extends AbstractMapleCharacterObject {\n     private static final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n@@ -2956,9 +2957,9 @@ public void run() {\n                             expiration = item.getExpiration();\n                             \n                             if (expiration != -1 && (expiration < currenttime) && ((item.getFlag() & ItemConstants.LOCK) == ItemConstants.LOCK)) {\n-                                byte aids = item.getFlag();\n-                                aids &= ~(ItemConstants.LOCK);\n-                                item.setFlag(aids); //Probably need a check, else people can make expiring items into permanent items...\n+                                short lock = item.getFlag();\n+                                lock &= ~(ItemConstants.LOCK);\n+                                item.setFlag(lock); //Probably need a check, else people can make expiring items into permanent items...\n                                 item.setExpiration(-1);\n                                 forceUpdateItem(item);   //TEST :3\n                             } else if (expiration != -1 && expiration < currenttime) {\n@@ -6099,7 +6100,8 @@ public boolean isMapObjectVisible(MapleMapObject mo) {\n     public boolean isPartyLeader() {\n         prtLock.lock();\n         try {\n-            return party.getLeaderId() == getId();\n+            MapleParty party = getParty();\n+            return party != null && party.getLeaderId() == getId();\n         } finally {\n             prtLock.unlock();\n         }\n@@ -6410,7 +6412,7 @@ public boolean leaveParty() {\n         prtLock.lock();\n         try {\n             party = getParty();\n-            partyLeader = party != null && isPartyLeader();\n+            partyLeader = isPartyLeader();\n         } finally {\n             prtLock.unlock();\n         }\n@@ -6932,7 +6934,7 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             ret.getInventory(MapleInventoryType.SETUP).setSlotLimit(rs.getByte(\"setupslots\"));\n             ret.getInventory(MapleInventoryType.ETC).setSlotLimit(rs.getByte(\"etcslots\"));\n             \n-            byte sandboxCheck = 0x0;\n+            short sandboxCheck = 0x0;\n             for (Pair<Item, MapleInventoryType> item : ItemFactory.INVENTORY.loadItems(ret.id, !channelserver)) {\n                 sandboxCheck |= item.getLeft().getFlag();\n                 \n@@ -7402,28 +7404,29 @@ private void playerDead() {\n         if (possesed > 0) {\n             message(\"You have used a safety charm, so your EXP points have not been decreased.\");\n             MapleInventoryManipulator.removeById(client, ItemConstants.getInventoryType(charmID[i]), charmID[i], 1, true, false);\n-        } else if (mapid > 925020000 && mapid < 925030000) {\n-            this.dojoStage = 0;\n         } else if (getJob() != MapleJob.BEGINNER) { //Hmm...\n-            int XPdummy = ExpTable.getExpNeededForLevel(getLevel());\n-            if (getMap().isTown()) {\n-                XPdummy /= 100;\n-            }\n-            if (XPdummy == ExpTable.getExpNeededForLevel(getLevel())) {\n-                if (getLuk() <= 100 && getLuk() > 8) {\n-                    XPdummy *= (200 - getLuk()) / 2000;\n-                } else if (getLuk() < 8) {\n-                    XPdummy /= 10;\n+            if (!FieldLimit.NO_EXP_DECREASE.check(getMap().getFieldLimit())) {  // thanks Conrad for noticing missing FieldLimit check\n+                int XPdummy = ExpTable.getExpNeededForLevel(getLevel());\n+                if (getMap().isTown()) {\n+                    XPdummy /= 100;\n+                }\n+                if (XPdummy == ExpTable.getExpNeededForLevel(getLevel())) {\n+                    if (getLuk() <= 100 && getLuk() > 8) {\n+                        XPdummy *= (200 - getLuk()) / 2000;\n+                    } else if (getLuk() < 8) {\n+                        XPdummy /= 10;\n+                    } else {\n+                        XPdummy /= 20;\n+                    }\n+                }\n+                if (getExp() > XPdummy) {\n+                    loseExp(XPdummy, false, false);\n                 } else {\n-                    XPdummy /= 20;\n+                    loseExp(getExp(), false, false);\n                 }\n             }\n-            if (getExp() > XPdummy) {\n-                loseExp(XPdummy, false, false);\n-            } else {\n-                loseExp(getExp(), false, false);\n-            }\n         }\n+        \n         if (getBuffedValue(MapleBuffStat.MORPH) != null) {\n             cancelEffectFromBuffStat(MapleBuffStat.MORPH);\n         }\n@@ -9168,10 +9171,10 @@ private static boolean hasMergeFlag(Item item) {\n     }\n     \n     private static void setMergeFlag(Item item) {\n-        int flag = item.getFlag();\n+        short flag = item.getFlag();\n         flag |= ItemConstants.MERGE_UNTRADEABLE;\n         flag |= ItemConstants.UNTRADEABLE;\n-        item.setFlag((byte) flag);\n+        item.setFlag(flag);\n     }\n     \n     private List<Equip> getUpgradeableEquipped() {\n@@ -9911,6 +9914,10 @@ public String getAreaInfo(int area) {\n     }\n \n     public void autoban(String reason) {\n+        if (this.isGM() || this.isBanned()){  // thanks RedHat for noticing GM's being able to get banned\n+            return;\n+        }\n+        \n         this.ban(reason);\n         announce(MaplePacketCreator.sendPolice(String.format(\"You have been blocked by the#b %s Police for HACK reason.#k\", \"HeavenMS\")));\n         TimerManager.getInstance().schedule(new Runnable() {"}, {"sha": "a3da53638793982ec2ae2314584ab7fae91ae5f6", "filename": "src/client/autoban/AutobanManager.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/autoban/AutobanManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/autoban/AutobanManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/autoban/AutobanManager.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -33,10 +33,11 @@ public AutobanManager(MapleCharacter chr) {\n     }\n \n     public void addPoint(AutobanFactory fac, String reason) {\n-    \tif (chr.isGM() || chr.isBanned()){\n-    \t\treturn;\n-    \t}\n     \tif (ServerConstants.USE_AUTOBAN) {\n+            if (chr.isGM() || chr.isBanned()){\n+                    return;\n+            }\n+            \n             if (lastTime.containsKey(fac)) {\n                 if (lastTime.get(fac) < (Server.getInstance().getCurrentTime() - fac.getExpire())) {\n                     points.put(fac, points.get(fac) / 2); //So the points are not completely gone."}, {"sha": "e59df0d908b6eeb2f0f95b0a63235da0fd9a2974", "filename": "src/client/command/commands/gm2/ItemCommand.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/ItemCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/ItemCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/ItemCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -77,12 +77,12 @@ public void execute(MapleClient c, String[] params) {\n                 }\n         }\n         \n-        byte flag = 0;\n+        short flag = 0;\n         if(player.gmLevel() < 3) {\n                 flag |= ItemConstants.ACCOUNT_SHARING;\n                 flag |= ItemConstants.UNTRADEABLE;\n         }\n-\n+        \n         MapleInventoryManipulator.addById(c, itemId, quantity, player.getName(), -1, flag, -1);\n     }\n }"}, {"sha": "2185fd7df55823e734cc2cc814069eb9f6cd3fa7", "filename": "src/client/command/commands/gm2/ItemDropCommand.java", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/ItemDropCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/ItemDropCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/ItemDropCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -75,12 +75,12 @@ public void execute(MapleClient c, String[] params) {\n \n                 toDrop.setOwner(\"\");\n                 if(player.gmLevel() < 3) {\n-                    byte b = toDrop.getFlag();\n-                    b |= ItemConstants.ACCOUNT_SHARING;\n-                    b |= ItemConstants.UNTRADEABLE;\n-                    b |= ItemConstants.SANDBOX;\n+                    short f = toDrop.getFlag();\n+                    f |= ItemConstants.ACCOUNT_SHARING;\n+                    f |= ItemConstants.UNTRADEABLE;\n+                    f |= ItemConstants.SANDBOX;\n                     \n-                    toDrop.setFlag(b);\n+                    toDrop.setFlag(f);\n                     toDrop.setOwner(\"TRIAL-MODE\");\n                 }\n \n@@ -102,12 +102,12 @@ public void execute(MapleClient c, String[] params) {\n \n         toDrop.setOwner(player.getName());\n         if(player.gmLevel() < 3) {\n-            byte b = toDrop.getFlag();\n-            b |= ItemConstants.ACCOUNT_SHARING;\n-            b |= ItemConstants.UNTRADEABLE;\n-            b |= ItemConstants.SANDBOX;\n+            short f = toDrop.getFlag();\n+            f |= ItemConstants.ACCOUNT_SHARING;\n+            f |= ItemConstants.UNTRADEABLE;\n+            f |= ItemConstants.SANDBOX;\n \n-            toDrop.setFlag(b);\n+            toDrop.setFlag(f);\n             toDrop.setOwner(\"TRIAL-MODE\");\n         }\n "}, {"sha": "fb43fac4340b2fe23b3cc365220396cce8ab4911", "filename": "src/client/command/commands/gm2/LootCommand.java", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/LootCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm2/LootCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/LootCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,51 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server, commands OdinMS-based\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+/*\n+   @Author: Resinate\n+*/\n+package client.command.commands.gm2;\n+\n+import client.MapleClient;\n+import client.command.Command;\n+import java.util.Arrays;\n+import java.util.List;\n+import server.maps.MapleMapItem;\n+import server.maps.MapleMapObject;\n+import server.maps.MapleMapObjectType;\n+\n+public class LootCommand extends Command {\n+\n+    {\n+        setDescription(\"Loots all items that belong to you.\");\n+    }\n+\n+    @Override\n+    public void execute(MapleClient c, String[] params) {\n+        List<MapleMapObject> items = c.getPlayer().getMap().getMapObjectsInRange(c.getPlayer().getPosition(), Double.POSITIVE_INFINITY, Arrays.asList(MapleMapObjectType.ITEM));\n+        for (MapleMapObject item : items) {\n+            MapleMapItem mapItem = (MapleMapItem) item;\n+            if (mapItem.getOwnerId() == c.getPlayer().getId() || mapItem.getOwnerId() == c.getPlayer().getPartyId()) {\n+                c.getPlayer().pickupItem(mapItem);\n+            }\n+        }\n+\n+    }\n+}"}, {"sha": "0e5464259e1cbd4d7f44b729386951ffba8552c9", "filename": "src/client/command/commands/gm4/PapCommand.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/PapCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/PapCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/PapCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -36,6 +36,8 @@\n     @Override\n     public void execute(MapleClient c, String[] params) {\n         MapleCharacter player = c.getPlayer();\n-        player.getMap().spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(8510000), player.getPosition());\n+        \n+        // thanks Conrad for noticing mobid typo here\n+        player.getMap().spawnMonsterOnGroundBelow(MapleLifeFactory.getMonster(8500001), player.getPosition());\n     }\n }"}, {"sha": "551a98b10cecc331941664c7aabd811797c7210a", "filename": "src/client/command/commands/gm4/ProItemCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/ProItemCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/ProItemCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/ProItemCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -84,7 +84,7 @@ private static void hardsetItemStats(Equip equip, short stat, short spdjmp) {\n         equip.setHp(stat);\n         equip.setMp(stat);\n \n-        byte flag = equip.getFlag();\n+        short flag = equip.getFlag();\n         flag |= ItemConstants.UNTRADEABLE;\n         equip.setFlag(flag);\n     }"}, {"sha": "e1f623bd1415108f9a8d274c8a8b009ffe66ac4f", "filename": "src/client/command/commands/gm4/SetEqStatCommand.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/SetEqStatCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/command/commands/gm4/SetEqStatCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm4/SetEqStatCommand.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -68,7 +68,7 @@ public void execute(MapleClient c, String[] params) {\n                 eq.setStr(newStat);\n                 eq.setLuk(newStat);\n \n-                byte flag = eq.getFlag();\n+                short flag = eq.getFlag();\n                 flag |= ItemConstants.UNTRADEABLE;\n                 eq.setFlag(flag);\n "}, {"sha": "93f9ff038781f1d3da1d6e847620f620b1d8c7d4", "filename": "src/client/inventory/Equip.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/Equip.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/Equip.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Equip.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -64,7 +64,8 @@ private StatUpgrade(int value) {\n     }\n     \n     private byte upgradeSlots;\n-    private byte level, flag, itemLevel;\n+    private byte level, itemLevel;\n+    private short flag;\n     private short str, dex, _int, luk, hp, mp, watk, matk, wdef, mdef, acc, avoid, hands, speed, jump, vicious;\n     private float itemExp;\n     private int ringid = -1;\n@@ -117,7 +118,7 @@ public Item copy() {\n     }\n \n     @Override\n-    public byte getFlag() {\n+    public short getFlag() {\n         return flag;\n     }\n \n@@ -195,7 +196,7 @@ public short getVicious() {\n     }\n \n     @Override\n-    public void setFlag(byte flag) {\n+    public void setFlag(short flag) {\n         this.flag = flag;\n     }\n "}, {"sha": "49417464c96bf0ae3ee0576c42cf1943f6def9c9", "filename": "src/client/inventory/Item.java", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/Item.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/Item.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/Item.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -40,7 +40,7 @@\n     private MaplePet pet = null;\n     private String owner = \"\";\n     protected List<String> log;\n-    private byte flag;\n+    private short flag;\n     private long expiration = -1;\n     private String giftFrom = \"\";\n \n@@ -146,11 +146,16 @@ public String toString() {\n         return Collections.unmodifiableList(log);\n     }\n \n-    public byte getFlag() {\n+    public short getFlag() {\n         return flag;\n     }\n \n-    public void setFlag(byte b) {\n+    public void setFlag(short b) {\n+        MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n+        if (ii.isAccountRestricted(id)) {\n+            b |= ItemConstants.ACCOUNT_SHARING; // thanks Shinigami15 for noticing ACCOUNT_SHARING flag not being applied properly to items server-side\n+        }\n+        \n         this.flag = b;\n     }\n "}, {"sha": "bce04120a0970492b62c5afb19c4eaa46d9e6c16", "filename": "src/client/inventory/ItemFactory.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/ItemFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/ItemFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/ItemFactory.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -97,7 +97,7 @@ private static Equip loadEquipFromResultSet(ResultSet rs) throws SQLException {\n         equip.setInt((short) rs.getInt(\"int\"));\n         equip.setJump((short) rs.getInt(\"jump\"));\n         equip.setVicious((short) rs.getInt(\"vicious\"));\n-        equip.setFlag((byte) rs.getInt(\"flag\"));\n+        equip.setFlag((short) rs.getInt(\"flag\"));\n         equip.setLuk((short) rs.getInt(\"luk\"));\n         equip.setMatk((short) rs.getInt(\"matk\"));\n         equip.setMdef((short) rs.getInt(\"mdef\"));\n@@ -177,7 +177,7 @@ private static Equip loadEquipFromResultSet(ResultSet rs) throws SQLException {\n                     item.setOwner(rs.getString(\"owner\"));\n                     item.setExpiration(rs.getLong(\"expiration\"));\n                     item.setGiftFrom(rs.getString(\"giftFrom\"));\n-                    item.setFlag((byte) rs.getInt(\"flag\"));\n+                    item.setFlag((short) rs.getInt(\"flag\"));\n                     items.add(new Pair<>(item, mit));\n                 }\n             }\n@@ -333,7 +333,7 @@ private void saveItemsCommon(List<Pair<Item, MapleInventoryType>> items, int id,\n                         item.setOwner(rs.getString(\"owner\"));\n                         item.setExpiration(rs.getLong(\"expiration\"));\n                         item.setGiftFrom(rs.getString(\"giftFrom\"));\n-                        item.setFlag((byte) rs.getInt(\"flag\"));\n+                        item.setFlag((short) rs.getInt(\"flag\"));\n                         items.add(new Pair<>(item, mit));\n                     }\n                 }"}, {"sha": "cb88ca74198a85abf65bd7f9c106d070bacfd292", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -68,7 +68,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n         return addById(c, itemId, quantity, owner, petid, (byte) 0, expiration);\n     }\n \n-    public static boolean addById(MapleClient c, int itemId, short quantity, String owner, int petid, byte flag, long expiration) {\n+    public static boolean addById(MapleClient c, int itemId, short quantity, String owner, int petid, short flag, long expiration) {\n         MapleCharacter chr = c.getPlayer();\n         MapleInventoryType type = ItemConstants.getInventoryType(itemId);\n         \n@@ -90,7 +90,7 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n         }\n     }\n     \n-    private static boolean addByIdInternal(MapleClient c, MapleCharacter chr, MapleInventoryType type, MapleInventory inv, int itemId, short quantity, String owner, int petid, byte flag, long expiration) {\n+    private static boolean addByIdInternal(MapleClient c, MapleCharacter chr, MapleInventoryType type, MapleInventory inv, int itemId, short quantity, String owner, int petid, short flag, long expiration) {\n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n         if (!type.equals(MapleInventoryType.EQUIP)) {\n             short slotMax = ii.getSlotMax(c, itemId);"}, {"sha": "faf3d5fc89ddd85673abfcd4566ffbf10ac16d23", "filename": "src/client/inventory/manipulator/MapleKarmaManipulator.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/manipulator/MapleKarmaManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/inventory/manipulator/MapleKarmaManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleKarmaManipulator.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -27,18 +27,18 @@\n  * @author RonanLana\n  */\n public class MapleKarmaManipulator {\n-    private static int getKarmaFlag(Item item) {\n+    private static short getKarmaFlag(Item item) {\n         return item.getItemType() == 1 ? ItemConstants.KARMA_EQP : ItemConstants.KARMA_USE;\n     }\n     \n     public static boolean hasKarmaFlag(Item item) {\n-        int karmaFlag = getKarmaFlag(item);\n+        short karmaFlag = getKarmaFlag(item);\n         return (item.getFlag() & karmaFlag) == karmaFlag;\n     }\n \n     public static void toggleKarmaFlagToUntradeable(Item item) {\n-        int karmaFlag = getKarmaFlag(item);\n-        int flag = item.getFlag();\n+        short karmaFlag = getKarmaFlag(item);\n+        short flag = item.getFlag();\n         \n         if ((flag & karmaFlag) == karmaFlag) {\n             flag ^= karmaFlag;\n@@ -49,8 +49,8 @@ public static void toggleKarmaFlagToUntradeable(Item item) {\n     }\n     \n     public static void setKarmaFlag(Item item) {\n-        int karmaFlag = getKarmaFlag(item);\n-        int flag = item.getFlag();\n+        short karmaFlag = getKarmaFlag(item);\n+        short flag = item.getFlag();\n         \n         flag |= karmaFlag;\n         flag &= (0xFFFFFFFF ^ ItemConstants.UNTRADEABLE);"}, {"sha": "793b0c179e964d38e60dfd8e044a7b47078364b5", "filename": "src/client/processor/DueyProcessor.java", "status": "modified", "additions": 45, "deletions": 13, "changes": 58, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/processor/DueyProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/client/processor/DueyProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/DueyProcessor.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -39,6 +39,7 @@\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.sql.Statement;\n+import java.sql.Timestamp;\n import java.util.Calendar;\n import java.util.Collections;\n import java.util.LinkedList;\n@@ -112,21 +113,13 @@ public byte getCode() {\n         return null;\n     }\n     \n-    private static String getCurrentDate(boolean quick) {\n-        String date = \"\";\n+    private static Timestamp getCurrentDate(boolean quick) {\n         Calendar cal = Calendar.getInstance();\n         if (!quick) {\n             cal.add(Calendar.DATE, 1);\n         }\n         \n-        int day = cal.get(Calendar.DATE);\n-        int month = cal.get(Calendar.MONTH) + 1; // its an array of months.\n-        int year = cal.get(Calendar.YEAR);\n-        date += day <= 9 ? \"0\" + day + \"-\" : \"\" + day + \"-\";\n-        date += month <= 9 ? \"0\" + month + \"-\" : \"\" + month + \"-\";\n-        date += year;\n-        \n-        return date;\n+        return new Timestamp(cal.getTime().getTime());\n     }\n     \n     private static void showDueyNotification(MapleClient c, MapleCharacter player) {\n@@ -211,7 +204,7 @@ private static DueyPackage getPackageFromDB(ResultSet rs) {\n             \n             dueypack.setSender(rs.getString(\"SenderName\"));\n             dueypack.setMesos(rs.getInt(\"Mesos\"));\n-            dueypack.setSentTime(rs.getString(\"TimeStamp\"));\n+            dueypack.setSentTime(rs.getTimestamp(\"TimeStamp\"));\n             dueypack.setMessage(rs.getString(\"Message\"));\n             \n             return dueypack;\n@@ -257,7 +250,7 @@ private static int createPackage(int mesos, String message, String sender, int t\n                 ps.setInt(1, toCid);\n                 ps.setString(2, sender);\n                 ps.setInt(3, mesos);\n-                ps.setString(4, getCurrentDate(quick));\n+                ps.setTimestamp(4, getCurrentDate(quick));\n                 ps.setString(5, message);\n                 ps.setInt(6, quick ? 1 : 0);\n \n@@ -468,11 +461,16 @@ public static void dueyClaimPackage(MapleClient c, int packageId) {\n                     }\n                     con.close();\n                     \n-                    if(dp == null) {\n+                    if (dp == null) {\n                         c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_UNKNOWN_ERROR.getCode()));\n                         FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to receive package from duey with id \" + packageId);\n                         return;\n                     }\n+                    \n+                    if (dp.isDeliveringTime()) {\n+                        c.announce(MaplePacketCreator.sendDueyMSG(Actions.TOCLIENT_RECV_UNKNOWN_ERROR.getCode()));\n+                        return;\n+                    }\n \n                     Item dpItem = dp.getItem();\n                     if (dpItem != null) {\n@@ -530,4 +528,38 @@ public static void dueyCreatePackage(Item item, int mesos, String sender, int re\n             insertPackageItem(packageId, item);\n         }\n     }\n+    \n+    public static void runDueyExpireSchedule() {\n+        try {\n+            Calendar c = Calendar.getInstance();\n+            c.add(Calendar.DATE, -30);\n+            \n+            Timestamp ts = new Timestamp(c.getTime().getTime());\n+            \n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"SELECT `PackageId` FROM dueypackages WHERE `TimeStamp` < ?\");\n+            ps.setTimestamp(1, ts);\n+            \n+            List<Integer> toRemove = new LinkedList<>();\n+            try (ResultSet rs = ps.executeQuery()) {\n+                while (rs.next()) {\n+                    toRemove.add(rs.getInt(\"PackageId\"));\n+                }\n+            }\n+            ps.close();\n+            \n+            for (Integer pid : toRemove) {\n+                removePackageFromDB(pid);\n+            }\n+            \n+            ps = con.prepareStatement(\"DELETE FROM dueypackages WHERE `TimeStamp` < ?\");\n+            ps.setTimestamp(1, ts);\n+            ps.executeUpdate();\n+            ps.close();\n+            \n+            con.close();\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+        }\n+    }\n }"}, {"sha": "c3ff38e45821b3d3b0c3117f94986beb93447a1d", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -35,16 +35,16 @@\n public final class ItemConstants {\n     protected static Map<Integer, MapleInventoryType> inventoryTypeCache = new HashMap<>();\n     \n-    public final static int LOCK = 0x01;\n-    public final static int SPIKES = 0x02;\n-    public final static int KARMA_USE = 0x02;\n-    public final static int COLD = 0x04;\n-    public final static int UNTRADEABLE = 0x08;\n-    public final static int KARMA_EQP = 0x10;\n-    public final static int SANDBOX = 0x40;             // let 0x40 until it's proven something uses this\n-    public final static int PET_COME = 0x80;\n-    public final static int ACCOUNT_SHARING = 0x100;\n-    public final static int MERGE_UNTRADEABLE = 0x200;\n+    public final static short LOCK = 0x01;\n+    public final static short SPIKES = 0x02;\n+    public final static short KARMA_USE = 0x02;\n+    public final static short COLD = 0x04;\n+    public final static short UNTRADEABLE = 0x08;\n+    public final static short KARMA_EQP = 0x10;\n+    public final static short SANDBOX = 0x40;             // let 0x40 until it's proven something uses this\n+    public final static short PET_COME = 0x80;\n+    public final static short ACCOUNT_SHARING = 0x100;\n+    public final static short MERGE_UNTRADEABLE = 0x200;\n \n     public final static boolean EXPIRING_ITEMS = true;\n     public final static Set<Integer> permanentItemids = new HashSet<>();\n@@ -147,7 +147,7 @@ public static boolean isModifierScroll(int scrollId) {\n         return scrollId == 2040727 || scrollId == 2041058;\n     }\n     \n-    public static boolean isFlagModifier(int scrollId, byte flag) {\n+    public static boolean isFlagModifier(int scrollId, short flag) {\n         if(scrollId == 2041058 && ((flag & ItemConstants.COLD) == ItemConstants.COLD)) return true;\n         if(scrollId == 2040727 && ((flag & ItemConstants.SPIKES) == ItemConstants.SPIKES)) return true;\n         return false;"}, {"sha": "4959f1e1d28b3a8555871c97bba0567d3e391884", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -116,9 +116,10 @@\n     public static final boolean USE_NPCS_SCRIPTABLE = true;         //Flag to enable/disable serverside predefined script NPCs.\n     \n     //Events/PQs Configuration\n-    public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;  //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n-    public static final boolean USE_ENABLE_SOLO_EXPEDITIONS = true; //Enables start expeditions with any number of players. This will also bypass all the Zakum prequest.\n-    public static final boolean USE_ENABLE_RECALL_EVENT = true;     //Enables a disconnected player to reaccess the last event instance they were in before logging out. Recall only works if the event isn't cleared or disposed yet. Suggestion thanks to Alisson (Goukken).\n+    public static final boolean USE_OLD_GMS_STYLED_PQ_NPCS = true;   //Enables PQ NPCs with similar behaviour to old GMS style, that skips info about the PQs and immediately tries to register the party in.\n+    public static final boolean USE_ENABLE_SOLO_EXPEDITIONS = true;  //Enables start expeditions with any number of players. This will also bypass all the Zakum prequest.\n+    public static final boolean USE_ENABLE_DAILY_EXPEDITIONS = false;//Enables daily entry limitations in expeditions.\n+    public static final boolean USE_ENABLE_RECALL_EVENT = false;      //Enables a disconnected player to reaccess the last event instance they were in before logging out. Recall only works if the event isn't cleared or disposed yet. Suggestion thanks to Alisson (Goukken).\n     \n     //Announcement Configuration\n     public static final boolean USE_ANNOUNCE_SHOPITEMSOLD = false;  //Automatic message sent to owner when an item from the Player Shop or Hired Merchant is sold.\n@@ -210,6 +211,7 @@\n     public static final boolean USE_FAST_REUSE_HERO_WILL = true;//Greatly reduce cooldown on Hero's Will.\n     public static final boolean USE_ANTI_IMMUNITY_CRASH = true; //Crash skills additionally removes the mob's invincibility buffs. Suggestion thanks to Celestial.\n     public static final boolean USE_UNDISPEL_HOLY_SHIELD = true;//Holy shield buff also prevents players from suffering dispel from mobs.\n+    public static final boolean USE_FULL_HOLY_SYMBOL = true;    //Holy symbol doesn't require EXP sharers to work in full.\n     \n     //Character Configuration\n     public static final boolean USE_ADD_SLOTS_BY_LEVEL = true;  //Slots are added each 20 levels."}, {"sha": "7564cf3a0bcc748cba112bb5f900e34a33d081c1", "filename": "src/net/opcodes/SendOpcode.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/opcodes/SendOpcode.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/opcodes/SendOpcode.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/opcodes/SendOpcode.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -182,7 +182,7 @@\n     CONTI_STATE(0x95),\n     SET_QUEST_CLEAR(0x96),\n     SET_QUEST_TIME(0x97),\n-    WARN_MESSAGE(0x98),\n+    ARIANT_RESULT(0x98),    // thanks lrenex\n     SET_OBJECT_STATE(0x99),\n     STOP_CLOCK(0x9A),\n     ARIANT_ARENA_SHOW_RESULT(0x9B),\n@@ -302,7 +302,7 @@\n     ARIANT_ARENA_USER_SCORE(0x129),\n     SHEEP_RANCH_INFO(0x12B),\n     SHEEP_RANCH_CLOTHES(0x12C),\n-    ARIANT_SCORE(0x12D),\n+    WITCH_TOWER_SCORE_UPDATE(0x12D),    // thanks lrenex\n     HORNTAIL_CAVE(0x12E),\n     ZAKUM_SHRINE(0x12F),\n     NPC_TALK(0x130),"}, {"sha": "1caaf8e61492f9c2a42069f7e54403b0e7ff11b9", "filename": "src/net/server/Server.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -61,13 +61,14 @@\n import net.server.worker.CharacterDiseaseWorker;\n import net.server.worker.CouponWorker;\n import net.server.worker.EventRecallCoordinatorWorker;\n-import net.server.worker.FredrickWorker;\n+import net.server.worker.DueyFredrickWorker;\n import net.server.worker.InvitationWorker;\n import net.server.worker.LoginCoordinatorWorker;\n import net.server.worker.LoginStorageWorker;\n import net.server.worker.RankingCommandWorker;\n import net.server.worker.RankingLoginWorker;\n import net.server.worker.ReleaseLockWorker;\n+import net.server.worker.RespawnWorker;\n import net.server.world.World;\n \n import org.apache.mina.core.buffer.IoBuffer;\n@@ -904,8 +905,9 @@ public void init() {\n         tMan.register(new LoginCoordinatorWorker(), 60 * 60 * 1000, timeLeft);\n         tMan.register(new EventRecallCoordinatorWorker(), 60 * 60 * 1000, timeLeft);\n         tMan.register(new LoginStorageWorker(), 2 * 60 * 1000, 2 * 60 * 1000);\n-        tMan.register(new FredrickWorker(), 60 * 60 * 1000, 60 * 60 * 1000);\n+        tMan.register(new DueyFredrickWorker(), 60 * 60 * 1000, timeLeft);\n         tMan.register(new InvitationWorker(), 30 * 1000, 30 * 1000);\n+        tMan.register(new RespawnWorker(), ServerConstants.RESPAWN_INTERVAL, ServerConstants.RESPAWN_INTERVAL);\n         \n         timeLeft = getTimeLeftForNextDay();\n         MapleExpeditionBossLog.resetBossLogTable();"}, {"sha": "99f92ffbb80029bbbb72acc9e95f2abbbe826461", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -49,7 +49,6 @@\n import client.MapleBuffStat;\n import client.MapleCharacter;\n import client.MapleJob;\n-import client.MapleStat;\n import client.Skill;\n import client.SkillFactory;\n import client.autoban.AutobanFactory;\n@@ -650,7 +649,7 @@ protected AttackInfo parseDamage(LittleEndianAccessor lea, MapleCharacter chr, b\n         \n         // Find the base damage to base futher calculations on.\n         // Several skills have their own formula in this section.\n-        int calcDmgMax = 0;\t\n+        long calcDmgMax = 0;\t\n         \n         if(magic && ret.skill != 0) {\n             calcDmgMax = (chr.getTotalMagic() * chr.getTotalMagic() / 1000 + chr.getTotalMagic()) / 30 + chr.getTotalInt() / 200;\n@@ -714,15 +713,15 @@ protected AttackInfo parseDamage(LittleEndianAccessor lea, MapleCharacter chr, b\n             if(comboBuff > 6) {\n                 // Advanced Combo\n                 MapleStatEffect ceffect = SkillFactory.getSkill(advcomboid).getEffect(chr.getSkillLevel(advcomboid));\n-                calcDmgMax = (int) Math.floor(calcDmgMax * (ceffect.getDamage() + 50) / 100 + 0.20 + (comboBuff - 5) * 0.04);\n+                calcDmgMax = (long) Math.floor(calcDmgMax * (ceffect.getDamage() + 50) / 100 + 0.20 + (comboBuff - 5) * 0.04);\n             } else {\n                 // Normal Combo\n                 int skillLv = chr.getSkillLevel(oid);\n                 if(skillLv <= 0 || chr.isGM()) skillLv = SkillFactory.getSkill(oid).getMaxLevel();\n                 \n                 if(skillLv > 0) {\n                     MapleStatEffect ceffect = SkillFactory.getSkill(oid).getEffect(skillLv);\n-                    calcDmgMax = (int) Math.floor(calcDmgMax * (ceffect.getDamage() + 50) / 100 + Math.floor((comboBuff - 1) * (skillLv / 6)) / 100);\n+                    calcDmgMax = (long) Math.floor(calcDmgMax * (ceffect.getDamage() + 50) / 100 + Math.floor((comboBuff - 1) * (skillLv / 6)) / 100);\n                 }\n             }\n             \n@@ -850,7 +849,7 @@ else if(orbs >= 5)\n             \n             for (int j = 0; j < ret.numDamage; j++) {\n                     int damage = lea.readInt();\n-                    int hitDmgMax = calcDmgMax;\n+                    long hitDmgMax = calcDmgMax;\n                     if(ret.skill == Buccaneer.BARRAGE || ret.skill == ThunderBreaker.BARRAGE) {\n                         if(j > 3)\n                             hitDmgMax *= Math.pow(2, (j - 3));\n@@ -870,7 +869,7 @@ else if(orbs >= 5)\n                         hitDmgMax = 82569000; // 30% of Max HP of strongest Dojo boss\n                     }\n \n-                    int maxWithCrit = hitDmgMax;\n+                    long maxWithCrit = hitDmgMax;\n                     if(canCrit) // They can crit, so up the max.\n                             maxWithCrit *= 2;\n "}, {"sha": "9f7166c1e0b8675f6ccc95da2ede885a7e6d8f5a", "filename": "src/net/server/channel/handlers/DueyHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/DueyHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/DueyHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DueyHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -47,6 +47,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             String recipient = slea.readMapleAsciiString();\n             boolean quick = slea.readByte() != 0;\n             String message = quick ? slea.readMapleAsciiString() : \"\";\n+            \n             DueyProcessor.dueySendItem(c, inventId, itemPos, amount, mesos, message, recipient, quick);\n         } else if (operation == DueyProcessor.Actions.TOSERVER_REMOVE_PACKAGE.getCode()) {\n             int packageid = slea.readInt();"}, {"sha": "a3ff880cd301490fa20112ef4873c1bc97c9ae52", "filename": "src/net/server/channel/handlers/EnterMTSHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/EnterMTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/EnterMTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/EnterMTSHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -141,7 +141,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         equip.setInt((short) rs.getInt(\"int\"));\n                         equip.setJump((short) rs.getInt(\"jump\"));\n                         equip.setVicious((short) rs.getInt(\"vicious\"));\n-                        equip.setFlag((byte) rs.getInt(\"flag\"));\n+                        equip.setFlag((short) rs.getInt(\"flag\"));\n                         equip.setLuk((short) rs.getInt(\"luk\"));\n                         equip.setMatk((short) rs.getInt(\"matk\"));\n                         equip.setMdef((short) rs.getInt(\"mdef\"));\n@@ -209,7 +209,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rs.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n-                            equip.setFlag((byte) rs.getInt(\"flag\"));\n+                            equip.setFlag((short) rs.getInt(\"flag\"));\n                             items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                         }\n                     }\n@@ -256,7 +256,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rs.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n-                            equip.setFlag((byte) rs.getInt(\"flag\"));\n+                            equip.setFlag((short) rs.getInt(\"flag\"));\n                             items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                         }\n                     }"}, {"sha": "6ebd342c991216256172d3b441612edd78660ed7", "filename": "src/net/server/channel/handlers/MTSHandler.java", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/MTSHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/MTSHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MTSHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -321,7 +321,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rs.getInt(\"level\"));\n                             equip.setVicious((byte) rs.getInt(\"vicious\"));\n-                            equip.setFlag((byte) rs.getInt(\"flag\"));\n+                            equip.setFlag((short) rs.getInt(\"flag\"));\n                             equip.setPosition(c.getPlayer().getInventory(ItemConstants.getInventoryType(rs.getInt(\"itemid\"))).getNextFreeSlot());\n                             i = equip.copy();\n                         }\n@@ -568,7 +568,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n-                    equip.setFlag((byte) rs.getInt(\"flag\"));\n+                    equip.setFlag((short) rs.getInt(\"flag\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -623,7 +623,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                             equip.setWdef((short) rse.getInt(\"wdef\"));\n                             equip.setUpgradeSlots((byte) rse.getInt(\"upgradeslots\"));\n                             equip.setLevel((byte) rse.getInt(\"level\"));\n-                            equip.setFlag((byte) rs.getInt(\"flag\"));\n+                            equip.setFlag((short) rs.getInt(\"flag\"));\n                             items.add(new MTSItemInfo((Item) equip, rse.getInt(\"price\"), rse.getInt(\"id\"), rse.getInt(\"seller\"), rse.getString(\"sellername\"), rse.getString(\"sell_ends\")));\n                         }\n                     }\n@@ -686,7 +686,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n-                    equip.setFlag((byte) rs.getInt(\"flag\"));\n+                    equip.setFlag((short) rs.getInt(\"flag\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -747,7 +747,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n-                    equip.setFlag((byte) rs.getInt(\"flag\"));\n+                    equip.setFlag((short) rs.getInt(\"flag\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }\n@@ -841,7 +841,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     equip.setWdef((short) rs.getInt(\"wdef\"));\n                     equip.setUpgradeSlots((byte) rs.getInt(\"upgradeslots\"));\n                     equip.setLevel((byte) rs.getInt(\"level\"));\n-                    equip.setFlag((byte) rs.getInt(\"flag\"));\n+                    equip.setFlag((short) rs.getInt(\"flag\"));\n                     items.add(new MTSItemInfo((Item) equip, rs.getInt(\"price\"), rs.getInt(\"id\"), rs.getInt(\"seller\"), rs.getString(\"sellername\"), rs.getString(\"sell_ends\")));\n                 }\n             }"}, {"sha": "bdc8f692b0fd83e0b18e9d6bd33df324b7b50855", "filename": "src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "status": "modified", "additions": 18, "deletions": 15, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/MobDamageMobFriendlyHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -22,6 +22,7 @@\n package net.server.channel.handlers;\n \n import net.AbstractMaplePacketHandler;\n+import scripting.event.EventInstanceManager;\n import server.life.MapleMonster;\n import server.maps.MapleMap;\n import tools.MaplePacketCreator;\n@@ -40,47 +41,49 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\tint attacker = slea.readInt();\n \t\tslea.readInt();\n \t\tint damaged = slea.readInt();\n-\t\tMapleMonster monster = c.getPlayer().getMap().getMonsterByOid(damaged);\n+                \n+                MapleMap map = c.getPlayer().getMap();\n+\t\tMapleMonster monster = map.getMonsterByOid(damaged);\n \n-\t\tif (monster == null || c.getPlayer().getMap().getMonsterByOid(attacker) == null) {\n+\t\tif (monster == null || map.getMonsterByOid(attacker) == null) {\n \t\t\treturn;\n \t\t}\n \n \t\tint damage = Randomizer.nextInt(((monster.getMaxHp() / 13 + monster.getPADamage() * 10)) * 2 + 500) / 10; //Beng's formula.\n                 \n                 if (monster.getHp() - damage < 1) {     // friendly dies\n                         if(monster.getId() == 9300102) {\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Watch Hog has been injured by the aliens. Better luck next time...\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Watch Hog has been injured by the aliens. Better luck next time...\"));\n                         } else if (monster.getId() == 9300061) {  //moon bunny\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Moon Bunny went home because he was sick.\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Moon Bunny went home because he was sick.\"));\n                         } else if(monster.getId() == 9300093) {   //tylus\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Tylus has fallen by the overwhelming forces of the ambush.\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"Tylus has fallen by the overwhelming forces of the ambush.\"));\n                         } else if(monster.getId() == 9300137) {   //juliet\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Juliet has fainted in the middle of the combat.\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"Juliet has fainted in the middle of the combat.\"));\n                         } else if(monster.getId() == 9300138) {   //romeo\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Romeo has fainted in the middle of the combat.\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"Romeo has fainted in the middle of the combat.\"));\n                         } else if(monster.getId() == 9400322 || monster.getId() == 9400327 || monster.getId() == 9400332) { //snowman\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Snowman has melted on the heat of the battle.\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Snowman has melted on the heat of the battle.\"));\n                         } else if(monster.getId() == 9300162) {   //delli\n-                                monster.getMap().broadcastMessage(MaplePacketCreator.serverNotice(6, \"Delli vanished after the ambush, sheets still laying on the ground...\"));\n+                                map.broadcastMessage(MaplePacketCreator.serverNotice(6, \"Delli vanished after the ambush, sheets still laying on the ground...\"));\n                         }\n                         \n-                        c.getPlayer().getMap().killFriendlies(monster);\n+                        map.killFriendlies(monster);\n                 } else {\n-                        if (monster.getId() == 9300061) {\n-                                MapleMap map = c.getPlayer().getEventInstance().getMapInstance(monster.getMap().getId());\n-                                map.addBunnyHit();\n+                        EventInstanceManager eim = map.getEventInstance();\n+                        if (eim != null) {\n+                                eim.friendlyDamaged(monster);\n                         }\n                 }\n                 \n                 monster.applyAndGetHpDamage(damage, false);\n                 int remainingHp = monster.getHp();\n                 if(remainingHp <= 0) {\n                     remainingHp = 0;\n-                    monster.getMap().removeMapObject(monster);\n+                    map.removeMapObject(monster);\n                 }\n \n-\t\tc.getPlayer().getMap().broadcastMessage(MaplePacketCreator.MobDamageMobFriendly(monster, damage, remainingHp), monster.getPosition());\n+\t\tmap.broadcastMessage(MaplePacketCreator.MobDamageMobFriendly(monster, damage, remainingHp), monster.getPosition());\n \t\tc.announce(MaplePacketCreator.enableActions());\n \t}\n }\n\\ No newline at end of file"}, {"sha": "fcadb213dad511dfd897dd61e989c67b2be1c024", "filename": "src/net/server/channel/handlers/QuestActionHandler.java", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/QuestActionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/QuestActionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/QuestActionHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -72,7 +72,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         short questid = slea.readShort();\n         MapleCharacter player = c.getPlayer();\n         MapleQuest quest = MapleQuest.getInstance(questid);\n-        if (action == 1) { //Start Quest\n+        \n+        if (action == 0) { // Restore lost item, Credits Darter ( Rajan )\n+            slea.readInt();\n+            int itemid = slea.readInt();\n+            quest.restoreLostItem(player, itemid);\n+        } else if (action == 1) { //Start Quest\n             int npc = slea.readInt();\n             if(!isNpcNearby(slea, player, quest, npc)) {\n                 return;"}, {"sha": "08315c3a0b545e9c6445f5ef4b2dc54487c59732", "filename": "src/net/server/channel/handlers/SummonDamageHandler.java", "status": "modified", "additions": 10, "deletions": 20, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/SummonDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/SummonDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SummonDamageHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -28,9 +28,7 @@\n import client.autoban.AutobanFactory;\n import client.status.MonsterStatusEffect;\n import java.util.ArrayList;\n-import java.util.HashMap;\n import java.util.List;\n-import java.util.Map;\n import server.MapleStatEffect;\n import server.life.MapleMonster;\n import server.life.MapleMonsterInformationProvider;\n@@ -45,12 +43,10 @@\n \n         private int monsterOid;\n         private int damage;\n-        private boolean magic;\n-\n-        public SummonAttackEntry(int monsterOid, int damage, boolean magic) {\n+        \n+        public SummonAttackEntry(int monsterOid, int damage) {\n             this.monsterOid = monsterOid;\n             this.damage = damage;\n-            this.magic = magic;\n         }\n \n         public int getMonsterOid() {\n@@ -61,9 +57,6 @@ public int getDamage() {\n             return damage;\n         }\n         \n-        public boolean isMagic() {\n-            return magic;\n-        }\n     }\n \n     @Override\n@@ -91,27 +84,22 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         slea.skip(8); //Thanks Gerald :D, I failed lol (mob x,y and summon x,y)\n         for (int x = 0; x < numAttacked; x++) {\n             int monsterOid = slea.readInt(); // attacked oid\n-            slea.skip(17);\n-            boolean magic = slea.readByte() != 0;\n+            slea.skip(18);\n             int damage = slea.readInt();\n-            allDamage.add(new SummonAttackEntry(monsterOid, damage, magic));\n+            allDamage.add(new SummonAttackEntry(monsterOid, damage));\n         }\n         player.getMap().broadcastMessage(player, MaplePacketCreator.summonAttack(player.getId(), summon.getObjectId(), direction, allDamage), summon.getPosition());\n+        \n         if (player.getMap().isOwnershipRestricted(player)) {\n             return;\n         }\n         \n-        Map<Integer, Integer> maxDmgEntries = new HashMap<>();\n+        boolean magic = summonEffect.getWatk() == 0;\n+        int maxDmg = calcMaxDamage(summonEffect, player, magic);    // thanks Darter (YungMoozi) for reporting unchecked max dmg\n         for (SummonAttackEntry attackEntry : allDamage) {\n             int damage = attackEntry.getDamage();\n             MapleMonster target = player.getMap().getMonsterByOid(attackEntry.getMonsterOid());\n             if (target != null) {\n-                Integer maxDmg = maxDmgEntries.get(attackEntry.getMonsterOid());\n-                if (maxDmg == null) {\n-                    maxDmg = calcMaxDamage(summonEffect, player, attackEntry.isMagic());    // thanks Darter (YungMoozi) for reporting unchecked max dmg\n-                    maxDmgEntries.put(attackEntry.getMonsterOid(), maxDmg);\n-                }\n-                \n                 if (damage > maxDmg) {\n                     AutobanFactory.DAMAGE_HACK.alert(c.getPlayer(), \"Possible packet editing summon damage exploit.\");\n \n@@ -135,7 +123,9 @@ private static int calcMaxDamage(MapleStatEffect summonEffect, MapleCharacter pl\n         if (magic) {\n             maxDamage = player.calculateMaxBaseMagicDamage() * (0.05 * summonEffect.getMatk());\n         } else {\n-            maxDamage = player.calculateMaxBaseDamage(player.getTotalWatk()) * (0.021 * summonEffect.getWatk());\n+            int maxBaseDmg = player.calculateMaxBaseDamage(player.getTotalWatk());  // thanks Conrad for detecting some summons legitimately hitting over the calculated limit\n+            float summonDmgMod = (maxBaseDmg >= 438) ? 0.054f : 0.077f;\n+            maxDamage = maxBaseDmg * (summonDmgMod * summonEffect.getWatk());\n         }\n         \n         return (int) maxDamage;"}, {"sha": "31b75fee32e29d0dd4606aa7f29de0d708a8255c", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -189,7 +189,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 if (eq == null) { //Check if the type is EQUIPMENT?\n                     return;\n                 }\n-                byte flag = eq.getFlag();\n+                short flag = eq.getFlag();\n                 flag |= ItemConstants.LOCK;\n                 if (eq.getExpiration() > -1) {\n                     return; //No perma items pls"}, {"sha": "5287140931b5b5c477dba5080ca787c0e1ce9dc3", "filename": "src/net/server/worker/DueyFredrickWorker.java", "status": "renamed", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/worker/DueyFredrickWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/worker/DueyFredrickWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/DueyFredrickWorker.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -19,15 +19,17 @@\n */\n package net.server.worker;\n \n+import client.processor.DueyProcessor;\n import client.processor.FredrickProcessor;\n \n /**\n  * @author Ronan\n  */\n-public class FredrickWorker implements Runnable {\n+public class DueyFredrickWorker implements Runnable {\n     \n     @Override\n     public void run() {\n         FredrickProcessor.runFredrickSchedule();\n+        DueyProcessor.runDueyExpireSchedule();\n     }\n }", "previous_filename": "src/net/server/worker/FredrickWorker.java"}, {"sha": "3ea15c373f2ef9d018856b6c73b16ec6069144fd", "filename": "src/net/server/worker/RespawnWorker.java", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/worker/RespawnWorker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/worker/RespawnWorker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/worker/RespawnWorker.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,19 @@\n+package net.server.worker;\n+\n+import net.server.Server;\n+import net.server.channel.Channel;\n+\n+/**\n+ * @author Resinate\n+ */\n+public class RespawnWorker implements Runnable {\n+    \n+    @Override\n+    public void run() {\n+        for (Channel ch : Server.getInstance().getAllChannels()) {\n+            if (!ch.getPlayerStorage().getAllCharacters().isEmpty()) {\n+                ch.getMapFactory().updateMaps();\n+            }\n+        }\n+    }\n+}"}, {"sha": "8fdaaa4c3efd438e00d868fc82f8abe3188d7560", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -96,6 +96,8 @@\n import net.server.coordinator.MapleInviteCoordinator.InviteType;\n import net.server.coordinator.MapleMatchCheckerCoordinator;\n import net.server.coordinator.MaplePartySearchCoordinator;\n+import server.maps.MapleMiniDungeon;\n+import server.maps.MapleMiniDungeonInfo;\n \n /**\n  *\n@@ -927,10 +929,23 @@ public void updateParty(int partyid, PartyOperation operation, MaplePartyCharact\n                 break;\n             case CHANGE_LEADER:\n                 MapleCharacter mc = party.getLeader().getPlayer();\n+                MapleCharacter newLeader = target.getPlayer();\n+                \n                 EventInstanceManager eim = mc.getEventInstance();\n                 \n                 if(eim != null && eim.isEventLeader(mc)) {\n-                    eim.changedLeader(target.getPlayer());\n+                    eim.changedLeader(newLeader);\n+                } else {\n+                    int oldLeaderMapid = mc.getMapId();\n+                    \n+                    if (MapleMiniDungeonInfo.isDungeonMap(oldLeaderMapid)) {\n+                        if (oldLeaderMapid != newLeader.getMapId()) {\n+                            MapleMiniDungeon mmd = newLeader.getClient().getChannelServer().getMiniDungeon(oldLeaderMapid);\n+                            if(mmd != null) {\n+                                mmd.close();\n+                            }\n+                        }\n+                    }\n                 }\n                 party.setLeader(target);\n                 break;"}, {"sha": "29facd7c5619b1aabff469668c8348d3abc9541f", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -68,6 +68,7 @@\n import constants.ItemConstants;\n import constants.ServerConstants;\n import server.MapleMarriage;\n+import server.expeditions.MapleExpeditionBossLog;\n import server.life.MapleNPC;\n import tools.Pair;\n \n@@ -1067,13 +1068,24 @@ public Pyramid getPyramid() {\n \t\treturn (Pyramid) getPlayer().getPartyQuest();\n \t}\n \n-        public boolean createExpedition(MapleExpeditionType type) {\n+        public int createExpedition(MapleExpeditionType type) {\n                 return createExpedition(type, false, 0, 0);\n         }\n         \n-\tpublic boolean createExpedition(MapleExpeditionType type, boolean silent, int minPlayers, int maxPlayers) {\n-\t\tMapleExpedition exped = new MapleExpedition(getPlayer(), type, silent, minPlayers, maxPlayers);\n-\t\treturn exped.addChannelExpedition(getPlayer().getClient().getChannelServer());\n+\tpublic int createExpedition(MapleExpeditionType type, boolean silent, int minPlayers, int maxPlayers) {\n+                MapleCharacter player = getPlayer();\n+                MapleExpedition exped = new MapleExpedition(player, type, silent, minPlayers, maxPlayers);\n+                \n+                int channel = player.getMap().getChannelServer().getId();\n+                if (!MapleExpeditionBossLog.attemptBoss(player.getId(), channel, exped, false)) {    // thanks Conrad for noticing missing expeditions entry limit\n+                        return 1;\n+                }\n+                \n+                if (exped.addChannelExpedition(player.getClient().getChannelServer())) {\n+                        return 0;\n+                } else {\n+                        return -1;\n+                }\n \t}\n \n \tpublic void endExpedition(MapleExpedition exped) {"}, {"sha": "f70b46868435e0ffae44633e620fe656bd6ed65b", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -518,6 +518,18 @@ public void friendlyKilled(final MapleMonster mob, final boolean hasKiller) {\n                         invokeScriptFunction(\"friendlyKilled\", mob, EventInstanceManager.this, hasKiller);\n                 } catch (ScriptException | NoSuchMethodException ex) {} //optional\n \t}\n+        \n+        public void friendlyDamaged(final MapleMonster mob) {\n+                try {\n+                        invokeScriptFunction(\"friendlyDamaged\", EventInstanceManager.this, mob);\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n+\t}\n+        \n+        public void friendlyItemDrop(final MapleMonster mob) {\n+                try {\n+                        invokeScriptFunction(\"friendlyItemDrop\", EventInstanceManager.this, mob);\n+                } catch (ScriptException | NoSuchMethodException ex) {} // optional\n+\t}\n \n \tpublic void playerKilled(final MapleCharacter chr) {\n                 ThreadManager.getInstance().newTask(new Runnable() {"}, {"sha": "d4cd0e8f3c8e0a5c4408b60b05cbe4dd75854a36", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -678,6 +678,7 @@ public void cpqLobby(int field) {\n                     final MapleCharacter mc;\n                     mc = ps.getCharacterById(mpc.getId());\n                     if (mc != null) {\n+                        mc.setChallenged(false);\n                         mc.changeMap(map, map.getPortal(0));\n                         mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.getMessage(mc, LanguageConstants.CPQEntryLobby)));\n                         TimerManager tMan = TimerManager.getInstance();\n@@ -715,9 +716,8 @@ public void cancelCPQLobby() {\n             }\n         }\n         \n-        private void warpoutCPQLobby() {\n-            MapleMap lobbyMap = c.getPlayer().getMap();\n-            MapleMap out = this.getWarpMap((lobbyMap.getId() > 980030000) ? 980000000 : 980030000);\n+        private void warpoutCPQLobby(MapleMap lobbyMap) {\n+            MapleMap out = lobbyMap.getChannelServer().getMapFactory().getMap((lobbyMap.getId() < 980030000) ? 980000000 : 980030000);\n             for (MapleCharacter mc : lobbyMap.getAllPlayers()) {\n                 mc.resetCP();\n                 mc.setTeam(-1);\n@@ -729,6 +729,8 @@ private void warpoutCPQLobby() {\n         public void startCPQ(final MapleCharacter challenger, final int field) {\n             try {\n                 cancelCPQLobby();\n+                \n+                final MapleMap lobbyMap = getPlayer().getMap();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"Nao existe oponente!\");\n@@ -737,7 +739,7 @@ public void startCPQ(final MapleCharacter challenger, final int field) {\n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n                         MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                         if (mc != null) {\n-                            mc.changeMap(getPlayer().getMap(), getPlayer().getMap().getPortal(0));\n+                            mc.changeMap(lobbyMap, lobbyMap.getPortal(0));\n                             TimerManager tMan = TimerManager.getInstance();\n                             tMan.schedule(new Runnable() {\n                                 @Override\n@@ -776,7 +778,7 @@ public void run() {\n                                 mc.setMonsterCarnival(null);\n                             }\n                         } catch (NullPointerException npe) {\n-                            warpoutCPQLobby();\n+                            warpoutCPQLobby(lobbyMap);\n                             return;\n                         }\n                         \n@@ -791,6 +793,8 @@ public void run() {\n         public void startCPQ2(final MapleCharacter challenger, final int field) {\n             try {\n                 cancelCPQLobby();\n+                \n+                final MapleMap lobbyMap = getPlayer().getMap();\n                 if (challenger != null) {\n                     if (challenger.getParty() == null) {\n                         throw new RuntimeException(\"N\u00e3o existe oponente!\");\n@@ -799,7 +803,7 @@ public void startCPQ2(final MapleCharacter challenger, final int field) {\n                     for (MaplePartyCharacter mpc : challenger.getParty().getMembers()) {\n                         MapleCharacter mc = ps.getCharacterById(mpc.getId());\n                         if (mc != null) {\n-                            mc.changeMap(getPlayer().getMap(), getPlayer().getMap().getPortal(0));\n+                            mc.changeMap(lobbyMap, lobbyMap.getPortal(0));\n                             mapClock(10);\n                         }\n                     }\n@@ -820,7 +824,7 @@ public void run() {\n                                 mc.setMonsterCarnival(null);\n                             }\n                         } catch (NullPointerException npe) {\n-                            warpoutCPQLobby();\n+                            warpoutCPQLobby(lobbyMap);\n                             return;\n                         }\n                         \n@@ -895,6 +899,7 @@ public void cpqLobby2(int field) {\n                     final MapleCharacter mc;\n                     mc = ps.getCharacterById(mpc.getId());\n                     if (mc != null) {\n+                        mc.setChallenged(false);\n                         mc.changeMap(map, map.getPortal(0));\n                         mc.announce(MaplePacketCreator.serverNotice(6, LanguageConstants.getMessage(mc, LanguageConstants.CPQEntryLobby)));\n                         TimerManager tMan = TimerManager.getInstance();"}, {"sha": "a7f7f69671b175949230285c929ab817e0868e0b", "filename": "src/server/DueyPackage.java", "status": "modified", "additions": 27, "deletions": 11, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/DueyPackage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/DueyPackage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/DueyPackage.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -23,15 +23,14 @@\n \n import client.inventory.Item;\n import java.util.Calendar;\n+import java.sql.Timestamp;\n \n public class DueyPackage {\n     private String sender = null;\n     private Item item = null;\n     private int mesos = 0;\n     private String message = \"\";\n-    private int day;\n-    private int month;\n-    private int year;\n+    private Calendar timestamp;\n     private int packageId = 0;\n \n     public DueyPackage(int pId, Item item) {\n@@ -76,18 +75,35 @@ public int getPackageId() {\n     }\n \n     public long sentTimeInMilliseconds() {\n+        Calendar ts = timestamp;\n+        if (ts != null) {\n+            Calendar cal = Calendar.getInstance();\n+            cal.setTime(ts.getTime());\n+            cal.add(Calendar.MONTH, 1);  // duey representation is in an array of months.\n+\n+            return cal.getTimeInMillis();\n+        } else {\n+            return 0;\n+        }\n+    }\n+    \n+    public boolean isDeliveringTime() {\n+        Calendar ts = timestamp;\n+        if (ts != null) {\n+            return ts.getTimeInMillis() >= System.currentTimeMillis();\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    public void setSentTime(Timestamp ts) {\n         Calendar cal = Calendar.getInstance();\n-        cal.set(year, month, day);\n+        cal.setTimeInMillis(ts.getTime());\n         cal.set(Calendar.HOUR, 0);\n         cal.set(Calendar.MINUTE, 0);\n         cal.set(Calendar.SECOND, 0);\n         cal.set(Calendar.MILLISECOND, 0);\n-        return cal.getTimeInMillis();\n-    }\n-\n-    public void setSentTime(String sentTime) {\n-        day = Integer.parseInt(sentTime.substring(0, 2));\n-        month = Integer.parseInt(sentTime.substring(3, 5));\n-        year = Integer.parseInt(sentTime.substring(6, 10));\n+        \n+        this.timestamp = cal;\n     }\n }"}, {"sha": "9f669eb0b3dfcb8e7115f8f5d17083c78160eaa0", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -106,6 +106,7 @@ public static MapleItemInformationProvider getInstance() {\n     protected Map<Integer, String> nameCache = new HashMap<>();\n     protected Map<Integer, String> descCache = new HashMap<>();\n     protected Map<Integer, String> msgCache = new HashMap<>();\n+    protected Map<Integer, Boolean> accountItemRestrictionCache = new HashMap<>();\n     protected Map<Integer, Boolean> dropRestrictionCache = new HashMap<>();\n     protected Map<Integer, Boolean> pickupRestrictionCache = new HashMap<>();\n     protected Map<Integer, Integer> getMesoCache = new HashMap<>();\n@@ -1046,7 +1047,7 @@ public Item getEquipById(int equipId) {\n         return getEquipById(equipId, -1);\n     }\n \n-    Item getEquipById(int equipId, int ringId) {\n+    private Item getEquipById(int equipId, int ringId) {\n         Equip nEquip;\n         nEquip = new Equip(equipId, (byte) 0, ringId);\n         nEquip.setQuantity((short) 1);\n@@ -1084,11 +1085,11 @@ Item getEquipById(int equipId, int ringId) {\n                 } else if (stat.getKey().equals(\"tuc\")) {\n                     nEquip.setUpgradeSlots((byte) stat.getValue().intValue());\n                 } else if (isUntradeableRestricted(equipId)) {  // thanks Hyun & Thora for showing an issue with more than only \"Untradeable\" items being flagged as such here\n-                    byte flag = nEquip.getFlag();\n+                    short flag = nEquip.getFlag();\n                     flag |= ItemConstants.UNTRADEABLE;\n                     nEquip.setFlag(flag);\n                 } else if (stats.get(\"fs\") > 0) {\n-                    byte flag = nEquip.getFlag();\n+                    short flag = nEquip.getFlag();\n                     flag |= ItemConstants.SPIKES;\n                     nEquip.setFlag(flag);\n                     equipCache.put(equipId, nEquip);\n@@ -1230,6 +1231,23 @@ public boolean isUntradeableRestricted(int itemId) {\n         untradeableCache.put(itemId, bRestricted);\n         return bRestricted;\n     }\n+    \n+    public boolean isAccountRestricted(int itemId) {\n+        if (accountItemRestrictionCache.containsKey(itemId)) {\n+            return accountItemRestrictionCache.get(itemId);\n+        }\n+\n+        boolean bRestricted = false;\n+        if(itemId != 0) {\n+            MapleData data = getItemData(itemId);\n+            if (data != null) {\n+                bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n+            }\n+        }\n+\n+        accountItemRestrictionCache.put(itemId, bRestricted);\n+        return bRestricted;\n+    }\n \n     public boolean isLootRestricted(int itemId) {\n         if (dropRestrictionCache.containsKey(itemId)) {\n@@ -1242,7 +1260,7 @@ public boolean isLootRestricted(int itemId) {\n             if (data != null) {\n                 bRestricted = MapleDataTool.getIntConvert(\"info/tradeBlock\", data, 0) == 1;\n                 if (!bRestricted) {\n-                    bRestricted = MapleDataTool.getIntConvert(\"info/accountSharable\", data, 0) == 1;\n+                    bRestricted = isAccountRestricted(itemId);\n                 }\n             }\n         }"}, {"sha": "4a559e52b530a1cb44f8c81d13433dd4ce12e0ce", "filename": "src/server/MapleSkillbookInformationProvider.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleSkillbookInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleSkillbookInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleSkillbookInformationProvider.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -245,6 +245,8 @@ private static void fetchSkillbooksFromQuests() {\n         } catch(IOException ioe) {\n             System.out.println(\"Failed to read Quest.wz file. Line \" + lineNumber + \": \" + line);\n             ioe.printStackTrace();\n+        } catch (Exception e) {\n+            System.out.println(\"Failed to parse Quest.wz XML file.\");   // catch this exception, thanks to YonhNi\n         }\n     }\n     "}, {"sha": "ec718cd608a1c86aacc794576e6e465212e5496e", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -1207,9 +1207,15 @@ private void applyMonsterBuff(MapleCharacter applyfrom) {\n     }\n \n     private Rectangle calculateBoundingBox(Point posFrom, boolean facingLeft) {\n-        int multiplier = facingLeft ? 1 : -1;\n-        Point mylt = new Point(lt.x * multiplier + posFrom.x, lt.y + posFrom.y);\n-        Point myrb = new Point(rb.x * multiplier + posFrom.x, rb.y + posFrom.y);\n+        Point mylt;\n+        Point myrb;\n+        if (facingLeft) {\n+            mylt = new Point(lt.x + posFrom.x, lt.y + posFrom.y);\n+            myrb = new Point(rb.x + posFrom.x, rb.y + posFrom.y);\n+        } else {\n+            myrb = new Point(-lt.x + posFrom.x, rb.y + posFrom.y);  // thanks Conrad, April for noticing a disturbance in AoE skill behavior after a hitched refactor here\n+            mylt = new Point(-rb.x + posFrom.x, lt.y + posFrom.y);\n+        }\n         Rectangle bounds = new Rectangle(mylt.x, mylt.y, myrb.x - mylt.x, myrb.y - mylt.y);\n         return bounds;\n     }"}, {"sha": "02549ec4fa10ad8f8453bdde6e91ea3346fcf969", "filename": "src/server/expeditions/MapleExpeditionBossLog.java", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/expeditions/MapleExpeditionBossLog.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/expeditions/MapleExpeditionBossLog.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/expeditions/MapleExpeditionBossLog.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -27,6 +27,7 @@\n import java.util.Calendar;\n import java.util.LinkedList;\n import java.util.List;\n+import constants.ServerConstants;\n import tools.DatabaseConnection;\n import tools.Pair;\n \n@@ -184,6 +185,10 @@ private static void insertPlayerEntry(int cid, BossLogEntry boss) {\n     }\n     \n     public static boolean attemptBoss(int cid, int channel, MapleExpedition exped, boolean log) {\n+        if (!ServerConstants.USE_ENABLE_DAILY_EXPEDITIONS) {\n+            return true;\n+        }\n+        \n         BossLogEntry boss = BossLogEntry.getBossEntryByName(exped.getType().name());\n         if (boss == null) {\n             return true;"}, {"sha": "dc57eb4906db0c417e221d200ea947a68fe6c3c5", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 54, "deletions": 10, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -52,6 +52,7 @@\n import java.util.Map.Entry;\n import java.util.HashSet;\n import java.util.Set;\n+import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicLong;\n import net.server.audit.locks.MonitoredReentrantLock;\n@@ -100,6 +101,7 @@\n     private int team;\n     private int parentMobOid = 0;\n     private final HashMap<Integer, AtomicLong> takenDamage = new HashMap<>();\n+    private ScheduledFuture<?> monsterItemDrop = null;\n     private Runnable removeAfterAction = null;\n     private boolean availablePuppetUpdate = true;\n \n@@ -512,14 +514,14 @@ private static double calcExperienceStandDevThreshold(List<Float> entryExpRatio,\n         return avgExpReward + Math.sqrt(varExpReward);\n     }\n     \n-    private void distributePlayerExperience(MapleCharacter chr, float exp, float partyBonusMod, int totalPartyLevel, boolean highestPartyDamager, boolean whiteExpGain) {\n+    private void distributePlayerExperience(MapleCharacter chr, float exp, float partyBonusMod, int totalPartyLevel, boolean highestPartyDamager, boolean whiteExpGain, boolean hasPartySharers) {\n         float playerExp = (ServerConstants.EXP_SPLIT_COMMON_MOD * chr.getLevel()) / totalPartyLevel;\n         if (highestPartyDamager) playerExp += ServerConstants.EXP_SPLIT_MVP_MOD;\n         \n         playerExp *= exp;\n         float bonusExp = partyBonusMod * playerExp;\n         \n-        this.giveExpToCharacter(chr, playerExp, bonusExp, whiteExpGain);\n+        this.giveExpToCharacter(chr, playerExp, bonusExp, whiteExpGain, hasPartySharers);\n     }\n     \n     private void distributePartyExperience(Map<MapleCharacter, Long> partyParticipation, float expPerDmg, Set<MapleCharacter> underleveled, Map<Integer, Float> personalRatio, double sdevRatio) {\n@@ -560,10 +562,11 @@ private void distributePartyExperience(Map<MapleCharacter, Long> partyParticipat\n         float participationExp = partyDamage * expPerDmg;\n         \n         // thanks Crypter for reporting an insufficiency on party exp bonuses\n-        float partyBonusMod = (membersSize > 1) ? 0.05f * membersSize : 0.0f;\n+        boolean hasPartySharers = membersSize > 1;\n+        float partyBonusMod = hasPartySharers ? 0.05f * membersSize : 0.0f;\n         \n         for (MapleCharacter mc : expMembers) {\n-            distributePlayerExperience(mc, participationExp, partyBonusMod, totalPartyLevel, mc == participationMvp, isWhiteExpGain(mc, personalRatio, sdevRatio));\n+            distributePlayerExperience(mc, participationExp, partyBonusMod, totalPartyLevel, mc == participationMvp, isWhiteExpGain(mc, personalRatio, sdevRatio), hasPartySharers);\n         }\n     }\n     \n@@ -636,7 +639,7 @@ private void distributeExperience(int killerId) {\n             float exp = chrParticipation.getValue() * expPerDmg;\n             MapleCharacter chr = chrParticipation.getKey();\n             \n-            distributePlayerExperience(chr, exp, 0.0f, chr.getLevel(), true, isWhiteExpGain(chr, personalRatio, sdevRatio));\n+            distributePlayerExperience(chr, exp, 0.0f, chr.getLevel(), true, isWhiteExpGain(chr, personalRatio, sdevRatio), false);\n         }\n         \n         for (Map<MapleCharacter, Long> partyParticipation : partyExpDist.values()) {\n@@ -657,13 +660,17 @@ private void distributeExperience(int killerId) {\n         \n     }\n     \n-    private float getStatusExpMultiplier(MapleCharacter attacker) {\n+    private float getStatusExpMultiplier(MapleCharacter attacker, boolean hasPartySharers) {\n         float multiplier = 1.0f;\n         \n         // thanks Prophecy & Aika for finding out Holy Symbol not being applied on party bonuses\n         Integer holySymbol = attacker.getBuffedValue(MapleBuffStat.HOLY_SYMBOL);\n         if (holySymbol != null) {\n-            multiplier *= (1.0 + (holySymbol.doubleValue() / 100.0));\n+            if (ServerConstants.USE_FULL_HOLY_SYMBOL) { // thanks Mordred, xinyifly, AyumiLove, andy33 for noticing HS hands out 20% of its potential on less than 3 players\n+                multiplier *= (1.0 + (holySymbol.doubleValue() / 100.0));\n+            } else {\n+                multiplier *= (1.0 + (holySymbol.doubleValue() / (hasPartySharers ? 100.0 : 500.0)));\n+            }\n         }\n \n         statiLock.lock();\n@@ -689,10 +696,10 @@ private static int expValueToInteger(double exp) {\n         return (int) exp;\n     }\n     \n-    private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Float partyExp, boolean white) {\n+    private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Float partyExp, boolean white, boolean hasPartySharers) {\n         if (attacker.isAlive()) {\n             if (personalExp != null) {\n-                personalExp *= getStatusExpMultiplier(attacker);\n+                personalExp *= getStatusExpMultiplier(attacker, hasPartySharers);\n                 personalExp *= attacker.getExpRate();\n             } else {\n                 personalExp = 0.0f;\n@@ -706,7 +713,7 @@ private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Floa\n             int _personalExp = expValueToInteger(personalExp); // assuming no negative xp here\n             \n             if (partyExp != null) {\n-                partyExp *= getStatusExpMultiplier(attacker);\n+                partyExp *= getStatusExpMultiplier(attacker, hasPartySharers);\n                 partyExp *= attacker.getExpRate();\n                 partyExp *= ServerConstants.PARTY_BONUS_EXP_RATE;\n             } else {\n@@ -722,6 +729,10 @@ private void giveExpToCharacter(MapleCharacter attacker, Float personalExp, Floa\n     }\n     \n     public List<MonsterDropEntry> retrieveRelevantDrops() {\n+        if (this.getStats().isFriendly()) {     // thanks Conrad for noticing friendly mobs not spawning loots after a recent update\n+            return MapleMonsterInformationProvider.getInstance().retrieveEffectiveDrop(this.getId());\n+        }\n+        \n         Map<Integer, MapleCharacter> pchars = map.getMapAllPlayers();\n         \n         List<MapleCharacter> lootChars = new LinkedList<>();\n@@ -814,6 +825,35 @@ public void run() {\n         return looter != null ? looter : killer;\n     }\n     \n+    public void dropFromFriendlyMonster(long delay) {\n+        final MapleMonster m = this;\n+        monsterItemDrop = TimerManager.getInstance().register(new Runnable() {\n+            @Override\n+            public void run() {\n+                if (!m.isAlive()) {\n+                    if (monsterItemDrop != null) {\n+                        monsterItemDrop.cancel(false);\n+                    }\n+                    \n+                    return;\n+                }\n+                \n+                MapleMap map = m.getMap();\n+                List<MapleCharacter> chrList = map.getAllPlayers();\n+                if (!chrList.isEmpty()) {\n+                    MapleCharacter chr = (MapleCharacter) chrList.get(0);\n+                    \n+                    EventInstanceManager eim = map.getEventInstance();\n+                    if (eim != null) {\n+                        eim.friendlyItemDrop(m);\n+                    }\n+                    \n+                    map.dropFromFriendlyMonster(chr, m);\n+                }\n+            }\n+        }, delay, delay);\n+    }\n+    \n     private void dispatchUpdateQuestMobCount() {\n         Set<Integer> attackerChrids = takenDamage.keySet();\n         if(!attackerChrids.isEmpty()) {\n@@ -2176,6 +2216,10 @@ public final int getRemoveAfter() {\n     }\n     \n     public void dispose() {\n+        if (monsterItemDrop != null) {\n+            monsterItemDrop.cancel(false);\n+        }\n+        \n         this.getMap().dismissRemoveAfter(this);\n         disposeLocks();\n     }"}, {"sha": "04abc34c35d61319aebea40c656d42ff2433a6ae", "filename": "src/server/maps/FieldLimit.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/FieldLimit.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/FieldLimit.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/FieldLimit.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -42,15 +42,15 @@\n     //CASH_WEATHER_CONSUME_LIMIT(0x4000),\n     //NO_PET(0x8000), // Ariant colosseum-related?\n     //ANTI_MACRO_LIMIT(0x10000), // No notes\n-    CANNOTJUMPDOWN(0x20000);\n+    CANNOTJUMPDOWN(0x20000),\n     //SUMMON_NPC_LIMIT(0x40000); // Seems to .. disable Rush if 0x2 is set\n     \n     //......... EVEN MORE LIMITS ............\n     //SUMMON_NPC_LIMIT(0x40000),\n-    //NO_EXP_DECREASE(0x80000),\n+    NO_EXP_DECREASE(0x80000),\n     //NO_DAMAGE_ON_FALLING(0x100000),\n     //PARCEL_OPEN_LIMIT(0x200000),\n-    //DROP_LIMIT(0x400000),\n+    DROP_LIMIT(0x400000);\n     //ROCKETBOOSTER_LIMIT(0x800000)     //lol we don't even have mechanics <3\n     \n     private long i;"}, {"sha": "f92f1bf3e91573810a04d92cba9629d8e2a9ebe8", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 6, "deletions": 35, "changes": 41, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -159,9 +159,6 @@\n     private MapleCharacter mapOwner = null;\n     private long mapOwnerLastActivityTime = Long.MAX_VALUE;\n     \n-    // HPQ\n-    private int riceCakes = 0;\n-    private int bunnyDamage = 0;\n     // events\n     private boolean eventstarted = false, isMuted = false;\n     private MapleSnowball snowball0 = null;\n@@ -1864,35 +1861,8 @@ public void spawnCPQMonster(MapleMonster mob, Point pos, int team) {\n         spawnMonster(mob);\n     }\n \n-    public void addBunnyHit() {\n-        bunnyDamage++;\n-        if (bunnyDamage > 5) {\n-            broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Moon Bunny is feeling sick. Please protect it so it can make delicious rice cakes.\"));\n-            bunnyDamage = 0;\n-        }\n-    }\n-\n     private void monsterItemDrop(final MapleMonster m, long delay) {\n-        final ScheduledFuture<?> monsterItemDrop = TimerManager.getInstance().register(new Runnable() {\n-            @Override\n-            public void run() {\n-                List<MapleMapObject> chrList = MapleMap.this.getPlayers();\n-                \n-                if (m.isAlive() && !chrList.isEmpty()) {\n-                    MapleCharacter chr = (MapleCharacter) chrList.get(0);\n-                    \n-                    if (m.getId() == 9300061) {\n-                        MapleMap.this.riceCakes++;\n-                        MapleMap.this.broadcastMessage(MaplePacketCreator.serverNotice(6, \"The Moon Bunny made rice cake number \" + (MapleMap.this.riceCakes) + \".\"));\n-                    }\n-                    \n-                    dropFromFriendlyMonster(chr, m);\n-                }\n-            }\n-        }, delay, delay);\n-        if (!m.isAlive()) {\n-            monsterItemDrop.cancel(true);\n-        }\n+        m.dropFromFriendlyMonster(delay);\n     }\n \n     public void spawnFakeMonsterOnGroundBelow(MapleMonster mob, Point pos) {\n@@ -2259,6 +2229,11 @@ public final void spawnItemDrop(final MapleMapObject dropper, final MapleCharact\n     }\n \n     public final void spawnItemDrop(final MapleMapObject dropper, final MapleCharacter owner, final Item item, Point pos, final byte dropType, final boolean playerDrop) {\n+        if (FieldLimit.DROP_LIMIT.check(this.getFieldLimit())) { // thanks Conrad for noticing some maps shouldn't have loots available\n+            this.disappearingItemDrop(dropper, owner, item, pos);\n+            return;\n+        }\n+        \n         final Point droppos = calcDropPos(pos, pos);\n         final MapleMapItem mdrop = new MapleMapItem(item, droppos, dropper, owner, owner.getClient(), dropType, playerDrop);\n         mdrop.setDropTime(Server.getInstance().getCurrentTime());\n@@ -3938,10 +3913,6 @@ public int getFieldLimit() {\n         return fieldLimit;\n     }\n \n-    public void resetRiceCakes() {\n-        this.riceCakes = 0;\n-    }\n-\n     public void allowSummonState(boolean b) {\n         MapleMap.this.allowSummons = b;\n     }"}, {"sha": "36d36212c53b50bd438c9f52b174e029b6701cbb", "filename": "src/server/maps/MapleMapManager.java", "status": "modified", "additions": 1, "deletions": 18, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMapManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMapManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapManager.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -19,17 +19,14 @@\n */\n package server.maps;\n \n-import constants.ServerConstants;\n import java.util.HashMap;\n import java.util.Map;\n-import java.util.concurrent.ScheduledFuture;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.WriteLock;\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.MonitoredReentrantReadWriteLock;\n import scripting.event.EventInstanceManager;\n-import server.TimerManager;\n \n public class MapleMapManager {\n \n@@ -38,8 +35,6 @@\n     \n     private Map<Integer, MapleMap> maps = new HashMap<>();\n     \n-    private ScheduledFuture<?> updateTask;\n-    \n     private ReadLock mapsRLock;\n     private WriteLock mapsWLock;\n \n@@ -51,13 +46,6 @@ public MapleMapManager(EventInstanceManager eim, int world, int channel) {\n         ReentrantReadWriteLock rrwl = new MonitoredReentrantReadWriteLock(MonitoredLockType.MAP_MANAGER);\n         this.mapsRLock = rrwl.readLock();\n         this.mapsWLock = rrwl.writeLock();\n-        \n-        updateTask = TimerManager.getInstance().register(new Runnable() {\n-            @Override\n-            public void run() {\n-                updateMaps();\n-            }\n-        }, ServerConstants.RESPAWN_INTERVAL);\n     }\n \n     public MapleMap resetMap(int mapid) {\n@@ -136,19 +124,14 @@ public boolean isMapLoaded(int mapId) {\n         }\n     }\n     \n-    private void updateMaps() {\n+    public void updateMaps() {\n         for (MapleMap map : getMaps().values()) {\n             map.respawn();\n             map.mobMpRecovery();\n         }\n     }\n     \n     public void dispose() {\n-        if (updateTask != null) {\n-            updateTask.cancel(false);\n-            updateTask = null;\n-        }\n-        \n         for (MapleMap map : getMaps().values()) {\n             map.dispose();\n         }"}, {"sha": "9a1aa27aec9dec490a2c3cc9bed84dba6447ab7f", "filename": "src/server/maps/MapleMiniDungeon.java", "status": "modified", "additions": 23, "deletions": 15, "changes": 38, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMiniDungeon.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/maps/MapleMiniDungeon.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMiniDungeon.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -49,19 +49,7 @@ public MapleMiniDungeon(int base, long timeLimit) {\n         timeoutTask = TimerManager.getInstance().schedule(new Runnable() {\n             @Override\n             public void run() {\n-                lock.lock();\n-                try {\n-                    List<MapleCharacter> lchr = new ArrayList<>(players);\n-                    \n-                    for(MapleCharacter chr : lchr) {\n-                        chr.changeMap(baseMap);\n-                    }\n-                    \n-                    dispose();\n-                    timeoutTask = null;\n-                } finally {\n-                    lock.unlock();\n-                }\n+                close();\n             }\n         }, expireTime);\n         \n@@ -95,8 +83,28 @@ public boolean unregisterPlayer(MapleCharacter chr) {\n                 dispose();\n                 return false;\n             }\n-            \n-            return true;\n+        } finally {\n+            lock.unlock();\n+        }\n+        \n+        if (chr.isPartyLeader()) {  // thanks Conrad for noticing party is not sent out of the MD as soon as leader leaves it\n+            close();\n+        }\n+        \n+        return true;\n+    }\n+    \n+    public void close() {\n+        lock.lock();\n+        try {\n+            List<MapleCharacter> lchr = new ArrayList<>(players);\n+\n+            for(MapleCharacter chr : lchr) {\n+                chr.changeMap(baseMap);\n+            }\n+\n+            dispose();\n+            timeoutTask = null;\n         } finally {\n             lock.unlock();\n         }"}, {"sha": "cefceb45d308ac0f9c926eae1ded2f28b1253352", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -174,7 +174,7 @@ private MapleQuest(int id) {\n             }\n         }\n     }\n-\t\n+    \n     public boolean isAutoComplete() {\n         return autoPreComplete || autoComplete;\n     }\n@@ -544,8 +544,13 @@ private MapleQuestAction getAction(MapleQuestActionType type, MapleData data) {\n \t\treturn ret;\n \t}\n         \n-        public static boolean isExploitableQuest(short questid) {\n-                return exploitableQuests.contains(questid);\n+        public boolean restoreLostItem(MapleCharacter chr, int itemid) {\n+                ItemAction itemAct = (ItemAction) startActs.get(MapleQuestActionType.ITEM);\n+                if (itemAct != null) {\n+                        return itemAct.restoreLostItem(chr, itemid);\n+                }\n+                \n+                return false;\n         }\n \t\n         public int getMedalRequirement() {\n@@ -572,6 +577,10 @@ public String getParentName() {\n                 return parent;\n         }\n         \n+        public static boolean isExploitableQuest(short questid) {\n+                return exploitableQuests.contains(questid);\n+        }\n+        \n         public static List<MapleQuest> getMatchedQuests(String search) {\n                 List<MapleQuest> ret = new LinkedList<>();\n                 "}, {"sha": "a395035f468323add4b2d7ad431846bb6781770d", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 30, "deletions": 2, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -35,8 +35,10 @@\n import provider.MapleData;\n import provider.MapleDataTool;\n import client.inventory.manipulator.MapleInventoryManipulator;\n+import server.MapleItemInformationProvider;\n import server.quest.MapleQuest;\n import server.quest.MapleQuestActionType;\n+import tools.FilePrinter;\n import tools.MaplePacketCreator;\n import tools.Pair;\n import tools.Randomizer;\n@@ -250,8 +252,34 @@ private boolean canGetItem(ItemData item, MapleCharacter chr) {\n                     }\n                     return jobFound;\n                 }\n-        return true;\n-    }\n+                \n+                return true;\n+        }\n+        \n+        public boolean restoreLostItem(MapleCharacter chr, int itemid) {\n+            if (!MapleItemInformationProvider.getInstance().isQuestItem(itemid)) {\n+                return false;\n+            }\n+            \n+            // thanks danielktran (MapleHeroesD)\n+            for (ItemData item : items) {\n+                if (item.getId() == itemid) {\n+                    int missingQty = item.getCount() - chr.countItem(itemid);\n+                    if (missingQty > 0) {\n+                        if (!chr.canHold(itemid, missingQty)) {\n+                            chr.dropMessage(1, \"Please check if you have enough space in your inventory.\");\n+                            return false;\n+                        }\n+                        \n+                        MapleInventoryManipulator.addById(chr.getClient(), item.getId(), (short) missingQty);\n+                        FilePrinter.print(FilePrinter.QUEST_RESTORE_ITEM, chr + \" obtained \" + itemid + \" qty. \" + missingQty + \" from quest \" + questID);\n+                    }\n+                    return true;\n+                }\n+            }\n+            \n+            return false;\n+        }\n \t\n \tprivate class ItemData {\n \t\tprivate final int map, id, count, job, gender;"}, {"sha": "0e934c1dd3bf3a0d48f9cc608f11b72d2cd0c85c", "filename": "src/tools/FilePrinter.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/tools/FilePrinter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/tools/FilePrinter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/FilePrinter.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -21,6 +21,7 @@\n             LOG_LEAF = \"interactions/MapleLeaves.txt\",\n             LOG_GACHAPON = \"interactions/Gachapon.txt\",\n             LOG_CHAT = \"interactions/ChatLog.txt\",\n+            QUEST_RESTORE_ITEM = \"game/QuestItemRestore.txt\",\n             EXCEPTION_CAUGHT = \"game/ExceptionCaught.txt\",\n             CLIENT_START = \"game/ClientStartError.txt\",\n             MAPLE_MAP = \"game/MapleMap.txt\","}, {"sha": "391e6a300c71c6cee736d99108bcdd24dafc5640", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 21, "deletions": 11, "changes": 32, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -110,7 +110,7 @@\n import constants.skills.Buccaneer;\n import constants.skills.Corsair;\n import constants.skills.ThunderBreaker;\n-import scripting.npc.NPCConversationManager;\n+import java.util.TimeZone;\n import server.maps.AbstractMapleMapObject;\n \n /**\n@@ -120,20 +120,23 @@\n public class MaplePacketCreator {\n \n         public static final List<Pair<MapleStat, Integer>> EMPTY_STATUPDATE = Collections.emptyList();\n-        private final static long FT_UT_OFFSET = 116444628000000000L;\n+        private final static long FT_UT_OFFSET = 116444736010800000L + (10000L * TimeZone.getDefault().getOffset(System.currentTimeMillis())); // normalize with timezone offset suggested by Ari\n         private final static long DEFAULT_TIME = 150842304000000000L;//00 80 05 BB 46 E6 17 02\n         public final static long ZERO_TIME = 94354848000000000L;//00 40 E0 FD 3B 37 4F 01\n         private final static long PERMANENT = 150841440000000000L; // 00 C0 9B 90 7D E5 17 02\n \n-        private static long getTime(long realTimestamp) {\n-                if (realTimestamp == -1) {\n-                        return DEFAULT_TIME;//high number ll\n-                } else if (realTimestamp == -2) {\n-                        return ZERO_TIME;\n-                } else if (realTimestamp == -3) {\n-                        return PERMANENT;\n+        private static long getTime(long utcTimestamp) {\n+                if (utcTimestamp < 0 && utcTimestamp >= -3) {\n+                        if (utcTimestamp == -1) {\n+                                return DEFAULT_TIME;    //high number ll\n+                        } else if (utcTimestamp == -2) {\n+                                return ZERO_TIME;\n+                        } else {\n+                                return PERMANENT;\n+                        }\n                 }\n-                return realTimestamp * 10000 + FT_UT_OFFSET;\n+                \n+                return utcTimestamp * 10000 + FT_UT_OFFSET;\n         }\n \n         public static byte[] showHpHealed(int cid, int amount) { \n@@ -361,7 +364,7 @@ private static void addQuestInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                         mplew.writeLong(getTime(q.getCompletionTime()));\n                 }\n         }\n-\n+        \n         private static void addExpirationTime(final MaplePacketLittleEndianWriter mplew, long time) {\n                 mplew.writeLong(getTime(time)); // offset expiration time issue found thanks to Thora\n         }\n@@ -2568,6 +2571,13 @@ private static int doubleToShortBits(double d) {\n                 return mplew.getPacket();\n         }\n         \n+        public static byte[] updateWitchTowerScore(int score) {\n+                MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n+                mplew.writeShort(SendOpcode.WITCH_TOWER_SCORE_UPDATE.getValue());\n+                mplew.write(score);\n+                return mplew.getPacket();\n+        }\n+        \n         public static byte[] silentRemoveItemFromMap(int oid) {\n                 return removeItemFromMap(oid, 1, 0);\n         }"}, {"sha": "2da76eb63d38d3dedd0d05a72f9ad4c2f942be05", "filename": "tools/MapleMapFieldLimitChecker/build.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/build.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/build.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleMapFieldLimitChecker/build.xml?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleMapFieldLimitChecker\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleMapFieldLimitChecker.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleMapFieldLimitChecker-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "2d4b2753148f43fa7f05e9187a39a43a6cd374a5", "filename": "tools/MapleMapFieldLimitChecker/lib/Report.txt", "status": "added", "additions": 149, "deletions": 0, "changes": 149, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/lib/Report.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/lib/Report.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleMapFieldLimitChecker/lib/Report.txt?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,149 @@\n+ # Report File autogenerated from the MapleEmptyItemWzChecker feature by Ronan Lana.\n+ # Generated data takes into account several data info from the server-side WZ.xmls.\n+\n+String.wz NAMES with no Item.wz node, 130 entries:\n+  20816 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Face\\\n+  20817 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Face\\\n+  21817 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Face\\\n+  21820 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Face\\\n+  1002655 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1002657 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1002658 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1003028 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1003029 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1003030 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1003043 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Cap\\\n+  1022096 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Accessory\\\n+  1042180 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Coat\\\n+  1052226 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Longcoat\\\n+  1060115 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1060138 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1061125 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1061160 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1062036 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1062037 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Pants\\\n+  1072248 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Shoes\\\n+  1072249 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Shoes\\\n+  1072418 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Shoes\\\n+  1072425 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Shoes\\\n+  1080002 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Glove\\\n+  1082217 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Glove\\\n+  1082221 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Glove\\\n+  1082261 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Glove\\\n+  1142152 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Accessory\\\n+  1142155 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Accessory\\\n+  1302032 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1302069 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1322030 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1322034 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1332058 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1382013 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1452047 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1462020 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1462042 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1472057 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  1702113 ../../wz/String.wz/Eqp.img.xml -> Eqp.img\\Eqp\\Weapon\\\n+  2002012 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2002013 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2002014 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2012004 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2022034 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2022036 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2022046 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2022114 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2070014 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2083000 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2084000 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101016 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101017 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101018 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101019 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101022 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2101058 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2210023 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2210024 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240004 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240005 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240006 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240007 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240008 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240009 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240010 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240011 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240012 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240013 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240014 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2240015 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2290109 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  2390000 ../../wz/String.wz/Consume.img.xml -> Consume.img\\\n+  3010044 ../../wz/String.wz/Ins.img.xml -> Ins.img\\\n+  3994016 ../../wz/String.wz/Ins.img.xml -> Ins.img\\\n+  4000275 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4001150 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031294 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031627 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031628 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031629 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031630 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031631 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031632 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031633 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031634 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031635 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031636 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031637 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031638 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031639 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031640 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031641 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031642 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031643 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031644 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031645 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031646 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031647 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031648 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031795 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4031867 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  4032526 ../../wz/String.wz/Etc.img.xml -> Etc.img\\Etc\\\n+  5000040 ../../wz/String.wz/Pet.img.xml -> Pet.img\\\n+  5000043 ../../wz/String.wz/Pet.img.xml -> Pet.img\\\n+  5000046 ../../wz/String.wz/Pet.img.xml -> Pet.img\\\n+  5201000 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5201001 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210000 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210001 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210002 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210003 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210004 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5210005 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5211001 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5211002 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5211003 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5211047 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5240016 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5240019 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5251004 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5251005 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5251006 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360009 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360010 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360011 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360012 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360013 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+  5360014 ../../wz/String.wz/Cash.img.xml -> Cash.img\\\n+\n+Item.wz ITEMS with no String.wz node, 12 entries:\n+  1942000 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01942000.img.xml ->  NOT FOUND\n+  1942001 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01942001.img.xml ->  NOT FOUND\n+  1942002 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01942002.img.xml ->  NOT FOUND\n+  1952000 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01952000.img.xml ->  NOT FOUND\n+  1952001 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01952001.img.xml ->  NOT FOUND\n+  1952002 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01952002.img.xml ->  NOT FOUND\n+  1962000 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01962000.img.xml ->  NOT FOUND\n+  1962001 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01962001.img.xml ->  NOT FOUND\n+  1962002 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01962002.img.xml ->  NOT FOUND\n+  1972000 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01972000.img.xml ->  NOT FOUND\n+  1972001 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01972001.img.xml ->  NOT FOUND\n+  1972002 C:\\Nexon\\HeavenMS\\wz\\Character.wz\\Dragon\\01972002.img.xml ->  NOT FOUND\n+"}, {"sha": "328e8e5bc3b7f1f7bad2bc0751a933e00c801983", "filename": "tools/MapleMapFieldLimitChecker/manifest.mf", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/manifest.mf", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/manifest.mf", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleMapFieldLimitChecker/manifest.mf?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,3 @@\n+Manifest-Version: 1.0\n+X-COMMENT: Main-Class will be added automatically by build\n+"}, {"sha": "657ca2ebc453dca694a1037bb3d55778d3f6ed62", "filename": "tools/MapleMapFieldLimitChecker/src/maplemapfieldlimitchecker/MapleMapFieldLimitChecker.java", "status": "added", "additions": 197, "deletions": 0, "changes": 197, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/src/maplemapfieldlimitchecker/MapleMapFieldLimitChecker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/tools/MapleMapFieldLimitChecker/src/maplemapfieldlimitchecker/MapleMapFieldLimitChecker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleMapFieldLimitChecker/src/maplemapfieldlimitchecker/MapleMapFieldLimitChecker.java?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -0,0 +1,197 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package maplemapfieldlimitchecker;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.InputStreamReader;\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+\n+/**\n+ *\n+ * @author RonanLana\n+ * \n+  This application seeks from the XMLs all mapid entries that holds the specified\n+  fieldLimit.\n+ */\n+public class MapleMapFieldLimitChecker {\n+    \n+    static String newFile = \"lib/Report.txt\";\n+    static String outputWzPath = \"lib\";\n+    static PrintWriter printWriter = null;\n+    static InputStreamReader fileReader = null;\n+    static BufferedReader bufferedReader = null;\n+    \n+    static String wzPath = \"../../wz\";\n+    static int initialStringLength = 50;\n+    static int itemFileNameSize = 13;\n+    \n+    static int fieldLimit = 0x400000;\n+    \n+    static byte status = 0;\n+    static int mapid = 0;\n+    \n+    private static String getName(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"name\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static String getValue(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"value\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static void forwardCursor(int st) {\n+        String line = null;\n+\n+        try {\n+            while(status >= st && (line = bufferedReader.readLine()) != null) {\n+                simpleToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static void simpleToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        }\n+    }\n+    \n+    private static void listFiles(String directoryName, ArrayList<File> files) {\n+        File directory = new File(directoryName);\n+\n+        // get all the files from a directory\n+        File[] fList = directory.listFiles();\n+        for (File file : fList) {\n+            if (file.isFile()) {\n+                files.add(file);\n+            } else if (file.isDirectory()) {\n+                listFiles(file.getAbsolutePath(), files);\n+            }\n+        }\n+    }\n+    \n+    private static int getMapIdFromFilename(String name) {\n+        try {\n+            return Integer.valueOf(name.substring(0, name.indexOf('.')));\n+        } catch(Exception e) {\n+            return -1;\n+        }\n+    }\n+    \n+    private static void translateToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+            \n+            if (status == 2) {\n+                String d = getName(token);\n+                if (!d.contentEquals(\"info\")) {\n+                    forwardCursor(status);\n+                }\n+            }\n+        }\n+        else {\n+            if (status == 2) {\n+                String d = getName(token);\n+                \n+                if (d.contentEquals(\"fieldLimit\")) {\n+                    int value = Integer.valueOf(getValue(token));\n+                    if ((value & fieldLimit) == fieldLimit) {\n+                        System.out.println(mapid + \" \" + value);\n+                    }\n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void inspectMapEntry() {\n+        String line = null;\n+\n+        try {\n+            while((line = bufferedReader.readLine()) != null) {\n+                translateToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+    \n+    private static void loadMapWz() throws IOException {\n+        System.out.println(\"Reading Map.wz ...\");\n+        ArrayList<File> files = new ArrayList<>();\n+        listFiles(wzPath + \"/Map.wz/Map\", files);\n+\n+        for(File f : files) {\n+            fileReader = new InputStreamReader(new FileInputStream(f), \"UTF-8\");\n+            bufferedReader = new BufferedReader(fileReader);\n+            \n+            mapid = getMapIdFromFilename(f.getName());\n+            inspectMapEntry();\n+\n+            bufferedReader.close();\n+            fileReader.close();\n+        }\n+    }\n+    \n+    public static void main(String[] args) {\n+        try {\n+            loadMapWz();\n+            System.out.println(\"Done!\");\n+        } catch (IOException ioe) {\n+            ioe.printStackTrace();\n+        }\n+    }\n+    \n+}"}, {"sha": "ccc3c4ef70af9924a1ccf2e900529b082e7ede1a", "filename": "wz/Map.wz/Map/Map2/211042400.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/wz/Map.wz/Map/Map2/211042400.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/ab5cec7f33c3617f4762b9b3d2388aeb21c405dd/wz/Map.wz/Map/Map2/211042400.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map2/211042400.img.xml?ref=ab5cec7f33c3617f4762b9b3d2388aeb21c405dd", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"bgm\" value=\"Bgm05/HellGate\"/>\n     <string name=\"mapMark\" value=\"ElNathDungeon\"/>\n     <int name=\"hideMinimap\" value=\"0\"/>\n-    <int name=\"fieldLimit\" value=\"8284\"/>\n+    <int name=\"fieldLimit\" value=\"4202588\"/>\n     <int name=\"VRTop\" value=\"-720\"/>\n     <int name=\"VRLeft\" value=\"-1800\"/>\n     <int name=\"VRBottom\" value=\"-120\"/>"}]}]},
