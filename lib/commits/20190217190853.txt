{"fetchDate": "2019-12-19", "content": [{"sha": "46fec675f139abd9b81cbe5e862152c89444cc59", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NDZmZWM2NzVmMTM5YWJkOWI4MWNiZTVlODYyMTUyYzg5NDQ0Y2M1OQ==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-02-17T19:08:53Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-02-17T19:08:53Z"}, "message": "Added Puppets on Aggro + Guild/Alliance packet info patch + Pet flags\n\nAdded pet flags recognition, such as the \"pet speed same as owner\" mechanic.\nFixed repeatable quest \"Remnants of HT...\" not rewarding Dragon Stones.\nRefactored character object's check slots method, now using the same algorithm from the API class.\nFixed a vunerability from before reviving/respawning players to towns, on where players would get their HP restored in area map before sending them back to safety.\nFixed some NPC gates in Mushking Empire, allowing players to access bosses free of quest requirements.\nImproved dialog of NPCs for \"permission to attempt Zakum expeds\".\nImplemented (or rather improved) item scripts, now using NPC conversation methods as it was intended originally.\nRehauled mob-skill \"summon mobs\" limit, now using the placeholders found in the wz to determine limit of concurrent underlings spawned, and \"limit\" now refers to total of underlings spawned from a mob.\nRevised IoSession closing mechanics in several login classes.\nImplemented automated loggedin account shutdown if another player has gained a pass from the DB to login.\nImproved the server-side check for teleport rocks.\nFixed removeAfter from mobs being procced after they were disposed.\nReviewed EIM start references on several scripts, minding the latest EIM setup implementations.\nFixed equipments that were reused Scissors of Karma not not being able to sell on pshops/merchants.\nFixed a bug where entering alliances would lead a player to see information from other guilds of past alliances until an update takes place.\nPadronized a few skillbook names.\nReviewed player puppets not gaining priority properly on the recent aggro system.\nImproved \"item sold\" message of merchants, now displaying also quantity left of an item on store.\nFixed a bug with itemid limits of weapons on server.", "tree": {"sha": "46223a7e0a510b2341c894079a8b26b18010ba9e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/46223a7e0a510b2341c894079a8b26b18010ba9e"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/46fec675f139abd9b81cbe5e862152c89444cc59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/46fec675f139abd9b81cbe5e862152c89444cc59", "html_url": "https://github.com/ronancpl/HeavenMS/commit/46fec675f139abd9b81cbe5e862152c89444cc59", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/46fec675f139abd9b81cbe5e862152c89444cc59/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4beea3961583c832c9e7a98f8720fa7307653968", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/4beea3961583c832c9e7a98f8720fa7307653968", "html_url": "https://github.com/ronancpl/HeavenMS/commit/4beea3961583c832c9e7a98f8720fa7307653968"}], "stats": {"total": 2362, "additions": 1757, "deletions": 605}, "files": [{"sha": "32140893acf1977dc56e3eb7e43da54970c6a171", "filename": ".gitignore", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/.gitignore", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/.gitignore", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/.gitignore?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -27,6 +27,10 @@\n /tools/MapleCashDropFetcher/dist/\n /tools/MapleCashDropFetcher/nbproject/\n \n+/tools/MapleCashVegaChecker/build/\n+/tools/MapleCashVegaChecker/dist/\n+/tools/MapleCashVegaChecker/nbproject/\n+\n /tools/MapleCodeCouponGenerator/build/\n /tools/MapleCodeCouponGenerator/dist/\n /tools/MapleCodeCouponGenerator/nbproject/"}, {"sha": "33a2d0e088536ef1f960bce91581ce42539480e6", "filename": "README.md", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/README.md", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/README.md", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/README.md?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -23,13 +23,15 @@ Java7 SDK: https://www.oracle.com/technetwork/java/javase/downloads/java-archive\n \n **Important note about localhosts**: these executables are red-flagged by antivirus tools as __potentially malicious softwares__, this happens due to the reverse engineering methods that were applied onto these software artifacts. Those depicted here have been put to use for years already and posed no harm so far, so they are soundly assumed to be safe.\n \n-  Latest localhost: https://hostr.co/m2bVtnizCtmD\n+  Latest localhost: https://hostr.co/tsYsQzzV6xT0\n \n   The following list, in bottom-up chronological order, holds information regarding all changes that were applied from the starting localhost used in this development. Some lines have a link attached, that will lead you to a snapshot of the localhost at that version of the artifact. Naturally, later versions holds all previous changes along with the proposed changes.\n \n **Change log:**\n \n-  * Removed block on applying attack-based strengthening gems on non-weapon equipments.\n+  * Fixed some 'rn' problems with quest icons & removed \"tab\" from party leader changed message.\n+\n+  * Removed block on applying attack-based strengthening gems on non-weapon equipments. https://hostr.co/m2bVtnizCtmD\n \n   * Set a higher cap for SPEED.\n \n@@ -84,6 +86,7 @@ It's never enough to tell this, thanks to everyone that have been contributing s\n Our Discord channel is still available on: https://discord.gg/Q7wKxHX\n \n <hr id=\"donate\" />\n+\n ### Donation\n \n If you REALLY liked what you have seen on the project, please feel free to donate a little something as a helping hand for my contributions towards Maple development. Also remember to **support Nexon**!"}, {"sha": "657eadb8e2e226b19c0763962acfedc1df323787", "filename": "docs/issues.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/docs/issues.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/docs/issues.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/issues.txt?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -16,6 +16,7 @@ Known issues:\n - Some monster status such as freeze and weapon/magic reflect doesn't behave properly in certain scenarios. Freeze seems to not work on mobs with low OID or are starters from server boot time.\n - On low-end connections, things such as command summoning a player that is currently logging in (already visible to other players) may cause the player to freeze, consequently freezing the account as well since the server-side disconnection doesn't happen.\n - Reportedly, there are cases where mob positions fail to sync between player's client-view.\n+- Visual equip EXP watch value will present stuttering for early levels requirement (EXP needed less than 100), and requirement at level 200 will not progress at all due to the level cap in client.\n ---------------------------\n \n ---------------------------\n@@ -24,7 +25,6 @@ Missing features list:\n - Some pirate skills doesn't work for 3rd parties.\n - Cache frequently used SQL data.\n - Pet commands are not being propagated to 3rd parties, and the commandResponse packet function seems somewhat wonky.\n-- Pet speed.\n ---------------------------\n \n "}, {"sha": "9f5614badcf520d22663f75a8b9566b95879fc75", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 42, "deletions": 1, "changes": 43, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1619,4 +1619,45 @@ Adicionado checagem em quantidade de itens nas lojas e mercantes de jogadores, a\n Corrigido um exploit com mercantes, envolvendo chamada \u00e0 DB antes de retirar item (que est\u00e1 sendo inserido na loja) do invent\u00e1rio do jogador.\n \n 30 Janeiro 2019,\n-Corrigido chamadas irregulares a \"qm/cm\" em scripts.\n\\ No newline at end of file\n+Corrigido chamadas irregulares a \"qm/cm\" em scripts.\n+\n+31 Janeiro 2019,\n+Com a ajuda de Irenex, adicionado refer\u00eancia a pet flags no criador de pacotes.\n+Adicionado funcionalidade de quest que permite pets a andarem na velocidade do jogador.\n+Corrigido quest repet\u00edvel de Dragon Stone n\u00e3o apropriadamente recompensando o item ao jogador.\n+Corrigido m\u00e9todo de checagem de slots em MapleCharacter, agora utilizando o m\u00e9todo padr\u00e3o implementado especificamente para checagem de slots.\n+\n+01 Fevereiro 2019,\n+Corrigido vulnerabilidade na a\u00e7\u00e3o de jogadores ao retornar para a cidade ap\u00f3s reviver. Servidor poderia receber packet de dano e process\u00e1-lo legitimamente com o HP atualizado do jogador antes de envi\u00e1-lo de volta para cidade.\n+\n+04 - 05 Fevereiro 2019,\n+Corrigido NPCs de port\u00e3o em Mushking Empire permitindo jogadores acesso a \u00e1rea de bosses sem requisitos m\u00ednimos.\n+Incrementado di\u00e1logos de permiss\u00e3o para realizar expedi\u00e7\u00f5es contra Zakum.\n+Modificado gerenciador de item scripts, agora referenciando conversa\u00e7\u00e3o de NPCs (como previsto pelo WZ).\n+Implementado limita\u00e7\u00e3o de mob summons, como previsto no WZ.\n+Revisado fechamento de sess\u00f5es no c\u00f3digo-fonte n\u00e3o utilizando o coordenador de sess\u00f5es para isto.\n+Revisado sistema de login, agora automaticamente desconectando contas retidas no jogo quando DB determina que uma conta est\u00e1 dispon\u00edvel para login.\n+Revisado Teleport Rocks, agora devidamente checando se \u00e9 poss\u00edvel chegar ao mapa alvo (ou se h\u00e1 bloqueio de uso do item para esse mapa), al\u00e9m de certas checagens contra exploits com esse item.\n+Corrigido agendamento de removeAfter de mobs atuando quando o mesmo j\u00e1 foi liberado.\n+\n+07 - 08 Fevereiro 2019,\n+Corrigido ocorr\u00eancias de NPE ao tentar registrar-se em inst\u00e2ncia de evento, quando existe uma outra inst\u00e2ncia que leva o mesmo nome em andamento.\n+Tentativa de corre\u00e7\u00e3o em todos os scripts de eventos, ap\u00f3s ter atualizado o sistema de eventos para n\u00e3o mais ficar gerando inst\u00e2ncias livremente (agora, todas as inst\u00e2ncias orientadas-a-solo t\u00eam limite de acesso simult\u00e2neo entre jogadores).\n+Corrigido lojas de jogadores e mercantes n\u00e3o aceitando itens em certos casos onde j\u00e1 se foi usado Scissors of Karma.\n+Revisado novamente diversos scripts de evento, atentando \u00e0s chamadas de fun\u00e7\u00e3o \"setup\" das mesmas.\n+\n+09 Fevereiro 2019,\n+Tentativa de corre\u00e7\u00e3o em sess\u00f5es com exceptionCaught, j\u00e1 que aparentemente a sess\u00e3o nem sempre \u00e9 fechada pelo MINA automaticamente.\n+Corrigido lista de guilds em alliances n\u00e3o sendo atualizado corretamente ao criar-se uma nova alliance. Era poss\u00edvel ver guilds de alian\u00e7as passadas antes de ocorrer alguma atualiza\u00e7\u00e3o de packet em jogo que resolva isso.\n+Implementado comando \"toggleexp\", que permite jogadores a escolher ganhar n\u00edvel ou n\u00e3o se os mesmos n\u00e3o estivem em inst\u00e2ncia de evento.\n+Nova ferramenta: MapleCashVegaChecker. Ferramenta busca por itens que supostamente deveriam permitir uso do Vega Scroll (segundo descri\u00e7\u00e3o) por\u00e9m n\u00e3o o permitem.\n+Revisado nomes de skill e mastery books, que mantinham n\u00fameros no nome da skill (agora padronizado com os outros livros).\n+\n+10 Fevereiro 2019,\n+Editado requerimentos de level de medalhas level 200 para 180, assim evitando o problema onde n\u00edvel das medalhas n\u00e3o apare\u00e7e na vis\u00e3o do cliente devido ao level cap.\n+Corrigido puppets n\u00e3o tomando prioridade na nova mec\u00e2nica de aggro.\n+Incrementado mensagem custom de venda de produtos pelo mercante.\n+\n+13 - 14 Fevereiro 2019,\n+Corrigido limites na fun\u00e7\u00e3o isWeapon, que n\u00e3o contabilizaria certos itens corretamente.\n+Resolvido comportamento de puppets usando o novo sistema de aggro.\n\\ No newline at end of file"}, {"sha": "ae3945d6d9b209a5dfa78b100752ffd8911d0aae", "filename": "handbook/Equip/Cape.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/handbook/Equip/Cape.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/handbook/Equip/Cape.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/handbook/Equip/Cape.txt?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -82,7 +82,7 @@\n 1102080 - Ragged Blue Cape - (no description)\n 1102081 - Ragged Yellow Cape - (no description)\n 1102082 - Ragged Black Cape - (no description)\n-1102083 - Ragged Red Cape - (no description)\n+1102083 - Ragged Green Cape - (no description)\n 1102084 - Pink Gaia Cape - (no description)\n 1102085 - Yellow Gaia Cape - (no description)\n 1102086 - Purple Gaia Cape - (no description)"}, {"sha": "137f8b3141c77a7a8505401a3c32af8694127427", "filename": "handbook/Use.txt", "status": "modified", "additions": 28, "deletions": 28, "changes": 56, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/handbook/Use.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/handbook/Use.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/handbook/Use.txt?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -376,15 +376,15 @@\n 2030004 - Return Scroll to Henesys - Returns you to Henesys.\n 2030005 - Return Scroll to Kerning City - Returns you to the dark Kerning City.\n 2030006 - Return Scroll to Sleepywood - Returns you to Sleepywood, a quiet and dark forest-town.\n-2030007 - Return Scroll for Dead Mine - Returns you to the dead mine at the higher ground of El Nath.nCan only be used in Orbis and El Nath.\n+2030007 - Return Scroll to Dead Mine - Returns you to the dead mine at the higher ground of El Nath.nCan only be used in Orbis and El Nath.\n 2030008 - Coffee Milk - Returns you to the nearest town.\n 2030009 - Strawberry Milk - Returns you to Mushroom Shrine.\n 2030010 - Fruit Milk - Returns you to Showa Town.\n 2030011 - Command Center Warp Capsule - A warp capsule that allows the owner of the capsule to warp to the Command Center of Omega Sector.\n 2030012 - Ludibrium Warp Capsule - A warp capsule that returns you to Ludibrium.\n 2030016 - Phyllia's Warp Powder - Warp powder made by fairy Phyllia.  Teleports you to Magatia when used inside the Nihal desert region.\n-2030019 - Nautilus Return Scroll - This scroll enables you to return to the Pirate village, Nautilus. This is a one use item and will disappear after use.\n-2030020 - Return to New Leaf City Scroll - Use this scroll to venture back to New Leaf City whenever you want!\n+2030019 - Return Scroll to Nautilus - This scroll enables you to return to the Pirate village, Nautilus. This is a one use item and will disappear after use.\n+2030020 - Return Scroll to New Leaf City - Use this scroll to venture back to New Leaf City whenever you want!\n 2030100 - Return Scroll - Banished Area - Returns you to the map where you were last banished. Requires immediate use and have changed neither maps nor channels.\n 2031000 - Masked Man's Invitation - An invitation from the Masked Man to the Halloween Party at the Haunted Mansion. Double-click to move straight to the mansion.\n 2031001 - Studio Invitation - An invitation to the studio for the event \"For Guild Only\".\n@@ -1182,7 +1182,7 @@\n 2280001 - Black Cloud Machine - A mechanical device that produces black clouds. Enables the character to acquire the Smokescreen skill using the clouds.\n 2280002 - Firm Hand - A stimulant packaged inside a bottle that resembles a clenched fist. Drinking the stimulant will allow the character to acquire The Will of a Warrior.\n 2280003 - [Skill Book] Maple Warrior - You can learn #cMaple Warrior# with this book.rnJob : All 4th jobsrnCondition : #cMaple Warrior# not acquired.\n-2280004 - [Skill Book] Infinity - You can learn #Infinity# with this book.rnJob : 4th Advancement MagicianrnCondition : #cInfinity# not acquired\n+2280004 - [Skill Book] Infinity - You can learn #cInfinity# with this book.rnJob : 4th Advancement MagicianrnCondition : #cInfinity# not acquired\n 2280005 - [Skill Book] Dragon's Breath - You can learn #cDragon's Breath# with this book.wnJob : 4th Advancement BowmanrnCondition : #cDragon's Breath# not acquired\n 2280006 - [Skill Book] Taunt - You can learn #cTaunt# with this book.rnJob : 4th Advancement ThiefrnCondition : #cTaunt# not acquired\n 2280007 - [Skill Book] Advanced Combo Attack - You can learn #cAdvanced Combo Attack# with this book.rnClass : HerornCondition : #cAdvanced Combo# not acquired\n@@ -1191,6 +1191,13 @@\n 2280010 - [Skill Book] Triple Throw - You can learn #cTriple Throw# with this book.rnClass : Night LordrnCondition : #cTriple Throw# not acquired\n 2280011 - Ancient Ice Powder - This is a pack full of ancient ice powder. If you eat this,  you will feel chilled and can learn Ice Demon.\n 2280012 - [Skill Book] Rush - You can learn #cRush# with this book.rnJob : 4th Advancement WarriorrnCondition : #cRush# not acquired\n+2280013 - [Skill Book] Final Blow - Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Lv Aran\\nCondition: #cFinal Blow# not available\n+2280014 - [Skill Book] High Defense - Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Lv Aran\\nCondition: #cHigh Defense# not available\n+2280015 - [Skill Book] Combo Tempest - Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Tempest# not available\n+2280017 - [Skill Book] Pig's Weakness - Skill Book from which you can learn about the #cPig's Weakness# skill.\\nCondition: #cPig's Weakness# not available\n+2280016 - [Skill Book] Combo Barrier - Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Barrier# not available\n+2280018 - [Skill Book] Stump's Weakness - Skill Book from which you can learn about the #cStump's Weakness# skill.\\nCondition: #cStump's Weakness# not available\n+2280019 - [Skill Book] Slime's Weakness - Skill Book from which you can learn about the #cSlime's Weakness# skill.\\nCondition: #cSlime's Weakness# not available\n 2290000 - [Mastery Book] Monster Magnet - This increases master level of the  #cMonster Magnet# skill up to 20 with 70% chance of success.rnJob : 4th Advancement WarriorrnCondition : Skill level above 5\n 2290001 - [Mastery Book] Monster Magnet - This increases master level of the  #cMonster Magnet# skill up to 30 with 50% chance of success. rnJob : 4th Advancement WarriorrnCondition : Skill Level above 15\n 2290002 - [Mastery Book] Achilles - This increases the master level of #cAchilles# up to 20 with 70% of chance.rnJob : 4th Advancement WarriorrnCondition : Skill level above 5\n@@ -1287,7 +1294,7 @@\n 2290093 - [Mastery Book] Assassinate - This increases the master level of #cAssassinate# up to 30 with 50% of chance.rnClass : ShadowerrnCondition : Skill level above 15\n 2290094 - [Mastery Book] Smokescreen - This increases the master level of #cSmokescreen# up to 20 with 70% of chance.rnClass : ShadowerrnCondition : Skill level above 5\n 2290095 - [Mastery Book] Smokescreen - This increases the master level of #cSmokescreen# up to 30 with 50% of chance.rnClass : ShadowerrnCondition : Skill level above 15\n-2290096 - [Mastery Book] Maple Warrior 20 - This increases the master level of #cMaple Warrior# up to 20 with 70% of chance.rnJob : All 4th Advancement JobsrnCondition : Skill level above 5\n+2290096 - [Mastery Book] Maple Warrior - This increases the master level of #cMaple Warrior# up to 20 with 70% of chance.rnJob : All 4th Advancement JobsrnCondition : Skill level above 5\n 2290097 - [Mastery Book] Dragon Strike - With a 70% success rate, it raises the Master Level of #cDragon Strike# to 20.nJob : BuccaneernRequirement : At least Level 5 in this skill\n 2290098 - [Mastery Book] Dragon Strike - With a 50% success rate, it raises the Master Level of #cDragon Strike# to 30.nJob : BuccaneernRequirement : At least Level 15 in this skill\n 2290099 - [Mastery Book] Energy Orb - With a 70% success rate, it raises the Master Level of #cEnergy Orb# to 20.nJob : BuccaneernRequirement : At least Level 5 in this skill\n@@ -1316,7 +1323,21 @@\n 2290122 - [Mastery Book] Battleship Torpedo - With a 50% success rate, it raises the Master Level of #cBattleship Torpedo# to 30.nJob : CorsairnRequirement : At least Level 15 in this skill\n 2290123 - [Mastery Book] Hypnotize - With a 70% success rate, it raises the Master Level of #cHypnotize# to 20.nJob : CorsairnRequirement : At least Level 5 in this skill\n 2290124 - [Mastery Book] Bullseye - With a 70% success rate, it raises the Master Level of #cBullseye# to 20.nJob : CorsairnRequirement : At least Level 5 in this skill\n-2290125 - [Mastery Book] Maple Warrior 30 - This increases the master level of #cMaple Warrior# up to 30 with 50% of chance.rnJob : All 4th Advancement JobsrnCondition : Skill level above 15\n+2290125 - [Mastery Book] Maple Warrior - This increases the master level of #cMaple Warrior# up to 30 with 50% of chance.rnJob : All 4th Advancement JobsrnCondition : Skill level above 15\n+2290126 - [Mastery Book] Overswing - With a 70% success rate, raises the Mastery Level of #cOverswing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290127 - [Mastery Book] Overswing - With a 50% success rate, raises the Mastery Level of #cOverswing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290128 - [Mastery Book] High Mastery - With a 70% success rate, raises the Mastery Level of #cHigh Mastery# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290129 - [Mastery Book] High Mastery - With a 50% success rate, raises the Mastery Level of #cHigh Mastery# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290130 - [Mastery Book] Freeze Standing - With a 70% success rate, raises the Mastery Level of #cFreeze Standing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290131 - [Mastery Book] Freeze Standing - With a 50% success rate, raises the Mastery Level of #cFreeze Standing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290132 - [Mastery Book] Final Blow - With a 70% success rate, raises the Mastery Level of #cFinal Blow# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290133 - [Mastery Book] Final Blow - With a 50% success rate, raises the Mastery Level of #cFinal Blow# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290134 - [Mastery Book] High Defense - With a 70% success rate, raises the Mastery Level of #cHigh Defense# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290135 - [Mastery Book] High Defense - With a 50% success rate, raises the Mastery Level of #cHigh Defense# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290136 - [Mastery Book] Combo Tempest - With a 70% success rate, raises the Mastery Level of #cCombo Tempest# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290137 - [Mastery Book] Combo Tempest - With a 50% success rate, raises the Mastery Level of #cCombo Tempest# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n+2290138 - [Mastery Book] Combo Barrier - With a 70% success rate, raises the Mastery Level of #cCombo Barrier# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n+2290139 - [Mastery Book] Combo Barrier - With a 50% success rate, raises the Mastery Level of #cCombo Barrier# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n 2310000 - The Owl of Minerva - #cThe Owl of Minerva#, which represents wisdom, can be used to search for items sold at the Free Market. #cDisappears right after showing the results of the item search#.\n 2320000 - Teleport Rock - Remembers 5 maps of your choice. This rock will enable you to #cteleport to the map you remembered#. It can even allow you to #cmove to the map where a certain character is#, provided that the person is in the same channel at the same world.\n 2330000 - Bullet - A bullet made out of steel. A set contains numerous bullets and once they are used up, they'll need to be recharged.\\nAttack + 10\n@@ -2162,27 +2183,6 @@\n 2109008 - Bubbling Summoning Bag - For use in the restricted bonus map area of the subway station.\n 2109009 - Jr. Yeti Pharaoh Summoning Bag - Summons Jr. Yeti Pharaoh for the bonus stage of Nett's Pyramid (Easy, Normal, Hard)\n 2109010 - Jr. Yeti Pharaoh Summoning Bag - Summons Jr. Yeti Pharaoh for the bonus stage of Nett's Pyramid (Hell Mode)\n-2280013 - [Skill Book] Final Blow - Skill Book from which you can learn about the #cFinal Blow# skill.\\nJob: 4th Lv Aran\\nCondition: #cFinal Blow# not available\n-2280014 - [Skill Book] High Defense - Skill Book from which you can learn about the #cHigh Defense# skill.\\nJob: 4th Lv Aran\\nCondition: #cHigh Defense# not available\n-2280015 - [Skill Book] Combo Tempest - Skill Book from which you can learn about the #cCombo Tempest# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Tempest# not available\n-2280017 - [Skill Book] Pig's Weakness - Skill Book from which you can learn about the #cPig's Weakness# skill.\\nCondition: #cPig's Weakness# not available\n-2280016 - [Skill Book] Combo Barrier - Skill Book from which you can learn about the #cCombo Barrier# skill.\\nJob: 4th Lv Aran\\nCondition: #cCombo Barrier# not available\n-2280018 - [Skill Book] Stump's Weakness - Skill Book from which you can learn about the #cStump's Weakness# skill.\\nCondition: #cStump's Weakness# not available\n-2280019 - [Skill Book] Slime's Weakness - Skill Book from which you can learn about the #cSlime's Weakness# skill.\\nCondition: #cSlime's Weakness# not available\n-2290126 - [Mastery Book] Overswing 20 - With a 70% success rate, raises the Mastery Level of #cOverswing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290127 - [Mastery Book] Overswing 30 - With a 50% success rate, raises the Mastery Level of #cOverswing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290128 - [Mastery Book] High Mastery 20 - With a 70% success rate, raises the Mastery Level of #cHigh Mastery# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290129 - [Mastery Book]High Mastery 30 - With a 50% success rate, raises the Mastery Level of #cHigh Mastery# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290130 - [Mastery Book] Freeze Standing 20 - With a 70% success rate, raises the Mastery Level of #cFreeze Standing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290131 - [Mastery Book] Freeze Standing 30 - With a 50% success rate, raises the Mastery Level of #cFreeze Standing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290132 - [Mastery Book] Final Blow 20 - With a 70% success rate, raises the Mastery Level of #cFinal Blow# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290133 - [Mastery Book] Final Blow 30 - With a 50% success rate, raises the Mastery Level of #cFinal Blow# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290134 - [Mastery Book] High Defense 20 - With a 70% success rate, raises the Mastery Level of #cHigh Defense# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290135 - [Mastery Book] High Defense 30 - With a 50% success rate, raises the Mastery Level of #cHigh Defense# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290136 - [Mastery Book] Combo Tempest 20 - With a 70% success rate, raises the Mastery Level of #cCombo Tempest# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290137 - [Mastery Book] Combo Tempest 30 - With a 50% success rate, raises the Mastery Level of #cCombo Tempest# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n-2290138 - [Mastery Book] Combo Barrier 20 - With a 70% success rate, raises the Mastery Level of #cCombo Barrier# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\n-2290139 - [Mastery Book] Combo Barrier 30 - With a 50% success rate, raises the Mastery Level of #cCombo Barrier# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\n 2380014 - Dejected Green Mushroom Card - A card featuring the Dejected Green Mushroom.\n 2380015 - Muru Card - A card featuring Muru.\n 2380016 - Murupa Card - A card featuring Murupa.\n@@ -2209,7 +2209,7 @@\n 2430016 - Crystal Chest - A chest full of items that's sure to excite anyone who sees it. Open it by August 31st, 2009, or it'll disappear.\n 2450000 - Hunter's Luck - For 30 minutes, doubles your EXP from hunting.\n 2040758 - Scroll for Shoes for ATT - Improves attack on shoes.\\nSuccess rate: 100%. Weapon Attack +1\n-2040759 - Scroll for Shoes for ATT - Improves attack on gloves.\\nSuccess rate: 60%. Weapon Attack +2. The success rate of this scroll can be enhanced by Vega's Spell.\n+2040759 - Scroll for Shoes for ATT - Improves attack on shoes.\\nSuccess rate: 60%. Weapon Attack +2. The success rate of this scroll can be enhanced by Vega's Spell.\n 2040760 - Scroll for Shoes for ATT - Improves attack on shoes.\\nSuccess rate: 10%, Weapon Attack +3. The success rate of this scroll can be enhanced by Vega's Spell.\n 2044815 - Scroll for Knuckler for Attack 100% - Improves attack on Knucklers.\\nSuccess rate: 100%. Weapon Attack +2, STR +1\n 2044817 - Scroll for Knuckler for Attack 50% - Improves attack on Knucklers.\\nSuccess rate: 50%. Weapon Attack +5, STR +3,  DEX +1"}, {"sha": "447ae673d7fa07b0b781669b9585ac2c99aba98c", "filename": "scripts/event/3rdJob_bowman.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_bowman.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_bowman.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_bowman.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_bowman_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     eim.getInstanceMap(maxMapId).resetPQ(1);\n     \n@@ -97,8 +105,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "aa244b5114bf345f4a4864b65b1ac9cd0c6b63a2", "filename": "scripts/event/3rdJob_magician.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_magician.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_magician.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_magician.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_magician_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     eim.getInstanceMap(maxMapId).resetPQ(1);\n     \n@@ -97,8 +105,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "b3f4bc0f7a1eeb3cd50409fedfc8765e960b3363", "filename": "scripts/event/3rdJob_mount.js", "status": "modified", "additions": 24, "deletions": 3, "changes": 27, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_mount.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_mount.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_mount.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -43,15 +43,38 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function checkHogHealth(eim) {\n+    var watchHog = eim.getInstanceMap(923010000).getMonsterById(9300102);\n+    if (watchHog != null) {\n+        var hp = watchHog.getHp();\n+        var oldHp = eim.getIntProperty(\"whog_hp\");\n+        \n+        if (oldHp - hp > 1000) {    // or 800, if using mobHP / eventTime\n+            eim.dropMessage(6, \"Please protect the pig from the aliens!\");  // thanks Vcoc\n+        }\n+        eim.setIntProperty(\"whog_hp\", hp);\n+    }\n+}\n+\n function respawnStages(eim) {\n     var i;\n     for (i = 0; i < eventMaps.length; i++) {\n         eim.getInstanceMap(eventMaps[i]).instanceMapRespawn();\n     }\n-\n+    checkHogHealth(eim);\n+    \n     eim.schedule(\"respawnStages\", 10 * 1000);\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_mount_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    eim.setProperty(\"whog_hp\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     var mapObj = eim.getInstanceMap(entryMap);\n     \n@@ -127,8 +150,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "ef18f1dc3141ab334716cc1bd2e571934c336520", "filename": "scripts/event/3rdJob_pirate.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_pirate.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_pirate.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_pirate.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -51,6 +51,14 @@ function playerEntry(eim, player) {\n     eim.startEventTimer(eventTime * 60000);\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_pirate_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerUnregistered(eim, player) {}\n \n function playerExit(eim, player) {\n@@ -97,8 +105,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "285c4d04842cfc4b4b35c5ee9ab09e1a6ada43f7", "filename": "scripts/event/3rdJob_thief.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_thief.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_thief.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_thief.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_thief_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     eim.getInstanceMap(maxMapId).resetPQ(1);\n     \n@@ -97,8 +105,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "f3b7f0bf970dcd1e67c59ab124ed85f80e7ee055", "filename": "scripts/event/3rdJob_warrior.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_warrior.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/3rdJob_warrior.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/3rdJob_warrior.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"3rdJob_warrior_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     eim.getInstanceMap(maxMapId).resetPQ(1);\n     \n@@ -97,8 +105,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "d3fd4fa7476e5f5a9f547ac04953d6f5539d79f3", "filename": "scripts/event/4jberserk.js", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/4jberserk.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/4jberserk.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jberserk.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -20,27 +20,22 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n var exitMap;\n-var instanceId;\n var minPlayers = 3;\n \n-function init() {\n-    instanceId = 1;\n-}\n+function init() {}\n \n function monsterValue(eim, mobId) {\n     return 1;\n }\n \n-function setup() {\n+function setup(level, lobbyid) {\n     exitMap = em.getChannelServer().getMapFactory().getMap(105090800); // <exit>\n-    var instanceName = \"4jberserk\" + instanceId;\n-\n-    var eim = em.newInstance(instanceName);\n+    \n+    var eim = em.newInstance(\"4jberserk_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n \t\n     var mf = eim.getMapFactory();\n-\t\n-    instanceId++;\n-\t\n+    \n     var map = mf.getMap(910500200);\n     map.addMapTimer(3*60);\n     em.schedule(\"timeOut\", 20 * 60000);"}, {"sha": "a1258d0ec6d9057631456aaec50b599c21cb0c6d", "filename": "scripts/event/4jrush.js", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/4jrush.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/4jrush.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/4jrush.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -27,23 +27,21 @@\n  */\n \n var exitMap;\n-var instanceId;\n var minPlayers = 3;\n \n-function init() {\n-    instanceId = 1;\n-}\n+function init() {}\n \n function monsterValue(eim, mobId) {\n     return 1;\n }\n \n-function setup() {\n+function setup(level, lobbyid) {\n     exitMap = em.getChannelServer().getMapFactory().getMap(105090700); // <exit>\n-    var instanceName = \"4jrush\" + instanceId;\n-    var eim = em.newInstance(instanceName);\n+    \n+    var eim = em.newInstance(\"4jrush_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    \n     var mf = eim.getMapFactory();\n-    instanceId++;\n     var map = mf.getMap(910500100);\n     map.addMapTimer(20*60);\n     em.schedule(\"timeOut\", 20 * 60000);"}, {"sha": "1be6114b18f299ad98f0af68a143628bb71395eb", "filename": "scripts/event/Aran_2ndmount.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Aran_2ndmount.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Aran_2ndmount.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Aran_2ndmount.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"Aran_2ndmount_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function respawnStages(eim) {}\n \n function playerEntry(eim, player) {\n@@ -114,8 +122,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "04e135d0b8c090f3b5dcc114d5225c7cb49a1cc9", "filename": "scripts/event/Aran_3rdmount.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Aran_3rdmount.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Aran_3rdmount.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Aran_3rdmount.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"Aran_3rdmount_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function respawnStages(eim) {}\n \n function playerEntry(eim, player) {\n@@ -119,8 +127,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function afterSetup(eim) {}"}, {"sha": "fcef456bf4fb80cc37c0addc74c62bf64997c218", "filename": "scripts/event/BalrogQuest.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/BalrogQuest.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/BalrogQuest.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/BalrogQuest.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,6 +41,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"BalrogQuest_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function respawnStages(eim) {}\n \n function afterSetup(eim) {}\n@@ -104,8 +112,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function disbandParty(eim, player) {}\n \n function changedLeader(eim, leader) {}"}, {"sha": "a01e6e072a3ced5d6b23191142fae022dfcb5bed", "filename": "scripts/event/DollHouse.js", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/DollHouse.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/DollHouse.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/DollHouse.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -32,6 +32,14 @@ function init() {\n     em.setProperty(\"noEntry\",\"false\");\n }\n \n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"DollHouse_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n+    return eim;\n+}\n+\n function playerEntry(eim, player) {\n     eim.getInstanceMap(entryMap).shuffleReactors();\n     eim.setExclusiveItems([4031094]);\n@@ -81,8 +89,6 @@ function dispose() {}\n \n // ---------- FILLER FUNCTIONS ----------\n \n-function setup(eim, leaderid) {}\n-\n function monsterValue(eim, mobid) {return 0;}\n \n function disbandParty(eim, player) {}"}, {"sha": "24e33279d9b4b440099dedc2acfcf38bc698d735", "filename": "scripts/event/Hak.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Hak.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/Hak.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/Hak.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -16,8 +16,8 @@ function init() {\n     rideTime = em.getTransportationTime(rideTime);\n }\n \n-function setup() {\n-\tvar eim = em.newInstance(\"Hak_\" + + em.getProperty(\"player\"));\n+function setup(level, lobbyid) {\n+\tvar eim = em.newInstance(\"Hak_\" + lobbyid);\n \treturn eim;\n }\n "}, {"sha": "516af052c58f427f29e33ca547e8bd0ff5d23e65", "filename": "scripts/event/KerningTrain.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/KerningTrain.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/KerningTrain.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KerningTrain.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -16,8 +16,8 @@ function init() {\n     rideTime = em.getTransportationTime(rideTime);\n }\n \n-function setup() {\n-\tvar eim = em.newInstance(\"KerningTrain_\" + em.getProperty(\"player\"));\n+function setup(level, lobbyid) {\n+\tvar eim = em.newInstance(\"KerningTrain_\" + lobbyid);\n \treturn eim;\n }\n "}, {"sha": "fe043ad251cffb7c026b981f6f4daf027d8b1247", "filename": "scripts/event/RockSpirit.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/RockSpirit.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/RockSpirit.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/RockSpirit.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -34,8 +34,11 @@ function init() {\n     otherMap = em.getChannelServer().getMapFactory().getMap(103040420);\n }\n \n-function setup() {\n-    var eim = em.newInstance(\"RockSpirit_\" + em.getProperty(\"player\"));\n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"RockSpirit_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n     respawn(eim);\n     eim.startEventTimer(timer);    \n     return eim;"}, {"sha": "4de76839c1655b4f38aa65656d2a13a5bb790ba1", "filename": "scripts/event/RockSpiritVIP.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/RockSpiritVIP.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/RockSpiritVIP.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/RockSpiritVIP.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -34,8 +34,11 @@ function init() {\n \totherMap = em.getChannelServer().getMapFactory().getMap(103040450);\n }\n \n-function setup() {\n-    var eim = em.newInstance(\"RockSpiritVIP_\" + em.getProperty(\"player\"));\n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"RockSpiritVIP_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n+    eim.setProperty(\"boss\", \"0\");\n+    \n     respawn(eim);\n     eim.startEventTimer(timer);    \n \treturn eim;"}, {"sha": "24867aaa3b92a97a6b303986d587b7206359519f", "filename": "scripts/event/s4aWorld.js", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/s4aWorld.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/event/s4aWorld.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/s4aWorld.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -33,8 +33,9 @@ function getEligibleParty(party) {      //selects, from the given party, the tea\n         return eligible;\n }\n \n-function setup() {\n-    var eim = em.newInstance(\"s4aWorld\");\n+function setup(level, lobbyid) {\n+    var eim = em.newInstance(\"s4aWorld_\" + lobbyid);\n+    eim.setProperty(\"level\", level);\n \n     eim.getInstanceMap(910500000).resetPQ(1);\n     respawnStages(eim);"}, {"sha": "0a346311d3be7d6f2a0758c0b87dd57a52a23a29", "filename": "scripts/map/onUserEnter/200090000.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/200090000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/200090000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/200090000.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -3,12 +3,12 @@ importPackage(Packages.tools);\n \n var mapId = 200090000;\n \n-function start(pi) {\n-\tvar map = pi.getClient().getChannelServer().getMapFactory().getMap(mapId);\n+function start(ms) {\n+\tvar map = ms.getClient().getChannelServer().getMapFactory().getMap(mapId);\n \n \tif(map.getDocked()) {\n-\t\tpi.getClient().announce(MaplePacketCreator.musicChange(\"Bgm04/ArabPirate\"));\n-\t\tpi.getClient().announce(MaplePacketCreator.crogBoatPacket(true));\n+\t\tms.getClient().announce(MaplePacketCreator.musicChange(\"Bgm04/ArabPirate\"));\n+\t\tms.getClient().announce(MaplePacketCreator.crogBoatPacket(true));\n \t}\n \n \treturn(true);"}, {"sha": "bf114d894f1d307ed2ccfd5f4a171c7cbf279a2f", "filename": "scripts/map/onUserEnter/200090010.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/200090010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/200090010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/200090010.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -3,12 +3,12 @@ importPackage(Packages.tools);\n \n var mapId = 200090010;\n \n-function start(pi) {\n-\tvar map = pi.getClient().getChannelServer().getMapFactory().getMap(mapId);\n+function start(ms) {\n+\tvar map = ms.getClient().getChannelServer().getMapFactory().getMap(mapId);\n \n \tif(map.getDocked()) {\n-\t\tpi.getClient().announce(MaplePacketCreator.musicChange(\"Bgm04/ArabPirate\"));\n-\t\tpi.getClient().announce(MaplePacketCreator.crogBoatPacket(true));\n+\t\tms.getClient().announce(MaplePacketCreator.musicChange(\"Bgm04/ArabPirate\"));\n+\t\tms.getClient().announce(MaplePacketCreator.crogBoatPacket(true));\n \t}\n \n \treturn(true);"}, {"sha": "8ef2f3647efe78fb070ba1e27ab4f4cc05cc6856", "filename": "scripts/map/onUserEnter/922000000.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/922000000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/map/onUserEnter/922000000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/map/onUserEnter/922000000.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1,5 +1,5 @@\n-function start(pi) {\n-\tvar map = pi.getClient().getChannelServer().getMapFactory().getMap(922000000);\n+function start(ms) {\n+\tvar map = ms.getClient().getChannelServer().getMapFactory().getMap(922000000);\n         map.clearDrops();\n \tmap.resetReactors();\n \tmap.shuffleReactors();"}, {"sha": "8636978a81f27bf8235d96eb30afd6de2e19fdd9", "filename": "scripts/npc/1052007.js", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1052007.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1052007.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052007.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -25,10 +25,11 @@ function action(mode, type, selection) {\n     }\n     if (status == 1) {\n         if (selection == 0) {\n-    \t\tvar train = cm.getEventManager(\"KerningTrain\");\n-        \ttrain.newInstance(\"KerningTrain\");\n-        \ttrain.setProperty(\"player\", cm.getPlayer().getName());\n-        \ttrain.startInstance(cm.getPlayer());\n+    \t\tvar em = cm.getEventManager(\"KerningTrain\");\n+                if (!em.startInstance(cm.getPlayer())) {\n+                    cm.sendOk(\"The passenger wagon is already full. Try again a bit later.\");\n+                }\n+                \n         \tcm.dispose();\n         \treturn;\n         } else if (selection == 1) {"}, {"sha": "05f5a8d6343004e9d681e5795c95ea48d3ca74fb", "filename": "scripts/npc/1052125.js", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1052125.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1052125.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1052125.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -47,10 +47,10 @@ function action(mode, type, selection) {\n     if (status == 0) {\n     \tif (selection == 0) {\n     \t\tif (cm.isQuestStarted(2286) || cm.isQuestStarted(2287) || cm.isQuestStarted(2288)) {\n-        \t\tvar rock = cm.getEventManager(\"RockSpirit\");\n-        \t\trock.newInstance(\"RockSpirit\");\n-        \t\trock.setProperty(\"player\", cm.getPlayer().getName());\n-        \t\trock.startInstance(cm.getPlayer());\n+        \t\tvar em = cm.getEventManager(\"RockSpirit\");\n+                        if (!em.startInstance(cm.getPlayer())) {\n+                            cm.sendOk(\"Uh... It looks like the rooms ahead are a bit crowded right now. Please wait around here for a bit, ok?\");\n+                        }\n     \t\t\tcm.dispose();\n     \t\t\treturn;\n     \t\t} else {"}, {"sha": "3062c8eb24aa8faa446c9b492c902d6f8d86cd0f", "filename": "scripts/npc/1061009.js", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1061009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1061009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061009.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -59,13 +59,12 @@ function start() {\n         if (em == null)\n             cm.sendOk(\"Sorry, but 3rd job advancement (\" + js + \") is closed.\");\n         else {\n-            if (em.getProperty(\"noEntry\") == \"false\") {\n-                var eim = em.newInstance(\"3rdjob_\" + js);\n-                eim.registerPlayer(cm.getPlayer());\n-            }\n-            else {\n+            if (!em.startInstance(cm.getPlayer())) {\n                 cm.sendOk(\"Someone else is already challenging the clone. Please wait until the area is cleared.\");\n             }\n+            \n+            cm.dispose();\n+            return;\n         }\n     }\n     "}, {"sha": "ce3cd86ffadbabf56571bc3e40fb817e3801a16a", "filename": "scripts/npc/1061014.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1061014.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1061014.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1061014.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -174,7 +174,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "ed62c35219ecc4d3b5b936dced90c86a578e7503", "filename": "scripts/npc/1300013.js", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1300013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/1300013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1300013.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -6,7 +6,7 @@\n var status;\n \n function start(){\n-\tstatus = -1;\n+        status = -1;\n \taction(1, 0, 0);\n }\n \n@@ -26,6 +26,11 @@ function action(mode, type, selection){\n \n \n         if(cm.getMapId() == 106021402) {\n+                if (!(cm.isQuestCompleted(2331))) {\n+                        cm.dispose();\n+                        return;\n+                }\n+            \n                 if(status == 0){\n                         cm.sendSimple(\"#L0#Enter to fight #bKing Pepe#k and #bYeti Brothers#k.#l\\r\\n#L1#Enter to fight #bPrime Minister#k.#l\");\n                 }\n@@ -48,6 +53,12 @@ function action(mode, type, selection){\n                         }\n                 }\n         } else {\n+                var questProgress = cm.getQuestProgress(2330, 3300005) + cm.getQuestProgress(2330, 3300006) + cm.getQuestProgress(2330, 3300007); //3 Yetis\n+                if (!(cm.isQuestStarted(2330) && questProgress < 3)) {  // thanks Vcoc for finding an exploit with boss entry through NPC\n+                        cm.dispose();\n+                        return;\n+                }\n+            \n                 if(status == 0){\n                         cm.sendSimple(\"#L1#Enter to fight #bKing Pepe#k and #bYeti Brothers#k.#l\");\n                 }"}, {"sha": "ce8ab3516e4ff38085da511dca20712ddf55f6f0", "filename": "scripts/npc/2020008.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020008.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -140,11 +140,11 @@ function action(mode, type, selection){\n             }\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n-            \tcm.sendNext(\"Ok, go.\");\n+            \tcm.sendOk(\"The Chief's Residence Council grants you #bconcession#k to make part of the #rcounteroffensive team against Zakum#k. Good luck on your journey ahead.\");\n                 if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n-                cm.sendNext(\"You're weak.\");\n+                cm.sendOk(\"You're way too weak to make part of the #rcounteroffensive team against Zakum#k. Reach at least #blevel 50#k, then talk to me.\");\n             cm.dispose();\n         }\n     }"}, {"sha": "5e759803ef5928b809c0e3ade502997d705af5e5", "filename": "scripts/npc/2020009.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020009.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020009.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020009.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -112,11 +112,11 @@ function action(mode, type, selection){\n \t\t\t}\n             } else {\n                 if (cm.getPlayer().getLevel() >= 50){\n-            \t    cm.sendNext(\"Ok, go.\");\n+            \t    cm.sendOk(\"The Chief's Residence Council grants you #bconcession#k to make part of the #rcounteroffensive team against Zakum#k. Good luck on your journey ahead.\");\n                     if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                     if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n                 }else\n-                    cm.sendNext(\"You're weak.\");\n+                    cm.sendOk(\"You're way too weak to make part of the #rcounteroffensive team against Zakum#k. Reach at least #blevel 50#k, then talk to me.\");\n                 cm.dispose();\n             }\n \t}"}, {"sha": "b4de6203d5cf38635b04ffdde69670743a353c9c", "filename": "scripts/npc/2020010.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020010.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020010.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020010.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -113,11 +113,11 @@ function action(mode, type, selection){\n \t\t\t}\n             } else {\n             \tif (cm.getPlayer().getLevel() >= 50){\n-            \t\tcm.sendNext(\"Ok, go.\");\n+            \t\tcm.sendOk(\"The Chief's Residence Council grants you #bconcession#k to make part of the #rcounteroffensive team against Zakum#k. Good luck on your journey ahead.\");\n                 \tif(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                         if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             \t}else\n-                \tcm.sendNext(\"You're weak.\");\n+                \tcm.sendOk(\"You're way too weak to make part of the #rcounteroffensive team against Zakum#k. Reach at least #blevel 50#k, then talk to me.\");\n             \tcm.dispose();\n             }\n \t}"}, {"sha": "811ca153f26853aff0e8d2f5337dadcce9cea7ff", "filename": "scripts/npc/2020011.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020011.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020011.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020011.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -112,11 +112,11 @@ function action(mode, type, selection){\n             }\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n-            \tcm.sendNext(\"Ok, go.\");\n+            \tcm.sendOk(\"The Chief's Residence Council grants you #bconcession#k to make part of the #rcounteroffensive team against Zakum#k. Good luck on your journey ahead.\");\n                 if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n-                cm.sendNext(\"You're weak.\");\n+                cm.sendOk(\"You're way too weak to make part of the #rcounteroffensive team against Zakum#k. Reach at least #blevel 50#k, then talk to me.\");\n             cm.dispose();\n         }\n     }"}, {"sha": "f18199331d30ac6be22d768dd24b8668ae1429b5", "filename": "scripts/npc/2020013.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2020013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2020013.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -111,11 +111,11 @@ function action(mode, type, selection){\n             }\n         } else {\n             if (cm.getPlayer().getLevel() >= 50){\n-            \tcm.sendNext(\"Ok, go.\");\n+            \tcm.sendOk(\"The Chief's Residence Council grants you #bconcession#k to make part of the #rcounteroffensive team against Zakum#k. Good luck on your journey ahead.\");\n                 if(!(cm.isQuestStarted(100200) || cm.isQuestCompleted(100200))) cm.startQuest(100200);\n                 if(Packages.constants.ServerConstants.USE_ENABLE_SOLO_EXPEDITIONS && !cm.isQuestCompleted(100201)) cm.completeQuest(100201);\n             }else\n-                cm.sendNext(\"You're weak.\");\n+                cm.sendOk(\"You're way too weak to make part of the #rcounteroffensive team against Zakum#k. Reach at least #blevel 50#k, then talk to me.\");\n             cm.dispose();\n         }\n     }"}, {"sha": "15af48201bd0df433e9812fbeed2cd75416d8873", "filename": "scripts/npc/2030013.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2030013.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2030013.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030013.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -176,7 +176,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");    // getValue, thanks MedicOP for finding this issue\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "a7ea949fa0aa0ee75bd333218c57aff5b6fe121f", "filename": "scripts/npc/2030013_old.js", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2030013_old.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2030013_old.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2030013_old.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -78,13 +78,13 @@ function action(mode, type, selection) {\n                     if (getEimForString(em,passwd) != null)\n                         cm.sendOk(\"You may not use that password.\");\n                     else { // start Zakum Battle\n-                        var eim = em.newInstance(\"Zakum\" + passwd);\n-                        if(!em.startInstance(eim,cm.getPlayer().getName())) {\n-                            cm.sendOk(\"A party in your name is already registered in this instance.\");\n-                            cm.dispose();\n-                            return;\n+                        //var em = cm.getEventManager(\"Zakum\" + passwd);\n+                        if (!em.startInstance(cm.getPlayer())) {\n+                            cm.sendOk(\"A party is already registered in this instance.\");\n                         }\n-                        eim.registerPlayer(cm.getPlayer());\n+\n+                        cm.dispose();\n+                        return;\n                     }\n                 }\n                 if (state == 1) { // Member"}, {"sha": "4e81a20573051bfb1d7889ea8a56e31cd902ebaa", "filename": "scripts/npc/2040002.js", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2040002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2040002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040002.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -56,8 +56,11 @@ function action(mode, type, selection) {\n         if (status == 1) \n             cm.sendYesNo(\"Are you ready to enter the dollhouse map?\");\n         else if (status == 2) {\n-            var eim = em.newInstance(\"DollHouse\");\n-            eim.registerPlayer(cm.getPlayer());\n+            var em = cm.getEventManager(\"DollHouse\");\n+            if (!em.startInstance(cm.getPlayer())) {\n+                cm.sendOk(\"Hmm... The DollHouse is being challenged already, it seems. Try again later.\");\n+            }\n+            \n             cm.dispose();\n         }\n     }"}, {"sha": "d9a200973329e75bd1427c0f057715f5dc32ed0d", "filename": "scripts/npc/2060005.js", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2060005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2060005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2060005.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -36,11 +36,7 @@ function start() {\n         if (em == null)\n             cm.sendOk(\"Sorry, but 3rd job advancement (mount) is closed.\");\n         else {\n-            if (em.getProperty(\"noEntry\") == \"false\") {\n-                var eim = em.newInstance(\"3rdjob_mount\");\n-                eim.registerPlayer(cm.getPlayer());\n-            }\n-            else {\n+            if (!em.startInstance(cm.getPlayer())) {\n                 cm.sendOk(\"There is currently someone in this map, come back later.\");\n             }\n         }"}, {"sha": "7960c49c4f6401e6362ea4fb5d6d24167fd68fb9", "filename": "scripts/npc/2083004.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2083004.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2083004.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2083004.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -168,7 +168,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "be092366f1772387faf8a7897fdae25327b63433", "filename": "scripts/npc/2090005.js", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2090005.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2090005.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2090005.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -85,10 +85,14 @@ function action(mode, type, selection) {\n                             cm.warp(250000100, 0);\n                             cm.dispose();\n                         } else {\n+                            var em = cm.getEventManager(\"Hak\");\n+                            if (!em.startInstance(cm.getPlayer())) {\n+                                cm.sendOk(\"Uh... We are currently taking requests from too many maplers right now... Please try again in a bit.\");\n+                                cm.dispose();\n+                                return;\n+                            }\n+                            \n                             cm.gainMeso(-cost[slct]);\n-                            hak.newInstance(\"Hak\");\n-                            hak.setProperty(\"player\", cm.getPlayer().getName());\n-                            hak.startInstance(cm.getPlayer());\n                             cm.dispose();\n                         }\n                 }"}, {"sha": "e0336c95851ccbfdcf4352d582fdf92f4712633d", "filename": "scripts/npc/2141001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2141001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/2141001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2141001.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -171,7 +171,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "275acfa41591e1f57bc126a29945a2f295f93e02", "filename": "scripts/npc/9120201.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9120201.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9120201.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9120201.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -175,7 +175,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "4c9621d43188b097ef06a7af7b4e7910d91769a2", "filename": "scripts/npc/9201113.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9201113.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9201113.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9201113.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -158,7 +158,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "6b3418ca4b44c626e7f275d0ec33f6beeb07e4c9", "filename": "scripts/npc/9270047.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9270047.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9270047.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9270047.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -175,7 +175,7 @@ function action(mode, type, selection) {\n             if (selection > 0) {\n                 var banned = expedMembers.get(selection - 1);\n                 expedition.ban(banned);\n-                cm.sendOk(\"You have banned \" + banned.getName() + \" from the expedition.\");\n+                cm.sendOk(\"You have banned \" + banned.getValue() + \" from the expedition.\");\n                 cm.dispose();\n             } else {\n                 cm.sendSimple(list);"}, {"sha": "95910632629fd46cd201e5dae510be374c915845", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -48,6 +48,7 @@ function writeFeatureTab_PQs() {\n         addFeature(\"Mu Lung Dojo.\");\n         addFeature(\"Capt. Latanica with party fighting the boss.\");\n         addFeature(\"Filled up missing obligatory event script methods.\");\n+        addFeature(\"Secured uniquety of active lobby-name instances.\");\n }\n \n function writeFeatureTab_Skills() {\n@@ -126,7 +127,9 @@ function writeFeatureTab_MonstersMapsReactors() {\n         addFeature(\"Mobs now can drop more than one of the same equip.\");\n         addFeature(\"Mobs only drop items collectable by the player/party.\");\n         addFeature(\"Mobs shouldn't fall from foothold too often now.\");\n+        addFeature(\"Puppets holds targeted mobs nearby on new aggro feat.\");\n         addFeature(\"Properly applying MP cost on non-skill mob moves.\");\n+        addFeature(\"Limited underling mob spawns.\");\n         addFeature(\"Implemented mob banish by touch & skill move.\");\n         addFeature(\"Redesigned HT mechanics: assemble & dmg taken.\");\n         addFeature(\"Implemented Zombify disease status.\");\n@@ -253,10 +256,12 @@ function writeFeatureTab_Project() {\n         addFeature(\"Improved login phase, using cache over DB queries.\");\n         addFeature(\"Protected many flaws with login management system.\");\n         addFeature(\"Developed a robust anti-exploit login coordinator.\");\n+        addFeature(\"Revised uniqueness aspect of logged in accounts.\");\n         addFeature(\"Usage of HikariCP to improve DB connection calls.\");\n         addFeature(\"Usage of Java Threadpool to improve runnable calls.\");\n         addFeature(\"Developed many survey tools for content profiling.\");\n         addFeature(\"Removed dangling item name throughout game files.\");\n+        addFeature(\"Remodeled item scripts, properly using NPC dialogs.\");\n         addFeature(\"ThreadTracker: runtime tool for deadlock detection.\");\n         addFeature(\"Channel, World and Server-wide timer management.\");\n         addFeature(\"Thoroughly reviewed encapsulation for player stats.\");"}, {"sha": "213f7aa04f9aa9901f6d22c67df7c1bf9a0a2f90", "filename": "scripts/portal/Depart_ToKerning.js", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/Depart_ToKerning.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/Depart_ToKerning.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/Depart_ToKerning.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1,8 +1,10 @@\n function enter(pi) {\n+        var em = pi.getEventManager(\"KerningTrain\");\n+        if (!em.startInstance(pi.getPlayer())) {\n+            pi.message(\"The passenger wagon is already full. Try again a bit later.\");\n+            return false;\n+        }\n+        \n \tpi.playPortalSound();\n-\tvar train = pi.getEventManager(\"KerningTrain\");\n-\ttrain.newInstance(\"KerningTrain\");\n-\ttrain.setProperty(\"player\", pi.getPlayer().getName());\n-\ttrain.startInstance(pi.getPlayer());\n \treturn true;\n }\n\\ No newline at end of file"}, {"sha": "225c2e42a201f7b5ddc9728f3fcf9bf565f1aed1", "filename": "scripts/portal/enterRider.js", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/enterRider.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/enterRider.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/enterRider.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -6,14 +6,13 @@ function enter(pi) {\n             return false;\n         }\n         else {\n-            if (em.getProperty(\"noEntry\") == \"false\") {\n-                var eim = em.newInstance(\"Aran_2ndmount\");\n-                eim.registerPlayer(pi.getPlayer());\n-                return true;\n-            }\n-            else {\n+            var em = pi.getEventManager(\"Aran_2ndmount\");\n+            if (!em.startInstance(pi.getPlayer())) {\n                 pi.message(\"There is currently someone in this map, come back later.\");\n                 return false;\n+            } else {\n+                pi.playPortalSound();\n+                return true;\n             }\n         }\n     } else {"}, {"sha": "e1af259317a2b78dbd3956382d1f00573ddd3d31", "filename": "scripts/portal/q2073.js", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/q2073.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/q2073.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/q2073.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -28,6 +28,8 @@ function enter(pi) {\n \t\tpi.playPortalSound();\n \t\tpi.warp(900000000, 0);\n \t\treturn true;\n-\t} \n-    return false;\n+\t} else {\n+                pi.message(\"Private property. This place can only be entered when running an errand from Camila.\");\n+                return false;\n+        }\n }\n\\ No newline at end of file"}, {"sha": "c112ece152a7edc12645b7744ce4857102757b92", "filename": "scripts/portal/rankRoom.js", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/rankRoom.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/portal/rankRoom.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/rankRoom.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -20,6 +20,9 @@ function enter(pi) {\n \tcase 100000201:\n             pi.warp(100000204, 2); //or 100000205\n             break;\n+        case 101000003: // portal warp fix thanks to Vcoc\n+            pi.warp(101000004, 2); //or 101000005\n+            break;\n \tdefault:\n             pi.warp(pi.getMapId() + 1, 1); //or + 2\n             break;"}, {"sha": "0e52708254bb5bb90a16dfdd9cbbe3044c96a9a8", "filename": "scripts/quest/21401.js", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/21401.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/21401.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21401.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -22,13 +22,13 @@ function start(mode, type, selection) {\n \t} else if (status == 3) {\n \t\tqm.sendAcceptDecline(\"Please, Aran. Please stop me from becoming enraged. Only you can control me. It's getting out of my hands now. Please do whatever it takes to #rstop me from going berserk#k!\");\n \t} else if (status == 4) {\n-\t\tqm.startQuest();\n-\t\t\n-                var mb = qm.getEventManager(\"MahaBattle\");\n-                mb.newInstance(\"MahaBattle\");\n-                mb.setProperty(\"player\", qm.getPlayer().getName());\n-                mb.startInstance(qm.getPlayer());\n-\t\t\n+\t\tvar em = qm.getEventManager(\"MahaBattle\");\n+                if (!em.startInstance(qm.getPlayer())) {\n+                    qm.sendOk(\"There is currently someone in this map, come back later.\");\n+                } else {\n+                    qm.startQuest();\n+                }\n+                \n \t\tqm.dispose();\n \t}\n }"}, {"sha": "cc99db89f438b5c5436814db1594769dc9c5de39", "filename": "scripts/quest/21613.js", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/21613.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/21613.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/21613.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -48,17 +48,14 @@ function start(mode, type, selection) {\n                 return;\n             }\n             else {\n-                if (em.getProperty(\"noEntry\") == \"false\") {\n-                    var eim = em.newInstance(\"Aran_3rdmount\");\n-                    eim.registerPlayer(qm.getPlayer());\n-                    \n-                    qm.forceStartQuest();\n-                    qm.dispose();\n-                }\n-                else {\n+                var em = qm.getEventManager(\"Aran_3rdmount\");\n+                if (!em.startInstance(qm.getPlayer())) {\n                     qm.sendOk(\"There is currently someone in this map, come back later.\");\n-                    qm.dispose();\n+                } else {\n+                    qm.forceStartQuest();\n                 }\n+                \n+                qm.dispose();\n             }\n         }\n     }"}, {"sha": "f5d503c15360a91ee929e85bd42159c208f27d5b", "filename": "scripts/quest/2245.js", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/2245.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/2245.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2245.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -42,17 +42,14 @@ function start(mode, type, selection) {\n                 return;\n             }\n             \n-            if (em.getProperty(\"noEntry\") == \"false\") {\n-                var eim = em.newInstance(\"BalrogQuest\");\n-                eim.registerPlayer(qm.getPlayer());\n-                eim.startEvent();\n-\n-                qm.dispose();\n-            }\n-            else {\n+            var em = qm.getEventManager(\"BalrogQuest\");\n+            if (!em.startInstance(qm.getPlayer())) {\n                 qm.sendOk(\"There is currently someone in this map, come back later.\");\n-                qm.dispose();\n+            } else {\n+                qm.forceStartQuest();\n             }\n+\n+            qm.dispose();\n         }\n     }\n }"}, {"sha": "d9d6588f57afa7491baf38d9ea16968bd6f27b44", "filename": "scripts/quest/2291.js", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/2291.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/2291.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/2291.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -43,13 +43,14 @@ function end(mode, type, selection) {\n             \n             qm.sendNext(\"You got the #b#i4032521##k with you, great. Let me show you the way.\");\n         } else if (status == 1) {\n-            qm.gainItem(4032521, -10);\n-            \n-            var rock = qm.getEventManager(\"RockSpiritVIP\");\n-            rock.newInstance(\"RockSpiritVIP\");\n-            rock.setProperty(\"player\", qm.getPlayer().getName());\n-            rock.startInstance(qm.getPlayer());\n+            var em = qm.getEventManager(\"RockSpiritVIP\");\n+            if (!em.startInstance(qm.getPlayer())) {\n+                qm.sendOk(\"Uh... It looks like the rooms ahead are a bit crowded right now. Please wait around here for a bit, ok?\");\n+                qm.dispose();\n+                return;\n+            }\n             \n+            qm.gainItem(4032521, -10);\n             qm.forceCompleteQuest();\n             qm.dispose();\n         }"}, {"sha": "7868cb80bca7cc70aab6f418e4d397802a41b476", "filename": "scripts/quest/3714.js", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/3714.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/scripts/quest/3714.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/quest/3714.js?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -41,9 +41,22 @@ function start(mode, type, selection) {\n                 return;\n             }\n             \n-            qm.sendNext(\"You have brought a #b#t4001094##k, thank you for the effort!\");\n+            if (qm.haveItem(2041200, 1)) {\n+                qm.sendOk(\"(The #b#t2041200##k in my bag has grown brighter since reaching this place... Noticing again, the young dragon over there seems to be glaring bitterly towards it.)\");\n+                qm.dispose();\n+                return;\n+            }\n+            \n+            qm.sendNext(\"You have brought a #b#t4001094##k, thank you for retrieving one more of my kin to the nest! Please have this...\\r\\n\\r\\n....... (bleuuhnuhgh) (blahrgngnhhng) ...\\r\\n\\r\\nehh, #b#t2041200##k as a token of my kin's gratitude. And do a favor for us, please, get that thing out of here...\");\n         } else if (status == 1) {\n+            if (!qm.canHold(2041200, 1)) {\n+                qm.sendOk(\"Please make a room on your USE inventory to receive the reward.\");\n+                qm.dispose();\n+                return;\n+            }\n+            \n             qm.gainItem(4001094, -1);\n+            qm.gainItem(2041200, 1);    // quest not rewarding properly found thanks to MedicOP & Thora\n             qm.gainExp(42000);\n             \n             qm.forceCompleteQuest();"}, {"sha": "ca9b1715655e57083fed0d83c19531be77e31c65", "filename": "sql/db_database.sql", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -16458,6 +16458,7 @@ CREATE TABLE IF NOT EXISTS `pets` (\n   `closeness` int(10) unsigned NOT NULL,\n   `fullness` int(10) unsigned NOT NULL,\n   `summoned` tinyint(1) NOT NULL DEFAULT '0',\n+  `flag` int(10) unsigned NOT NULL DEFAULT '0',\n   PRIMARY KEY (`petid`)\n ) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;\n "}, {"sha": "7645da228c2e807916fc2170a7cc48793122261f", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 43, "deletions": 35, "changes": 78, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -66,6 +66,7 @@\n import scripting.event.EventInstanceManager;\n import server.CashShop;\n import server.MapleItemInformationProvider;\n+import server.MapleItemInformationProvider.ScriptedItem;\n import server.MaplePortal;\n import server.MapleShop;\n import server.MapleStatEffect;\n@@ -287,6 +288,7 @@\n     private AutobanManager autoban;\n     private boolean isbanned = false;\n     private boolean blockCashShop = false;\n+    private boolean allowExpGain = false;\n     private byte pendantExp = 0, lastmobcount = 0, doorSlot = -1;\n     private List<Integer> trockmaps = new ArrayList<>();\n     private List<Integer> viptrockmaps = new ArrayList<>();\n@@ -649,6 +651,10 @@ public void addPet(MaplePet pet) {\n     \n     public void addSummon(int id, MapleSummon summon) {\n         summons.put(id, summon);\n+        \n+        if (summon.isPuppet()) {\n+            map.addPlayerPuppet(this);\n+        }\n     }\n \n     public void addVisibleMapObject(MapleMapObject mo) {\n@@ -805,6 +811,10 @@ public boolean cannotEnterCashShop() {\n     public void toggleBlockCashShop() {\n         blockCashShop = !blockCashShop;\n     }\n+    \n+    public void toggleExpGain() {\n+        allowExpGain = !allowExpGain;\n+    }\n \n     public void setClient(MapleClient c) {\n         this.client = c;\n@@ -1728,6 +1738,15 @@ public int getNumControlledMonsters() {\n         }\n     }\n     \n+    public Collection<MapleMonster> getControlledMonsters() {\n+        cpnLock.lock();\n+        try {\n+            return new ArrayList<>(controlled);\n+        } finally {\n+            cpnLock.unlock();\n+        }\n+    }\n+    \n     public void releaseControlledMonsters() {\n         Collection<MapleMonster> controlledMonsters;\n         \n@@ -1799,7 +1818,7 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                 mpcs = getPartyMembersOnSameMap();\n             }\n             \n-            String itemScriptName = null;\n+            ScriptedItem itemScript = null;\n             mapitem.lockItem();\n             try {\n                 if (mapitem.isPickedUp()) {\n@@ -1872,9 +1891,9 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                             this.gainMeso(mapitem.getMeso(), true, true, false);\n                         }\n                     } else if (mItem.getItemId() / 10000 == 243) {\n-                        MapleItemInformationProvider.scriptedItem info = ii.getScriptedItemInfo(mItem.getItemId());\n-                        if (info.runOnPickup()) {\n-                            itemScriptName = info.getScript();\n+                        ScriptedItem info = ii.getScriptedItemInfo(mItem.getItemId());\n+                        if (info != null && info.runOnPickup()) {\n+                            itemScript = info;\n                         } else {\n                             if (!MapleInventoryManipulator.addFromDrop(client, mItem, true)) {\n                                 client.announce(MaplePacketCreator.enableActions());\n@@ -1908,11 +1927,9 @@ public final void pickupItem(MapleMapObject ob, int petIndex) {     // yes, one\n                 mapitem.unlockItem();\n             }\n             \n-            if (itemScriptName != null) {\n+            if (itemScript != null) {\n                 ItemScriptManager ism = ItemScriptManager.getInstance();\n-                if (ism.scriptExists(itemScriptName)) {\n-                    ism.runItemScript(client, itemScriptName);\n-                }\n+                ism.runItemScript(client, itemScript);\n             }\n         }\n         client.announce(MaplePacketCreator.enableActions());\n@@ -1927,14 +1944,7 @@ public boolean canHold(int itemid) {\n     }\n         \n     public boolean canHold(int itemid, int quantity) {\n-        int hold = getCleanItemQuantity(itemid, false);\n-        \n-        if(hold > 0) {\n-            if(hold + quantity <= ii.getSlotMax(client, itemid))\n-                return true;\n-        }\n-        \n-        return getInventory(ItemConstants.getInventoryType(itemid)).getNextFreeSlot() > -1;\n+        return client.getAbstractPlayerInteraction().canHold(itemid, quantity);\n     }\n \n     public boolean isRidingBattleship() {\n@@ -2907,7 +2917,7 @@ public void loseExp(int loss, boolean show, boolean inChat, boolean white) {\n     private synchronized void gainExpInternal(long gain, int equip, int party, boolean show, boolean inChat, boolean white) {   // need of method synchonization here detected thanks to MedicOP\n         long total = Math.max(gain, -exp.get());\n         \n-        if (level < getMaxLevel()) {\n+        if (level < getMaxLevel() && (allowExpGain || this.getEventInstance() != null)) {\n             long leftover = 0;\n             long nextExp = exp.get() + total;\n             \n@@ -3464,9 +3474,11 @@ private void dropBuffStats(List<Pair<MapleBuffStat, MapleBuffStatValueHolder>> e\n                             getMap().broadcastMessage(MaplePacketCreator.removeSummon(summon, true), summon.getPosition());\n                             getMap().removeMapObject(summon);\n                             removeVisibleMapObject(summon);\n+                            \n                             summons.remove(summonId);\n-\n-                            if (summon.getSkill() == DarkKnight.BEHOLDER) {\n+                            if (summon.isPuppet()) {\n+                                map.removePlayerPuppet(this);\n+                            } else if (summon.getSkill() == DarkKnight.BEHOLDER) {\n                                 if (beholderHealingSchedule != null) {\n                                     beholderHealingSchedule.cancel(false);\n                                     beholderHealingSchedule = null;\n@@ -4602,19 +4614,19 @@ public boolean haveWeddingRing() {\n     }\n     \n     public int getItemQuantity(int itemid, boolean checkEquipped) {\n-        int possesed = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countById(itemid);\n+        int count = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countById(itemid);\n         if (checkEquipped) {\n-            possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countById(itemid);\n+            count += inventory[MapleInventoryType.EQUIPPED.ordinal()].countById(itemid);\n         }\n-        return possesed;\n+        return count;\n     }\n     \n     public int getCleanItemQuantity(int itemid, boolean checkEquipped) {\n-        int possesed = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countNotOwnedById(itemid);\n+        int count = inventory[ItemConstants.getInventoryType(itemid).ordinal()].countNotOwnedById(itemid);\n         if (checkEquipped) {\n-            possesed += inventory[MapleInventoryType.EQUIPPED.ordinal()].countNotOwnedById(itemid);\n+            count += inventory[MapleInventoryType.EQUIPPED.ordinal()].countNotOwnedById(itemid);\n         }\n-        return possesed;\n+        return count;\n     }\n \n     public MapleJob getJob() {\n@@ -6600,13 +6612,9 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n             rs = ps.executeQuery();\n             while (rs.next()) {\n                 String name = rs.getString(\"name\");\n-                if (rs.getString(\"name\").equals(\"rescueGaga\")) {\n+                if (rs.getString(\"name\").contentEquals(\"rescueGaga\")) {\n                     ret.events.put(name, new RescueGaga(rs.getInt(\"info\")));\n                 }\n-                //ret.events = new MapleEvents(new RescueGaga(rs.getInt(\"rescuegaga\")), new ArtifactHunt(rs.getInt(\"artifacthunt\")));\n-            }\n-            if (!ret.events.containsKey(\"rescueGaga\")) {\n-                ret.events.put(\"rescueGaga\", new RescueGaga(0));\n             }\n             rs.close();\n             ps.close();\n@@ -6988,13 +6996,12 @@ public void respawn(int returnMap) {\n     }\n     \n     public void respawn(EventInstanceManager eim, int returnMap) {\n-        cancelAllBuffs(false);\n+        if (eim != null) eim.unregisterPlayer(this);    // some event scripts uses this...\n+        changeMap(returnMap);\n         \n+        cancelAllBuffs(false);  // thanks Oblivium91 for finding out players still could revive in area and take damage before returning to town\n         updateHp(50);\n         setStance(0);\n-        \n-        if (eim != null) eim.unregisterPlayer(this);    // some event scripts uses this...\n-        changeMap(returnMap);\n     }\n \n     private void prepareDragonBlood(final MapleStatEffect bloodEffect) {\n@@ -7514,6 +7521,8 @@ public final boolean insertNewChar(CharacterFactoryRecipe recipe) {\n             this.getInventory(itEntry.getRight()).addItem(itEntry.getLeft());\n         }\n         \n+        this.events.put(\"rescueGaga\", new RescueGaga(0));\n+        \n         Connection con = null;\n         PreparedStatement ps = null;\n \n@@ -9733,7 +9742,6 @@ public final void empty(final boolean remove) {\n             events = null;\n             mpc = null;\n             mgc = null;\n-            events = null;\n             party = null;\n             family = null;\n             "}, {"sha": "9fdf031b5319da4b2b92795f2ad40f0558b0b91e", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -517,11 +517,15 @@ public boolean checkPic(String other) {\n \t}\n \n \tpublic int login(String login, String pwd, String nibbleHwid) {\n+\t\tint loginok = 5;\n+                \n \t\tloginattempt++;\n-\t\tif (loginattempt > 4) {\n+                if (loginattempt > 4) {\n+                        loggedIn = false;\n \t\t\tMapleSessionCoordinator.getInstance().closeSession(session, false);\n+                        return loginok;\n \t\t}\n-\t\tint loginok = 5;\n+\t\t\n \t\tConnection con = null;\n \t\tPreparedStatement ps = null;\n \t\tResultSet rs = null;\n@@ -748,7 +752,12 @@ public int getAccID() {\n \t\treturn accId;\n \t}\n         \n-\tpublic void updateLoginState(int newstate) {\n+        public void updateLoginState(int newstate) {\n+                // rules out possibility of multiple account entries\n+                if (newstate == LOGIN_LOGGEDIN) {\n+                        MapleSessionCoordinator.getInstance().updateOnlineSession(this.getSession());\n+                }\n+                \n \t\ttry {\n                         Connection con = DatabaseConnection.getConnection();\n \t\t\ttry (PreparedStatement ps = con.prepareStatement(\"UPDATE accounts SET loggedin = ?, lastlogin = ? WHERE id = ?\")) {\n@@ -763,6 +772,7 @@ public void updateLoginState(int newstate) {\n \t\t} catch (SQLException e) {\n \t\t\te.printStackTrace();\n \t\t}\n+                \n \t\tif (newstate == LOGIN_NOTLOGGEDIN) {\n \t\t\tloggedIn = false;\n \t\t\tserverTransition = false;\n@@ -797,9 +807,6 @@ public int getLoginState() {  // 0 = LOGIN_NOTLOGGEDIN, 1= LOGIN_SERVER_TRANSITI\n                                         MapleSessionCoordinator.getInstance().closeSession(session, null);\n \t\t\t\t\tupdateLoginState(LOGIN_NOTLOGGEDIN);\n \t\t\t\t}\n-\t\t\t} else if (state == LOGIN_LOGGEDIN && player == null) {\n-\t\t\t\tstate = LOGIN_LOGGEDIN;\n-\t\t\t\tupdateLoginState(LOGIN_LOGGEDIN);\n \t\t\t}\n \t\t\trs.close();\n \t\t\tps.close();\n@@ -1006,8 +1013,7 @@ private void clear() {\n             \n                 Server.getInstance().unregisterLoginState(this);\n             \n-                this.session.setAttribute(MapleClient.CLIENT_KEY, null);\n-\t\tthis.accountName = null;\n+                this.accountName = null;\n \t\tthis.macs = null;\n \t\tthis.hwid = null;\n \t\tthis.birthday = null;"}, {"sha": "966809824df5a4f9422d7f883dcc0c7384da6656", "filename": "src/client/command/CommandsExecutor.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/CommandsExecutor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/CommandsExecutor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/CommandsExecutor.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -193,6 +193,7 @@ private void registerLv0Commands(){\n         addCommand(\"int\", StatIntCommand.class);\n         addCommand(\"luk\", StatLukCommand.class);\n         addCommand(\"enableauth\", EnableAuthCommand.class);\n+        addCommand(\"toggleexp\", ToggleExpCommand.class);\n         \n         commandsNameDesc.add(levelCommandsCursor);\n     }"}, {"sha": "d7e6ab5e0fa244fc38b77a55f00c568b74548f46", "filename": "src/client/command/commands/gm0/ToggleExpCommand.java", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm0/ToggleExpCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm0/ToggleExpCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm0/ToggleExpCommand.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,44 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server, commands OdinMS-based\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+\n+/*\n+   @Author: Ronan\n+*/\n+package client.command.commands.gm0;\n+\n+import client.command.Command;\n+import client.MapleClient;\n+\n+public class ToggleExpCommand extends Command {\n+    {\n+        setDescription(\"\");\n+    }\n+\n+    @Override\n+    public void execute(MapleClient c, String[] params) {\n+        if (c.tryacquireClient()) {\n+            try {\n+                c.getPlayer().toggleExpGain();  // Vcoc's idea\n+            } finally {\n+                c.releaseClient();\n+            }\n+        }\n+    }\n+}"}, {"sha": "72445d122be82da34e23f0b87e94665b41c8a730", "filename": "src/client/command/commands/gm1/GotoCommand.java", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm1/GotoCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm1/GotoCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm1/GotoCommand.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -46,12 +46,19 @@ public void execute(MapleClient c, String[] params) {\n             player.yellowMessage(\"Syntax: @goto <map name>\");\n             return;\n         }\n-\n-        if (player.getEventInstance() != null || MapleMiniDungeonInfo.isDungeonMap(player.getMapId()) || FieldLimit.CANNOTMIGRATE.check(player.getMap().getFieldLimit()) || !player.isAlive()) {\n-            player.dropMessage(1, \"This command can not be used in this map.\");\n+        \n+        if (!player.isAlive()) {\n+            player.dropMessage(1, \"This command cannot be used when you're dead.\");\n             return;\n         }\n \n+        if (!player.isGM()) {\n+            if (player.getEventInstance() != null || MapleMiniDungeonInfo.isDungeonMap(player.getMapId()) || FieldLimit.CANNOTMIGRATE.check(player.getMap().getFieldLimit())) {\n+                player.dropMessage(1, \"This command can not be used in this map.\");\n+                return;\n+            }\n+        }\n+\n         HashMap<String, Integer> gotomaps;\n         if (player.isGM()) {\n             gotomaps = new HashMap<>(GameConstants.GOTO_AREAS);     // distinct map registry for GM/users suggested thanks to Vcoc"}, {"sha": "80a6807275072f1b9a3323ef76a6a4318c1357af", "filename": "src/client/command/commands/gm2/WarpCommand.java", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm2/WarpCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm2/WarpCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm2/WarpCommand.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -50,11 +50,18 @@ public void execute(MapleClient c, String[] params) {\n                 return;\n             }\n             \n-            if (player.getEventInstance() != null || MapleMiniDungeonInfo.isDungeonMap(player.getMapId()) || FieldLimit.CANNOTMIGRATE.check(player.getMap().getFieldLimit()) || !player.isAlive()) {\n-                player.dropMessage(1, \"This command cannot be used in this map.\");\n+            if (!player.isAlive()) {\n+                player.dropMessage(1, \"This command cannot be used when you're dead.\");\n                 return;\n             }\n             \n+            if (!player.isGM()) {\n+                if (player.getEventInstance() != null || MapleMiniDungeonInfo.isDungeonMap(player.getMapId()) || FieldLimit.CANNOTMIGRATE.check(player.getMap().getFieldLimit())) {\n+                    player.dropMessage(1, \"This command cannot be used in this map.\");\n+                    return;\n+                }\n+            }\n+            \n             // expedition issue with this command detected thanks to Masterrulax\n             player.saveLocationOnWarp();\n             player.changeMap(target, target.getRandomPlayerSpawnpoint());"}, {"sha": "64c52c03be077918fd402c74d08b96eeeeb21b03", "filename": "src/client/command/commands/gm3/FaceCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm3/FaceCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm3/FaceCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/FaceCommand.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import client.MapleCharacter;\n+import constants.ItemConstants;\n import server.MapleItemInformationProvider;\n \n public class FaceCommand extends Command {\n@@ -45,7 +46,7 @@ public void execute(MapleClient c, String[] params) {\n         try {\n             if (params.length == 1) {\n                 int itemId = Integer.parseInt(params[0]);\n-                if (!(itemId >= 20000 && itemId < 22000) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n+                if (!ItemConstants.isFace(itemId) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n                     player.yellowMessage(\"Face id '\" + params[0] + \"' does not exist.\");\n                     return;\n                 }\n@@ -55,7 +56,7 @@ public void execute(MapleClient c, String[] params) {\n                 player.equipChanged();\n             } else {\n                 int itemId = Integer.parseInt(params[1]);\n-                if (!(itemId >= 20000 && itemId < 22000) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n+                if (!ItemConstants.isFace(itemId) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n                     player.yellowMessage(\"Face id '\" + params[1] + \"' does not exist.\");\n                 }\n "}, {"sha": "3bc17f3566b565b1040c30d11dcf86d1e06fa188", "filename": "src/client/command/commands/gm3/HairCommand.java", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm3/HairCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/command/commands/gm3/HairCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm3/HairCommand.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -27,6 +27,7 @@\n import client.command.Command;\n import client.MapleClient;\n import client.MapleCharacter;\n+import constants.ItemConstants;\n import server.MapleItemInformationProvider;\n \n public class HairCommand extends Command {\n@@ -45,7 +46,7 @@ public void execute(MapleClient c, String[] params) {\n         try {\n             if (params.length == 1) {\n                 int itemId = Integer.parseInt(params[0]);\n-                if (!(itemId >= 30000 && itemId < 35000) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n+                if (!ItemConstants.isHair(itemId) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n                     player.yellowMessage(\"Hair id '\" + params[0] + \"' does not exist.\");\n                     return;\n                 }\n@@ -55,7 +56,7 @@ public void execute(MapleClient c, String[] params) {\n                 player.equipChanged();\n             } else {\n                 int itemId = Integer.parseInt(params[1]);\n-                if (!(itemId >= 30000 && itemId < 35000) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n+                if (!ItemConstants.isHair(itemId) || MapleItemInformationProvider.getInstance().getName(itemId) == null) {\n                     player.yellowMessage(\"Hair id '\" + params[1] + \"' does not exist.\");\n                     return;\n                 }"}, {"sha": "95cc8bb771cbdd878736bc42ce9895c8bf2169f7", "filename": "src/client/inventory/MaplePet.java", "status": "modified", "additions": 48, "deletions": 5, "changes": 53, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/inventory/MaplePet.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/inventory/MaplePet.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/MaplePet.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -52,6 +52,21 @@\n     private Point pos;\n     private int stance;\n     private boolean summoned;\n+    private int petFlag = 0;\n+    \n+    public enum PetFlag {\n+        OWNER_SPEED(0x01);\n+        \n+        private int i;\n+\n+        private PetFlag(int i) {\n+            this.i = i;\n+        }\n+\n+        public int getValue() {\n+            return i;\n+        }\n+    }\n \n     private MaplePet(int id, short position, int uniqueid) {\n         super(id, position, (short) 1);\n@@ -63,7 +78,7 @@ public static MaplePet loadFromDb(int itemid, short position, int petid) {\n         try {\n             MaplePet ret = new MaplePet(itemid, position, petid);\n             Connection con = DatabaseConnection.getConnection();\n-            PreparedStatement ps = con.prepareStatement(\"SELECT name, level, closeness, fullness, summoned FROM pets WHERE petid = ?\"); // Get pet details..\n+            PreparedStatement ps = con.prepareStatement(\"SELECT name, level, closeness, fullness, summoned, flag FROM pets WHERE petid = ?\"); // Get pet details..\n             ps.setInt(1, petid);\n             ResultSet rs = ps.executeQuery();\n             rs.next();\n@@ -72,6 +87,7 @@ public static MaplePet loadFromDb(int itemid, short position, int petid) {\n             ret.setLevel((byte) Math.min(rs.getByte(\"level\"), 30));\n             ret.setFullness(Math.min(rs.getInt(\"fullness\"), 100));\n             ret.setSummoned(rs.getInt(\"summoned\") == 1);\n+            ret.setPetFlag(rs.getInt(\"flag\"));\n             rs.close();\n             ps.close();\n             con.close();\n@@ -108,13 +124,14 @@ public static void deleteFromDb(MapleCharacter owner, int petid) {\n     public void saveToDb() {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            PreparedStatement ps = con.prepareStatement(\"UPDATE pets SET name = ?, level = ?, closeness = ?, fullness = ?, summoned = ? WHERE petid = ?\");\n+            PreparedStatement ps = con.prepareStatement(\"UPDATE pets SET name = ?, level = ?, closeness = ?, fullness = ?, summoned = ?, flag = ? WHERE petid = ?\");\n             ps.setString(1, getName());\n             ps.setInt(2, getLevel());\n             ps.setInt(3, getCloseness());\n             ps.setInt(4, getFullness());\n             ps.setInt(5, isSummoned() ? 1 : 0);\n-            ps.setInt(6, getUniqueId());\n+            ps.setInt(6, getPetFlag());\n+            ps.setInt(7, getUniqueId());\n             ps.executeUpdate();\n             ps.close();\n             con.close();\n@@ -126,7 +143,7 @@ public void saveToDb() {\n     public static int createPet(int itemid) {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            PreparedStatement ps = con.prepareStatement(\"INSERT INTO pets (petid, name, level, closeness, fullness, summoned) VALUES (?, ?, 1, 0, 100, 0)\");\n+            PreparedStatement ps = con.prepareStatement(\"INSERT INTO pets (petid, name, level, closeness, fullness, summoned, flag) VALUES (?, ?, 1, 0, 100, 0, 0)\");\n             int ret = MapleCashidGenerator.generateCashId();\n             ps.setInt(1, ret);\n             ps.setString(2, MapleItemInformationProvider.getInstance().getName(itemid));\n@@ -143,7 +160,7 @@ public static int createPet(int itemid) {\n     public static int createPet(int itemid, byte level, int closeness, int fullness) {\n         try {\n             Connection con = DatabaseConnection.getConnection();\n-            PreparedStatement ps = con.prepareStatement(\"INSERT INTO pets (petid, name, level, closeness, fullness, summoned) VALUES (?, ?, ?, ?, ?, 0)\");\n+            PreparedStatement ps = con.prepareStatement(\"INSERT INTO pets (petid, name, level, closeness, fullness, summoned, flag) VALUES (?, ?, ?, ?, ?, 0, 0)\");\n             int ret = MapleCashidGenerator.generateCashId();\n             ps.setInt(1, ret);\n             ps.setString(2, MapleItemInformationProvider.getInstance().getName(itemid));\n@@ -274,6 +291,32 @@ public boolean isSummoned() {\n     public void setSummoned(boolean yes) {\n         this.summoned = yes;\n     }\n+    \n+    public int getPetFlag() {\n+        return this.petFlag;\n+    }\n+    \n+    private void setPetFlag(int flag) {\n+        this.petFlag = flag;\n+    }\n+    \n+    public void addPetFlag(MapleCharacter owner, PetFlag flag) {\n+        this.petFlag |= flag.getValue();\n+        saveToDb();\n+        \n+        Item petz = owner.getInventory(MapleInventoryType.CASH).getItem(getPosition());\n+        if (petz != null)\n+            owner.forceUpdateItem(petz);\n+    }\n+    \n+    public void removePetFlag(MapleCharacter owner, PetFlag flag) {\n+        this.petFlag &= 0xFFFFFFFF ^ flag.getValue();\n+        saveToDb();\n+        \n+        Item petz = owner.getInventory(MapleInventoryType.CASH).getItem(getPosition());\n+        if (petz != null)\n+            owner.forceUpdateItem(petz);\n+    }\n \n     public Pair<Integer, Boolean> canConsume(int itemId) {\n         return MapleItemInformationProvider.getInstance().canPetConsume(this.getItemId(), itemId);"}, {"sha": "93e0874dda0f0891fb463a8531b6a9349ca54de0", "filename": "src/client/inventory/manipulator/MapleKarmaManipulator.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/inventory/manipulator/MapleKarmaManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/inventory/manipulator/MapleKarmaManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleKarmaManipulator.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -53,6 +53,7 @@ public static void setKarmaFlag(Item item) {\n         int flag = item.getFlag();\n         \n         flag |= karmaFlag;\n+        flag &= (0xFFFFFFFF ^ ItemConstants.UNTRADEABLE);\n         item.setFlag((byte) flag);\n     }\n }"}, {"sha": "e08d7d97d313657658442e06dd8e0e28f01c01c8", "filename": "src/client/processor/MakerProcessor.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/processor/MakerProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/client/processor/MakerProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/MakerProcessor.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -218,7 +218,7 @@ private static boolean removeOddMakerReagents(int toCreate, Map<Integer, Short>\n         Map<Integer, Integer> reagentType = new LinkedHashMap<>();\n         List<Integer> toRemove = new LinkedList<>();\n         \n-        boolean isWeapon = ItemConstants.isWeapon(toCreate) || ServerConstants.USE_MAKER_PERMISSIVE_ATKUP;\n+        boolean isWeapon = ItemConstants.isWeapon(toCreate) || ServerConstants.USE_MAKER_PERMISSIVE_ATKUP;  // thanks Vcoc for finding a case where a weapon wouldn't be counted as such due to a bounding on isWeapon\n         \n         for(Map.Entry<Integer, Short> r : reagentids.entrySet()) {\n             int curRid = r.getKey();"}, {"sha": "d1624daf662b0824c6dffa54f61fab84f59c7863", "filename": "src/constants/ItemConstants.java", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/constants/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/constants/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ItemConstants.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -217,7 +217,7 @@ public static boolean isMapleLife(int itemId) {\n     }\n \n     public static boolean isWeapon(int itemId) {\n-        return itemId >= 1302000 && itemId < 1492024;\n+        return itemId >= 1302000 && itemId < 1493000;\n     }\n     \n     public static boolean isEquipment(int itemId) {\n@@ -235,4 +235,12 @@ public static boolean isWeddingRing(int itemId) {\n     public static boolean isWeddingToken(int itemId) {\n         return itemId >= 4031357 && itemId <= 4031364;\n     }\n+    \n+    public static boolean isFace(int itemId) {\n+        return itemId >= 20000 && itemId < 22000;\n+    }\n+    \n+    public static boolean isHair(int itemId) {\n+        return itemId >= 30000 && itemId < 35000;\n+    }\n }"}, {"sha": "d726b8f826a9af351098589cc0a013cd0c3b10cf", "filename": "src/constants/ServerConstants.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/constants/ServerConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/constants/ServerConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/ServerConstants.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -149,7 +149,7 @@\n     public static boolean USE_DISPLAY_NUMBERS_WITH_COMMA = true;        //Enforce comma on displayed strings (use this when USE_UNITPRICE_WITH_COMMA is active and you still want to display comma-separated values).\n     public static boolean USE_UNITPRICE_WITH_COMMA = true;              //Set this accordingly with the layout of the unitPrices on Item.wz XML's, whether it's using commas or dots to represent fractions.\n     public static final byte MIN_UNDERLEVEL_TO_EXP_GAIN = 20;           //Characters are unable to get EXP from a mob if their level are under this threshold, only if \"USE_ENFORCE_MOB_LEVEL_RANGE\" is enabled. For bosses, this attribute is doubled.\n-    public static final byte MIN_UNDERLEVEL_TO_EXP_LEECH = 40;          //Characters are unable to leech EXP from party member kills whose level difference are past this limit.\n+    public static final byte MIN_RANGELEVEL_TO_EXP_LEECH = 40;          //Characters are unable to leech EXP from party member kills whose level difference are past this limit.\n     public static final byte MAX_MONITORED_BUFFSTATS = 5;               //Limits accounting for \"dormant\" buff effects, that should take place when stronger stat buffs expires.\n     public static final int MAX_AP = 32767;                             //Max AP allotted on the auto-assigner.\n     public static final int MAX_EVENT_LEVELS = 8;                       //Event has different levels of rewarding system."}, {"sha": "484f0699acd640b530b8c25b5c6a7099f2075316", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -88,8 +88,8 @@ public MapleServerHandler(int world, int channel) {\n     \n     @Override\n     public void exceptionCaught(IoSession session, Throwable cause) {\n-        if (cause instanceof IOException) { // mina closes session automatically and does not call sessionClosed on IOException\n-            session.closeNow(); // calls sessionClosed\n+        if (cause instanceof IOException) {\n+            closeMapleSession(session);\n         } else {\n             MapleClient client = (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n             \n@@ -137,8 +137,7 @@ public void sessionOpened(IoSession session) {\n         session.setAttribute(MapleClient.CLIENT_KEY, client);\n     }\n \n-    @Override\n-    public void sessionClosed(IoSession session) throws Exception {\n+    private void closeMapleSession(IoSession session) {\n         if (isLoginServerHandler()) {\n             MapleSessionCoordinator.getInstance().closeLoginSession(session);\n         } else {\n@@ -157,10 +156,15 @@ public void sessionClosed(IoSession session) throws Exception {\n                 FilePrinter.printError(FilePrinter.ACCOUNT_STUCK, t);\n             } finally {\n                 session.close();\n-                session.removeAttribute(MapleClient.CLIENT_KEY);      \n+                session.removeAttribute(MapleClient.CLIENT_KEY);\n                 //client.empty();\n             }\n         }\n+    }\n+    \n+    @Override\n+    public void sessionClosed(IoSession session) throws Exception {\n+        closeMapleSession(session);\n         super.sessionClosed(session);\n     }\n "}, {"sha": "ca0bdbbc9cdd0f791049089c849f3cfe7eb9c843", "filename": "src/net/server/Server.java", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -86,6 +86,7 @@\n import constants.GameConstants;\n import constants.ServerConstants;\n import java.util.TimeZone;\n+import net.server.coordinator.MapleSessionCoordinator;\n import server.CashShop.CashItemFactory;\n import server.MapleSkillbookInformationProvider;\n import server.ThreadManager;\n@@ -1693,7 +1694,7 @@ private void disconnectIdlesOnLoginState() {\n             if(c.isLoggedIn()) {\n                 c.disconnect(false, false);\n             } else {\n-                c.getSession().close(true);\n+                MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             }\n         }\n     }\n@@ -1766,8 +1767,13 @@ private synchronized void shutdownInternal(boolean restart) {\n         System.out.println(\"Worlds + Channels are offline.\");\n         acceptor.unbind();\n         acceptor = null;\n-        if (!restart) {\n-            System.exit(0);\n+        if (!restart) {  // shutdown hook deadlocks if System.exit() method is used within its body chores, thanks MIKE for pointing that out\n+            new Thread(new Runnable() {\n+                @Override\n+                public void run() {\n+                    System.exit(0);\n+                }\n+            }).start();\n         } else {\n             System.out.println(\"\\r\\nRestarting the server....\\r\\n\");\n             try {"}, {"sha": "d514b5d3febf5d63f509e8ea0f991f63aac30aad", "filename": "src/net/server/channel/handlers/AllianceOperationHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/AllianceOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/AllianceOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AllianceOperationHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -130,7 +130,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 chr.saveGuildStatus();\n \n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.addGuildToAlliance(alliance, guildid, c), -1, -1);\n-                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.updateAllianceInfo(alliance, c), -1, -1);\n+                Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.updateAllianceInfo(alliance, c.getWorld()), -1, -1);\n                 Server.getInstance().allianceMessage(alliance.getId(), MaplePacketCreator.allianceNotice(alliance.getId(), alliance.getNotice()), -1, -1);\n                 chr.getGuild().dropMessage(\"Your guild has joined the [\" + alliance.getName() + \"] union.\");\n                "}, {"sha": "6454a9e25683bedad580cc12f32b2a167a15382c", "filename": "src/net/server/channel/handlers/CharInfoRequestHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/CharInfoRequestHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/CharInfoRequestHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CharInfoRequestHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -29,6 +29,8 @@\n import tools.data.input.SeekableLittleEndianAccessor;\n \n public final class CharInfoRequestHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         slea.skip(4);\n         int cid = slea.readInt();"}, {"sha": "ae54da544463d8df37080afa773f784e1fe4d2e0", "filename": "src/net/server/channel/handlers/DamageSummonHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/DamageSummonHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/DamageSummonHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/DamageSummonHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -24,7 +24,6 @@\n import client.MapleBuffStat;\n import client.MapleCharacter;\n import client.MapleClient;\n-import client.SkillFactory;\n import net.AbstractMaplePacketHandler;\n import server.maps.MapleSummon;\n import server.maps.MapleMapObject;"}, {"sha": "0f74a86b608bfaebf1ea092031e3230f8d996c0a", "filename": "src/net/server/channel/handlers/PlayerInteractionHandler.java", "status": "modified", "additions": 53, "deletions": 11, "changes": 64, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/PlayerInteractionHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/PlayerInteractionHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerInteractionHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -25,6 +25,7 @@\n import client.MapleClient;\n import client.autoban.AutobanFactory;\n import client.inventory.Item;\n+import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import client.inventory.manipulator.MapleKarmaManipulator;\n@@ -465,22 +466,41 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             } else if (mode == Action.SET_ITEMS.getCode()) {\n                 MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n                 MapleInventoryType ivType = MapleInventoryType.getByType(slea.readByte());\n-                Item item = chr.getInventory(ivType).getItem(slea.readShort());\n+                short pos = slea.readShort();\n+                Item item = chr.getInventory(ivType).getItem(pos);\n                 short quantity = slea.readShort();\n                 byte targetSlot = slea.readByte();\n \n+                if (targetSlot < 1 || targetSlot > 9) {\n+                    System.out.println(\"[h4x] \" + chr.getName() + \" Trying to dupe on trade slot.\");\n+                    c.announce(MaplePacketCreator.enableActions());\n+                    return;\n+                }\n+                \n                 if (item == null) {\n                     c.announce(MaplePacketCreator.serverNotice(1, \"Invalid item description.\"));\n                     c.announce(MaplePacketCreator.enableActions());\n                     return;\n                 }\n-\n+                \n+                if(ServerConstants.USE_ENFORCE_UNMERCHABLE_CASH && ii.isCash(item.getItemId())) {\n+                    c.announce(MaplePacketCreator.serverNotice(1, \"Cash items are not allowed to be traded.\"));\n+                    return;\n+                }\n+                \n+                if (ServerConstants.USE_ENFORCE_UNMERCHABLE_PET && ItemConstants.isPet(item.getItemId())) {\n+                    c.announce(MaplePacketCreator.serverNotice(1, \"Pets are not allowed to be traded.\"));\n+                    return;\n+                }\n+                \n                 if (quantity < 1 || quantity > item.getQuantity()) {\n                     c.announce(MaplePacketCreator.serverNotice(1, \"You don't have enough quantity of the item.\"));\n                     c.announce(MaplePacketCreator.enableActions());\n                     return;\n                 }\n-                if (chr.getTrade() != null) {\n+                \n+                MapleTrade trade = chr.getTrade();\n+                if (trade != null) {\n                     if ((quantity <= item.getQuantity() && quantity >= 0) || ItemConstants.isRechargeable(item.getItemId())) {\n                         if (ii.isDropRestricted(item.getItemId())) { // ensure that undroppable items do not make it to the trade window\n                             if (!MapleKarmaManipulator.hasKarmaFlag(item)) {\n@@ -489,16 +509,38 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 return;\n                             }\n                         }\n-                        Item tradeItem = item.copy();\n-                        if (ItemConstants.isRechargeable(item.getItemId())) {\n-                            tradeItem.setQuantity(item.getQuantity());\n-                            MapleInventoryManipulator.removeFromSlot(c, ivType, item.getPosition(), item.getQuantity(), true);\n-                        } else {\n+                        \n+                        MapleInventory inv = chr.getInventory(ivType);\n+                        inv.lockInventory();\n+                        try {\n+                            Item checkItem = chr.getInventory(ivType).getItem(pos);\n+                            if (checkItem != item || checkItem.getPosition() != item.getPosition()) {\n+                                c.announce(MaplePacketCreator.serverNotice(1, \"Invalid item description.\"));\n+                                c.announce(MaplePacketCreator.enableActions());\n+                                return;\n+                            }\n+                            \n+                            Item tradeItem = item.copy();\n+                            if (ItemConstants.isRechargeable(item.getItemId())) {\n+                                quantity = item.getQuantity();\n+                            }\n+                            \n                             tradeItem.setQuantity(quantity);\n-                            MapleInventoryManipulator.removeFromSlot(c, ivType, item.getPosition(), quantity, true);\n+                            tradeItem.setPosition(targetSlot);\n+                            \n+                            if (trade.addItem(tradeItem)) {\n+                                MapleInventoryManipulator.removeFromSlot(c, ivType, item.getPosition(), quantity, true);\n+                                \n+                                trade.getChr().announce(MaplePacketCreator.getTradeItemAdd((byte) 0, tradeItem));\n+                                if (trade.getPartner() != null) {\n+                                    trade.getPartner().getChr().announce(MaplePacketCreator.getTradeItemAdd((byte) 1, tradeItem));\n+                                }\n+                            }\n+                        } catch (Exception e) {\n+                            FilePrinter.printError(FilePrinter.TRADE_EXCEPTION, e, \"Player '\" + chr + \"' tried to add \" + ii.getName(item.getItemId()) + \" qty. \" + item.getQuantity() + \" in trade (slot \" + targetSlot + \") then exception occurred.\");\n+                        } finally {\n+                            inv.unlockInventory();\n                         }\n-                        tradeItem.setPosition(targetSlot);\n-                        chr.getTrade().addItem(tradeItem);\n                     }\n                 }\n             } else if (mode == Action.CONFIRM.getCode()) {"}, {"sha": "5514a7dc2480005258501e45b6b8a94d51e7f582", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -289,7 +289,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                 }\n                             }\n                             if (newAlliance != null) {\n-                                c.announce(MaplePacketCreator.updateAllianceInfo(newAlliance, c));\n+                                c.announce(MaplePacketCreator.updateAllianceInfo(newAlliance, c.getWorld()));\n                                 c.announce(MaplePacketCreator.allianceNotice(newAlliance.getId(), newAlliance.getNotice()));\n \n                                 if (newcomer) {"}, {"sha": "1c95735b17b9a3fa7136ae58eefcaf9c8981862b", "filename": "src/net/server/channel/handlers/ScriptedItemHandler.java", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/ScriptedItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/ScriptedItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ScriptedItemHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -27,8 +27,7 @@\n import net.AbstractMaplePacketHandler;\n import scripting.item.ItemScriptManager;\n import server.MapleItemInformationProvider;\n-import server.MapleItemInformationProvider.scriptedItem;\n-import tools.MaplePacketCreator;\n+import server.MapleItemInformationProvider.ScriptedItem;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n /**\n@@ -38,19 +37,20 @@\n public final class ScriptedItemHandler extends AbstractMaplePacketHandler {\n     @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n+        slea.readInt(); // trash stamp, thanks RMZero213\n+        short itemSlot = slea.readShort(); // item slot, thanks RMZero213\n+        int itemId = slea.readInt();\n+        \n         MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();\n-        slea.readInt(); // trash stamp (thanks rmzero)\n-        short itemSlot = slea.readShort(); // item slot (thanks rmzero)\n-        int itemId = slea.readInt(); // itemId\n-        scriptedItem info = ii.getScriptedItemInfo(itemId);\n+        ScriptedItem info = ii.getScriptedItemInfo(itemId);\n         if (info == null) return;\n-        ItemScriptManager ism = ItemScriptManager.getInstance();\n+        \n         Item item = c.getPlayer().getInventory(ItemConstants.getInventoryType(itemId)).getItem(itemSlot);\n-        if (item == null || item.getItemId() != itemId || item.getQuantity() < 1 || !ism.scriptExists(info.getScript())) {\n+        if (item == null || item.getItemId() != itemId || item.getQuantity() < 1) {\n             return;\n         }\n-        ism.runItemScript(c, info.getScript());\n-        c.announce(MaplePacketCreator.enableActions());\n-        //NPCScriptManager.getInstance().start(c, info.getNpc(), null, null);        \n+        \n+        ItemScriptManager ism = ItemScriptManager.getInstance();\n+        ism.runItemScript(c, info);\n     }\n }"}, {"sha": "0f0c34364bce2031bdf3428ce61aaedaf80e679b", "filename": "src/net/server/channel/handlers/TrockAddMapHandler.java", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/TrockAddMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/TrockAddMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/TrockAddMapHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -33,6 +33,8 @@\n  * @author kevintjuh93\n  */\n public final class TrockAddMapHandler extends AbstractMaplePacketHandler {\n+    \n+    @Override\n     public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         MapleCharacter chr = c.getPlayer();\n         byte type = slea.readByte();"}, {"sha": "5b5cb1354073be2a3d3e3b34c526f40dd9055b41", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 22, "deletions": 19, "changes": 41, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -53,6 +53,7 @@\n import server.MapleShopFactory;\n import server.TimerManager;\n import server.maps.AbstractMapleMapObject;\n+import server.maps.FieldLimit;\n import server.maps.MaplePlayerShopItem;\n import server.maps.MapleKite;\n import server.maps.MapleMap;\n@@ -106,31 +107,32 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         if (itemType == 504) { // vip teleport rock\n             String error1 = \"Either the player could not be found or you were trying to teleport to an illegal location.\";\n-            boolean vip = slea.readByte() == 1;\n+            boolean vip = slea.readByte() == 1 && itemId / 1000 >= 5041;\n             remove(c, position, itemId);\n+            boolean success = false;\n             if (!vip) {\n                 int mapId = slea.readInt();\n-                if (c.getChannelServer().getMapFactory().getMap(mapId).getForcedReturnId() == 999999999) {\n-                \tplayer.changeMap(c.getChannelServer().getMapFactory().getMap(mapId));\n+                if (itemId / 1000 >= 5041 || mapId / 100000000 == player.getMapId() / 100000000) { //check vip or same continent\n+                    MapleMap targetMap = c.getChannelServer().getMapFactory().getMap(mapId);\n+                    if (!FieldLimit.CANNOTVIPROCK.check(targetMap.getFieldLimit()) && (targetMap.getForcedReturnId() == 999999999 || mapId < 100000000)) {\n+                        player.forceChangeMap(targetMap, targetMap.getRandomPlayerSpawnpoint());\n+                        success = true;\n+                    } else {\n+                        player.dropMessage(1, error1);\n+                    }\n                 } else {\n-                    MapleInventoryManipulator.addById(c, itemId, (short) 1);\n-                    player.dropMessage(1, error1);\n-                    c.announce(MaplePacketCreator.enableActions());\n+                    player.dropMessage(1, \"You cannot teleport between continents with this teleport rock.\");\n                 }\n             } else {\n                 String name = slea.readMapleAsciiString();\n                 MapleCharacter victim = c.getChannelServer().getPlayerStorage().getCharacterByName(name);\n-                boolean success = false;\n+                \n                 if (victim != null) {\n-                    MapleMap target = victim.getMap();\n-                    if (c.getChannelServer().getMapFactory().getMap(victim.getMapId()).getForcedReturnId() == 999999999 || victim.getMapId() < 100000000) {\n+                    MapleMap targetMap = victim.getMap();\n+                    if (!FieldLimit.CANNOTVIPROCK.check(targetMap.getFieldLimit()) && (targetMap.getForcedReturnId() == 999999999 || targetMap.getId() < 100000000)) {\n                         if (victim.gmLevel() <= player.gmLevel()) {\n-                            if (itemId == 5041000 || victim.getMapId() / player.getMapId() == 1) { //viprock & same continent\n-                                player.changeMap(target, target.findClosestPlayerSpawnpoint(victim.getPosition()));\n-                                success = true;\n-                            } else {\n-                                player.dropMessage(1, \"You cannot teleport between continents with this teleport rock.\");\n-                            }\n+                            player.forceChangeMap(targetMap, targetMap.findClosestPlayerSpawnpoint(victim.getPosition()));\n+                            success = true;\n                         } else {\n                             player.dropMessage(1, error1);\n                         }\n@@ -140,10 +142,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 } else {\n                     player.dropMessage(1, \"Player could not be found in this channel.\");\n                 }\n-                if (!success) {\n-                    MapleInventoryManipulator.addById(c, itemId, (short) 1);\n-                    c.announce(MaplePacketCreator.enableActions());\n-                }\n+            }\n+            \n+            if (!success) {\n+                MapleInventoryManipulator.addById(c, itemId, (short) 1);\n+                c.announce(MaplePacketCreator.enableActions());\n             }\n         } else if (itemType == 505) { // AP/SP reset\n             if(!player.isAlive()) {"}, {"sha": "1cfc75b72cfecca0ef8a22d626c67cbec225bc55", "filename": "src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/coordinator/MapleMonsterAggroCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleMonsterAggroCoordinator.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -25,8 +25,10 @@\n import java.util.Map;\n import java.util.Map.Entry;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.LinkedList;\n import java.util.List;\n+import java.util.Set;\n \n import constants.ServerConstants;\n import client.MapleCharacter;\n@@ -56,6 +58,8 @@\n     private Map<MapleMonster, Map<Integer, PlayerAggroEntry>> mobAggroEntries = new HashMap<>();\n     private Map<MapleMonster, List<PlayerAggroEntry>> mobSortedAggros = new HashMap<>();\n     \n+    private Set<Integer> mapPuppetEntries = new HashSet<>();\n+    \n     private class PlayerAggroEntry {\n         protected int cid;\n         protected int averageDamage = 0;\n@@ -291,6 +295,12 @@ private static void insertionSortAggroList(List<PlayerAggroEntry> paeList) {\n     }\n     \n     public boolean isLeadingCharacterAggro(MapleMonster mob, MapleCharacter player) {\n+        if (mob.isLeadingPuppetInVicinity()) {\n+            return false;\n+        } else if (mob.isCharacterPuppetInVicinity(player)) {\n+            return true;\n+        }\n+        \n         // by assuming the quasi-sorted nature of \"mobAggroList\", this method\n         // returns whether the player given as parameter can be elected as next aggro leader\n         \n@@ -342,6 +352,24 @@ public void removeAggroEntries(MapleMonster mob) {\n         }\n     }\n     \n+    public void addPuppetAggro(MapleCharacter player) {\n+        synchronized (mapPuppetEntries) {\n+            mapPuppetEntries.add(player.getId());\n+        }\n+    }\n+    \n+    public void removePuppetAggro(Integer cid) {\n+        synchronized (mapPuppetEntries) {\n+            mapPuppetEntries.remove(cid);\n+        }\n+    }\n+    \n+    public List<Integer> getPuppetAggroList() {\n+        synchronized (mapPuppetEntries) {\n+            return new ArrayList<>(mapPuppetEntries);\n+        }\n+    }\n+    \n     public void dispose() {\n         stopAggroCoordinator();\n         "}, {"sha": "cc14b57c7d41574a0b37b7572fd5841f808bb7d6", "filename": "src/net/server/coordinator/MapleSessionCoordinator.java", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/coordinator/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/coordinator/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/MapleSessionCoordinator.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -68,6 +68,7 @@ public static MapleSessionCoordinator getInstance() {\n     }\n     \n     private final LoginStorage loginStorage = new LoginStorage();\n+    private final Map<Integer, MapleClient> onlineClients = new HashMap<>();\n     private final Set<String> onlineRemoteHwids = new HashSet<>();\n     private final Map<String, Set<IoSession>> loginRemoteHosts = new HashMap<>();\n     private final Set<String> pooledRemoteHosts = new HashSet<>();\n@@ -221,6 +222,24 @@ private static String getRemoteIp(IoSession session) {\n         return ((InetSocketAddress) session.getRemoteAddress()).getAddress().getHostAddress();\n     }\n     \n+    private static MapleClient getSessionClient(IoSession session) {\n+        return (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n+    }\n+    \n+    public void updateOnlineSession(IoSession session) {\n+        MapleClient client = getSessionClient(session);\n+        \n+        if (client != null) {\n+            int accountId = client.getAccID();\n+            MapleClient ingameClient = onlineClients.get(accountId);\n+            if (ingameClient != null) {     // thanks MedicOP for finding out a loss of loggedin account uniqueness when using the CMS \"Unstuck\" feature\n+                ingameClient.forceDisconnect();\n+            }\n+\n+            onlineClients.put(accountId, client);\n+        }\n+    }\n+    \n     public boolean canStartLoginSession(IoSession session) {\n         if (!ServerConstants.DETERRED_MULTICLIENT) return true;\n         \n@@ -296,6 +315,11 @@ public void closeLoginSession(IoSession session) {\n         String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n         if (nibbleHwid != null) {\n             onlineRemoteHwids.remove(nibbleHwid);\n+            \n+            MapleClient client = getSessionClient(session);\n+            if (client != null) {\n+                onlineClients.remove(client.getAccID());\n+            }\n         }\n     }\n     \n@@ -448,6 +472,11 @@ public void closeSession(IoSession session, Boolean immediately) {\n         hwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID); // making sure to clean up calls to this function on login phase\n         onlineRemoteHwids.remove(hwid);\n         \n+        MapleClient client = getSessionClient(session);\n+        if (client != null) {\n+            onlineClients.remove(client.getAccID());\n+        }\n+        \n         if (immediately != null) {\n             session.close(immediately);\n         }"}, {"sha": "3320aa22cdefdd6b94bd11a42fdd1de46cf3f7df", "filename": "src/net/server/guild/MapleAlliance.java", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/guild/MapleAlliance.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/guild/MapleAlliance.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/guild/MapleAlliance.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -130,7 +130,9 @@ public static MapleAlliance createAlliance(MapleParty party, String name) {\n \n                 Server.getInstance().addAlliance(id, alliance);\n                 \n-                Server.getInstance().allianceMessage(id, MaplePacketCreator.updateAllianceInfo(alliance, guildMasters.get(0).getClient()), -1, -1);\n+                int worldid = guildMasters.get(0).getWorld();\n+                Server.getInstance().allianceMessage(id, MaplePacketCreator.updateAllianceInfo(alliance, worldid), -1, -1);\n+                Server.getInstance().allianceMessage(id, MaplePacketCreator.getGuildAlliances(alliance, worldid), -1, -1);  // thanks Vcoc for noticing guilds from other alliances being visually stacked here due to this not being updated\n             } catch (Exception e) {\n                 e.printStackTrace();\n                 return null;\n@@ -347,7 +349,7 @@ public static boolean removeGuildFromAlliance(int allianceId, int guildId, int w\n     \n     public void updateAlliancePackets(MapleCharacter chr) {\n         if (allianceId > 0) {\n-            this.broadcastMessage(MaplePacketCreator.updateAllianceInfo(this, chr.getClient()));\n+            this.broadcastMessage(MaplePacketCreator.updateAllianceInfo(this, chr.getWorld()));\n             this.broadcastMessage(MaplePacketCreator.allianceNotice(this.getId(), this.getNotice()));\n         }\n     }"}, {"sha": "505e61ec3906161a852b6daf1e1bcfe1b4788995", "filename": "src/net/server/handlers/login/CharSelectedHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/CharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/CharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -78,13 +78,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            session.close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(session, true);\n             return;\n         }\n \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            session.close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(session, true);\n             return;\n         }\n         "}, {"sha": "8017e4967b557a9e003d02d0f78f20e4d3f4c786", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -59,13 +59,13 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         }\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         "}, {"sha": "6940088b7105a22c8df16bbb2c084700a425a584", "filename": "src/net/server/handlers/login/LoginPasswordHandler.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/LoginPasswordHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/LoginPasswordHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/LoginPasswordHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -83,6 +83,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 c.setAccID(rs.getInt(1));\n                 rs.close();\n             } catch (SQLException | NoSuchAlgorithmException | UnsupportedEncodingException e) {\n+                c.setAccID(-1);\n                 e.printStackTrace();\n             } finally {\n                 disposeSql(con, ps);"}, {"sha": "c8fd76f3497a7182a89672c7aa84a2b4e552e008", "filename": "src/net/server/handlers/login/RegisterPicHandler.java", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/RegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/RegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/RegisterPicHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -59,13 +59,13 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n \t\t\n@@ -96,7 +96,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 e.printStackTrace();\n             }\n         } else {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n         }\n     }\n }\n\\ No newline at end of file"}, {"sha": "5d2c13a500edbd05069428e620fecaac6865e711", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -52,7 +52,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         c.updateHWID(hwid);\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         \n@@ -65,7 +65,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         "}, {"sha": "050a0419f4a2b141dd46525b7148b58a6209b55e", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -72,7 +72,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         c.updateHWID(hwid);\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         \n@@ -85,7 +85,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         "}, {"sha": "391c4fd7ef9a2e61efd1e9fa4e307cfd5a6b9d1a", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -54,7 +54,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         c.updateHWID(hwid);\n         \n         if (c.hasBannedMac() || c.hasBannedHWID()) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         \n@@ -67,7 +67,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n         \n         Server server = Server.getInstance();\n         if(!server.haveCharacterEntry(c.getAccID(), charId)) {\n-            c.getSession().close(true);\n+            MapleSessionCoordinator.getInstance().closeSession(c.getSession(), true);\n             return;\n         }\n         "}, {"sha": "da8d4d6b3188f034a67b2bbe9adca8baf37bc90b", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -228,7 +228,11 @@ public boolean canHold(int itemid) {\n         }\n         \n         public boolean canHold(int itemid, int quantity) {\n-                return getPlayer().canHold(itemid, quantity);\n+                return canHoldAll(Collections.singletonList(itemid), Collections.singletonList(quantity), true);\n+        }\n+        \n+        public boolean canHold(int itemid, int quantity, int removeItemid, int removeQuantity) {\n+                return canHoldAllAfterRemoving(Collections.singletonList(itemid), Collections.singletonList(quantity), Collections.singletonList(removeItemid), Collections.singletonList(removeQuantity));\n         }\n         \n         private static List<Integer> convertToIntegerArray(List<Double> list) {\n@@ -263,10 +267,6 @@ private boolean canHoldAll(List<Integer> itemids, List<Integer> quantity, boolea\n             return MapleInventory.checkSpots(c.getPlayer(), addedItems, false);\n         }\n         \n-        public boolean canHold(int itemid, int quantity, int removeItemid, int removeQuantity) {\n-            return canHoldAllAfterRemoving(Collections.singletonList(itemid), Collections.singletonList(quantity), Collections.singletonList(removeItemid), Collections.singletonList(removeQuantity));\n-        }\n-        \n         private static List<Pair<Item, MapleInventoryType>> prepareProofInventoryItems(List<Pair<Integer, Integer>> items) {\n             List<Pair<Item, MapleInventoryType>> addedItems = new LinkedList<>();\n             for(Pair<Integer, Integer> p : items) {"}, {"sha": "128429562d39e81a9cc8d91dd93877d4b072d94b", "filename": "src/scripting/event/EventInstanceInProgressException.java", "status": "renamed", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/event/EventInstanceInProgressException.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/event/EventInstanceInProgressException.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceInProgressException.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1,8 +1,6 @@\n /*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n \n     This program is free software: you can redistribute it and/or modify\n     it under the terms of the GNU Affero General Public License as\n@@ -19,17 +17,19 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-package scripting.item;\n+package scripting.event;\n \n-import client.MapleClient;\n-import scripting.AbstractPlayerInteraction;\n \n /**\n  *\n- * @author kevintjuh93\n+ * @author Ronan\n  */\n-public class ItemScriptMethods extends AbstractPlayerInteraction {\n-    public ItemScriptMethods(MapleClient c) {\n-    \tsuper(c);\n+public class EventInstanceInProgressException extends Exception {\n+    \n+    public static String EIIP_KEY = \"Event instance \";\n+    \n+    public EventInstanceInProgressException(String eventName, String eventInstance) {\n+        super(EIIP_KEY + \"already in progress - \" + eventName + \", EM: \" + eventInstance);\n     }\n+\n }", "previous_filename": "src/scripting/item/ItemScriptMethods.java"}, {"sha": "d051f2586d225eeca7dad448697be584082f03bb", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 63, "deletions": 15, "changes": 78, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -260,7 +260,7 @@ public EventInstanceManager getInstance(String name) {\n         }\n     }\n \n-    public EventInstanceManager newInstance(String name) {\n+    public EventInstanceManager newInstance(String name) throws EventInstanceInProgressException {\n         EventInstanceManager ret = getReadyInstance();\n         \n         if(ret == null) {\n@@ -271,7 +271,7 @@ public EventInstanceManager newInstance(String name) {\n         \n         synchronized (instances) {\n             if (instances.containsKey(name)) {\n-                return null;\n+                throw new EventInstanceInProgressException(name, this.getName());\n             }\n             \n             instances.put(name, ret);\n@@ -365,6 +365,34 @@ private int availableLobbyInstance() {\n             return -1;\n     }\n     \n+    private String getInternalScriptExceptionMessage(Throwable a) {\n+        if (!(a instanceof ScriptException)) {\n+            return null;\n+        }\n+        \n+        while(true) {\n+            Throwable t = a;\n+            a = a.getCause();\n+            \n+            if (a == null) {\n+                return t.getMessage();\n+            }\n+        }\n+    }\n+    \n+    private EventInstanceManager createInstance(String name, Object... args) throws ScriptException, NoSuchMethodException {\n+        return (EventInstanceManager) iv.invokeFunction(name, args);\n+    }\n+    \n+    private void registerEventInstance(String eventName, int lobbyId) {\n+        Integer oldLobby = instanceLocks.get(eventName);\n+        if (oldLobby != null) {\n+            setLockLobby(oldLobby, false);\n+        }\n+        \n+        instanceLocks.put(eventName, lobbyId);\n+    }\n+    \n     public boolean startInstance(MapleExpedition exped) {\n         return startInstance(-1, exped);\n     }\n@@ -394,9 +422,14 @@ public boolean startInstance(int lobbyId, MapleExpedition exped, MapleCharacter\n                         \n                         EventInstanceManager eim;\n                         try {\n-                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", leader.getClient().getChannel()));\n-                            instanceLocks.put(eim.getName(), lobbyId);\n-                        } catch (NullPointerException npe) {\n+                            eim = createInstance(\"setup\", leader.getClient().getChannel());\n+                            registerEventInstance(eim.getName(), lobbyId);\n+                        } catch (ScriptException | NullPointerException e) {\n+                            String message = getInternalScriptExceptionMessage(e);\n+                            if (message != null && !message.startsWith(EventInstanceInProgressException.EIIP_KEY)) {\n+                                throw e;\n+                            }\n+                            \n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n@@ -460,9 +493,14 @@ public boolean startInstance(int lobbyId, MapleCharacter chr, MapleCharacter lea\n                         \n                         EventInstanceManager eim;\n                         try {\n-                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId()));\n-                            instanceLocks.put(eim.getName(), lobbyId);\n-                        } catch (NullPointerException npe) {\n+                            eim = createInstance(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId());\n+                            registerEventInstance(eim.getName(), lobbyId);\n+                        } catch (ScriptException | NullPointerException e) {\n+                            String message = getInternalScriptExceptionMessage(e);\n+                            if (message != null && !message.startsWith(EventInstanceInProgressException.EIIP_KEY)) {\n+                                throw e;\n+                            }\n+                            \n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n@@ -520,9 +558,14 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, MapleC\n                         \n                         EventInstanceManager eim;\n                         try {\n-                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n-                            instanceLocks.put(eim.getName(), lobbyId);\n-                        } catch (NullPointerException npe) {\n+                            eim = createInstance(\"setup\", (Object) null);\n+                            registerEventInstance(eim.getName(), lobbyId);\n+                        } catch (ScriptException | NullPointerException e) {\n+                            String message = getInternalScriptExceptionMessage(e);\n+                            if (message != null && !message.startsWith(EventInstanceInProgressException.EIIP_KEY)) {\n+                                throw e;\n+                            }\n+                            \n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n@@ -582,9 +625,14 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n                         \n                         EventInstanceManager eim;\n                         try {\n-                            eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId()));\n-                            instanceLocks.put(eim.getName(), lobbyId);\n-                        } catch (NullPointerException npe) {\n+                            eim = createInstance(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : party.getLeaderId());\n+                            registerEventInstance(eim.getName(), lobbyId);\n+                        } catch (ScriptException | NullPointerException e) {\n+                            String message = getInternalScriptExceptionMessage(e);\n+                            if (message != null && !message.startsWith(EventInstanceInProgressException.EIIP_KEY)) {\n+                                throw e;\n+                            }\n+                            \n                             if(lobbyId > -1) {\n                                 setLockLobby(lobbyId, false);\n                             }\n@@ -652,7 +700,7 @@ public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr,\n                             }\n                             return false;\n                         }\n-                        instanceLocks.put(eim.getName(), lobbyId);\n+                        registerEventInstance(eim.getName(), lobbyId);\n                         eim.setLeader(leader);\n                         \n                         iv.invokeFunction(\"setup\", eim);"}, {"sha": "c38d9fb4f9d26d38cbff9f354fb3abb39fe68edc", "filename": "src/scripting/item/ItemScriptManager.java", "status": "modified", "additions": 4, "deletions": 70, "changes": 74, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/item/ItemScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/item/ItemScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/item/ItemScriptManager.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -22,21 +22,8 @@\n package scripting.item;\n \n import client.MapleClient;\n-import constants.ServerConstants;\n-import java.io.File;\n-import java.io.FileReader;\n-import java.io.IOException;\n-import java.lang.reflect.UndeclaredThrowableException;\n-import java.util.HashMap;\n-import java.util.Map;\n-import javax.script.Compilable;\n-import javax.script.Invocable;\n-import javax.script.ScriptEngine;\n-import javax.script.ScriptEngineFactory;\n-import javax.script.ScriptEngineManager;\n-import javax.script.ScriptException;\n-import tools.FilePrinter;\n-import tools.MaplePacketCreator;\n+import scripting.npc.NPCScriptManager;\n+import server.MapleItemInformationProvider.ScriptedItem;\n \n public class ItemScriptManager {\n \n@@ -46,60 +33,7 @@ public static ItemScriptManager getInstance() {\n         return instance;\n     }\n     \n-    private Map<String, Invocable> scripts = new HashMap<>();\n-    private ScriptEngineFactory sef;\n-\n-    private ItemScriptManager() {\n-        ScriptEngineManager sem = new ScriptEngineManager();\n-        sef = sem.getEngineByName(\"javascript\").getFactory();\n-    }\n-    \n-    public boolean scriptExists(String scriptName) {\n-        File scriptFile = new File(\"scripts/item/\" + scriptName + \".js\");\n-        return scriptFile.exists();\n-    }\n-\n-    public void runItemScript(MapleClient c, String scriptName) {\n-        if (scripts.containsKey(scriptName)) {\n-            try {\n-                scripts.get(scriptName).invokeFunction(\"start\", new ItemScriptMethods(c));\n-            } catch (ScriptException | NoSuchMethodException ex) {\n-                FilePrinter.printError(FilePrinter.ITEM + scriptName + \".txt\", ex);\n-            }\n-            return;\n-        }\n-        File scriptFile = new File(\"scripts/item/\" + scriptName + \".js\");\n-        if (!scriptFile.exists()) {\n-            c.announce(MaplePacketCreator.enableActions());\n-            return;\n-        }\n-        FileReader fr = null;\n-        ScriptEngine portal = sef.getScriptEngine();\n-        try {\n-            fr = new FileReader(scriptFile);\n-            \n-            // java 8 support here thanks to Arufonsu\n-            if (ServerConstants.JAVA_8){\n-                    portal.eval(\"load('nashorn:mozilla_compat.js');\" + System.lineSeparator());\n-            }\n-            \n-            ((Compilable) portal).compile(fr).eval();\n-\n-            final Invocable script = ((Invocable) portal);\n-            scripts.put(scriptName, script);\n-            script.invokeFunction(\"start\", new ItemScriptMethods(c));\n-        } catch (final UndeclaredThrowableException | ScriptException ute) {\n-            FilePrinter.printError(FilePrinter.ITEM + scriptName + \".txt\", ute);\n-        } catch (final Exception e) {\n-            FilePrinter.printError(FilePrinter.ITEM + scriptName + \".txt\", e);\n-        } finally {\n-            if (fr != null) {\n-                try {\n-                    fr.close();\n-                } catch (IOException e) {\n-                    e.printStackTrace();\n-                }\n-            }\n-        }\n+    public void runItemScript(MapleClient c, ScriptedItem scriptItem) {\n+        NPCScriptManager.getInstance().start(c, scriptItem, null);\n     }\n }\n\\ No newline at end of file"}, {"sha": "04acbecc398e4def608d50239fd42b4ee977be25", "filename": "src/scripting/map/MapScriptManager.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/map/MapScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/map/MapScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/map/MapScriptManager.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -78,18 +78,18 @@ public void runMapScript(MapleClient c, String scriptName, boolean firstUser) {\n             return;\n         }\n         FileReader fr = null;\n-        ScriptEngine portal = sef.getScriptEngine();\n+        ScriptEngine se = sef.getScriptEngine();\n         try {\n             fr = new FileReader(scriptFile);\n             \n             // java 8 support here thanks to Arufonsu\n             if (ServerConstants.JAVA_8){\n-                    portal.eval(\"load('nashorn:mozilla_compat.js');\" + System.lineSeparator());\n+                    se.eval(\"load('nashorn:mozilla_compat.js');\" + System.lineSeparator());\n             }\n             \n-            ((Compilable) portal).compile(fr).eval();\n+            ((Compilable) se).compile(fr).eval();\n             \n-            final Invocable script = ((Invocable) portal);\n+            final Invocable script = ((Invocable) se);\n             scripts.put(scriptName, script);\n             script.invokeFunction(\"start\", new MapScriptMethods(c));\n         } catch (final UndeclaredThrowableException | ScriptException ute) {"}, {"sha": "e5c7a41bf9cedbabddbb0c9c03049a94fa1e49b5", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -74,16 +74,18 @@\n         private int npcOid;\n \tprivate String scriptName;\n \tprivate String getText;\n+        private boolean itemScript;\n         \n         public NPCConversationManager(MapleClient c, int npc, String scriptName) {\n-               this(c, npc, -1, scriptName);\n+               this(c, npc, -1, scriptName, false);\n         }\n         \n-\tpublic NPCConversationManager(MapleClient c, int npc, int oid, String scriptName) {\n+\tpublic NPCConversationManager(MapleClient c, int npc, int oid, String scriptName, boolean itemScript) {\n \t\tsuper(c);\n \t\tthis.npc = npc;\n                 this.npcOid = oid;\n \t\tthis.scriptName = scriptName;\n+                this.itemScript = itemScript;\n \t}\n \n \tpublic int getNpc() {\n@@ -97,6 +99,14 @@ public int getNpcObjectId() {\n \tpublic String getScriptName() {\n \t\treturn scriptName;\n \t}\n+        \n+        public boolean isItemScript() {\n+                return itemScript;\n+        }\n+        \n+        public void resetItemScript() {\n+                this.itemScript = false;\n+        }\n \n \tpublic void dispose() {\n \t\tNPCScriptManager.getInstance().dispose(this);"}, {"sha": "120ec9ec6f4b9cfef07a289005fc30c44a625807", "filename": "src/scripting/npc/NPCScriptManager.java", "status": "modified", "additions": 25, "deletions": 8, "changes": 33, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/npc/NPCScriptManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/scripting/npc/NPCScriptManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCScriptManager.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -32,6 +32,7 @@\n import javax.script.ScriptException;\n \n import scripting.AbstractScriptManager;\n+import server.MapleItemInformationProvider.ScriptedItem;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;\n \n@@ -60,7 +61,7 @@ public boolean isNpcScriptAvailable(MapleClient c, String fileName) {\n     }\n     \n     public boolean start(MapleClient c, int npc, MapleCharacter chr) {\n-        return start(c, npc, null, chr);\n+        return start(c, npc, -1, chr);\n     }\n     \n     public boolean start(MapleClient c, int npc, int oid, MapleCharacter chr) {\n@@ -70,27 +71,42 @@ public boolean start(MapleClient c, int npc, int oid, MapleCharacter chr) {\n     public boolean start(MapleClient c, int npc, String fileName, MapleCharacter chr) {\n         return start(c, npc, -1, fileName, chr);\n     }\n-\n+    \n     public boolean start(MapleClient c, int npc, int oid, String fileName, MapleCharacter chr) {\n+        return start(c, npc, oid, fileName, chr, false, \"cm\");\n+    }\n+    \n+    public boolean start(MapleClient c, ScriptedItem scriptItem, MapleCharacter chr) {\n+        return start(c, scriptItem.getNpc(), -1, scriptItem.getScript(), chr, true, \"im\");\n+    }\n+\n+    private boolean start(MapleClient c, int npc, int oid, String fileName, MapleCharacter chr, boolean itemScript, String engineName) {\n         try {\n-            NPCConversationManager cm = new NPCConversationManager(c, npc, oid, fileName);\n+            NPCConversationManager cm = new NPCConversationManager(c, npc, oid, fileName, itemScript);\n             if (cms.containsKey(c)) {\n                 dispose(c);\n             }\n             if (c.canClickNPC()) {\n                 cms.put(c, cm);\n                 Invocable iv = null;\n-                if (fileName != null) {\n-                    iv = getInvocable(\"npc/\" + fileName + \".js\", c);\n+                if (!itemScript) {\n+                    if (fileName != null) {\n+                        iv = getInvocable(\"npc/\" + fileName + \".js\", c);\n+                    }\n+                } else {\n+                    if (fileName != null) {     // thanks MiLin for drafting NPC-based item scripts\n+                        iv = getInvocable(\"item/\" + fileName + \".js\", c);\n+                    }\n                 }\n                 if (iv == null) {\n                     iv = getInvocable(\"npc/\" + npc + \".js\", c);\n+                    cm.resetItemScript();\n                 }\n                 if (iv == null || NPCScriptManager.getInstance() == null) {\n                     dispose(c);\n                     return false;\n                 }\n-                engine.put(\"cm\", cm);\n+                engine.put(engineName, cm);\n                 scripts.put(c, iv);\n                 c.setClickedNPC();\n                 try {\n@@ -142,10 +158,11 @@ public void dispose(NPCConversationManager cm) {\n         cms.remove(c);\n         scripts.remove(c);\n         \n+        String scriptFolder = (cm.isItemScript() ? \"item\" : \"npc\");\n         if(cm.getScriptName() != null) {\n-            resetContext(\"npc/\" + cm.getScriptName() + \".js\", c);\n+            resetContext(scriptFolder + \"/\" + cm.getScriptName() + \".js\", c);\n         } else {\n-            resetContext(\"npc/\" + cm.getNpc() + \".js\", c);\n+            resetContext(scriptFolder + \"/\" + cm.getNpc() + \".js\", c);\n         }\n     }\n "}, {"sha": "ccbf21cf57b382096c1b4368c2a2f3d0ff14a58b", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -112,7 +112,7 @@ public static MapleItemInformationProvider getInstance() {\n     protected Map<Integer, Integer> monsterBookID = new HashMap<>();\n     protected Map<Integer, Boolean> untradeableCache = new HashMap<>();\n     protected Map<Integer, Boolean> onEquipUntradeableCache = new HashMap<>();\n-    protected Map<Integer, scriptedItem> scriptedItemCache = new HashMap<>();\n+    protected Map<Integer, ScriptedItem> scriptedItemCache = new HashMap<>();\n     protected Map<Integer, Boolean> karmaCache = new HashMap<>();\n     protected Map<Integer, Integer> triggerItemCache = new HashMap<>();\n     protected Map<Integer, Integer> expCache = new HashMap<>();\n@@ -1447,14 +1447,14 @@ public boolean isUntradeableOnEquip(int itemId) {\n         return untradeableOnEquip;\n     }\n \n-    public scriptedItem getScriptedItemInfo(int itemId) {\n+    public ScriptedItem getScriptedItemInfo(int itemId) {\n         if (scriptedItemCache.containsKey(itemId)) {\n             return scriptedItemCache.get(itemId);\n         }\n         if ((itemId / 10000) != 243) {\n             return null;\n         }\n-        scriptedItem script = new scriptedItem(MapleDataTool.getInt(\"spec/npc\", getItemData(itemId), 0),\n+        ScriptedItem script = new ScriptedItem(MapleDataTool.getInt(\"spec/npc\", getItemData(itemId), 0),\n         MapleDataTool.getString(\"spec/script\", getItemData(itemId), \"\"),\n         MapleDataTool.getInt(\"spec/runOnPickup\", getItemData(itemId), 0) == 1);\n         scriptedItemCache.put(itemId, script);\n@@ -2100,13 +2100,13 @@ private boolean canUseSkillBook(MapleCharacter player, Integer skillBookId) {\n         return skillbook;\n     }\n \n-    public class scriptedItem {\n+    public class ScriptedItem {\n \n         private boolean runOnPickup;\n         private int npc;\n         private String script;\n \n-        public scriptedItem(int npc, String script, boolean rop) {\n+        public ScriptedItem(int npc, String script, boolean rop) {\n             this.npc = npc;\n             this.script = script;\n             this.runOnPickup = rop;"}, {"sha": "a477144ac2ae6d4c17f5b820de53f8bbaf0f972a", "filename": "src/server/MapleTrade.java", "status": "modified", "additions": 88, "deletions": 23, "changes": 111, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/MapleTrade.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/MapleTrade.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleTrade.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -82,16 +82,16 @@ private void lockTrade() {\n         partner.getChr().getClient().announce(MaplePacketCreator.getTradeConfirmation());\n     }\n \n-    private void complete1() {\n+    private void fetchExchangedItems() {\n         exchangeItems = partner.getItems();\n         exchangeMeso = partner.getMeso();\n     }\n \n-    private void complete2() {\n+    private void completeTrade() {\n         boolean show = ServerConstants.USE_DEBUG;\n-        \n         items.clear();\n         meso = 0;\n+        \n         for (Item item : exchangeItems) {\n             MapleKarmaManipulator.toggleKarmaFlagToUntradeable(item);\n             MapleInventoryManipulator.addFromDrop(chr.getClient(), item, show);\n@@ -164,12 +164,21 @@ public void setMeso(int meso) {\n         }\n     }\n \n-    public void addItem(Item item) {\n-        items.add(item);\n-        chr.getClient().announce(MaplePacketCreator.getTradeItemAdd((byte) 0, item));\n-        if (partner != null) {\n-            partner.getChr().getClient().announce(MaplePacketCreator.getTradeItemAdd((byte) 1, item));\n+    public boolean addItem(Item item) {\n+        synchronized (items) {\n+            if (items.size() > 9) {\n+                return false;\n+            }\n+            for (Item it : items) {\n+                if (it.getPosition() == item.getPosition()) {\n+                    return false;\n+                }\n+            }\n+            \n+            items.add(item);\n         }\n+        \n+        return true;\n     }\n \n     public void chat(String message) {\n@@ -214,38 +223,65 @@ private boolean fitsInInventory() {\n         \n         return MapleInventory.checkSpotsAndOwnership(chr, tradeItems);\n     }\n-\n+    \n+    private synchronized boolean checkTradeCompleteHandshake(boolean updateSelf) {\n+        MapleTrade self, other;\n+                \n+        if (updateSelf) {\n+            self = this;\n+            other = this.getPartner();\n+        } else {\n+            self = this.getPartner();\n+            other = this;\n+        }\n+        \n+        if (self.isLocked()) {\n+            return false;\n+        }\n+        \n+        self.lockTrade();\n+        return other.isLocked();\n+    }\n+    \n+    private boolean checkCompleteHandshake() {  // handshake checkout thanks to Ronan\n+        if (this.getChr().getId() < this.getPartner().getChr().getId()) {\n+            return this.checkTradeCompleteHandshake(true);\n+        } else {\n+            return this.getPartner().checkTradeCompleteHandshake(false);\n+        }\n+    }\n+    \n     public static void completeTrade(MapleCharacter c) {\n-        c.getTrade().lockTrade();\n         MapleTrade local = c.getTrade();\n         MapleTrade partner = local.getPartner();\n-        if (partner.isLocked()) {\n-            local.complete1();\n-            partner.complete1();\n+        if (local.checkCompleteHandshake()) {\n+            local.fetchExchangedItems();\n+            partner.fetchExchangedItems();\n+            \n             if (!local.fitsMeso()) {\n                 cancelTrade(c);\n                 c.message(\"There is not enough meso inventory space to complete the trade.\");\n                 partner.getChr().message(\"Partner does not have enough meso inventory space to complete the trade.\");\n                 return;\n-            }\n-            else if (!partner.fitsMeso()) {\n+            } else if (!partner.fitsMeso()) {\n                 cancelTrade(c);\n                 c.message(\"Partner does not have enough meso inventory space to complete the trade.\");\n                 partner.getChr().message(\"There is not enough meso inventory space to complete the trade.\");\n                 return;\n             }\n+            \n             if (!local.fitsInInventory()) {\n                 cancelTrade(c);\n                 c.message(\"There is not enough inventory space to complete the trade.\");\n                 partner.getChr().message(\"Partner does not have enough inventory space to complete the trade.\");\n                 return;\n-            }\n-            else if (!partner.fitsInInventory()) {\n+            } else if (!partner.fitsInInventory()) {\n                 cancelTrade(c);\n                 c.message(\"Partner does not have enough inventory space to complete the trade.\");\n                 partner.getChr().message(\"There is not enough inventory space to complete the trade.\");\n                 return;\n             }\n+            \n             if (local.getChr().getLevel() < 15) {\n                 if (local.getChr().getMesosTraded() + local.exchangeMeso > 1000000) {\n                     cancelTrade(c);\n@@ -263,26 +299,55 @@ else if (!partner.fitsInInventory()) {\n                     partner.getChr().addMesosTraded(partner.exchangeMeso);\n                 }\n             }\n+            \n             LogHelper.logTrade(local, partner);\n-            local.complete2();\n-            partner.complete2();\n+            local.completeTrade();\n+            partner.completeTrade();\n+            \n             partner.getChr().setTrade(null);\n             c.setTrade(null);\n         }\n     }\n-\n-    public static void cancelTrade(MapleCharacter c) {\n-        MapleTrade trade = c.getTrade();\n+    \n+    private static void cancelTradeInternal(MapleCharacter chr) {\n+        MapleTrade trade = chr.getTrade();\n         if(trade == null) return;\n         \n         trade.cancel();\n         if (trade.getPartner() != null) {\n             trade.getPartner().cancel();\n             trade.getPartner().getChr().setTrade(null);\n         }\n-        c.setTrade(null);\n+        chr.setTrade(null);\n+    }\n+    \n+    private synchronized void tradeCancelHandshake(boolean updateSelf) {\n+        MapleTrade self;\n+                \n+        if (updateSelf) {\n+            self = this;\n+        } else {\n+            self = this.getPartner();\n+        }\n+        \n+        cancelTradeInternal(self.getChr());\n+    }\n+    \n+    private void cancelHandshake() {  // handshake checkout thanks to Ronan\n+        if (this.getChr().getId() < this.getPartner().getChr().getId()) {\n+            this.tradeCancelHandshake(true);\n+        } else {\n+            this.getPartner().tradeCancelHandshake(false);\n+        }\n     }\n \n+    public static void cancelTrade(MapleCharacter chr) {\n+        MapleTrade trade = chr.getTrade();\n+        if(trade == null) return;\n+        \n+        trade.cancelHandshake();\n+    }\n+    \n     public static void startTrade(MapleCharacter c) {\n         if (c.getTrade() == null) {\n             c.setTrade(new MapleTrade((byte) 0, c));"}, {"sha": "6ea511e450773a216c14e778ff2450720eb658d3", "filename": "src/server/life/MapleMonster.java", "status": "modified", "additions": 269, "deletions": 40, "changes": 309, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/life/MapleMonster.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/life/MapleMonster.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MapleMonster.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -63,7 +63,6 @@\n import server.TimerManager;\n import server.life.MapleLifeFactory.BanishInfo;\n import server.maps.MapleMap;\n-import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n import tools.MaplePacketCreator;\n import tools.Pair;\n@@ -72,6 +71,8 @@\n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n import net.server.coordinator.MapleMonsterAggroCoordinator;\n+import server.MapleStatEffect;\n+import server.maps.MapleSummon;\n \n public class MapleMonster extends AbstractLoadedMapleLife {\n     private ChangeableStats ostats = null;  //unused, v83 WZs offers no support for changeable stats.\n@@ -80,7 +81,7 @@\n     private AtomicLong maxHpPlusHeal = new AtomicLong(1);\n     private int mp;\n     private WeakReference<MapleCharacter> controller = new WeakReference<>(null);\n-    private boolean controllerHasAggro, controllerKnowsAboutAggro;\n+    private boolean controllerHasAggro, controllerKnowsAboutAggro, controllerHasPuppet;\n     private Collection<MonsterListener> listeners = new LinkedList<>();\n     private EnumMap<MonsterStatus, MonsterStatusEffect> stati = new EnumMap<>(MonsterStatus.class);\n     private ArrayList<MonsterStatus> alreadyBuffed = new ArrayList<>();\n@@ -91,10 +92,15 @@\n     private List<Pair<Integer, Integer>> usedSkills = new ArrayList<>();\n     private Map<Pair<Integer, Integer>, Integer> skillsUsed = new HashMap<>();\n     private Set<Integer> usedAttacks = new HashSet<>();\n+    private Set<Integer> calledMobOids = null;\n+    private int calledMobCount = 0;\n+    private WeakReference<MapleMonster> callerMob = new WeakReference<>(null);\n     private List<Integer> stolenItems = new ArrayList<>();\n     private int team;\n     private int parentMobOid = 0;\n     private final HashMap<Integer, AtomicInteger> takenDamage = new HashMap<>();\n+    private Runnable removeAfterAction = null;\n+    private boolean availablePuppetUpdate = true;\n \n     private MonitoredReentrantLock externalLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB_EXT);\n     private MonitoredReentrantLock monsterLock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.MOB, true);\n@@ -152,7 +158,59 @@ public int getParentMobOid() {\n     public void setParentMobOid(int parentMobId) {\n         this.parentMobOid = parentMobId;\n     }\n-\n+    \n+    public int countAvailableMobSummons(int limit, int skillLimit) {    // limit prop for summons has another conotation, found thanks to MedicOP\n+        Set<Integer> calledOids = this.calledMobOids;\n+        if(calledOids != null) {\n+            limit -= calledOids.size();\n+        }\n+        \n+        return Math.min(limit, skillLimit - this.calledMobCount);\n+    }\n+    \n+    public void addSummonedMob(MapleMonster mob) {\n+        Set<Integer> calledOids = this.calledMobOids;\n+        if (calledOids == null) {\n+            calledOids = Collections.synchronizedSet(new HashSet<Integer>());\n+            this.calledMobOids = calledOids;\n+        }\n+        \n+        calledOids.add(mob.getObjectId());\n+        mob.setSummonerMob(this);\n+        this.calledMobCount += 1;\n+    }\n+    \n+    private void removeSummonedMob(int mobOid) {\n+        Set<Integer> calledOids = this.calledMobOids;\n+        if (calledOids != null) {\n+            calledOids.remove(mobOid);\n+        }\n+    }\n+    \n+    private void setSummonerMob(MapleMonster mob) {\n+        this.callerMob = new WeakReference<>(mob);\n+    }\n+    \n+    private void dispatchClearSummons() {\n+        MapleMonster caller = this.callerMob.get();\n+        if (caller != null) {\n+            caller.removeSummonedMob(this.getObjectId());\n+        }\n+        \n+        this.calledMobOids = null;\n+    }\n+    \n+    public void pushRemoveAfterAction(Runnable run) {\n+        this.removeAfterAction = run;\n+    }\n+    \n+    public Runnable popRemoveAfterAction() {\n+        Runnable r = this.removeAfterAction;\n+        this.removeAfterAction = null;\n+        \n+        return r;\n+    }\n+    \n     public int getHp() {\n         return hp.get();\n     }\n@@ -421,7 +479,7 @@ private void distributeExperienceToParty(int pid, float exp, int killer, int kil\n         int expSharersLevel = 0;\n         for (MapleCharacter mc : members) {\n             if (mc.getLevel() >= minThresholdLevel) {    //NO EXP WILL BE GIVEN for those who are underleveled!\n-                if (Math.abs(killerLevel - mc.getLevel()) < ServerConstants.MIN_UNDERLEVEL_TO_EXP_LEECH) {\n+                if (Math.abs(killerLevel - mc.getLevel()) < ServerConstants.MIN_RANGELEVEL_TO_EXP_LEECH) {\n                     // thanks Thora for pointing out leech level limitation\n                     \n                     expSharersLevel += mc.getLevel();\n@@ -710,6 +768,7 @@ private synchronized void processMonsterKilled(boolean hasKiller) {\n         }\n         \n         this.aggroClearDamages();\n+        this.dispatchClearSummons();\n         \n         MonsterListener[] listenersList;\n         statiLock.lock();\n@@ -809,6 +868,10 @@ public boolean isControllerKnowsAboutAggro() {\n     private void setControllerKnowsAboutAggro(boolean controllerKnowsAboutAggro) {\n         if (!fake) this.controllerKnowsAboutAggro = controllerKnowsAboutAggro;\n     }\n+    \n+    private void setControllerHasPuppet(boolean controllerHasPuppet) {\n+        this.controllerHasPuppet = controllerHasPuppet;\n+    }\n \n     public byte[] makeBossHPBarPacket() {\n         return MaplePacketCreator.showBossHP(getId(), getHp(), getMaxHp(), getTagColor(), getTagBgColor());\n@@ -1233,39 +1296,13 @@ public boolean canUseSkill(MobSkill toUse) {\n             return false;\n         }\n         \n-        int useLimit = toUse.getLimit();\n         int useSkillid = toUse.getSkillId();\n-        if (useSkillid == 200) {\n-            int i = 0;\n-            for (MapleMapObject mo : getMap().getMapObjects()) {\n-                if (mo.getType() == MapleMapObjectType.MONSTER) {\n-                    i++;\n-                }\n-            }\n-            if (i > 100) {\n-                return false;\n-            }\n-            if (map.isDojoMap()) {  // spawns in dojo should be unlimited\n-                useLimit = 0;\n-            }\n-        } else if (useSkillid >= 143 && useSkillid <= 145) {\n+        if (useSkillid >= 143 && useSkillid <= 145) {\n             if (this.isBuffed(MonsterStatus.WEAPON_REFLECT) || this.isBuffed(MonsterStatus.MAGIC_REFLECT)) {\n                 return false;\n             }\n         }\n         \n-        if (useLimit > 0) {\n-            monsterLock.lock();\n-            try {\n-                Integer times = this.skillsUsed.get(new Pair<>(useSkillid, toUse.getSkillLevel()));\n-                if (times != null && times >= useLimit) {\n-                    return false;\n-                }\n-            } finally {\n-                monsterLock.unlock();\n-            }\n-        }\n-        \n         monsterLock.lock();\n         try {\n             /*\n@@ -1303,13 +1340,14 @@ private void usedSkill(MobSkill skill) {\n         try {\n             mp -= skill.getMpCon();\n             \n-            this.usedSkills.add(new Pair<>(skillId, level));\n-            if (this.skillsUsed.containsKey(new Pair<>(skillId, level))) {\n-                int times = this.skillsUsed.get(new Pair<>(skillId, level)) + 1;\n-                this.skillsUsed.remove(new Pair<>(skillId, level));\n-                this.skillsUsed.put(new Pair<>(skillId, level), times);\n+            Pair<Integer, Integer> skillKey = new Pair<>(skillId, level);\n+            this.usedSkills.add(skillKey);\n+            \n+            Integer useCount = this.skillsUsed.remove(skillKey);\n+            if (useCount != null) {\n+                this.skillsUsed.put(skillKey, useCount + 1);\n             } else {\n-                this.skillsUsed.put(new Pair<>(skillId, level), 1);\n+                this.skillsUsed.put(skillKey, 1);\n             }\n         } finally {\n             monsterLock.unlock();\n@@ -1605,18 +1643,57 @@ public final void changeDifficulty(final int difficulty, boolean pqMob) {\n         changeLevelByDifficulty(difficulty, pqMob);\n     }\n     \n+    private boolean isPuppetInVicinity(MapleSummon summon) {\n+        return summon.getPosition().distanceSq(this.getPosition()) < 177777;\n+    }\n+    \n+    public boolean isCharacterPuppetInVicinity(MapleCharacter chr) {\n+        MapleStatEffect mse = chr.getBuffEffect(MapleBuffStat.PUPPET);\n+        if (mse != null) {\n+            MapleSummon summon = chr.getSummonByKey(mse.getSourceId());\n+\n+            // check whether mob is currently under a puppet's field of action or not\n+            if (summon != null) {\n+                if (isPuppetInVicinity(summon)) {\n+                    return true;\n+                }\n+            } else {\n+                map.getAggroCoordinator().removePuppetAggro(chr.getId());\n+            }\n+        }\n+        \n+        return false;\n+    }\n+    \n+    public boolean isLeadingPuppetInVicinity() {\n+        MapleCharacter chrController = this.getActiveController();\n+        \n+        if (chrController != null) {\n+            if (this.isCharacterPuppetInVicinity(chrController)) {\n+                return true;\n+            }\n+        }\n+        \n+        return false;\n+    }\n+    \n     private MapleCharacter getNextControllerCandidate() {\n         int mincontrolled = Integer.MAX_VALUE;\n         MapleCharacter newController = null;\n         \n         int mincontrolleddead = Integer.MAX_VALUE;\n         MapleCharacter newControllerDead = null;\n         \n+        MapleCharacter newControllerWithPuppet = null;\n+        \n         for (MapleCharacter chr : getMap().getAllPlayers()) {\n             if (!chr.isHidden()) {\n                 int ctrlMonsSize = chr.getNumControlledMonsters();\n \n-                if (chr.isAlive()) {\n+                if (isCharacterPuppetInVicinity(chr)) {\n+                    newControllerWithPuppet = chr;\n+                    break;\n+                } else if (chr.isAlive()) {\n                     if (ctrlMonsSize < mincontrolled) {\n                         mincontrolled = ctrlMonsSize;\n                         newController = chr;\n@@ -1630,7 +1707,13 @@ private MapleCharacter getNextControllerCandidate() {\n             }\n         }\n         \n-        return newController != null ? newController : newControllerDead;\n+        if (newControllerWithPuppet != null) {\n+            return newControllerWithPuppet;\n+        } else if (newController != null) {\n+            return newController;\n+        } else {\n+            return newControllerDead;\n+        }\n     }\n     \n     /**\n@@ -1682,15 +1765,39 @@ public void aggroSwitchController(MapleCharacter newController, boolean immediat\n                 this.setController(newController);\n                 this.setControllerHasAggro(immediateAggro);\n                 this.setControllerKnowsAboutAggro(false);\n+                this.setControllerHasPuppet(false);\n             } finally {\n                 aggroUpdateLock.unlock();\n             }\n             \n+            this.aggroUpdatePuppetVisibility();\n             newController.announce(MaplePacketCreator.controlMonster(this, false, immediateAggro));\n             newController.controlMonster(this);\n         }\n     }\n     \n+    public void aggroAddPuppet(MapleCharacter player) {\n+        MapleMonsterAggroCoordinator mmac = map.getAggroCoordinator();\n+        mmac.addPuppetAggro(player);\n+        \n+        aggroUpdatePuppetController(player);\n+        \n+        if (this.isControllerHasAggro()) {\n+            this.aggroUpdatePuppetVisibility();\n+        }\n+    }\n+    \n+    public void aggroRemovePuppet(MapleCharacter player) {\n+        MapleMonsterAggroCoordinator mmac = map.getAggroCoordinator();\n+        mmac.removePuppetAggro(player.getId());\n+        \n+        aggroUpdatePuppetController(null);\n+        \n+        if (this.isControllerHasAggro()) {\n+            this.aggroUpdatePuppetVisibility();\n+        }\n+    }\n+    \n     /**\n      * Automagically finds a new controller for the given monster from the chars\n      * on the map it is from...\n@@ -1710,6 +1817,60 @@ public void aggroUpdateController() {\n         this.aggroSwitchController(newController, false);\n     }\n     \n+    /**\n+     * Finds a new controller for the given monster from the chars with deployed puppet\n+     * nearby on the map it is from...\n+     * \n+     */\n+    private void aggroUpdatePuppetController(MapleCharacter newController) {\n+        MapleCharacter chrController = this.getActiveController();\n+        boolean updateController = false;\n+        \n+        if (chrController != null && chrController.isAlive()) {\n+            if (isCharacterPuppetInVicinity(chrController)) {\n+                return;\n+            }\n+        } else {\n+            updateController = true;\n+        }\n+        \n+        if (newController == null || !isCharacterPuppetInVicinity(newController)) {\n+            MapleMonsterAggroCoordinator mmac = map.getAggroCoordinator();\n+            \n+            List<Integer> puppetOwners = mmac.getPuppetAggroList();\n+            List<Integer> toRemovePuppets = new LinkedList<>();\n+        \n+            for (Integer cid : puppetOwners) {\n+                MapleCharacter chr = map.getCharacterById(cid);\n+\n+                if (chr != null) {\n+                    if (isCharacterPuppetInVicinity(chr)) {\n+                        newController = chr;\n+                        break;\n+                    }\n+                } else {\n+                    toRemovePuppets.add(cid);\n+                }\n+            }\n+\n+            for (Integer cid : toRemovePuppets) {\n+                mmac.removePuppetAggro(cid);\n+            }\n+            \n+            if (newController == null) {    // was a new controller found? (if not there's no puppet nearby)\n+                if (updateController) {\n+                    aggroUpdateController();\n+                }\n+                \n+                return;\n+            }\n+        } else if (chrController == newController) {\n+            this.aggroUpdatePuppetVisibility();\n+        }\n+        \n+        this.aggroSwitchController(newController, this.isControllerHasAggro());\n+    }\n+    \n     /**\n      * Ensures controllability removal of the current player controller, and\n      * fetches for any player on the map to start controlling in place.\n@@ -1767,6 +1928,9 @@ public void aggroMonsterDamage(MapleCharacter attacker, int damage) {\n         if (chrController != attacker) {\n             if (this.getMapAggroCoordinator().isLeadingCharacterAggro(this, attacker)) {\n                 this.aggroSwitchController(attacker, true);\n+            } else {\n+                this.setControllerHasAggro(true);\n+                this.aggroUpdatePuppetVisibility();\n             }\n             \n             /*\n@@ -1780,7 +1944,67 @@ else if (chrController != null) {\n             */\n         } else {\n             this.setControllerHasAggro(true);\n+            this.aggroUpdatePuppetVisibility();\n+        }\n+    }\n+    \n+    private void aggroRefreshPuppetVisibility(MapleCharacter chrController, MapleSummon puppet) {\n+        // lame patch for client to redirect all aggro to the puppet\n+        \n+        List<MapleMonster> puppetControlled = new LinkedList<>();\n+        for (MapleMonster mob : chrController.getControlledMonsters()) {\n+            if (mob.isPuppetInVicinity(puppet)) {\n+                puppetControlled.add(mob);\n+            }\n+        }\n+        \n+        for (MapleMonster mob : puppetControlled) {\n+            chrController.announce(MaplePacketCreator.stopControllingMonster(mob.getObjectId()));\n+        }\n+        chrController.announce(MaplePacketCreator.removeSummon(puppet, false));\n+        \n+        for (MapleMonster mob : puppetControlled) {\n+            chrController.announce(MaplePacketCreator.controlMonster(mob, false, mob.isControllerHasAggro()));\n         }\n+        chrController.announce(MaplePacketCreator.spawnSummon(puppet, false));\n+    }\n+    \n+    public void aggroUpdatePuppetVisibility() {\n+        if (!availablePuppetUpdate) return;\n+        \n+        availablePuppetUpdate = false;\n+        Runnable r = new Runnable() {\n+            @Override\n+            public void run() {\n+                try {\n+                    MapleCharacter chrController = MapleMonster.this.getActiveController();\n+                    if (chrController == null) return;\n+\n+                    MapleStatEffect puppetEffect = chrController.getBuffEffect(MapleBuffStat.PUPPET);\n+                    if (puppetEffect != null) {\n+                        MapleSummon puppet = chrController.getSummonByKey(puppetEffect.getSourceId());\n+\n+                        if (puppet != null && isPuppetInVicinity(puppet)) {\n+                            controllerHasPuppet = true;\n+                            aggroRefreshPuppetVisibility(chrController, puppet);\n+                            return;\n+                        }\n+                    }\n+\n+                    if (controllerHasPuppet) {\n+                        controllerHasPuppet = false;\n+\n+                        chrController.announce(MaplePacketCreator.stopControllingMonster(MapleMonster.this.getObjectId()));\n+                        chrController.announce(MaplePacketCreator.controlMonster(MapleMonster.this, false, MapleMonster.this.isControllerHasAggro()));\n+                    }\n+                } finally {\n+                    availablePuppetUpdate = true;\n+                }\n+            }\n+        };\n+        \n+        // had to schedule this since mob wouldn't stick to puppet aggro who knows why\n+        this.getMap().getChannelServer().registerOverallAction(this.getMap().getId(), r, ServerConstants.UPDATE_INTERVAL);\n     }\n     \n     /**\n@@ -1805,7 +2029,12 @@ public void aggroResetAggro() {\n         }\n     }\n     \n-    public final void disposeLocks() {\n+    public void dispose() {\n+        this.getMap().dismissRemoveAfter(this);\n+        disposeLocks();\n+    }\n+    \n+    private void disposeLocks() {\n         LockCollector.getInstance().registerDisposeAction(new Runnable() {\n             @Override\n             public void run() {"}, {"sha": "c58775a0dbf0c78e1e992aee19c73c22d31e06cb", "filename": "src/server/life/MobSkill.java", "status": "modified", "additions": 67, "deletions": 51, "changes": 118, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/life/MobSkill.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/life/MobSkill.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/life/MobSkill.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -33,6 +33,7 @@\n import java.util.LinkedList;\n import java.util.Map;\n import tools.Randomizer;\n+import server.maps.MapleMap;\n import server.maps.MapleMapObject;\n import server.maps.MapleMapObjectType;\n import server.maps.MapleMist;\n@@ -235,57 +236,72 @@ public void applyEffect(MapleCharacter player, MapleMonster monster, boolean ski\n             case 156: // speed up\n                 break;\n             case 200: // summon\n-                if (monster.getMap().getSpawnedMonstersOnMap() < 80) {\n-                    for (Integer mobId : getSummons()) {\n-                        MapleMonster toSpawn = MapleLifeFactory.getMonster(mobId);\n-                        if(toSpawn != null) {\n-                            if(GameConstants.isBossRush(monster.getMap().getId())) toSpawn.disableDrops();  // no littering on BRPQ pls\n-                            \n-                            toSpawn.setPosition(monster.getPosition());\n-                            int ypos, xpos;\n-                            xpos = (int) monster.getPosition().getX();\n-                            ypos = (int) monster.getPosition().getY();\n-                            switch (mobId) {\n-                                case 8500003: // Pap bomb high\n-                                    toSpawn.setFh((int) Math.ceil(Math.random() * 19.0));\n-                                    ypos = -590;\n-                                    break;\n-                                case 8500004: // Pap bomb\n-                                    xpos = (int) (monster.getPosition().getX() + Randomizer.nextInt(1000) - 500);\n-                                    if (ypos != -590) {\n-                                        ypos = (int) monster.getPosition().getY();\n-                                    }\n-                                    break;\n-                                case 8510100: //Pianus bomb\n-                                    if (Math.ceil(Math.random() * 5) == 1) {\n-                                        ypos = 78;\n-                                        xpos = (int) Randomizer.nextInt(5) + (Randomizer.nextInt(2) == 1 ? 180 : 0);\n-                                    } else {\n+                int skillLimit = this.getLimit();\n+                MapleMap map = monster.getMap();\n+                \n+                if (map.isDojoMap()) {  // spawns in dojo should be unlimited\n+                    skillLimit = Integer.MAX_VALUE;\n+                }\n+                \n+                if (map.getSpawnedMonstersOnMap() < 80) {\n+                    List<Integer> summons = getSummons();\n+                    int summonLimit = monster.countAvailableMobSummons(summons.size(), skillLimit);\n+                    if (summonLimit >= 1) {\n+                        Collections.shuffle(summons);\n+                        boolean bossRushMap = GameConstants.isBossRush(map.getId());\n+\n+                        for (Integer mobId : summons.subList(0, summonLimit)) {\n+                            MapleMonster toSpawn = MapleLifeFactory.getMonster(mobId);\n+                            if(toSpawn != null) {\n+                                if(bossRushMap) toSpawn.disableDrops();  // no littering on BRPQ pls\n+\n+                                toSpawn.setPosition(monster.getPosition());\n+                                int ypos, xpos;\n+                                xpos = (int) monster.getPosition().getX();\n+                                ypos = (int) monster.getPosition().getY();\n+                                switch (mobId) {\n+                                    case 8500003: // Pap bomb high\n+                                        toSpawn.setFh((int) Math.ceil(Math.random() * 19.0));\n+                                        ypos = -590;\n+                                        break;\n+                                    case 8500004: // Pap bomb\n                                         xpos = (int) (monster.getPosition().getX() + Randomizer.nextInt(1000) - 500);\n-                                    }\n-                                    break;          \n-                            }\n-                            switch (monster.getMap().getId()) {\n-                                case 220080001: //Pap map\n-                                    if (xpos < -890) {\n-                                        xpos = (int) (Math.ceil(Math.random() * 150) - 890);\n-                                    } else if (xpos > 230) {\n-                                        xpos = (int) (230 - Math.ceil(Math.random() * 150));\n-                                    }\n-                                    break;\n-                                case 230040420: // Pianus map\n-                                    if (xpos < -239) {\n-                                        xpos = (int) (Math.ceil(Math.random() * 150) - 239);\n-                                    } else if (xpos > 371) {\n-                                        xpos = (int) (371 - Math.ceil(Math.random() * 150));\n-                                    }\n-                                    break;\n-                            }\n-                            toSpawn.setPosition(new Point(xpos, ypos));\n-                            if (toSpawn.getId() == 8500004) {\n-                                    monster.getMap().spawnFakeMonster(toSpawn);\n-                            } else {\n-                                    monster.getMap().spawnMonsterWithEffect(toSpawn, getSpawnEffect(), toSpawn.getPosition());\n+                                        if (ypos != -590) {\n+                                            ypos = (int) monster.getPosition().getY();\n+                                        }\n+                                        break;\n+                                    case 8510100: //Pianus bomb\n+                                        if (Math.ceil(Math.random() * 5) == 1) {\n+                                            ypos = 78;\n+                                            xpos = (int) Randomizer.nextInt(5) + (Randomizer.nextInt(2) == 1 ? 180 : 0);\n+                                        } else {\n+                                            xpos = (int) (monster.getPosition().getX() + Randomizer.nextInt(1000) - 500);\n+                                        }\n+                                        break;          \n+                                }\n+                                switch (map.getId()) {\n+                                    case 220080001: //Pap map\n+                                        if (xpos < -890) {\n+                                            xpos = (int) (Math.ceil(Math.random() * 150) - 890);\n+                                        } else if (xpos > 230) {\n+                                            xpos = (int) (230 - Math.ceil(Math.random() * 150));\n+                                        }\n+                                        break;\n+                                    case 230040420: // Pianus map\n+                                        if (xpos < -239) {\n+                                            xpos = (int) (Math.ceil(Math.random() * 150) - 239);\n+                                        } else if (xpos > 371) {\n+                                            xpos = (int) (371 - Math.ceil(Math.random() * 150));\n+                                        }\n+                                        break;\n+                                }\n+                                toSpawn.setPosition(new Point(xpos, ypos));\n+                                if (toSpawn.getId() == 8500004) {\n+                                        map.spawnFakeMonster(toSpawn);\n+                                } else {\n+                                        map.spawnMonsterWithEffect(toSpawn, getSpawnEffect(), toSpawn.getPosition());\n+                                }\n+                                monster.addSummonedMob(toSpawn);\n                             }\n                         }\n                     }\n@@ -342,7 +358,7 @@ public int getMpCon() {\n     }\n \n     public List<Integer> getSummons() {\n-        return Collections.unmodifiableList(toSummon);\n+        return new ArrayList<>(toSummon);\n     }\n \n     public int getSpawnEffect() {"}, {"sha": "7dc08243f76db8d867adf183d868364a9300ffb9", "filename": "src/server/maps/MapMonitor.java", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapMonitor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapMonitor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapMonitor.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -44,12 +44,19 @@ public void run() {\n     }\n \n     private void cancelAction() {\n-        monitorSchedule.cancel(false);\n+        if (monitorSchedule != null) {  // thanks Thora for pointing a NPE occurring here\n+            monitorSchedule.cancel(false);\n+            monitorSchedule = null;\n+        }\n+        \n         map.killAllMonsters();\n         map.clearDrops();\n         if (portal != null) {\n             portal.setPortalStatus(MaplePortal.OPEN);\n         }\n         map.resetReactors();\n+        \n+        map = null;\n+        portal = null;\n     }\n }"}, {"sha": "0f16f494e7aa93d1ab6bbb3ee9f8ed3ed763d5c5", "filename": "src/server/maps/MapleHiredMerchant.java", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapleHiredMerchant.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapleHiredMerchant.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleHiredMerchant.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -227,6 +227,18 @@ private static boolean canBuy(MapleClient c, Item newItem) {\n         return MapleInventoryManipulator.checkSpace(c, newItem.getItemId(), newItem.getQuantity(), newItem.getOwner()) && MapleInventoryManipulator.addFromDrop(c, newItem, false);\n     }\n     \n+    private int getQuantityLeft(int itemid) {\n+        int count = 0;\n+        \n+        for (MaplePlayerShopItem mpsi : items) {\n+            if (mpsi.getItem().getItemId() == itemid) {\n+                count += (mpsi.getBundles() * mpsi.getItem().getQuantity());\n+            }\n+        }\n+        \n+        return count;\n+    }\n+    \n     public void buy(MapleClient c, int item, short quantity) {\n         synchronized (items) {\n             MaplePlayerShopItem pItem = items.get(item);\n@@ -247,7 +259,6 @@ public void buy(MapleClient c, int item, short quantity) {\n             if (c.getPlayer().getMeso() >= price) {\n                 if (canBuy(c, newItem)) {\n                     c.getPlayer().gainMeso(-price, false);\n-                    if(ServerConstants.USE_ANNOUNCE_SHOPITEMSOLD) announceItemSold(newItem, price);   // idea thanks to Vcoc\n                     \n                     synchronized (sold) {\n                         sold.add(new SoldItem(c.getPlayer().getName(), pItem.getItem().getItemId(), newItem.getQuantity(), price));\n@@ -257,6 +268,11 @@ public void buy(MapleClient c, int item, short quantity) {\n                     if (pItem.getBundles() < 1) {\n                         pItem.setDoesExist(false);\n                     }\n+                    \n+                    if(ServerConstants.USE_ANNOUNCE_SHOPITEMSOLD) {   // idea thanks to Vcoc\n+                        announceItemSold(newItem, price, getQuantityLeft(pItem.getItem().getItemId()));\n+                    }\n+                    \n                     MapleCharacter owner = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterByName(ownerName);\n                     if (owner != null) {\n                         owner.addMerchantMesos(price);\n@@ -288,12 +304,12 @@ public void buy(MapleClient c, int item, short quantity) {\n         }\n     }\n     \n-    private void announceItemSold(Item item, int mesos) {\n-        String qtyStr = (item.getQuantity() > 1) ? \" (qty. \" + item.getQuantity() + \")\" : \"\";\n+    private void announceItemSold(Item item, int mesos, int inStore) {\n+        String qtyStr = (item.getQuantity() > 1) ? \" x \" + item.getQuantity() : \"\";\n         \n         MapleCharacter player = Server.getInstance().getWorld(world).getPlayerStorage().getCharacterById(ownerId);\n         if(player != null && player.isLoggedinWorld()) {\n-            player.dropMessage(6, \"[HIRED MERCHANT] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos.\");\n+            player.dropMessage(6, \"[Hired Merchant] Item '\" + MapleItemInformationProvider.getInstance().getName(item.getItemId()) + \"'\" + qtyStr + \" has been sold for \" + mesos + \" mesos. (\" + inStore + \" left)\");\n         }\n     }\n "}, {"sha": "c0e6908dea9debe1dbb707b82fad506e41e42d90", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 37, "deletions": 7, "changes": 44, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1796,21 +1796,36 @@ public void sendPackets(MapleClient c) {\n     private void applyRemoveAfter(final MapleMonster monster) {\n         final selfDestruction selfDestruction = monster.getStats().selfDestruction();\n         if (monster.getStats().removeAfter() > 0 || selfDestruction != null && selfDestruction.getHp() < 0) {\n+            Runnable removeAfterAction;\n+            \n             if (selfDestruction == null) {\n-                registerMapSchedule(new Runnable() {\n+                removeAfterAction = new Runnable() {\n                     @Override\n                     public void run() {\n                         killMonster(monster, null, false);\n                     }\n-                }, monster.getStats().removeAfter() * 1000);\n+                };\n+                \n+                registerMapSchedule(removeAfterAction, monster.getStats().removeAfter() * 1000);\n             } else {\n-                registerMapSchedule(new Runnable() {\n+                removeAfterAction = new Runnable() {\n                     @Override\n                     public void run() {\n                         killMonster(monster, null, false, selfDestruction.getAction());\n                     }\n-                }, selfDestruction.removeAfter() * 1000);\n+                };\n+                \n+                registerMapSchedule(removeAfterAction, selfDestruction.removeAfter() * 1000);\n             }\n+            \n+            monster.pushRemoveAfterAction(removeAfterAction);\n+        }\n+    }\n+    \n+    public void dismissRemoveAfter(final MapleMonster monster) {\n+        Runnable removeAfterAction = monster.popRemoveAfterAction();\n+        if (removeAfterAction != null) {\n+            this.getChannelServer().forceRunOverallAction(mapid, removeAfterAction);\n         }\n     }\n     \n@@ -2583,6 +2598,18 @@ public MaplePortal findMarketPortal() {\n         return Collections.unmodifiableCollection(portals.values());\n     }\n     */\n+    \n+    public void addPlayerPuppet(MapleCharacter player) {\n+        for (MapleMonster mm : this.getMonsters()) {\n+            mm.aggroAddPuppet(player);\n+        }\n+    }\n+    \n+    public void removePlayerPuppet(MapleCharacter player) {\n+        for (MapleMonster mm : this.getMonsters()) {\n+            mm.aggroRemovePuppet(player);\n+        }\n+    }\n \n     public void removePlayer(MapleCharacter chr) {\n         Channel cserv = chr.getClient().getChannelServer();\n@@ -3699,8 +3726,11 @@ public void run() {\n                     if (mapid >= 922240100 && mapid <= 922240119) {\n                         toggleHiddenNPC(9001108);\n                     }\n-                    mapMonitor.cancel(true);\n-                    mapMonitor = null;\n+                    \n+                    if (mapMonitor != null) {\n+                        mapMonitor.cancel(true);\n+                        mapMonitor = null;\n+                    }\n                 }\n             }\n         }, 1000);\n@@ -3993,7 +4023,7 @@ public void monsterHealed(int trueHeal) {\n     \n     public void dispose() {\n         for(MapleMonster mm : this.getMonsters()) {\n-            mm.disposeLocks();\n+            mm.dispose();\n         }\n         \n         clearMapObjects();"}, {"sha": "dc214327ef4258a154d9b6dff18b29e0d6252222", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -536,6 +536,9 @@ private MapleQuestAction getAction(MapleQuestActionType type, MapleData data) {\n                         case PETTAMENESS:\n \t\t\t\tret = new PetTamenessAction(this, data);\n \t\t\t\tbreak;\n+                        case PETSPEED:\n+\t\t\t\tret = new PetSpeedAction(this, data);\n+\t\t\t\tbreak;\n \t\t\tdefault:\n \t\t\t\t//FilePrinter.printError(FilePrinter.EXCEPTION_CAUGHT, \"Unhandled Action Type: \" + type.toString() + \" QuestID: \" + this.getId());\n \t\t\t\tbreak;"}, {"sha": "06721b45bdffab1c428198d363458235cf0a8c73", "filename": "src/server/quest/MapleQuestActionType.java", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/MapleQuestActionType.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/MapleQuestActionType.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuestActionType.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -26,7 +26,7 @@\n  * @author Matze\n  */\n public enum MapleQuestActionType {\n-    UNDEFINED(-1), EXP(0), ITEM(1), NEXTQUEST(2), MESO(3), QUEST(4), SKILL(5), FAME(6), BUFF(7), PETSKILL(8), YES(9), NO(10), NPC(11), MIN_LEVEL(12), NORMAL_AUTO_START(13), PETTAMENESS(14), ZERO(15);\n+    UNDEFINED(-1), EXP(0), ITEM(1), NEXTQUEST(2), MESO(3), QUEST(4), SKILL(5), FAME(6), BUFF(7), PETSKILL(8), YES(9), NO(10), NPC(11), MIN_LEVEL(12), NORMAL_AUTO_START(13), PETTAMENESS(14), PETSPEED(15), ZERO(16);\n     final byte type;\n \n     private MapleQuestActionType(int type) {\n@@ -62,6 +62,8 @@ public static MapleQuestActionType getByWZName(String name) {\n             return NORMAL_AUTO_START;\n         } else if (name.equals(\"pettameness\")) {\n             return PETTAMENESS;\n+        } else if (name.equals(\"petspeed\")) {\n+            return PETSPEED;\n         } else if (name.equals(\"0\")) {\n             return ZERO;\n         } else {"}, {"sha": "24637256d14eb745e0e387b192f72c591462db8a", "filename": "src/server/quest/actions/PetSpeedAction.java", "status": "added", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/actions/PetSpeedAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/server/quest/actions/PetSpeedAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/PetSpeedAction.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,60 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package server.quest.actions;\n+\n+import client.MapleClient;\n+import client.MapleCharacter;\n+import client.inventory.MaplePet;\n+import provider.MapleData;\n+import provider.MapleDataTool;\n+import server.quest.MapleQuest;\n+import server.quest.MapleQuestActionType;\n+\n+/**\n+ *\n+ * @author Ronan\n+ */\n+public class PetSpeedAction extends MapleQuestAction {\n+\t\n+\tpublic PetSpeedAction(MapleQuest quest, MapleData data) {\n+\t\tsuper(MapleQuestActionType.PETTAMENESS, quest);\n+\t\tquestID = quest.getId();\n+\t}\n+\t\n+\t\n+\t@Override\n+\tpublic void processData(MapleData data) {}\n+\t\n+\t@Override\n+\tpublic void run(MapleCharacter chr, Integer extSelection) {\n+                MapleClient c = chr.getClient();\n+                \n+                MaplePet pet = chr.getPet(0);   // assuming here only the pet leader will gain owner speed\n+                if(pet == null) return;\n+            \n+                c.lockClient();\n+                try {\n+                        pet.addPetFlag(c.getPlayer(), MaplePet.PetFlag.OWNER_SPEED);\n+                } finally {\n+                    c.unlockClient();\n+                }\n+                \n+\t}\n+} "}, {"sha": "f9e5feee6adef85c2b959c350a5d41bd390f6e54", "filename": "src/tools/FilePrinter.java", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/tools/FilePrinter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/tools/FilePrinter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/FilePrinter.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -28,6 +28,7 @@\n             PACKET_LOG = \"game/Log.txt\",\n             CASHITEM_BOUGHT = \"interactions/CashLog.txt\",\n             EXCEPTION = \"game/Exceptions.txt\",\n+            TRADE_EXCEPTION = \"game/TradeExceptions.txt\",\n             SQL_EXCEPTION = \"game/SqlExceptions.txt\",\n             PACKET_HANDLER = \"game/packethandler/\",\n             PORTAL = \"game/portals/\","}, {"sha": "e26d6370d610888dd0fa97787b4526ac6be20dd5", "filename": "src/tools/MaplePacketCreator.java", "status": "modified", "additions": 20, "deletions": 15, "changes": 35, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/src/tools/MaplePacketCreator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/src/tools/MaplePacketCreator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/tools/MaplePacketCreator.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -406,7 +406,7 @@ protected static void addItemInfo(final MaplePacketLittleEndianWriter mplew, Ite\n                         mplew.writeShort(pet.getCloseness());\n                         mplew.write(pet.getFullness());\n                         addExpirationTime(mplew, item.getExpiration());\n-                        mplew.writeInt(0);\n+                        mplew.writeInt(pet.getPetFlag());  /* pet flags found by -- Irenex & Spoon */\n                         mplew.write(new byte[]{(byte) 0x50, (byte) 0x46}); //wonder what this is\n                         mplew.writeInt(0);\n                         return;\n@@ -1065,7 +1065,7 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.writeShort(chr.getHp());\n                 mplew.writeBool(false);\n                 mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n-                mplew.skip(10);\n+                mplew.skip(14);\n                 return mplew.getPacket();\n         }\n         \n@@ -1082,7 +1082,7 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.writeInt(spawnPosition.x);    // spawn position placement thanks to Arnah (Vertisy)\n                 mplew.writeInt(spawnPosition.y);\n                 mplew.writeLong(getTime(Server.getInstance().getCurrentTime()));\n-                mplew.skip(10);\n+                mplew.skip(14);\n                 return mplew.getPacket();\n         }\n         \n@@ -1158,7 +1158,8 @@ public int compare(Pair<MapleStat, Integer> o1, Pair<MapleStat, Integer> o2) {\n                 mplew.write(0x0A); //v83\n                 mplew.write(summon.getSkillLevel());\n                 mplew.writePos(summon.getPosition());\n-                mplew.skip(3);\n+                mplew.write(summon.getStance());    //bMoveAction & foothold, found thanks to Rien dev team\n+                mplew.writeShort(0);\n                 mplew.write(summon.getMovementType().getValue()); // 0 = don't move, 1 = follow (4th mage summons?), 2/4 = only tele follow, 3 = bird follow\n                 mplew.write(summon.isPuppet() ? 0 : 1); // 0 and the summon can't attack - but puppets don't attack with 1 either ^.-\n                 mplew.write(animated ? 0 : 1);\n@@ -1828,8 +1829,7 @@ private static void encodeParentlessMobSpawnEffect(MaplePacketLittleEndianWriter\n                 mplew.writeInt(!drop.isFFADrop() ? (recvrInParty ? drop.getPartyOwnerId() : drop.getOwnerId()) : 0); // owner charid/partyid :)\n                 mplew.write(drop.getDropType()); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA\n                 mplew.writePos(dropto);\n-                // its not charId, but dropper's oid, this error will occur only if a monster's oid in map equals charId, (the item will drop from the error monster)\n-                mplew.writeInt(drop.getDropper().getObjectId());\n+                mplew.writeInt(drop.getDropper().getObjectId()); // dropper oid, found thanks to Li Jixue\n \n                 if (mod != 2) {\n                         mplew.writePos(dropfrom);\n@@ -2736,9 +2736,9 @@ private static int doubleToShortBits(double d) {\n                         }\n                 }\n                 mplew.writeMapleAsciiString(guildName);\n-                mplew.writeMapleAsciiString(allianceName);  // does not seems to work\n+                mplew.writeMapleAsciiString(allianceName);  // does not seem to work\n+                mplew.write(0); // pMedalInfo, thanks to Arnah (Vertisy)\n                 \n-                mplew.write(0);\n                 MaplePet[] pets = chr.getPets();\n                 Item inv = chr.getInventory(MapleInventoryType.EQUIPPED).getItem((short) -114);\n                 for (int i = 0; i < 3; i++) {\n@@ -3778,11 +3778,16 @@ private static void writeLongMaskChair(final MaplePacketLittleEndianWriter mplew\n         }\n \n         /**\n-         * 10: A beginner can't create a party. 1/11/14/19: Your request for a party\n-         * didn't work due to an unexpected error. 13: You have yet to join a party.\n+         * 10: A beginner can't create a party. 1/5/6/11/14/19: Your request for a\n+         * party didn't work due to an unexpected error. 12: Quit as leader of the\n+         * party. 13: You have yet to join a party.\n          * 16: Already have joined a party. 17: The party you're trying to join is\n          * already in full capacity. 19: Unable to find the requested character in\n-         * this channel.\n+         * this channel. 21: Player is blocking any party invitations. 22: Player\n+         * is taking care of another invitation. 23: Player denied request.\n+         * 25: Cannot kick another user in this map. 28/29: Leadership can only be\n+         * given to a party member in the vicinity. 30: Change leadership only on\n+         * same channel.\n          *\n          * @param message\n          * @return\n@@ -4065,7 +4070,7 @@ private static void writeIntMask(final MaplePacketLittleEndianWriter mplew, Map<\n                 mplew.writeInt(cid);\n                 mplew.writeInt(oid);\n                 mplew.write(12);\n-                mplew.writeInt(damage);         // damage display doesn't seems to work...\n+                mplew.writeInt(damage);         // damage display doesn't seem to work...\n                 mplew.writeInt(monsterIdFrom);\n                 mplew.write(0);\n                 return mplew.getPacket();\n@@ -6746,7 +6751,7 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 return mplew.getPacket();\n         }\n \n-        public static byte[] updateAllianceInfo(MapleAlliance alliance, MapleClient c) {\n+        public static byte[] updateAllianceInfo(MapleAlliance alliance, int world) {\n                 final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();\n                 mplew.writeShort(SendOpcode.ALLIANCE_OPERATION.getValue());\n                 mplew.write(0x0F);\n@@ -6761,8 +6766,8 @@ private static void getGuildInfo(final MaplePacketLittleEndianWriter mplew, Mapl\n                 }\n                 mplew.writeInt(alliance.getCapacity()); // probably capacity\n                 mplew.writeShort(0);\n-                for (Integer guildd : alliance.getGuilds()) {\n-                        getGuildInfo(mplew, Server.getInstance().getGuild(guildd, c.getWorld()));\n+                for (Integer guildid : alliance.getGuilds()) {\n+                        getGuildInfo(mplew, Server.getInstance().getGuild(guildid, world));\n                 }\n                 return mplew.getPacket();\n         }"}, {"sha": "dea31716d291b1fa92d28782ba51fac619206572", "filename": "tools/MapleCashCosmeticsChecker/src/maplecashcosmeticschecker/MapleCashCosmeticsChecker.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashCosmeticsChecker/src/maplecashcosmeticschecker/MapleCashCosmeticsChecker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashCosmeticsChecker/src/maplecashcosmeticschecker/MapleCashCosmeticsChecker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleCashCosmeticsChecker/src/maplecashcosmeticschecker/MapleCashCosmeticsChecker.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -57,7 +57,7 @@\n     static String wzPath = \"../../wz\";\n     static String scriptPath = \"../../scripts\";\n     \n-    private static PrintWriter printWriter = null;\n+    static PrintWriter printWriter = null;\n     static InputStreamReader fileReader = null;\n     static BufferedReader bufferedReader = null;\n     "}, {"sha": "c21bdb4382ab3da5a692b5b6c9e495983e44fc30", "filename": "tools/MapleCashVegaChecker/build.xml", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/build.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/build.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleCashVegaChecker/build.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,73 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- You may freely edit this file. See commented blocks below for -->\n+<!-- some examples of how to customize the build. -->\n+<!-- (If you delete it and reopen the project it will be recreated.) -->\n+<!-- By default, only the Clean and Build commands use this build script. -->\n+<!-- Commands such as Run, Debug, and Test only use this build script if -->\n+<!-- the Compile on Save feature is turned off for the project. -->\n+<!-- You can turn off the Compile on Save (or Deploy on Save) setting -->\n+<!-- in the project's Project Properties dialog box.-->\n+<project name=\"MapleCashVegaChecker\" default=\"default\" basedir=\".\">\n+    <description>Builds, tests, and runs the project MapleCashVegaChecker.</description>\n+    <import file=\"nbproject/build-impl.xml\"/>\n+    <!--\n+\n+    There exist several targets which are by default empty and which can be \n+    used for execution of your tasks. These targets are usually executed \n+    before and after some main targets. They are: \n+\n+      -pre-init:                 called before initialization of project properties\n+      -post-init:                called after initialization of project properties\n+      -pre-compile:              called before javac compilation\n+      -post-compile:             called after javac compilation\n+      -pre-compile-single:       called before javac compilation of single file\n+      -post-compile-single:      called after javac compilation of single file\n+      -pre-compile-test:         called before javac compilation of JUnit tests\n+      -post-compile-test:        called after javac compilation of JUnit tests\n+      -pre-compile-test-single:  called before javac compilation of single JUnit test\n+      -post-compile-test-single: called after javac compilation of single JUunit test\n+      -pre-jar:                  called before JAR building\n+      -post-jar:                 called after JAR building\n+      -post-clean:               called after cleaning build products\n+\n+    (Targets beginning with '-' are not intended to be called on their own.)\n+\n+    Example of inserting an obfuscator after compilation could look like this:\n+\n+        <target name=\"-post-compile\">\n+            <obfuscate>\n+                <fileset dir=\"${build.classes.dir}\"/>\n+            </obfuscate>\n+        </target>\n+\n+    For list of available properties check the imported \n+    nbproject/build-impl.xml file. \n+\n+\n+    Another way to customize the build is by overriding existing main targets.\n+    The targets of interest are: \n+\n+      -init-macrodef-javac:     defines macro for javac compilation\n+      -init-macrodef-junit:     defines macro for junit execution\n+      -init-macrodef-debug:     defines macro for class debugging\n+      -init-macrodef-java:      defines macro for class execution\n+      -do-jar:                  JAR building\n+      run:                      execution of project \n+      -javadoc-build:           Javadoc generation\n+      test-report:              JUnit report generation\n+\n+    An example of overriding the target for project execution could look like this:\n+\n+        <target name=\"run\" depends=\"MapleCashVegaChecker-impl.jar\">\n+            <exec dir=\"bin\" executable=\"launcher.exe\">\n+                <arg file=\"${dist.jar}\"/>\n+            </exec>\n+        </target>\n+\n+    Notice that the overridden target depends on the jar target and not only on \n+    the compile target as the regular run target does. Again, for a list of available \n+    properties which you can use, check the target you are overriding in the\n+    nbproject/build-impl.xml file. \n+\n+    -->\n+</project>"}, {"sha": "a1e80b03cf525f57db5847c95dbd5cab73b92be5", "filename": "tools/MapleCashVegaChecker/lib/result.txt", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/lib/result.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/lib/result.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleCashVegaChecker/lib/result.txt?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,5 @@\n+ # Report File autogenerated from the MapleCashVegaChecker feature by Ronan Lana.\n+ # Generated data takes into account several data info from the server-side WZ.xmls.\n+\n+  2040759\n+  2040760"}, {"sha": "328e8e5bc3b7f1f7bad2bc0751a933e00c801983", "filename": "tools/MapleCashVegaChecker/manifest.mf", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/manifest.mf", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/manifest.mf", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleCashVegaChecker/manifest.mf?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,3 @@\n+Manifest-Version: 1.0\n+X-COMMENT: Main-Class will be added automatically by build\n+"}, {"sha": "65207cb91fdf7a1daa9ba96f9aac2485d3ed4fe0", "filename": "tools/MapleCashVegaChecker/src/maplecashvegachecker/MapleCashVegaChecker.java", "status": "added", "additions": 213, "deletions": 0, "changes": 213, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/src/maplecashvegachecker/MapleCashVegaChecker.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/tools/MapleCashVegaChecker/src/maplecashvegachecker/MapleCashVegaChecker.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/tools/MapleCashVegaChecker/src/maplecashvegachecker/MapleCashVegaChecker.java?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -0,0 +1,213 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2018 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+package maplecashvegachecker;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ *\n+ * @author RonanLana\n+ * \n+   This application main objective is to read Vega-related information from\n+   the item's description report back missing nodes for these items.\n+  \n+   Estimated parse time: 10 seconds\n+ */\n+public class MapleCashVegaChecker {\n+    \n+    private static String wzPath = \"../../wz\";\n+    \n+    static PrintWriter printWriter = null;\n+    static InputStreamReader fileReader = null;\n+    static BufferedReader bufferedReader = null;\n+    \n+    static int initialStringLength = 1000;\n+    static int currentItem;\n+    \n+    static byte status = 0;\n+    \n+    static Set<Integer> vegaItems = new HashSet<>();\n+    \n+    private static String getName(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"name\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+\n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static String getValue(String token) {\n+        int i, j;\n+        char[] dest;\n+        String d;\n+\n+        i = token.lastIndexOf(\"value=\");\n+        i = token.indexOf(\"\\\"\", i) + 1; //lower bound of the string\n+        j = token.indexOf(\"\\\"\", i);     //upper bound\n+\n+        dest = new char[initialStringLength];\n+        token.getChars(i, j, dest, 0);\n+        \n+        d = new String(dest);\n+        return(d.trim());\n+    }\n+    \n+    private static void forwardCursor(int st) {\n+        String line = null;\n+\n+        try {\n+            while(status >= st && (line = bufferedReader.readLine()) != null) {\n+                simpleToken(line);\n+            }\n+        }\n+        catch(Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static void simpleToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        }\n+    }\n+    \n+    private static void translateItemToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+            \n+            if (status == 2) {\n+                currentItem = Integer.valueOf(getName(token));\n+            }\n+        } else {\n+            if (status == 2) {\n+                if (getValue(token).endsWith(\"Vega&apos;s Spell.\")) {\n+                    vegaItems.add(currentItem);\n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void translateVegaToken(String token) {\n+        if(token.contains(\"/imgdir\")) {\n+            status -= 1;\n+        }\n+        else if(token.contains(\"imgdir\")) {\n+            status += 1;\n+        } else {\n+            if (status == 2) {\n+                if (getName(token).contentEquals(\"item\")) {\n+                    vegaItems.remove(Integer.valueOf(getValue(token)));\n+                }\n+            }\n+        }\n+    }\n+    \n+    private static void readItemDescriptionFile(File f) {\n+        System.out.print(\"Reading String.wz... \");\n+        try {\n+            fileReader = new InputStreamReader(new FileInputStream(f), \"UTF-8\");\n+            bufferedReader = new BufferedReader(fileReader);\n+\n+            String line;\n+            while((line = bufferedReader.readLine())!=null){\n+                translateItemToken(line);\n+            }\n+\n+            bufferedReader.close();\n+            fileReader.close();\n+        } catch (IOException ioe) {\n+            ioe.printStackTrace();\n+        }\n+        System.out.println(vegaItems.size() + \" Vega Scroll items found\");\n+    }\n+    \n+    private static void readVegaDescriptionFile(File f) {\n+        System.out.println(\"Reading Etc.wz...\");\n+        try {\n+            fileReader = new InputStreamReader(new FileInputStream(f), \"UTF-8\");\n+            bufferedReader = new BufferedReader(fileReader);\n+\n+            String line;\n+            while((line = bufferedReader.readLine())!=null){\n+                translateVegaToken(line);\n+            }\n+\n+            bufferedReader.close();\n+            fileReader.close();\n+        } catch (IOException ioe) {\n+            ioe.printStackTrace();\n+        }\n+    }\n+    \n+    private static void printReportFileHeader() {\n+        printWriter.println(\" # Report File autogenerated from the MapleCashVegaChecker feature by Ronan Lana.\");\n+        printWriter.println(\" # Generated data takes into account several data info from the server-side WZ.xmls.\");\n+        printWriter.println();\n+    }\n+    \n+    private static void reportMissingVegaItems() {\n+        System.out.println(\"Reporting results ...\");\n+        \n+        try {\n+            printWriter = new PrintWriter(\"lib/result.txt\", \"UTF-8\");\n+        \n+            printReportFileHeader();\n+\n+            for (Integer itemid : vegaItems) {\n+                printWriter.println(\"  \" + itemid);\n+            }\n+            \n+            printWriter.close();\n+        } catch (IOException ioe) {\n+            ioe.printStackTrace();\n+        }\n+        \n+    }\n+    \n+    public static void main(String[] args) {\n+        \n+        readItemDescriptionFile(new File(wzPath + \"/String.wz/Consume.img.xml\"));\n+        readVegaDescriptionFile(new File(wzPath + \"/Etc.wz/VegaSpell.img.xml\"));\n+        \n+        reportMissingVegaItems();\n+    }\n+    \n+}"}, {"sha": "a3419e6da5bc4112c1cd5840ff53a124daa82051", "filename": "wz/Character.wz/Accessory/01142009.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142009.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142009.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142009.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"1\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "b74620fa57b5e21a768c3c8248b7ff79818e8489", "filename": "wz/Character.wz/Accessory/01142010.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142010.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142010.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142010.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"2\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "9cc7d4cec6ae8ecdcf4488ed50c5e551fb9b27e3", "filename": "wz/Character.wz/Accessory/01142011.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142011.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142011.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142011.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"4\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "965488746cf125a6d268fbda854ec1c2fcda625e", "filename": "wz/Character.wz/Accessory/01142012.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142012.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142012.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142012.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"8\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "2112704e2ed32c4fefe1c365f66783e0f6927ead", "filename": "wz/Character.wz/Accessory/01142013.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142013.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142013.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142013.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"16\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "1940253d8900e0218b4c8977a70e40f67ee84104", "filename": "wz/Character.wz/Accessory/01142133.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142133.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Character.wz/Accessory/01142133.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Character.wz/Accessory/01142133.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -10,7 +10,7 @@\n     <string name=\"islot\" value=\"Me\"/>\n     <string name=\"vslot\" value=\"Me\"/>\n     <int name=\"reqJob\" value=\"0\"/>\n-    <int name=\"reqLevel\" value=\"200\"/>\n+    <int name=\"reqLevel\" value=\"180\"/>\n     <int name=\"reqSTR\" value=\"0\"/>\n     <int name=\"reqDEX\" value=\"0\"/>\n     <int name=\"reqINT\" value=\"0\"/>"}, {"sha": "a1d0196a03dd9f46ffc7e1eecca0c62afab28a94", "filename": "wz/Etc.wz/Commodity.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Etc.wz/Commodity.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Etc.wz/Commodity.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Etc.wz/Commodity.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -48790,7 +48790,7 @@\n     <int name=\"Period\" value=\"90\"/>\n     <int name=\"Priority\" value=\"12\"/>\n     <int name=\"Gender\" value=\"2\"/>\n-    <int name=\"OnSale\" value=\"1\"/>\n+    <int name=\"OnSale\" value=\"0\"/>\n   </imgdir>\n   <imgdir name=\"4714\">\n     <int name=\"SN\" value=\"10102432\"/>"}, {"sha": "e5625d16a2876a0cf3c958e6463dc72a1c048682", "filename": "wz/Etc.wz/VegaSpell.img.xml", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Etc.wz/VegaSpell.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Etc.wz/VegaSpell.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Etc.wz/VegaSpell.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -796,4 +796,12 @@\n     <int name=\"item\" value=\"2048013\"/>\n     <string name=\"prob\" value=\"[R8]0.6\"/>\n   </imgdir>\n+  <imgdir name=\"199\">\n+    <int name=\"item\" value=\"2040759\"/>\n+    <string name=\"prob\" value=\"[R8]0.6\"/>\n+  </imgdir>\n+  <imgdir name=\"200\">\n+    <int name=\"item\" value=\"2040760\"/>\n+    <string name=\"prob\" value=\"[R8]0.1\"/>\n+  </imgdir>\n </imgdir>"}, {"sha": "3a5a15ffbcdb25d5a75fb5a49edfd8aee027f977", "filename": "wz/Mob.wz/8520000.img.xml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Mob.wz/8520000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Mob.wz/8520000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Mob.wz/8520000.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -26,7 +26,6 @@\n     <int name=\"boss\" value=\"1\"/>\n     <int name=\"firstAttack\" value=\"1\"/>\n     <int name=\"publicReward\" value=\"1\"/>\n-    <string name=\"removeAfter\" value=\"129600\"/>\n     <imgdir name=\"skill\">\n       <imgdir name=\"0\">\n         <int name=\"skill\" value=\"114\"/>"}, {"sha": "64365fca392792a59e05aa7e719f268502fe78a6", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -38562,6 +38562,9 @@\n         <imgdir name=\"48\">\n           <int name=\"id\" value=\"5000060\"/>\n         </imgdir>\n+        <imgdir name=\"49\">\n+          <int name=\"id\" value=\"5000066\"/>\n+        </imgdir>\n       </imgdir>\n     </imgdir>\n     <imgdir name=\"1\">\n@@ -38736,6 +38739,9 @@\n         <imgdir name=\"48\">\n           <int name=\"id\" value=\"5000060\"/>\n         </imgdir>\n+        <imgdir name=\"49\">\n+          <int name=\"id\" value=\"5000066\"/>\n+        </imgdir>\n       </imgdir>\n     </imgdir>\n   </imgdir>"}, {"sha": "18f7d8137256dd2c310a02b64e5c76ed3a5b224a", "filename": "wz/Quest.wz/QuestInfo.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Quest.wz/QuestInfo.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/Quest.wz/QuestInfo.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/QuestInfo.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -6865,7 +6865,7 @@ Once there, talk to #b#p1200003##k to board the ship.\n     <int name=\"area\" value=\"30\"/>\n     <string name=\"0\" value=\"Apparently, the #bThe Rememberer#k of Sleepywood is conducting studies on mutated Horny Mushrooms. You should go to Sleepywood to find out more.\"/>\n     <string name=\"1\" value=\"Some Horny Mushrooms have been acting really mean lately, and there seems to be something suspicious going on. #bThe Rememberer has noticed the change and is conducting studies on these supicious Horny Mushrooms.\\r\\n\"/>\n-    <string name=\"2\" value=\"You helped #bThe Rememberer# with his research on Horny Mushrooms, but he seems to need some more information.\"/>\n+    <string name=\"2\" value=\"You helped #bThe Rememberer#k with his research on Horny Mushrooms, but he seems to need some more information.\"/>\n     <string name=\"parent\" value=\"Strange Mushrooms\"/>\n     <int name=\"order\" value=\"1\"/>\n     <string name=\"rewardSummary\" value=\"EXP 7,000\\r\\nCan proceed to &apos;Raging Horny Mushrooms&apos; quest\\r\\n\"/>"}, {"sha": "e398dc40760c487904067174f673d8255a619004", "filename": "wz/String.wz/Consume.img.xml", "status": "modified", "additions": 21, "deletions": 21, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/String.wz/Consume.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/String.wz/Consume.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Consume.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -1468,7 +1468,7 @@\n     <string name=\"desc\" value=\"Returns you to Sleepywood, a quiet and dark forest-town.\"/>\n   </imgdir>\n   <imgdir name=\"2030007\">\n-    <string name=\"name\" value=\"Return Scroll for Dead Mine\"/>\n+    <string name=\"name\" value=\"Return Scroll to Dead Mine\"/>\n     <string name=\"desc\" value=\"Returns you to the dead mine at the higher ground of El Nath.nCan only be used in Orbis and El Nath.\"/>\n   </imgdir>\n   <imgdir name=\"2030008\">\n@@ -1496,7 +1496,7 @@\n     <string name=\"desc\" value=\"Warp powder made by fairy Phyllia.  Teleports you to Magatia when used inside the Nihal desert region.\"/>\n   </imgdir>\n   <imgdir name=\"2030019\">\n-    <string name=\"name\" value=\"Nautilus Return Scroll\"/>\n+    <string name=\"name\" value=\"Return Scroll to Nautilus\"/>\n     <string name=\"desc\" value=\"This scroll enables you to return to the Pirate village, Nautilus. This is a one use item and will disappear after use.\"/>\n   </imgdir>\n   <imgdir name=\"2030100\">\n@@ -4588,7 +4588,7 @@\n   </imgdir>\n   <imgdir name=\"2280004\">\n     <string name=\"name\" value=\"[Skill Book] Infinity\"/>\n-    <string name=\"desc\" value=\"You can learn #Infinity# with this book.rnJob : 4th Advancement MagicianrnCondition : #cInfinity# not acquired\"/>\n+    <string name=\"desc\" value=\"You can learn #cInfinity# with this book.rnJob : 4th Advancement MagicianrnCondition : #cInfinity# not acquired\"/>\n   </imgdir>\n   <imgdir name=\"2280005\">\n     <string name=\"name\" value=\"[Skill Book] Dragon&apos;s Breath\"/>\n@@ -8044,59 +8044,59 @@\n     <string name=\"desc\" value=\"Skill Book from which you can learn about the #cSlime&apos;s Weakness# skill.\\nCondition: #cSlime&apos;s Weakness# not available\"/>\n   </imgdir>\n   <imgdir name=\"2290126\">\n-    <string name=\"name\" value=\"[Mastery Book] Overswing 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Overswing\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cOverswing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290127\">\n-    <string name=\"name\" value=\"[Mastery Book] Overswing 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Overswing\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cOverswing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290128\">\n-    <string name=\"name\" value=\"[Mastery Book] High Mastery 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] High Mastery\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cHigh Mastery# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290129\">\n-    <string name=\"name\" value=\"[Mastery Book] High Mastery 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] High Mastery\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cHigh Mastery# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290130\">\n-    <string name=\"name\" value=\"[Mastery Book] Freeze Standing 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Freeze Standing\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cFreeze Standing# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290131\">\n-    <string name=\"name\" value=\"[Mastery Book] Freeze Standing 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Freeze Standing\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cFreeze Standing# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290132\">\n-    <string name=\"name\" value=\"[Mastery Book] Final Blow 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Final Blow\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cFinal Blow# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290133\">\n-    <string name=\"name\" value=\"[Mastery Book] Final Blow 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Final Blow\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cFinal Blow# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290134\">\n-    <string name=\"name\" value=\"[Mastery Book] High Defense 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] High Defense\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cHigh Defense# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290135\">\n-    <string name=\"name\" value=\"[Mastery Book] High Defense 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] High Defense\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cHigh Defense# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290136\">\n-    <string name=\"name\" value=\"[Mastery Book] Combo Tempest 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Combo Tempest\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cCombo Tempest# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290137\">\n-    <string name=\"name\" value=\"[Mastery Book] Combo Tempest 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Combo Tempest\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cCombo Tempest# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2290138\">\n-    <string name=\"name\" value=\"[Mastery Book] Combo Barrier 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Combo Barrier\"/>\n     <string name=\"desc\" value=\"With a 70% success rate, raises the Mastery Level of #cCombo Barrier# to 20.\\nJob: Aran\\nCondition: Min Skill Lv. 5\"/>\n   </imgdir>\n   <imgdir name=\"2290139\">\n-    <string name=\"name\" value=\"[Mastery Book] Combo Barrier 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Combo Barrier\"/>\n     <string name=\"desc\" value=\"With a 50% success rate, raises the Mastery Level of #cCombo Barrier# to 30.\\nJob: Aran\\nCondition: Min Skill Lv. 15\"/>\n   </imgdir>\n   <imgdir name=\"2380014\">\n@@ -8205,7 +8205,7 @@\n   </imgdir>\n   <imgdir name=\"2040759\">\n     <string name=\"name\" value=\"Scroll for Shoes for ATT\"/>\n-    <string name=\"desc\" value=\"Improves attack on gloves.\\nSuccess rate: 60%. Weapon Attack +2. The success rate of this scroll can be enhanced by Vega&apos;s Spell.\"/>\n+    <string name=\"desc\" value=\"Improves attack on shoes.\\nSuccess rate: 60%. Weapon Attack +2. The success rate of this scroll can be enhanced by Vega&apos;s Spell.\"/>\n   </imgdir>\n   <imgdir name=\"2040760\">\n     <string name=\"name\" value=\"Scroll for Shoes for ATT\"/>\n@@ -8556,7 +8556,7 @@\n     <string name=\"desc\" value=\"A mysterious and unripe Onyx Apple. When consumed, it grants the following: ATT +60, Magic ATT +70, DEF +10 for 1 minute.\"/>\n   </imgdir>\n   <imgdir name=\"2030020\">\n-    <string name=\"name\" value=\"Return to New Leaf City Scroll\"/>\n+    <string name=\"name\" value=\"Return Scroll to New Leaf City\"/>\n     <string name=\"desc\" value=\"Use this scroll to venture back to New Leaf City whenever you want!\"/>\n   </imgdir>\n   <imgdir name=\"2000000\">\n@@ -8960,7 +8960,7 @@\n     <string name=\"desc\" value=\"This increases the master level of #cSmokescreen# up to 30 with 50% of chance.\\r\\nClass : Shadower\\r\\nCondition : Skill level above 15\"/>\n   </imgdir>\n   <imgdir name=\"2290096\">\n-    <string name=\"name\" value=\"[Mastery Book] Maple Warrior 20\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Maple Warrior\"/>\n     <string name=\"desc\" value=\"This increases the master level of #cMaple Warrior# up to 20 with 70% of chance.\\r\\nJob : All 4th Advancement Jobs\\r\\nCondition : Skill level above 5\"/>\n   </imgdir>\n   <imgdir name=\"2290097\">\n@@ -9072,7 +9072,7 @@\n     <string name=\"desc\" value=\"With a 70% success rate, it raises the Master Level of #cBullseye# to 20.nJob : Corsair\\r\\nRequirement : At least Level 5 in this skill\"/>\n   </imgdir>\n   <imgdir name=\"2290125\">\n-    <string name=\"name\" value=\"[Mastery Book] Maple Warrior 30\"/>\n+    <string name=\"name\" value=\"[Mastery Book] Maple Warrior\"/>\n     <string name=\"desc\" value=\"This increases the master level of #cMaple Warrior# up to 30 with 50% of chance.\\r\\nJob : All 4th Advancement Jobs\\r\\nCondition : Skill level above 15\"/>\n   </imgdir>\n   <imgdir name=\"2022303\">"}, {"sha": "06181f5d929891793dbaf705e90295e803e4fc62", "filename": "wz/String.wz/Eqp.img.xml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/46fec675f139abd9b81cbe5e862152c89444cc59/wz/String.wz/Eqp.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/46fec675f139abd9b81cbe5e862152c89444cc59/wz/String.wz/Eqp.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/String.wz/Eqp.img.xml?ref=46fec675f139abd9b81cbe5e862152c89444cc59", "patch": "@@ -4573,7 +4573,7 @@\n         <string name=\"name\" value=\"Ragged Black Cape\"/>\n       </imgdir>\n       <imgdir name=\"1102083\">\n-        <string name=\"name\" value=\"Ragged Red Cape\"/>\n+        <string name=\"name\" value=\"Ragged Green Cape\"/>\n       </imgdir>\n       <imgdir name=\"1102084\">\n         <string name=\"name\" value=\"Pink Gaia Cape\"/>"}]}]},
