{"fetchDate": "2019-12-19", "content": [{"sha": "81f92262864fc271d380bd6261d51d51fc2224df", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6ODFmOTIyNjI4NjRmYzI3MWQzODBiZDYyNjFkNTFkNTFmYzIyMjRkZg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-06-13T23:47:58Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2017-06-13T23:47:58Z"}, "message": "GuildPQ Queue system + revamped Warp mechanic\n\nAdded a queue system for waiting guilds outside the GPQ area. Changed\nthe way players are transported through maps on non-portal passing\ncases: if not defined, a spawn point is chosen randomly for each player.", "tree": {"sha": "14b148f0ef0ec48a3d00410a66ee5514ca813a2c", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/14b148f0ef0ec48a3d00410a66ee5514ca813a2c"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/81f92262864fc271d380bd6261d51d51fc2224df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/81f92262864fc271d380bd6261d51d51fc2224df", "html_url": "https://github.com/ronancpl/HeavenMS/commit/81f92262864fc271d380bd6261d51d51fc2224df", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/81f92262864fc271d380bd6261d51d51fc2224df/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7a8bba98ca8c69a06e2111dcbda9b0d4d637c9ed", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/7a8bba98ca8c69a06e2111dcbda9b0d4d637c9ed", "html_url": "https://github.com/ronancpl/HeavenMS/commit/7a8bba98ca8c69a06e2111dcbda9b0d4d637c9ed"}], "stats": {"total": 1028, "additions": 661, "deletions": 367}, "files": [{"sha": "20990307a344614a9cda3cdef64ddbd8092ee395", "filename": "build/built-jar.properties", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/built-jar.properties", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/built-jar.properties", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/built-jar.properties?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1,4 +1,4 @@\n-#Mon, 12 Jun 2017 14:40:21 -0300\n+#Tue, 13 Jun 2017 20:04:33 -0300\n \n \n C\\:\\\\Nexon\\\\MapleSolaxia\\\\MapleSolaxiaV2="}, {"sha": "0eff4df0bd45c38c0c2d81f104ddc211f1ade79c", "filename": "build/classes/client/MapleCharacter$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$1.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "0b646bb9bbd563079951c1ae98f84d2ae7cd5ce3", "filename": "build/classes/client/MapleCharacter$10.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$10.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$10.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$10.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "272b892a782886c2699d13f984073a04fb2e3db6", "filename": "build/classes/client/MapleCharacter$11.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$11.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$11.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$11.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "24e3db5287dfa970c9eca72ac8331cf2ed951bb6", "filename": "build/classes/client/MapleCharacter$12.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$12.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$12.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$12.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "76209ac700ec62ee4f14a9a784a9572aa53ff9db", "filename": "build/classes/client/MapleCharacter$13.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$13.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$13.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$13.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "f61dfa482d3247a746433329b5ab055d6c808451", "filename": "build/classes/client/MapleCharacter$14.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$14.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$14.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$14.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "0854f98674d37312dbdf36965ed31962e1f23ed1", "filename": "build/classes/client/MapleCharacter$15.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$15.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$15.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$15.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "79898b5c874b4b40047d7a2c93d7c90be3b5d534", "filename": "build/classes/client/MapleCharacter$16.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$16.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$16.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$16.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "e520ac3c5a662393944972342807890d38366120", "filename": "build/classes/client/MapleCharacter$17.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$17.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$17.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$17.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "ffdc7903cac8c015ce06afad29b904fc9b758059", "filename": "build/classes/client/MapleCharacter$18.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$18.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$18.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$18.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "a314c4d1a0f6244578b420fdbd3b6d9980c03ac4", "filename": "build/classes/client/MapleCharacter$2.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$2.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$2.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$2.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "26352f663a5e834c8335cdb13fc56f394970d407", "filename": "build/classes/client/MapleCharacter$3.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$3.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$3.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$3.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "2b893eebf9663655e0870919f1a0ebfdebeebe56", "filename": "build/classes/client/MapleCharacter$4.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$4.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$4.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$4.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "5d3abdfe32fdf0ce47694a4e5b563f4ebfc12268", "filename": "build/classes/client/MapleCharacter$5.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$5.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$5.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$5.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "b14de10d838ee521f0563481098b371e7b4a46bf", "filename": "build/classes/client/MapleCharacter$6.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$6.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$6.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$6.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "21f54190fc207be1c79581105fe86a6e7450cbb5", "filename": "build/classes/client/MapleCharacter$7.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$7.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$7.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$7.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "d7d64736ffd583710e1e31a3397fdea01fd5f166", "filename": "build/classes/client/MapleCharacter$8.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$8.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$8.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$8.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "955f4dd2ffa4c87094f22d481b505174fc20b13b", "filename": "build/classes/client/MapleCharacter$9.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$9.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$9.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$9.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "5779bd24925a5fa6b6161379388ebc75e040992b", "filename": "build/classes/client/MapleCharacter$FameStatus.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$FameStatus.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$FameStatus.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$FameStatus.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "5c4f79fa8c674a5ca2b2f97eb5bff93775871739", "filename": "build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$MapleBuffStatValueHolder.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "40cb71201d1d6f2dbe3c8d702328ecf9df46dc42", "filename": "build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$MapleCoolDownValueHolder.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "c15b8968c2cd4456196e5415fb4243d9f9b0dcd6", "filename": "build/classes/client/MapleCharacter$SkillEntry.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$SkillEntry.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter$SkillEntry.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter$SkillEntry.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "6e4ca68a7f6419d33f63003f1a5fbfeea3e3e81e", "filename": "build/classes/client/MapleCharacter.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/MapleCharacter.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/MapleCharacter.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "b53b5a20c85f909c27030084524bee6930326e11", "filename": "build/classes/client/command/Commands.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/command/Commands.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/client/command/Commands.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/client/command/Commands.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "8870918038148c06b12b5bcefc86fee3fe994c75", "filename": "build/classes/net/server/channel/Channel.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/channel/Channel.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/channel/Channel.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/Channel.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "20da458f47d31ddc76597601d4864361d6574de6", "filename": "build/classes/net/server/channel/handlers/ChangeMapHandler.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/channel/handlers/ChangeMapHandler.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/channel/handlers/ChangeMapHandler.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/channel/handlers/ChangeMapHandler.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "baa56660b3b406a4494aa5b5bbe2f1d328c6dbcf", "filename": "build/classes/net/server/world/World$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/world/World$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/world/World$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/world/World$1.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "eff849d1818b3564159aa0052f8904872bae05e0", "filename": "build/classes/net/server/world/World.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/world/World.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/net/server/world/World.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/net/server/world/World.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "c1df24b70a9701f9303d54ef19b34e95bb78ed35", "filename": "build/classes/provider/wz/WZIMGFile.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/provider/wz/WZIMGFile.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/provider/wz/WZIMGFile.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/provider/wz/WZIMGFile.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "bae8646bea66d51cb6b628ed634c6e43f3138180", "filename": "build/classes/scripting/AbstractPlayerInteraction.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/AbstractPlayerInteraction.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/AbstractPlayerInteraction.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/AbstractPlayerInteraction.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "f899a457711aa159290c2628b21dd0773ef73ccb", "filename": "build/classes/scripting/event/EventInstanceManager$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventInstanceManager$1.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "fd3ed07051c5ccbffc4e7867dde78de9a8178fbb", "filename": "build/classes/scripting/event/EventInstanceManager$2.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$2.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$2.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventInstanceManager$2.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "cae96034428bc59d219c192ea1ed679cfcf42eee", "filename": "build/classes/scripting/event/EventInstanceManager$3.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$3.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager$3.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventInstanceManager$3.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "4a2833ce311b6143a8cba1a454803e2f624cb281", "filename": "build/classes/scripting/event/EventInstanceManager.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventInstanceManager.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventInstanceManager.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "f3690101a159f85578310ef00c7aff80a00ab4bf", "filename": "build/classes/scripting/event/EventManager$1.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$1.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$1.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventManager$1.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "3b6b461520f8632b27c6cad1d24f3d7d0f82cb00", "filename": "build/classes/scripting/event/EventManager$2.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$2.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$2.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventManager$2.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "06b4cc64cee9d6b2abbf765eb9f85d0008821e99", "filename": "build/classes/scripting/event/EventManager$3.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$3.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager$3.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventManager$3.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "e5097b1c40051ad98e72532c7e650f6d55bf634b", "filename": "build/classes/scripting/event/EventManager.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/scripting/event/EventManager.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/scripting/event/EventManager.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "085aa0cea33937720ef8d00ba4cb9774f7dafe76", "filename": "build/classes/server/MapleStatEffect.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/server/MapleStatEffect.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/server/MapleStatEffect.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/MapleStatEffect.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "2ada2f8c4f337634171aac616b6e17bc1434837d", "filename": "build/classes/server/maps/MapleMap.class", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/server/maps/MapleMap.class", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/build/classes/server/maps/MapleMap.class", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/build/classes/server/maps/MapleMap.class?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "50a528771ecef4919b0f9082eff4a458442b578e", "filename": "dist/MapleSolaxia.jar", "status": "modified", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/dist/MapleSolaxia.jar", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/dist/MapleSolaxia.jar", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/dist/MapleSolaxia.jar?ref=81f92262864fc271d380bd6261d51d51fc2224df"}, {"sha": "147833c2e341c618ba55401b6c57ce1a9a1ae16a", "filename": "mychanges_ptbr.txt", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/mychanges_ptbr.txt?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -309,4 +309,8 @@ Corre\n Incrementada a documenta\ufffd\ufffdo referente aos m\ufffdtodos usados nos scripts de eventos.\n \n 12 Junho 2016,\n-Corre\ufffd\ufffdo de falha em cria\ufffd\ufffdo de guilds, n\ufffdo atribuindo corretamente o t\ufffdtulo de mestre da guild ao criador.\n\\ No newline at end of file\n+Corre\ufffd\ufffdo de falha em cria\ufffd\ufffdo de guilds, n\ufffdo atribuindo corretamente o t\ufffdtulo de mestre da guild ao criador.\n+\n+13 Junho 2016,\n+Mudan\ufffda nas mec\ufffdnicas de busca por portais ao transportar cada jogador: quando n\ufffdo for definido, escolhe-se um spawn point aleatoriamente.\n+Implementa\ufffd\ufffdo de fila de espera para Guilds na GPQ (funciona em harmonia com o sistema de lobbys).\n\\ No newline at end of file"}, {"sha": "22548efa3bfc3d16eafdea1add1e0b5484d602c7", "filename": "nbproject/private/private.xml", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/nbproject/private/private.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/nbproject/private/private.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/nbproject/private/private.xml?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -5,17 +5,21 @@\n             <url>src/tools/MaplePacketCreator.java</url>\n             <bookmark id=\"1\">\n                 <name/>\n-                <line>5939</line>\n+                <line>5937</line>\n                 <key/>\n             </bookmark>\n         </file>\n     </editor-bookmarks>\n     <open-files xmlns=\"http://www.netbeans.org/ns/projectui-open-files/2\">\n         <group>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/OrbisPQ.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/0_EXAMPLE.js</file>\n-            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/BossRushPQ.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/GuildQuest.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/event/CWKPQ.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/9040000.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/AbstractPlayerInteraction.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/scripts/npc/2040034.js</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/client/MapleCharacter.java</file>\n             <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/scripting/event/EventManager.java</file>\n+            <file>file:/C:/Nexon/MapleSolaxia/MapleSolaxiaV2/src/net/server/channel/Channel.java</file>\n         </group>\n     </open-files>\n </project-private>"}, {"sha": "db15e75c8ec4c73a98725b4e8f5f3266205009ab", "filename": "scripts/event/GuildQuest.js", "status": "modified", "additions": 212, "deletions": 143, "changes": 355, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/event/GuildQuest.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/event/GuildQuest.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/GuildQuest.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -19,197 +19,266 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n  */\n \n-/*\n- * @Author Lerk\n- * \n- * Guild Quest \n- */\n+/**\n+ * @author: Ronan\n+ * @event: Sharenian Guild PQ\n+*/\n+\n+var isPq = true;\n+var minPlayers = 1, maxPlayers = 30;\n+var minLevel = 1, maxLevel = 200;\n+var entryMap = 990000000;\n+var exitMap = 990001100;\n+var recruitMap = 101030104;\n+var clearMap = 990001101;\n+\n+var minMapId = 990000000;\n+var maxMapId = 990001101;\n \n-var exitMap;\n-var waitingListCurrent = 0;\n- \n-importPackage(Packages.world);\n-importPackage(Packages.client);\n-importPackage(Packages.server.maps);\n-importPackage(java.lang);\n+var waitTime = 3;\n+var eventTime = 90;     // 90 minutes\n+\n+var lobbyRange = [0, 0];\n \n function init() {\n-    em.setProperty(\"shuffleReactors\",\"false\");\n-\tem.setProperty(\"canEnter\", \"true\");\n-\tem.setProperty(\"gpqOpen\", \"true\");\n+        setEventRequirements();\n+}\n+\n+function setLobbyRange() {\n+        return lobbyRange;\n }\n \n-function monsterValue(eim, mobId) { //should only trigger on ergoth\n-    if (mobId == 9300028) { //but, just to be safe...\n-        var rubian = new Packages.client.inventory.Item(4001024, 0, 1);\n-        var map = eim.getMapInstance(990000900);\n-        var reactor = map.getReactorByName(\"boss\");\n-        map.spawnItemDrop(reactor, eim.getPlayers().get(0), rubian, reactor.getPosition(), true, false);\n-    }\n-    return -1;\n+function setEventRequirements() {\n+        var reqStr = \"\";\n+        \n+        reqStr += \"\\r\\n    Number of players: \";\n+        if(maxPlayers - minPlayers >= 1) reqStr += minPlayers + \" ~ \" + maxPlayers;\n+        else reqStr += minPlayers;\n+        \n+        reqStr += \"\\r\\n    Level range: \";\n+        if(maxLevel - minLevel >= 1) reqStr += minLevel + \" ~ \" + maxLevel;\n+        else reqStr += minLevel;\n+        \n+        reqStr += \"\\r\\n    Time limit: \";\n+        reqStr += eventTime + \" minutes\";\n+        \n+        em.setProperty(\"party\", reqStr);\n }\n \n+function setEventExclusives(eim) {\n+        var itemSet = [1032033, 4001024, 4001025, 4001026, 4001027, 4001028, 4001029, 4001030, 4001031, 4001032, 4001033, 4001034, 4001035, 4001037];\n+        eim.setExclusiveItems(itemSet);\n+}\n \n+function setEventRewards(eim) {\n+        var itemSet, itemQty, evLevel, expStages;\n \n-function setup(eim) {\n-    exitMap = em.getChannelServer().getMapFactory().getMap(990001100); //returning path\n+        evLevel = 1;    //Rewards at clear PQ\n+        itemSet = [];\n+        itemQty = [];\n+        eim.setEventRewards(evLevel, itemSet, itemQty);\n         \n-    //shuffle reactors in two maps for stage 3\n-    eim.getMapInstance(990000501).shuffleReactors();\n-    eim.getMapInstance(990000502).shuffleReactors();\n+        expStages = [];    //bonus exp given on CLEAR stage signal\n+        eim.setEventClearStageExp(expStages);\n+}\n+\n+function getEligibleParty(party) {      //selects, from the given party, the team that is allowed to attempt this event\n+        var eligible = [];\n+        var hasLeader = false;\n         \n-    //force no-respawn on certain map reactors\n-    eim.getMapInstance(990000611).getReactorByName(\"\").setDelay(-1);\n-    eim.getMapInstance(990000620).getReactorByName(\"\").setDelay(-1);\n-    eim.getMapInstance(990000631).getReactorByName(\"\").setDelay(-1);\n-    eim.getMapInstance(990000641).getReactorByName(\"\").setDelay(-1);\n+        var guildId = 0;\n         \n-    //activate three minutes after start\n-\teim.setProperty(\"entryTimestamp\", Packages.java.lang.System.currentTimeMillis());\n-    eim.setProperty(\"canEnter\",\"true\");\n-    eim.schedule(\"begin\", 60000);\n-\teim.startEventTimer(60000);\n+        if(party.size() > 0) {\n+                var partyList = party.toArray();\n+                \n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+                        if(ch.isLeader()) {\n+                                guildId = ch.getGuildId();\n+                                break;\n+                        }\n+                }\n+\n+                for(var i = 0; i < party.size(); i++) {\n+                        var ch = partyList[i];\n+\n+                        if(ch.getMapId() == recruitMap && ch.getLevel() >= minLevel && ch.getLevel() <= maxLevel && ch.getGuildId() == guildId) {\n+                                if(ch.isLeader()) hasLeader = true;\n+                                eligible.push(ch);\n+                        }\n+                }\n+        }\n+        \n+        if(!(hasLeader)) eligible = [];\n+        return eligible;\n }\n \n-function begin(eim) {\n-    eim.setProperty(\"canEnter\",\"false\");\n-    var party = eim.getPlayers();\n-    //if (party.size() < 6) { //not enough to start\n-    //        end(eim,\"There are no longer enough players to continue, and those remaining shall be warped out.\");\n-    //} else {\n-    var iter = party.iterator();\n-    while (iter.hasNext()) {\n-        iter.next().dropMessage(6,\"The quest has begun.\");\n-    }\n-\t\n-\teim.startEventTimer(1000 * 60 * 90);\n-\teim.schedule(\"timeOut\", 1000 * 60 * 90);\n-//}\n+function setup(level, lobbyid) {\n+        var eim = em.newInstance(\"Guild\" + lobbyid);\n+        eim.setProperty(\"level\", level);\n+        \n+        eim.setProperty(\"guild\", 0);\n+        eim.setProperty(\"canJoin\", 1);\n+        eim.setProperty(\"statusStg1\", -1);\n+        \n+        eim.getInstanceMap(990000000).resetPQ(level);\n+        eim.getInstanceMap(990000100).resetPQ(level);\n+        eim.getInstanceMap(990000200).resetPQ(level);\n+        eim.getInstanceMap(990000300).resetPQ(level);\n+        eim.getInstanceMap(990000301).resetPQ(level);\n+        eim.getInstanceMap(990000400).resetPQ(level);\n+        eim.getInstanceMap(990000401).resetPQ(level);\n+        eim.getInstanceMap(990000410).resetPQ(level);\n+        eim.getInstanceMap(990000420).resetPQ(level);\n+        eim.getInstanceMap(990000430).resetPQ(level);\n+        eim.getInstanceMap(990000431).resetPQ(level);\n+        eim.getInstanceMap(990000440).resetPQ(level);\n+        eim.getInstanceMap(990000500).resetPQ(level);\n+        eim.getInstanceMap(990000501).resetPQ(level);\n+        eim.getInstanceMap(990000502).resetPQ(level);\n+        eim.getInstanceMap(990000600).resetPQ(level);\n+        eim.getInstanceMap(990000610).resetPQ(level);\n+        eim.getInstanceMap(990000611).resetPQ(level);\n+        eim.getInstanceMap(990000620).resetPQ(level);\n+        eim.getInstanceMap(990000630).resetPQ(level);\n+        eim.getInstanceMap(990000631).resetPQ(level);\n+        eim.getInstanceMap(990000640).resetPQ(level);\n+        eim.getInstanceMap(990000641).resetPQ(level);\n+        eim.getInstanceMap(990000700).resetPQ(level);\n+        eim.getInstanceMap(990000800).resetPQ(level);\n+        eim.getInstanceMap(990000900).resetPQ(level);\n+        eim.getInstanceMap(990001000).resetPQ(level);\n+        eim.getInstanceMap(990001100).resetPQ(level);\n+        eim.getInstanceMap(990001101).resetPQ(level);\n+        \n+        respawnStages(eim);\n+        \n+        var ts = Date.now();\n+        ts += (60000 * waitTime);\n+        eim.setProperty(\"entryTimestamp\", \"\" + ts);\n+        \n+        eim.startEventTimer(waitTime * 60000);    \n+        \n+        setEventRewards(eim);\n+        setEventExclusives(eim);\n+        \n+        return eim;\n }\n \n-function afterSetup(eim) {}\n+/*\n+function isTeamAllJobs(eim) {\n+        var eventJobs = eim.getEventPlayersJobs();\n+        var rangeJobs = parseInt('111110', 2);\n+        \n+        return ((eventJobs & rangeJobs) == rangeJobs);\n+}\n+*/\n \n-function timeOut(eim) {\n-\tend(eim, \"Your allotted time to finish the quest has passed.\");\n+function afterSetup(eim) {\n+        eim.setProperty(\"guild\", \"\" + eim.getLeader().getGuildId());\n }\n \n+function respawnStages(eim) {}\n+\n function playerEntry(eim, player) {\n-    var map = eim.getMapInstance(990000000);\n-    player.changeMap(map, map.getPortal(0));\n+        var map = eim.getMapInstance(entryMap);\n+        player.changeMap(map, map.getPortal(0));\n+        \n+        var texttt = \"So, here is the brief. You guys should be warned that, once out on the fortress outskirts, anyone that would not be equipping the #b#t1032033##k will die instantly due to the deteriorated state of the air around there. That being said, once your team move out to the next stage, make sure to #bhit the glowing rocks#k in that region and #bequip the dropped item#k before advancing stages. That will protect you thoroughly from the air sickness. Good luck!\";\n+        player.getClient().getSession().write(Packages.tools.MaplePacketCreator.getNPCTalk(9040000, /*(byte)*/ 0, texttt, \"00 00\", /*(byte)*/ 0));\n }\n \n-function playerRevive(eim, player) {\n-    var returnMap = 990000200;\n-    if (eim.getProperty(\"canEnter\").equals(\"true\")) {\n-        returnMap = 990000000;\n-    }\n-    player.setHp(50);\n-    player.setStance(0);\n-    player.changeMap(eim.getMapInstance(returnMap), eim.getMapInstance(returnMap).getPortal(0));\n-    return false;\n+function scheduledTimeout(eim) {\n+        if(eim.getIntProperty(\"canJoin\") == 1) {\n+                eim.setProperty(\"canJoin\", 0);\n+    \n+                if(eim.checkEventTeamLacking(true, minPlayers)) {\n+                        end(eim);\n+                } else {\n+                        eim.startEventTimer(eventTime * 60000);\n+                }\n+        } else {\n+                end(eim);\n+        }\n }\n \n-function playerDead(eim, player) {\n+function playerUnregistered(eim, player) {}\n+\n+function playerExit(eim, player) {\n+        eim.unregisterPlayer(player);\n+        player.changeMap(exitMap, 0);\n }\n \n-function playerDisconnected(eim, player) {\n-    var party = eim.getPlayers();\n-    if (player.getName().equals(eim.getProperty(\"leader\"))) { //check for party leader\n-        //boot all players and end\n-        var iter = party.iterator();\n-        while (iter.hasNext()) {\n-            var pl = iter.next();\n-            pl.dropMessage(6,\"The leader of the instance has disconnected, and the remaining players shall be warped out.\");\n-            if (pl.equals(player)) {\n-                removePlayer(eim, pl);\n-            }\n-            else {\n-                eim.unregisterPlayer(pl);\n-                pl.changeMap(exitMap, exitMap.getPortal(0));\n-            }\n+function changedMap(eim, player, mapid) {\n+        if (mapid < minMapId || mapid > maxMapId) {\n+                if (eim.isEventTeamLackingNow(true, minPlayers, player) && eim.getIntProperty(\"canJoin\") == 0) {\n+                        eim.unregisterPlayer(player);\n+                        end(eim);\n+                }\n+                else\n+                        eim.unregisterPlayer(player);\n         }\n-        eim.dispose();\n-    }\n-    else { //boot d/ced player and check if enough players left\n-        removePlayer(eim, player);\n-        if (party.size() < 6) { //five after player booted\n-            end(eim,\"There are no longer enough players to continue, and those remaining shall be warped out.\");\n+}\n+\n+function changedLeader(eim, leader) {}\n+\n+function playerDead(eim, player) {}\n+\n+function playerRevive(eim, player) { // player presses ok on the death pop up.\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player) && eim.getIntProperty(\"canJoin\") == 0) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n         }\n-    }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n-function leftParty(eim, player) { //ignore for GQ\n+function playerDisconnected(eim, player) {\n+        if (eim.isEventTeamLackingNow(true, minPlayers, player) && eim.getIntProperty(\"canJoin\") == 0) {\n+                eim.unregisterPlayer(player);\n+                end(eim);\n+        }\n+        else\n+                eim.unregisterPlayer(player);\n }\n \n-function disbandParty(eim) { //ignore for GQ\n+function leftParty(eim, player) {}\n+\n+function disbandParty(eim) {\n+        end(eim);\n }\n \n-function playerUnregistered(eim, player) {}\n+function monsterValue(eim, mobId) {\n+        return 1;\n+}\n \n-function playerExit(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.changeMap(exitMap, exitMap.getPortal(0));\n-    var party = eim.getPlayers();\n-    if (party.size() < 6) { //five after player booted\n-        end(eim,\"There are no longer enough players to continue, and those remaining shall be warped out.\");\n-    }\n-}\n-\n-function end(eim, msg) {\n-    var iter = eim.getPlayers().iterator();\n-    while (iter.hasNext()) {\n-        var player = iter.next();\n-        player.dropMessage(6,msg);\n-        eim.unregisterPlayer(player);\n-        player.changeMap(exitMap, exitMap.getPortal(0));\n-    }\n-    eim.dispose();\n+function end(eim) {\n+        var party = eim.getPlayers();\n+        for (var i = 0; i < party.size(); i++) {\n+                playerExit(eim, party.get(i));\n+        }\n+        eim.dispose();\n }\n \n-//for offline players\n-function removePlayer(eim, player) {\n-    eim.unregisterPlayer(player);\n-    player.getMap().removePlayer(player);\n-    player.setMap(exitMap);\n+function giveRandomEventReward(eim, player) {\n+        eim.giveEventReward(player);\n }\n \n function clearPQ(eim) {\n-    var iter = eim.getPlayers().iterator();\n-    var bonusMap = eim.getMapInstance(990001000);\n-\teim.startEventTimer(40000);\n-    while (iter.hasNext()) {\n-        var player = iter.next();\n-        player.changeMap(bonusMap, bonusMap.getPortal(0));\n-    }\n-    eim.schedule(\"finish\", 40000)\n-}\n-\n-function finish(eim) {\n-    var iter = eim.getPlayers().iterator();\n-    while (iter.hasNext()) {\n-        var player = iter.next();\n-        eim.unregisterPlayer(player);\n-        player.changeMap(exitMap, exitMap.getPortal(0));\n-    }\n-    eim.dispose();\n+        eim.stopEventTimer();\n+        eim.setEventCleared();\n }\n \n function monsterKilled(mob, eim) {}\n \n function allMonstersDead(eim) {}\n \n-function cancelSchedule() {\n-}\n+function cancelSchedule() {}\n \n function dispose(eim) {\n-\tem.schedule(\"openGPQ\", 5000);\n+        em.schedule(\"reopenGuildQuest\", em.getLobbyDelay() * 1.5 * 1000);\n }\n \n-function openGPQ() {\n-\tem.setProperty(\"gpqOpen\", \"true\");\n-}\n-\n-\n-function timeOut() {\n-\t\n+function reopenGuildQuest() {\n+        em.attemptStartGuildInstance();\n }\n\\ No newline at end of file"}, {"sha": "267d13f62a8b707621805748847fdd9fc3c24e5c", "filename": "scripts/event/KerningTrain.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/event/KerningTrain.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/event/KerningTrain.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/event/KerningTrain.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -46,6 +46,6 @@ function playerDisconnected(eim, player) {\n \n function cancelSchedule() {}\n \n-function dispose() {\n-    em.cancelSchedule();\n+function dispose(eim) {\n+    eim.cancelSchedule();\n }\n\\ No newline at end of file"}, {"sha": "7cb7b9842149e5671d64363bd1f50781f8a364fa", "filename": "scripts/npc/1012113.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/1012113.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/1012113.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1012113.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -38,7 +38,7 @@ function action(mode, type, selection) {\n                         if (status == 0) {\n                                 cm.sendNext(\"Hello, there! I'm Tommy. There's a Pig Town nearby where we're standing. The pigs there are rowdy and uncontrollable to the point where they have stolen numerous weapons from travelers. They were kicked out from their towns, and are currently hiding out at the Pig Town.\");\n                         } else if (status == 1) {\n-                                if(cm.isLeader()) {\n+                                if(cm.isEventLeader()) {\n                                         cm.sendYesNo(\"What do you think about making your way there with your party members and teach those rowdy pigs a lesson?\");\n                                 }\n                                 else {"}, {"sha": "bb2ddce7d724bc01d8a831c44af78797b59ad2bc", "filename": "scripts/npc/1012114.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/1012114.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/1012114.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1012114.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -35,7 +35,7 @@ function action(mode, type, selection) {\n                         status++;\n                     \n                 if (status == 0) {\n-                        if (cm.isLeader()) {\n+                        if (cm.isEventLeader()) {\n                                 cm.sendSimple(\"Growl! I am Growlie, always ready to protect this place. What brought you here?\\r\\n#b#L0# Please tell me what this place is all about.#l\\r\\n#L1# I have brought #t4001101#.#l\\r\\n#L2# I would like to leave this place.#l\");\n                         } else {\n                                 cm.sendSimple(\"Growl! I am Growlie, always ready to protect this place. What brought you here?\\r\\n#b#L0# Please tell me what this place is all about.#l\\r\\n#L2# I would like to leave this place.#l\");"}, {"sha": "83c00da76ad203e82eed1b8b2908b5b47f1c58bd", "filename": "scripts/npc/2013001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2013001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2013001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2013001.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -44,7 +44,7 @@ function action(mode, type, selection) {\n             cm.dispose();\n             return;\n         }\n-        if (!cm.isLeader()) {\n+        if (!cm.isEventLeader()) {\n             if(cm.getPlayer().getMapId() == 920010000) {\n                 cm.warp(920010000, 2);\n                 cm.dispose();"}, {"sha": "c9136d6dd539cb160cfce8d07ab4b2d023278943", "filename": "scripts/npc/2040036.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040036.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040036.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040036.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "50862dc9f0b4eeb7892ef21a89c300a84b900df8", "filename": "scripts/npc/2040037.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040037.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040037.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040037.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "bd88e83484f8dc58b1b50794d63ed6f5f6153c0e", "filename": "scripts/npc/2040038.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040038.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040038.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040038.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "fc3d6818aa3f452e9f3d3fbe702168bcea451f2f", "filename": "scripts/npc/2040039.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040039.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040039.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040039.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "a5a0fcd78648d76da7829a83682de9e0f74ed449", "filename": "scripts/npc/2040040.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040040.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040040.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040040.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -64,7 +64,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "5eb82c680301234d1ef7ab52dde7b9f6083cae39", "filename": "scripts/npc/2040042.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040042.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040042.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040042.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -67,7 +67,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "32d2610c397cfcd1fcfa8717ecdd2101853dceec", "filename": "scripts/npc/2040043.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040043.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040043.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040043.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -89,7 +89,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "28a96baeb5a56a474e3412f99960fa935ecc22bd", "filename": "scripts/npc/2040044.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040044.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2040044.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2040044.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -58,7 +58,7 @@ function action(mode, type, selection) {\n                         cm.sendNext(\"Hurry, goto the next stage, the portal is open!\");\n                 }\n                 else {\n-                        if (eim.isLeader(cm.getPlayer())) {\n+                        if (eim.isEventLeader(cm.getPlayer())) {\n                                 var state = eim.getIntProperty(\"statusStg\" + stage);\n \n                                 if(state == -1) {           // preamble"}, {"sha": "358f2332f48324026ee2e38381c6156a68312eca", "filename": "scripts/npc/2094001.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2094001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2094001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2094001.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -43,7 +43,7 @@ function action(mode, type, selection) {\n                     \n                 if(cm.getMapId() == 925100500) {\n                         if (status == 0) {\n-                                if(cm.isLeader()) {\n+                                if(cm.isEventLeader()) {\n                                         cm.sendOk(\"I have been saved thanks to your efforts! Thank you, guys!\");\n                                 }\n                                 else {"}, {"sha": "97fad6864140c303cac28da74fc7a376ade8d9fc", "filename": "scripts/npc/2094002.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2094002.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/2094002.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2094002.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -22,7 +22,7 @@ function action(mode, type, selection) {\n         return;\n     }\n     \n-    if (!cm.isLeader()) {\n+    if (!cm.isEventLeader()) {\n \tcm.sendYesNo(\"I wish for your leader to talk to me. Alternatively, you may be wanting to quit. Are you going to abandon this campaign?\");\n     }\n     else {"}, {"sha": "8ca5cc7821c8a395c625dc27921899378fad6f2a", "filename": "scripts/npc/9000037.js", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9000037.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9000037.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9000037.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -65,15 +65,15 @@ function action(mode, type, selection) {\n                                         cm.getEventInstance().setProperty(\"clear\", \"true\");\n                                 }\n                             \n-                                if(cm.isLeader()) {\n+                                if(cm.isEventLeader()) {\n                                         cm.sendOk(\"Your party completed such an astounding feat coming this far, #byou have defeated all the bosses#k, congratulations! Now I will be handing your reward as you are being transported out...\");\n                                 }\n                                 else {\n                                         cm.sendOk(\"For #bdefeating all bosses#k in this event, congratulations! You will now receive a prize that matches your performance here as I warp you out.\");\n                                 }\n                         }\n                         else if(state == 2) {\n-                                if(cm.isLeader()) {\n+                                if(cm.isEventLeader()) {\n                                         if(cm.getPlayer().getEventInstance().isEventTeamTogether()) {\n                                                 cm.sendYesNo(\"Is your party ready to proceed to the next stages? Walk through the portal if you think you're done, the time is now.. Now, do you guys REALLY want to proceed?\");\n                                         }\n@@ -126,7 +126,7 @@ function action(mode, type, selection) {\n                                         if (cm.getParty() == null) {\n                                                 cm.sendOk(\"You can participate in the party quest only if you are in a party.\");\n                                                 cm.dispose();\n-                                        } else if(!cm.isLeader()) {\n+                                        } else if(!cm.isEventLeader()) {\n                                                 cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                                 cm.dispose();\n                                         } else {"}, {"sha": "ca6204f1a184518e8542064fa9021ee334538f57", "filename": "scripts/npc/9020000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9020000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9020000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9020000.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -51,7 +51,7 @@ function action(mode, type, selection) {\n                                         if (cm.getParty() == null) {\n                                                 cm.sendOk(\"You can participate in the party quest only if you are in a party.\");\n                                                 cm.dispose();\n-                                        } else if(!cm.isLeader()) {\n+                                        } else if(!cm.isEventLeader()) {\n                                                 cm.sendOk(\"Your party leader must talk to me to start this party quest.\");\n                                                 cm.dispose();\n                                         } else {"}, {"sha": "55a6826e46967ecd24e2abd65c44575fad08f42b", "filename": "scripts/npc/9020001.js", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9020001.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9020001.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9020001.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -136,7 +136,7 @@ function action(mode, type, selection) {\n                                 }\n                         }\n                         else if(curMap == 103000800) {   // stage 1\n-                                if(cm.isLeader()) {\n+                                if(cm.isEventLeader()) {\n                                         var numpasses = eim.getPlayerCount() - 1;     // minus leader\n \n                                         if(cm.hasItem(4001008, numpasses)) {\n@@ -184,7 +184,7 @@ function action(mode, type, selection) {\n                                 var nthtext = \"2nd\", nthobj = \"ropes\", nthverb = \"hang\", nthpos = \"hang on the ropes too low\";\n                                 var nextStgId = 103000802;\n \n-                                if(!eim.isLeader(cm.getPlayer())) {\n+                                if(!eim.isEventLeader(cm.getPlayer())) {\n                                         cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n                                 }\n                                 else if(eim.getProperty(stgProperty) == null) {\n@@ -214,7 +214,7 @@ function action(mode, type, selection) {\n                                 var nthtext = \"3rd\", nthobj = \"platforms\", nthverb = \"stand\", nthpos = \"stand too close to the edges\";\n                                 var nextStgId = 103000803;\n \n-                                if(!eim.isLeader(cm.getPlayer())) {\n+                                if(!eim.isEventLeader(cm.getPlayer())) {\n                                         cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n                                 }\n                                 else if(eim.getProperty(stgProperty) == null) {\n@@ -244,7 +244,7 @@ function action(mode, type, selection) {\n                                 var nthtext = \"4th\", nthobj = \"barrels\", nthverb = \"stand\", nthpos = \"stand too close to the edges\";\n                                 var nextStgId = 103000804;\n \n-                                if(!eim.isLeader(cm.getPlayer())) {\n+                                if(!eim.isEventLeader(cm.getPlayer())) {\n                                         cm.sendOk(\"Follow the instructions given by your party leader to proceed through this stage.\");\n                                 }\n                                 else if(eim.getProperty(stgProperty) == null) {\n@@ -267,7 +267,7 @@ function action(mode, type, selection) {\n \n                                 cm.dispose();\n                         } else if(curMap == 103000804) {\n-                                if (eim.isLeader(cm.getPlayer())) {\n+                                if (eim.isEventLeader(cm.getPlayer())) {\n                                         if (cm.haveItem(4001008, 10)) {\n                                                 cm.sendNext(\"Here's the portal that leads you to the last, bonus stage. It's a stage that allows you to defeat regular monsters a little easier. You'll be given a set amount of time to hunt as much as possible, but you can always leave the stage in the middle of it through the NPC. Again, congratulations on clearing all the stages. Let your party talk to me to receive their prizes as they are allowed to pass to the bonus stage. Take care...\");\n                                                 cm.gainItem(4001008, -10);"}, {"sha": "765f988852aeac5acfb0e06aac0b5bb02c19562d", "filename": "scripts/npc/9040000.js", "status": "modified", "additions": 92, "deletions": 108, "changes": 200, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9040000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9040000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9040000.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1,122 +1,106 @@\n-/*\n-\tThis file is part of the OdinMS Maple Story Server\n-    Copyright (C) 2008 Patrick Huy <patrick.huy@frz.cc>\n-\t\t       Matthias Butz <matze@odinms.de>\n-\t\t       Jan Christian Meyer <vimes@odinms.de>\n-\n-    This program is free software: you can redistribute it and/or modify\n-    it under the terms of the GNU Affero General Public License as\n-    published by the Free Software Foundation version 3 as published by\n-    the Free Software Foundation. You may not use, modify or distribute\n-    this program under any other version of the GNU Affero General Public\n-    License.\n-\n-    This program is distributed in the hope that it will be useful,\n-    but WITHOUT ANY WARRANTY; without even the implied warranty of\n-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-    GNU Affero General Public License for more details.\n-\n-    You should have received a copy of the GNU Affero General Public License\n-    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n-*/\n-/* \n-* @Author Lerk\n-* \n-* Shuang, Victoria Road: Excavation Site<Camp> (101030104)\n-* \n-* Start of Guild Quest\n+/**\n+ * @author: Ronan\n+ * @npc: Shuang\n+ * @map: Victoria Road: Excavation Site<Camp> (101030104)\n+ * @func: Start Guild PQ\n */\n \n var status = 0;\n-var GQItems = new Array(1032033, 4001024, 4001025, 4001026, 4001027, 4001028, 4001029, 4001030, 4001031, 4001032, 4001033, 4001034, 4001035, 4001037);\n+var sel;\n+var em = null;\n+\n+function findLobby(guild) {\n+        for (var iterator = em.getInstances().iterator(); iterator.hasNext();) {\n+                var lobby = iterator.next();\n+                \n+                if(lobby.getIntProperty(\"guild\") == guild) {\n+                        if(lobby.getIntProperty(\"canJoin\") == 1) return lobby;\n+                        else return null;\n+                }\n+        }\n+        \n+        return null;\n+}\n \n function start() {\n-    cm.sendSimple(\"The path to Sharenian starts here. What would you like to do? #b\\r\\n#L0#Start a Guild Quest#l\\r\\n#L1#Join your guild's Guild Quest#l\");\n+\tstatus = -1;\n+\taction(1, 0, 0);\n }\n \n function action(mode, type, selection) {\n-    if (mode == -1) \n-        cm.dispose();\n-    else {\n-        if (mode == 0 && status == 0) {\n-            cm.dispose();\n-            return;\n-        }\n-        if (mode == 1)\n-            status++;\n-        else\n-            status--;\n-        if (status == 1) {\n-            if (selection == 0) { //Start\n-\t\t\t\tif (cm.getPlayer().getGuildId() == 0 || cm.getPlayer().getGuildRank() >= 3) { //no guild or not guild master/jr. master\n-                    cm.sendNext(\"Only a Master or Jr. Master of the guild can start an instance.\");\n-                    cm.dispose();\n+        if (mode == -1) {\n+                cm.dispose();\n+        } else {\n+                if (mode == 0 && status == 0) {\n+                        cm.dispose();\n+                        return;\n                 }\n-                else {\n-                    var em = cm.getEventManager(\"GuildQuest\");\n-                    if (em == null) \n-                        cm.sendOk(\"This trial is currently under construction.\");\n-                    else {\n-\t\t\t\t\t\tif(em.getProperty(\"gpqOpen\").equals(\"false\")) {\n-\t\t\t\t\t\t\tcm.sendOk(\"Another guild has already registered for the quest. Please try again later.\");\n-                        } else if (getEimForGuild(em, cm.getPlayer().getGuildId()) != null) \n-                            cm.sendOk(\"Your guild already is already registered.\");\n-                        else {\n-                            var guildId = cm.getPlayer().getGuildId();\n-                            var eim = em.newInstance(guildId);\n-                            em.startInstance(eim, cm.getPlayer().getName());\n-\t\t\t\t\t\t\tem.setProperty(\"gpqOpen\", \"false\");\n-                            var map = eim.getMapInstance(990000000);\n-                            map.getPortal(5).setScriptName(\"guildwaitingenter\");\n-                            map.getPortal(4).setScriptName(\"guildwaitingexit\");\n-                            eim.registerPlayer(cm.getPlayer());\n-                            cm.guildMessage(5, \"The guild has been entered into the Guild Quest. Please report to Shuang at the Excavation Camp on channel \" + cm.getClient().getChannel() + \".\");\n-                            for (var i = 0; i < GQItems.length; i++) \n-                                cm.removeAll(GQItems[i]);\n+                if (mode == 1)\n+                        status++;\n+                else\n+                        status--;\n+                \n+                if (status == 0) {\n+                        em = cm.getEventManager(\"GuildQuest\");\n+                        if(em == null) {\n+                                cm.sendOk(\"The Guild Quest has encountered an error.\");\n+                                cm.dispose();\n+                                return;\n                         }\n-                    }\n-                    cm.dispose();\n-                }\n-            }\n-            else if (selection == 1) { //entering existing GQ\n-                if (cm.getPlayer().getGuildId() == 0) { //no guild or not guild master/jr. master\n-                    cm.sendNext(\"You must be in a guild to join an instance.\");\n-                    cm.dispose();\n-                }\n-                else {\n-                    var em = cm.getEventManager(\"GuildQuest\");\n-                    if (em == null)\n-                        cm.sendOk(\"This trial is currently under construction.\");\n-                    else {\n-                        var eim = getEimForGuild(em, cm.getPlayer().getGuildId());\n-                        if (eim == null) \n-                            cm.sendOk(\"Your guild is currently not registered for the Guild Quest.\");\n-                        else {\n-                            if (\"true\".equals(eim.getProperty(\"canEnter\"))) {\n-                                eim.registerPlayer(cm.getPlayer());\n-                                for (var i = 0; i < GQItems.length; i++)\n-                                    cm.removeAll(GQItems[i]);\n-                            }\n-                            else \n-                                cm.sendOk(\"I'm sorry, but the guild has gone on without you. Try again later.\");\n+                    \n+                        cm.sendSimple(\"#e#b<Guild Quest: Sharenian Ruins>\\r\\n#k#n\" + em.getProperty(\"party\") + \"\\r\\n\\r\\nThe path to Sharenian starts here. What would you like to do? #b\\r\\n#L0#Register your guild for Guild Quest#l\\r\\n#L1#Join your guild's Guild Quest#l\\r\\n#L2#I would like to hear more details.#l\");\n+                } else if (status == 1) {\n+                        sel = selection;\n+                        if (selection == 0) {\n+                                if(!cm.isGuildLeader()) {\n+                                        cm.sendOk(\"Your guild master/jr.master must talk to me to register this guild quest.\");\n+                                        cm.dispose();\n+                                } else {\n+                                        if(em.isQueueFull()) {\n+                                                cm.sendOk(\"The queue on this channel is already full. Please be patient and try again after a while, or try on another channel.\");\n+                                                cm.dispose();\n+                                        } else {\n+                                                var qsize = em.getQueueSize();\n+                                                cm.sendYesNo(((qsize > 0) ? \"There is currently #r\" + qsize + \"#k guilds queued on. \" : \"\") + \"Do you wish for your guild to join this queue?\");\n+                                        }\n+                                }\n+                        } else if (selection == 1) {\n+                                if(cm.getPlayer().getGuildId() > 0) {\n+                                        var eim = findLobby(cm.getPlayer().getGuildId());\n+                                        if(eim == null) {\n+                                                cm.sendOk(\"You don't have a guild registered and currently on strategy time to assist on this channel.\");\n+                                        } else {\n+                                                if(cm.isLeader()) {\n+                                                        em.getEligibleParty(cm.getParty());\n+                                                        eim.registerParty(cm.getPlayer());\n+                                                } else {\n+                                                        eim.registerPlayer(cm.getPlayer());\n+                                                }\n+                                        }\n+                                } else {\n+                                        cm.sendOk(\"You can't participate in the guild quest if you don't pertain on a guild yourself!\");\n+                                }\n+                                \n+                                cm.dispose();\n+                        } else {\n+                                cm.sendOk(\"#e#b<Guild Quest: Sharenian Ruins>#k#n\\r\\n Team up with your guild members in an auspicious attempt to recover the Rubian from the skeleton's grasp, with teamwork overcoming many puzzles and challenges awaiting inside the Sharenian tombs. Great rewards can be obtained upon the instance completion, and Guild Points can be racked up for your Guild.\");\n+                                cm.dispose();\n+                        }\n+                } else if (status == 2) {\n+                        if (sel == 0) {\n+                                var entry = em.addGuildToQueue(cm.getPlayer().getGuildId(), cm.getPlayer().getId());\n+                                if(entry > 0) {\n+                                        if(entry == 1) {\n+                                                cm.sendOk(\"Your guild has been registered successfully. A message will pop on your chat keeping your guild aware about the registration status. Now, #rimportant#k: as the leader of this instance, #ryou must already be present on this channel#k the right moment your guild is called for the strategy time. #bThe missubmission of this action will void#k your guild registration as a whole, and the next guild will be called immediately. Must be noted also, that if you become absent from the end of the strategy time to any point on the duration of the instance, it will render the instance interrupted, and your guild will be moved out instantly, moving again the queue.\");\n+                                        }\n+                                } else if(entry == 0) {\n+                                        cm.sendOk(\"The queue on this channel is already full. Please be patient and try again after a while, or try on another channel.\");\n+                                } else {\n+                                        cm.sendOk(\"Your guild is already queued on a channel. Please wait for your guild's turn.\");\n+                                }\n                         }\n-                    }\n-                    cm.dispose();\n+                        \n+                        cm.dispose();\n                 }\n-            }\n         }\n-    }\n-}\n-\n-function getEimForGuild(em, id) {\n-    var stringId = \"\" + id;\n-    return em.getInstance(stringId);\n-}\n-\n-function isGuildQuestOwner(em, id) {\n-\tvar stringId = \"\" + id;\n-\tif(em.getProperty(\"curGuild\").equals(stringId))\n-\t\treturn true;\n-\t\t\n-\treturn false;\n }\n\\ No newline at end of file"}, {"sha": "dde1a4e58fd10ecbe32dda12f67f7cd0305832ab", "filename": "scripts/npc/9103000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9103000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/npc/9103000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9103000.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -51,7 +51,7 @@ function action(mode, type, selection) {\n                         status--;\n                 \n                 if (status == 0) {\n-                        if(cm.isLeader()) {\n+                        if(cm.isEventLeader()) {\n                                 if(!cm.getEventInstance().isEventTeamTogether()) {\n                                         cm.sendOk(\"One or more event team members is missing, please wait for them to reach here first.\");\n                                         cm.dispose();"}, {"sha": "634af77734a980bc082cedfa830e6001fa07b773", "filename": "scripts/portal/guildwaitingenter.js", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/guildwaitingenter.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/guildwaitingenter.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/guildwaitingenter.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -19,24 +19,23 @@\n     You should have received a copy of the GNU Affero General Public License\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n-/* @Author Lerk\n+/* @Author Lerk, Ronan\n  * \n  * Guild Quest Waiting Room - Entry Portal (map 990000000)\n  */\n \n function enter(pi) {\n-    if (pi.getPlayer().getEventInstance() == null) {\n-        pi.warp(101030104);\n-        return true;\n-    }\n-    else {\n-        if (pi.getPlayer().getEventInstance().getProperty(\"canEnter\").equals(\"false\")) {\n+        var entryTime = pi.getPlayer().getEventInstance().getProperty(\"entryTimestamp\");\n+        var timeNow = Date.now();\n+    \n+        var timeLeft = Math.ceil((entryTime - timeNow) / 1000);\n+    \n+        if(timeLeft <= 0) {\n             pi.warp(990000100);\n             return true;\n         }\n         else { //cannot proceed while allies can still enter\n-            pi.playerMessage(5, \"The portal is not open yet.\");\n+            pi.playerMessage(5, \"The portal will open in about \" + timeLeft + \" seconds.\");\n             return false;\n         }\n-    }\n }\n\\ No newline at end of file"}, {"sha": "6393214b2bd1b8400575e2fc32e760b534923a3e", "filename": "scripts/portal/guildwaitingexit.js", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/guildwaitingexit.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/guildwaitingexit.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/guildwaitingexit.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -20,8 +20,6 @@\n     along with this program.  If not, see <http://www.gnu.org/licenses/>.\n */\n function enter(pi) {\n-        if (pi.getPlayer().getEventInstance() != null) {\n-                pi.getPlayer().getEventInstance().removePlayer(pi.getPlayer());\n-        }\n+        pi.warp(101030104);\n         return true;\n }\n\\ No newline at end of file"}, {"sha": "4ab499afd00052e746e924ad8ddc79ef3361670b", "filename": "scripts/portal/party3_gardenin.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/party3_gardenin.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/party3_gardenin.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/party3_gardenin.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1,5 +1,5 @@\n function enter(pi) {\n-\tif (pi.getPlayer().getParty() != null && pi.isLeader() && pi.haveItem(4001055,1)) {\n+\tif (pi.getPlayer().getParty() != null && pi.isEventLeader() && pi.haveItem(4001055,1)) {\n                 pi.getEventInstance().warpEventTeam(920010100);\n                 return true;\n \t} else {"}, {"sha": "df3231fe5ec91d509f5c071cc4a6529cd259db66", "filename": "scripts/portal/party6_out.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/party6_out.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/party6_out.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/party6_out.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1,6 +1,6 @@\n function enter(pi) {\n         if ((pi.getMap().getMonsters().size() == 0 || pi.getMap().getMonsterById(9300183) != null) && (pi.getMap().getReactorByName(\"\") == null || pi.getMap().getReactorByName(\"\").getState() == 1)) {\n-                if(pi.isLeader()) {\n+                if(pi.isEventLeader()) {\n                         pi.getEventInstance().clearPQ();\n                         return true;\n                 }"}, {"sha": "2a49b8ca9dbb8c2f3a2724d91a51bb450c89a0b6", "filename": "scripts/portal/raid_rest.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/raid_rest.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/scripts/portal/raid_rest.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/portal/raid_rest.js?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -27,7 +27,7 @@ BossRushPQ - Rest Spot portal\n function enter(pi) {\n         var evLevel = ((pi.getMapId() - 1) % 5) + 1;\n         \n-        if(pi.getPlayer().getEventInstance().isLeader(pi.getPlayer()) && pi.getPlayer().getEventInstance().getPlayerCount() > 1) {\n+        if(pi.getPlayer().getEventInstance().isEventLeader(pi.getPlayer()) && pi.getPlayer().getEventInstance().getPlayerCount() > 1) {\n                 pi.message(\"Being the party leader, you cannot leave before your teammates leave first or you pass leadership.\");\n                 return false;\n         }"}, {"sha": "f8681890b28bb2e23055dd972b630cfb69f1c96d", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1124,7 +1124,14 @@ private void eventChangedMap(int map) {\n     }\n \n     public void changeMap(int map) {\n-        changeMap(map, 0);\n+        MapleMap warpMap;\n+        if (getEventInstance() != null) {\n+            warpMap = getEventInstance().getMapInstance(map);\n+        } else {\n+            warpMap = client.getChannelServer().getMapFactory().getMap(map);\n+        }\n+        \n+        changeMap(warpMap, warpMap.getRandomPlayerSpawnpoint());\n     }\n \n     public void changeMap(int map, int portal) {\n@@ -3343,6 +3350,10 @@ public boolean isMapObjectVisible(MapleMapObject mo) {\n     public boolean isPartyLeader() {\n         return party.getLeaderId() == getId();\n     }\n+    \n+    public boolean isGuildLeader() {    // true on guild master or jr. master\n+        return guildid > 0 && guildRank < 3;\n+    }\n \n     public void leaveMap() {\n         controlled.clear();"}, {"sha": "40919b2763c2034b71515cf3c018d87ec4afb527", "filename": "src/client/command/Commands.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/client/command/Commands.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/client/command/Commands.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/Commands.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -684,15 +684,15 @@ public static boolean executePlayerCommand(MapleClient c, String[] sub, char hea\n                 case \"debugnearestportal\":\n                         if(ServerConstants.USE_DEBUG) {\n                             MaplePortal portal = player.getMap().findClosestPortal(player.getPosition());\n-                            if(portal != null) player.dropMessage(6, \"Closest portal: \" + portal.getId() + \" '\" + portal.getName() + \"' --> toMap: \" + portal.getTargetMapId() + \" scriptname: '\" + portal.getScriptName() + \"' state: \" + portal.getPortalState() + \".\");\n+                            if(portal != null) player.dropMessage(6, \"Closest portal: \" + portal.getId() + \" '\" + portal.getName() + \"' Type: \" + portal.getType() + \" --> toMap: \" + portal.getTargetMapId() + \" scriptname: '\" + portal.getScriptName() + \"' state: \" + portal.getPortalState() + \".\");\n                             else player.dropMessage(6, \"There is no portal on this map.\");\n                         }\n                         break;\n                 \n                 case \"debugnearestspawnpoint\":\n                         if(ServerConstants.USE_DEBUG) {\n                             SpawnPoint sp = player.getMap().findClosestSpawnpoint(player.getPosition());\n-                            if(sp != null) player.dropMessage(6, \"Closest spawn point: \" + \" Position: x \" + sp.getPosition().getX() + \" y \" + sp.getPosition().getY() + \" Spawns mobid: '\" + ((sp.getMonster() != null) ? sp.getMonster().getId() : \"null\") + \"' --> canSpawn: \" + !sp.getDenySpawn() + \" canSpawnRightNow: \" + sp.shouldSpawn() + \".\");\n+                            if(sp != null) player.dropMessage(6, \"Closest mob spawn point: \" + \" Position: x \" + sp.getPosition().getX() + \" y \" + sp.getPosition().getY() + \" Spawns mobid: '\" + ((sp.getMonster() != null) ? sp.getMonster().getId() : \"null\") + \"' --> canSpawn: \" + !sp.getDenySpawn() + \" canSpawnRightNow: \" + sp.shouldSpawn() + \".\");\n                             else player.dropMessage(6, \"There is no mob spawn point on this map.\");\n                         }\n                         break;"}, {"sha": "05f6930d2b57f36febeeb440ea9f267cc87e035e", "filename": "src/net/server/PlayerStorage.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/PlayerStorage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/PlayerStorage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/PlayerStorage.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -57,7 +57,7 @@ public MapleCharacter removePlayer(int chr) {\n     public MapleCharacter getCharacterByName(String name) {\n         rlock.lock();    \n         try {\n-            for (MapleCharacter chr : storage.values()) {            \n+            for (MapleCharacter chr : storage.values()) {\n                 if (chr.getName().toLowerCase().equals(name.toLowerCase()))\n                     return chr;\n             }"}, {"sha": "0a165a1745266c038c886dd8420c8fac11c14a53", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -296,14 +296,16 @@ public void setServerMessage(String message) {\n     private static String [] getEvents(){\n     \tList<String> events = new ArrayList<String>();\n     \tfor (File file : new File(\"scripts/event\").listFiles()){\n-    \t\tevents.add(file.getName().substring(0, file.getName().length() - 3));\n+            events.add(file.getName().substring(0, file.getName().length() - 3));\n     \t}\n     \treturn events.toArray(new String[0]);\n     }\n \t\n-\tpublic int getStoredVar(int key) {\n-\t\tif(storedVars.containsKey(key))\n+    public int getStoredVar(int key) {\n+        if(storedVars.containsKey(key)) {\n             return storedVars.get(key);\n+        }\n+\n         return 0;\n     }\n     "}, {"sha": "ab0ea7be41ebc8f805d2c51834c09899f70e0ca3", "filename": "src/net/server/channel/handlers/ChangeMapHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/channel/handlers/ChangeMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/channel/handlers/ChangeMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeMapHandler.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -88,7 +88,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\t\t\t\t\tchr.setStance(0);\n \t\t\t\t\t\t}\n \t\t\t\t\t\tchr.setHp(50);\n-\t\t\t\t\t\tchr.changeMap(to, to.getPortal(0));\n+\t\t\t\t\t\tchr.changeMap(to, to.getRandomPlayerSpawnpoint());\n \t\t\t\t\t}\n \t\t\t\t} else if (targetid != -1 && chr.isGM()) {\n \t\t\t\t\tMapleMap to = c.getChannelServer().getMapFactory().getMap(targetid);"}, {"sha": "79800b3a3baf9850c3ea30c3b7da6461161ba42c", "filename": "src/net/server/world/World.java", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/world/World.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/net/server/world/World.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/World.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -37,6 +37,8 @@\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.Set;\n+import java.util.HashSet;\n \n import net.server.PlayerStorage;\n import net.server.Server;\n@@ -65,6 +67,7 @@\n     private Map<Integer, MapleFamily> families = new LinkedHashMap<>();\n     private Map<Integer, MapleGuildSummary> gsStore = new HashMap<>();\n     private PlayerStorage players = new PlayerStorage();\n+    private Set<Integer> queuedGuilds = new HashSet<>();\n \n     public World(int world, int flag, String eventmsg, int exprate, int droprate, int mesorate, int bossdroprate) {\n         this.id = world;\n@@ -300,6 +303,18 @@ public void sendPacket(List<Integer> targetIds, final byte[] packet, int excepti\n         }\n     }\n \n+    public boolean isGuildQueued(int guildId) {\n+        return queuedGuilds.contains(guildId);\n+    }\n+    \n+    public void putGuildQueued(int guildId) {\n+        queuedGuilds.add(guildId);\n+    }\n+    \n+    public void removeGuildQueued(int guildId) {\n+        queuedGuilds.remove(guildId);\n+    }\n+    \n     public MapleParty createParty(MaplePartyCharacter chrfor) {\n         int partyid = runningPartyId.getAndIncrement();\n         MapleParty party = new MapleParty(partyid, chrfor);\n@@ -364,13 +379,14 @@ public void updateParty(int partyid, PartyOperation operation, MaplePartyCharact\n                 party.updateMember(target);\n                 break;\n             case CHANGE_LEADER:\n-                if(party.getLeader().getPlayer().getEventInstance() != null) {\n-                    party.getLeader().getPlayer().getEventInstance().changedLeader(target.getPlayer());\n+                MapleCharacter mc = party.getLeader().getPlayer();\n+                if(mc.getEventInstance() != null && mc.getEventInstance().isEventLeader(mc)) {\n+                    mc.getEventInstance().changedLeader(target.getPlayer());\n                 }\n                 party.setLeader(target);\n                 break;\n             default:\n-                System.out.println(\"Unhandeled updateParty operation \" + operation.name());\n+                System.out.println(\"Unhandled updateParty operation \" + operation.name());\n         }\n         updateParty(party, operation, target);\n     }"}, {"sha": "bec06c78bdf9568da3ea9819f896e22bbc7f7c44", "filename": "src/provider/wz/WZIMGFile.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/provider/wz/WZIMGFile.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/provider/wz/WZIMGFile.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/provider/wz/WZIMGFile.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -221,7 +221,7 @@ private void parseExtended(WZIMGEntry entry, SeekableLittleEndianAccessor slea,\n                     System.out.println(\"Unknown UOL marker: \" + uolmarker + \" \" + entry.getName());\n             }\n         } else {\n-            throw new RuntimeException(\"Unhandeled extended type: \" + type);\n+            throw new RuntimeException(\"Unhandled extended type: \" + type);\n         }\n     }\n }"}, {"sha": "c4714bbb275cabc648efe83008cee73df6e28c14", "filename": "src/scripting/AbstractPlayerInteraction.java", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/AbstractPlayerInteraction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/AbstractPlayerInteraction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/AbstractPlayerInteraction.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -528,13 +528,21 @@ public MapleGuild getGuild() {\n \tpublic MapleParty getParty() {\n \t\treturn getPlayer().getParty();\n \t}\n+        \n+        public boolean isGuildLeader() {\n+                return getPlayer().isGuildLeader();\n+        }\n \n \tpublic boolean isLeader() {\n \t\tif(getParty() == null)\n \t\t\treturn false;\n \t\t\n                 return getParty().getLeaderId() == getPlayer().getId();\n \t}\n+        \n+        public boolean isEventLeader() {\n+\t\treturn getEventInstance() != null && getPlayer().getId() == getEventInstance().getLeaderId();\n+\t}\n \n \tpublic void givePartyItems(int id, short quantity, List<MapleCharacter> party) {\n \t\tfor (MapleCharacter chr : party) {"}, {"sha": "dd4bda2eb4cacc114f1f34ebae7e99b654f39de4", "filename": "src/scripting/event/EventInstanceManager.java", "status": "modified", "additions": 80, "deletions": 30, "changes": 110, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/event/EventInstanceManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/event/EventInstanceManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventInstanceManager.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -31,6 +31,7 @@\n import java.util.Map;\n import java.util.HashSet;\n import java.util.Set;\n+import java.util.Iterator;\n import java.util.Properties;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock.ReadLock;\n@@ -69,7 +70,8 @@\n  * @author Matze, Ronan\n  */\n public class EventInstanceManager {\n-\tprivate List<MapleCharacter> chars = new ArrayList<>();\n+\tprivate Map<Integer, MapleCharacter> chars = new HashMap<>();\n+        private int leaderId = -1;\n \tprivate List<MapleMonster> mobs = new LinkedList<>();\n \tprivate Map<MapleCharacter, Integer> killCount = new HashMap<>();\n \tprivate EventManager em;\n@@ -103,7 +105,7 @@\n         // registers all opened gates on the event. Will help late characters to encounter next stages gates already opened\n         private Set<Integer> openedGates = new HashSet<>();\n         \n-        // forces deletion of items not supposed to be holding out of the event, dealt on a player's leave moment.\n+        // forces deletion of items not supposed to be held outside of the event, dealt on a player's leaving moment.\n         private Set<Integer> exclusiveItems = new HashSet<>();\n         \n \tpublic EventInstanceManager(EventManager em, String name) {\n@@ -209,7 +211,7 @@ public void registerPlayer(MapleCharacter chr) {\n                 try {\n                         wL.lock();\n                         try {\n-                                chars.add(chr);\n+                                chars.put(chr.getId(), chr);\n                         }\n                         finally {\n                                 wL.unlock();\n@@ -238,12 +240,15 @@ public void startEventTimer(long time) {\n                 timeStarted = System.currentTimeMillis();\n \t\teventTime = time;\n                 \n-                for(MapleCharacter chr: getPlayers()) chr.announce(MaplePacketCreator.getClock((int) (time / 1000)));\n+                for(MapleCharacter chr: getPlayers()) {\n+                        chr.announce(MaplePacketCreator.getClock((int) (time / 1000)));\n+                }\n+                \n                 event_schedule = TimerManager.getInstance().schedule(new Runnable() {\n                         public void run() {\n                                 try {\n-                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                         dismissEventTimer();\n+                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n                                 }\n@@ -260,8 +265,8 @@ public void addEventTimer(long time) {\n                                 event_schedule = TimerManager.getInstance().schedule(new Runnable() {\n                                         public void run() {\n                                                 try {\n-                                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                                         dismissEventTimer();\n+                                                        em.getIv().invokeFunction(\"scheduledTimeout\", EventInstanceManager.this);\n                                                 } catch (ScriptException | NoSuchMethodException ex) {\n                                                         Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n                                                 }\n@@ -274,14 +279,6 @@ public void run() {\n                 }\n         }\n         \n-        public void stopEventTimer() {\n-                if(event_schedule != null) {\n-                        event_schedule.cancel(false);\n-                        event_schedule = null;\n-                }\n-                dismissEventTimer();\n-        }\n-        \n         private void dismissEventTimer() {\n                 for(MapleCharacter chr: getPlayers()) {\n                         chr.getClient().getSession().write(MaplePacketCreator.removeClock());\n@@ -292,6 +289,14 @@ private void dismissEventTimer() {\n                 timeStarted = 0;\n         }\n         \n+        public void stopEventTimer() {\n+                if(event_schedule != null) {\n+                        event_schedule.cancel(false);\n+                        event_schedule = null;\n+                }\n+                dismissEventTimer();\n+        }\n+        \n \tpublic boolean isTimerStarted() {\n \t\treturn eventTime > 0 && timeStarted > 0;\n \t}\n@@ -300,6 +305,12 @@ public long getTimeLeft() {\n \t\treturn eventTime - (System.currentTimeMillis() - timeStarted);\n \t}\n \n+        public void registerParty(MapleCharacter chr) {\n+                if(chr.isPartyLeader()) {\n+                        registerParty(chr.getParty(), chr.getMap());\n+                }\n+        }\n+        \n \tpublic void registerParty(MapleParty party, MapleMap map) {\n \t\tfor (MaplePartyCharacter pc : party.getEligibleMembers()) {\n \t\t\tMapleCharacter c = map.getCharacterById(pc.getId());\n@@ -321,7 +332,7 @@ public void unregisterPlayer(MapleCharacter chr) {\n                                 Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n                         }\n                     \n-                        chars.remove(chr);\n+                        chars.remove(chr.getId());\n                         gridRemove(chr);\n                         dropExclusiveItems(chr);\n                 } finally {\n@@ -344,7 +355,7 @@ public int getPlayerCount() {\n \tpublic List<MapleCharacter> getPlayers() {\n                 rL.lock();\n                 try {\n-                        return new ArrayList<>(chars);\n+                        return new ArrayList<>(chars.values());\n                 }\n                 finally {\n                         rL.unlock();\n@@ -354,7 +365,7 @@ public int getPlayerCount() {\n         private List<MapleCharacter> getPlayerList() {\n                 rL.lock();\n                 try {\n-                        return new LinkedList<>(chars);\n+                        return new LinkedList<>(chars.values());\n                 } finally {\n                         rL.unlock();\n                 }\n@@ -478,7 +489,7 @@ public void dispose() {\n \n                 wL.lock();\n                 try {\n-                        for(MapleCharacter chr: chars) chr.setEventInstance(null);\n+                        for(MapleCharacter chr: chars.values()) chr.setEventInstance(null);\n                         chars.clear();\n                         \n                         mobs.clear();\n@@ -612,6 +623,10 @@ public boolean isLeader(MapleCharacter chr) {\n \t\treturn (chr.getParty().getLeaderId() == chr.getId());\n \t}\n         \n+        public boolean isEventLeader(MapleCharacter chr) {\n+\t\treturn (chr.getId() == getLeaderId());\n+\t}\n+        \n         public final MapleMap getInstanceMap(final int mapid) { //gets instance map from the channelserv\n                 if (disposed) {\n                         return getMapFactory().getMap(mapid);\n@@ -829,10 +844,27 @@ public final boolean isEventCleared() {\n                 return eventCleared;\n         }\n         \n+        private boolean isEventTeamLeaderOn() {\n+                for(MapleCharacter chr: getPlayers()) {\n+                        if(chr.getId() == getLeaderId()) return true;\n+                }\n+                \n+                return false;\n+        }\n+        \n+        public final boolean checkEventTeamLacking(boolean testLeader, int minPlayers) {\n+                if(eventCleared && getPlayerCount() > 1) return false;\n+                \n+                if(!eventCleared && testLeader && !isEventTeamLeaderOn()) return true;\n+                if(getPlayerCount() < minPlayers) return true;\n+                \n+                return false;\n+        }\n+        \n         public final boolean isEventTeamLackingNow(boolean testLeader, int minPlayers, MapleCharacter quitter) {\n                 if(eventCleared && getPlayerCount() > 1) return false;\n                 \n-                if(!eventCleared && testLeader && getLeader().getId() == quitter.getId()) return true;\n+                if(!eventCleared && testLeader && getLeaderId() == quitter.getId()) return true;\n                 if(getPlayerCount() <= minPlayers) return true;\n                 \n                 return false;\n@@ -842,12 +874,16 @@ public final boolean isEventTeamTogether() {\n                 rL.lock();\n                 try {\n                         if(chars.size() <= 1) return true;\n-\n-                        int mapId = chars.get(0).getMapId();\n-                        for(int i = 1; i < chars.size(); i++) {\n-                                if(chars.get(i).getMapId() != mapId) return false;\n+                        \n+                        Iterator<MapleCharacter> iterator = chars.values().iterator();\n+                        MapleCharacter mc = iterator.next();\n+                        int mapId = mc.getMapId();\n+                        \n+                        for (; iterator.hasNext();) {\n+                                mc = iterator.next();\n+                                if(mc.getMapId() != mapId) return false;\n                         }\n-\n+                        \n                         return true;\n                 } finally {\n                         rL.unlock();\n@@ -888,19 +924,33 @@ public final void warpEventTeamToMapSpawnPoint(int warpTo, int toSp) {\n                 }\n         }\n         \n-        public final MapleCharacter getLeader() {\n+        public final int getLeaderId() {\n                 rL.lock();\n                 try {\n-                        for (MapleCharacter chr : chars) {\n-                                if(chr.isPartyLeader()) return chr;\n-                        }\n-                        \n-                        return null;\n+                        return leaderId;\n+                } finally {\n+                        rL.unlock();\n+                }\n+        }\n+        \n+        public MapleCharacter getLeader() {\n+                rL.lock();\n+                try {\n+                        return chars.get(leaderId);\n                 } finally {\n                         rL.unlock();\n                 }\n         }\n         \n+        public final void setLeader(MapleCharacter chr) {\n+                wL.lock();\n+                try {\n+                        leaderId = chr.getId();\n+                } finally {\n+                        wL.unlock();\n+                }\n+        }\n+        \n         public final void showWrongEffect() {\n                 MapleMap map = getMapInstance(getLeader().getMapId());\n                 map.broadcastMessage(MaplePacketCreator.showEffect(\"quest/party/wrong_kor\"));"}, {"sha": "1068bf7479bb9d6d8fa48177c872316f7ce5c76e", "filename": "src/scripting/event/EventManager.java", "status": "modified", "additions": 166, "deletions": 18, "changes": 184, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/event/EventManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/scripting/event/EventManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/event/EventManager.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -33,7 +33,10 @@\n import javax.script.Invocable;\n import javax.script.ScriptException;\n \n+import net.server.Server;\n+import net.server.world.World;\n import net.server.channel.Channel;\n+import net.server.guild.MapleGuild;\n import net.server.world.MapleParty;\n import net.server.world.MaplePartyCharacter;\n import server.TimerManager;\n@@ -43,10 +46,10 @@\n import server.life.MapleLifeFactory;\n \n import client.MapleCharacter;\n-import java.util.LinkedList;\n import java.util.List;\n import java.util.ArrayList;\n-import java.lang.reflect.Array;\n+import java.util.LinkedList;\n+import java.util.Queue;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReentrantLock;\n \n@@ -57,20 +60,26 @@\n public class EventManager {\n     private Invocable iv;\n     private Channel cserv;\n+    private World wserv;\n+    private Server server;\n     private Map<String, EventInstanceManager> instances = new HashMap<String, EventInstanceManager>();\n     private Map<String, Integer> instanceLocks = new HashMap<String, Integer>();\n+    private final Queue<Integer> queuedGuilds = new LinkedList<>();\n+    private final Map<Integer, Integer> queuedGuildLeaders = new HashMap<>();\n     private List<Boolean> openedLobbys;\n     private Properties props = new Properties();\n     private String name;\n-    private ScheduledFuture<?> schedule = null;\n     private Lock l = new ReentrantLock();\n     \n+    private static final int limitGuilds = 10;  // max numbers of guilds in queue for GPQ.\n     private static final int maxLobbys = 8;     // an event manager holds up to this amount of concurrent lobbys\n     private static final long lobbyDelay = 10;  // 10 seconds cooldown before reopening a lobby\n \n     public EventManager(Channel cserv, Invocable iv, String name) {\n+        this.server = Server.getInstance();\n         this.iv = iv;\n         this.cserv = cserv;\n+        this.wserv = server.getWorld(cserv.getWorld());\n         this.name = name;\n         \n         this.openedLobbys = new ArrayList<>();\n@@ -92,6 +101,10 @@ public void cancel() {\n         return intList;\n     }\n     \n+    public long getLobbyDelay() {\n+        return lobbyDelay;\n+    }\n+    \n     private List<Integer> getLobbyRange() {\n         try {\n             return convertToIntegerArray((List<Double>)iv.invokeFunction(\"setLobbyRange\", (Object) null));\n@@ -104,12 +117,12 @@ public void cancel() {\n         }\n     }\n \n-    public void schedule(String methodName, long delay) {\n-        schedule(methodName, null, delay);\n+    public ScheduledFuture<?> schedule(String methodName, long delay) {\n+        return schedule(methodName, null, delay);\n     }\n \n-    public void schedule(final String methodName, final EventInstanceManager eim, long delay) {\n-        schedule = TimerManager.getInstance().schedule(new Runnable() {\n+    public ScheduledFuture<?> schedule(final String methodName, final EventInstanceManager eim, long delay) {\n+        return TimerManager.getInstance().schedule(new Runnable() {\n             public void run() {\n                 try {\n                     iv.invokeFunction(methodName, eim);\n@@ -120,11 +133,6 @@ public void run() {\n         }, delay);\n     }\n \n-    public void cancelSchedule() {\n-        if(schedule != null)\n-            schedule.cancel(false);\n-    }\n-\n     public ScheduledFuture<?> scheduleAtTimestamp(final String methodName, long timestamp) {\n         return TimerManager.getInstance().scheduleAtTimestamp(new Runnable() {\n             public void run() {\n@@ -250,9 +258,13 @@ public int availableLobbyInstance() {\n     public boolean startInstance(MapleExpedition exped) {\n         return startInstance(-1, exped);\n     }\n+    \n+    public boolean startInstance(int lobbyId, MapleExpedition exped) {\n+        return startInstance(lobbyId, exped, exped.getLeader());\n+    }\n \n     //Expedition method: starts an expedition\n-    public boolean startInstance(int lobbyId, MapleExpedition exped) {\n+    public boolean startInstance(int lobbyId, MapleExpedition exped, MapleCharacter leader) {\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n@@ -269,6 +281,7 @@ public boolean startInstance(int lobbyId, MapleExpedition exped) {\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n+            eim.setLeader(leader);\n             \n             eim.registerExpedition(exped);\n             exped.start();\n@@ -286,6 +299,10 @@ public boolean startInstance(MapleCharacter chr) {\n     }\n     \n     public boolean startInstance(int lobbyId, MapleCharacter chr) {\n+        return startInstance(lobbyId, chr, chr, 1);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleCharacter chr, MapleCharacter leader, int difficulty) {\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n@@ -296,12 +313,13 @@ public boolean startInstance(int lobbyId, MapleCharacter chr) {\n                 startLobbyInstance(lobbyId);\n             }\n             \n-            EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", (Object) null));\n+            EventInstanceManager eim = (EventInstanceManager) (iv.invokeFunction(\"setup\", difficulty, (lobbyId > -1) ? lobbyId : leader.getId()));\n             if(eim == null) {\n                 if(lobbyId > -1) setLockLobby(lobbyId, false);\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n+            eim.setLeader(leader);\n             \n             eim.registerPlayer(chr);\n             iv.invokeFunction(\"afterSetup\", eim);\n@@ -318,6 +336,10 @@ public boolean startInstance(MapleParty party, MapleMap map) {\n     }\n     \n     public boolean startInstance(int lobbyId, MapleParty party, MapleMap map) {\n+        return startInstance(lobbyId, party, map, party.getLeader().getPlayer());\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, MapleCharacter leader) {\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n@@ -334,6 +356,7 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map) {\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n+            eim.setLeader(leader);\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n@@ -351,6 +374,10 @@ public boolean startInstance(MapleParty party, MapleMap map, int difficulty) {\n     }\n     \n     public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int difficulty) {\n+        return startInstance(lobbyId, party, map, difficulty, party.getLeader().getPlayer());\n+    }\n+    \n+    public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int difficulty, MapleCharacter leader) {\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n@@ -367,6 +394,7 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n+            eim.setLeader(leader);\n             \n             eim.registerParty(party, map);\n             party.setEligibleMembers(null);\n@@ -379,11 +407,19 @@ public boolean startInstance(int lobbyId, MapleParty party, MapleMap map, int di\n     }\n \n     //non-PQ method for starting instance\n-    public boolean startInstance(EventInstanceManager eim, String leader) {\n-        return startInstance(-1, eim, leader);\n+    public boolean startInstance(EventInstanceManager eim, String ldr) {\n+        return startInstance(-1, eim, ldr);\n+    }\n+    \n+    public boolean startInstance(EventInstanceManager eim, MapleCharacter ldr) {\n+        return startInstance(-1, eim, ldr.getName(), ldr);\n+    }\n+    \n+    public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr) {\n+        return startInstance(-1, eim, ldr, eim.getEm().getChannelServer().getPlayerStorage().getCharacterByName(ldr));  // things they make me do...\n     }\n     \n-    public boolean startInstance(int lobbyId, EventInstanceManager eim, String leader) {\n+    public boolean startInstance(int lobbyId, EventInstanceManager eim, String ldr, MapleCharacter leader) {\n         try {\n             if(lobbyId == -1) {\n                 lobbyId = availableLobbyInstance();\n@@ -399,9 +435,10 @@ public boolean startInstance(int lobbyId, EventInstanceManager eim, String leade\n                 return false;\n             }\n             instanceLocks.put(eim.getName(), lobbyId);\n+            eim.setLeader(leader);\n             \n             iv.invokeFunction(\"setup\", eim);\n-            eim.setProperty(\"leader\", leader);\n+            eim.setProperty(\"leader\", ldr);\n             iv.invokeFunction(\"afterSetup\", eim);\n         } catch (ScriptException | NoSuchMethodException ex) {\n             Logger.getLogger(EventManager.class.getName()).log(Level.SEVERE, null, ex);\n@@ -448,4 +485,115 @@ public void clearPQ(EventInstanceManager eim, MapleMap toMap) {\n     public MapleMonster getMonster(int mid) {\n         return(MapleLifeFactory.getMonster(mid));\n     }\n+    \n+    private static String ordinal(int i) {\n+        String[] sufixes = new String[] { \"th\", \"st\", \"nd\", \"rd\", \"th\", \"th\", \"th\", \"th\", \"th\", \"th\" };\n+        switch (i % 100) {\n+        case 11:\n+        case 12:\n+        case 13:\n+            return i + \"th\";\n+        default:\n+            return i + sufixes[i % 10];\n+\n+        }\n+    }\n+    \n+    private void exportReadyGuild(Integer guildId) {\n+        MapleGuild mg = server.getGuild(guildId);\n+        String callout = \"Your guild has been registered to attend to the Sharenian Guild Quest at channel \" + this.getChannelServer().getId() \n+                       + \" and    JUST STARTED THE STRATEGY PHASE. After 3 minutes, no more guild members will be allowed to join the effort.\";\n+        \n+        mg.dropMessage(0, callout);\n+    }\n+    \n+    private void exportMovedQueueToGuild(Integer guildId, int place) {\n+        MapleGuild mg = server.getGuild(guildId);\n+        String callout = \"Your guild has been registered to attend to the Sharenian Guild Quest at channel \" + this.getChannelServer().getId() \n+                       + \" and is currently on the \" + ordinal(place) + \" place on the waiting queue.\";\n+        \n+        mg.dropMessage(0, callout);\n+    }\n+    \n+    private List<Integer> getNextGuildQueue() {\n+        synchronized(queuedGuilds) {\n+            Integer guildId = queuedGuilds.poll();\n+            if(guildId == null) return null;\n+            \n+            wserv.removeGuildQueued(guildId);\n+            Integer leaderId = queuedGuildLeaders.remove(guildId);\n+            \n+            exportReadyGuild(guildId);\n+            \n+            int place = 1;\n+            for(Integer i: queuedGuilds) {\n+                exportMovedQueueToGuild(i, place);\n+                place++;\n+            }\n+            \n+            List<Integer> list = new ArrayList<>(2);\n+            list.add(guildId); list.add(leaderId);\n+            return list;\n+        }\n+    }\n+    \n+    public boolean isQueueFull() {\n+        synchronized(queuedGuilds) {\n+            return queuedGuilds.size() >= limitGuilds;\n+        }\n+    }\n+    \n+    public int getQueueSize() {\n+        synchronized(queuedGuilds) {\n+            return queuedGuilds.size();\n+        }\n+    }\n+    \n+    public byte addGuildToQueue(Integer guildId, Integer leaderId) {\n+        if(wserv.isGuildQueued(guildId)) return -1;\n+        \n+        if(!isQueueFull()) {\n+            boolean canStartAhead;\n+            synchronized(queuedGuilds) {\n+                canStartAhead = queuedGuilds.isEmpty();\n+\n+                queuedGuilds.add(guildId);\n+                wserv.putGuildQueued(guildId);\n+                queuedGuildLeaders.put(guildId, leaderId);\n+\n+                int place = queuedGuilds.size();\n+                exportMovedQueueToGuild(guildId, place);\n+            }\n+            \n+            if(canStartAhead) {\n+                if(!attemptStartGuildInstance()) {\n+                    synchronized(queuedGuilds) {\n+                        queuedGuilds.add(guildId);\n+                        wserv.putGuildQueued(guildId);\n+                        queuedGuildLeaders.put(guildId, leaderId);\n+                    }\n+                } else {\n+                    return 2;\n+                }\n+            }\n+            \n+            return 1;\n+        } else {\n+            return 0;\n+        }\n+    }\n+    \n+    public boolean attemptStartGuildInstance() {\n+        MapleCharacter chr = null;\n+        while(chr == null) {\n+            List<Integer> guildInstance = getNextGuildQueue();\n+            if(guildInstance == null) {\n+                return false;\n+            }\n+\n+            chr = cserv.getPlayerStorage().getCharacterById(guildInstance.get(1));\n+        }\n+        \n+        return startInstance(chr);\n+    }\n }"}, {"sha": "03137305821e57590ecae08ba0718d5a62905dae", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -749,7 +749,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                     \treturn false;\n                     }\n                 }\n-                applyto.changeMap(target);\n+                applyto.changeMap(target, target.getRandomPlayerSpawnpoint());\n             } else {\n                 return false;\n             }"}, {"sha": "758dbc748f0e58ce469ce01e5d82604c44a1bbab", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -1640,7 +1640,7 @@ public void run() {\n     public MaplePortal getRandomPlayerSpawnpoint() {\n         List<MaplePortal> spawnPoints = new ArrayList<>();\n         for (MaplePortal portal : portals.values()) {\n-            if (portal.getType() >= 0 && portal.getType() <= 2) {\n+            if (portal.getType() >= 0 && portal.getType() <= 1) {\n                 spawnPoints.add(portal);\n             }\n         }\n@@ -1653,7 +1653,7 @@ public MaplePortal findClosestPlayerSpawnpoint(Point from) {\n         double shortestDistance = Double.POSITIVE_INFINITY;\n         for (MaplePortal portal : portals.values()) {\n             double distance = portal.getPosition().distanceSq(from);\n-            if (portal.getType() >= 0 && portal.getType() <= 2 && distance < shortestDistance && portal.getTargetMapId() == 999999999) {\n+            if (portal.getType() >= 0 && portal.getType() <= 1 && distance < shortestDistance && portal.getTargetMapId() == 999999999) {\n                 closest = portal;\n                 shortestDistance = distance;\n             }"}, {"sha": "fbcfeab6b7e16fade1a2ca4031d65a9bf43d8c1a", "filename": "wz/Map.wz/Map/Map9/990000000.img.xml", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/81f92262864fc271d380bd6261d51d51fc2224df/wz/Map.wz/Map/Map9/990000000.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/81f92262864fc271d380bd6261d51d51fc2224df/wz/Map.wz/Map/Map9/990000000.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Map.wz/Map/Map9/990000000.img.xml?ref=81f92262864fc271d380bd6261d51d51fc2224df", "patch": "@@ -2790,20 +2790,21 @@\n     </imgdir>\n     <imgdir name=\"4\">\n       <string name=\"pn\" value=\"st00\"/>\n-      <int name=\"pt\" value=\"2\"/>\n+      <int name=\"pt\" value=\"7\"/>\n       <int name=\"x\" value=\"428\"/>\n       <int name=\"y\" value=\"-482\"/>\n-      <int name=\"tm\" value=\"101030104\"/>\n-      <string name=\"tn\" value=\"st00\"/>\n-      <string name=\"script\" value=\"\"/>\n+      <int name=\"tm\" value=\"999999999\"/>\n+      <string name=\"tn\" value=\"\"/>\n+      <string name=\"script\" value=\"guildwaitingexit\"/>\n     </imgdir>\n     <imgdir name=\"5\">\n       <string name=\"pn\" value=\"join00\"/>\n-      <int name=\"pt\" value=\"5\"/>\n+      <int name=\"pt\" value=\"8\"/>\n       <int name=\"x\" value=\"132\"/>\n       <int name=\"y\" value=\"161\"/>\n-      <int name=\"tm\" value=\"990000100\"/>\n-      <string name=\"tn\" value=\"st00\"/>\n+      <int name=\"tm\" value=\"999999999\"/>\n+      <string name=\"tn\" value=\"\"/>\n+      <string name=\"script\" value=\"guildwaitingenter\"/>\n     </imgdir>\n   </imgdir>\n </imgdir>"}]}]},
