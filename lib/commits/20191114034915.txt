{"fetchDate": "2019-12-19", "content": [{"sha": "6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "node_id": "MDY6Q29tbWl0NDUwODIwMjM6NmQ1N2ViMTAzM2FlZWVkMDI2MDVlYjRjYjkzMGI4ZmMzYjE1ZjY5Mg==", "commit": {"author": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-11-14T03:49:15Z"}, "committer": {"name": "ronancpl", "email": "rcpl2010@gmail.com", "date": "2019-11-14T03:49:15Z"}, "message": "After-quest messages & MCPQ patch + Scroll Generator\n\nFixed an issue within Restore Lost Item functionality.\nNew custom NPC: scroll generator. Trades a scroll for bundles of common miscellaneous items.\nRevised several lock-acquiring flow scenarios.\nFixed pet autopot taking out \"negative\" amounts from inventory.\nAdded zombify and confuse diseases dispellable by all-cure potions.\nPatched after-quest messages sometimes allowing player movement, that shouldn't be available until the message box is closed.\nReviewed multiclient component, now also evaluating passed HWID alongside remote IP.\nFixed missing info about questlines on skillbook announcer NPC after recent updates.\nFixed some Aran skills not applying MP consume properly.\nCleared a few issues within MCPQ collectable solo/party items and skills.\nImproved response time on scroll generator by adding a cache for scroll requirements.", "tree": {"sha": "07645b51e6de5a6cadf22093e30c281f1b14942e", "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/trees/07645b51e6de5a6cadf22093e30c281f1b14942e"}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/git/commits/6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "html_url": "https://github.com/ronancpl/HeavenMS/commit/6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "comments_url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/comments", "author": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ronancpl", "id": 9257761, "node_id": "MDQ6VXNlcjkyNTc3NjE=", "avatar_url": "https://avatars2.githubusercontent.com/u/9257761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ronancpl", "html_url": "https://github.com/ronancpl", "followers_url": "https://api.github.com/users/ronancpl/followers", "following_url": "https://api.github.com/users/ronancpl/following{/other_user}", "gists_url": "https://api.github.com/users/ronancpl/gists{/gist_id}", "starred_url": "https://api.github.com/users/ronancpl/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ronancpl/subscriptions", "organizations_url": "https://api.github.com/users/ronancpl/orgs", "repos_url": "https://api.github.com/users/ronancpl/repos", "events_url": "https://api.github.com/users/ronancpl/events{/privacy}", "received_events_url": "https://api.github.com/users/ronancpl/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d9f87f18a11415355af866e48f61f926532bc688", "url": "https://api.github.com/repos/ronancpl/HeavenMS/commits/d9f87f18a11415355af866e48f61f926532bc688", "html_url": "https://github.com/ronancpl/HeavenMS/commit/d9f87f18a11415355af866e48f61f926532bc688"}], "stats": {"total": 1281, "additions": 893, "deletions": 388}, "files": [{"sha": "35125c96f430351d90fc0c4dfadc80beb7d12e29", "filename": "config.yaml", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/config.yaml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/config.yaml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/config.yaml?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -239,7 +239,7 @@ server:\n     USE_SERVER_AUTOASSIGNER: true       #HeavenMS-builtin autoassigner, uses algorithm based on distributing AP accordingly with required secondary stat on equipments.\n     USE_REFRESH_RANK_MOVE: true\n     USE_ENFORCE_ADMIN_ACCOUNT: false    #Forces accounts having GM characters to be treated as a \"GM account\" by the client (localhost). Some of the GM account perks is the ability to FLY, but unable to TRADE.\n-    USE_ENFORCE_NOVICE_EXPRATE: false   #Hardsets experience rate 1x for beginners level 10 or under. Ideal for roaming on novice areas without caring too much about losing some stats.\n+    USE_ENFORCE_NOVICE_EXPRATE: true    #Hardsets experience rate 1x for beginners level 10 or under. Ideal for roaming on novice areas without caring too much about losing some stats.\n     USE_ENFORCE_HPMP_SWAP: false        #Forces players to reuse stats (via AP Resetting) located on HP/MP pool only inside the HP/MP stats.\n     USE_ENFORCE_MOB_LEVEL_RANGE: true   #Players N levels below the killed mob will gain no experience from defeating it.\n     USE_ENFORCE_JOB_LEVEL_RANGE: false  #Caps the player level on the minimum required to advance their current jobs.\n@@ -343,7 +343,7 @@ server:\n     USE_ENHANCED_CHSCROLL: true     #Equips even more powerful with chaos upgrade.\n     USE_ENHANCED_CRAFTING: true     #Apply chaos scroll on every equip crafted.\n     USE_ENHANCED_CLNSLATE: true     #Clean slates can be applied to recover successfully used slots as well.\n-    SCROLL_CHANCE_RATE: 10              #Number of rolls for success on a scroll, set 1 for default.\n+    SCROLL_CHANCE_ROLLS: 10         #Number of rolls for success on a scroll, set 1 for default.\n     CHSCROLL_STAT_RATE: 3               #Number of rolls of stat upgrade on a successfully applied chaos scroll, set 1 for default.\n     CHSCROLL_STAT_RANGE: 6              #Stat upgrade range (-N, N) on chaos scrolls.\n \n@@ -414,7 +414,7 @@ server:\n     #Pet Auto-Pot Configuration\n     USE_COMPULSORY_AUTOPOT: true    #Pets will consume as many potions as needed to fulfill the AUTOHP/MP ratio threshold.\n     USE_EQUIPS_ON_AUTOPOT: true     #Player MaxHP and MaxMP check values on autopot handler will be updated by the HP/MP bonuses on equipped items.\n-    PET_AUTOHP_RATIO: 0.99           #Will automatically consume potions until given ratio of the MaxHP/MaxMP is reached.\n+    PET_AUTOHP_RATIO: 0.99          #Will automatically consume potions until given ratio of the MaxHP/MaxMP is reached.\n     PET_AUTOMP_RATIO: 0.99\n \n     #Pet & Mount Configuration"}, {"sha": "39c603514e2b8869f9d9aff1b1c5f2c744c6b3a1", "filename": "docs/mychanges_ptbr.txt", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/docs/mychanges_ptbr.txt", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/docs/mychanges_ptbr.txt", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/docs/mychanges_ptbr.txt?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -2237,4 +2237,39 @@ Adicionado utiliza\u00e7\u00e3o de dispose em quest scripts para o comando hom\u00f4nimo.\n \n 30 Outubro 2019,\n Corrigido bug em scripts (que possivelmente passou a ocorrer ao utilizar Java8) relacionado ao tentar utilizar m\u00e9todos da biblioteca Math sem corresponder par\u00e2metros com a assinatura adequada.\n-Corrigido entrega de itemid inesperado em script relacionado a EllinPQ.\n\\ No newline at end of file\n+Corrigido entrega de itemid inesperado em script relacionado a EllinPQ.\n+\n+01 - 03 Novembro 2019,\n+Corrigido deslize recente em na funcionalidade de recupera\u00e7\u00e3o de itens de quest.\n+Adicionado custom npc para MapleTVs: geradora de scrolls, prov\u00ea os mesmos ap\u00f3s trocar diversos itens ganhos durante jogo.\n+\n+04 Novembro 2019,\n+Revisado diversos fluxos de aquisi\u00e7\u00e3o de locks ao longo das classes mais relevantes do c\u00f3digo-fonte.\n+Corrigido problema inesperado com funcionalidade restoreLostItem.\n+Inserido remo\u00e7\u00e3o de cash item para dentro da cl\u00e1usula que checa item no invent\u00e1rio.\n+Corrigido bug em pet autopot retirando quantidades negativas do invent\u00e1rio.\n+Corrigido caso de deadlock em tentativa de aquisi\u00e7\u00e3o de lock inesperada ap\u00f3s adquirir os de mapas, que deveriam ter prioridade baixa.\n+\n+07 Novembro 2019,\n+Adicionado cura de debuffs zumbifica\u00e7\u00e3o e confus\u00e3o na lista de debuffs a serem curados pela po\u00e7\u00e3o \"cura-tudo\".\n+Corrigido duplica\u00e7\u00e3o em mensagem de p\u00f3s-quest enviada, em casos onde h\u00e1 a presen\u00e7a de a\u00e7\u00e3o que automatiza mensagem guiando jogador para a pr\u00f3xima quest.\n+\n+09 - 10 Novembro 2019,\n+Refatorado certos usos de finaliza\u00e7\u00e3o n\u00e3o-sucedida de quests, que poderiam compartilhar das mec\u00e2nicas de desist\u00eancia de quest.\n+Revisado aquisi\u00e7\u00e3o de endere\u00e7o remoto para checagem de transi\u00e7\u00e3o de jogadores e multi-cliente, agora tamb\u00e9m avaliando distin\u00e7\u00e3o de HWID passado.\n+Corrigido p\u00f3s-quests ainda permitindo jogadores a movimentarem enquanto a mensagem est\u00e1 na tela, devido a certo conflito com envio de recompensas permitindo movimenta\u00e7\u00e3o do jogador.\n+Corrigido informa\u00e7\u00e3o de skillbooks por quests n\u00e3o-funcional ap\u00f3s refatora\u00e7\u00e3o recente.\n+Corrigido chance de drop de item de quest em El Nath extremamente baixa.\n+\n+11 - 12 Novembro 2019,\n+Corrigido algumas skills de ataque de Aran (double, triple swing) n\u00e3o aplicando consumo de MP devidamente.\n+Revisado caso com doors levando jogadores a solo abaixo inesperadamente.\n+Corrigido pots em MCPQ n\u00e3o atuando devidamente para outros jogadores no grupo ou somente para si.\n+Corrigido buffs random em MCPQ acertando sempre m\u00faltiplos jogadores.\n+Corrigido po\u00e7\u00e3o \"cura-tudo\" em MCPQ: pots pequenos curando todos os jogadores de party, pots grandes n\u00e3o curando slow.\n+Corrigido caso inesperado em 2nd job de pirata bloqueando sa\u00edda de jogadores do mapa enquanto n\u00e3o lidarem com todos os mobs.\n+\n+13 Novembro 2019,\n+Corrigido problema no sistema de matching ao tentar rodar a\u00e7\u00f5es externas enquanto travando os recursos do sistema, ao criar match.\n+Corrigido caso onde novos jogadores poderiam ser agregados \u00e0 party e entrar em campo na MCPQ assim que confirma\u00e7\u00e3o de partida e contagem de in\u00edcio fossem efetivados.\n+Adicionado cache para requerimento de scrolls, assim melhorando tempo de resposta para o novo custom NPC de gera\u00e7\u00e3o de scrolls.\n\\ No newline at end of file"}, {"sha": "03a5973b8a8006bb73a766752691a74e60079144", "filename": "scripts/npc/1072008.js", "status": "modified", "additions": 44, "deletions": 28, "changes": 72, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/1072008.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/1072008.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/1072008.js?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -5,36 +5,52 @@\n **/\n \n var status;\n-\n+ \n function start() {\n     status = -1;\n-    action(1,0,0);\n+    action(1, 0, 0);\n }\n \n-function action(mode,type,selection) {\n-    if (status == -1) {\n-\tif (cm.getMapId() == 108000502) {\n-\t    if (!(cm.haveItem(4031856,15))) {\n-\t    \tcm.sendNext(\"Go, and get me 15 #b#t4031856##k.\");\n-\t    \tcm.dispose();\n-\t    } else {\n-\t    \tstatus = 2;\n-\t    \tcm.sendNext(\"Wow, you have brought me 15 #b#t4031856##k! Congratulations. Let me warp you out now.\");\n-\t    }\n-\t} else if (cm.getMapId() == 108000501) {\n-\t    if (!(cm.haveItem(4031857,15))) {\n-\t    \tcm.sendNext(\"Go, and get me 15 #b#t4031857##k.\");\n-\t    \tcm.dispose();\n-\t    } else {\n-\t    \tstatus = 2;\n-\t    \tcm.sendNext(\"Wow, you have brought me 15 #b#t4031857##k! Congratulations. Let me warp you out now.\");\n-\t    }\n-\t} else {\n-\t    cm.sendNext(\"Error. Please report this.\");\n-\t    cm.dispose();\n-\t}\n-    } else if (status == 2) {\n-    \tcm.warp(120000101,0);\n-\t\tcm.dispose();\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && type > 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+\n+        if(status == 0) {\n+            if (cm.getMapId() == 108000502) {\n+                if (!(cm.haveItem(4031856,15))) {\n+                    cm.sendSimple(\"You haven't brought me all the crystals yet. I'm looking forward for your progress, mate! \\r\\n#b#L1#I would like to leave#l\");\n+                } else {\n+                    status++;\n+                    cm.sendNext(\"Wow, you have brought me 15 #b#t4031856##k! Congratulations. Let me warp you out now.\");\n+                }\n+            } else if (cm.getMapId() == 108000501) {\n+                if (!(cm.haveItem(4031857,15))) {\n+                    cm.sendSimple(\"You haven't brought me all the crystals yet. I'm looking forward for your progress, mate! \\r\\n#b#L1#I would like to leave#l\");\n+                } else {\n+                    status++;\n+                    cm.sendNext(\"Wow, you have brought me 15 #b#t4031857##k! Congratulations. Let me warp you out now.\");\n+                }\n+            } else {\n+                cm.sendNext(\"Error. Please report this.\");\n+                cm.dispose();\n+            }\n+        } else if (status == 1) {   // thanks Lame for noticing players getting stuck in area in certain scenarios\n+            cm.removeAll(4031856);\n+            cm.removeAll(4031857);\n+            cm.warp(120000101,0);\n+            cm.dispose();\n+        } else if (status == 2) {\n+            cm.warp(120000101,0);\n+            cm.dispose();\n+        }\n     }\n-}\n\\ No newline at end of file\n+}"}, {"sha": "cd84aeec7567910eb5a4dd08e396e577504f0320", "filename": "scripts/npc/2042000.js", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/2042000.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/2042000.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/2042000.js?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -437,7 +437,7 @@ function action(mode, type, selection) {\n                     cm.sendNext(\"Oh, and do not worry about turning into a ghost. In the Monster Carnival, #byou will not lose EXP after death#k. So it's really an experience like no other!\");\n                     cm.dispose();\n                 } else if (select == 2) {\n-                    cm.sendNext(\"#bProtetor#k basically an invoked item that drastically increases the abilities of the monsters invoked by your group. Protector works until it is demolished by the opposing group, so I'm hoping you'll summon several monsters first, and then bring the Protector.\");\n+                    cm.sendNext(\"#bProtector#k is basically an invoked item that drastically increases the abilities of the monsters invoked by your group. Protector works until it is demolished by the opposing group, so I'm hoping you'll summon several monsters first, and then bring the Protector.\");\n                 }\n             } else if (status == 66) {\n                 cm.sendNext(\"Lastly, while in the Monster Carnival, #byou can not use items / recovery potions that you carry around with you. #kMeanwhile, the monsters let these items fall for good. when, and when you #bget them, the item will immediately activate#k. That's why it's important to know when to get these items.\");"}, {"sha": "e5d2adfb4c2cc63aa49d471dd6fd8c21f0e71164", "filename": "scripts/npc/9977777.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/9977777.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/9977777.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/9977777.js?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -253,6 +253,7 @@ function writeFeatureTab_CustomNPCs() {\n         addFeature(\"Dalair: automatized equipment-merger.\");\n         addFeature(\"Donation Box: automatized item-buyer.\");\n         addFeature(\"Coco & Ace of Hearts: C. scroll crafters.\");\n+        addFeature(\"Barry (MapleTV): fill book & exchange items for scroll.\");\n }\n \n function writeFeatureTab_Localhostedits() {"}, {"sha": "db14d5adab719e2862c414c6e47a76d5c95993fd", "filename": "scripts/npc/mapleTV.js", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/mapleTV.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/mapleTV.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/mapleTV.js?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -24,6 +24,12 @@\n var status;\n  \n function start() {\n+        if (Packages.config.YamlConfig.config.server.USE_ENABLE_CUSTOM_NPC_SCRIPT) {\n+                cm.dispose();\n+                cm.openNpc(9201088, \"scroll_generator\");\n+                return;\n+        }\n+\n         status = -1;\n         action(1, 0, 0);\n }"}, {"sha": "b3b3f038c7eb34b539e23af6fd775e2b025931ea", "filename": "scripts/npc/scroll_generator.js", "status": "added", "additions": 408, "deletions": 0, "changes": 408, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/scroll_generator.js", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/scripts/npc/scroll_generator.js", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/scripts/npc/scroll_generator.js?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -0,0 +1,408 @@\n+/*\n+    This file is part of the HeavenMS MapleStory Server\n+    Copyleft (L) 2016 - 2019 RonanLana\n+\n+    This program is free software: you can redistribute it and/or modify\n+    it under the terms of the GNU Affero General Public License as\n+    published by the Free Software Foundation version 3 as published by\n+    the Free Software Foundation. You may not use, modify or distribute\n+    this program under any other version of the GNU Affero General Public\n+    License.\n+\n+    This program is distributed in the hope that it will be useful,\n+    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+    GNU Affero General Public License for more details.\n+\n+    You should have received a copy of the GNU Affero General Public License\n+    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+*/\n+/* NPC: MapleTV / Larry\n+\t\n+\tExchanger NPC:\n+\t* Scroll generator\n+        * \n+        * @author Ronan Lana\n+*/\n+\n+importPackage(Packages.client);\n+importPackage(Packages.config);\n+importPackage(Packages.constants.game);\n+importPackage(Packages.server);\n+importPackage(Packages.server.life);\n+\n+var status;\n+\n+var jobWeaponRestricted = [[[2043000, 2043100, 2044000, 2044100, 2043200, 2044200]], [[2043000, 2043100, 2044000, 2044100], [2043000, 2043200, 2044000, 2044200], [2044300, 2044400]], [[2043700, 2043800], [2043700, 2043800], [2043700, 2043800]], [[2044500], [2044600]], [[2044700], [2043300]], [[2044800], [2044900]]];\n+var aranWeaponRestricted = [jobWeaponRestricted[1][2][1]];\n+\n+var tier1Scrolls = [];\n+var tier2Scrolls = [2040000, 2040400, 2040500, 2040600, 2040700, 2040800, 2040900];\n+var tier3Scrolls = [2048000, 2049200, 2041000, 2041100, 2041300, 2040100, 2040200, 2040300];\n+\n+var typeTierScrolls = [[\"PAD\", \"MAD\"], [\"STR\", \"DEX\", \"INT\", \"LUK\", \"ACC\", \"EVA\", \"Speed\", \"Jump\"], [\"PDD\", \"MDD\", \"MHP\", \"MMP\"]];\n+\n+var sgItems = [4003004, 4003005, 4001006, 4006000, 4006001, 4030012];\n+var sgToBucket = [100, 50, 37.5, 37.5, 37.5, 200];\n+var mesoToBucket = 2800000;\n+\n+var sgAppliedItems = [0, 0, 0, 0, 0, 0];\n+var sgAppliedMeso = 0;\n+\n+var sgBuckets = 0.0;\n+var sgBookBuckets = 0.0;\n+var sgItemBuckets = 0.0;\n+\n+function start() {\n+    status = -1;\n+    action(1, 0, 0);\n+}\n+\n+function action(mode, type, selection) {\n+    if (mode == -1) {\n+        cm.dispose();\n+    } else {\n+        if (mode == 0 && type > 0) {\n+            cm.dispose();\n+            return;\n+        }\n+        if (mode == 1)\n+            status++;\n+        else\n+            status--;\n+\n+        if(status == 0) {\n+            cm.sendNext(\"This is the MapleTV Scroll Generator broadcast. Place your supplies or mesos earned throughout your adventure to redeem a prize! You can place #bany amount of supplies#k, however take note that placing #rdifferent supplies#k with #rbigger shots of any of them#k will improve the reward possibilities!\");\n+        } else if(status == 1) {\n+            var sendStr;\n+\n+            //print(\"Book: \" + sgBookBuckets + \" Item: \" + sgItemBuckets);\n+            \n+            if(sgItemBuckets > 0.0) sendStr = \"With the items you have currently placed, you have #r\" + sgBuckets + \"#k buckets (#r\" + (sgItemBuckets < 1.0 ? sgItemBuckets.toFixed(2) : Math.floor(sgItemBuckets)) + \"#k supply buckets) for claiming a prize. Place supplies:\";\n+            else sendStr = \"You have placed no supplies yet. Place supplies:\";\n+\n+            var listStr = \"\";\n+            var i;\n+            for(i = 0; i < sgItems.length; i++) {\n+                listStr += \"#b#L\" + i + \"##t\" + sgItems[i] + \"##k\";\n+                if(sgAppliedItems[i] > 0) listStr += \" - \" + sgAppliedItems[i];\n+                listStr += \"#l\\r\\n\";\n+            }\n+\n+            listStr += \"#b#L\" + i + \"#Mesos#k\";\n+            if(sgAppliedMeso > 0) listStr += \" - \" + sgAppliedMeso;\n+            listStr += \"#l\\r\\n\";\n+\n+            cm.sendSimple(sendStr + \"\\r\\n\\r\\n\" + listStr + \"#r#L\" + (sgItems.length + 2) + \"#Retrieve a prize!#l#k\\r\\n\");\n+        } else if(status == 2) {\n+            if(selection == (sgItems.length + 2)) {\n+                if(sgItemBuckets < 1.0) {\n+                    cm.sendPrev(\"You have set not enough supplies. Insert at least one bucket of #bsupplies#k to claim a prize.\");\n+                } else {\n+                    generateRandomScroll();\n+                    cm.dispose();\n+                }\n+            } else {\n+                var tickSel;\n+                if(selection < sgItems.length) {\n+                    tickSel = \"of #b#t\" + sgItems[selection] + \"##k\";\n+                    curItemQty = cm.getItemQuantity(sgItems[selection]);\n+                } else {\n+                    tickSel = \"#bmesos#k\";\n+                    curItemQty = cm.getMeso();\n+                }\n+                \n+                curItemSel = selection;\n+                if(curItemQty > 0) {\n+                    cm.sendGetText(\"How many \" + tickSel + \" do you want to provide? (#r\" + curItemQty + \"#k available)#k\");\n+                } else {\n+                    cm.sendPrev(\"You have got #rnone#k \" + tickSel + \" to provide for Scroll Generation. Click '#rBack#k' to return to the main interface.\");\n+                }\n+            }\n+        } else if(status == 3) {\n+            var text = cm.getText();\n+\n+            try {\n+                var placedQty = parseInt(text);\n+                if(isNaN(placedQty) || placedQty < 0) throw true;\n+\n+                if(placedQty > curItemQty) {\n+                    cm.sendPrev(\"You cannot insert the given amount of #r\" + (curItemSel < sgItems.length ? \"#t\" + sgItems[curItemSel] + \"#\" : \"mesos\") + \"#k (#r\" + curItemQty + \"#k available). Click '#rBack#k' to return to the main interface.\");\n+                } else {\n+                    if(curItemSel < sgItems.length) sgApplyItem(curItemSel, placedQty);\n+                    else sgApplyMeso(placedQty);\n+\n+                    cm.sendPrev(\"Operation succeeded. Click '#rBack#k' to return to the main interface.\");\n+                }\n+            } catch(err) {\n+                cm.sendPrev(\"You must enter a positive number of supplies to insert. Click '#rBack#k' to return to the main interface.\");\n+            }\n+\n+            status = 2;\n+        } else {\n+            cm.dispose();\n+        }\n+    }\n+}\n+\n+function getJobTierScrolls() {\n+    var scrolls = [];\n+\n+    var job = cm.getPlayer().getJob();\n+    var jobScrolls = jobWeaponRestricted[Math.floor(cm.getPlayer().getJobStyle().getId() / 100)];\n+    \n+    var jobBranch = GameConstants.getJobBranch(job);\n+    if (jobBranch >= 2) {\n+        Array.prototype.push.apply(scrolls, jobScrolls[Math.floor((job.getId() / 10) % 10) - 1]);\n+    } else {\n+        for (var i = 0; i < jobScrolls.length; i++) {\n+            Array.prototype.push.apply(scrolls, jobScrolls[i]);\n+        }\n+    }\n+    \n+    return scrolls;\n+}\n+\n+function getScrollTypePool(rewardTier) {\n+    var scrolls = [];\n+    switch (rewardTier) {\n+        case 1:\n+            if (cm.getPlayer().isAran()) {\n+                Array.prototype.push.apply(scrolls, aranWeaponRestricted);\n+            } else {\n+                Array.prototype.push.apply(scrolls, getJobTierScrolls());\n+            }\n+            \n+            Array.prototype.push.apply(scrolls, tier1Scrolls);\n+            break;\n+        case 2:\n+            Array.prototype.push.apply(scrolls, tier2Scrolls);\n+            break;\n+        default:\n+            Array.prototype.push.apply(scrolls, tier3Scrolls);\n+    }\n+    \n+    return scrolls;\n+}\n+\n+function getScrollTier(scrollStats) {\n+    for (var i = 0; i < typeTierScrolls.length; i++) {\n+        for (var j = 0; j < typeTierScrolls[i].length; j++) {\n+            if (scrollStats.get(typeTierScrolls[i][j]) > 0) {\n+                return i + 1;\n+            }\n+        }\n+    }\n+    \n+    return 4;\n+}\n+\n+function getScrollSuccessTier(scrollStats) {\n+    var prop = scrollStats.get(\"success\");\n+\n+    if (prop > 90) {\n+        return 3;\n+    } else if (prop < 50) {\n+        return YamlConfig.config.server.SCROLL_CHANCE_ROLLS > 2 ? 2 : 1;\n+    } else {\n+        return YamlConfig.config.server.SCROLL_CHANCE_ROLLS > 2 ? 1 : 2;\n+    }\n+}\n+\n+function getAvailableScrollsPool(baseScrolls, rewardTier, successTier) {\n+    var scrolls = [];\n+    var ii = MapleItemInformationProvider.getInstance();\n+    \n+    for (var i = 0; i < baseScrolls.length; i++) {\n+        for (var j = 0; j < 100; j++) {\n+            var scrollid = baseScrolls[i] + j;\n+            var scrollStats = ii.getEquipStats(scrollid);\n+            if (scrollStats != null && ii.getScrollReqs(scrollid).isEmpty()) {\n+                var scrollTier = getScrollTier(scrollStats);\n+                if (scrollTier == rewardTier && successTier == getScrollSuccessTier(scrollStats)) {\n+                    scrolls.push(scrollid);\n+                }\n+            }\n+        }\n+    }\n+\n+    return scrolls;\n+}\n+\n+// passive tier buckets...\n+\n+function getLevelTier(level) {\n+    return Math.floor((level - 1) / 15) + 1;\n+}\n+\n+function getPlayerCardTierPower() {\n+    var cardset = cm.getPlayer().getMonsterBook().getCardSet();\n+    var countTier = [0, 0, 0, 0, 0, 0, 0, 0, 0];\n+\n+    for (var iterator = cardset.iterator(); iterator.hasNext();) {\n+        var ce = iterator.next();\n+\n+        var cardid = ce.getKey();\n+        var ceTier = Math.floor(cardid / 1000) % 10;\n+        countTier[ceTier] += ce.getValue();\n+\n+        if (ceTier >= 8) {  // is special card\n+            var mobLevel = MapleLifeFactory.getMonsterLevel(MapleItemInformationProvider.getInstance().getCardMobId(cardid));\n+            var mobTier = getLevelTier(mobLevel) - 1;\n+\n+            countTier[mobTier] += (ce.getValue() * 1.2);\n+        }\n+    }\n+    \n+    return countTier;\n+}\n+\n+function calculateMobBookTierBuckets(tierSize, playerCards, tier) {\n+    if (tier < 1) {\n+        return 0.0;\n+    }\n+\n+    tier--; // started at 1\n+    var tierHitRate = playerCards[tier] / (tierSize[tier] * 5);\n+    if (tierHitRate > 0.5) {\n+        tierHitRate = 0.5;\n+    }\n+    \n+    return tierHitRate * 4;\n+}\n+\n+function calculateMobBookBuckets() {\n+    var book = cm.getPlayer().getMonsterBook();\n+    var bookLevelMult = 0.9 + (0.1 * book.getBookLevel());\n+    \n+    var playerLevelTier = getLevelTier(cm.getPlayer().getLevel());\n+    if (playerLevelTier > 8) {\n+        playerLevelTier = 8;\n+    }\n+\n+    var tierSize = MonsterBook.getCardTierSize();\n+    var playerCards = getPlayerCardTierPower();\n+    \n+    var prevBuckets = calculateMobBookTierBuckets(tierSize, playerCards, playerLevelTier - 1);\n+    var currBuckets = calculateMobBookTierBuckets(tierSize, playerCards, playerLevelTier);\n+    \n+    return (prevBuckets + currBuckets) * bookLevelMult;\n+}\n+\n+function recalcBuckets() {\n+    sgBookBuckets = calculateMobBookBuckets();\n+    sgItemBuckets = calculateSuppliesBuckets();\n+    \n+    var buckets = sgBookBuckets + sgItemBuckets;\n+    if (buckets > 6.0) {\n+        sgBuckets = 6;\n+    } else {\n+        sgBuckets = Math.floor(buckets);\n+    }\n+}\n+\n+// variable buckets...\n+\n+function sgApplyItem(idx, amount) {\n+    if (sgAppliedItems[idx] != amount) {\n+        sgAppliedItems[idx] = amount;\n+        recalcBuckets();\n+    }\n+}\n+\n+function sgApplyMeso(amount) {\n+    if (sgAppliedMeso != amount) {\n+        sgAppliedMeso = amount;\n+        recalcBuckets();\n+    }\n+}\n+\n+function calculateSuppliesBuckets() {\n+    var suppliesHitRate = 0.0;\n+    for (var i = 0; i < sgItems.length; i++) {\n+        suppliesHitRate += sgAppliedItems[i] / sgToBucket[i];\n+    }\n+    suppliesHitRate *= 2;\n+\n+    suppliesHitRate += (sgAppliedMeso / mesoToBucket);\n+    return suppliesHitRate;\n+}\n+\n+function calculateScrollTiers() {\n+    var buckets = sgBuckets;\n+    var tiers = [0, 0, 0];\n+    while (buckets > 0) {\n+        var pool = [];\n+        for (var i = 0; i < tiers.length; i++) {\n+            if (tiers[i] < 2) {\n+                pool.push(i);\n+            }\n+        }\n+        \n+        var rnd = pool[Math.floor(Math.random() * pool.length)];\n+        \n+        tiers[rnd]++;\n+        buckets--;\n+    }\n+\n+    // normalize tiers\n+    for (var i = 0; i < tiers.length; i++) {\n+        tiers[i] = 3 - tiers[i];\n+    }\n+\n+    return tiers;\n+}\n+\n+function getRandomScroll(tiers) {\n+    var typeTier = tiers[0], subtypeTier = tiers[1], successTier = tiers[2];\n+    var scrollTypePool = getScrollTypePool(typeTier);\n+    var scrollPool = getAvailableScrollsPool(scrollTypePool, subtypeTier, successTier);\n+    \n+    if (scrollPool.length > 0) {\n+        return scrollPool[Math.floor(Math.random() * scrollPool.length)];\n+    } else {\n+        return -1;\n+    }\n+}\n+\n+function performExchange(sgItemid, sgCount) {\n+    if (cm.getMeso() < sgAppliedMeso) {\n+        return false;\n+    }\n+    \n+    for (var i = 0; i < sgItems.length; i++) {\n+        var itemid = sgItems[i];\n+        var count = sgAppliedItems[i];\n+        if (count > 0 && !cm.haveItem(itemid, count)) {\n+            return false;\n+        }\n+    }\n+\n+    cm.gainMeso(-sgAppliedMeso);\n+    \n+    for (var i = 0; i < sgItems.length; i++) {\n+        var itemid = sgItems[i];\n+        var count = sgAppliedItems[i];\n+        cm.gainItem(itemid, -count);\n+    }\n+\n+    cm.gainItem(sgItemid, sgCount);\n+    return true;\n+}\n+\n+function generateRandomScroll() {\n+    if (cm.getPlayer().getInventory(Packages.client.inventory.MapleInventoryType.USE).getNumFreeSlot() >= 1) {\n+        var itemid = getRandomScroll(calculateScrollTiers());\n+        if (itemid != -1) {\n+            if (performExchange(itemid, 1)) {\n+                cm.sendNext(\"Transaction accepted! You have received a #r#t\" + itemid + \"##k.\");\n+            } else {\n+                cm.sendOk(\"Oh, it looks like some items are missing... Please double-check provided items in your inventory before trying to exchange.\");\n+            }\n+        } else {\n+            cm.sendOk(\"Sorry for the inconvenience, but it seems there are no scrolls on store right now... Try again later.\");\n+        }\n+    } else {\n+        cm.sendOk(\"Please look out for a slot available on your USE inventory before trying for a scroll.\");\n+    }\n+}"}, {"sha": "c25e7951676405116a63ed844635573b17adbdf4", "filename": "sql/db_database.sql", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/sql/db_database.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/sql/db_database.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_database.sql?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -10439,7 +10439,7 @@ INSERT IGNORE INTO `temp_data` (`dropperid`, `itemid`, `minimum_quantity`, `maxi\n (3230104, 4031209, 1, 1, 3072, 500000),\n (3230306, 4031159, 1, 1, 2074, 500000),\n (9500400, 4031224, 1, 1, 3607, 1000000),\n-(9500400, 4031223, 1, 1, 3607, 1000000),\n+(9500400, 4031223, 1, 1, 3608, 1000000),    # thanks Lame for noticing Hongbu's gourd unavailable\n (9420003, 4031400, 1, 1, 8761, 1000000),\n (9420001, 4031401, 1, 1, 8761, 1000000),\n (9300097, 4031472, 1, 1, 6301, 100000),\n@@ -14844,7 +14844,7 @@ INSERT IGNORE INTO `makerrecipedata` (`itemid`, `req_item`, `count`) VALUES\n   (1372009, 4011002, 4),\n   (1372009, 4260004, 28),\n   (1382035, 4011002, 4),\n-  (1382035, 4260004, 28),\n+  (1382035, 4260005, 28),\n   (1372010, 4011003, 4),\n   (1372010, 4260005, 30),\n   (1372032, 4011003, 5),"}, {"sha": "d17bc0addeb084aacd7a25fb9fac4360b9d37e0f", "filename": "sql/db_drops.sql", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/sql/db_drops.sql", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/sql/db_drops.sql", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/sql/db_drops.sql?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -17932,7 +17932,7 @@ USE `heavenms`;\n (8220005, 1002382, 1, 1, 0, 40000), \n (8220005, 1482012, 1, 1, 0, 40000), \n (8800002, 4001083, 1, 1, 0, 7000), \n-(8800002, 4032133, 1, 1, 0, 10000), \n+(8800002, 4032133, 1, 1, 0, 420000), \n (8800002, 2000005, 1, 4, 0, 40000),\n (8800002, 2020015, 1, 4, 0, 3000), \n (8800002, 2000006, 1, 4, 0, 40000), "}, {"sha": "406e9014ad7584ffdd243f9001a5c67f91112e62", "filename": "src/client/MapleCharacter.java", "status": "modified", "additions": 33, "deletions": 53, "changes": 86, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MapleCharacter.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MapleCharacter.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleCharacter.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -568,9 +568,7 @@ public boolean hasDisabledPartySearchInvite(int fromLeaderid) {\n     }\n     \n     public void setSessionTransitionState() {\n-        IoSession session = client.getSession();\n-        session.setAttribute(MapleClient.CLIENT_TRANSITION);\n-        Server.getInstance().setCharacteridInTransition(session, this.getId());\n+        client.setCharacterOnSessionTransitionState(this.getId());\n     }\n     \n     public boolean getCS() {\n@@ -2803,6 +2801,8 @@ public void dispelDebuffs() {\n         dispelDebuff(MapleDisease.SEAL);\n         dispelDebuff(MapleDisease.WEAKEN);\n         dispelDebuff(MapleDisease.SLOW);\n+        dispelDebuff(MapleDisease.ZOMBIFY);\n+        dispelDebuff(MapleDisease.CONFUSE);\n     }\n \n     public void cancelAllDebuffs() {\n@@ -6792,20 +6792,16 @@ public void updateCouponRates() {\n         MapleInventory cashInv = this.getInventory(MapleInventoryType.CASH);\n         if (cashInv == null) return;\n         \n-        if (cpnLock.tryLock()) {\n-            effLock.lock();\n-            chrLock.lock();\n-            cashInv.lockInventory();\n-            try {\n-                revertCouponRates();\n-                setCouponRates();\n-            } finally {\n-                cpnLock.unlock();\n-                \n-                cashInv.unlockInventory();\n-                chrLock.unlock();\n-                effLock.unlock();\n-            }\n+        effLock.lock();\n+        chrLock.lock();\n+        cashInv.lockInventory();\n+        try {\n+            revertCouponRates();\n+            setCouponRates();\n+        } finally {\n+            cashInv.unlockInventory();\n+            chrLock.unlock();\n+            effLock.unlock();\n         }\n     }\n     \n@@ -7509,7 +7505,7 @@ public static MapleCharacter loadCharFromDB(int charid, MapleClient client, bool\n     }\n     \n     public void reloadQuestExpirations() {\n-        for(MapleQuestStatus mqs: getQuests()) {\n+        for(MapleQuestStatus mqs: getStartedQuests()) {\n             if(mqs.getExpirationTime() > 0) {\n                 questTimeLimit2(mqs.getQuest(), mqs.getExpirationTime());\n             }\n@@ -7690,29 +7686,23 @@ private void unsitChairInternal() {\n     }\n     \n     public void sitChair(int itemId) {\n-        if (client.tryacquireClient()) {\n-            try {\n-                if (this.isLoggedinWorld()) {\n-                    if (itemId >= 1000000) {    // sit on item chair\n-                        if (chair.get() < 0) {\n-                            setChair(itemId);\n-                            getMap().broadcastMessage(this, MaplePacketCreator.showChair(this.getId(), itemId), false);\n-                        }\n-                        announce(MaplePacketCreator.enableActions());\n-                    } else if (itemId >= 0) {    // sit on map chair\n-                        if (chair.get() < 0) {\n-                            setChair(itemId);\n-                            if (registerChairBuff()) {\n-                                getMap().broadcastMessage(this, MaplePacketCreator.giveForeignChairSkillEffect(this.getId()), false);\n-                            }\n-                            announce(MaplePacketCreator.cancelChair(itemId));\n-                        }\n-                    } else {    // stand up\n-                        unsitChairInternal();\n+        if (this.isLoggedinWorld()) {\n+            if (itemId >= 1000000) {    // sit on item chair\n+                if (chair.get() < 0) {\n+                    setChair(itemId);\n+                    getMap().broadcastMessage(this, MaplePacketCreator.showChair(this.getId(), itemId), false);\n+                }\n+                announce(MaplePacketCreator.enableActions());\n+            } else if (itemId >= 0) {    // sit on map chair\n+                if (chair.get() < 0) {\n+                    setChair(itemId);\n+                    if (registerChairBuff()) {\n+                        getMap().broadcastMessage(this, MaplePacketCreator.giveForeignChairSkillEffect(this.getId()), false);\n                     }\n+                    announce(MaplePacketCreator.cancelChair(itemId));\n                 }\n-            } finally {\n-                client.releaseClient();\n+            } else {    // stand up\n+                unsitChairInternal();\n             }\n         }\n     }\n@@ -9974,9 +9964,9 @@ public void updateQuestStatus(MapleQuestStatus qs) {\n                 awardQuestPoint(YamlConfig.config.server.QUEST_POINT_PER_QUEST_COMPLETE);\n             }\n             qs.setCompleted(qs.getCompleted() + 1);   // count quest completed Jayd's idea\n-            \n+\n             announceUpdateQuest(DelayedQuestUpdate.COMPLETE, questid, qs.getCompletionTime());\n-            announceUpdateQuest(DelayedQuestUpdate.INFO, qs);\n+            //announceUpdateQuest(DelayedQuestUpdate.INFO, qs); // happens after giving rewards, for non-next quests only\n         } else if (qs.getStatus().equals(MapleQuestStatus.Status.NOT_STARTED)) {\n             announceUpdateQuest(DelayedQuestUpdate.UPDATE, qs, false);\n             if (qs.getInfoNumber() > 0) {\n@@ -9987,19 +9977,9 @@ public void updateQuestStatus(MapleQuestStatus qs) {\n     }\n     \n     private void expireQuest(MapleQuest quest) {\n-        MapleQuestStatus mqs = getQuest(quest);\n-        if(mqs.getStatus().equals(MapleQuestStatus.Status.COMPLETED)) {\n-            return;\n+        if (quest.forfeit(this)) {\n+            announce(MaplePacketCreator.questExpire(quest.getId()));\n         }\n-        \n-        if(System.currentTimeMillis() < mqs.getExpirationTime()) {\n-            return;\n-        }\n-        \n-        announce(MaplePacketCreator.questExpire(quest.getId()));\n-        MapleQuestStatus newStatus = new MapleQuestStatus(quest, MapleQuestStatus.Status.NOT_STARTED);\n-        newStatus.setForfeited(mqs.getForfeited() + 1);\n-        updateQuestStatus(newStatus);\n     }\n     \n     public void cancelQuestExpirationTask() {"}, {"sha": "aad0849b229fa935803e145503aac68a876c55f9", "filename": "src/client/MapleClient.java", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MapleClient.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MapleClient.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MapleClient.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -74,7 +74,6 @@\n import server.life.MapleMonster;\n import server.ThreadManager;\n import server.maps.*;\n-import server.quest.MapleQuest;\n \n import net.server.audit.locks.MonitoredLockType;\n import net.server.audit.locks.factory.MonitoredReentrantLockFactory;\n@@ -997,14 +996,9 @@ private void disconnectInternal(boolean shutdown, boolean cashshop) {//once per\n                                                                 family.\n                                                         }\n                                                         */\n-                                                        for (MapleQuestStatus status : player.getStartedQuests()) { //This is for those quests that you have to stay logged in for a certain amount of time\n-                                                                MapleQuest quest = status.getQuest();\n-                                                                if (quest.getTimeLimit() > 0) {\n-                                                                        MapleQuestStatus newStatus = new MapleQuestStatus(quest, MapleQuestStatus.Status.NOT_STARTED);\n-                                                                        newStatus.setForfeited(player.getQuest(quest).getForfeited() + 1);\n-                                                                        player.updateQuestStatus(newStatus);\n-                                                                }\n-                                                        }\t                   \n+                                                        \n+                                                        player.forfeitExpirableQuests();    //This is for those quests that you have to stay logged in for a certain amount of time\n+                                                        \n                                                         if (guild != null) {\n                                                                 final Server server = Server.getInstance();\n                                                                 server.setGuildMemberOnline(player, false, player.getClient().getChannel());\n@@ -1059,7 +1053,8 @@ private void disconnectInternal(boolean shutdown, boolean cashshop) {//once per\n                                 MapleSessionCoordinator.getInstance().closeSession(session, false);\n                                 session.removeAttribute(MapleClient.CLIENT_KEY);\n                         }\n-                        if (!Server.getInstance().hasCharacteridInTransition(session)) {\n+                        \n+                        if (!Server.getInstance().hasCharacteridInTransition(this)) {\n                                 updateLoginState(MapleClient.LOGIN_NOTLOGGEDIN);\n                         }\n                         \n@@ -1085,6 +1080,12 @@ private void clear() {\n \t\tthis.send = null;\n \t\t//this.session = null;\n \t}\n+        \n+        public void setCharacterOnSessionTransitionState(int cid) {\n+                this.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n+                session.setAttribute(MapleClient.CLIENT_TRANSITION);\n+                Server.getInstance().setCharacteridInTransition(this, cid);\n+        }\n \n \tpublic int getChannel() {\n \t\treturn channel;\n@@ -1544,8 +1545,7 @@ public void changeChannel(int channel) {\n                 \n                 player.saveCharToDB();\n \t\t\n-                player.getClient().updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-\t\tplayer.setSessionTransitionState();\n+                player.setSessionTransitionState();\n                 try {\n \t\t\tannounce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));\n \t\t} catch (IOException e) {"}, {"sha": "235362d78fc1aecaa92325111f762ed16c6d35de", "filename": "src/client/MonsterBook.java", "status": "modified", "additions": 28, "deletions": 2, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MonsterBook.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/MonsterBook.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/MonsterBook.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -29,6 +29,7 @@\n import java.util.LinkedHashMap;\n import java.util.Map;\n import java.util.Map.Entry;\n+import java.util.HashSet;\n import java.util.Set;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.Semaphore;\n@@ -46,10 +47,10 @@\n     private Map<Integer, Integer> cards = new LinkedHashMap<>();\n     private Lock lock = MonitoredReentrantLockFactory.createLock(MonitoredLockType.BOOK);\n \n-    private Set<Entry<Integer, Integer>> getCardSet() {\n+    public Set<Entry<Integer, Integer>> getCardSet() {\n         lock.lock();\n         try {\n-            return Collections.unmodifiableSet(cards.entrySet());\n+            return new HashSet<>(cards.entrySet());\n         } finally {\n             lock.unlock();\n         }\n@@ -242,4 +243,29 @@ public void saveCards(final int charid) {\n             e.printStackTrace();\n         }\n     }\n+    \n+    public static int[] getCardTierSize() {\n+        try {\n+            Connection con = DatabaseConnection.getConnection();\n+            PreparedStatement ps = con.prepareStatement(\"SELECT COUNT(*) FROM monstercarddata GROUP BY floor(cardid / 1000);\");\n+            ResultSet rs = ps.executeQuery();\n+            \n+            rs.last();\n+            int[] tierSizes = new int[rs.getRow()];\n+            rs.beforeFirst();\n+            \n+            while (rs.next()) {\n+                tierSizes[rs.getRow() - 1] = rs.getInt(1);\n+            }\n+            \n+            rs.close();\n+            ps.close();\n+            con.close();\n+            \n+            return tierSizes;\n+        } catch (SQLException e) {\n+            e.printStackTrace();\n+            return new int[0];\n+        }\n+    }\n }"}, {"sha": "abd54a85c0088753e40a8ace00628e905fda4a0f", "filename": "src/client/command/commands/gm6/WarpWorldCommand.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/command/commands/gm6/WarpWorldCommand.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/command/commands/gm6/WarpWorldCommand.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/command/commands/gm6/WarpWorldCommand.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -52,7 +52,6 @@ public void execute(MapleClient c, String[] params) {\n                 String[] socket = server.getInetSocket(worldb, c.getChannel());\n                 c.getWorldServer().removePlayer(player);\n                 player.getMap().removePlayer(player);//LOL FORGOT THIS ><\n-                c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n                 player.setSessionTransitionState();\n                 player.setWorld(worldb);\n                 player.saveCharToDB();//To set the new world :O (true because else 2 player instances are created, one in both worlds)"}, {"sha": "68ce8d698bc2313d1698ecaf2d907bb684c0c9df", "filename": "src/client/inventory/manipulator/MapleInventoryManipulator.java", "status": "modified", "additions": 12, "deletions": 30, "changes": 42, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/inventory/manipulator/MapleInventoryManipulator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/inventory/manipulator/MapleInventoryManipulator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/inventory/manipulator/MapleInventoryManipulator.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -72,21 +72,12 @@ public static boolean addById(MapleClient c, int itemId, short quantity, String\n         MapleCharacter chr = c.getPlayer();\n         MapleInventoryType type = ItemConstants.getInventoryType(itemId);\n         \n-        if (c.tryacquireClient()) {\n-            try {\n-                MapleInventory inv = chr.getInventory(type);\n-                inv.lockInventory();\n-                try {\n-                    return addByIdInternal(c, chr, type, inv, itemId, quantity, owner, petid, flag, expiration);\n-                } finally {\n-                    inv.unlockInventory();\n-                }\n-            } finally {\n-                c.releaseClient();\n-            }\n-        } else {\n-            c.announce(MaplePacketCreator.enableActions());\n-            return false;\n+        MapleInventory inv = chr.getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            return addByIdInternal(c, chr, type, inv, itemId, quantity, owner, petid, flag, expiration);\n+        } finally {\n+            inv.unlockInventory();\n         }\n     }\n     \n@@ -187,21 +178,12 @@ public static boolean addFromDrop(MapleClient c, Item item, boolean show, int pe\n         MapleCharacter chr = c.getPlayer();\n         MapleInventoryType type = item.getInventoryType();\n         \n-        if (c.tryacquireClient()) {\n-            try {\n-                MapleInventory inv = chr.getInventory(type);\n-                inv.lockInventory();\n-                try {\n-                    return addFromDropInternal(c, chr, type, inv, item, show, petId);\n-                } finally {\n-                    inv.unlockInventory();\n-                }\n-            } finally {\n-                c.releaseClient();\n-            }\n-        } else {\n-            c.announce(MaplePacketCreator.enableActions());\n-            return false;\n+        MapleInventory inv = chr.getInventory(type);\n+        inv.lockInventory();\n+        try {\n+            return addFromDropInternal(c, chr, type, inv, item, show, petId);\n+        } finally {\n+            inv.unlockInventory();\n         }\n     }\n     "}, {"sha": "0bb2c79c30db3e9ab4a7feb1e7e839e9f268b7e5", "filename": "src/client/processor/action/PetAutopotProcessor.java", "status": "modified", "additions": 23, "deletions": 11, "changes": 34, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/action/PetAutopotProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/action/PetAutopotProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/action/PetAutopotProcessor.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -88,6 +88,12 @@ public void run() {\n             \n             int useCount = 0, qtyCount = 0;\n             MapleStatEffect stat = null;\n+            \n+            maxHp = chr.getCurrentMaxHp();\n+            maxMp = chr.getCurrentMaxMp();\n+\n+            curHp = chr.getHp();\n+            curMp = chr.getMp();\n \n             MapleInventory useInv = chr.getInventory(MapleInventoryType.USE);\n             useInv.lockInventory();\n@@ -112,13 +118,7 @@ public void run() {\n                     stat = MapleItemInformationProvider.getInstance().getItemEffect(toUse.getItemId());\n                     hasHpGain = stat.getHp() > 0 || stat.getHpRate() > 0.0;\n                     hasMpGain = stat.getMp() > 0 || stat.getMpRate() > 0.0;\n-\n-                    maxHp = chr.getCurrentMaxHp();\n-                    maxMp = chr.getCurrentMaxMp();\n-\n-                    curHp = chr.getHp();\n-                    curMp = chr.getMp();\n-\n+                    \n                     incHp = stat.getHp();\n                     if(incHp <= 0 && hasHpGain) incHp = Math.ceil(maxHp * stat.getHpRate());\n \n@@ -127,11 +127,21 @@ public void run() {\n \n                     if (YamlConfig.config.server.USE_COMPULSORY_AUTOPOT) {\n                         if (hasHpGain) {\n-                            qtyCount = (int) Math.ceil(((YamlConfig.config.server.PET_AUTOHP_RATIO * maxHp) - curHp) / incHp);\n+                            double hpRatio = (YamlConfig.config.server.PET_AUTOHP_RATIO * maxHp) - curHp;\n+                            if (hpRatio > 0.0) {\n+                                qtyCount = (int) Math.ceil(hpRatio / incHp);\n+                            }\n                         }\n \n                         if (hasMpGain) {\n-                            qtyCount = Math.max(qtyCount, (int) Math.ceil(((YamlConfig.config.server.PET_AUTOMP_RATIO * maxMp) - curMp) / incMp));\n+                            double mpRatio = ((YamlConfig.config.server.PET_AUTOMP_RATIO * maxMp) - curMp);\n+                            if (mpRatio > 0.0) {\n+                                qtyCount = Math.max(qtyCount, (int) Math.ceil(mpRatio / incMp));\n+                            }\n+                        }\n+                        \n+                        if (qtyCount < 0) { // thanks Flint, Kevs for noticing an issue where negative counts were getting achieved\n+                            qtyCount = 0;\n                         }\n                     } else {\n                         qtyCount = 1;   // non-compulsory autopot concept thanks to marcuswoon\n@@ -162,8 +172,10 @@ public void run() {\n                 useInv.unlockInventory();\n             }\n \n-            for (int i = 0; i < useCount; i++) {\n-                stat.applyTo(chr);\n+            if (stat != null) {\n+                for (int i = 0; i < useCount; i++) {\n+                    stat.applyTo(chr);\n+                }\n             }\n \n             chr.announce(MaplePacketCreator.enableActions());"}, {"sha": "dcf2488e93780766a7fb54ea7da096c134987a35", "filename": "src/client/processor/stat/AssignAPProcessor.java", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/stat/AssignAPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/stat/AssignAPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/stat/AssignAPProcessor.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -348,14 +348,7 @@ public static void APAutoAssignAction(SeekableLittleEndianAccessor slea, MapleCl\n                 if(slea.available() < 16) {\n                     AutobanFactory.PACKET_EDIT.alert(chr, \"Didn't send full packet for Auto Assign.\");\n                     \n-                    final MapleClient client = c;\n-                    ThreadManager.getInstance().newTask(new Runnable() {\n-                        @Override\n-                        public void run() {\n-                            client.disconnect(false, false);\n-                        }\n-                    });\n-                    \n+                    c.disconnect(true, false);\n                     return;\n                 }\n                 "}, {"sha": "cf100fd8ceb61cee9af4cfcaded977e9e2495b1a", "filename": "src/client/processor/stat/AssignSPProcessor.java", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/stat/AssignSPProcessor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/client/processor/stat/AssignSPProcessor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/client/processor/stat/AssignSPProcessor.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -51,14 +51,7 @@ public static boolean canSPAssign(MapleClient c, int skillid) {\n             AutobanFactory.PACKET_EDIT.alert(player, \"tried to packet edit in distributing sp.\");\n             FilePrinter.printError(FilePrinter.EXPLOITS + c.getPlayer().getName() + \".txt\", c.getPlayer().getName() + \" tried to use skill \" + skillid + \" without it being in their job.\");\n \n-            final MapleClient client = c;\n-            ThreadManager.getInstance().newTask(new Runnable() {\n-                @Override\n-                public void run() {\n-                    client.disconnect(true, false);\n-                }\n-            });\n-\n+            c.disconnect(true, false);\n             return false;\n         }\n         "}, {"sha": "ea40b0b2ad97109648ec7442117086d00f28ca7a", "filename": "src/config/ServerConfig.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/config/ServerConfig.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/config/ServerConfig.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/config/ServerConfig.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -187,7 +187,7 @@\n     public boolean USE_ENHANCED_CHSCROLL;\n     public boolean USE_ENHANCED_CRAFTING;\n     public boolean USE_ENHANCED_CLNSLATE;\n-    public int SCROLL_CHANCE_RATE;\n+    public int SCROLL_CHANCE_ROLLS;\n     public int CHSCROLL_STAT_RATE;\n     public int CHSCROLL_STAT_RANGE;\n "}, {"sha": "ea8174cfe409991883d79fd89ca9b4a42c247090", "filename": "src/constants/game/GameConstants.java", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/constants/game/GameConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/constants/game/GameConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/game/GameConstants.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -490,18 +490,6 @@ public static int getJobMaxLevel(MapleJob job) {\n         }\n     }\n     \n-    public static int getHiddenSkill(final int skill) {\n-        switch (skill) {\n-            case Aran.HIDDEN_FULL_DOUBLE:\n-            case Aran.HIDDEN_FULL_TRIPLE:\n-                return Aran.FULL_SWING;\n-            case Aran.HIDDEN_OVER_DOUBLE:\n-            case Aran.HIDDEN_OVER_TRIPLE:\n-                return Aran.OVER_SWING;\n-        }\n-        return skill;\n-    }\n-    \n     public static int getSkillBook(final int job) {\n         if (job >= 2210 && job <= 2218) {\n              return job - 2209;"}, {"sha": "dae6df6b895974add091c129af7d39eb596a3a66", "filename": "src/constants/inventory/ItemConstants.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/constants/inventory/ItemConstants.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/constants/inventory/ItemConstants.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/constants/inventory/ItemConstants.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -170,11 +170,11 @@ public static boolean isExpCoupon(int couponId) {\n     }\n     \n     public static boolean isPartyItem(int itemId) {\n-        return itemId >= 2022430 && itemId <= 2022433;\n+        return itemId >= 2022430 && itemId <= 2022433 || itemId >= 2022160 && itemId <= 2022163;\n     }\n     \n     public static boolean isPartyAllcure(int itemId) {\n-        return itemId == 2022433;\n+        return itemId == 2022433 || itemId == 2022163;\n     }\n     \n     public static boolean isHiredMerchant(int itemId) {"}, {"sha": "3922c847c8149f22166d953385bcdbd49e409765", "filename": "src/net/MapleServerHandler.java", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/MapleServerHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/MapleServerHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/MapleServerHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -242,14 +242,14 @@ private void manageIdleSessions() {\n         long timeNow = Server.getInstance().getCurrentTime();\n         long timeThen = timeNow - 15000;\n         \n+        Set<MapleClient> pingClients = new HashSet<>();\n         idleLock.lock();\n         try {\n             for(Entry<MapleClient, Long> mc : idleSessions.entrySet()) {\n                 if(timeNow - mc.getValue() >= 15000) {\n-                    mc.getKey().testPing(timeThen);\n+                    pingClients.add(mc.getKey());\n                 }\n             }\n-            \n             idleSessions.clear();\n             \n             if(!tempIdleSessions.isEmpty()) {\n@@ -267,6 +267,10 @@ private void manageIdleSessions() {\n         } finally {\n             idleLock.unlock();\n         }\n+        \n+        for(MapleClient c : pingClients) {\n+            c.testPing(timeThen);\n+        }\n     }\n     \n     private void idleManagerTask() {"}, {"sha": "30695ab3f846616ebdba027720b4fcd93187015e", "filename": "src/net/mina/MaplePacketDecoder.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/mina/MaplePacketDecoder.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/mina/MaplePacketDecoder.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/mina/MaplePacketDecoder.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -33,7 +33,6 @@\n import tools.MapleAESOFB;\n import tools.data.input.ByteArrayByteStream;\n import tools.data.input.GenericLittleEndianAccessor;\n-import net.opcodes.RecvOpcode;\n import tools.FilePrinter;\n \n public class MaplePacketDecoder extends CumulativeProtocolDecoder {"}, {"sha": "b8f0e62a5006915c486043bc9e1379e591d5c0d1", "filename": "src/net/server/Server.java", "status": "modified", "additions": 11, "deletions": 12, "changes": 23, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/Server.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/Server.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/Server.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -106,7 +106,6 @@\n import tools.DatabaseConnection;\n import tools.FilePrinter;\n import tools.Pair;\n-import org.apache.mina.core.session.IoSession;\n \n public class Server {\n     \n@@ -1730,12 +1729,12 @@ public void loadAccountStorages(MapleClient c) {\n         }\n     }\n     \n-    private static String getRemoteIp(IoSession session) {\n-        return MapleSessionCoordinator.getSessionRemoteAddress(session);\n+    private static String getRemoteHost(MapleClient client) {\n+        return MapleSessionCoordinator.getSessionRemoteHost(client.getSession());\n     }\n     \n-    public void setCharacteridInTransition(IoSession session, int charId) {\n-        String remoteIp = getRemoteIp(session);\n+    public void setCharacteridInTransition(MapleClient client, int charId) {\n+        String remoteIp = getRemoteHost(client);\n         \n         lgnWLock.lock();\n         try {\n@@ -1745,12 +1744,12 @@ public void setCharacteridInTransition(IoSession session, int charId) {\n         }\n     }\n     \n-    public boolean validateCharacteridInTransition(IoSession session, int charId) {\n+    public boolean validateCharacteridInTransition(MapleClient client, int charId) {\n         if (!YamlConfig.config.server.USE_IP_VALIDATION) {\n             return true;\n         }\n         \n-        String remoteIp = getRemoteIp(session);\n+        String remoteIp = getRemoteHost(client);\n         \n         lgnWLock.lock();\n         try {\n@@ -1761,12 +1760,12 @@ public boolean validateCharacteridInTransition(IoSession session, int charId) {\n         }\n     }\n     \n-    public Integer freeCharacteridInTransition(IoSession session) {\n+    public Integer freeCharacteridInTransition(MapleClient client) {\n         if (!YamlConfig.config.server.USE_IP_VALIDATION) {\n             return null;\n         }\n         \n-        String remoteIp = getRemoteIp(session);\n+        String remoteIp = getRemoteHost(client);\n         \n         lgnWLock.lock();\n         try {\n@@ -1776,13 +1775,13 @@ public Integer freeCharacteridInTransition(IoSession session) {\n         }\n     }\n     \n-    public boolean hasCharacteridInTransition(IoSession session) {\n+    public boolean hasCharacteridInTransition(MapleClient client) {\n         if (!YamlConfig.config.server.USE_IP_VALIDATION) {\n             return true;\n         }\n         \n-        String remoteIp = getRemoteIp(session);\n-        \n+        String remoteIp = getRemoteHost(client);\n+                \n         lgnRLock.lock();\n         try {\n             return transitioningChars.containsKey(remoteIp);"}, {"sha": "df6b7440f0d3f5a99a6520f8ba80ef90d9a7e82f", "filename": "src/net/server/channel/Channel.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/Channel.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/Channel.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/Channel.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -375,7 +375,7 @@ private void disconnectAwayPlayers() {\n         for (Integer cid : playersAway) {\n             MapleCharacter chr = wserv.getPlayerStorage().getCharacterById(cid);\n             if (chr != null && chr.isLoggedin()) {\n-                chr.getClient().disconnect(true, false);\n+                chr.getClient().forceDisconnect();\n             }\n         }\n     }"}, {"sha": "d0455c3c991ca045265cad11f9b56c5a2ae2ad60", "filename": "src/net/server/channel/handlers/AbstractDealDamageHandler.java", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/AbstractDealDamageHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/AbstractDealDamageHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -113,10 +113,11 @@\n         public boolean ranged, magic;\n         public int speed = 4;\n         public Point position = new Point();\n+        \n         public MapleStatEffect getAttackEffect(MapleCharacter chr, Skill theSkill) {\n             Skill mySkill = theSkill;\n             if (mySkill == null) {\n-                mySkill = SkillFactory.getSkill(GameConstants.getHiddenSkill(skill));\n+                mySkill = SkillFactory.getSkill(skill);\n             }\n             \n             int skillLevel = chr.getSkillLevel(mySkill);\n@@ -149,8 +150,8 @@ protected void applyAttack(AttackInfo attack, final MapleCharacter player, int a\n                 return;\n             }\n             if (attack.skill != 0) {\n-                theSkill = SkillFactory.getSkill(GameConstants.getHiddenSkill(attack.skill)); //returns back the skill id if its not a hidden skill so we are gucci\n-                attackEffect = attack.getAttackEffect(player, theSkill);\n+                theSkill = SkillFactory.getSkill(attack.skill); // thanks Conrad for noticing some Aran skills not consuming MP\n+                attackEffect = attack.getAttackEffect(player, theSkill); //returns back the player's attack effect so we are gucci\n                 if (attackEffect == null) {\n                     player.announce(MaplePacketCreator.enableActions());\n                     return;"}, {"sha": "74a4cdbae95ef055a05612b5b0e965d9563aad11", "filename": "src/net/server/channel/handlers/CancelChairHandler.java", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/CancelChairHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/CancelChairHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CancelChairHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -37,6 +37,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n-        mc.sitChair(id);\n+        if (c.tryacquireClient()) {\n+            try {\n+                mc.sitChair(id);\n+            } finally {\n+                c.releaseClient();\n+            }\n+        }\n     }\n }"}, {"sha": "ea776e240e791ba83c4b40f66e9d3370d9481453", "filename": "src/net/server/channel/handlers/CashOperationHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/CashOperationHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/CashOperationHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/CashOperationHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -40,7 +40,6 @@\n import server.CashShop.CashItem;\n import server.CashShop.CashItemFactory;\n import client.inventory.manipulator.MapleInventoryManipulator;\n-import constants.net.ServerConstants;\n import server.MapleItemInformationProvider;\n import tools.FilePrinter;\n import tools.MaplePacketCreator;"}, {"sha": "40700b28b078ae24b7a230f55bd5bec1660be878", "filename": "src/net/server/channel/handlers/ChangeMapHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/ChangeMapHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/ChangeMapHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/ChangeMapHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -62,7 +62,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n \t\t\tString[] socket = c.getChannelServer().getIP().split(\":\");\n \t\t\tchr.getCashShop().open(false);\n \t\t\t\n-                        c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n                         chr.setSessionTransitionState();\n \t\t\ttry {\n \t\t\t\tc.announce(MaplePacketCreator.getChannelChange(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1])));"}, {"sha": "137e48b2b948a912b0798a910d8bd973dfc7eded", "filename": "src/net/server/channel/handlers/PlayerLoggedinHandler.java", "status": "modified", "additions": 23, "deletions": 22, "changes": 45, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/PlayerLoggedinHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/PlayerLoggedinHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -126,13 +126,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                 }\n \n                 MapleCharacter player = wserv.getPlayerStorage().getCharacterById(cid);\n-                boolean newcomer = false;\n-                \n                 IoSession session = c.getSession();\n-                if (!server.validateCharacteridInTransition(session, cid)) {\n-                    c.disconnect(true, false);\n-                    return;\n-                }\n                 \n                 String remoteHwid;\n                 if (player == null) {\n@@ -141,25 +135,37 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         c.disconnect(true, false);\n                         return;\n                     }\n-\n+                } else {\n+                    remoteHwid = player.getClient().getHWID();\n+                }\n+                \n+                int hwidLen = remoteHwid.length();\n+                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n+                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n+                c.setHWID(remoteHwid);\n+                \n+                if (!server.validateCharacteridInTransition(c, cid)) {\n+                    c.disconnect(true, false);\n+                    return;\n+                }\n+                \n+                boolean newcomer = false;\n+                if (player == null) {\n                     try {\n                         player = MapleCharacter.loadCharFromDB(cid, c, true);\n                         newcomer = true;\n                     } catch (SQLException e) {\n                         e.printStackTrace();\n                     }\n-                } else {\n-                    remoteHwid = player.getClient().getHWID();\n-                }\n-\n-                if (player == null) { //If you are still getting null here then please just uninstall the game >.>, we dont need you fucking with the logs\n-                    c.disconnect(true, false);\n-                    return;\n+                    \n+                    if (player == null) { //If you are still getting null here then please just uninstall the game >.>, we dont need you fucking with the logs\n+                        c.disconnect(true, false);\n+                        return;\n+                    }\n                 }\n-\n                 c.setPlayer(player);\n                 c.setAccID(player.getAccountID());\n-\n+                \n                 boolean allowLogin = true;\n \n                 /*  is this check really necessary?\n@@ -211,11 +217,6 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                     player.newClient(c);\n                 }\n \n-                int hwidLen = remoteHwid.length();\n-                session.setAttribute(MapleClient.CLIENT_HWID, remoteHwid);\n-                session.setAttribute(MapleClient.CLIENT_NIBBLEHWID, remoteHwid.substring(hwidLen - 8, hwidLen));\n-                c.setHWID(remoteHwid);\n-\n                 cserv.addPlayer(player);\n                 wserv.addPlayer(player);\n                 player.setEnteredChannelWorld();\n@@ -386,7 +387,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                         player.announceBattleshipHp();\n                     }\n                 }\n-\n+                \n                 player.buffExpireTask();\n                 player.diseaseExpireTask();\n                 player.skillCooldownTask();"}, {"sha": "cf988013d80610a4421e78913db2807029529be4", "filename": "src/net/server/channel/handlers/SpecialMoveHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/SpecialMoveHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/SpecialMoveHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/SpecialMoveHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -33,7 +33,6 @@\n import client.MapleClient;\n import client.Skill;\n import client.SkillFactory;\n-import constants.net.ServerConstants;\n import constants.skills.Brawler;\n import constants.skills.Corsair;\n import constants.skills.DarkKnight;"}, {"sha": "7146eba05de2884988f7c8d0e17978b2597c7c23", "filename": "src/net/server/channel/handlers/UseCashItemHandler.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseCashItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseCashItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseCashItemHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -635,11 +635,11 @@ private static void remove(MapleClient c, short position, int itemid) {\n                     position = it.getPosition();\n                 }\n             }\n+            \n+            MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, position, (short) 1, true, false);\n         } finally {\n             cashInv.unlockInventory();\n         }\n-        \n-        MapleInventoryManipulator.removeFromSlot(c, MapleInventoryType.CASH, position, (short) 1, true, false);\n     }\n \n     private static boolean getIncubatedItem(MapleClient c, int id) {"}, {"sha": "857fcdb704612ee41c34b8be65d6dfffa3a6f919", "filename": "src/net/server/channel/handlers/UseChairHandler.java", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseChairHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseChairHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseChairHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -37,6 +37,12 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             return;\n         }\n         \n-        c.getPlayer().sitChair(itemId);\n+        if (c.tryacquireClient()) {\n+            try {\n+                c.getPlayer().sitChair(itemId);\n+            } finally {\n+                c.releaseClient();\n+            }\n+        }\n     }\n }"}, {"sha": "61f04cfec58ca92f30f50fbc48c5bdcf40fc0257", "filename": "src/net/server/channel/handlers/UseItemHandler.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseItemHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseItemHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseItemHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -53,7 +53,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         int itemId = slea.readInt();\n         Item toUse = chr.getInventory(MapleInventoryType.USE).getItem(slot);\n         if (toUse != null && toUse.getQuantity() > 0 && toUse.getItemId() == itemId) {\n-            if (itemId == 2022178 || itemId == 2050004) {\n+            if (itemId == 2050004) {\n                 chr.dispelDebuffs();\n                 remove(c, slot);\n                 return;"}, {"sha": "3325baa28045851c11a1ebf268043ff5288b016c", "filename": "src/net/server/channel/handlers/UseMountFoodHandler.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseMountFoodHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/UseMountFoodHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/UseMountFoodHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -31,7 +31,6 @@\n import net.AbstractMaplePacketHandler;\n import client.inventory.manipulator.MapleInventoryManipulator;\n import tools.MaplePacketCreator;\n-import tools.Pair;\n import tools.data.input.SeekableLittleEndianAccessor;\n \n /**"}, {"sha": "2c51dd728c7b2ac190c36f1745e4dfce18b13cbf", "filename": "src/net/server/channel/handlers/WeddingHandler.java", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/WeddingHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/channel/handlers/WeddingHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/channel/handlers/WeddingHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -58,20 +58,18 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                         MapleInventoryType type = ItemConstants.getInventoryType(itemid);\n                                         MapleInventory chrInv = chr.getInventory(type);\n \n+                                        Item newItem = null;\n                                         chrInv.lockInventory();\n                                         try {\n                                             Item item = chrInv.getItem((byte) slot);\n                                             if (item != null) {\n                                                 if (!item.isUntradeable()) {\n                                                     if (itemid == item.getItemId() && quantity <= item.getQuantity()) {\n-                                                        Item newItem = item.copy();\n+                                                        newItem = item.copy();\n \n                                                         marriage.addGiftItem(groomWishlist, newItem);\n                                                         MapleInventoryManipulator.removeFromSlot(c, type, slot, quantity, false, false);\n-\n-                                                        if (YamlConfig.config.server.USE_ENFORCE_MERCHANT_SAVE) chr.saveCharToDB(false); \n-                                                        marriage.saveGiftItemsToDb(c, groomWishlist, cid);\n-\n+                                                        \n                                                         MapleKarmaManipulator.toggleKarmaFlagToUntradeable(newItem);\n                                                         marriage.setIntProperty(groomWishlistProp, giftCount + 1);\n \n@@ -84,6 +82,11 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n                                         } finally {\n                                             chrInv.unlockInventory();\n                                         }\n+                                        \n+                                        if (newItem != null) {\n+                                            if (YamlConfig.config.server.USE_ENFORCE_MERCHANT_SAVE) chr.saveCharToDB(false); \n+                                            marriage.saveGiftItemsToDb(c, groomWishlist, cid);\n+                                        }\n                                     } else {\n                                         c.announce(Wedding.OnWeddingGiftResult((byte) 0xE, marriage.getWishlistItems(groomWishlist), null));\n                                     }"}, {"sha": "421b4aec3dde315d5f383118973e0927600d9e6e", "filename": "src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "status": "modified", "additions": 34, "deletions": 29, "changes": 63, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/matchchecker/MapleMatchCheckerCoordinator.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -22,7 +22,6 @@\n import client.MapleCharacter;\n import net.server.PlayerStorage;\n import net.server.Server;\n-import net.server.coordinator.matchchecker.AbstractMatchCheckerListener;\n import net.server.coordinator.matchchecker.MatchCheckerListenerFactory.MatchCheckerType;\n import net.server.world.World;\n import java.util.Collections;\n@@ -260,28 +259,27 @@ public boolean isMatchConfirmationActive(int cid) {\n         }\n     }\n     \n-    private void createMatchConfirmationInternal(MatchCheckerType matchType, int world, int leaderCid, AbstractMatchCheckerListener leaderListener, Set<Integer> players, String message) {\n+    private MapleMatchCheckingElement createMatchConfirmationInternal(MatchCheckerType matchType, int world, int leaderCid, AbstractMatchCheckerListener leaderListener, Set<Integer> players, String message) {\n         MapleMatchCheckingElement mmce = new MapleMatchCheckingElement(matchType, leaderCid, world, leaderListener, players, message);\n         \n         for (Integer cid : players) {\n             matchEntries.put(cid, mmce);\n         }\n         \n-        mmce.dispatchMatchCreated();\n-        \n         acceptMatchElement(mmce, leaderCid);\n+        return mmce;\n     }\n     \n     public boolean createMatchConfirmation(MatchCheckerType matchType, int world, int leaderCid, Set<Integer> players, String message) {\n+        MapleMatchCheckingElement mmce = null;\n         try {\n             semaphorePool.acquire();\n             try {\n                 if (poolMatchPlayers(players)) {\n                     try {\n                         if (isMatchingAvailable(players)) {\n                             AbstractMatchCheckerListener leaderListener = matchType.getListener();\n-                            createMatchConfirmationInternal(matchType, world, leaderCid, leaderListener, players, message);\n-                            return true;\n+                            mmce = createMatchConfirmationInternal(matchType, world, leaderCid, leaderListener, players, message);\n                         } else {\n                             reenablePlayerMatching(players);\n                         }\n@@ -296,7 +294,12 @@ public boolean createMatchConfirmation(MatchCheckerType matchType, int world, in\n             ie.printStackTrace();\n         }\n         \n-        return false;\n+        if (mmce != null) {\n+            mmce.dispatchMatchCreated();\n+            return true;\n+        } else {\n+            return false;\n+        }\n     }\n     \n     private void disposeMatchElement(MapleMatchCheckingElement mmce) {\n@@ -320,52 +323,45 @@ private void acceptMatchElement(MapleMatchCheckingElement mmce, int cid) {\n         if (mmce.acceptEntry(cid)) {\n             unpoolMatchPlayer(cid);\n             disposeMatchElement(mmce);\n-            \n-            mmce.dispatchMatchResult(true);\n         }\n     }\n     \n     private void denyMatchElement(MapleMatchCheckingElement mmce, int cid) {\n         unpoolMatchPlayer(cid);\n         disposeMatchElement(mmce);\n-        \n-        mmce.dispatchMatchResult(false);\n     }\n     \n     private void dismissMatchElement(MapleMatchCheckingElement mmce, int cid) {\n         mmce.setMatchActive(false);\n         \n         unpoolMatchPlayer(cid);\n         disposeMatchElement(mmce);\n-        \n-        mmce.dispatchMatchDismissed();\n     }\n     \n     public boolean answerMatchConfirmation(int cid, boolean accept) {\n+        MapleMatchCheckingElement mmce = null;\n         try {\n             semaphorePool.acquire();\n             try {\n                 while (matchEntries.containsKey(cid)) {\n                     if (poolMatchPlayer(cid)) {\n                         try {\n-                            MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+                            mmce = matchEntries.get(cid);\n                             \n                             if (mmce != null) {\n                                 synchronized (mmce) {\n                                     if (!mmce.isMatchActive()) {    // thanks Alex (CanIGetaPR) for noticing that exploiters could stall on match checking\n                                         matchEntries.remove(cid);\n-                                        return false;\n-                                    }\n-                                    \n-                                    if (accept) {\n-                                        acceptMatchElement(mmce, cid);\n+                                        mmce = null;\n                                     } else {\n-                                        denyMatchElement(mmce, cid);\n-                                        matchEntries.remove(cid);\n+                                        if (accept) {\n+                                            acceptMatchElement(mmce, cid);\n+                                        } else {\n+                                            denyMatchElement(mmce, cid);\n+                                            matchEntries.remove(cid);\n+                                        }\n                                     }\n                                 }\n-                                \n-                                return true;\n                             }\n                         } finally {\n                             unpoolMatchPlayer(cid);\n@@ -379,26 +375,30 @@ public boolean answerMatchConfirmation(int cid, boolean accept) {\n             ie.printStackTrace();\n         }\n         \n+        if (mmce != null) {\n+            mmce.dispatchMatchResult(accept);\n+        }\n+        \n         return false;\n     }\n     \n     public boolean dismissMatchConfirmation(int cid) {\n+        MapleMatchCheckingElement mmce = null;\n         try {\n             semaphorePool.acquire();\n             try {\n                 while (matchEntries.containsKey(cid)) {\n                     if (poolMatchPlayer(cid)) {\n                         try {\n-                            MapleMatchCheckingElement mmce = matchEntries.get(cid);\n+                            mmce = matchEntries.get(cid);\n \n                             if (mmce != null) {\n                                 synchronized (mmce) {\n                                     if (!mmce.isMatchActive()) {\n-                                        return false;\n+                                        mmce = null;\n+                                    } else {\n+                                        dismissMatchElement(mmce, cid);\n                                     }\n-                                    \n-                                    dismissMatchElement(mmce, cid);\n-                                    return true;\n                                 }\n                             }\n                         } finally {\n@@ -413,7 +413,12 @@ public boolean dismissMatchConfirmation(int cid) {\n             ie.printStackTrace();\n         }\n         \n-        return false;\n+        if (mmce != null) {\n+            mmce.dispatchMatchDismissed();\n+            return true;\n+        } else {\n+            return false;\n+        }\n     }\n         \n }"}, {"sha": "cf922b2c58feb395c32b9d5e9c208b7f92db0700", "filename": "src/net/server/coordinator/session/MapleSessionCoordinator.java", "status": "modified", "additions": 21, "deletions": 8, "changes": 29, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/coordinator/session/MapleSessionCoordinator.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/coordinator/session/MapleSessionCoordinator.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/coordinator/session/MapleSessionCoordinator.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -224,6 +224,16 @@ private Lock getCoodinatorLock(String remoteHost) {\n     public static String getSessionRemoteAddress(IoSession session) {\n         return (String) session.getAttribute(MapleClient.CLIENT_REMOTE_ADDRESS);\n     }\n+    \n+    public static String getSessionRemoteHost(IoSession session) {\n+        String nibbleHwid = (String) session.getAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+        \n+        if (nibbleHwid != null) {\n+            return getSessionRemoteAddress(session) + \"-\" + nibbleHwid;\n+        } else {\n+            return getSessionRemoteAddress(session);\n+        }\n+    }\n \n     private static MapleClient getSessionClient(IoSession session) {\n         return (MapleClient) session.getAttribute(MapleClient.CLIENT_KEY);\n@@ -246,7 +256,7 @@ public void updateOnlineSession(IoSession session) {\n     public boolean canStartLoginSession(IoSession session) {\n         if (!YamlConfig.config.server.DETERRED_MULTICLIENT) return true;\n \n-        String remoteHost = getSessionRemoteAddress(session);\n+        String remoteHost = getSessionRemoteHost(session);\n         Lock lock = getCoodinatorLock(remoteHost);\n \n         try {\n@@ -306,16 +316,17 @@ public boolean canStartLoginSession(IoSession session) {\n     }\n \n     public void closeLoginSession(IoSession session) {\n-        String remoteHost = getSessionRemoteAddress(session);\n+        String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+        String remoteHost = getSessionRemoteHost(session);\n+        \n         Set<IoSession> lrh = loginRemoteHosts.get(remoteHost);\n         if (lrh != null) {\n             lrh.remove(session);\n             if (lrh.isEmpty()) {\n                 loginRemoteHosts.remove(remoteHost);\n             }\n         }\n-\n-        String nibbleHwid = (String) session.removeAttribute(MapleClient.CLIENT_NIBBLEHWID);\n+        \n         if (nibbleHwid != null) {\n             onlineRemoteHwids.remove(nibbleHwid);\n \n@@ -337,7 +348,7 @@ public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbl\n             return AntiMulticlientResult.SUCCESS;\n         }\n \n-        String remoteHost = getSessionRemoteAddress(session);\n+        String remoteHost = getSessionRemoteHost(session);\n         Lock lock = getCoodinatorLock(remoteHost);\n \n         try {\n@@ -403,9 +414,10 @@ public AntiMulticlientResult attemptLoginSession(IoSession session, String nibbl\n     }\n \n     public AntiMulticlientResult attemptGameSession(IoSession session, int accountId, String remoteHwid) {\n-        String remoteHost = getSessionRemoteAddress(session);\n+        String remoteHost = getSessionRemoteHost(session);\n         if (!YamlConfig.config.server.DETERRED_MULTICLIENT) {\n             associateRemoteHostHwid(remoteHost, remoteHwid);\n+            associateRemoteHostHwid(getSessionRemoteAddress(session), remoteHwid);  // no HWID information on the loggedin newcomer session...\n             return AntiMulticlientResult.SUCCESS;\n         }\n         \n@@ -451,6 +463,7 @@ public AntiMulticlientResult attemptGameSession(IoSession session, int accountId\n                         // updated session CLIENT_HWID attribute will be set when the player log in the game\n                         onlineRemoteHwids.add(remoteHwid);\n                         associateRemoteHostHwid(remoteHost, remoteHwid);\n+                        associateRemoteHostHwid(getSessionRemoteAddress(session), remoteHwid);\n                         associateHwidAccountIfAbsent(remoteHwid, accountId);\n \n                         return AntiMulticlientResult.SUCCESS;\n@@ -486,7 +499,7 @@ private static MapleClient fetchInTransitionSessionClient(IoSession session) {\n             }\n             \n             MapleClient client = new MapleClient(null, null, session);\n-            Integer cid = Server.getInstance().freeCharacteridInTransition(session);\n+            Integer cid = Server.getInstance().freeCharacteridInTransition(client);\n             if (cid != null) {\n                 try {\n                     client.setAccID(MapleCharacter.loadCharFromDB(cid, client, false).getAccountID());\n@@ -535,7 +548,7 @@ public void closeSession(IoSession session, Boolean immediately) {\n     }\n     \n     public String getGameSessionHwid(IoSession session) {\n-        String remoteHost = getSessionRemoteAddress(session);\n+        String remoteHost = getSessionRemoteHost(session);\n         return cachedHostHwids.get(remoteHost);\n     }\n     "}, {"sha": "e378ad1b6cc8fe84bdc0dd9643ef69b06856a751", "filename": "src/net/server/handlers/login/CharSelectedHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/CharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/CharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -101,8 +101,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         server.unregisterLoginState(c);\n-        c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition(session, charId);\n+        c.setCharacterOnSessionTransitionState(charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "26f89ccd218f25045e6261eb804c56c28487fd8f", "filename": "src/net/server/handlers/login/CharSelectedWithPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/CharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/CharSelectedWithPicHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -84,8 +84,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             }\n             \n             server.unregisterLoginState(c);\n-            c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition(session, charId);\n+            c.setCharacterOnSessionTransitionState(charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "4de8d673fe732ddee851270d993e996f93b5e3dd", "filename": "src/net/server/handlers/login/RegisterPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/RegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/RegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/RegisterPicHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -86,8 +86,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n             }\n             \n             server.unregisterLoginState(c);\n-            c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition(session, charId);\n+            c.setCharacterOnSessionTransitionState(charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "a4a9f5235b999e6f2524091fbdd86d771f6ffd62", "filename": "src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharRegisterPicHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -89,8 +89,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         server.unregisterLoginState(c);\n-        c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition(session, charId);\n+        c.setCharacterOnSessionTransitionState(charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "e2f458b4bb25e4bae5122ba066bbb586594615fc", "filename": "src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharSelectedHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -112,8 +112,7 @@ public final void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c)\n         }\n         \n         server.unregisterLoginState(c);\n-        c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-        server.setCharacteridInTransition(session, charId);\n+        c.setCharacterOnSessionTransitionState(charId);\n         \n         try {\n             c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "aeb6e3208b9dad0f18fa0148ffe280687d6b85a1", "filename": "src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/handlers/login/ViewAllCharSelectedWithPicHandler.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -90,8 +90,7 @@ public void handlePacket(SeekableLittleEndianAccessor slea, MapleClient c) {\n             }\n             \n             server.unregisterLoginState(c);\n-            c.updateLoginState(MapleClient.LOGIN_SERVER_TRANSITION);\n-            server.setCharacteridInTransition(session, charId);\n+            c.setCharacterOnSessionTransitionState(charId);\n             \n             try {\n                 c.announce(MaplePacketCreator.getServerIP(InetAddress.getByName(socket[0]), Integer.parseInt(socket[1]), charId));"}, {"sha": "7d0d40191becf7c372f211b572df8931216c7473", "filename": "src/net/server/world/MapleParty.java", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/world/MapleParty.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/net/server/world/MapleParty.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/net/server/world/MapleParty.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -356,7 +356,7 @@ public static boolean createParty(MapleCharacter player, boolean silentCheck) {\n             party = player.getWorldServer().createParty(partyplayer);\n             player.setParty(party);\n             player.setMPC(partyplayer);\n-            player.getMap().addPartyMember(player);\n+            player.getMap().addPartyMember(player, party.getId());\n             player.silentPartyUpdate();\n             \n             player.updatePartySearchAvailability(false);\n@@ -383,7 +383,7 @@ public static boolean joinParty(MapleCharacter player, int partyid, boolean sile\n             if (party != null) {\n                 if (party.getMembers().size() < 6) {\n                     MaplePartyCharacter partyplayer = new MaplePartyCharacter(player);\n-                    player.getMap().addPartyMember(player);\n+                    player.getMap().addPartyMember(player, party.getId());\n                     \n                     world.updateParty(party.getId(), PartyOperation.JOIN, partyplayer);\n                     player.receivePartyMemberHP();\n@@ -433,7 +433,7 @@ public static void leaveParty(MapleParty party, MapleClient c) {\n             } else {\n                 MapleMap map = player.getMap();\n                 if (map != null) {\n-                    map.removePartyMember(player);\n+                    map.removePartyMember(player, party.getId());\n                 }\n                 \n                 MonsterCarnival mcpq = player.getMonsterCarnival();\n@@ -472,7 +472,7 @@ public static void expelFromParty(MapleParty party, MapleClient c, int expelCid)\n                         List<MapleCharacter> partyMembers = emc.getPartyMembersOnline();\n \n                         MapleMap map = emc.getMap();\n-                        if(map != null) map.removePartyMember(emc);\n+                        if(map != null) map.removePartyMember(emc, party.getId());\n                         \n                         MonsterCarnival mcpq = player.getMonsterCarnival();\n                         if (mcpq != null) {"}, {"sha": "2df36ef2a592e13fdff3d1c5cfe08f22a4e5ed7c", "filename": "src/scripting/npc/NPCConversationManager.java", "status": "modified", "additions": 53, "deletions": 2, "changes": 55, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/scripting/npc/NPCConversationManager.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/scripting/npc/NPCConversationManager.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/scripting/npc/NPCConversationManager.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -719,6 +719,45 @@ private void warpoutCPQLobby(MapleMap lobbyMap) {\n                 mc.changeMap(out, out.getPortal(0));\n             }\n         }\n+        \n+        private int isCPQParty(MapleMap lobby, MapleParty party) {\n+            int cpqMinLvl, cpqMaxLvl;\n+            \n+            if (lobby.isCPQLobby()) {\n+                cpqMinLvl = 30;\n+                cpqMaxLvl = 50;\n+            } else {\n+                cpqMinLvl = 51;\n+                cpqMaxLvl = 70;\n+            }\n+            \n+            List<MaplePartyCharacter> partyMembers = party.getPartyMembers();\n+            for (MaplePartyCharacter pchr : partyMembers) {\n+                if (pchr.getLevel() >= cpqMinLvl && pchr.getLevel() <= cpqMaxLvl) {\n+                    if (lobby.getCharacterById(pchr.getId()) == null) {\n+                        return 1;  // party member detected out of area\n+                    }\n+                } else {\n+                    return 2;  // party member doesn't fit requirements\n+                }\n+            }\n+            \n+            return 0;\n+        }\n+        \n+        private int canStartCPQ(MapleMap lobby, MapleParty party, MapleParty challenger) {\n+            int ret = isCPQParty(lobby, party);\n+            if (ret != 0) {\n+                return ret;\n+            }\n+            \n+            ret = isCPQParty(lobby, challenger);\n+            if (ret != 0) {\n+                return -ret;\n+            }\n+            \n+            return 0;\n+        }\n \n         public void startCPQ(final MapleCharacter challenger, final int field) {\n             try {\n@@ -779,7 +818,13 @@ public void run() {\n                             return;\n                         }\n                         \n-                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, true, (field / 100) % 10);\n+                        MapleParty lobbyParty = getPlayer().getParty(), challengerParty = challenger.getParty();\n+                        int status = canStartCPQ(lobbyMap, lobbyParty, challengerParty);\n+                        if (status == 0) {\n+                            new MonsterCarnival(lobbyParty, challengerParty, mapid, true, (field / 100) % 10);\n+                        } else {\n+                            warpoutCPQLobby(lobbyMap);\n+                        }\n                     }\n                 }, 11000);\n             } catch (Exception e) {\n@@ -828,7 +873,13 @@ public void run() {\n                             return;\n                         }\n                         \n-                        new MonsterCarnival(getPlayer().getParty(), challenger.getParty(), mapid, false, (field / 1000) % 10);\n+                        MapleParty lobbyParty = getPlayer().getParty(), challengerParty = challenger.getParty();\n+                        int status = canStartCPQ(lobbyMap, lobbyParty, challengerParty);\n+                        if (status == 0) {\n+                            new MonsterCarnival(lobbyParty, challengerParty, mapid, false, (field / 1000) % 10);\n+                        } else {\n+                            warpoutCPQLobby(lobbyMap);\n+                        }\n                     }\n                 }, 10000);\n             } catch (Exception e) {"}, {"sha": "d0713ed1b6843945d41859c98ffc731c04aba4b9", "filename": "src/server/MapleItemInformationProvider.java", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleItemInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleItemInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleItemInformationProvider.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -101,6 +101,7 @@ public static MapleItemInformationProvider getInstance() {\n     protected Map<Integer, MapleData> equipLevelInfoCache = new HashMap<>();\n     protected Map<Integer, Integer> equipLevelReqCache = new HashMap<>();\n     protected Map<Integer, Integer> equipMaxLevelCache = new HashMap<>();\n+    protected Map<Integer, List<Integer>> scrollReqsCache = new HashMap<>();\n     protected Map<Integer, Integer> wholePriceCache = new HashMap<>();\n     protected Map<Integer, Double> unitPriceCache = new HashMap<>();\n     protected Map<Integer, Integer> projectileWatkCache = new HashMap<>();\n@@ -594,15 +595,20 @@ public Integer getEquipLevelReq(int itemId) {\n     }\n \n     public List<Integer> getScrollReqs(int itemId) {\n+        if (scrollReqsCache.containsKey(itemId)) {\n+            return scrollReqsCache.get(itemId);\n+        }\n+        \n         List<Integer> ret = new ArrayList<>();\n         MapleData data = getItemData(itemId);\n         data = data.getChildByPath(\"req\");\n-        if (data == null) {\n-            return ret;\n-        }\n-        for (MapleData req : data.getChildren()) {\n-            ret.add(MapleDataTool.getInt(req));\n+        if (data != null) {\n+            for (MapleData req : data.getChildren()) {\n+                ret.add(MapleDataTool.getInt(req));\n+            }\n         }\n+        \n+        scrollReqsCache.put(itemId, ret);\n         return ret;\n     }\n \n@@ -620,7 +626,7 @@ private static double testYourLuck(double prop, int dices) {   // revamped testY\n     }\n \n     public static boolean rollSuccessChance(double propPercent) {\n-        return Math.random() >= testYourLuck(propPercent / 100.0, YamlConfig.config.server.SCROLL_CHANCE_RATE);\n+        return Math.random() >= testYourLuck(propPercent / 100.0, YamlConfig.config.server.SCROLL_CHANCE_ROLLS);\n     }\n \n     private static short getMaximumShortMaxIfOverflow(int value1, int value2) {"}, {"sha": "8a4c912a087ba5d4e3b485ac9de93e7bc8dceed4", "filename": "src/server/MapleMarriage.java", "status": "modified", "additions": 19, "deletions": 36, "changes": 55, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleMarriage.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleMarriage.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleMarriage.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -69,18 +69,10 @@ public void initializeGiftItems() {\n     }\n \n     public List<Item> getGiftItems(MapleClient c, boolean groom) {\n-        if (c.tryacquireClient()) {\n-            try {\n-                List<Item> gifts = getGiftItemsList(groom);\n-                synchronized (gifts) {\n-                    return new LinkedList<>(gifts);\n-                }\n-            } finally {\n-                c.releaseClient();\n-            }\n+        List<Item> gifts = getGiftItemsList(groom);\n+        synchronized (gifts) {\n+            return new LinkedList<>(gifts);\n         }\n-        \n-        return new LinkedList<>();\n     }\n \n     private List<Item> getGiftItemsList(boolean groom) {\n@@ -130,7 +122,9 @@ public static boolean claimGiftItems(MapleClient c, MapleCharacter chr) {\n                 Connection con = DatabaseConnection.getConnection();\n                 ItemFactory.MARRIAGE_GIFTS.saveItems(new LinkedList<Pair<Item, MapleInventoryType>>(), chr.getId(), con);\n                 con.close();\n-            } catch (SQLException sqle) {}\n+            } catch (SQLException sqle) {\n+                sqle.printStackTrace();\n+            }\n \n             for (Item item : gifts) {\n                 MapleInventoryManipulator.addFromDrop(chr.getClient(), item, false);\n@@ -144,18 +138,13 @@ public static boolean claimGiftItems(MapleClient c, MapleCharacter chr) {\n         \n     public static List<Item> loadGiftItemsFromDb(MapleClient c, int cid) {\n         List<Item> items = new LinkedList<>();\n-        if (c.tryacquireClient()) {\n-            try {\n-                try {\n-                    for (Pair<Item, MapleInventoryType> it : ItemFactory.MARRIAGE_GIFTS.loadItems(cid, false)) {\n-                        items.add(it.getLeft());\n-                    }\n-                } catch (SQLException sqle) {\n-                    sqle.printStackTrace();\n-                }\n-            } finally {\n-                c.releaseClient();\n+        \n+        try {\n+            for (Pair<Item, MapleInventoryType> it : ItemFactory.MARRIAGE_GIFTS.loadItems(cid, false)) {\n+                items.add(it.getLeft());\n             }\n+        } catch (SQLException sqle) {\n+            sqle.printStackTrace();\n         }\n         \n         return items;\n@@ -170,19 +159,13 @@ public static void saveGiftItemsToDb(MapleClient c, List<Item> giftItems, int ci\n         for (Item it : giftItems) {\n             items.add(new Pair<>(it, it.getInventoryType()));\n         }\n-\n-        if (c.tryacquireClient()) {\n-            try {\n-                try {\n-                    Connection con = DatabaseConnection.getConnection();\n-                    ItemFactory.MARRIAGE_GIFTS.saveItems(items, cid, con);\n-                    con.close();\n-                } catch (SQLException sqle) {\n-                    sqle.printStackTrace();\n-                }\n-            } finally {\n-                c.releaseClient();\n-            }\n+        \n+        try {\n+            Connection con = DatabaseConnection.getConnection();\n+            ItemFactory.MARRIAGE_GIFTS.saveItems(items, cid, con);\n+            con.close();\n+        } catch (SQLException sqle) {\n+            sqle.printStackTrace();\n         }\n     }\n }"}, {"sha": "57e9d8309e22c4ee4a7f853ca1b5aced1cc22e98", "filename": "src/server/MapleSkillbookInformationProvider.java", "status": "modified", "additions": 2, "deletions": 17, "changes": 19, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleSkillbookInformationProvider.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleSkillbookInformationProvider.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleSkillbookInformationProvider.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -19,10 +19,8 @@\n */\n package server;\n \n-import java.io.BufferedReader;\n import java.io.File;\n import java.io.IOException;\n-import java.io.InputStreamReader;\n import java.sql.Connection;\n import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n@@ -67,25 +65,12 @@ public static MapleSkillbookInformationProvider getInstance() {\n     static String driver = \"com.mysql.jdbc.Driver\";\n     static String username = \"root\";\n     static String password = \"\";\n-\n-    static String wzPath = \"wz\";\n-    static String rootDirectory = \".\";\n-    \n-    static InputStreamReader fileReader = null;\n-    static BufferedReader bufferedReader = null;\n     \n-    static int initialStringLength = 50;\n+    static String rootDirectory = \".\";\n     \n     static int skillbookMinItemid = 2280000;\n     static int skillbookMaxItemid = 2300000;  // exclusively\n     \n-    static byte status = 0;\n-    static int questId = -1;\n-    static int isCompleteState = 0;\n-    \n-    static int currentItemid = 0;\n-    static int currentCount = 0;\n-    \n     static {\n         loadSkillbooks();\n     }\n@@ -106,7 +91,7 @@ private static void fetchSkillbooksFromQuests() {\n                             int itemcount = MapleDataTool.getInt(\"count\", questItemData, 0);\n                             \n                             if (isSkillBook(itemid) && itemcount > 0) {\n-                                foundSkillbooks.put(currentItemid, SkillBookEntry.QUEST);\n+                                foundSkillbooks.put(itemid, SkillBookEntry.QUEST);\n                             }\n                         }\n                         "}, {"sha": "d16363d74b734edfccebb58ff55bea47f16c0264", "filename": "src/server/MapleStatEffect.java", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleStatEffect.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/MapleStatEffect.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/MapleStatEffect.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -262,6 +262,7 @@ private static MapleStatEffect loadFromData(MapleData source, int sourceid, bool\n         }\n         if (MapleDataTool.getInt(\"weakness\", source, 0) > 0) {\n             cure.add(MapleDisease.WEAKEN);\n+            cure.add(MapleDisease.SLOW);\n         }\n         if (MapleDataTool.getInt(\"curse\", source, 0) > 0) {\n             cure.add(MapleDisease.CURSE);\n@@ -1070,7 +1071,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n         if (isMagicDoor() && !FieldLimit.DOOR.check(applyto.getMap().getFieldLimit())) { // Magic Door\n             int y = applyto.getFh();\n             if (y == 0) {\n-                y = applyto.getPosition().y;\n+                y = applyto.getMap().getGroundBelow(applyto.getPosition()).y;    // thanks Lame for pointing out unusual cases of doors sending players on ground below\n             }\n             Point doorPosition = new Point(applyto.getPosition().x, y);\n             MapleDoor door = new MapleDoor(applyto, doorPosition);\n@@ -1118,7 +1119,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n                         }\n                     }\n                 } else {\n-                    int amount = opposition.getMembers().size() - 1;\n+                    int amount = opposition.getMembers().size();\n                     int randd = (int) Math.floor(Math.random() * amount);\n                     MapleCharacter chrApp = applyfrom.getMap().getCharacterById(opposition.getMemberByPos(randd).getId());\n                     if (chrApp != null && chrApp.getMap().isCPQMap()) {\n@@ -1132,16 +1133,7 @@ private boolean applyTo(MapleCharacter applyfrom, MapleCharacter applyto, boolea\n             }\n         } else if (cureDebuffs.size() > 0) { // by Drago-Dragohe4rt\n             for (final MapleDisease debuff : cureDebuffs) {\n-                if (applyfrom.getParty() != null) {\n-                    for (MaplePartyCharacter mpc : applyfrom.getParty().getPartyMembers()) {\n-                        MapleCharacter chr = mpc.getPlayer();\n-                        if (chr != null) {\n-                            chr.dispelDebuff(debuff);\n-                        }\n-                    }\n-                } else {\n-                    applyfrom.dispelDebuff(debuff);\n-                }\n+                applyfrom.dispelDebuff(debuff);\n             }\n         } else if (mobSkill > 0 && mobSkillLevel > 0) {\n             MobSkill ms = MobSkillFactory.getMobSkill(mobSkill, mobSkillLevel);"}, {"sha": "32b3d0dab99b8400d0e5cfcecb1fe9a69d430389", "filename": "src/server/maps/MapleMap.java", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleMap.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleMap.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMap.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -70,6 +70,7 @@\n import net.server.services.task.channel.FaceExpressionService;\n import net.server.services.task.channel.MobMistService;\n import net.server.services.task.channel.OverallService;\n+import net.server.world.MapleParty;\n import net.server.world.World;\n import scripting.map.MapScriptManager;\n import server.MapleItemInformationProvider;\n@@ -2413,8 +2414,7 @@ public MapleCharacter getAnyCharacterFromParty(int partyid) {\n         return null;\n     }\n     \n-    private void addPartyMemberInternal(MapleCharacter chr) {\n-        int partyid = chr.getPartyId();\n+    private void addPartyMemberInternal(MapleCharacter chr, int partyid) {\n         if (partyid == -1) {\n             return;\n         }\n@@ -2430,8 +2430,7 @@ private void addPartyMemberInternal(MapleCharacter chr) {\n         }\n     }\n     \n-    private void removePartyMemberInternal(MapleCharacter chr) {\n-        int partyid = chr.getPartyId();\n+    private void removePartyMemberInternal(MapleCharacter chr, int partyid) {\n         if (partyid == -1) {\n             return;\n         }\n@@ -2446,19 +2445,19 @@ private void removePartyMemberInternal(MapleCharacter chr) {\n         }\n     }\n     \n-    public void addPartyMember(MapleCharacter chr) {\n+    public void addPartyMember(MapleCharacter chr, int partyid) {\n         chrWLock.lock();\n         try {\n-            addPartyMemberInternal(chr);\n+            addPartyMemberInternal(chr, partyid);\n         } finally {\n             chrWLock.unlock();\n         }\n     }\n             \n-    public void removePartyMember(MapleCharacter chr) {\n+    public void removePartyMember(MapleCharacter chr, int partyid) {\n         chrWLock.lock();\n         try {\n-            removePartyMemberInternal(chr);\n+            removePartyMemberInternal(chr, partyid);\n         } finally {\n             chrWLock.unlock();\n         }\n@@ -2475,12 +2474,15 @@ public void removeParty(int partyid) {\n     \n     public void addPlayer(final MapleCharacter chr) {\n         int chrSize;\n+        MapleParty party = chr.getParty();\n         chrWLock.lock();\n         try {\n             characters.add(chr);\n             chrSize = characters.size();\n             \n-            addPartyMemberInternal(chr);\n+            if (party != null && party.getMemberById(chr.getId()) != null) {\n+                addPartyMemberInternal(chr, party.getId());\n+            }\n             itemMonitorTimeout = 1;\n         } finally {\n             chrWLock.unlock();\n@@ -2810,9 +2812,13 @@ public void removePlayer(MapleCharacter chr) {\n         service.unregisterFaceExpression(mapid, chr);\n         chr.unregisterChairBuff();\n         \n+        MapleParty party = chr.getParty();\n         chrWLock.lock();\n         try {\n-            removePartyMemberInternal(chr);\n+            if (party != null && party.getMemberById(chr.getId()) != null) {\n+                removePartyMemberInternal(chr, party.getId());\n+            }\n+            \n             characters.remove(chr);\n         } finally {\n             chrWLock.unlock();\n@@ -3559,7 +3565,7 @@ public ActivateItemReactor(MapleMapItem mapitem, MapleReactor reactor, MapleClie\n \n         @Override\n         public void run() {\n-            reactor.lockReactor();\n+            reactor.hitLockReactor();\n             try {\n                 if(reactor.getReactorType() == 100) {\n                     if (reactor.getShouldCollect() == true && mapitem != null && mapitem == getMapObject(mapitem.getObjectId())) {\n@@ -3603,7 +3609,7 @@ public void run() {\n                     }\n                 }\n             } finally {\n-                reactor.unlockReactor();\n+                reactor.hitUnlockReactor();\n             }\n         }\n     }"}, {"sha": "dd483131d2df5af86e495d9ecacb008f301703e2", "filename": "src/server/maps/MapleMapFactory.java", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleMapFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleMapFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleMapFactory.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -274,10 +274,10 @@ public static MapleMap loadMapFromWz(int mapid, int world, int channel, EventIns\n             MapleData mcData = mapData.getChildByPath(\"monsterCarnival\");\n             if (mcData != null) {\n                 map.setDeathCP(MapleDataTool.getIntConvert(\"deathCP\", mcData, 0));\n-                map.setMaxMobs(MapleDataTool.getIntConvert(\"mobGenMax\", mcData, Integer.MAX_VALUE));    // thanks Atoot for noticing CPQ1 bf. 3 & 4 not accepting spawns due to undefined limits\n+                map.setMaxMobs(MapleDataTool.getIntConvert(\"mobGenMax\", mcData, 20));    // thanks Atoot for noticing CPQ1 bf. 3 & 4 not accepting spawns due to undefined limits, Lame for noticing a need to cap mob spawns even on such undefined limits\n                 map.setTimeDefault(MapleDataTool.getIntConvert(\"timeDefault\", mcData, 0));\n                 map.setTimeExpand(MapleDataTool.getIntConvert(\"timeExpand\", mcData, 0));\n-                map.setMaxReactors(MapleDataTool.getIntConvert(\"guardianGenMax\", mcData, Integer.MAX_VALUE));\n+                map.setMaxReactors(MapleDataTool.getIntConvert(\"guardianGenMax\", mcData, 16));\n                 MapleData guardianGenData = mcData.getChildByPath(\"guardianGenPos\");\n                 for (MapleData node : guardianGenData.getChildren()) {\n                     GuardianSpawnPoint pt = new GuardianSpawnPoint(new Point(MapleDataTool.getIntConvert(\"x\", node), MapleDataTool.getIntConvert(\"y\", node)));"}, {"sha": "0202127f7e0468c6473a04cc281d024b6eec8b83", "filename": "src/server/maps/MapleReactor.java", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleReactor.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/maps/MapleReactor.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/maps/MapleReactor.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -86,6 +86,16 @@ public void lockReactor() {\n     public void unlockReactor() {\n         reactorLock.unlock();\n     }\n+    \n+    public void hitLockReactor() {\n+        hitLock.lock();\n+        reactorLock.lock();\n+    }\n+\n+    public void hitUnlockReactor() {\n+        reactorLock.unlock();\n+        hitLock.unlock();\n+    }\n \n     public void setState(byte state) {\n         this.state = state;"}, {"sha": "c0c93884c1bebcd7fd40650dbccb54c4bed39c1d", "filename": "src/server/partyquest/MapleCarnivalFactory.java", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/partyquest/MapleCarnivalFactory.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/partyquest/MapleCarnivalFactory.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/partyquest/MapleCarnivalFactory.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -59,7 +59,7 @@ private MCSkill randomizeSkill(boolean multi) {\n         if (multi) {\n             return skills.get(multiTargetedSkills.get((int) (Math.random() * multiTargetedSkills.size())));\n         } else {\n-            return skills.get(multiTargetedSkills.get((int) (Math.random() * multiTargetedSkills.size())));\n+            return skills.get(singleTargetedSkills.get((int) (Math.random() * singleTargetedSkills.size())));\n         }\n     }\n     "}, {"sha": "73f08f5ed5043bd4a97d753682beded1cb8205c8", "filename": "src/server/quest/MapleQuest.java", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/MapleQuest.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/MapleQuest.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/MapleQuest.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -305,23 +305,28 @@ public void complete(MapleCharacter chr, int npc, Integer selection) {\n             for (MapleQuestAction a : acts) {\n                 a.run(chr, selection);\n             }\n+            if (!this.hasNextQuestAction()) {\n+                chr.announceUpdateQuest(MapleCharacter.DelayedQuestUpdate.INFO, chr.getQuest(this));\n+            }\n         }\n     }\n \n     public void reset(MapleCharacter chr) {\n-        chr.updateQuestStatus(new MapleQuestStatus(this, MapleQuestStatus.Status.NOT_STARTED));\n+        MapleQuestStatus newStatus = new MapleQuestStatus(this, MapleQuestStatus.Status.NOT_STARTED);\n+        chr.updateQuestStatus(newStatus);\n     }\n \n-    public void forfeit(MapleCharacter chr) {\n+    public boolean forfeit(MapleCharacter chr) {\n         if (!chr.getQuest(this).getStatus().equals(Status.STARTED)) {\n-            return;\n+            return false;\n         }\n         if (timeLimit > 0) {\n             chr.announce(MaplePacketCreator.removeQuestTimeLimit(id));\n         }\n         MapleQuestStatus newStatus = new MapleQuestStatus(this, MapleQuestStatus.Status.NOT_STARTED);\n         newStatus.setForfeited(chr.getQuest(this).getForfeited() + 1);\n         chr.updateQuestStatus(newStatus);\n+        return true;\n     }\n \n     public boolean forceStart(MapleCharacter chr, int npc) {\n@@ -584,7 +589,7 @@ private MapleQuestAction getAction(MapleQuestActionType type, MapleData data) {\n \t}\n         \n         public boolean restoreLostItem(MapleCharacter chr, int itemid) {\n-                if (chr.getQuest(this).equals(MapleQuestStatus.Status.STARTED)) {\n+                if (chr.getQuest(this).getStatus().equals(MapleQuestStatus.Status.STARTED)) {\n                         ItemAction itemAct = (ItemAction) startActs.get(MapleQuestActionType.ITEM);\n                         if (itemAct != null) {\n                                 return itemAct.restoreLostItem(chr, itemid);\n@@ -620,6 +625,13 @@ public boolean hasScriptRequirement(boolean checkEnd) {\n                 }\n         }\n         \n+        public boolean hasNextQuestAction() {\n+                Map<MapleQuestActionType, MapleQuestAction> acts = completeActs;\n+                MapleQuestAction mqa = acts.get(MapleQuestActionType.NEXTQUEST);\n+                \n+                return mqa != null;\n+        }\n+        \n         public String getName() {\n                 return name;\n         }"}, {"sha": "e37b88a1becb986eab1985c45b6f7f9f0be1a099", "filename": "src/server/quest/actions/FameAction.java", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/FameAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/FameAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/FameAction.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -22,12 +22,10 @@\n package server.quest.actions;\n \n import client.MapleCharacter;\n-import client.MapleStat;\n import provider.MapleData;\n import provider.MapleDataTool;\n import server.quest.MapleQuest;\n import server.quest.MapleQuestActionType;\n-import tools.MaplePacketCreator;\n \n /**\n  *"}, {"sha": "15b69c64fcdb504669c719623629b671d619a450", "filename": "src/server/quest/actions/ItemAction.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/ItemAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/ItemAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/ItemAction.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -24,7 +24,6 @@\n import client.MapleCharacter;\n import client.MapleClient;\n import client.inventory.Item;\n-import client.inventory.MapleInventory;\n import client.inventory.MapleInventoryType;\n import constants.inventory.ItemConstants;\n import java.util.ArrayList;"}, {"sha": "7dfd57f2bda7017bdfb0f25808bbcab2f4deba23", "filename": "src/server/quest/actions/MapleQuestAction.java", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/MapleQuestAction.java", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/src/server/quest/actions/MapleQuestAction.java", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/src/server/quest/actions/MapleQuestAction.java?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -19,7 +19,6 @@\n package server.quest.actions;\n \n import client.MapleCharacter;\n-import client.MapleQuestStatus;\n import provider.MapleData;\n import server.quest.MapleQuest;\n import server.quest.MapleQuestActionType;"}, {"sha": "25900a598e54a879efa03a4482b23d1015170c49", "filename": "wz/Quest.wz/Check.img.xml", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/wz/Quest.wz/Check.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/wz/Quest.wz/Check.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Quest.wz/Check.img.xml?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -50201,8 +50201,6 @@\n   <imgdir name=\"4309\">\n     <imgdir name=\"1\">\n       <int name=\"npc\" value=\"9120003\"/>\n-      <string name=\"start\" value=\"2000010100\"/>\n-      <string name=\"end\" value=\"2000010200\"/>\n       <imgdir name=\"mob\">\n         <imgdir name=\"0\">\n           <int name=\"id\" value=\"9400205\"/>"}, {"sha": "fdd8ed566970744c36fe4025b1b6e8597e3434cd", "filename": "wz/Skill.wz/MobSkill.img.xml", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/ronancpl/HeavenMS/blob/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/wz/Skill.wz/MobSkill.img.xml", "raw_url": "https://github.com/ronancpl/HeavenMS/raw/6d57eb1033aeeed02605eb4cb930b8fc3b15f692/wz/Skill.wz/MobSkill.img.xml", "contents_url": "https://api.github.com/repos/ronancpl/HeavenMS/contents/wz/Skill.wz/MobSkill.img.xml?ref=6d57eb1033aeeed02605eb4cb930b8fc3b15f692", "patch": "@@ -13724,12 +13724,12 @@\n         <int name=\"hp\" value=\"80\"/>\n         <int name=\"limit\" value=\"15\"/>\n         <int name=\"summonEffect\" value=\"1\"/>\n-        <int name=\"0\" value=\"9300167\"/>\n-        <int name=\"1\" value=\"9300167\"/>\n-        <int name=\"2\" value=\"9300167\"/>\n-        <int name=\"3\" value=\"9300168\"/>\n-        <int name=\"4\" value=\"9300168\"/>\n-        <int name=\"5\" value=\"9300168\"/>\n+        <int name=\"0\" value=\"3110302\"/>\n+        <int name=\"1\" value=\"3110302\"/>\n+        <int name=\"2\" value=\"3110302\"/>\n+        <int name=\"3\" value=\"5110301\"/>\n+        <int name=\"4\" value=\"5110301\"/>\n+        <int name=\"5\" value=\"5110301\"/>\n       </imgdir>\n       <imgdir name=\"89\">\n         <int name=\"interval\" value=\"40\"/>"}]}]},
